<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Verifikasi Perbaikan Transformasi Barang</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .test-result {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }
        .test-pass { border-color: #28a745; background-color: #f8fff9; }
        .test-fail { border-color: #dc3545; background-color: #fff8f8; }
        .test-warning { border-color: #ffc107; background-color: #fffdf5; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2><i class="bi bi-check-circle me-2"></i>Verifikasi Perbaikan Transformasi Barang</h2>
        <p class="text-muted">Pengujian untuk memastikan semua masalah telah diperbaiki</p>

        <div class="row">
            <div class="col-md-6">
                <button class="btn btn-primary w-100 mb-2" onclick="testHTMLStructure()">
                    <i class="bi bi-file-code me-1"></i>Test HTML Structure
                </button>
                <button class="btn btn-info w-100 mb-2" onclick="testJavaScriptSyntax()">
                    <i class="bi bi-code-slash me-1"></i>Test JavaScript Syntax
                </button>
                <button class="btn btn-warning w-100 mb-2" onclick="testFunctionDuplication()">
                    <i class="bi bi-layers me-1"></i>Test Function Duplication
                </button>
            </div>
            <div class="col-md-6">
                <button class="btn btn-success w-100 mb-2" onclick="testErrorHandling()">
                    <i class="bi bi-shield-check me-1"></i>Test Error Handling
                </button>
                <button class="btn btn-secondary w-100 mb-2" onclick="testFallbackMechanisms()">
                    <i class="bi bi-arrow-repeat me-1"></i>Test Fallback Mechanisms
                </button>
                <button class="btn btn-danger w-100 mb-2" onclick="runAllTests()">
                    <i class="bi bi-play-fill me-1"></i>Run All Tests
                </button>
            </div>
        </div>

        <div id="test-results"></div>

        <!-- Test iframe for loading the actual page -->
        <div class="mt-4">
            <h4>Live Test</h4>
            <p>Frame di bawah ini memuat halaman transformasi_barang.html untuk pengujian langsung:</p>
            <iframe id="test-frame" src="transformasi_barang.html" width="100%" height="600" 
                    style="border: 1px solid #ddd; border-radius: 5px;"></iframe>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let testResults = [];

        /**
         * Test HTML structure integrity
         */
        function testHTMLStructure() {
            const tests = [
                {
                    name: 'Form Elements Present',
                    test: () => {
                        const iframe = document.getElementById('test-frame');
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        
                        const requiredElements = ['sourceItem', 'targetItem', 'quantity', 'submit-transformation', 'reset-form'];
                        const missing = requiredElements.filter(id => !iframeDoc.getElementById(id));
                        
                        return {
                            pass: missing.length === 0,
                            message: missing.length === 0 ? 'All form elements found' : `Missing elements: ${missing.join(', ')}`
                        };
                    }
                },
                {
                    name: 'Modal Elements Present',
                    test: () => {
                        const iframe = document.getElementById('test-frame');
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        
                        const modals = ['historyModal', 'configModal'];
                        const missing = modals.filter(id => !iframeDoc.getElementById(id));
                        
                        return {
                            pass: missing.length === 0,
                            message: missing.length === 0 ? 'All modals found' : `Missing modals: ${missing.join(', ')}`
                        };
                    }
                },
                {
                    name: 'Container Elements Present',
                    test: () => {
                        const iframe = document.getElementById('test-frame');
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        
                        const containers = ['alert-container', 'preview-container', 'recent-transformations'];
                        const missing = containers.filter(id => !iframeDoc.getElementById(id));
                        
                        return {
                            pass: missing.length === 0,
                            message: missing.length === 0 ? 'All containers found' : `Missing containers: ${missing.join(', ')}`
                        };
                    }
                }
            ];

            runTestSuite('HTML Structure', tests);
        }

        /**
         * Test JavaScript syntax and loading
         */
        function testJavaScriptSyntax() {
            const tests = [
                {
                    name: 'No JavaScript Errors',
                    test: () => {
                        const iframe = document.getElementById('test-frame');
                        const iframeWindow = iframe.contentWindow;
                        
                        // Check if basic functions are defined
                        const requiredFunctions = [
                            'initializeSampleDataIfNeeded',
                            'loadInitialData',
                            'updateStats',
                            'showAlert',
                            'loadRecentTransformations'
                        ];
                        
                        const missing = requiredFunctions.filter(fn => typeof iframeWindow[fn] !== 'function');
                        
                        return {
                            pass: missing.length === 0,
                            message: missing.length === 0 ? 'All functions defined' : `Missing functions: ${missing.join(', ')}`
                        };
                    }
                },
                {
                    name: 'Global Variables Initialized',
                    test: () => {
                        const iframe = document.getElementById('test-frame');
                        const iframeWindow = iframe.contentWindow;
                        
                        // Check if currentUser is set (mock or real)
                        const hasCurrentUser = !!iframeWindow.currentUser;
                        
                        return {
                            pass: hasCurrentUser,
                            message: hasCurrentUser ? 'Current user is set' : 'Current user not initialized'
                        };
                    }
                }
            ];

            runTestSuite('JavaScript Syntax', tests);
        }

        /**
         * Test for function duplication
         */
        function testFunctionDuplication() {
            const tests = [
                {
                    name: 'No Duplicate Function Definitions',
                    test: () => {
                        // This is a conceptual test - in practice, we'd need to parse the source
                        // For now, we'll check if the page loads without errors
                        const iframe = document.getElementById('test-frame');
                        const iframeWindow = iframe.contentWindow;
                        
                        try {
                            // Try to call a function that was previously duplicated
                            if (typeof iframeWindow.updateStats === 'function') {
                                return {
                                    pass: true,
                                    message: 'Functions are properly defined without duplication'
                                };
                            } else {
                                return {
                                    pass: false,
                                    message: 'updateStats function not found'
                                };
                            }
                        } catch (error) {
                            return {
                                pass: false,
                                message: `Error calling function: ${error.message}`
                            };
                        }
                    }
                }
            ];

            runTestSuite('Function Duplication', tests);
        }

        /**
         * Test error handling
         */
        function testErrorHandling() {
            const tests = [
                {
                    name: 'Graceful Degradation',
                    test: () => {
                        const iframe = document.getElementById('test-frame');
                        const iframeWindow = iframe.contentWindow;
                        
                        try {
                            // Test if functions handle missing dependencies gracefully
                            if (typeof iframeWindow.updateStats === 'function') {
                                // This should not throw an error even if transformationManager is not available
                                iframeWindow.updateStats();
                                return {
                                    pass: true,
                                    message: 'Functions handle missing dependencies gracefully'
                                };
                            } else {
                                return {
                                    pass: false,
                                    message: 'updateStats function not available for testing'
                                };
                            }
                        } catch (error) {
                            return {
                                pass: false,
                                message: `Error in graceful degradation: ${error.message}`
                            };
                        }
                    }
                }
            ];

            runTestSuite('Error Handling', tests);
        }

        /**
         * Test fallback mechanisms
         */
        function testFallbackMechanisms() {
            const tests = [
                {
                    name: 'LocalStorage Fallback',
                    test: () => {
                        const iframe = document.getElementById('test-frame');
                        const iframeWindow = iframe.contentWindow;
                        
                        // Check if sample data is initialized
                        const masterBarang = iframeWindow.localStorage.getItem('masterBarang');
                        const hasData = !!masterBarang;
                        
                        return {
                            pass: hasData,
                            message: hasData ? 'Sample data initialized in localStorage' : 'No sample data found'
                        };
                    }
                },
                {
                    name: 'Mock User Setup',
                    test: () => {
                        const iframe = document.getElementById('test-frame');
                        const iframeWindow = iframe.contentWindow;
                        
                        const hasMockUser = !!iframeWindow.currentUser;
                        
                        return {
                            pass: hasMockUser,
                            message: hasMockUser ? 'Mock user is set up' : 'Mock user not initialized'
                        };
                    }
                }
            ];

            runTestSuite('Fallback Mechanisms', tests);
        }

        /**
         * Run all tests
         */
        function runAllTests() {
            testResults = [];
            
            // Wait for iframe to load
            const iframe = document.getElementById('test-frame');
            iframe.onload = function() {
                setTimeout(() => {
                    testHTMLStructure();
                    testJavaScriptSyntax();
                    testFunctionDuplication();
                    testErrorHandling();
                    testFallbackMechanisms();
                    
                    // Summary
                    const totalTests = testResults.length;
                    const passedTests = testResults.filter(r => r.status === 'pass').length;
                    const failedTests = testResults.filter(r => r.status === 'fail').length;
                    
                    addTestResult('Overall Summary', 
                        failedTests === 0 ? 'pass' : 'warning',
                        `${passedTests}/${totalTests} tests passed. ${failedTests} failed.`
                    );
                }, 2000);
            };
            
            // Reload iframe to ensure fresh test
            iframe.src = iframe.src;
        }

        /**
         * Run a test suite
         */
        function runTestSuite(suiteName, tests) {
            tests.forEach(test => {
                try {
                    const result = test.test();
                    addTestResult(`${suiteName}: ${test.name}`, 
                        result.pass ? 'pass' : 'fail', 
                        result.message
                    );
                } catch (error) {
                    addTestResult(`${suiteName}: ${test.name}`, 'fail', `Test error: ${error.message}`);
                }
            });
        }

        /**
         * Add test result
         */
        function addTestResult(testName, status, message) {
            const result = { testName, status, message, timestamp: new Date() };
            testResults.push(result);
            updateTestDisplay();
        }

        /**
         * Update test display
         */
        function updateTestDisplay() {
            const container = document.getElementById('test-results');
            
            container.innerHTML = testResults.map(result => {
                const statusClass = result.status === 'pass' ? 'test-pass' : 
                                  result.status === 'fail' ? 'test-fail' : 'test-warning';
                const iconClass = result.status === 'pass' ? 'check-circle' : 
                                result.status === 'fail' ? 'x-circle' : 'exclamation-triangle';
                
                return `
                    <div class="test-result ${statusClass}">
                        <h6><i class="bi bi-${iconClass} me-2"></i>${result.testName}</h6>
                        <p class="mb-1">${result.message}</p>
                        <small class="text-muted">Tested at: ${result.timestamp.toLocaleTimeString()}</small>
                    </div>
                `;
            }).join('');
        }

        // Auto-run basic tests when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                addTestResult('Page Load', 'pass', 'Test page loaded successfully');
            }, 1000);
        });
    </script>
</body>
</html>