<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Barang - Sistem Koperasi</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/fontawesome.min.css">
    <link rel="stylesheet" href="css/master-barang.css">
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            text-align: center;
            color: white;
        }
        
        .loading-text {
            margin-top: 10px;
        }
        
        .sortable {
            cursor: pointer;
            user-select: none;
        }
        
        .sortable:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        .table-actions {
            white-space: nowrap;
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .alert-dismissible {
            padding-right: 4rem;
        }
        
        .form-floating {
            position: relative;
        }
        
        .invalid-feedback {
            display: block;
        }
        
        .was-validated .form-control:invalid {
            border-color: #dc3545;
        }
        
        .was-validated .form-control:valid {
            border-color: #198754;
        }
        
        @media (max-width: 768px) {
            .table-responsive {
                font-size: 0.875rem;
            }
            
            .btn-group .btn {
                padding: 0.375rem 0.5rem;
            }
            
            .navbar-nav .nav-link {
                padding: 0.5rem 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div id="app" class="container-fluid">
        <!-- Navigation Header -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">
                    <i class="fas fa-boxes"></i> Master Barang
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" onclick="showSection('data-table')" id="nav-data-table">
                                <i class="fas fa-table"></i> Data Barang
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('import-export')" id="nav-import-export">
                                <i class="fas fa-exchange-alt"></i> Import/Export
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('category-management')" id="nav-category-management">
                                <i class="fas fa-tags"></i> Kategori & Satuan
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('audit-logs')" id="nav-audit-logs">
                                <i class="fas fa-history"></i> Audit Log
                            </a>
                        </li>
                    </ul>
                    <ul class="navbar-nav">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user"></i> Admin
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="showHelp()">
                                    <i class="fas fa-question-circle"></i> Bantuan
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="index.html">
                                    <i class="fas fa-home"></i> Dashboard Utama
                                </a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Alert Container -->
        <div id="alert-container"></div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="loading-overlay" style="display: none;">
            <div class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="loading-text">Memproses...</div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div id="main-content">
            <!-- Data Table Section -->
            <div id="data-table-section" class="content-section active">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h2><i class="fas fa-table"></i> Data Barang</h2>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-success" onclick="showAddForm()">
                            <i class="fas fa-plus"></i> Tambah Barang
                        </button>
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-primary" onclick="showBulkOperations()">
                                <i class="fas fa-tasks"></i> Operasi Massal
                            </button>
                            <button class="btn btn-outline-info" onclick="refreshData()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Search and Filter Controls -->
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Pencarian</label>
                                <div class="input-group">
                                    <input type="text" id="search-input" class="form-control" 
                                           placeholder="Cari kode, nama, atau kategori...">
                                    <button class="btn btn-outline-secondary" onclick="clearSearch()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Filter Kategori</label>
                                <select id="category-filter" class="form-select">
                                    <option value="">Semua Kategori</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Filter Satuan</label>
                                <select id="unit-filter" class="form-select">
                                    <option value="">Semua Satuan</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button class="btn btn-primary" onclick="applyFilters()">
                                        <i class="fas fa-filter"></i> Filter
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="barang-table" class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>
                                            <input type="checkbox" id="select-all" onchange="toggleSelectAll()">
                                        </th>
                                        <th onclick="sortTable('kode')" class="sortable">
                                            Kode <i class="fas fa-sort"></i>
                                        </th>
                                        <th onclick="sortTable('nama')" class="sortable">
                                            Nama Barang <i class="fas fa-sort"></i>
                                        </th>
                                        <th onclick="sortTable('kategori')" class="sortable">
                                            Kategori <i class="fas fa-sort"></i>
                                        </th>
                                        <th onclick="sortTable('satuan')" class="sortable">
                                            Satuan <i class="fas fa-sort"></i>
                                        </th>
                                        <th onclick="sortTable('harga')" class="sortable">
                                            Harga <i class="fas fa-sort"></i>
                                        </th>
                                        <th onclick="sortTable('stok')" class="sortable">
                                            Stok <i class="fas fa-sort"></i>
                                        </th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="barang-tbody">
                                    <!-- Data will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        <nav aria-label="Pagination">
                            <ul class="pagination justify-content-center" id="pagination">
                                <!-- Pagination will be populated by JavaScript -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>

            <!-- Import/Export Section -->
            <div id="import-export-section" class="content-section">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h2><i class="fas fa-exchange-alt"></i> Import/Export Data</h2>
                    </div>
                </div>

                <div class="row">
                    <!-- Import Section -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-upload"></i> Import Data</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Download Template</label>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-success" onclick="downloadTemplate('excel')">
                                            <i class="fas fa-file-excel"></i> Template Excel
                                        </button>
                                        <button class="btn btn-outline-info" onclick="downloadTemplate('csv')">
                                            <i class="fas fa-file-csv"></i> Template CSV
                                        </button>
                                    </div>
                                </div>
                                
                                <hr>
                                
                                <div class="mb-3">
                                    <label for="import-file" class="form-label">Upload File</label>
                                    <input type="file" id="import-file" class="form-control" 
                                           accept=".xlsx,.xls,.csv" onchange="handleFileUpload(event)">
                                    <div class="form-text">
                                        Format yang didukung: Excel (.xlsx, .xls) dan CSV (.csv)
                                    </div>
                                </div>
                                
                                <div id="import-preview" style="display: none;">
                                    <h6>Preview Data:</h6>
                                    <div class="table-responsive" style="max-height: 300px;">
                                        <table class="table table-sm table-bordered">
                                            <thead id="preview-header"></thead>
                                            <tbody id="preview-body"></tbody>
                                        </table>
                                    </div>
                                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                        <button class="btn btn-secondary" onclick="cancelImport()">Batal</button>
                                        <button class="btn btn-primary" onclick="processImport()">
                                            <i class="fas fa-check"></i> Proses Import
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Export Section -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-download"></i> Export Data</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Format Export</label>
                                    <select id="export-format" class="form-select">
                                        <option value="excel">Excel (.xlsx)</option>
                                        <option value="csv">CSV (.csv)</option>
                                        <option value="json">JSON (.json)</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Filter Export</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="export-all" checked>
                                        <label class="form-check-label" for="export-all">
                                            Export semua data
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="export-filtered">
                                        <label class="form-check-label" for="export-filtered">
                                            Export data yang difilter saja
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="d-grid">
                                    <button class="btn btn-success" onclick="exportData()">
                                        <i class="fas fa-download"></i> Export Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Import Progress -->
                <div id="import-progress" class="mt-3" style="display: none;">
                    <div class="card">
                        <div class="card-body">
                            <h6>Progress Import:</h6>
                            <div class="progress mb-2">
                                <div id="import-progress-bar" class="progress-bar" role="progressbar" 
                                     style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                            </div>
                            <div id="import-status" class="text-muted">Memulai import...</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Category Management Section -->
            <div id="category-management-section" class="content-section">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h2><i class="fas fa-tags"></i> Kategori & Satuan</h2>
                    </div>
                </div>

                <div class="row">
                    <!-- Category Management -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5><i class="fas fa-tag"></i> Kategori</h5>
                                <button class="btn btn-sm btn-success" onclick="showAddCategoryForm()">
                                    <i class="fas fa-plus"></i> Tambah
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Nama Kategori</th>
                                                <th>Status</th>
                                                <th>Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="category-tbody">
                                            <!-- Data will be populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Unit Management -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5><i class="fas fa-balance-scale"></i> Satuan</h5>
                                <button class="btn btn-sm btn-success" onclick="showAddUnitForm()">
                                    <i class="fas fa-plus"></i> Tambah
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Nama Satuan</th>
                                                <th>Status</th>
                                                <th>Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="unit-tbody">
                                            <!-- Data will be populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Audit Logs Section -->
            <div id="audit-logs-section" class="content-section">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h2><i class="fas fa-history"></i> Audit Log</h2>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-outline-success" onclick="exportAuditLogs()">
                            <i class="fas fa-download"></i> Export Log
                        </button>
                        <button class="btn btn-outline-danger" onclick="clearAuditLogs()">
                            <i class="fas fa-trash"></i> Clear Log
                        </button>
                    </div>
                </div>

                <!-- Audit Log Filters -->
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Tanggal Mulai</label>
                                <input type="date" id="audit-date-start" class="form-control">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Tanggal Akhir</label>
                                <input type="date" id="audit-date-end" class="form-control">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Jenis Operasi</label>
                                <select id="audit-operation-filter" class="form-select">
                                    <option value="">Semua Operasi</option>
                                    <option value="create">Create</option>
                                    <option value="update">Update</option>
                                    <option value="delete">Delete</option>
                                    <option value="import">Import</option>
                                    <option value="export">Export</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button class="btn btn-primary" onclick="filterAuditLogs()">
                                        <i class="fas fa-filter"></i> Filter
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Audit Log Table -->
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>User</th>
                                        <th>Operasi</th>
                                        <th>Target</th>
                                        <th>Detail</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="audit-tbody">
                                    <!-- Data will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Audit Pagination -->
                        <nav aria-label="Audit Pagination">
                            <ul class="pagination justify-content-center" id="audit-pagination">
                                <!-- Pagination will be populated by JavaScript -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        
        <!-- Add/Edit Barang Modal -->
        <div class="modal fade" id="barang-modal" tabindex="-1" aria-labelledby="barangModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="barangModalLabel">Tambah Barang</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="barang-form" novalidate>
                        <div class="modal-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="barang-kode" name="kode" required>
                                        <label for="barang-kode">Kode Barang *</label>
                                        <div class="invalid-feedback">Kode barang harus diisi dan unik</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <select class="form-select" id="barang-kategori" name="kategori_id" required>
                                            <option value="">Pilih Kategori</option>
                                        </select>
                                        <label for="barang-kategori">Kategori *</label>
                                        <div class="invalid-feedback">Kategori harus dipilih</div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="barang-nama" name="nama" required>
                                        <label for="barang-nama">Nama Barang *</label>
                                        <div class="invalid-feedback">Nama barang harus diisi</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <select class="form-select" id="barang-satuan" name="satuan_id" required>
                                            <option value="">Pilih Satuan</option>
                                        </select>
                                        <label for="barang-satuan">Satuan *</label>
                                        <div class="invalid-feedback">Satuan harus dipilih</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="number" class="form-control" id="barang-harga" name="harga" min="0" step="0.01" required>
                                        <label for="barang-harga">Harga *</label>
                                        <div class="invalid-feedback">Harga harus diisi dan valid</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="number" class="form-control" id="barang-stok" name="stok" min="0" step="1">
                                        <label for="barang-stok">Stok</label>
                                        <div class="invalid-feedback">Stok harus berupa angka positif</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="number" class="form-control" id="barang-stok-minimum" name="stok_minimum" min="0" step="1">
                                        <label for="barang-stok-minimum">Stok Minimum</label>
                                        <div class="invalid-feedback">Stok minimum harus berupa angka positif</div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-floating">
                                        <textarea class="form-control" id="barang-deskripsi" name="deskripsi" style="height: 100px"></textarea>
                                        <label for="barang-deskripsi">Deskripsi</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Simpan
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Add/Edit Category Modal -->
        <div class="modal fade" id="category-modal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="categoryModalLabel">Tambah Kategori</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="category-form" novalidate>
                        <div class="modal-body">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="category-nama" name="nama" required>
                                <label for="category-nama">Nama Kategori *</label>
                                <div class="invalid-feedback">Nama kategori harus diisi dan unik</div>
                            </div>
                            <div class="form-floating">
                                <select class="form-select" id="category-status" name="status">
                                    <option value="aktif">Aktif</option>
                                    <option value="nonaktif">Non-aktif</option>
                                </select>
                                <label for="category-status">Status</label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Simpan
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Add/Edit Unit Modal -->
        <div class="modal fade" id="unit-modal" tabindex="-1" aria-labelledby="unitModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="unitModalLabel">Tambah Satuan</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="unit-form" novalidate>
                        <div class="modal-body">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="unit-nama" name="nama" required>
                                <label for="unit-nama">Nama Satuan *</label>
                                <div class="invalid-feedback">Nama satuan harus diisi dan unik</div>
                            </div>
                            <div class="form-floating">
                                <select class="form-select" id="unit-status" name="status">
                                    <option value="aktif">Aktif</option>
                                    <option value="nonaktif">Non-aktif</option>
                                </select>
                                <label for="unit-status">Status</label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Simpan
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Bulk Operations Modal -->
        <div class="modal fade" id="bulk-operations-modal" tabindex="-1" aria-labelledby="bulkOperationsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="bulkOperationsModalLabel">Operasi Massal</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            Pilih item dari tabel terlebih dahulu untuk melakukan operasi massal.
                        </div>
                        
                        <div id="bulk-selected-info" class="mb-3" style="display: none;">
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle"></i>
                                <span id="bulk-selected-count">0</span> item dipilih
                            </div>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <button class="btn btn-outline-primary w-100" onclick="bulkUpdateCategory()">
                                    <i class="fas fa-tag"></i> Update Kategori
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-outline-info w-100" onclick="bulkUpdateUnit()">
                                    <i class="fas fa-balance-scale"></i> Update Satuan
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-outline-warning w-100" onclick="bulkUpdatePrice()">
                                    <i class="fas fa-dollar-sign"></i> Update Harga
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-outline-success w-100" onclick="bulkUpdateStock()">
                                    <i class="fas fa-boxes"></i> Update Stok
                                </button>
                            </div>
                            <div class="col-12">
                                <button class="btn btn-outline-danger w-100" onclick="bulkDelete()">
                                    <i class="fas fa-trash"></i> Hapus Terpilih
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Help Modal -->
        <div class="modal fade" id="help-modal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="helpModalLabel">Bantuan - Master Barang</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="accordion" id="helpAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="helpHeading1">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#helpCollapse1">
                                        Mengelola Data Barang
                                    </button>
                                </h2>
                                <div id="helpCollapse1" class="accordion-collapse collapse show" data-bs-parent="#helpAccordion">
                                    <div class="accordion-body">
                                        <ul>
                                            <li>Klik "Tambah Barang" untuk menambah data baru</li>
                                            <li>Gunakan pencarian untuk mencari barang berdasarkan kode, nama, atau kategori</li>
                                            <li>Filter data berdasarkan kategori atau satuan</li>
                                            <li>Klik ikon edit untuk mengubah data</li>
                                            <li>Klik ikon hapus untuk menghapus data</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="helpHeading2">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#helpCollapse2">
                                        Import/Export Data
                                    </button>
                                </h2>
                                <div id="helpCollapse2" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                                    <div class="accordion-body">
                                        <ul>
                                            <li>Download template Excel atau CSV terlebih dahulu</li>
                                            <li>Isi data sesuai format template</li>
                                            <li>Upload file dan preview data sebelum import</li>
                                            <li>Export data dalam format Excel, CSV, atau JSON</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="helpHeading3">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#helpCollapse3">
                                        Operasi Massal
                                    </button>
                                </h2>
                                <div id="helpCollapse3" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                                    <div class="accordion-body">
                                        <ul>
                                            <li>Pilih beberapa item dengan checkbox</li>
                                            <li>Klik "Operasi Massal" untuk membuka menu</li>
                                            <li>Pilih operasi yang ingin dilakukan</li>
                                            <li>Konfirmasi perubahan sebelum disimpan</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/fontawesome.min.js"></script>
    
    <!-- Master Barang System Scripts -->
    <script type="module" src="js/master-barang/types.js"></script>
    <script type="module" src="js/master-barang/BaseManager.js"></script>
    <script type="module" src="js/master-barang/ValidationEngine.js"></script>
    <script type="module" src="js/master-barang/DataValidator.js"></script>
    <script type="module" src="js/master-barang/BusinessRuleValidator.js"></script>
    <script type="module" src="js/master-barang/AuditLogger.js"></script>
    <script type="module" src="js/master-barang/BarangManager.js"></script>
    <script type="module" src="js/master-barang/KategoriManager.js"></script>
    <script type="module" src="js/master-barang/SatuanManager.js"></script>
    <script type="module" src="js/master-barang/DataTableManager.js"></script>
    <script type="module" src="js/master-barang/FormManager.js"></script>
    <script type="module" src="js/master-barang/SearchEngine.js"></script>
    <script type="module" src="js/master-barang/FilterManager.js"></script>
    <script type="module" src="js/master-barang/QueryBuilder.js"></script>
    <script type="module" src="js/master-barang/ImportManager.js"></script>
    <script type="module" src="js/master-barang/ExportManager.js"></script>
    <script type="module" src="js/master-barang/FileProcessor.js"></script>
    <script type="module" src="js/master-barang/TemplateManager.js"></script>
    <script type="module" src="js/master-barang/BulkOperationsManager.js"></script>
    <script type="module" src="js/master-barang/AuditViewer.js"></script>
    <script type="module" src="js/master-barang/AuditExporter.js"></script>
    <script type="module" src="js/master-barang/AdvancedFeatureManager.js"></script>
    <script type="module" src="js/master-barang/MasterBarangController.js"></script>
    <script type="module" src="js/master-barang/MasterBarangSystem.js"></script>
    
    <!-- Main Application Script -->
    <script type="module">
        import { MasterBarangSystem } from './js/master-barang/MasterBarangSystem.js';
        
        // Global variables
        let masterBarangSystem;
        let currentSection = 'data-table';
        
        // Initialize application when DOM is loaded
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                showLoading(true);
                
                // Initialize Master Barang System
                masterBarangSystem = new MasterBarangSystem();
                const initResult = await masterBarangSystem.initialize();
                
                if (initResult.success) {
                    showAlert('success', 'Sistem Master Barang berhasil diinisialisasi');
                    
                    // Load initial data
                    await loadInitialData();
                    
                    // Setup event listeners
                    setupGlobalEventListeners();
                    
                } else {
                    showAlert('danger', 'Gagal menginisialisasi sistem: ' + initResult.message);
                }
                
            } catch (error) {
                console.error('Failed to initialize application:', error);
                showAlert('danger', 'Terjadi kesalahan saat menginisialisasi aplikasi');
            } finally {
                showLoading(false);
            }
        });
        
        // Global functions for HTML onclick handlers
        window.showSection = function(sectionName) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            const navLink = document.getElementById('nav-' + sectionName);
            if (navLink) {
                navLink.classList.add('active');
            }
            
            currentSection = sectionName;
            
            // Load section-specific data
            loadSectionData(sectionName);
        };
        
        window.showAddForm = function() {
            if (masterBarangSystem && masterBarangSystem.controller) {
                masterBarangSystem.controller.showAddForm();
            }
        };
        
        window.showBulkOperations = function() {
            const modal = new bootstrap.Modal(document.getElementById('bulk-operations-modal'));
            updateBulkOperationsInfo();
            modal.show();
        };
        
        window.refreshData = function() {
            if (masterBarangSystem && masterBarangSystem.controller) {
                masterBarangSystem.controller.loadData();
            }
        };
        
        window.clearSearch = function() {
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.value = '';
                if (masterBarangSystem && masterBarangSystem.controller) {
                    masterBarangSystem.controller.handleSearch('');
                }
            }
        };
        
        window.applyFilters = function() {
            if (masterBarangSystem && masterBarangSystem.controller) {
                const categoryFilter = document.getElementById('category-filter').value;
                const unitFilter = document.getElementById('unit-filter').value;
                
                masterBarangSystem.controller.handleFilter({
                    kategori_id: categoryFilter || null,
                    satuan_id: unitFilter || null
                });
            }
        };
        
        window.sortTable = function(column) {
            if (masterBarangSystem && masterBarangSystem.controller) {
                masterBarangSystem.controller.handleSort(column);
            }
        };
        
        window.toggleSelectAll = function() {
            const selectAllCheckbox = document.getElementById('select-all');
            const itemCheckboxes = document.querySelectorAll('input[name="item-select"]');
            
            itemCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateBulkOperationsInfo();
        };
        
        window.downloadTemplate = function(format) {
            if (masterBarangSystem && masterBarangSystem.templateManager) {
                masterBarangSystem.templateManager.downloadTemplate(format);
            }
        };
        
        window.handleFileUpload = function(event) {
            if (masterBarangSystem && masterBarangSystem.importManager) {
                masterBarangSystem.importManager.handleFileUpload(event);
            }
        };
        
        window.cancelImport = function() {
            if (masterBarangSystem && masterBarangSystem.importManager) {
                masterBarangSystem.importManager.cancelImport();
            }
        };
        
        window.processImport = function() {
            if (masterBarangSystem && masterBarangSystem.importManager) {
                masterBarangSystem.importManager.processImport();
            }
        };
        
        window.exportData = function() {
            if (masterBarangSystem && masterBarangSystem.exportManager) {
                const format = document.getElementById('export-format').value;
                const exportAll = document.getElementById('export-all').checked;
                
                masterBarangSystem.exportManager.exportData({
                    format: format,
                    exportAll: exportAll
                });
            }
        };
        
        window.showAddCategoryForm = function() {
            const modal = new bootstrap.Modal(document.getElementById('category-modal'));
            document.getElementById('categoryModalLabel').textContent = 'Tambah Kategori';
            document.getElementById('category-form').reset();
            modal.show();
        };
        
        window.showAddUnitForm = function() {
            const modal = new bootstrap.Modal(document.getElementById('unit-modal'));
            document.getElementById('unitModalLabel').textContent = 'Tambah Satuan';
            document.getElementById('unit-form').reset();
            modal.show();
        };
        
        window.exportAuditLogs = function() {
            if (masterBarangSystem && masterBarangSystem.auditExporter) {
                masterBarangSystem.auditExporter.exportLogs();
            }
        };
        
        window.clearAuditLogs = function() {
            if (confirm('Apakah Anda yakin ingin menghapus semua audit log?')) {
                if (masterBarangSystem && masterBarangSystem.auditLogger) {
                    masterBarangSystem.auditLogger.clearLogs();
                    loadSectionData('audit-logs');
                }
            }
        };
        
        window.filterAuditLogs = function() {
            loadSectionData('audit-logs');
        };
        
        window.showHelp = function() {
            const modal = new bootstrap.Modal(document.getElementById('help-modal'));
            modal.show();
        };
        
        // Bulk operations functions
        window.bulkUpdateCategory = function() {
            // Implementation for bulk category update
            showAlert('info', 'Fitur bulk update kategori akan segera tersedia');
        };
        
        window.bulkUpdateUnit = function() {
            // Implementation for bulk unit update
            showAlert('info', 'Fitur bulk update satuan akan segera tersedia');
        };
        
        window.bulkUpdatePrice = function() {
            // Implementation for bulk price update
            showAlert('info', 'Fitur bulk update harga akan segera tersedia');
        };
        
        window.bulkUpdateStock = function() {
            // Implementation for bulk stock update
            showAlert('info', 'Fitur bulk update stok akan segera tersedia');
        };
        
        window.bulkDelete = function() {
            const selectedItems = getSelectedItems();
            if (selectedItems.length === 0) {
                showAlert('warning', 'Pilih item yang akan dihapus terlebih dahulu');
                return;
            }
            
            if (confirm(`Apakah Anda yakin ingin menghapus ${selectedItems.length} item terpilih?`)) {
                if (masterBarangSystem && masterBarangSystem.bulkOperationsManager) {
                    masterBarangSystem.bulkOperationsManager.bulkDelete(selectedItems);
                }
            }
        };
        
        // Helper functions
        async function loadInitialData() {
            try {
                // Load categories for filter dropdown
                if (masterBarangSystem && masterBarangSystem.kategoriManager) {
                    const categories = await masterBarangSystem.kategoriManager.getKategoriList({ status: 'aktif' });
                    populateDropdown('category-filter', categories.data, 'id', 'nama');
                }
                
                // Load units for filter dropdown
                if (masterBarangSystem && masterBarangSystem.satuanManager) {
                    const units = await masterBarangSystem.satuanManager.getSatuanList({ status: 'aktif' });
                    populateDropdown('unit-filter', units.data, 'id', 'nama');
                }
                
                // Load main data table
                await loadSectionData('data-table');
                
            } catch (error) {
                console.error('Failed to load initial data:', error);
                showAlert('danger', 'Gagal memuat data awal');
            }
        }
        
        async function loadSectionData(sectionName) {
            try {
                showLoading(true);
                
                switch (sectionName) {
                    case 'data-table':
                        if (masterBarangSystem && masterBarangSystem.controller) {
                            await masterBarangSystem.controller.loadData();
                        }
                        break;
                        
                    case 'category-management':
                        await loadCategoryManagementData();
                        break;
                        
                    case 'audit-logs':
                        await loadAuditLogsData();
                        break;
                        
                    default:
                        break;
                }
                
            } catch (error) {
                console.error(`Failed to load ${sectionName} data:`, error);
                showAlert('danger', `Gagal memuat data ${sectionName}`);
            } finally {
                showLoading(false);
            }
        }
        
        async function loadCategoryManagementData() {
            // Load categories
            if (masterBarangSystem && masterBarangSystem.kategoriManager) {
                const categories = await masterBarangSystem.kategoriManager.getKategoriList();
                populateCategoryTable(categories.data);
            }
            
            // Load units
            if (masterBarangSystem && masterBarangSystem.satuanManager) {
                const units = await masterBarangSystem.satuanManager.getSatuanList();
                populateUnitTable(units.data);
            }
        }
        
        async function loadAuditLogsData() {
            if (masterBarangSystem && masterBarangSystem.auditViewer) {
                const filters = {
                    dateStart: document.getElementById('audit-date-start').value,
                    dateEnd: document.getElementById('audit-date-end').value,
                    operation: document.getElementById('audit-operation-filter').value
                };
                
                const logs = await masterBarangSystem.auditViewer.getLogs(filters);
                populateAuditTable(logs.data);
            }
        }
        
        function setupGlobalEventListeners() {
            // Form submissions
            document.getElementById('barang-form').addEventListener('submit', handleBarangFormSubmit);
            document.getElementById('category-form').addEventListener('submit', handleCategoryFormSubmit);
            document.getElementById('unit-form').addEventListener('submit', handleUnitFormSubmit);
            
            // Item selection changes
            document.addEventListener('change', function(e) {
                if (e.target.name === 'item-select') {
                    updateBulkOperationsInfo();
                }
            });
        }
        
        async function handleBarangFormSubmit(e) {
            e.preventDefault();
            
            if (masterBarangSystem && masterBarangSystem.controller) {
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                
                try {
                    const result = await masterBarangSystem.controller.handleSave(data);
                    if (result.success) {
                        showAlert('success', 'Data barang berhasil disimpan');
                        bootstrap.Modal.getInstance(document.getElementById('barang-modal')).hide();
                        await masterBarangSystem.controller.loadData();
                    } else {
                        showAlert('danger', result.message);
                    }
                } catch (error) {
                    showAlert('danger', 'Terjadi kesalahan saat menyimpan data');
                }
            }
        }
        
        async function handleCategoryFormSubmit(e) {
            e.preventDefault();
            
            if (masterBarangSystem && masterBarangSystem.kategoriManager) {
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                
                try {
                    const result = await masterBarangSystem.kategoriManager.saveKategori(data);
                    if (result.success) {
                        showAlert('success', 'Kategori berhasil disimpan');
                        bootstrap.Modal.getInstance(document.getElementById('category-modal')).hide();
                        await loadCategoryManagementData();
                    } else {
                        showAlert('danger', result.message);
                    }
                } catch (error) {
                    showAlert('danger', 'Terjadi kesalahan saat menyimpan kategori');
                }
            }
        }
        
        async function handleUnitFormSubmit(e) {
            e.preventDefault();
            
            if (masterBarangSystem && masterBarangSystem.satuanManager) {
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                
                try {
                    const result = await masterBarangSystem.satuanManager.saveSatuan(data);
                    if (result.success) {
                        showAlert('success', 'Satuan berhasil disimpan');
                        bootstrap.Modal.getInstance(document.getElementById('unit-modal')).hide();
                        await loadCategoryManagementData();
                    } else {
                        showAlert('danger', result.message);
                    }
                } catch (error) {
                    showAlert('danger', 'Terjadi kesalahan saat menyimpan satuan');
                }
            }
        }
        
        function populateDropdown(selectId, data, valueField, textField) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            // Keep the first option (usually "Semua" or "Pilih")
            const firstOption = select.querySelector('option');
            select.innerHTML = '';
            if (firstOption) {
                select.appendChild(firstOption);
            }
            
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item[valueField];
                option.textContent = item[textField];
                select.appendChild(option);
            });
        }
        
        function populateCategoryTable(categories) {
            const tbody = document.getElementById('category-tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            categories.forEach(category => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${category.nama}</td>
                    <td>
                        <span class="badge bg-${category.status === 'aktif' ? 'success' : 'secondary'}">
                            ${category.status}
                        </span>
                    </td>
                    <td class="table-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="editCategory(${category.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory(${category.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function populateUnitTable(units) {
            const tbody = document.getElementById('unit-tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            units.forEach(unit => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${unit.nama}</td>
                    <td>
                        <span class="badge bg-${unit.status === 'aktif' ? 'success' : 'secondary'}">
                            ${unit.status}
                        </span>
                    </td>
                    <td class="table-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="editUnit(${unit.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUnit(${unit.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function populateAuditTable(logs) {
            const tbody = document.getElementById('audit-tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            logs.forEach(log => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(log.timestamp).toLocaleString('id-ID')}</td>
                    <td>${log.user || 'System'}</td>
                    <td>
                        <span class="badge bg-primary">${log.operation}</span>
                    </td>
                    <td>${log.target}</td>
                    <td>${log.details || '-'}</td>
                    <td>
                        <span class="badge bg-${log.status === 'success' ? 'success' : 'danger'}">
                            ${log.status}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function updateBulkOperationsInfo() {
            const selectedItems = getSelectedItems();
            const bulkInfo = document.getElementById('bulk-selected-info');
            const bulkCount = document.getElementById('bulk-selected-count');
            
            if (selectedItems.length > 0) {
                bulkInfo.style.display = 'block';
                bulkCount.textContent = selectedItems.length;
            } else {
                bulkInfo.style.display = 'none';
            }
        }
        
        function getSelectedItems() {
            const checkboxes = document.querySelectorAll('input[name="item-select"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.style.display = show ? 'flex' : 'none';
            }
        }
        
        function showAlert(type, message) {
            const alertContainer = document.getElementById('alert-container');
            if (!alertContainer) return;
            
            const alertId = 'alert-' + Date.now();
            const alertHtml = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            alertContainer.insertAdjacentHTML('beforeend', alertHtml);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        }
        
        // Additional global functions for category and unit management
        window.editCategory = async function(id) {
            if (masterBarangSystem && masterBarangSystem.kategoriManager) {
                const category = await masterBarangSystem.kategoriManager.getKategoriById(id);
                if (category.success) {
                    document.getElementById('categoryModalLabel').textContent = 'Edit Kategori';
                    document.getElementById('category-nama').value = category.data.nama;
                    document.getElementById('category-status').value = category.data.status;
                    
                    const modal = new bootstrap.Modal(document.getElementById('category-modal'));
                    modal.show();
                }
            }
        };
        
        window.deleteCategory = async function(id) {
            if (confirm('Apakah Anda yakin ingin menghapus kategori ini?')) {
                if (masterBarangSystem && masterBarangSystem.kategoriManager) {
                    const result = await masterBarangSystem.kategoriManager.deleteKategori(id);
                    if (result.success) {
                        showAlert('success', 'Kategori berhasil dihapus');
                        await loadCategoryManagementData();
                    } else {
                        showAlert('danger', result.message);
                    }
                }
            }
        };
        
        window.editUnit = async function(id) {
            if (masterBarangSystem && masterBarangSystem.satuanManager) {
                const unit = await masterBarangSystem.satuanManager.getSatuanById(id);
                if (unit.success) {
                    document.getElementById('unitModalLabel').textContent = 'Edit Satuan';
                    document.getElementById('unit-nama').value = unit.data.nama;
                    document.getElementById('unit-status').value = unit.data.status;
                    
                    const modal = new bootstrap.Modal(document.getElementById('unit-modal'));
                    modal.show();
                }
            }
        };
        
        window.deleteUnit = async function(id) {
            if (confirm('Apakah Anda yakin ingin menghapus satuan ini?')) {
                if (masterBarangSystem && masterBarangSystem.satuanManager) {
                    const result = await masterBarangSystem.satuanManager.deleteSatuan(id);
                    if (result.success) {
                        showAlert('success', 'Satuan berhasil dihapus');
                        await loadCategoryManagementData();
                    } else {
                        showAlert('danger', result.message);
                    }
                }
            }
        };
        
    </script>
</body>
</html>