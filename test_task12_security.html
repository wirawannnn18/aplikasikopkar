<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Task 12 - Access Control & Security</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }
        .test-result.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .test-result.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .audit-log {
            background: #f8f9fa;
            padding: 10px;
            border-left: 3px solid #007bff;
            margin-bottom: 10px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">
            <i class="bi bi-shield-check me-2"></i>
            Test Task 12: Access Control & Security
        </h1>
        
        <div class="alert alert-info">
            <h5 class="alert-heading">Test Coverage</h5>
            <ul class="mb-0">
                <li><strong>Task 12.1:</strong> Role-based access control</li>
                <li><strong>Task 12.2:</strong> Audit logging</li>
                <li><strong>Task 12.3:</strong> Input sanitization</li>
            </ul>
        </div>
        
        <!-- Current User Info -->
        <div class="test-section">
            <h3>Current User Info</h3>
            <div id="currentUserInfo"></div>
            <div class="mt-3">
                <button class="btn btn-primary btn-sm" onclick="setUserRole('admin')">Set as Admin</button>
                <button class="btn btn-secondary btn-sm" onclick="setUserRole('kasir')">Set as Kasir</button>
                <button class="btn btn-warning btn-sm" onclick="setUserRole('super_admin')">Set as Super Admin</button>
                <button class="btn btn-danger btn-sm" onclick="clearUser()">Clear User</button>
            </div>
        </div>
        
        <!-- Test 12.1: Role-Based Access Control -->
        <div class="test-section">
            <h3>Test 12.1: Role-Based Access Control</h3>
            <p class="text-muted">Test permission checks for different roles</p>
            
            <div class="mb-3">
                <h5>Test canMarkAnggotaKeluar()</h5>
                <button class="btn btn-primary" onclick="testPermission('markKeluar')">
                    Test Permission
                </button>
                <div id="resultMarkKeluar" class="test-result" style="display: none;"></div>
            </div>
            
            <div class="mb-3">
                <h5>Test canProcessPengembalian()</h5>
                <button class="btn btn-primary" onclick="testPermission('processPengembalian')">
                    Test Permission
                </button>
                <div id="resultProcessPengembalian" class="test-result" style="display: none;"></div>
            </div>
            
            <div class="mb-3">
                <h5>Test canCancelStatusKeluar()</h5>
                <button class="btn btn-primary" onclick="testPermission('cancelKeluar')">
                    Test Permission
                </button>
                <div id="resultCancelKeluar" class="test-result" style="display: none;"></div>
            </div>
            
            <div class="mb-3">
                <h5>Test canViewLaporanAnggotaKeluar()</h5>
                <button class="btn btn-primary" onclick="testPermission('viewLaporan')">
                    Test Permission
                </button>
                <div id="resultViewLaporan" class="test-result" style="display: none;"></div>
            </div>
            
            <div class="mb-3">
                <h5>Test checkAccessOrDeny()</h5>
                <button class="btn btn-primary" onclick="testAccessDeny()">
                    Test Access Denial
                </button>
            </div>
        </div>
        
        <!-- Test 12.2: Audit Logging -->
        <div class="test-section">
            <h3>Test 12.2: Audit Logging</h3>
            <p class="text-muted">Test audit trail logging for all actions</p>
            
            <div class="mb-3">
                <button class="btn btn-success" onclick="testAuditLog('MARK_KELUAR')">
                    Log MARK_KELUAR
                </button>
                <button class="btn btn-info" onclick="testAuditLog('PROSES_PENGEMBALIAN')">
                    Log PROSES_PENGEMBALIAN
                </button>
                <button class="btn btn-warning" onclick="testAuditLog('CANCEL_KELUAR')">
                    Log CANCEL_KELUAR
                </button>
                <button class="btn btn-secondary" onclick="testAuditLog('EXPORT_CSV')">
                    Log EXPORT_CSV
                </button>
            </div>
            
            <div class="mb-3">
                <h5>Audit Logs</h5>
                <button class="btn btn-primary btn-sm" onclick="displayAuditLogs()">
                    Refresh Logs
                </button>
                <button class="btn btn-danger btn-sm" onclick="clearAuditLogs()">
                    Clear Logs
                </button>
            </div>
            
            <div id="auditLogsContainer"></div>
        </div>
        
        <!-- Test 12.3: Input Sanitization -->
        <div class="test-section">
            <h3>Test 12.3: Input Sanitization</h3>
            <p class="text-muted">Test XSS prevention and input validation</p>
            
            <div class="mb-3">
                <h5>Test sanitizeText()</h5>
                <textarea class="form-control mb-2" id="testTextInput" rows="3" placeholder="Enter text with potential XSS...">
<script>alert('XSS')</script>Hello World
<img src=x onerror="alert('XSS')">
<a href="javascript:alert('XSS')">Click</a></textarea>
                <button class="btn btn-primary" onclick="testSanitizeText()">
                    Sanitize Text
                </button>
                <div id="resultSanitizeText" class="test-result" style="display: none;"></div>
            </div>
            
            <div class="mb-3">
                <h5>Test validateDate()</h5>
                <input type="text" class="form-control mb-2" id="testDateInput" placeholder="YYYY-MM-DD" value="2024-12-05">
                <button class="btn btn-primary" onclick="testValidateDate()">
                    Validate Date
                </button>
                <button class="btn btn-secondary" onclick="testInvalidDate()">
                    Test Invalid Date
                </button>
                <div id="resultValidateDate" class="test-result" style="display: none;"></div>
            </div>
            
            <div class="mb-3">
                <h5>Test validateNumber()</h5>
                <input type="text" class="form-control mb-2" id="testNumberInput" placeholder="Enter number" value="1000000">
                <button class="btn btn-primary" onclick="testValidateNumber()">
                    Validate Number
                </button>
                <button class="btn btn-secondary" onclick="testInvalidNumber()">
                    Test Invalid Number
                </button>
                <div id="resultValidateNumber" class="test-result" style="display: none;"></div>
            </div>
            
            <div class="mb-3">
                <h5>Test sanitizeAnggotaKeluarData()</h5>
                <button class="btn btn-primary" onclick="testSanitizeAnggotaKeluar()">
                    Test Valid Data
                </button>
                <button class="btn btn-secondary" onclick="testSanitizeAnggotaKeluarInvalid()">
                    Test Invalid Data
                </button>
                <div id="resultSanitizeAnggotaKeluar" class="test-result" style="display: none;"></div>
            </div>
            
            <div class="mb-3">
                <h5>Test sanitizePengembalianData()</h5>
                <button class="btn btn-primary" onclick="testSanitizePengembalian()">
                    Test Valid Data
                </button>
                <button class="btn btn-secondary" onclick="testSanitizePengembalianInvalid()">
                    Test Invalid Data
                </button>
                <div id="resultSanitizePengembalian" class="test-result" style="display: none;"></div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Mock Functions -->
    <script>
        // Mock generateId
        function generateId() {
            return 'test-' + Math.random().toString(36).substr(2, 9);
        }
        
        // Mock showToast
        function showToast(message, type, duration) {
            console.log(`[TOAST ${type}]`, message);
        }
    </script>
    
    <!-- Security Module -->
    <script src="js/anggotaKeluarSecurity.js"></script>
    
    <!-- Test Scripts -->
    <script>
        // Display current user info
        function displayCurrentUser() {
            const user = getCurrentUser();
            const container = document.getElementById('currentUserInfo');
            
            if (user) {
                container.innerHTML = `
                    <div class="alert alert-success">
                        <strong>Logged in as:</strong> ${user.username || user.nama}<br>
                        <strong>Role:</strong> ${user.role}<br>
                        <strong>ID:</strong> ${user.id}
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>No user logged in</strong>
                    </div>
                `;
            }
        }
        
        // Set user role for testing
        function setUserRole(role) {
            const user = {
                id: 'test-user-' + Date.now(),
                username: 'Test User',
                nama: 'Test User',
                role: role
            };
            localStorage.setItem('currentUser', JSON.stringify(user));
            displayCurrentUser();
            alert(`User role set to: ${role}`);
        }
        
        // Clear user
        function clearUser() {
            localStorage.removeItem('currentUser');
            displayCurrentUser();
            alert('User cleared');
        }
        
        // Test permission
        function testPermission(permission) {
            let result, functionName;
            
            switch (permission) {
                case 'markKeluar':
                    result = canMarkAnggotaKeluar();
                    functionName = 'canMarkAnggotaKeluar()';
                    break;
                case 'processPengembalian':
                    result = canProcessPengembalian();
                    functionName = 'canProcessPengembalian()';
                    break;
                case 'cancelKeluar':
                    result = canCancelStatusKeluar();
                    functionName = 'canCancelStatusKeluar()';
                    break;
                case 'viewLaporan':
                    result = canViewLaporanAnggotaKeluar();
                    functionName = 'canViewLaporanAnggotaKeluar()';
                    break;
            }
            
            const resultDiv = document.getElementById('result' + permission.charAt(0).toUpperCase() + permission.slice(1));
            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result ' + (result ? 'success' : 'error');
            
            const user = getCurrentUser();
            const userRole = user ? user.role : 'not logged in';
            
            resultDiv.innerHTML = `
                ${functionName}<br>
                User Role: ${userRole}<br>
                Result: ${result ? 'ALLOWED ✓' : 'DENIED ✗'}
            `;
        }
        
        // Test access deny
        function testAccessDeny() {
            const result = checkAccessOrDeny('markKeluar');
            alert(`checkAccessOrDeny('markKeluar') returned: ${result}`);
        }
        
        // Test audit log
        function testAuditLog(action) {
            const details = {
                testAction: action,
                timestamp: new Date().toISOString(),
                testData: 'Sample data for ' + action
            };
            
            const success = logAnggotaKeluarAction(action, details);
            
            if (success) {
                alert(`Audit log created for: ${action}`);
                displayAuditLogs();
            } else {
                alert('Failed to create audit log');
            }
        }
        
        // Display audit logs
        function displayAuditLogs() {
            const logs = getAnggotaKeluarAuditLogs();
            const container = document.getElementById('auditLogsContainer');
            
            if (logs.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No audit logs found</div>';
                return;
            }
            
            let html = `<div class="alert alert-success">Total Logs: ${logs.length}</div>`;
            
            logs.slice(0, 10).forEach(log => {
                html += `
                    <div class="audit-log">
                        <strong>${log.action}</strong> by ${log.userName} (${log.userRole})<br>
                        <small>Time: ${new Date(log.timestamp).toLocaleString('id-ID')}</small><br>
                        <small>Details: ${JSON.stringify(log.details)}</small>
                    </div>
                `;
            });
            
            if (logs.length > 10) {
                html += `<div class="text-muted">... and ${logs.length - 10} more logs</div>`;
            }
            
            container.innerHTML = html;
        }
        
        // Clear audit logs
        function clearAuditLogs() {
            localStorage.removeItem('auditLogsAnggotaKeluar');
            displayAuditLogs();
            alert('Audit logs cleared');
        }
        
        // Test sanitize text
        function testSanitizeText() {
            const input = document.getElementById('testTextInput').value;
            const sanitized = sanitizeText(input);
            
            const resultDiv = document.getElementById('resultSanitizeText');
            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result success';
            resultDiv.innerHTML = `
                <strong>Input:</strong><br>${input.replace(/</g, '&lt;').replace(/>/g, '&gt;')}<br><br>
                <strong>Sanitized:</strong><br>${sanitized.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
            `;
        }
        
        // Test validate date
        function testValidateDate() {
            const input = document.getElementById('testDateInput').value;
            const result = validateDate(input);
            
            const resultDiv = document.getElementById('resultValidateDate');
            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result ' + (result.valid ? 'success' : 'error');
            resultDiv.innerHTML = `
                Input: ${input}<br>
                Valid: ${result.valid}<br>
                Sanitized: ${result.sanitized}<br>
                Error: ${result.error || 'None'}
            `;
        }
        
        function testInvalidDate() {
            document.getElementById('testDateInput').value = '2025-12-31';
            testValidateDate();
        }
        
        // Test validate number
        function testValidateNumber() {
            const input = document.getElementById('testNumberInput').value;
            const result = validateNumber(input, { min: 0, allowNegative: false });
            
            const resultDiv = document.getElementById('resultValidateNumber');
            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result ' + (result.valid ? 'success' : 'error');
            resultDiv.innerHTML = `
                Input: ${input}<br>
                Valid: ${result.valid}<br>
                Sanitized: ${result.sanitized}<br>
                Error: ${result.error || 'None'}
            `;
        }
        
        function testInvalidNumber() {
            document.getElementById('testNumberInput').value = 'abc123';
            testValidateNumber();
        }
        
        // Test sanitize anggota keluar data
        function testSanitizeAnggotaKeluar() {
            const data = {
                anggotaId: 'test-123',
                tanggalKeluar: '2024-12-01',
                alasanKeluar: 'Pindah ke kota lain untuk bekerja'
            };
            
            const result = sanitizeAnggotaKeluarData(data);
            
            const resultDiv = document.getElementById('resultSanitizeAnggotaKeluar');
            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result ' + (result.valid ? 'success' : 'error');
            resultDiv.innerHTML = `
                Valid: ${result.valid}<br>
                Sanitized: ${JSON.stringify(result.sanitized, null, 2)}<br>
                Errors: ${JSON.stringify(result.errors, null, 2)}
            `;
        }
        
        function testSanitizeAnggotaKeluarInvalid() {
            const data = {
                anggotaId: '',
                tanggalKeluar: '2025-12-31',
                alasanKeluar: '<script>alert("XSS")</script>Short'
            };
            
            const result = sanitizeAnggotaKeluarData(data);
            
            const resultDiv = document.getElementById('resultSanitizeAnggotaKeluar');
            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result ' + (result.valid ? 'success' : 'error');
            resultDiv.innerHTML = `
                Valid: ${result.valid}<br>
                Sanitized: ${JSON.stringify(result.sanitized, null, 2)}<br>
                Errors: ${JSON.stringify(result.errors, null, 2)}
            `;
        }
        
        // Test sanitize pengembalian data
        function testSanitizePengembalian() {
            const data = {
                anggotaId: 'test-123',
                metodePembayaran: 'Kas',
                tanggalPembayaran: '2024-12-01',
                keterangan: 'Pengembalian simpanan anggota keluar'
            };
            
            const result = sanitizePengembalianData(data);
            
            const resultDiv = document.getElementById('resultSanitizePengembalian');
            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result ' + (result.valid ? 'success' : 'error');
            resultDiv.innerHTML = `
                Valid: ${result.valid}<br>
                Sanitized: ${JSON.stringify(result.sanitized, null, 2)}<br>
                Errors: ${JSON.stringify(result.errors, null, 2)}
            `;
        }
        
        function testSanitizePengembalianInvalid() {
            const data = {
                anggotaId: '',
                metodePembayaran: 'Invalid Method',
                tanggalPembayaran: 'invalid-date',
                keterangan: '<script>alert("XSS")</script>'
            };
            
            const result = sanitizePengembalianData(data);
            
            const resultDiv = document.getElementById('resultSanitizePengembalian');
            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result ' + (result.valid ? 'success' : 'error');
            resultDiv.innerHTML = `
                Valid: ${result.valid}<br>
                Sanitized: ${JSON.stringify(result.sanitized, null, 2)}<br>
                Errors: ${JSON.stringify(result.errors, null, 2)}
            `;
        }
        
        // Initialize
        window.addEventListener('load', () => {
            displayCurrentUser();
            displayAuditLogs();
        });
    </script>
</body>
</html>
