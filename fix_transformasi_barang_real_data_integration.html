<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Transformasi Barang - Integrasi Data Real</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4><i class="bi bi-tools me-2"></i>Fix Transformasi Barang - Integrasi Data Real</h4>
                        <p class="mb-0">Mengganti data dummy dengan data barang real dari aplikasi</p>
                    </div>
                    <div class="card-body">
                        <div id="status-container"></div>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <h6><i class="bi bi-database me-1"></i>Status Data Saat Ini</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="current-data-status">
                                            <div class="text-center">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <p class="mt-2">Mengecek data...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-success">
                                    <div class="card-header bg-success text-white">
                                        <h6><i class="bi bi-gear me-1"></i>Aksi Perbaikan</h6>
                                    </div>
                                    <div class="card-body">
                                        <button class="btn btn-success w-100 mb-2" onclick="integrateRealData()">
                                            <i class="bi bi-arrow-repeat me-1"></i>Integrasikan Data Real
                                        </button>
                                        <button class="btn btn-warning w-100 mb-2" onclick="createConversionRatios()">
                                            <i class="bi bi-calculator me-1"></i>Buat Rasio Konversi
                                        </button>
                                        <button class="btn btn-info w-100" onclick="testTransformation()">
                                            <i class="bi bi-check-circle me-1"></i>Test Transformasi
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h6><i class="bi bi-list-check me-1"></i>Log Aktivitas</h6>
                            </div>
                            <div class="card-body">
                                <div id="activity-log" style="height: 300px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 5px;">
                                    <div class="text-muted">Menunggu aktivitas...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Utility functions
        function log(message, type = 'info') {
            const logContainer = document.getElementById('activity-log');
            const timestamp = new Date().toLocaleTimeString();
            const iconMap = {
                'info': 'bi-info-circle text-info',
                'success': 'bi-check-circle text-success', 
                'warning': 'bi-exclamation-triangle text-warning',
                'error': 'bi-x-circle text-danger'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = 'mb-2';
            logEntry.innerHTML = `
                <span class="text-muted">[${timestamp}]</span>
                <i class="bi ${iconMap[type]} me-1"></i>
                ${message}
            `;
            
            if (logContainer.firstChild.classList?.contains('text-muted')) {
                logContainer.innerHTML = '';
            }
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function showStatus(message, type = 'info') {
            const statusContainer = document.getElementById('status-container');
            const alertClass = type === 'error' ? 'danger' : type;
            
            statusContainer.innerHTML = `
                <div class="alert alert-${alertClass} alert-dismissible fade show" role="alert">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        // Check current data status
        function checkCurrentDataStatus() {
            log('Mengecek status data saat ini...', 'info');
            
            try {
                // Check different localStorage keys
                const masterBarang = JSON.parse(localStorage.getItem('master_barang') || '[]');
                const masterBarangTransformasi = JSON.parse(localStorage.getItem('masterBarang') || '[]');
                const barang = JSON.parse(localStorage.getItem('barang') || '[]');
                const conversionRatios = JSON.parse(localStorage.getItem('conversionRatios') || '[]');
                
                const statusHtml = `
                    <div class="small">
                        <div class="mb-2">
                            <strong>Data Master Barang (Real):</strong>
                            <span class="badge bg-${masterBarang.length > 0 ? 'success' : 'danger'} ms-1">
                                ${masterBarang.length} items
                            </span>
                        </div>
                        <div class="mb-2">
                            <strong>Data Transformasi (Dummy):</strong>
                            <span class="badge bg-${masterBarangTransformasi.length > 0 ? 'warning' : 'secondary'} ms-1">
                                ${masterBarangTransformasi.length} items
                            </span>
                        </div>
                        <div class="mb-2">
                            <strong>Data Barang (Backup):</strong>
                            <span class="badge bg-${barang.length > 0 ? 'info' : 'secondary'} ms-1">
                                ${barang.length} items
                            </span>
                        </div>
                        <div class="mb-2">
                            <strong>Rasio Konversi:</strong>
                            <span class="badge bg-${conversionRatios.length > 0 ? 'success' : 'danger'} ms-1">
                                ${conversionRatios.length} groups
                            </span>
                        </div>
                        <div class="mt-3">
                            <div class="alert alert-${masterBarang.length > 0 ? 'success' : 'warning'} py-2">
                                <small>
                                    ${masterBarang.length > 0 
                                        ? '✅ Data real tersedia untuk integrasi' 
                                        : '⚠️ Tidak ada data real, akan menggunakan sample data'}
                                </small>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('current-data-status').innerHTML = statusHtml;
                
                log(`Status data: Real=${masterBarang.length}, Transformasi=${masterBarangTransformasi.length}, Konversi=${conversionRatios.length}`, 'info');
                
                return {
                    realData: masterBarang,
                    transformationData: masterBarangTransformasi,
                    conversionRatios: conversionRatios
                };
                
            } catch (error) {
                log(`Error checking data status: ${error.message}`, 'error');
                document.getElementById('current-data-status').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle me-1"></i>
                        Error: ${error.message}
                    </div>
                `;
                return null;
            }
        }

        // Integrate real data
        function integrateRealData() {
            log('Memulai integrasi data real...', 'info');
            
            try {
                // Get real data from master_barang
                const realMasterBarang = JSON.parse(localStorage.getItem('master_barang') || '[]');
                
                if (realMasterBarang.length === 0) {
                    log('Tidak ada data real, membuat sample data...', 'warning');
                    createSampleData();
                    return;
                }
                
                log(`Ditemukan ${realMasterBarang.length} item data real`, 'success');
                
                // Transform real data to transformation format
                const transformedData = [];
                const baseProductMap = new Map();
                
                realMasterBarang.forEach((item, index) => {
                    // Create base product grouping by category
                    const kategori = item.kategori_nama || 'Umum';
                    const baseProduct = `CAT_${kategori.replace(/\s+/g, '_').toUpperCase()}`;
                    
                    if (!baseProductMap.has(baseProduct)) {
                        baseProductMap.set(baseProduct, []);
                    }
                    
                    // Main item
                    const mainItem = {
                        kode: item.kode || `ITM_${item.id}`,
                        nama: item.nama,
                        satuan: item.satuan_nama || 'pcs',
                        stok: parseInt(item.stok) || 0,
                        baseProduct: baseProduct,
                        hargaBeli: parseInt(item.harga_beli) || 0,
                        hargaJual: parseInt(item.harga_jual) || 0,
                        kategori: kategori,
                        originalId: item.id,
                        isReal: true
                    };
                    
                    transformedData.push(mainItem);
                    baseProductMap.get(baseProduct).push(mainItem);
                    
                    // Add conversion variants for common units
                    addConversionVariants(item, baseProduct, transformedData, baseProductMap);
                });
                
                // Save transformed data
                localStorage.setItem('masterBarang', JSON.stringify(transformedData));
                localStorage.setItem('barang', JSON.stringify(transformedData)); // Backup
                
                log(`Berhasil mentransformasi ${transformedData.length} item untuk transformasi barang`, 'success');
                
                // Create conversion ratios
                createConversionRatiosFromData(baseProductMap);
                
                showStatus(`Integrasi data real berhasil! ${transformedData.length} item siap untuk transformasi.`, 'success');
                
                // Refresh status
                setTimeout(checkCurrentDataStatus, 500);
                
            } catch (error) {
                log(`Error integrasi data: ${error.message}`, 'error');
                showStatus(`Error integrasi data: ${error.message}`, 'error');
            }
        }

        // Add conversion variants for common units
        function addConversionVariants(item, baseProduct, transformedData, baseProductMap) {
            const satuan = (item.satuan_nama || 'pcs').toLowerCase();
            
            const conversionMap = {
                'kg': [
                    { unit: 'gram', ratio: 1000, suffix: 'GR' },
                    { unit: 'ons', ratio: 10, suffix: 'ONS' }
                ],
                'kilogram': [
                    { unit: 'gram', ratio: 1000, suffix: 'GR' },
                    { unit: 'ons', ratio: 10, suffix: 'ONS' }
                ],
                'liter': [
                    { unit: 'ml', ratio: 1000, suffix: 'ML' },
                    { unit: 'cc', ratio: 1000, suffix: 'CC' }
                ],
                'dus': [
                    { unit: 'pcs', ratio: 24, suffix: 'PCS' },
                    { unit: 'botol', ratio: 24, suffix: 'BTL' }
                ],
                'karung': [
                    { unit: 'kg', ratio: 50, suffix: 'KG' }
                ],
                'sak': [
                    { unit: 'kg', ratio: 25, suffix: 'KG' }
                ],
                'botol': [
                    { unit: 'dus', ratio: 0.041667, suffix: 'DUS' }
                ]
            };
            
            const conversions = conversionMap[satuan];
            if (conversions) {
                conversions.forEach(conv => {
                    const convertedStok = Math.floor((parseInt(item.stok) || 0) * conv.ratio);
                    const convertedHargaBeli = Math.round((parseInt(item.harga_beli) || 0) / conv.ratio);
                    const convertedHargaJual = Math.round((parseInt(item.harga_jual) || 0) / conv.ratio);
                    
                    const convertedItem = {
                        kode: `${item.kode || item.id}_${conv.suffix}`,
                        nama: `${item.nama} (${conv.unit})`,
                        satuan: conv.unit,
                        stok: convertedStok,
                        baseProduct: baseProduct,
                        hargaBeli: convertedHargaBeli,
                        hargaJual: convertedHargaJual,
                        kategori: item.kategori_nama || 'Umum',
                        originalId: item.id,
                        isReal: true,
                        isConverted: true,
                        conversionRatio: conv.ratio,
                        parentUnit: item.satuan_nama || 'pcs'
                    };
                    
                    transformedData.push(convertedItem);
                    baseProductMap.get(baseProduct).push(convertedItem);
                });
                
                log(`Menambahkan ${conversions.length} varian konversi untuk ${item.nama}`, 'info');
            }
        }

        // Create conversion ratios from transformed data
        function createConversionRatiosFromData(baseProductMap) {
            log('Membuat rasio konversi dari data...', 'info');
            
            const conversionRatios = [];
            
            baseProductMap.forEach((items, baseProduct) => {
                if (items.length > 1) {
                    const conversions = [];
                    
                    // Create conversion pairs
                    items.forEach(fromItem => {
                        items.forEach(toItem => {
                            if (fromItem.kode !== toItem.kode) {
                                let ratio = 1;
                                
                                // Calculate ratio based on conversion data
                                if (fromItem.isConverted && toItem.isConverted) {
                                    ratio = fromItem.conversionRatio / toItem.conversionRatio;
                                } else if (fromItem.isConverted && !toItem.isConverted) {
                                    ratio = 1 / fromItem.conversionRatio;
                                } else if (!fromItem.isConverted && toItem.isConverted) {
                                    ratio = toItem.conversionRatio;
                                }
                                
                                conversions.push({
                                    from: fromItem.satuan,
                                    to: toItem.satuan,
                                    ratio: ratio
                                });
                            }
                        });
                    });
                    
                    if (conversions.length > 0) {
                        conversionRatios.push({
                            baseProduct: baseProduct,
                            conversions: conversions
                        });
                    }
                }
            });
            
            localStorage.setItem('conversionRatios', JSON.stringify(conversionRatios));
            log(`Berhasil membuat ${conversionRatios.length} grup rasio konversi`, 'success');
        }

        // Create sample data if no real data exists
        function createSampleData() {
            log('Membuat sample data untuk testing...', 'warning');
            
            const sampleData = [
                {
                    id: 'sample001',
                    kode: 'BRG001',
                    nama: 'Beras Premium',
                    kategori_nama: 'Sembako',
                    satuan_nama: 'kg',
                    harga_beli: 12000,
                    harga_jual: 15000,
                    stok: 100
                },
                {
                    id: 'sample002',
                    kode: 'BRG002',
                    nama: 'Minyak Goreng',
                    kategori_nama: 'Sembako',
                    satuan_nama: 'liter',
                    harga_beli: 18000,
                    harga_jual: 22000,
                    stok: 50
                },
                {
                    id: 'sample003',
                    kode: 'BRG003',
                    nama: 'Air Mineral',
                    kategori_nama: 'Minuman',
                    satuan_nama: 'dus',
                    harga_beli: 48000,
                    harga_jual: 60000,
                    stok: 20
                }
            ];
            
            // Save sample data to master_barang
            localStorage.setItem('master_barang', JSON.stringify(sampleData));
            
            log('Sample data berhasil dibuat, menjalankan integrasi...', 'success');
            
            // Run integration with sample data
            setTimeout(integrateRealData, 500);
        }

        // Create conversion ratios manually
        function createConversionRatios() {
            log('Membuat rasio konversi manual...', 'info');
            
            const commonRatios = [
                {
                    baseProduct: 'CAT_SEMBAKO',
                    conversions: [
                        { from: 'kg', to: 'gram', ratio: 1000 },
                        { from: 'gram', to: 'kg', ratio: 0.001 },
                        { from: 'kg', to: 'ons', ratio: 10 },
                        { from: 'ons', to: 'kg', ratio: 0.1 },
                        { from: 'liter', to: 'ml', ratio: 1000 },
                        { from: 'ml', to: 'liter', ratio: 0.001 },
                        { from: 'karung', to: 'kg', ratio: 50 },
                        { from: 'kg', to: 'karung', ratio: 0.02 }
                    ]
                },
                {
                    baseProduct: 'CAT_MINUMAN',
                    conversions: [
                        { from: 'dus', to: 'botol', ratio: 24 },
                        { from: 'botol', to: 'dus', ratio: 0.041667 },
                        { from: 'dus', to: 'pcs', ratio: 24 },
                        { from: 'pcs', to: 'dus', ratio: 0.041667 }
                    ]
                }
            ];
            
            localStorage.setItem('conversionRatios', JSON.stringify(commonRatios));
            log(`Berhasil membuat ${commonRatios.length} grup rasio konversi manual`, 'success');
            
            showStatus('Rasio konversi berhasil dibuat!', 'success');
            setTimeout(checkCurrentDataStatus, 500);
        }

        // Test transformation
        function testTransformation() {
            log('Menjalankan test transformasi...', 'info');
            
            try {
                const masterBarang = JSON.parse(localStorage.getItem('masterBarang') || '[]');
                const conversionRatios = JSON.parse(localStorage.getItem('conversionRatios') || '[]');
                
                if (masterBarang.length === 0) {
                    throw new Error('Tidak ada data barang untuk transformasi');
                }
                
                if (conversionRatios.length === 0) {
                    throw new Error('Tidak ada rasio konversi');
                }
                
                // Find transformable items (same base product)
                const baseProducts = {};
                masterBarang.forEach(item => {
                    const baseProduct = item.baseProduct;
                    if (!baseProducts[baseProduct]) {
                        baseProducts[baseProduct] = [];
                    }
                    baseProducts[baseProduct].push(item);
                });
                
                let transformableGroups = 0;
                let transformableItems = 0;
                
                Object.entries(baseProducts).forEach(([baseProduct, items]) => {
                    if (items.length > 1) {
                        transformableGroups++;
                        transformableItems += items.length;
                        log(`Grup ${baseProduct}: ${items.length} item dapat ditransformasi`, 'info');
                    }
                });
                
                if (transformableGroups === 0) {
                    throw new Error('Tidak ada item yang dapat ditransformasi (perlu minimal 2 item dengan base product sama)');
                }
                
                log(`Test berhasil: ${transformableGroups} grup, ${transformableItems} item siap transformasi`, 'success');
                showStatus(`Test transformasi berhasil! ${transformableGroups} grup dengan ${transformableItems} item siap untuk transformasi.`, 'success');
                
                // Show sample transformation
                const firstGroup = Object.values(baseProducts).find(items => items.length > 1);
                if (firstGroup && firstGroup.length >= 2) {
                    const sourceItem = firstGroup[0];
                    const targetItem = firstGroup[1];
                    
                    log(`Contoh transformasi: ${sourceItem.nama} (${sourceItem.stok} ${sourceItem.satuan}) → ${targetItem.nama} (${targetItem.satuan})`, 'info');
                }
                
            } catch (error) {
                log(`Error test transformasi: ${error.message}`, 'error');
                showStatus(`Error test transformasi: ${error.message}`, 'error');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('Sistem fix transformasi barang dimuat', 'info');
            setTimeout(checkCurrentDataStatus, 500);
        });
    </script>
</body>
</html>