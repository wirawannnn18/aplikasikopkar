<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Task 1 - Core Filtering and Validation Functions</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .test-pass { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .test-fail { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .function-test { border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin: 15px 0; }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1><i class="bi bi-gear-fill"></i> Test Task 1 - Core Filtering and Validation Functions</h1>
        <p class="lead">Testing the three core functions: filterActiveAnggota(), filterTransactableAnggota(), and validateAnggotaForTransaction()</p>
        
        <div class="alert alert-info">
            <strong>Task 1 Requirements:</strong>
            <ul class="mb-0">
                <li>Create <code>filterActiveAnggota()</code> function in js/koperasi.js</li>
                <li>Create <code>filterTransactableAnggota()</code> function in js/koperasi.js</li>
                <li>Create <code>validateAnggotaForTransaction()</code> function in js/koperasi.js</li>
                <li>Add JSDoc comments explaining purpose and usage</li>
            </ul>
        </div>

        <div id="testResults"></div>
        
        <button class="btn btn-primary" onclick="runAllTests()">
            <i class="bi bi-play-fill"></i> Run All Tests
        </button>
        
        <button class="btn btn-secondary" onclick="clearResults()">
            <i class="bi bi-trash"></i> Clear Results
        </button>
    </div>

    <!-- Include the koperasi.js file -->
    <script src="js/koperasi.js"></script>
    
    <script>
        // Test data setup
        function setupTestData() {
            const testAnggota = [
                {
                    id: 'A001',
                    nama: 'John Aktif',
                    status: 'Aktif',
                    statusKeanggotaan: 'Anggota'
                },
                {
                    id: 'A002',
                    nama: 'Jane Nonaktif',
                    status: 'Nonaktif',
                    statusKeanggotaan: 'Anggota'
                },
                {
                    id: 'A003',
                    nama: 'Bob Keluar',
                    status: 'Aktif',
                    statusKeanggotaan: 'Keluar'
                },
                {
                    id: 'A004',
                    nama: 'Alice Cuti',
                    status: 'Cuti',
                    statusKeanggotaan: 'Anggota'
                },
                {
                    id: 'A005',
                    nama: 'Charlie TanggalKeluar',
                    status: 'Aktif',
                    statusKeanggotaan: 'Anggota',
                    tanggalKeluar: '2024-01-15'
                },
                {
                    id: 'A006',
                    nama: 'Diana PengembalianStatus',
                    status: 'Aktif',
                    statusKeanggotaan: 'Anggota',
                    pengembalianStatus: 'Proses'
                }
            ];
            
            localStorage.setItem('anggota', JSON.stringify(testAnggota));
            return testAnggota;
        }

        function addResult(testName, passed, message, details = '') {
            const resultsDiv = document.getElementById('testResults');
            const resultClass = passed ? 'test-pass' : 'test-fail';
            const icon = passed ? 'bi-check-circle-fill' : 'bi-x-circle-fill';
            
            resultsDiv.innerHTML += `
                <div class="test-result ${resultClass}">
                    <i class="bi ${icon}"></i>
                    <strong>${testName}:</strong> ${message}
                    ${details ? `<br><small>${details}</small>` : ''}
                </div>
            `;
        }

        // Test 1: Check if functions exist
        function testFunctionsExist() {
            addResult(
                'Function Existence - filterActiveAnggota',
                typeof filterActiveAnggota === 'function',
                typeof filterActiveAnggota === 'function' ? 'Function exists' : 'Function not found',
                'This function should filter out anggota with statusKeanggotaan === "Keluar"'
            );
            
            addResult(
                'Function Existence - filterTransactableAnggota',
                typeof filterTransactableAnggota === 'function',
                typeof filterTransactableAnggota === 'function' ? 'Function exists' : 'Function not found',
                'This function should filter anggota who can perform transactions'
            );
            
            addResult(
                'Function Existence - validateAnggotaForTransaction',
                typeof validateAnggotaForTransaction === 'function',
                typeof validateAnggotaForTransaction === 'function' ? 'Function exists' : 'Function not found',
                'This function should validate if anggota can perform transactions'
            );
        }

        // Test 2: filterActiveAnggota functionality
        function testFilterActiveAnggota() {
            const testData = setupTestData();
            
            // Test with valid array
            const result = filterActiveAnggota(testData);
            const expectedCount = 3; // A001 (Aktif), A002 (Nonaktif), A004 (Cuti) should pass
            
            addResult(
                'filterActiveAnggota - Basic filtering',
                result.length === expectedCount,
                `Returned ${result.length} anggota, expected ${expectedCount}`,
                `Should ONLY exclude: Keluar (A003), tanggalKeluar (A005), pengembalianStatus (A006). Nonaktif and Cuti are shown in Master Anggota.`
            );
            
            // Test with invalid input
            const emptyResult = filterActiveAnggota(null);
            addResult(
                'filterActiveAnggota - Invalid input handling',
                Array.isArray(emptyResult) && emptyResult.length === 0,
                'Handles null input correctly',
                'Should return empty array for invalid input'
            );
            
            // Test exclusion logic - only exclude permanent exits
            const hasKeluar = result.some(a => a.statusKeanggotaan === 'Keluar');
            const hasTanggalKeluar = result.some(a => a.tanggalKeluar);
            const hasPengembalianStatus = result.some(a => a.pengembalianStatus);
            
            // Test inclusion logic - should include Nonaktif and Cuti
            const hasNonaktif = result.some(a => a.status === 'Nonaktif');
            const hasCuti = result.some(a => a.status === 'Cuti');
            
            addResult(
                'filterActiveAnggota - Exclusion logic',
                !hasKeluar && !hasTanggalKeluar && !hasPengembalianStatus,
                'Correctly excludes only permanent exit indicators',
                'Should exclude: Keluar, tanggalKeluar, pengembalianStatus'
            );
            
            addResult(
                'filterActiveAnggota - Inclusion logic',
                hasNonaktif && hasCuti,
                'Correctly includes Nonaktif and Cuti members',
                'Nonaktif and Cuti members should appear in Master Anggota but be filtered from transactions'
            );
        }

        // Test 3: filterTransactableAnggota functionality
        function testFilterTransactableAnggota() {
            const testData = setupTestData();
            
            // Test with valid array
            const result = filterTransactableAnggota(testData);
            const expectedCount = 1; // Only A001 should pass (status: Aktif, statusKeanggotaan: not Keluar)
            
            addResult(
                'filterTransactableAnggota - Basic filtering',
                result.length === expectedCount,
                `Returned ${result.length} anggota, expected ${expectedCount}`,
                `Should only include anggota with status === 'Aktif' AND no exit indicators`
            );
            
            // Test that all results have status === 'Aktif'
            const allAktif = result.every(a => a.status === 'Aktif');
            addResult(
                'filterTransactableAnggota - Status requirement',
                allAktif,
                'All results have status === "Aktif"',
                'Only anggota with Aktif status should be included'
            );
            
            // Test exclusion of exit indicators
            const hasExitIndicators = result.some(a => 
                a.statusKeanggotaan === 'Keluar' || 
                a.tanggalKeluar || 
                a.pengembalianStatus
            );
            
            addResult(
                'filterTransactableAnggota - Exit exclusion',
                !hasExitIndicators,
                'Correctly excludes anggota with exit indicators',
                'No anggota with Keluar, tanggalKeluar, or pengembalianStatus should be included'
            );
        }

        // Test 4: validateAnggotaForTransaction functionality
        function testValidateAnggotaForTransaction() {
            setupTestData();
            
            // Test valid anggota (A001)
            const validResult = validateAnggotaForTransaction('A001');
            addResult(
                'validateAnggotaForTransaction - Valid anggota',
                validResult.valid === true && validResult.anggota,
                'Accepts valid anggota',
                `Result: ${JSON.stringify(validResult)}`
            );
            
            // Test anggota keluar (A003)
            const keluarResult = validateAnggotaForTransaction('A003');
            addResult(
                'validateAnggotaForTransaction - Anggota keluar',
                keluarResult.valid === false && keluarResult.error.includes('keluar'),
                'Rejects anggota keluar',
                `Error: ${keluarResult.error}`
            );
            
            // Test nonaktif anggota (A002)
            const nonaktifResult = validateAnggotaForTransaction('A002');
            addResult(
                'validateAnggotaForTransaction - Nonaktif anggota',
                nonaktifResult.valid === false && keluarResult.error.includes('non-aktif'),
                'Rejects nonaktif anggota',
                `Error: ${nonaktifResult.error}`
            );
            
            // Test cuti anggota (A004)
            const cutiResult = validateAnggotaForTransaction('A004');
            addResult(
                'validateAnggotaForTransaction - Cuti anggota',
                cutiResult.valid === false && cutiResult.error.includes('cuti'),
                'Rejects anggota on leave',
                `Error: ${cutiResult.error}`
            );
            
            // Test anggota with tanggalKeluar (A005)
            const tanggalKeluarResult = validateAnggotaForTransaction('A005');
            addResult(
                'validateAnggotaForTransaction - TanggalKeluar',
                tanggalKeluarResult.valid === false && tanggalKeluarResult.error.includes('keluar'),
                'Rejects anggota with tanggalKeluar',
                `Error: ${tanggalKeluarResult.error}`
            );
            
            // Test anggota with pengembalianStatus (A006)
            const pengembalianResult = validateAnggotaForTransaction('A006');
            addResult(
                'validateAnggotaForTransaction - PengembalianStatus',
                pengembalianResult.valid === false && pengembalianResult.error.includes('proses keluar'),
                'Rejects anggota with pengembalianStatus',
                `Error: ${pengembalianResult.error}`
            );
            
            // Test non-existent anggota
            const notFoundResult = validateAnggotaForTransaction('NOTFOUND');
            addResult(
                'validateAnggotaForTransaction - Non-existent anggota',
                notFoundResult.valid === false && notFoundResult.error.includes('tidak ditemukan'),
                'Rejects non-existent anggota',
                `Error: ${notFoundResult.error}`
            );
            
            // Test empty ID
            const emptyIdResult = validateAnggotaForTransaction('');
            addResult(
                'validateAnggotaForTransaction - Empty ID',
                emptyIdResult.valid === false && emptyIdResult.error.includes('tidak boleh kosong'),
                'Rejects empty ID',
                `Error: ${emptyIdResult.error}`
            );
        }

        // Test 5: JSDoc comments verification
        function testJSDocComments() {
            // Check if functions have proper JSDoc by examining their toString()
            const filterActiveStr = filterActiveAnggota.toString();
            const filterTransactableStr = filterTransactableAnggota.toString();
            const validateStr = validateAnggotaForTransaction.toString();
            
            addResult(
                'JSDoc Comments - filterActiveAnggota',
                filterActiveStr.includes('/**') || filterActiveStr.includes('*'),
                'Function has documentation comments',
                'JSDoc comments should explain the function purpose and usage'
            );
            
            addResult(
                'JSDoc Comments - filterTransactableAnggota',
                filterTransactableStr.includes('/**') || filterTransactableStr.includes('*'),
                'Function has documentation comments',
                'JSDoc comments should explain the function purpose and usage'
            );
            
            addResult(
                'JSDoc Comments - validateAnggotaForTransaction',
                validateStr.includes('/**') || validateStr.includes('*'),
                'Function has documentation comments',
                'JSDoc comments should explain the function purpose and usage'
            );
        }

        function runAllTests() {
            clearResults();
            
            document.getElementById('testResults').innerHTML += '<div class="function-test"><h4><i class="bi bi-1-circle"></i> Function Existence Tests</h4>';
            testFunctionsExist();
            document.getElementById('testResults').innerHTML += '</div>';
            
            document.getElementById('testResults').innerHTML += '<div class="function-test"><h4><i class="bi bi-2-circle"></i> filterActiveAnggota Tests</h4>';
            testFilterActiveAnggota();
            document.getElementById('testResults').innerHTML += '</div>';
            
            document.getElementById('testResults').innerHTML += '<div class="function-test"><h4><i class="bi bi-3-circle"></i> filterTransactableAnggota Tests</h4>';
            testFilterTransactableAnggota();
            document.getElementById('testResults').innerHTML += '</div>';
            
            document.getElementById('testResults').innerHTML += '<div class="function-test"><h4><i class="bi bi-4-circle"></i> validateAnggotaForTransaction Tests</h4>';
            testValidateAnggotaForTransaction();
            document.getElementById('testResults').innerHTML += '</div>';
            
            document.getElementById('testResults').innerHTML += '<div class="function-test"><h4><i class="bi bi-5-circle"></i> JSDoc Comments Tests</h4>';
            testJSDocComments();
            document.getElementById('testResults').innerHTML += '</div>';
            
            // Summary
            const allResults = document.querySelectorAll('.test-result');
            const passedTests = document.querySelectorAll('.test-pass').length;
            const totalTests = allResults.length;
            
            document.getElementById('testResults').innerHTML += `
                <div class="alert ${passedTests === totalTests ? 'alert-success' : 'alert-warning'} mt-4">
                    <h5><i class="bi bi-clipboard-check"></i> Test Summary</h5>
                    <p><strong>${passedTests}/${totalTests}</strong> tests passed</p>
                    ${passedTests === totalTests ? 
                        '<p class="mb-0"><i class="bi bi-check-circle-fill text-success"></i> All tests passed! Task 1 implementation is complete.</p>' :
                        '<p class="mb-0"><i class="bi bi-exclamation-triangle-fill text-warning"></i> Some tests failed. Please review the implementation.</p>'
                    }
                </div>
            `;
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
        }

        // Auto-run tests on page load
        window.onload = function() {
            runAllTests();
        };
    </script>
</body>
</html>