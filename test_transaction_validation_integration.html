<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Transaction Validation Integration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h2>Test Transaction Validation Integration</h2>
        <p class="text-muted">Testing that anggota keluar cannot perform transactions</p>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>Test Setup</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-primary" onclick="setupTestData()">Setup Test Data</button>
                <button class="btn btn-danger" onclick="clearTestData()">Clear Test Data</button>
                <div id="setupResult" class="mt-3"></div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>Test Cases</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6>Test 1: Validate Active Anggota (Should Pass)</h6>
                    <button class="btn btn-sm btn-success" onclick="testActiveAnggota()">Run Test</button>
                    <div id="test1Result" class="mt-2"></div>
                </div>
                
                <div class="mb-3">
                    <h6>Test 2: Validate Keluar Anggota for POS (Should Fail)</h6>
                    <button class="btn btn-sm btn-warning" onclick="testKeluarAnggotaPOS()">Run Test</button>
                    <div id="test2Result" class="mt-2"></div>
                </div>
                
                <div class="mb-3">
                    <h6>Test 3: Validate Keluar Anggota for Simpanan (Should Fail)</h6>
                    <button class="btn btn-sm btn-warning" onclick="testKeluarAnggotaSimpanan()">Run Test</button>
                    <div id="test3Result" class="mt-2"></div>
                </div>
                
                <div class="mb-3">
                    <h6>Test 4: Validate Keluar Anggota for Pinjaman (Should Fail)</h6>
                    <button class="btn btn-sm btn-warning" onclick="testKeluarAnggotaPinjaman()">Run Test</button>
                    <div id="test4Result" class="mt-2"></div>
                </div>
                
                <div class="mb-3">
                    <h6>Test 5: Validate Non-existent Anggota (Should Fail)</h6>
                    <button class="btn btn-sm btn-warning" onclick="testNonExistentAnggota()">Run Test</button>
                    <div id="test5Result" class="mt-2"></div>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>Test Summary</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-info" onclick="runAllTests()">Run All Tests</button>
                <div id="summaryResult" class="mt-3"></div>
            </div>
        </div>
    </div>
    
    <script src="js/transactionValidator.js"></script>
    <script>
        function setupTestData() {
            const anggota = [
                {
                    id: 'test-active-001',
                    nama: 'Test Anggota Aktif',
                    nik: '1234567890',
                    statusKeanggotaan: 'Aktif',
                    status: 'Aktif',
                    tipeAnggota: 'Anggota'
                },
                {
                    id: 'test-keluar-001',
                    nama: 'Test Anggota Keluar',
                    nik: '0987654321',
                    statusKeanggotaan: 'Keluar',
                    status: 'Aktif',
                    tipeAnggota: 'Anggota',
                    tanggalKeluar: '2024-01-01',
                    alasanKeluar: 'Pindah kerja'
                }
            ];
            
            localStorage.setItem('anggota', JSON.stringify(anggota));
            
            document.getElementById('setupResult').innerHTML = `
                <div class="alert alert-success">
                    Test data created:<br>
                    - Active Anggota: ${anggota[0].nama} (ID: ${anggota[0].id})<br>
                    - Keluar Anggota: ${anggota[1].nama} (ID: ${anggota[1].id})
                </div>
            `;
        }
        
        function clearTestData() {
            const anggota = JSON.parse(localStorage.getItem('anggota') || '[]');
            const filtered = anggota.filter(a => !a.id.startsWith('test-'));
            localStorage.setItem('anggota', JSON.stringify(filtered));
            
            document.getElementById('setupResult').innerHTML = `
                <div class="alert alert-info">Test data cleared</div>
            `;
        }
        
        function testActiveAnggota() {
            const result = validateAnggotaForTransaction('test-active-001');
            
            const resultDiv = document.getElementById('test1Result');
            if (result.valid) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        ✓ PASS: Active anggota can transact<br>
                        Anggota: ${result.anggota.nama}
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        ✗ FAIL: ${result.error}
                    </div>
                `;
            }
        }
        
        function testKeluarAnggotaPOS() {
            const result = validateAnggotaForPOS('test-keluar-001');
            
            const resultDiv = document.getElementById('test2Result');
            if (!result.valid && result.error.includes('keluar')) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        ✓ PASS: Keluar anggota blocked from POS<br>
                        Error: ${result.error}
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        ✗ FAIL: Keluar anggota should be blocked
                    </div>
                `;
            }
        }
        
        function testKeluarAnggotaSimpanan() {
            const result = validateAnggotaForSimpanan('test-keluar-001');
            
            const resultDiv = document.getElementById('test3Result');
            if (!result.valid && result.error.includes('keluar')) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        ✓ PASS: Keluar anggota blocked from Simpanan<br>
                        Error: ${result.error}
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        ✗ FAIL: Keluar anggota should be blocked
                    </div>
                `;
            }
        }
        
        function testKeluarAnggotaPinjaman() {
            const result = validateAnggotaForPinjaman('test-keluar-001');
            
            const resultDiv = document.getElementById('test4Result');
            if (!result.valid && result.error.includes('keluar')) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        ✓ PASS: Keluar anggota blocked from Pinjaman<br>
                        Error: ${result.error}
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        ✗ FAIL: Keluar anggota should be blocked
                    </div>
                `;
            }
        }
        
        function testNonExistentAnggota() {
            const result = validateAnggotaForTransaction('non-existent-id');
            
            const resultDiv = document.getElementById('test5Result');
            if (!result.valid && result.error.includes('tidak ditemukan')) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        ✓ PASS: Non-existent anggota properly rejected<br>
                        Error: ${result.error}
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        ✗ FAIL: Should reject non-existent anggota
                    </div>
                `;
            }
        }
        
        function runAllTests() {
            setupTestData();
            
            setTimeout(() => {
                testActiveAnggota();
                testKeluarAnggotaPOS();
                testKeluarAnggotaSimpanan();
                testKeluarAnggotaPinjaman();
                testNonExistentAnggota();
                
                setTimeout(() => {
                    document.getElementById('summaryResult').innerHTML = `
                        <div class="alert alert-info">
                            <strong>All tests completed!</strong><br>
                            Check individual test results above.
                        </div>
                    `;
                }, 500);
            }, 500);
        }
    </script>
</body>
</html>
