<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Payment History Modal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .test-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .table-row-clickable {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .table-row-clickable:hover {
            background-color: #f0f8ff !important;
        }
        .test-result {
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .test-pass {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .test-fail {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">
            <i class="bi bi-clipboard-check me-2"></i>
            Test Payment History Modal
        </h1>

        <!-- Test 1: Modal with payment history -->
        <div class="test-section">
            <h3>Test 1: Anggota dengan Riwayat Pembayaran</h3>
            <p class="text-muted">Klik baris untuk melihat modal dengan riwayat pembayaran</p>
            
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Nama</th>
                        <th>Total Kredit</th>
                        <th>Total Pembayaran</th>
                        <th>Saldo Hutang</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="table-row-clickable" onclick="testShowPaymentHistory('A001', 'Budi Santoso')" title="Klik untuk melihat riwayat pembayaran">
                        <td>
                            <strong>Budi Santoso</strong>
                            <i class="bi bi-info-circle-fill text-primary" style="font-size: 0.8rem;"></i>
                        </td>
                        <td>Rp 5.000.000</td>
                        <td class="text-primary">Rp 2.000.000</td>
                        <td><strong class="text-danger">Rp 3.000.000</strong></td>
                        <td><span class="badge bg-warning text-dark">Belum Lunas</span></td>
                    </tr>
                </tbody>
            </table>
            
            <div id="test1Result" class="test-result" style="display: none;"></div>
        </div>

        <!-- Test 2: Modal without payment history -->
        <div class="test-section">
            <h3>Test 2: Anggota Tanpa Riwayat Pembayaran</h3>
            <p class="text-muted">Klik baris untuk melihat modal dengan pesan "Belum ada pembayaran"</p>
            
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Nama</th>
                        <th>Total Kredit</th>
                        <th>Total Pembayaran</th>
                        <th>Saldo Hutang</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="table-row-clickable" onclick="testShowPaymentHistoryEmpty('A999', 'Siti Nurhaliza')" title="Klik untuk melihat riwayat pembayaran">
                        <td>
                            <strong>Siti Nurhaliza</strong>
                            <i class="bi bi-info-circle-fill text-primary" style="font-size: 0.8rem;"></i>
                        </td>
                        <td>Rp 1.000.000</td>
                        <td class="text-primary">Rp 0</td>
                        <td><strong class="text-danger">Rp 1.000.000</strong></td>
                        <td><span class="badge bg-warning text-dark">Belum Lunas</span></td>
                    </tr>
                </tbody>
            </table>
            
            <div id="test2Result" class="test-result" style="display: none;"></div>
        </div>

        <!-- Test 3: Modal with multiple payments -->
        <div class="test-section">
            <h3>Test 3: Anggota dengan Banyak Pembayaran</h3>
            <p class="text-muted">Klik baris untuk melihat modal dengan multiple payment records</p>
            
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Nama</th>
                        <th>Total Kredit</th>
                        <th>Total Pembayaran</th>
                        <th>Saldo Hutang</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="table-row-clickable" onclick="testShowPaymentHistoryMultiple('A002', 'Ahmad Dahlan')" title="Klik untuk melihat riwayat pembayaran">
                        <td>
                            <strong>Ahmad Dahlan</strong>
                            <i class="bi bi-info-circle-fill text-primary" style="font-size: 0.8rem;"></i>
                        </td>
                        <td>Rp 10.000.000</td>
                        <td class="text-primary">Rp 10.000.000</td>
                        <td><strong class="text-success">Rp 0</strong></td>
                        <td><span class="badge bg-success">Lunas</span></td>
                    </tr>
                </tbody>
            </table>
            
            <div id="test3Result" class="test-result" style="display: none;"></div>
        </div>

        <!-- Test 4: Direct function test -->
        <div class="test-section">
            <h3>Test 4: Direct Function Call</h3>
            <p class="text-muted">Test fungsi showPaymentHistory() secara langsung</p>
            
            <button class="btn btn-primary" onclick="testDirectFunctionCall()">
                <i class="bi bi-play-fill me-1"></i>
                Test Direct Call
            </button>
            
            <div id="test4Result" class="test-result" style="display: none;"></div>
        </div>

        <!-- Test Results Summary -->
        <div class="test-section">
            <h3>Test Summary</h3>
            <div id="testSummary">
                <p class="text-muted">Jalankan semua test untuk melihat summary</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/reports.js"></script>
    
    <script>
        // Setup test data
        function setupTestData() {
            // Clear existing data
            localStorage.clear();
            
            // Create test anggota
            const anggota = [
                { id: 'A001', nama: 'Budi Santoso', nik: '1234567890' },
                { id: 'A002', nama: 'Ahmad Dahlan', nik: '0987654321' },
                { id: 'A999', nama: 'Siti Nurhaliza', nik: '1111111111' }
            ];
            localStorage.setItem('anggota', JSON.stringify(anggota));
            
            // Create test penjualan (kredit transactions)
            const penjualan = [
                {
                    id: 'P001',
                    tanggal: new Date('2024-01-15').toISOString(),
                    anggotaId: 'A001',
                    total: 5000000,
                    metodePembayaran: 'kredit'
                },
                {
                    id: 'P002',
                    tanggal: new Date('2024-02-10').toISOString(),
                    anggotaId: 'A002',
                    total: 10000000,
                    metodePembayaran: 'kredit'
                },
                {
                    id: 'P003',
                    tanggal: new Date('2024-03-05').toISOString(),
                    anggotaId: 'A999',
                    total: 1000000,
                    metodePembayaran: 'kredit'
                }
            ];
            localStorage.setItem('penjualan', JSON.stringify(penjualan));
            
            // Create test pembayaran hutang
            const pembayaranHutang = [
                {
                    id: 'PH001',
                    tanggal: new Date('2024-01-20').toISOString(),
                    anggotaId: 'A001',
                    jumlah: 1000000,
                    kasir: 'kasir1',
                    kasirNama: 'Kasir Satu'
                },
                {
                    id: 'PH002',
                    tanggal: new Date('2024-02-01').toISOString(),
                    anggotaId: 'A001',
                    jumlah: 1000000,
                    kasir: 'kasir2',
                    kasirNama: 'Kasir Dua'
                },
                {
                    id: 'PH003',
                    tanggal: new Date('2024-02-15').toISOString(),
                    anggotaId: 'A002',
                    jumlah: 3000000,
                    kasir: 'kasir1',
                    kasirNama: 'Kasir Satu'
                },
                {
                    id: 'PH004',
                    tanggal: new Date('2024-02-20').toISOString(),
                    anggotaId: 'A002',
                    jumlah: 3000000,
                    kasir: 'kasir1',
                    kasirNama: 'Kasir Satu'
                },
                {
                    id: 'PH005',
                    tanggal: new Date('2024-03-01').toISOString(),
                    anggotaId: 'A002',
                    jumlah: 4000000,
                    kasir: 'kasir2',
                    kasirNama: 'Kasir Dua'
                }
            ];
            localStorage.setItem('pembayaranHutang', JSON.stringify(pembayaranHutang));
            
            console.log('Test data setup complete');
        }
        
        // Initialize test data on page load
        setupTestData();
        
        // Test 1: Show payment history with data
        function testShowPaymentHistory(anggotaId, anggotaNama) {
            try {
                showPaymentHistory(anggotaId, anggotaNama);
                
                // Check if modal exists
                setTimeout(() => {
                    const modal = document.getElementById('paymentHistoryModal');
                    const resultDiv = document.getElementById('test1Result');
                    
                    if (modal) {
                        resultDiv.className = 'test-result test-pass';
                        resultDiv.innerHTML = '<i class="bi bi-check-circle me-2"></i><strong>PASS:</strong> Modal berhasil ditampilkan dengan riwayat pembayaran';
                        resultDiv.style.display = 'block';
                    } else {
                        resultDiv.className = 'test-result test-fail';
                        resultDiv.innerHTML = '<i class="bi bi-x-circle me-2"></i><strong>FAIL:</strong> Modal tidak ditemukan';
                        resultDiv.style.display = 'block';
                    }
                }, 100);
            } catch (error) {
                const resultDiv = document.getElementById('test1Result');
                resultDiv.className = 'test-result test-fail';
                resultDiv.innerHTML = `<i class="bi bi-x-circle me-2"></i><strong>ERROR:</strong> ${error.message}`;
                resultDiv.style.display = 'block';
            }
        }
        
        // Test 2: Show payment history without data
        function testShowPaymentHistoryEmpty(anggotaId, anggotaNama) {
            try {
                showPaymentHistory(anggotaId, anggotaNama);
                
                setTimeout(() => {
                    const modal = document.getElementById('paymentHistoryModal');
                    const resultDiv = document.getElementById('test2Result');
                    
                    if (modal) {
                        const emptyMessage = modal.querySelector('td[colspan="4"]');
                        if (emptyMessage && emptyMessage.textContent.includes('Belum ada pembayaran')) {
                            resultDiv.className = 'test-result test-pass';
                            resultDiv.innerHTML = '<i class="bi bi-check-circle me-2"></i><strong>PASS:</strong> Modal menampilkan pesan "Belum ada pembayaran"';
                        } else {
                            resultDiv.className = 'test-result test-fail';
                            resultDiv.innerHTML = '<i class="bi bi-x-circle me-2"></i><strong>FAIL:</strong> Pesan empty state tidak ditemukan';
                        }
                    } else {
                        resultDiv.className = 'test-result test-fail';
                        resultDiv.innerHTML = '<i class="bi bi-x-circle me-2"></i><strong>FAIL:</strong> Modal tidak ditemukan';
                    }
                    resultDiv.style.display = 'block';
                }, 100);
            } catch (error) {
                const resultDiv = document.getElementById('test2Result');
                resultDiv.className = 'test-result test-fail';
                resultDiv.innerHTML = `<i class="bi bi-x-circle me-2"></i><strong>ERROR:</strong> ${error.message}`;
                resultDiv.style.display = 'block';
            }
        }
        
        // Test 3: Show payment history with multiple payments
        function testShowPaymentHistoryMultiple(anggotaId, anggotaNama) {
            try {
                showPaymentHistory(anggotaId, anggotaNama);
                
                setTimeout(() => {
                    const modal = document.getElementById('paymentHistoryModal');
                    const resultDiv = document.getElementById('test3Result');
                    
                    if (modal) {
                        const rows = modal.querySelectorAll('tbody tr');
                        const rowCount = rows.length;
                        
                        if (rowCount === 3) { // A002 has 3 payments
                            resultDiv.className = 'test-result test-pass';
                            resultDiv.innerHTML = `<i class="bi bi-check-circle me-2"></i><strong>PASS:</strong> Modal menampilkan ${rowCount} pembayaran`;
                        } else {
                            resultDiv.className = 'test-result test-fail';
                            resultDiv.innerHTML = `<i class="bi bi-x-circle me-2"></i><strong>FAIL:</strong> Expected 3 payments, got ${rowCount}`;
                        }
                    } else {
                        resultDiv.className = 'test-result test-fail';
                        resultDiv.innerHTML = '<i class="bi bi-x-circle me-2"></i><strong>FAIL:</strong> Modal tidak ditemukan';
                    }
                    resultDiv.style.display = 'block';
                }, 100);
            } catch (error) {
                const resultDiv = document.getElementById('test3Result');
                resultDiv.className = 'test-result test-fail';
                resultDiv.innerHTML = `<i class="bi bi-x-circle me-2"></i><strong>ERROR:</strong> ${error.message}`;
                resultDiv.style.display = 'block';
            }
        }
        
        // Test 4: Direct function call
        function testDirectFunctionCall() {
            try {
                const resultDiv = document.getElementById('test4Result');
                
                // Test if function exists
                if (typeof showPaymentHistory !== 'function') {
                    resultDiv.className = 'test-result test-fail';
                    resultDiv.innerHTML = '<i class="bi bi-x-circle me-2"></i><strong>FAIL:</strong> Function showPaymentHistory tidak ditemukan';
                    resultDiv.style.display = 'block';
                    return;
                }
                
                // Call function
                showPaymentHistory('A001', 'Test User');
                
                // Verify modal was created
                setTimeout(() => {
                    const modal = document.getElementById('paymentHistoryModal');
                    if (modal) {
                        resultDiv.className = 'test-result test-pass';
                        resultDiv.innerHTML = '<i class="bi bi-check-circle me-2"></i><strong>PASS:</strong> Function berhasil dipanggil dan modal dibuat';
                    } else {
                        resultDiv.className = 'test-result test-fail';
                        resultDiv.innerHTML = '<i class="bi bi-x-circle me-2"></i><strong>FAIL:</strong> Modal tidak dibuat setelah function call';
                    }
                    resultDiv.style.display = 'block';
                }, 100);
            } catch (error) {
                const resultDiv = document.getElementById('test4Result');
                resultDiv.className = 'test-result test-fail';
                resultDiv.innerHTML = `<i class="bi bi-x-circle me-2"></i><strong>ERROR:</strong> ${error.message}`;
                resultDiv.style.display = 'block';
            }
        }
        
        // Console logging for debugging
        console.log('Test page loaded');
        console.log('Available functions:', {
            showPaymentHistory: typeof showPaymentHistory,
            getPembayaranHutangHistory: typeof getPembayaranHutangHistory,
            formatRupiah: typeof formatRupiah
        });
    </script>
</body>
</html>
