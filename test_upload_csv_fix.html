<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Upload CSV Fix</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1>Test Upload Master Barang CSV</h1>
        
        <div class="alert alert-info">
            <h5>Test Steps:</h5>
            <ol>
                <li>Download template CSV</li>
                <li>Upload file CSV</li>
                <li>Verify preview shows correctly</li>
                <li>Check validation works</li>
            </ol>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>1. Download Template</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="downloadTemplate()">
                            <i class="fas fa-download me-2"></i>Download Template CSV
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>2. Test Upload</h5>
                    </div>
                    <div class="card-body">
                        <input type="file" class="form-control" id="fileInput" accept=".csv" onchange="testUpload(event)">
                        <div class="mt-2">
                            <small class="text-muted">Select the downloaded template or any CSV file</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="testResults">
                            <p class="text-muted">No tests run yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Include required scripts -->
    <script src="js/upload-excel/types.js"></script>
    <script src="js/upload-excel/ValidationEngine.js"></script>
    <script src="js/upload-excel/DataProcessor.js"></script>
    <script src="js/upload-excel/CategoryUnitManager.js"></script>
    <script src="js/upload-excel/AuditLogger.js"></script>
    <script src="js/upload-excel/ExcelUploadManager.js"></script>

    <script>
        let uploadManager;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            try {
                uploadManager = new ExcelUploadManager();
                logResult('‚úÖ ExcelUploadManager initialized successfully');
                
                // Test component initialization
                if (uploadManager.processor) {
                    logResult('‚úÖ DataProcessor initialized');
                } else {
                    logResult('‚ùå DataProcessor not initialized');
                }
                
                if (uploadManager.validator) {
                    logResult('‚úÖ ValidationEngine initialized');
                } else {
                    logResult('‚ùå ValidationEngine not initialized');
                }
                
            } catch (error) {
                logResult('‚ùå Initialization failed: ' + error.message);
            }
        });
        
        function downloadTemplate() {
            const template = `kode,nama,kategori,satuan,harga_beli,stok,supplier
BRG001,Beras Premium 5kg,makanan,kg,65000,50,PT Beras Sejahtera
BRG002,Minyak Goreng 1L,makanan,botol,15000,30,CV Minyak Murni
BRG003,Pulpen Pilot Hitam,alat-tulis,pcs,3000,100,Toko ATK Lengkap`;

            const blob = new Blob([template], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'test_template.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            logResult('‚úÖ Template downloaded successfully');
        }
        
        async function testUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            logResult(`üìÅ Testing file: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);
            
            try {
                // Test file processing
                const data = await uploadManager.processFileContent(file);
                logResult(`‚úÖ File processed successfully: ${data.length} records found`);
                
                // Test preview generation
                const preview = await uploadManager.previewData(data);
                logResult(`‚úÖ Preview generated: ${preview.data.length} rows`);
                
                if (preview.summary) {
                    logResult(`üìä Summary - Total: ${preview.summary.totalRows}, Valid: ${preview.summary.validRows}, Errors: ${preview.summary.errorRows}, Warnings: ${preview.summary.warningRows}`);
                }
                
                // Show sample data
                if (data.length > 0) {
                    const sample = data[0];
                    logResult(`üìã Sample record: ${sample.kode} - ${sample.nama} (${sample.kategori})`);
                }
                
                logResult('üéâ All tests passed! CSV upload is working correctly.');
                
            } catch (error) {
                logResult('‚ùå Test failed: ' + error.message);
                console.error('Upload test error:', error);
            }
        }
        
        function logResult(message) {
            const resultsDiv = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            
            if (resultsDiv.innerHTML.includes('No tests run yet')) {
                resultsDiv.innerHTML = '';
            }
            
            resultsDiv.innerHTML += `<div class="mb-1"><small class="text-muted">[${timestamp}]</small> ${message}</div>`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
    </script>
</body>
</html>