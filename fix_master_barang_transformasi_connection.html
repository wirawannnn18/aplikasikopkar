<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Koneksi Master Barang - Transformasi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .status-card {
            border-left: 4px solid #007bff;
            transition: all 0.3s ease;
        }
        .status-card.success {
            border-left-color: #28a745;
            background-color: #f8fff9;
        }
        .status-card.warning {
            border-left-color: #ffc107;
            background-color: #fffdf5;
        }
        .status-card.error {
            border-left-color: #dc3545;
            background-color: #fff5f5;
        }
        .fix-button {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .fix-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,123,255,0.3);
        }
        .progress-step {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .progress-step.completed {
            background: #d4edda;
            color: #155724;
        }
        .progress-step.error {
            background: #f8d7da;
            color: #721c24;
        }
        .step-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            background: #6c757d;
            color: white;
            font-size: 14px;
        }
        .step-icon.completed {
            background: #28a745;
        }
        .step-icon.error {
            background: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2><i class="bi bi-tools me-2"></i>Fix Koneksi Master Barang - Transformasi</h2>
                        <p class="text-muted mb-0">Memperbaiki koneksi antara form master barang dengan sistem transformasi barang</p>
                    </div>
                    <button class="btn btn-outline-secondary" onclick="window.location.reload()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                    </button>
                </div>

                <!-- Status Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card status-card" id="masterBarangStatus">
                            <div class="card-body text-center">
                                <i class="bi bi-database display-4 text-primary"></i>
                                <h6 class="mt-2">Master Barang</h6>
                                <span class="badge bg-secondary" id="masterBarangCount">Checking...</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card status-card" id="transformationStatus">
                            <div class="card-body text-center">
                                <i class="bi bi-arrow-left-right display-4 text-info"></i>
                                <h6 class="mt-2">Transformasi</h6>
                                <span class="badge bg-secondary" id="transformationCount">Checking...</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card status-card" id="conversionStatus">
                            <div class="card-body text-center">
                                <i class="bi bi-calculator display-4 text-warning"></i>
                                <h6 class="mt-2">Rasio Konversi</h6>
                                <span class="badge bg-secondary" id="conversionCount">Checking...</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card status-card" id="integrationStatus">
                            <div class="card-body text-center">
                                <i class="bi bi-link display-4 text-success"></i>
                                <h6 class="mt-2">Integrasi</h6>
                                <span class="badge bg-secondary" id="integrationBadge">Checking...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="row">
                    <div class="col-lg-8">
                        <!-- Diagnosis Section -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-search me-2"></i>Diagnosis Sistem</h5>
                            </div>
                            <div class="card-body">
                                <div id="diagnosisResults">
                                    <div class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2 text-muted">Melakukan diagnosis sistem...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Fix Progress Section -->
                        <div class="card mb-4" id="fixProgressCard" style="display: none;">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Progress Perbaikan</h5>
                            </div>
                            <div class="card-body">
                                <div id="fixProgress">
                                    <!-- Progress steps will be populated here -->
                                </div>
                                <div class="mt-3">
                                    <button class="btn fix-button" id="startFixBtn" onclick="startFix()">
                                        <i class="bi bi-play-fill me-2"></i>Mulai Perbaikan
                                    </button>
                                    <button class="btn btn-outline-success ms-2" id="testConnectionBtn" onclick="testConnection()" style="display: none;">
                                        <i class="bi bi-check-circle me-2"></i>Test Koneksi
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <!-- Quick Actions -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-lightning me-2"></i>Quick Actions</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="viewMasterBarang()">
                                        <i class="bi bi-eye me-1"></i>Lihat Master Barang
                                    </button>
                                    <button class="btn btn-outline-info btn-sm" onclick="viewTransformations()">
                                        <i class="bi bi-list me-1"></i>Lihat Transformasi
                                    </button>
                                    <button class="btn btn-outline-warning btn-sm" onclick="viewConversions()">
                                        <i class="bi bi-calculator me-1"></i>Lihat Rasio Konversi
                                    </button>
                                    <button class="btn btn-outline-success btn-sm" onclick="createSampleData()">
                                        <i class="bi bi-plus-circle me-1"></i>Buat Data Contoh
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- System Info -->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Informasi Sistem</h6>
                            </div>
                            <div class="card-body">
                                <div id="systemInfo">
                                    <div class="small text-muted">Loading system information...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/koperasi.js"></script>
    
    <!-- Transformasi Barang Modules -->
    <script src="js/transformasi-barang/types.js"></script>
    <script src="js/transformasi-barang/DataModels.js"></script>
    <script src="js/transformasi-barang/ValidationEngine.js"></script>
    <script src="js/transformasi-barang/ConversionCalculator.js"></script>
    <script src="js/transformasi-barang/StockManager.js"></script>
    <script src="js/transformasi-barang/AuditLogger.js"></script>
    <script src="js/transformasi-barang/TransformationManager.js"></script>
    
    <!-- Integration Module -->
    <script src="js/masterBarangIntegration.js"></script>

    <script>
        let diagnosisResults = {};
        let fixSteps = [];

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                runDiagnosis();
            }, 1000);
        });

        /**
         * Run system diagnosis
         */
        async function runDiagnosis() {
            try {
                diagnosisResults = {
                    masterBarang: await checkMasterBarang(),
                    transformation: await checkTransformationSystem(),
                    conversion: await checkConversionRatios(),
                    integration: await checkIntegration()
                };

                displayDiagnosisResults();
                updateStatusCards();
                prepareFix();

            } catch (error) {
                console.error('Error running diagnosis:', error);
                showError('Gagal melakukan diagnosis sistem');
            }
        }

        /**
         * Check master barang data
         */
        async function checkMasterBarang() {
            try {
                const masterBarang = JSON.parse(localStorage.getItem('masterBarang') || '[]');
                
                return {
                    exists: masterBarang.length > 0,
                    count: masterBarang.length,
                    hasBaseProduct: masterBarang.filter(item => item.baseProduct).length,
                    hasStock: masterBarang.filter(item => item.stok > 0).length,
                    issues: []
                };
            } catch (error) {
                return {
                    exists: false,
                    count: 0,
                    hasBaseProduct: 0,
                    hasStock: 0,
                    issues: ['Error loading master barang data']
                };
            }
        }

        /**
         * Check transformation system
         */
        async function checkTransformationSystem() {
            try {
                const hasTransformationManager = typeof TransformationManager !== 'undefined';
                const hasStockManager = typeof StockManager !== 'undefined';
                const hasValidationEngine = typeof ValidationEngine !== 'undefined';
                const hasCalculator = typeof ConversionCalculator !== 'undefined';
                const hasAuditLogger = typeof AuditLogger !== 'undefined';
                
                const history = JSON.parse(localStorage.getItem('transformationHistory') || '[]');
                
                return {
                    componentsLoaded: hasTransformationManager && hasStockManager && hasValidationEngine && hasCalculator && hasAuditLogger,
                    transformationManager: hasTransformationManager,
                    stockManager: hasStockManager,
                    validationEngine: hasValidationEngine,
                    calculator: hasCalculator,
                    auditLogger: hasAuditLogger,
                    historyCount: history.length,
                    issues: []
                };
            } catch (error) {
                return {
                    componentsLoaded: false,
                    transformationManager: false,
                    stockManager: false,
                    validationEngine: false,
                    calculator: false,
                    auditLogger: false,
                    historyCount: 0,
                    issues: ['Error checking transformation system']
                };
            }
        }

        /**
         * Check conversion ratios
         */
        async function checkConversionRatios() {
            try {
                const ratios = JSON.parse(localStorage.getItem('conversionRatios') || '[]');
                
                return {
                    exists: ratios.length > 0,
                    count: ratios.length,
                    totalConversions: ratios.reduce((sum, ratio) => sum + (ratio.conversions ? ratio.conversions.length : 0), 0),
                    issues: []
                };
            } catch (error) {
                return {
                    exists: false,
                    count: 0,
                    totalConversions: 0,
                    issues: ['Error loading conversion ratios']
                };
            }
        }

        /**
         * Check integration status
         */
        async function checkIntegration() {
            try {
                const hasIntegration = typeof MasterBarangIntegration !== 'undefined';
                const integrationInstance = window.masterBarangIntegration;
                
                return {
                    moduleLoaded: hasIntegration,
                    instanceExists: !!integrationInstance,
                    initialized: integrationInstance ? integrationInstance.initialized : false,
                    issues: []
                };
            } catch (error) {
                return {
                    moduleLoaded: false,
                    instanceExists: false,
                    initialized: false,
                    issues: ['Error checking integration']
                };
            }
        }

        /**
         * Display diagnosis results
         */
        function displayDiagnosisResults() {
            const container = document.getElementById('diagnosisResults');
            let html = '';

            // Master Barang Status
            html += `
                <div class="mb-3">
                    <h6><i class="bi bi-database me-2"></i>Master Barang</h6>
                    <div class="ps-3">
                        <div class="small">
                            <span class="badge ${diagnosisResults.masterBarang.exists ? 'bg-success' : 'bg-danger'}">
                                ${diagnosisResults.masterBarang.exists ? 'OK' : 'MISSING'}
                            </span>
                            ${diagnosisResults.masterBarang.count} items total
                        </div>
                        <div class="small text-muted">
                            ${diagnosisResults.masterBarang.hasBaseProduct} items dengan baseProduct, 
                            ${diagnosisResults.masterBarang.hasStock} items dengan stok
                        </div>
                    </div>
                </div>
            `;

            // Transformation System Status
            html += `
                <div class="mb-3">
                    <h6><i class="bi bi-arrow-left-right me-2"></i>Sistem Transformasi</h6>
                    <div class="ps-3">
                        <div class="small">
                            <span class="badge ${diagnosisResults.transformation.componentsLoaded ? 'bg-success' : 'bg-danger'}">
                                ${diagnosisResults.transformation.componentsLoaded ? 'LOADED' : 'MISSING'}
                            </span>
                            ${diagnosisResults.transformation.historyCount} transformasi dalam history
                        </div>
                        <div class="small text-muted">
                            TM: ${diagnosisResults.transformation.transformationManager ? '✓' : '✗'}, 
                            SM: ${diagnosisResults.transformation.stockManager ? '✓' : '✗'}, 
                            VE: ${diagnosisResults.transformation.validationEngine ? '✓' : '✗'}, 
                            CC: ${diagnosisResults.transformation.calculator ? '✓' : '✗'}, 
                            AL: ${diagnosisResults.transformation.auditLogger ? '✓' : '✗'}
                        </div>
                    </div>
                </div>
            `;

            // Conversion Ratios Status
            html += `
                <div class="mb-3">
                    <h6><i class="bi bi-calculator me-2"></i>Rasio Konversi</h6>
                    <div class="ps-3">
                        <div class="small">
                            <span class="badge ${diagnosisResults.conversion.exists ? 'bg-success' : 'bg-warning'}">
                                ${diagnosisResults.conversion.exists ? 'EXISTS' : 'EMPTY'}
                            </span>
                            ${diagnosisResults.conversion.count} produk, ${diagnosisResults.conversion.totalConversions} konversi
                        </div>
                    </div>
                </div>
            `;

            // Integration Status
            html += `
                <div class="mb-3">
                    <h6><i class="bi bi-link me-2"></i>Integrasi</h6>
                    <div class="ps-3">
                        <div class="small">
                            <span class="badge ${diagnosisResults.integration.initialized ? 'bg-success' : 'bg-warning'}">
                                ${diagnosisResults.integration.initialized ? 'READY' : 'NOT READY'}
                            </span>
                            Module: ${diagnosisResults.integration.moduleLoaded ? '✓' : '✗'}, 
                            Instance: ${diagnosisResults.integration.instanceExists ? '✓' : '✗'}
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        /**
         * Update status cards
         */
        function updateStatusCards() {
            // Master Barang Card
            const masterCard = document.getElementById('masterBarangStatus');
            const masterCount = document.getElementById('masterBarangCount');
            masterCount.textContent = `${diagnosisResults.masterBarang.count} items`;
            masterCard.className = `card status-card ${diagnosisResults.masterBarang.exists ? 'success' : 'error'}`;

            // Transformation Card
            const transformationCard = document.getElementById('transformationStatus');
            const transformationCount = document.getElementById('transformationCount');
            transformationCount.textContent = diagnosisResults.transformation.componentsLoaded ? 'Ready' : 'Not Ready';
            transformationCard.className = `card status-card ${diagnosisResults.transformation.componentsLoaded ? 'success' : 'error'}`;

            // Conversion Card
            const conversionCard = document.getElementById('conversionStatus');
            const conversionCount = document.getElementById('conversionCount');
            conversionCount.textContent = `${diagnosisResults.conversion.count} groups`;
            conversionCard.className = `card status-card ${diagnosisResults.conversion.exists ? 'success' : 'warning'}`;

            // Integration Card
            const integrationCard = document.getElementById('integrationStatus');
            const integrationBadge = document.getElementById('integrationBadge');
            integrationBadge.textContent = diagnosisResults.integration.initialized ? 'Connected' : 'Disconnected';
            integrationCard.className = `card status-card ${diagnosisResults.integration.initialized ? 'success' : 'warning'}`;
        }

        /**
         * Prepare fix steps
         */
        function prepareFix() {
            fixSteps = [];

            // Check what needs to be fixed
            if (!diagnosisResults.masterBarang.exists) {
                fixSteps.push({
                    id: 'createSampleMasterBarang',
                    title: 'Buat Data Master Barang Contoh',
                    description: 'Membuat data master barang contoh untuk testing',
                    status: 'pending'
                });
            }

            if (diagnosisResults.masterBarang.exists && diagnosisResults.masterBarang.hasBaseProduct < diagnosisResults.masterBarang.count) {
                fixSteps.push({
                    id: 'addBaseProductFields',
                    title: 'Tambah Field baseProduct',
                    description: 'Menambahkan field baseProduct ke items yang belum memilikinya',
                    status: 'pending'
                });
            }

            if (!diagnosisResults.conversion.exists) {
                fixSteps.push({
                    id: 'createConversionRatios',
                    title: 'Buat Rasio Konversi',
                    description: 'Membuat rasio konversi default untuk transformasi',
                    status: 'pending'
                });
            }

            if (!diagnosisResults.transformation.componentsLoaded) {
                fixSteps.push({
                    id: 'initializeTransformationSystem',
                    title: 'Inisialisasi Sistem Transformasi',
                    description: 'Menginisialisasi komponen sistem transformasi',
                    status: 'pending'
                });
            }

            if (!diagnosisResults.integration.initialized) {
                fixSteps.push({
                    id: 'initializeIntegration',
                    title: 'Inisialisasi Integrasi',
                    description: 'Menginisialisasi integrasi master barang dengan transformasi',
                    status: 'pending'
                });
            }

            displayFixSteps();
        }

        /**
         * Display fix steps
         */
        function displayFixSteps() {
            const container = document.getElementById('fixProgress');
            const card = document.getElementById('fixProgressCard');

            if (fixSteps.length === 0) {
                card.style.display = 'none';
                return;
            }

            card.style.display = 'block';
            
            let html = '';
            fixSteps.forEach((step, index) => {
                html += `
                    <div class="progress-step ${step.status}" id="step-${step.id}">
                        <div class="step-icon ${step.status}" id="icon-${step.id}">
                            ${step.status === 'completed' ? '<i class="bi bi-check"></i>' : 
                              step.status === 'error' ? '<i class="bi bi-x"></i>' : 
                              index + 1}
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-bold">${step.title}</div>
                            <div class="small text-muted">${step.description}</div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        /**
         * Start fix process
         */
        async function startFix() {
            const startBtn = document.getElementById('startFixBtn');
            startBtn.disabled = true;
            startBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Memperbaiki...';

            try {
                for (const step of fixSteps) {
                    await executeFixStep(step);
                }

                startBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Selesai';
                startBtn.className = 'btn btn-success';
                
                document.getElementById('testConnectionBtn').style.display = 'inline-block';

                showSuccess('Perbaikan selesai! Sistem siap digunakan.');

            } catch (error) {
                console.error('Error during fix:', error);
                startBtn.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Error';
                startBtn.className = 'btn btn-danger';
                showError('Terjadi error saat perbaikan: ' + error.message);
            }
        }

        /**
         * Execute individual fix step
         */
        async function executeFixStep(step) {
            const stepElement = document.getElementById(`step-${step.id}`);
            const iconElement = document.getElementById(`icon-${step.id}`);
            
            // Mark as in progress
            stepElement.className = 'progress-step';
            iconElement.innerHTML = '<i class="bi bi-hourglass-split"></i>';

            try {
                switch (step.id) {
                    case 'createSampleMasterBarang':
                        await createSampleMasterBarang();
                        break;
                    case 'addBaseProductFields':
                        await addBaseProductFields();
                        break;
                    case 'createConversionRatios':
                        await createDefaultConversionRatios();
                        break;
                    case 'initializeTransformationSystem':
                        await initializeTransformationSystem();
                        break;
                    case 'initializeIntegration':
                        await initializeIntegrationSystem();
                        break;
                }

                // Mark as completed
                step.status = 'completed';
                stepElement.className = 'progress-step completed';
                iconElement.innerHTML = '<i class="bi bi-check"></i>';

                // Wait a bit for visual feedback
                await new Promise(resolve => setTimeout(resolve, 500));

            } catch (error) {
                // Mark as error
                step.status = 'error';
                stepElement.className = 'progress-step error';
                iconElement.innerHTML = '<i class="bi bi-x"></i>';
                throw error;
            }
        }

        /**
         * Create sample master barang data
         */
        async function createSampleMasterBarang() {
            const sampleData = [
                {
                    kode: 'BRG001-KG',
                    nama: 'Beras Premium (Kilogram)',
                    kategori: 'makanan',
                    satuan: 'kg',
                    hargaBeli: 12000,
                    stok: 100,
                    supplier: 'PT Beras Sejahtera',
                    baseProduct: 'BRG001',
                    tanggalBuat: new Date().toISOString(),
                    tanggalUpdate: new Date().toISOString()
                },
                {
                    kode: 'BRG001-GR',
                    nama: 'Beras Premium (Gram)',
                    kategori: 'makanan',
                    satuan: 'gram',
                    hargaBeli: 12,
                    stok: 50000,
                    supplier: 'PT Beras Sejahtera',
                    baseProduct: 'BRG001',
                    tanggalBuat: new Date().toISOString(),
                    tanggalUpdate: new Date().toISOString()
                },
                {
                    kode: 'BRG002-LT',
                    nama: 'Minyak Goreng (Liter)',
                    kategori: 'makanan',
                    satuan: 'liter',
                    hargaBeli: 15000,
                    stok: 50,
                    supplier: 'CV Minyak Murni',
                    baseProduct: 'BRG002',
                    tanggalBuat: new Date().toISOString(),
                    tanggalUpdate: new Date().toISOString()
                },
                {
                    kode: 'BRG002-ML',
                    nama: 'Minyak Goreng (Mililiter)',
                    kategori: 'makanan',
                    satuan: 'ml',
                    hargaBeli: 15,
                    stok: 25000,
                    supplier: 'CV Minyak Murni',
                    baseProduct: 'BRG002',
                    tanggalBuat: new Date().toISOString(),
                    tanggalUpdate: new Date().toISOString()
                },
                {
                    kode: 'BRG003-DUS',
                    nama: 'Pulpen Pilot (Dus)',
                    kategori: 'alat-tulis',
                    satuan: 'dus',
                    hargaBeli: 36000,
                    stok: 10,
                    supplier: 'Toko ATK Lengkap',
                    baseProduct: 'BRG003',
                    tanggalBuat: new Date().toISOString(),
                    tanggalUpdate: new Date().toISOString()
                },
                {
                    kode: 'BRG003-PCS',
                    nama: 'Pulpen Pilot (Pieces)',
                    kategori: 'alat-tulis',
                    satuan: 'pcs',
                    hargaBeli: 3000,
                    stok: 120,
                    supplier: 'Toko ATK Lengkap',
                    baseProduct: 'BRG003',
                    tanggalBuat: new Date().toISOString(),
                    tanggalUpdate: new Date().toISOString()
                }
            ];

            localStorage.setItem('masterBarang', JSON.stringify(sampleData));
        }

        /**
         * Add baseProduct fields to existing items
         */
        async function addBaseProductFields() {
            const masterBarang = JSON.parse(localStorage.getItem('masterBarang') || '[]');
            let updated = false;

            masterBarang.forEach(item => {
                if (!item.baseProduct) {
                    item.baseProduct = item.kode.split('-')[0];
                    updated = true;
                }
            });

            if (updated) {
                localStorage.setItem('masterBarang', JSON.stringify(masterBarang));
            }
        }

        /**
         * Create default conversion ratios
         */
        async function createDefaultConversionRatios() {
            const defaultRatios = [
                {
                    baseProduct: 'BRG001',
                    conversions: [
                        { from: 'kg', to: 'gram', ratio: 1000 },
                        { from: 'gram', to: 'kg', ratio: 0.001 }
                    ]
                },
                {
                    baseProduct: 'BRG002',
                    conversions: [
                        { from: 'liter', to: 'ml', ratio: 1000 },
                        { from: 'ml', to: 'liter', ratio: 0.001 }
                    ]
                },
                {
                    baseProduct: 'BRG003',
                    conversions: [
                        { from: 'dus', to: 'pcs', ratio: 12 },
                        { from: 'pcs', to: 'dus', ratio: 0.083 }
                    ]
                }
            ];

            localStorage.setItem('conversionRatios', JSON.stringify(defaultRatios));
        }

        /**
         * Initialize transformation system
         */
        async function initializeTransformationSystem() {
            if (typeof TransformationManager === 'undefined') {
                throw new Error('TransformationManager class not loaded');
            }

            // Initialize components
            window.stockManager = new StockManager();
            window.validationEngine = new ValidationEngine();
            window.calculator = new ConversionCalculator();
            window.auditLogger = new AuditLogger();
            window.transformationManager = new TransformationManager();

            // Initialize each component
            window.stockManager.initialize();
            window.validationEngine.initialize();
            window.calculator.initialize();
            window.auditLogger.initialize();

            // Initialize transformation manager with dependencies
            window.transformationManager.initialize({
                validationEngine: window.validationEngine,
                calculator: window.calculator,
                stockManager: window.stockManager,
                auditLogger: window.auditLogger
            });
        }

        /**
         * Initialize integration system
         */
        async function initializeIntegrationSystem() {
            if (typeof MasterBarangIntegration === 'undefined') {
                throw new Error('MasterBarangIntegration class not loaded');
            }

            if (!window.masterBarangIntegration) {
                window.masterBarangIntegration = new MasterBarangIntegration();
            }

            // Wait for initialization
            let attempts = 0;
            while (!window.masterBarangIntegration.initialized && attempts < 10) {
                await new Promise(resolve => setTimeout(resolve, 500));
                attempts++;
            }

            if (!window.masterBarangIntegration.initialized) {
                throw new Error('Integration system failed to initialize');
            }
        }

        /**
         * Test connection between systems
         */
        async function testConnection() {
            try {
                if (!window.masterBarangIntegration) {
                    throw new Error('Integration system not available');
                }

                // Test getting transformable items
                const transformableItems = await window.masterBarangIntegration.getTransformableItemsForUI();
                
                if (transformableItems.length === 0) {
                    showWarning('Tidak ada item yang dapat ditransformasi. Pastikan ada item dengan baseProduct yang sama dan rasio konversi.');
                    return;
                }

                // Test transformation availability
                let canTransform = false;
                for (const group of transformableItems) {
                    if (group.items.length > 1) {
                        const sourceItem = group.items[0];
                        const targetItem = group.items[1];
                        
                        if (window.masterBarangIntegration.isTransformationAvailable(sourceItem.id, targetItem.id)) {
                            canTransform = true;
                            break;
                        }
                    }
                }

                if (canTransform) {
                    showSuccess(`Koneksi berhasil! Ditemukan ${transformableItems.length} grup produk yang dapat ditransformasi.`);
                } else {
                    showWarning('Koneksi berhasil, tetapi tidak ada transformasi yang tersedia. Periksa rasio konversi.');
                }

            } catch (error) {
                console.error('Connection test failed:', error);
                showError('Test koneksi gagal: ' + error.message);
            }
        }

        /**
         * Quick action functions
         */
        function viewMasterBarang() {
            const masterBarang = JSON.parse(localStorage.getItem('masterBarang') || '[]');
            console.table(masterBarang);
            alert(`Master Barang: ${masterBarang.length} items. Lihat console untuk detail.`);
        }

        function viewTransformations() {
            const history = JSON.parse(localStorage.getItem('transformationHistory') || '[]');
            console.table(history);
            alert(`Transformation History: ${history.length} records. Lihat console untuk detail.`);
        }

        function viewConversions() {
            const ratios = JSON.parse(localStorage.getItem('conversionRatios') || '[]');
            console.table(ratios);
            alert(`Conversion Ratios: ${ratios.length} groups. Lihat console untuk detail.`);
        }

        async function createSampleData() {
            try {
                await createSampleMasterBarang();
                await createDefaultConversionRatios();
                showSuccess('Data contoh berhasil dibuat!');
                setTimeout(() => window.location.reload(), 1500);
            } catch (error) {
                showError('Gagal membuat data contoh: ' + error.message);
            }
        }

        /**
         * Utility functions
         */
        function showSuccess(message) {
            alert('✅ ' + message);
        }

        function showWarning(message) {
            alert('⚠️ ' + message);
        }

        function showError(message) {
            alert('❌ ' + message);
        }

        // Update system info
        function updateSystemInfo() {
            const info = document.getElementById('systemInfo');
            const masterBarang = JSON.parse(localStorage.getItem('masterBarang') || '[]');
            const ratios = JSON.parse(localStorage.getItem('conversionRatios') || '[]');
            const history = JSON.parse(localStorage.getItem('transformationHistory') || '[]');

            info.innerHTML = `
                <div class="small">
                    <div><strong>Master Barang:</strong> ${masterBarang.length} items</div>
                    <div><strong>Conversion Ratios:</strong> ${ratios.length} groups</div>
                    <div><strong>Transformation History:</strong> ${history.length} records</div>
                    <div><strong>Integration:</strong> ${window.masterBarangIntegration ? 'Loaded' : 'Not Loaded'}</div>
                    <div><strong>Last Check:</strong> ${new Date().toLocaleTimeString()}</div>
                </div>
            `;
        }

        // Update system info every 5 seconds
        setInterval(updateSystemInfo, 5000);
        updateSystemInfo();
    </script>
</body>
</html>