<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Task 6: Import/Export Engine</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .test-pass {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .test-fail {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            transition: border-color 0.3s;
        }
        .upload-area.drag-over {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        .preview-table {
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1><i class="fas fa-exchange-alt"></i> Test Task 6: Import/Export Engine</h1>
        <p class="lead">Testing import/export functionality for master barang system</p>

        <!-- Test Results Summary -->
        <div class="test-section">
            <h3>Test Results Summary</h3>
            <div id="testSummary" class="row">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h5 id="totalTests">0</h5>
                            <small>Total Tests</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h5 id="passedTests">0</h5>
                            <small>Passed</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body text-center">
                            <h5 id="failedTests">0</h5>
                            <small>Failed</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h5 id="testProgress">0%</h5>
                            <small>Progress</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Import Engine Tests -->
        <div class="test-section">
            <h3><i class="fas fa-upload"></i> Import Engine Tests</h3>
            
            <div class="mb-3">
                <button class="btn btn-primary" onclick="testImportEngine()">
                    <i class="fas fa-play"></i> Run Import Tests
                </button>
                <button class="btn btn-success" onclick="openImportDialog()">
                    <i class="fas fa-upload"></i> Test Import Dialog
                </button>
            </div>

            <div id="importTestResults"></div>

            <!-- Sample Import Area -->
            <div class="mt-4">
                <h5>Sample Import Test</h5>
                <div class="upload-area" id="sampleUploadArea">
                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                    <p>Drop a CSV file here or click to browse</p>
                    <input type="file" id="sampleFileInput" accept=".csv" style="display: none;">
                    <button class="btn btn-outline-primary" onclick="document.getElementById('sampleFileInput').click()">
                        <i class="fas fa-folder-open"></i> Browse File
                    </button>
                </div>
                <div id="samplePreview" class="mt-3" style="display: none;">
                    <h6>Preview:</h6>
                    <div class="preview-table">
                        <table id="samplePreviewTable" class="table table-sm table-bordered">
                            <thead id="samplePreviewHeader"></thead>
                            <tbody id="samplePreviewBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Engine Tests -->
        <div class="test-section">
            <h3><i class="fas fa-download"></i> Export Engine Tests</h3>
            
            <div class="mb-3">
                <button class="btn btn-primary" onclick="testExportEngine()">
                    <i class="fas fa-play"></i> Run Export Tests
                </button>
                <button class="btn btn-success" onclick="openExportDialog()">
                    <i class="fas fa-download"></i> Test Export Dialog
                </button>
            </div>

            <div id="exportTestResults"></div>

            <!-- Sample Export Controls -->
            <div class="mt-4">
                <h5>Sample Export Test</h5>
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">Export Format:</label>
                        <select id="sampleExportFormat" class="form-select">
                            <option value="csv">CSV</option>
                            <option value="xlsx">Excel</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Sample Data Count:</label>
                        <input type="number" id="sampleDataCount" class="form-control" value="10" min="1" max="1000">
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-success" onclick="generateSampleExport()">
                        <i class="fas fa-download"></i> Generate Sample Export
                    </button>
                </div>
            </div>
        </div>

        <!-- File Processing Tests -->
        <div class="test-section">
            <h3><i class="fas fa-cogs"></i> File Processing Tests</h3>
            
            <div class="mb-3">
                <button class="btn btn-primary" onclick="testFileProcessor()">
                    <i class="fas fa-play"></i> Run File Processing Tests
                </button>
            </div>

            <div id="fileProcessorTestResults"></div>
        </div>

        <!-- Template Management Tests -->
        <div class="test-section">
            <h3><i class="fas fa-file-alt"></i> Template Management Tests</h3>
            
            <div class="mb-3">
                <button class="btn btn-primary" onclick="testTemplateManager()">
                    <i class="fas fa-play"></i> Run Template Tests
                </button>
                <button class="btn btn-success" onclick="downloadSampleTemplate()">
                    <i class="fas fa-download"></i> Download Sample Template
                </button>
            </div>

            <div id="templateTestResults"></div>
        </div>

        <!-- Integration Tests -->
        <div class="test-section">
            <h3><i class="fas fa-link"></i> Integration Tests</h3>
            
            <div class="mb-3">
                <button class="btn btn-primary" onclick="testIntegration()">
                    <i class="fas fa-play"></i> Run Integration Tests
                </button>
                <button class="btn btn-warning" onclick="resetTestData()">
                    <i class="fas fa-refresh"></i> Reset Test Data
                </button>
            </div>

            <div id="integrationTestResults"></div>
        </div>

        <!-- Run All Tests -->
        <div class="test-section">
            <div class="text-center">
                <button class="btn btn-lg btn-primary" onclick="runAllTests()">
                    <i class="fas fa-play-circle"></i> Run All Tests
                </button>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Import/Export Engine Components -->
    <script type="module">
        import { ImportManager } from './js/master-barang/ImportManager.js';
        import { ExportManager } from './js/master-barang/ExportManager.js';
        import { FileProcessor } from './js/master-barang/FileProcessor.js';
        import { TemplateManager } from './js/master-barang/TemplateManager.js';

        // Make components available globally
        window.importManager = new ImportManager();
        window.exportManager = new ExportManager();
        window.fileProcessor = new FileProcessor();
        window.templateManager = new TemplateManager();

        // Test tracking
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0
        };

        // Test utilities
        window.addTestResult = function(testName, passed, message) {
            testResults.total++;
            if (passed) {
                testResults.passed++;
            } else {
                testResults.failed++;
            }
            
            updateTestSummary();
            return { testName, passed, message };
        };

        window.displayTestResult = function(containerId, result) {
            const container = document.getElementById(containerId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${result.passed ? 'test-pass' : 'test-fail'}`;
            resultDiv.innerHTML = `
                <strong>${result.testName}:</strong> 
                <span class="badge ${result.passed ? 'bg-success' : 'bg-danger'}">
                    ${result.passed ? 'PASS' : 'FAIL'}
                </span>
                <br><small>${result.message}</small>
            `;
            container.appendChild(resultDiv);
        };

        function updateTestSummary() {
            document.getElementById('totalTests').textContent = testResults.total;
            document.getElementById('passedTests').textContent = testResults.passed;
            document.getElementById('failedTests').textContent = testResults.failed;
            
            const progress = testResults.total > 0 ? 
                Math.round((testResults.passed / testResults.total) * 100) : 0;
            document.getElementById('testProgress').textContent = progress + '%';
        }

        // Import Engine Tests
        window.testImportEngine = async function() {
            const container = document.getElementById('importTestResults');
            container.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Running import tests...</div>';

            try {
                // Test 1: Import Manager Initialization
                let result = addTestResult(
                    'Import Manager Initialization',
                    importManager instanceof ImportManager,
                    'ImportManager instance created successfully'
                );
                displayTestResult('importTestResults', result);

                // Test 2: Dialog Creation
                importManager.initializeImportDialog();
                const dialog = document.getElementById('importDialog');
                result = addTestResult(
                    'Import Dialog Creation',
                    dialog !== null,
                    dialog ? 'Import dialog created successfully' : 'Failed to create import dialog'
                );
                displayTestResult('importTestResults', result);

                // Test 3: File Validation
                const validFile = { name: 'test.csv', type: 'text/csv', size: 1024 };
                const invalidFile = { name: 'test.txt', type: 'text/plain', size: 1024 };
                
                result = addTestResult(
                    'File Validation - Valid File',
                    fileProcessor.isValidFile(validFile),
                    'CSV file validation passed'
                );
                displayTestResult('importTestResults', result);

                result = addTestResult(
                    'File Validation - Invalid File',
                    !fileProcessor.isValidFile(invalidFile),
                    'Invalid file correctly rejected'
                );
                displayTestResult('importTestResults', result);

                // Test 4: CSV Parsing
                const csvContent = 'Name,Age,City\nJohn,25,Jakarta\nJane,30,Bandung';
                const parsedData = fileProcessor.parseCSV(csvContent);
                
                result = addTestResult(
                    'CSV Parsing',
                    parsedData.length === 2 && parsedData[0].Name === 'John',
                    `Parsed ${parsedData.length} rows successfully`
                );
                displayTestResult('importTestResults', result);

            } catch (error) {
                const result = addTestResult(
                    'Import Engine Test',
                    false,
                    'Error: ' + error.message
                );
                displayTestResult('importTestResults', result);
            }
        };

        // Export Engine Tests
        window.testExportEngine = async function() {
            const container = document.getElementById('exportTestResults');
            container.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Running export tests...</div>';

            try {
                // Setup test data
                const testData = [
                    { kode: 'BRG001', nama: 'Item 1', kategori_nama: 'Cat1', satuan_nama: 'PCS', harga_beli: 1000, harga_jual: 1200, stok: 10 },
                    { kode: 'BRG002', nama: 'Item 2', kategori_nama: 'Cat2', satuan_nama: 'KG', harga_beli: 2000, harga_jual: 2400, stok: 5 }
                ];
                localStorage.setItem('master_barang', JSON.stringify(testData));

                // Test 1: Export Manager Initialization
                let result = addTestResult(
                    'Export Manager Initialization',
                    exportManager instanceof ExportManager,
                    'ExportManager instance created successfully'
                );
                displayTestResult('exportTestResults', result);

                // Test 2: Data Retrieval
                const retrievedData = JSON.parse(localStorage.getItem('master_barang') || '[]');
                result = addTestResult(
                    'Data Retrieval',
                    retrievedData.length === 2,
                    `Retrieved ${retrievedData.length} test records`
                );
                displayTestResult('exportTestResults', result);

                // Test 3: Column Selection
                const columns = [
                    { key: 'kode', label: 'Kode' },
                    { key: 'nama', label: 'Nama' }
                ];
                const exportData = exportManager.prepareExportData(testData, columns, true);
                
                result = addTestResult(
                    'Export Data Preparation',
                    exportData.length === 3 && exportData[0][0] === 'Kode',
                    `Prepared ${exportData.length} rows (including header)`
                );
                displayTestResult('exportTestResults', result);

                // Test 4: File Name Generation
                const fileName = exportManager.generateFileName('csv');
                result = addTestResult(
                    'File Name Generation',
                    fileName.includes('master_barang_export_') && fileName.endsWith('.csv'),
                    `Generated filename: ${fileName}`
                );
                displayTestResult('exportTestResults', result);

            } catch (error) {
                const result = addTestResult(
                    'Export Engine Test',
                    false,
                    'Error: ' + error.message
                );
                displayTestResult('exportTestResults', result);
            }
        };

        // File Processor Tests
        window.testFileProcessor = async function() {
            const container = document.getElementById('fileProcessorTestResults');
            container.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Running file processor tests...</div>';

            try {
                // Test 1: File Type Detection
                let result = addTestResult(
                    'File Type Detection - CSV',
                    fileProcessor.getFileType({ name: 'test.csv', type: 'text/csv' }) === 'csv',
                    'CSV file type detected correctly'
                );
                displayTestResult('fileProcessorTestResults', result);

                result = addTestResult(
                    'File Type Detection - Excel',
                    fileProcessor.getFileType({ name: 'test.xlsx', type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }) === 'excel',
                    'Excel file type detected correctly'
                );
                displayTestResult('fileProcessorTestResults', result);

                // Test 2: CSV Line Parsing
                const line = 'John,25,"Jakarta, Indonesia"';
                const parsed = fileProcessor.parseCSVLine(line);
                result = addTestResult(
                    'CSV Line Parsing',
                    parsed.length === 3 && parsed[2] === 'Jakarta, Indonesia',
                    `Parsed line into ${parsed.length} fields with proper quote handling`
                );
                displayTestResult('fileProcessorTestResults', result);

                // Test 3: Data Cleaning
                const dirtyData = [{ name: '  John Doe  ', age: ' 25 ', city: '' }];
                const cleanData = fileProcessor.cleanData(dirtyData);
                result = addTestResult(
                    'Data Cleaning',
                    cleanData[0].name === 'John Doe' && cleanData[0].city === null,
                    'Data cleaned successfully (trimmed spaces, converted empty strings to null)'
                );
                displayTestResult('fileProcessorTestResults', result);

                // Test 4: Sample Data Generation
                const sampleData = fileProcessor.generateSampleData();
                result = addTestResult(
                    'Sample Data Generation',
                    Array.isArray(sampleData) && sampleData.length > 0,
                    `Generated ${sampleData.length} sample records`
                );
                displayTestResult('fileProcessorTestResults', result);

            } catch (error) {
                const result = addTestResult(
                    'File Processor Test',
                    false,
                    'Error: ' + error.message
                );
                displayTestResult('fileProcessorTestResults', result);
            }
        };

        // Template Manager Tests
        window.testTemplateManager = async function() {
            const container = document.getElementById('templateTestResults');
            container.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Running template tests...</div>';

            try {
                // Test 1: Template Manager Initialization
                let result = addTestResult(
                    'Template Manager Initialization',
                    templateManager instanceof TemplateManager,
                    'TemplateManager instance created successfully'
                );
                displayTestResult('templateTestResults', result);

                // Test 2: Template Generation
                const template = templateManager.generateTemplate('csv');
                result = addTestResult(
                    'Template Generation',
                    typeof template === 'string' && template.includes('Kode Barang'),
                    'CSV template generated with proper headers'
                );
                displayTestResult('templateTestResults', result);

                // Test 3: Template File Name
                const templateFileName = templateManager.generateTemplateFileName('csv');
                result = addTestResult(
                    'Template File Name',
                    templateFileName.includes('template_master_barang_') && templateFileName.endsWith('.csv'),
                    `Generated template filename: ${templateFileName}`
                );
                displayTestResult('templateTestResults', result);

            } catch (error) {
                const result = addTestResult(
                    'Template Manager Test',
                    false,
                    'Error: ' + error.message
                );
                displayTestResult('templateTestResults', result);
            }
        };

        // Integration Tests
        window.testIntegration = async function() {
            const container = document.getElementById('integrationTestResults');
            container.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Running integration tests...</div>';

            try {
                // Test 1: Import-Export Round Trip
                const originalData = [
                    { kode: 'TEST001', nama: 'Test Item', kategori_nama: 'Test Cat', satuan_nama: 'PCS', harga_beli: 1000, harga_jual: 1200, stok: 10 }
                ];
                
                // Export data
                const columns = [
                    { key: 'kode', label: 'Kode' },
                    { key: 'nama', label: 'Nama' },
                    { key: 'kategori_nama', label: 'Kategori' },
                    { key: 'satuan_nama', label: 'Satuan' }
                ];
                const exportData = exportManager.prepareExportData(originalData, columns, false);
                
                let result = addTestResult(
                    'Import-Export Integration',
                    exportData.length === 1 && exportData[0][0] === 'TEST001',
                    'Data successfully prepared for export and maintains integrity'
                );
                displayTestResult('integrationTestResults', result);

                // Test 2: File Processing Integration
                const csvContent = 'Kode,Nama,Kategori,Satuan\nTEST002,Test Item 2,Test Cat 2,KG';
                const parsedData = fileProcessor.parseCSV(csvContent);
                
                result = addTestResult(
                    'File Processing Integration',
                    parsedData.length === 1 && parsedData[0].Kode === 'TEST002',
                    'CSV parsing integrated successfully with import process'
                );
                displayTestResult('integrationTestResults', result);

                // Test 3: Template-Import Integration
                const template = templateManager.generateTemplate('csv');
                const templateLines = template.split('\n');
                
                result = addTestResult(
                    'Template-Import Integration',
                    templateLines.length >= 2 && templateLines[0].includes('Kode Barang'),
                    'Template format compatible with import process'
                );
                displayTestResult('integrationTestResults', result);

            } catch (error) {
                const result = addTestResult(
                    'Integration Test',
                    false,
                    'Error: ' + error.message
                );
                displayTestResult('integrationTestResults', result);
            }
        };

        // Utility Functions
        window.openImportDialog = function() {
            importManager.openImportDialog();
        };

        window.openExportDialog = function() {
            exportManager.openExportDialog();
        };

        window.downloadSampleTemplate = function() {
            const template = templateManager.generateTemplate('csv');
            const blob = new Blob([template], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = templateManager.generateTemplateFileName('csv');
            link.click();
            window.URL.revokeObjectURL(url);
        };

        window.generateSampleExport = function() {
            const format = document.getElementById('sampleExportFormat').value;
            const count = parseInt(document.getElementById('sampleDataCount').value);
            
            // Generate sample data
            const sampleData = [];
            for (let i = 1; i <= count; i++) {
                sampleData.push({
                    kode: `SAMPLE${i.toString().padStart(3, '0')}`,
                    nama: `Sample Item ${i}`,
                    kategori_nama: `Category ${(i % 3) + 1}`,
                    satuan_nama: 'PCS',
                    harga_beli: 1000 + (i * 100),
                    harga_jual: 1200 + (i * 120),
                    stok: 10 + i
                });
            }
            
            // Export data
            exportManager.exportData(sampleData, format);
        };

        window.resetTestData = function() {
            localStorage.removeItem('master_barang');
            localStorage.removeItem('kategori_barang');
            localStorage.removeItem('satuan_barang');
            
            testResults = { total: 0, passed: 0, failed: 0 };
            updateTestSummary();
            
            // Clear all test result containers
            ['importTestResults', 'exportTestResults', 'fileProcessorTestResults', 
             'templateTestResults', 'integrationTestResults'].forEach(id => {
                document.getElementById(id).innerHTML = '';
            });
            
            alert('Test data reset successfully');
        };

        window.runAllTests = async function() {
            resetTestData();
            
            await testImportEngine();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testExportEngine();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testFileProcessor();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testTemplateManager();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testIntegration();
            
            // Show completion message
            const successRate = Math.round((testResults.passed / testResults.total) * 100);
            const message = `All tests completed!\n\nResults:\n- Total: ${testResults.total}\n- Passed: ${testResults.passed}\n- Failed: ${testResults.failed}\n- Success Rate: ${successRate}%`;
            alert(message);
        };

        // Sample file upload handling
        document.getElementById('sampleFileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file && file.type === 'text/csv') {
                try {
                    const result = await fileProcessor.processFile(file);
                    if (result.success) {
                        displaySamplePreview(result.data);
                    } else {
                        alert('Error processing file: ' + result.error);
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            } else {
                alert('Please select a CSV file');
            }
        });

        function displaySamplePreview(data) {
            if (!data || data.length === 0) return;
            
            const headers = Object.keys(data[0]);
            const previewHeader = document.getElementById('samplePreviewHeader');
            const previewBody = document.getElementById('samplePreviewBody');
            
            // Clear existing content
            previewHeader.innerHTML = '';
            previewBody.innerHTML = '';
            
            // Create header row
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            previewHeader.appendChild(headerRow);
            
            // Create data rows (limit to first 5 rows)
            const previewRows = data.slice(0, 5);
            previewRows.forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = row[header] || '';
                    tr.appendChild(td);
                });
                previewBody.appendChild(tr);
            });
            
            document.getElementById('samplePreview').style.display = 'block';
        }

        // Drag and drop for sample upload
        const uploadArea = document.getElementById('sampleUploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file) {
                document.getElementById('sampleFileInput').files = e.dataTransfer.files;
                document.getElementById('sampleFileInput').dispatchEvent(new Event('change'));
            }
        });

        // Initialize test summary
        updateTestSummary();
        
        console.log('Task 6: Import/Export Engine test page loaded successfully');
    </script>
</body>
</html>