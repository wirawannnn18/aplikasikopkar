<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task 14.1: End-to-End Workflow Testing</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .workflow-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
        }
        .step-card {
            background: white;
            color: #333;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .step-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .step-number {
            background: #667eea;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
        }
        .step-status {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .status-pending { background: #f8f9fa; color: #6c757d; }
        .status-running { background: #fff3cd; color: #856404; }
        .status-success { background: #d1edff; color: #0c63e4; }
        .status-error { background: #f8d7da; color: #721c24; }
        .simulation-panel {
            background: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        .data-display {
            background: #e9ecef;
            border-radius: 0.25rem;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            margin: 0.5rem 0;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="workflow-container">
            <h1 class="mb-4"><i class="bi bi-arrow-right-circle me-2"></i>End-to-End Workflow Testing</h1>
            <p class="lead mb-4">Comprehensive testing dari buka kas sampai tutup kasir dengan simulasi user interactions</p>
            
            <div class="row">
                <div class="col-md-6">
                    <button class="btn btn-light btn-lg w-100" onclick="startWorkflowTest()">
                        <i class="bi bi-play-fill me-2"></i>Start Complete Workflow Test
                    </button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-outline-light btn-lg w-100" onclick="resetWorkflowTest()">
                        <i class="bi bi-arrow-clockwise me-2"></i>Reset Test Environment
                    </button>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div id="workflowSteps">
                    <!-- Workflow steps will be populated here -->
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="simulation-panel">
                    <h5><i class="bi bi-gear me-2"></i>Test Configuration</h5>
                    <div class="mb-3">
                        <label class="form-label">Kasir Name:</label>
                        <input type="text" class="form-control" id="kasirName" value="Test Kasir">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Modal Awal:</label>
                        <input type="number" class="form-control" id="modalAwal" value="100000">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Kas Aktual (for testing):</label>
                        <input type="number" class="form-control" id="kasAktual" value="223000">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Test Scenario:</label>
                        <select class="form-select" id="testScenario">
                            <option value="normal">Normal Operation</option>
                            <option value="shortage">Cash Shortage</option>
                            <option value="excess">Cash Excess</option>
                            <option value="perfect">Perfect Match</option>
                        </select>
                    </div>
                </div>
                
                <div class="simulation-panel">
                    <h5><i class="bi bi-database me-2"></i>Current Data State</h5>
                    <div id="dataState">
                        <div class="data-display">
                            <strong>Session Storage:</strong><br>
                            <span id="sessionData">No data</span>
                        </div>
                        <div class="data-display">
                            <strong>Local Storage:</strong><br>
                            <span id="localData">No data</span>
                        </div>
                    </div>
                </div>
                
                <div class="simulation-panel">
                    <h5><i class="bi bi-speedometer2 me-2"></i>Performance Metrics</h5>
                    <div id="performanceData">
                        <div class="d-flex justify-content-between">
                            <span>Total Time:</span>
                            <span id="totalTime">-</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Steps Completed:</span>
                            <span id="stepsCompleted">0/0</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Success Rate:</span>
                            <span id="successRate">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // End-to-End Workflow Testing Framework
        class WorkflowTester {
            constructor() {
                this.steps = [];
                this.currentStep = 0;
                this.startTime = null;
                this.results = [];
                this.initializeSteps();
            }

            initializeSteps() {
                this.steps = [
                    {
                        id: 1,
                        title: 'Environment Setup',
                        description: 'Clear existing data and prepare test environment',
                        action: () => this.setupEnvironment(),
                        validation: () => this.validateEnvironmentSetup()
                    },
                    {
                        id: 2,
                        title: 'Buka Kas Simulation',
                        description: 'Simulate kasir opening cash register',
                        action: () => this.simulateBukaKas(),
                        validation: () => this.validateBukaKas()
                    },
                    {
                        id: 3,
                        title: 'Transaction Processing',
                        description: 'Generate and process sample transactions',
                        action: () => this.processTransactions(),
                        validation: () => this.validateTransactions()
                    },
                    {
                        id: 4,
                        title: 'Button Visibility Check',
                        description: 'Verify tutup kasir button is visible and accessible',
                        action: () => this.checkButtonVisibility(),
                        validation: () => this.validateButtonVisibility()
                    },
                    {
                        id: 5,
                        title: 'Modal Opening Test',
                        description: 'Test tutup kasir modal opening and data display',
                        action: () => this.testModalOpening(),
                        validation: () => this.validateModalData()
                    },
                    {
                        id: 6,
                        title: 'Cash Calculation Test',
                        description: 'Test cash reconciliation calculations',
                        action: () => this.testCashCalculation(),
                        validation: () => this.validateCalculations()
                    },
                    {
                        id: 7,
                        title: 'Tutup Kasir Process',
                        description: 'Complete tutup kasir process with data persistence',
                        action: () => this.processTutupKasir(),
                        validation: () => this.validateTutupKasir()
                    },
                    {
                        id: 8,
                        title: 'Session Cleanup',
                        description: 'Verify proper session cleanup after tutup kasir',
                        action: () => this.cleanupSession(),
                        validation: () => this.validateSessionCleanup()
                    },
                    {
                        id: 9,
                        title: 'Data Persistence Verification',
                        description: 'Verify all data is properly saved and retrievable',
                        action: () => this.verifyDataPersistence(),
                        validation: () => this.validateDataPersistence()
                    },
                    {
                        id: 10,
                        title: 'Integration Validation',
                        description: 'Validate integration with accounting and reporting systems',
                        action: () => this.validateIntegration(),
                        validation: () => this.validateIntegrationResults()
                    }
                ];
            }

            renderSteps() {
                const container = document.getElementById('workflowSteps');
                container.innerHTML = '';

                this.steps.forEach((step, index) => {
                    const status = this.getStepStatus(index);
                    const stepHtml = `
                        <div class="step-card">
                            <div class="d-flex align-items-center">
                                <div class="step-number">${step.id}</div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">${step.title}</h6>
                                    <p class="mb-2 text-muted">${step.description}</p>
                                </div>
                                <div class="step-status ${status.class}">${status.text}</div>
                            </div>
                            <div id="step-${step.id}-details" class="mt-2" style="display: none;">
                                <!-- Step details will be populated during execution -->
                            </div>
                        </div>
                    `;
                    container.innerHTML += stepHtml;
                });
            }

            getStepStatus(index) {
                if (index < this.currentStep) {
                    const result = this.results[index];
                    return result && result.success ? 
                        { class: 'status-success', text: 'Completed' } :
                        { class: 'status-error', text: 'Failed' };
                } else if (index === this.currentStep) {
                    return { class: 'status-running', text: 'Running' };
                } else {
                    return { class: 'status-pending', text: 'Pending' };
                }
            }

            async runStep(stepIndex) {
                const step = this.steps[stepIndex];
                this.currentStep = stepIndex;
                this.renderSteps();

                const detailsDiv = document.getElementById(`step-${step.id}-details`);
                detailsDiv.style.display = 'block';
                detailsDiv.innerHTML = '<div class="text-info"><i class="bi bi-hourglass-split me-2"></i>Executing...</div>';

                try {
                    const startTime = performance.now();
                    
                    // Execute step action
                    await step.action();
                    
                    // Validate step result
                    const validationResult = await step.validation();
                    
                    const endTime = performance.now();
                    const duration = endTime - startTime;

                    const result = {
                        step: step.id,
                        success: validationResult.success,
                        duration: duration,
                        details: validationResult.details || 'Step completed successfully',
                        data: validationResult.data || {}
                    };

                    this.results[stepIndex] = result;

                    // Update step details
                    const statusClass = result.success ? 'text-success' : 'text-danger';
                    const icon = result.success ? 'check-circle' : 'x-circle';
                    
                    detailsDiv.innerHTML = `
                        <div class="${statusClass}">
                            <i class="bi bi-${icon} me-2"></i>${result.details}
                            <br><small>Duration: ${duration.toFixed(2)}ms</small>
                        </div>
                    `;

                    return result;
                } catch (error) {
                    const result = {
                        step: step.id,
                        success: false,
                        error: error.message,
                        details: `Error: ${error.message}`
                    };

                    this.results[stepIndex] = result;
                    
                    detailsDiv.innerHTML = `
                        <div class="text-danger">
                            <i class="bi bi-x-circle me-2"></i>Error: ${error.message}
                        </div>
                    `;

                    return result;
                }
            }

            // Step implementations
            async setupEnvironment() {
                sessionStorage.clear();
                localStorage.removeItem('riwayatTutupKas');
                localStorage.removeItem('transaksiHarian');
                await this.delay(100);
            }

            async validateEnvironmentSetup() {
                const sessionEmpty = sessionStorage.length === 0;
                const noRiwayat = !localStorage.getItem('riwayatTutupKas');
                const noTransaksi = !localStorage.getItem('transaksiHarian');
                
                return {
                    success: sessionEmpty && noRiwayat && noTransaksi,
                    details: 'Environment cleared successfully'
                };
            }

            async simulateBukaKas() {
                const kasirName = document.getElementById('kasirName').value;
                const modalAwal = parseInt(document.getElementById('modalAwal').value);
                
                const bukaKasData = {
                    id: 'test-shift-' + Date.now(),
                    kasir: kasirName,
                    kasirId: 'kasir001',
                    modalAwal: modalAwal,
                    waktuBuka: new Date().toISOString(),
                    tanggal: new Date().toISOString().split('T')[0]
                };
                
                sessionStorage.setItem('bukaKas', JSON.stringify(bukaKasData));
                await this.delay(200);
            }

            async validateBukaKas() {
                const bukaKas = sessionStorage.getItem('bukaKas');
                if (!bukaKas) {
                    return { success: false, details: 'Buka kas data not found in session' };
                }
                
                const data = JSON.parse(bukaKas);
                const hasRequiredFields = data.id && data.kasir && data.modalAwal && data.waktuBuka;
                
                return {
                    success: hasRequiredFields,
                    details: hasRequiredFields ? 'Buka kas data valid' : 'Missing required fields',
                    data: data
                };
            }

            async processTransactions() {
                const scenario = document.getElementById('testScenario').value;
                let transactions = [];
                
                switch (scenario) {
                    case 'normal':
                        transactions = [
                            { id: 'tx001', total: 50000, metodePembayaran: 'cash', timestamp: new Date().toISOString() },
                            { id: 'tx002', total: 75000, metodePembayaran: 'cash', timestamp: new Date().toISOString() },
                            { id: 'tx003', total: 25000, metodePembayaran: 'kredit', timestamp: new Date().toISOString() }
                        ];
                        break;
                    case 'shortage':
                        transactions = [
                            { id: 'tx001', total: 30000, metodePembayaran: 'cash', timestamp: new Date().toISOString() },
                            { id: 'tx002', total: 45000, metodePembayaran: 'cash', timestamp: new Date().toISOString() }
                        ];
                        break;
                    case 'excess':
                        transactions = [
                            { id: 'tx001', total: 100000, metodePembayaran: 'cash', timestamp: new Date().toISOString() },
                            { id: 'tx002', total: 150000, metodePembayaran: 'cash', timestamp: new Date().toISOString() }
                        ];
                        break;
                    case 'perfect':
                        const kasAktual = parseInt(document.getElementById('kasAktual').value);
                        const modalAwal = parseInt(document.getElementById('modalAwal').value);
                        const targetCash = kasAktual - modalAwal;
                        transactions = [
                            { id: 'tx001', total: targetCash, metodePembayaran: 'cash', timestamp: new Date().toISOString() }
                        ];
                        break;
                }
                
                localStorage.setItem('transaksiHarian', JSON.stringify(transactions));
                await this.delay(300);
            }

            async validateTransactions() {
                const transactions = localStorage.getItem('transaksiHarian');
                if (!transactions) {
                    return { success: false, details: 'No transactions found' };
                }
                
                const data = JSON.parse(transactions);
                const validTransactions = data.every(t => t.id && t.total && t.metodePembayaran);
                
                return {
                    success: validTransactions && data.length > 0,
                    details: `${data.length} transactions processed successfully`,
                    data: { transactionCount: data.length, transactions: data }
                };
            }

            async checkButtonVisibility() {
                const bukaKas = sessionStorage.getItem('bukaKas');
                // Simulate button visibility check
                await this.delay(100);
                return { buttonVisible: !!bukaKas };
            }

            async validateButtonVisibility() {
                const bukaKas = sessionStorage.getItem('bukaKas');
                return {
                    success: !!bukaKas,
                    details: bukaKas ? 'Tutup kasir button should be visible' : 'Button should be hidden (no session)'
                };
            }

            async testModalOpening() {
                const bukaKas = JSON.parse(sessionStorage.getItem('bukaKas'));
                const transactions = JSON.parse(localStorage.getItem('transaksiHarian') || '[]');
                
                // Simulate modal data preparation
                const modalData = {
                    kasir: bukaKas.kasir,
                    waktuBuka: bukaKas.waktuBuka,
                    modalAwal: bukaKas.modalAwal,
                    totalTransaksi: transactions.length,
                    totalPenjualan: transactions.reduce((sum, t) => sum + t.total, 0),
                    totalCash: transactions.filter(t => t.metodePembayaran === 'cash').reduce((sum, t) => sum + t.total, 0)
                };
                
                await this.delay(150);
                return { modalData };
            }

            async validateModalData() {
                const bukaKas = JSON.parse(sessionStorage.getItem('bukaKas'));
                const transactions = JSON.parse(localStorage.getItem('transaksiHarian') || '[]');
                
                const hasRequiredData = bukaKas && bukaKas.kasir && bukaKas.modalAwal;
                const hasTransactions = transactions.length > 0;
                
                return {
                    success: hasRequiredData && hasTransactions,
                    details: 'Modal data prepared successfully',
                    data: { kasir: bukaKas.kasir, transactionCount: transactions.length }
                };
            }

            async testCashCalculation() {
                const bukaKas = JSON.parse(sessionStorage.getItem('bukaKas'));
                const transactions = JSON.parse(localStorage.getItem('transaksiHarian') || '[]');
                const kasAktual = parseInt(document.getElementById('kasAktual').value);
                
                const totalCash = transactions
                    .filter(t => t.metodePembayaran === 'cash')
                    .reduce((sum, t) => sum + t.total, 0);
                
                const kasSeharusnya = bukaKas.modalAwal + totalCash;
                const selisih = kasAktual - kasSeharusnya;
                
                await this.delay(100);
                
                return {
                    calculations: {
                        modalAwal: bukaKas.modalAwal,
                        totalCash: totalCash,
                        kasSeharusnya: kasSeharusnya,
                        kasAktual: kasAktual,
                        selisih: selisih
                    }
                };
            }

            async validateCalculations() {
                const bukaKas = JSON.parse(sessionStorage.getItem('bukaKas'));
                const transactions = JSON.parse(localStorage.getItem('transaksiHarian') || '[]');
                const kasAktual = parseInt(document.getElementById('kasAktual').value);
                
                const totalCash = transactions
                    .filter(t => t.metodePembayaran === 'cash')
                    .reduce((sum, t) => sum + t.total, 0);
                
                const kasSeharusnya = bukaKas.modalAwal + totalCash;
                const selisih = kasAktual - kasSeharusnya;
                
                const calculationsValid = !isNaN(selisih) && typeof selisih === 'number';
                
                return {
                    success: calculationsValid,
                    details: `Calculations: Modal ${bukaKas.modalAwal} + Cash ${totalCash} = ${kasSeharusnya}, Actual: ${kasAktual}, Selisih: ${selisih}`,
                    data: { selisih, kasSeharusnya, kasAktual }
                };
            }

            async processTutupKasir() {
                const bukaKas = JSON.parse(sessionStorage.getItem('bukaKas'));
                const transactions = JSON.parse(localStorage.getItem('transaksiHarian') || '[]');
                const kasAktual = parseInt(document.getElementById('kasAktual').value);
                
                const totalCash = transactions
                    .filter(t => t.metodePembayaran === 'cash')
                    .reduce((sum, t) => sum + t.total, 0);
                
                const kasSeharusnya = bukaKas.modalAwal + totalCash;
                const selisih = kasAktual - kasSeharusnya;
                
                const tutupKasirRecord = {
                    id: 'tutup-' + Date.now(),
                    shiftId: bukaKas.id,
                    kasir: bukaKas.kasir,
                    kasirId: bukaKas.kasirId,
                    waktuBuka: bukaKas.waktuBuka,
                    waktuTutup: new Date().toISOString(),
                    modalAwal: bukaKas.modalAwal,
                    totalPenjualan: transactions.reduce((sum, t) => sum + t.total, 0),
                    totalCash: totalCash,
                    kasSeharusnya: kasSeharusnya,
                    kasAktual: kasAktual,
                    selisih: selisih,
                    keteranganSelisih: selisih !== 0 ? 'Test selisih kas' : '',
                    jumlahTransaksi: transactions.length,
                    tanggalTutup: new Date().toISOString().split('T')[0]
                };
                
                const existing = JSON.parse(localStorage.getItem('riwayatTutupKas') || '[]');
                existing.push(tutupKasirRecord);
                localStorage.setItem('riwayatTutupKas', JSON.stringify(existing));
                
                await this.delay(200);
            }

            async validateTutupKasir() {
                const riwayat = JSON.parse(localStorage.getItem('riwayatTutupKas') || '[]');
                
                if (riwayat.length === 0) {
                    return { success: false, details: 'No tutup kasir record saved' };
                }
                
                const latestRecord = riwayat[riwayat.length - 1];
                const hasRequiredFields = latestRecord.id && latestRecord.kasir && 
                                        latestRecord.waktuTutup && typeof latestRecord.selisih === 'number';
                
                return {
                    success: hasRequiredFields,
                    details: `Tutup kasir record saved with selisih: ${latestRecord.selisih}`,
                    data: latestRecord
                };
            }

            async cleanupSession() {
                sessionStorage.removeItem('bukaKas');
                await this.delay(50);
            }

            async validateSessionCleanup() {
                const bukaKas = sessionStorage.getItem('bukaKas');
                return {
                    success: !bukaKas,
                    details: bukaKas ? 'Session not properly cleaned' : 'Session cleaned successfully'
                };
            }

            async verifyDataPersistence() {
                const riwayat = localStorage.getItem('riwayatTutupKas');
                const transactions = localStorage.getItem('transaksiHarian');
                await this.delay(50);
                return { riwayat: !!riwayat, transactions: !!transactions };
            }

            async validateDataPersistence() {
                const riwayat = localStorage.getItem('riwayatTutupKas');
                const transactions = localStorage.getItem('transaksiHarian');
                
                return {
                    success: !!riwayat && !!transactions,
                    details: 'All data properly persisted in localStorage'
                };
            }

            async validateIntegration() {
                const riwayat = JSON.parse(localStorage.getItem('riwayatTutupKas') || '[]');
                
                if (riwayat.length === 0) {
                    throw new Error('No data for integration validation');
                }
                
                const record = riwayat[riwayat.length - 1];
                
                // Simulate accounting integration
                const journalEntry = {
                    type: record.selisih > 0 ? 'pendapatan-lain' : 'beban-lain',
                    amount: Math.abs(record.selisih),
                    description: 'Selisih kas tutup kasir',
                    kasirId: record.kasirId,
                    shiftId: record.shiftId
                };
                
                await this.delay(100);
                return { journalEntry, record };
            }

            async validateIntegrationResults() {
                const riwayat = JSON.parse(localStorage.getItem('riwayatTutupKas') || '[]');
                
                return {
                    success: riwayat.length > 0,
                    details: 'Integration with accounting and reporting systems validated',
                    data: { recordCount: riwayat.length }
                };
            }

            // Utility methods
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            updateDataDisplay() {
                const sessionData = sessionStorage.getItem('bukaKas');
                const localData = localStorage.getItem('riwayatTutupKas');
                
                document.getElementById('sessionData').textContent = 
                    sessionData ? JSON.stringify(JSON.parse(sessionData), null, 2) : 'No data';
                
                document.getElementById('localData').textContent = 
                    localData ? `${JSON.parse(localData).length} records` : 'No data';
            }

            updatePerformanceMetrics() {
                const completedSteps = this.results.filter(r => r && r.success).length;
                const totalSteps = this.steps.length;
                const successRate = totalSteps > 0 ? Math.round((completedSteps / totalSteps) * 100) : 0;
                
                document.getElementById('stepsCompleted').textContent = `${completedSteps}/${totalSteps}`;
                document.getElementById('successRate').textContent = `${successRate}%`;
                
                if (this.startTime && completedSteps === totalSteps) {
                    const totalTime = performance.now() - this.startTime;
                    document.getElementById('totalTime').textContent = `${(totalTime / 1000).toFixed(2)}s`;
                }
            }
        }

        // Initialize workflow tester
        const workflowTester = new WorkflowTester();

        // Main functions
        async function startWorkflowTest() {
            workflowTester.startTime = performance.now();
            workflowTester.currentStep = 0;
            workflowTester.results = [];
            
            workflowTester.renderSteps();
            
            for (let i = 0; i < workflowTester.steps.length; i++) {
                await workflowTester.runStep(i);
                workflowTester.updateDataDisplay();
                workflowTester.updatePerformanceMetrics();
                workflowTester.renderSteps();
                
                // Small delay between steps for better UX
                await workflowTester.delay(500);
            }
            
            console.log('Workflow test completed:', workflowTester.results);
        }

        function resetWorkflowTest() {
            sessionStorage.clear();
            localStorage.removeItem('riwayatTutupKas');
            localStorage.removeItem('transaksiHarian');
            
            workflowTester.currentStep = 0;
            workflowTester.results = [];
            workflowTester.renderSteps();
            workflowTester.updateDataDisplay();
            
            document.getElementById('totalTime').textContent = '-';
            document.getElementById('stepsCompleted').textContent = '0/0';
            document.getElementById('successRate').textContent = '-';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            workflowTester.renderSteps();
            workflowTester.updateDataDisplay();
            
            // Update data display periodically
            setInterval(() => {
                workflowTester.updateDataDisplay();
            }, 1000);
        });
    </script>
</body>
</html>