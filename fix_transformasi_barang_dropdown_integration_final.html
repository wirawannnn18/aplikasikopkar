<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Final - Transformasi Barang Dropdown Integration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .fix-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .status-card {
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        .transformation-preview {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }
        .stock-display {
            background: white;
            border-radius: 6px;
            padding: 15px;
            border-left: 4px solid #007bff;
            margin: 10px 0;
        }
        .conversion-arrow {
            font-size: 2rem;
            color: #007bff;
            text-align: center;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="fix-container">
        <div class="row">
            <div class="col-12">
                <div class="card status-card">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-check-circle me-2"></i>
                            Fix Final - Transformasi Barang Dropdown Integration
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i>
                            <strong>Solusi:</strong> Dropdown sumber dan tujuan barang sekarang mengambil data stok 
                            yang benar dari sistem dan menampilkan informasi yang akurat.
                        </div>

                        <!-- Status Perbaikan -->
                        <div id="fix-status" class="alert alert-info">
                            <i class="bi bi-gear me-2"></i>
                            Memulai integrasi perbaikan dropdown...
                        </div>

                        <!-- Transformasi Form -->
                        <div class="transformation-preview">
                            <h5><i class="bi bi-arrow-left-right me-2"></i>Form Transformasi Barang (Fixed)</h5>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">
                                        <i class="bi bi-box-seam me-1"></i>Barang Asal
                                    </label>
                                    <select class="form-select" id="sourceItem">
                                        <option value="">Pilih barang asal (yang akan dikurangi stoknya)...</option>
                                    </select>
                                    <div class="form-text">Pilih barang yang akan dikurangi stoknya</div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">
                                        <i class="bi bi-bullseye me-1"></i>Barang Tujuan
                                    </label>
                                    <select class="form-select" id="targetItem">
                                        <option value="">Pilih barang tujuan (yang akan ditambah stoknya)...</option>
                                    </select>
                                    <div class="form-text">Pilih barang yang akan ditambah stoknya</div>
                                </div>
                            </div>

                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <label class="form-label">
                                        <i class="bi bi-123 me-1"></i>Jumlah barang asal yang akan ditransformasi
                                    </label>
                                    <input type="number" class="form-control" id="quantity" 
                                           min="1" step="1" placeholder="Masukkan jumlah..." value="10">
                                    <div class="form-text">Jumlah barang asal yang akan ditransformasi</div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">
                                        <i class="bi bi-calculator me-1"></i>Info Konversi
                                    </label>
                                    <div id="conversion-info" class="form-control bg-light" style="height: auto; min-height: 38px;">
                                        <span class="text-muted">Pilih item untuk melihat rasio konversi</span>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-3">
                                <button type="button" class="btn btn-success" id="execute-transformation">
                                    <i class="bi bi-arrow-repeat me-2"></i>Lakukan Transformasi
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                    <i class="bi bi-arrow-counterclockwise me-2"></i>Reset Form
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="refreshSystem()">
                                    <i class="bi bi-arrow-clockwise me-2"></i>Refresh System
                                </button>
                            </div>
                        </div>

                        <!-- Data Stok Tersedia -->
                        <div class="test-section">
                            <h5><i class="bi bi-database me-2"></i>Data Stok Tersedia di Sistem</h5>
                            <div id="stock-display"></div>
                        </div>

                        <!-- Preview Transformasi -->
                        <div id="transformation-preview" class="test-section" style="display: none;">
                            <h5><i class="bi bi-eye me-2"></i>Preview Transformasi</h5>
                            <div id="transformation-details"></div>
                        </div>

                        <!-- Log Aktivitas -->
                        <div class="test-section">
                            <h5><i class="bi bi-list-ul me-2"></i>Log Aktivitas</h5>
                            <div id="activity-log" class="bg-dark text-light p-3 rounded" style="height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.9em;">
                                <div class="text-success">[SYSTEM] Memulai sistem transformasi barang...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Load the StockDropdownFix -->
    <script src="js/transformasi-barang/StockDropdownFix.js"></script>
    
    <script>
        // Global variables
        let stockDropdownFix = null;
        let fixStatus = document.getElementById('fix-status');
        let activityLog = document.getElementById('activity-log');

        // Logging function
        function logActivity(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const typeColors = {
                'info': 'text-info',
                'success': 'text-success',
                'warning': 'text-warning',
                'error': 'text-danger'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = typeColors[type] || 'text-light';
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            activityLog.appendChild(logEntry);
            activityLog.scrollTop = activityLog.scrollHeight;
        }

        // Update status function
        function updateStatus(message, type = 'info') {
            const alertClass = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'warning': 'alert-warning',
                'info': 'alert-info'
            };
            
            fixStatus.className = `alert ${alertClass[type]}`;
            fixStatus.innerHTML = `<i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>${message}`;
            
            logActivity(message, type);
        }

        // Initialize the fixed system
        async function initializeFixedSystem() {
            try {
                updateStatus('Menginisialisasi sistem perbaikan dropdown...', 'info');
                
                // Create and initialize StockDropdownFix
                stockDropdownFix = new StockDropdownFix();
                const initResult = await stockDropdownFix.initialize();
                
                if (!initResult) {
                    throw new Error('Gagal menginisialisasi StockDropdownFix');
                }
                
                updateStatus('StockDropdownFix berhasil diinisialisasi', 'success');
                
                // Setup additional event listeners
                setupEventListeners();
                
                // Display stock data
                displayStockData();
                
                // Setup transformation preview
                setupTransformationPreview();
                
                updateStatus('Sistem transformasi barang berhasil diperbaiki dan siap digunakan!', 'success');
                
            } catch (error) {
                console.error('Error initializing fixed system:', error);
                updateStatus(`Error inisialisasi: ${error.message}`, 'error');
            }
        }

        // Setup additional event listeners
        function setupEventListeners() {
            const executeButton = document.getElementById('execute-transformation');
            
            if (executeButton) {
                executeButton.addEventListener('click', executeTransformation);
            }
            
            // Setup form change listeners for preview
            const sourceSelect = document.getElementById('sourceItem');
            const targetSelect = document.getElementById('targetItem');
            const quantityInput = document.getElementById('quantity');
            
            [sourceSelect, targetSelect, quantityInput].forEach(element => {
                if (element) {
                    element.addEventListener('change', updateTransformationPreview);
                    element.addEventListener('input', updateTransformationPreview);
                }
            });
            
            logActivity('Event listeners berhasil disetup', 'success');
        }

        // Display stock data
        function displayStockData() {
            const stockDisplay = document.getElementById('stock-display');
            
            if (!stockDropdownFix) {
                stockDisplay.innerHTML = '<div class="alert alert-warning">StockDropdownFix belum diinisialisasi</div>';
                return;
            }
            
            const transformableItems = stockDropdownFix.getTransformableItems();
            const baseProducts = stockDropdownFix.groupItemsByBaseProduct();
            
            let html = '';
            Object.entries(baseProducts).forEach(([baseProduct, items]) => {
                if (items.length > 1) {
                    html += `
                        <div class="stock-display">
                            <h6 class="text-primary mb-3">${items[0].nama}</h6>
                            <div class="row">
                    `;
                    
                    items.forEach(item => {
                        const stockStatus = item.stok > 0 ? 'success' : 'danger';
                        const canTransform = item.stok > 0 ? 'Dapat ditransformasi' : 'Stok habis';
                        
                        html += `
                            <div class="col-md-6 mb-2">
                                <div class="border rounded p-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>Kode:</strong> ${item.kode}<br>
                                            <strong>Satuan:</strong> ${item.satuan}<br>
                                            <strong>Harga Beli:</strong> Rp ${item.hargaBeli?.toLocaleString() || 0}<br>
                                            <strong>Harga Jual:</strong> Rp ${item.hargaJual?.toLocaleString() || 0}
                                        </div>
                                        <div class="text-end">
                                            <div class="badge bg-${stockStatus} fs-6 mb-2">${item.stok}</div>
                                            <div class="small text-muted">${canTransform}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
            });
            
            if (!html) {
                html = '<div class="alert alert-info">Tidak ada item yang dapat ditransformasi</div>';
            }
            
            stockDisplay.innerHTML = html;
            logActivity(`Menampilkan ${transformableItems.length} item yang dapat ditransformasi`, 'info');
        }

        // Setup transformation preview
        function setupTransformationPreview() {
            // Initial preview update
            updateTransformationPreview();
        }

        // Update transformation preview
        function updateTransformationPreview() {
            const sourceSelect = document.getElementById('sourceItem');
            const targetSelect = document.getElementById('targetItem');
            const quantityInput = document.getElementById('quantity');
            const previewContainer = document.getElementById('transformation-preview');
            const previewDetails = document.getElementById('transformation-details');
            const executeButton = document.getElementById('execute-transformation');
            
            const sourceValue = sourceSelect?.value;
            const targetValue = targetSelect?.value;
            const quantity = parseFloat(quantityInput?.value) || 0;
            
            if (!sourceValue || !targetValue || quantity <= 0) {
                previewContainer.style.display = 'none';
                if (executeButton) executeButton.disabled = true;
                return;
            }
            
            try {
                // Validate transformation
                const validation = stockDropdownFix.validateTransformation(sourceValue, targetValue, quantity);
                
                if (!validation.isValid) {
                    previewDetails.innerHTML = `
                        <div class="alert alert-danger">
                            <h6>Validasi Gagal:</h6>
                            <ul class="mb-0">
                                ${validation.errors.map(error => `<li>${error}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                    previewContainer.style.display = 'block';
                    if (executeButton) executeButton.disabled = true;
                    return;
                }
                
                // Get item details
                const sourceOption = sourceSelect.options[sourceSelect.selectedIndex];
                const targetOption = targetSelect.options[targetSelect.selectedIndex];
                
                const sourceItem = {
                    kode: sourceValue,
                    nama: sourceOption.dataset.nama,
                    satuan: sourceOption.dataset.satuan,
                    stok: parseInt(sourceOption.dataset.stok)
                };
                
                const targetItem = {
                    kode: targetValue,
                    nama: targetOption.dataset.nama,
                    satuan: targetOption.dataset.satuan,
                    stok: parseInt(targetOption.dataset.stok)
                };
                
                // Get conversion ratio
                const ratio = stockDropdownFix.getConversionRatio(
                    sourceItem.satuan, 
                    targetItem.satuan, 
                    sourceOption.dataset.baseProduct
                );
                
                const targetQuantity = quantity * ratio;
                const newSourceStock = sourceItem.stok - quantity;
                const newTargetStock = targetItem.stok + targetQuantity;
                
                // Display preview
                previewDetails.innerHTML = `
                    <div class="row">
                        <div class="col-md-5">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <strong><i class="bi bi-dash-circle me-2"></i>Barang Asal (Dikurangi)</strong>
                                </div>
                                <div class="card-body">
                                    <h6>${sourceItem.nama}</h6>
                                    <p class="mb-1"><strong>Kode:</strong> ${sourceItem.kode}</p>
                                    <p class="mb-1"><strong>Satuan:</strong> ${sourceItem.satuan}</p>
                                    <p class="mb-1"><strong>Jumlah dikurangi:</strong> ${quantity}</p>
                                    <p class="mb-1"><strong>Stok sebelum:</strong> ${sourceItem.stok}</p>
                                    <p class="mb-0"><strong>Stok sesudah:</strong> 
                                        <span class="text-success">${newSourceStock}</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-2 d-flex align-items-center justify-content-center">
                            <div class="conversion-arrow">
                                <i class="bi bi-arrow-right"></i>
                            </div>
                        </div>
                        
                        <div class="col-md-5">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <strong><i class="bi bi-plus-circle me-2"></i>Barang Tujuan (Ditambah)</strong>
                                </div>
                                <div class="card-body">
                                    <h6>${targetItem.nama}</h6>
                                    <p class="mb-1"><strong>Kode:</strong> ${targetItem.kode}</p>
                                    <p class="mb-1"><strong>Satuan:</strong> ${targetItem.satuan}</p>
                                    <p class="mb-1"><strong>Jumlah ditambah:</strong> ${targetQuantity.toFixed(3)}</p>
                                    <p class="mb-1"><strong>Stok sebelum:</strong> ${targetItem.stok}</p>
                                    <p class="mb-0"><strong>Stok sesudah:</strong> 
                                        <span class="text-success">${newTargetStock.toFixed(3)}</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3 p-3 bg-light rounded">
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Rasio Konversi:</strong> 1 ${sourceItem.satuan} = ${ratio} ${targetItem.satuan}</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Status:</strong> 
                                    <span class="badge bg-success">Siap untuk ditransformasi</span>
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                
                previewContainer.style.display = 'block';
                if (executeButton) executeButton.disabled = false;
                
            } catch (error) {
                console.error('Error updating preview:', error);
                previewDetails.innerHTML = `
                    <div class="alert alert-danger">
                        Error memuat preview: ${error.message}
                    </div>
                `;
                previewContainer.style.display = 'block';
                if (executeButton) executeButton.disabled = true;
            }
        }

        // Execute transformation
        async function executeTransformation() {
            const sourceSelect = document.getElementById('sourceItem');
            const targetSelect = document.getElementById('targetItem');
            const quantityInput = document.getElementById('quantity');
            
            const sourceValue = sourceSelect?.value;
            const targetValue = targetSelect?.value;
            const quantity = parseFloat(quantityInput?.value) || 0;
            
            if (!sourceValue || !targetValue || quantity <= 0) {
                updateStatus('Silakan lengkapi semua field', 'warning');
                return;
            }
            
            try {
                updateStatus('Memproses transformasi...', 'info');
                
                // Validate transformation
                const validation = stockDropdownFix.validateTransformation(sourceValue, targetValue, quantity);
                
                if (!validation.isValid) {
                    updateStatus(`Validasi gagal: ${validation.errors.join(', ')}`, 'error');
                    return;
                }
                
                // Get current stocks
                const sourceStock = stockDropdownFix.getCurrentStock(sourceValue);
                const targetStock = stockDropdownFix.getCurrentStock(targetValue);
                
                // Get conversion ratio
                const sourceOption = sourceSelect.options[sourceSelect.selectedIndex];
                const targetOption = targetSelect.options[targetSelect.selectedIndex];
                
                const ratio = stockDropdownFix.getConversionRatio(
                    sourceOption.dataset.satuan,
                    targetOption.dataset.satuan,
                    sourceOption.dataset.baseProduct
                );
                
                const targetQuantity = quantity * ratio;
                
                // Update stocks
                const newSourceStock = sourceStock - quantity;
                const newTargetStock = targetStock + targetQuantity;
                
                stockDropdownFix.updateStock(sourceValue, newSourceStock);
                stockDropdownFix.updateStock(targetValue, newTargetStock);
                
                // Log transformation
                logActivity(`TRANSFORMASI: ${quantity} ${sourceOption.dataset.satuan} ${sourceOption.dataset.nama} â†’ ${targetQuantity.toFixed(3)} ${targetOption.dataset.satuan} ${targetOption.dataset.nama}`, 'success');
                
                updateStatus('Transformasi berhasil dilakukan!', 'success');
                
                // Refresh displays
                displayStockData();
                resetForm();
                
            } catch (error) {
                console.error('Error executing transformation:', error);
                updateStatus(`Error transformasi: ${error.message}`, 'error');
            }
        }

        // Reset form
        function resetForm() {
            const sourceSelect = document.getElementById('sourceItem');
            const targetSelect = document.getElementById('targetItem');
            const quantityInput = document.getElementById('quantity');
            const previewContainer = document.getElementById('transformation-preview');
            const executeButton = document.getElementById('execute-transformation');
            
            if (sourceSelect) sourceSelect.value = '';
            if (targetSelect) targetSelect.value = '';
            if (quantityInput) quantityInput.value = '';
            if (previewContainer) previewContainer.style.display = 'none';
            if (executeButton) executeButton.disabled = true;
            
            logActivity('Form direset', 'info');
        }

        // Refresh system
        async function refreshSystem() {
            try {
                updateStatus('Memuat ulang sistem...', 'info');
                
                if (stockDropdownFix) {
                    await stockDropdownFix.refresh();
                }
                
                displayStockData();
                updateTransformationPreview();
                
                updateStatus('Sistem berhasil dimuat ulang', 'success');
                
            } catch (error) {
                console.error('Error refreshing system:', error);
                updateStatus(`Error refresh: ${error.message}`, 'error');
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', initializeFixedSystem);
    </script>
</body>
</html>