<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Export Manager Test - Dashboard Analytics</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        
        .test-section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        
        .export-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
        }
        
        .control-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }
        
        .control-group select,
        .control-group input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #0056b3;
        }
        
        .btn.success {
            background-color: #28a745;
        }
        
        .btn.danger {
            background-color: #dc3545;
        }
        
        .btn.warning {
            background-color: #ffc107;
            color: #212529;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .mock-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .mock-widget {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .mock-widget h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .mock-chart {
            width: 100%;
            height: 150px;
            background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-style: italic;
        }
        
        .export-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .export-preview pre {
            margin: 0;
            white-space: pre-wrap;
            font-size: 12px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Export Manager Test Suite</h1>
        <p>Testing multi-format export functionality for Dashboard Analytics & KPI system.</p>
        
        <!-- Mock Dashboard Section -->
        <div class="test-section">
            <h3>üìä Mock Dashboard Data</h3>
            <div class="mock-dashboard" id="mockDashboard">
                <div class="mock-widget">
                    <h4>Financial Health Score</h4>
                    <div class="mock-chart">KPI Widget</div>
                    <p>Score: 85/100 (Good)</p>
                </div>
                <div class="mock-widget">
                    <h4>Member Growth</h4>
                    <div class="mock-chart">Line Chart</div>
                    <p>+12% this month</p>
                </div>
                <div class="mock-widget">
                    <h4>Transaction Volume</h4>
                    <div class="mock-chart">Bar Chart</div>
                    <p>$125,000 total</p>
                </div>
                <div class="mock-widget">
                    <h4>Savings Distribution</h4>
                    <div class="mock-chart">Pie Chart</div>
                    <p>3 categories</p>
                </div>
            </div>
        </div>
        
        <!-- Export Controls Section -->
        <div class="test-section">
            <h3>‚öôÔ∏è Export Configuration</h3>
            <div class="export-controls">
                <div class="control-group">
                    <label for="exportFormat">Export Format:</label>
                    <select id="exportFormat">
                        <option value="json">JSON</option>
                        <option value="csv">CSV</option>
                        <option value="pdf">PDF</option>
                        <option value="excel">Excel</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="includeCharts">Include Charts:</label>
                    <select id="includeCharts">
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="dateRange">Date Range:</label>
                    <select id="dateRange">
                        <option value="current">Current Month</option>
                        <option value="last3">Last 3 Months</option>
                        <option value="last6">Last 6 Months</option>
                        <option value="year">Current Year</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="reportTitle">Report Title:</label>
                    <input type="text" id="reportTitle" value="Dashboard Analytics Report" />
                </div>
            </div>
            
            <div style="text-align: center; margin: 20px 0;">
                <button class="btn" onclick="testExport()">üöÄ Test Export</button>
                <button class="btn success" onclick="testAllFormats()">üìã Test All Formats</button>
                <button class="btn warning" onclick="testEmailIntegration()">üìß Test Email</button>
                <button class="btn danger" onclick="clearResults()">üóëÔ∏è Clear Results</button>
            </div>
            
            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
        
        <!-- Test Results Section -->
        <div class="test-section">
            <h3>üìã Test Results</h3>
            <div id="testResults"></div>
        </div>
        
        <!-- Export Preview Section -->
        <div class="test-section">
            <h3>üëÅÔ∏è Export Preview</h3>
            <div id="exportPreview" class="export-preview">
                <p><em>Export preview will appear here...</em></p>
            </div>
        </div>
    </div>

    <!-- Include required libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Include our modules -->
    <script src="js/dashboard/types.js"></script>
    <script src="js/dashboard/ExportManager.js"></script>
    
    <script>
        // Mock Dashboard Controller
        class MockDashboardController {
            constructor() {
                this.config = {
                    id: 'dashboard-001',
                    userId: 'user-123',
                    role: 'manager',
                    layout: [
                        {
                            id: 'widget-1',
                            type: 'kpi',
                            title: 'Financial Health Score',
                            position: { x: 0, y: 0 },
                            size: { width: 300, height: 200 }
                        },
                        {
                            id: 'widget-2',
                            type: 'chart',
                            title: 'Member Growth',
                            position: { x: 300, y: 0 },
                            size: { width: 300, height: 200 }
                        },
                        {
                            id: 'widget-3',
                            type: 'chart',
                            title: 'Transaction Volume',
                            position: { x: 0, y: 200 },
                            size: { width: 300, height: 200 }
                        },
                        {
                            id: 'widget-4',
                            type: 'chart',
                            title: 'Savings Distribution',
                            position: { x: 300, y: 200 },
                            size: { width: 300, height: 200 }
                        }
                    ],
                    theme: 'light',
                    refreshInterval: 300000
                };
            }
            
            getCurrentConfig() {
                return this.config;
            }
            
            async getWidgetData(widgetId, options = {}) {
                // Generate mock data based on widget ID
                const mockData = {
                    'widget-1': [
                        { label: 'Health Score', value: 85, y: 85, category: 'financial' },
                        { label: 'Liquidity Ratio', value: 1.2, y: 1.2, category: 'financial' },
                        { label: 'Profitability', value: 0.15, y: 0.15, category: 'financial' }
                    ],
                    'widget-2': [
                        { x: '2024-01', y: 1250, label: 'January' },
                        { x: '2024-02', y: 1320, label: 'February' },
                        { x: '2024-03', y: 1480, label: 'March' },
                        { x: '2024-04', y: 1520, label: 'April' }
                    ],
                    'widget-3': [
                        { x: '2024-01', y: 125000, label: 'January' },
                        { x: '2024-02', y: 132000, label: 'February' },
                        { x: '2024-03', y: 148000, label: 'March' },
                        { x: '2024-04', y: 152000, label: 'April' }
                    ],
                    'widget-4': [
                        { label: 'Simpanan Pokok', y: 45000, category: 'savings' },
                        { label: 'Simpanan Wajib', y: 78000, category: 'savings' },
                        { label: 'Simpanan Sukarela', y: 32000, category: 'savings' }
                    ]
                };
                
                return mockData[widgetId] || [];
            }
        }
        
        // Initialize components
        let mockController;
        let exportManager;
        let testResults = [];
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            try {
                mockController = new MockDashboardController();
                exportManager = new ExportManager(mockController);
                addResult('‚úÖ Export Manager initialized successfully', 'success');
            } catch (error) {
                addResult(`‚ùå Initialization failed: ${error.message}`, 'error');
            }
        });
        
        // Test single export
        async function testExport() {
            const format = document.getElementById('exportFormat').value;
            const includeCharts = document.getElementById('includeCharts').value === 'true';
            const dateRange = document.getElementById('dateRange').value;
            const title = document.getElementById('reportTitle').value;
            
            showProgress(0);
            
            try {
                addResult(`üöÄ Starting ${format.toUpperCase()} export test...`, 'info');
                
                const options = {
                    includeCharts: includeCharts,
                    dateRange: dateRange,
                    title: title,
                    orientation: 'portrait',
                    format: 'a4'
                };
                
                showProgress(30);
                
                const exportData = await exportManager.exportDashboard(format, options);
                
                showProgress(70);
                
                // Handle different data types
                let previewText = '';
                let downloadFilename = `dashboard-report.${format}`;
                
                if (typeof exportData === 'string') {
                    previewText = exportData.substring(0, 1000) + (exportData.length > 1000 ? '...' : '');
                } else if (exportData instanceof Blob) {
                    previewText = `Binary data (${exportData.type}, ${exportData.size} bytes)`;
                    downloadFilename = `dashboard-report-${Date.now()}.${format}`;
                }
                
                showProgress(90);
                
                // Show preview
                document.getElementById('exportPreview').innerHTML = `
                    <h4>Export Result (${format.toUpperCase()})</h4>
                    <p><strong>Type:</strong> ${typeof exportData}</p>
                    <p><strong>Size:</strong> ${exportData instanceof Blob ? exportData.size + ' bytes' : exportData.length + ' characters'}</p>
                    <pre>${previewText}</pre>
                    <button class="btn success" onclick="downloadResult('${format}')">üíæ Download Result</button>
                `;
                
                // Store for download
                window.lastExportData = exportData;
                window.lastExportFormat = format;
                window.lastExportFilename = downloadFilename;
                
                showProgress(100);
                addResult(`‚úÖ ${format.toUpperCase()} export completed successfully`, 'success');
                
                setTimeout(() => hideProgress(), 1000);
                
            } catch (error) {
                hideProgress();
                addResult(`‚ùå ${format.toUpperCase()} export failed: ${error.message}`, 'error');
            }
        }
        
        // Test all formats
        async function testAllFormats() {
            const formats = ['json', 'csv', 'pdf', 'excel'];
            const results = {};
            
            addResult('üîÑ Testing all export formats...', 'info');
            
            for (let i = 0; i < formats.length; i++) {
                const format = formats[i];
                showProgress((i / formats.length) * 100);
                
                try {
                    const exportData = await exportManager.exportDashboard(format, {
                        includeCharts: false, // Faster testing
                        title: `Test Report - ${format.toUpperCase()}`
                    });
                    
                    results[format] = {
                        success: true,
                        size: exportData instanceof Blob ? exportData.size : exportData.length,
                        type: typeof exportData
                    };
                    
                    addResult(`‚úÖ ${format.toUpperCase()}: Success (${results[format].size} ${results[format].type === 'string' ? 'chars' : 'bytes'})`, 'success');
                    
                } catch (error) {
                    results[format] = {
                        success: false,
                        error: error.message
                    };
                    
                    addResult(`‚ùå ${format.toUpperCase()}: Failed - ${error.message}`, 'error');
                }
                
                // Small delay between tests
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            showProgress(100);
            
            // Summary
            const successCount = Object.values(results).filter(r => r.success).length;
            addResult(`üìä Summary: ${successCount}/${formats.length} formats successful`, successCount === formats.length ? 'success' : 'error');
            
            setTimeout(() => hideProgress(), 1000);
        }
        
        // Test email integration
        async function testEmailIntegration() {
            try {
                addResult('üìß Testing email integration...', 'info');
                
                const exportData = await exportManager.exportDashboard('json', {
                    includeCharts: false,
                    title: 'Email Test Report'
                });
                
                const emailOptions = {
                    to: 'manager@koperasi.com',
                    subject: 'Dashboard Report - ' + new Date().toLocaleDateString(),
                    body: 'Please find the attached dashboard report.',
                    filename: 'dashboard-report.json'
                };
                
                const result = await exportManager.sendReportByEmail(exportData, 'json', emailOptions);
                
                if (result) {
                    addResult('‚úÖ Email integration test completed (mailto link opened)', 'success');
                } else {
                    addResult('‚ö†Ô∏è Email integration requires backend service', 'error');
                }
                
            } catch (error) {
                addResult(`‚ùå Email test failed: ${error.message}`, 'error');
            }
        }
        
        // Download last export result
        function downloadResult(format) {
            if (window.lastExportData) {
                exportManager.downloadExportedData(
                    window.lastExportData,
                    window.lastExportFilename || `dashboard-report.${format}`,
                    format
                );
                addResult(`üíæ Downloaded ${format.toUpperCase()} file`, 'success');
            } else {
                addResult('‚ùå No export data available for download', 'error');
            }
        }
        
        // Clear test results
        function clearResults() {
            testResults = [];
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('exportPreview').innerHTML = '<p><em>Export preview will appear here...</em></p>';
            addResult('üóëÔ∏è Results cleared', 'info');
        }
        
        // Add test result
        function addResult(message, type) {
            const timestamp = new Date().toLocaleTimeString();
            const result = {
                message: message,
                type: type,
                timestamp: timestamp
            };
            
            testResults.push(result);
            
            const resultDiv = document.createElement('div');
            resultDiv.className = `status ${type}`;
            resultDiv.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            const resultsContainer = document.getElementById('testResults');
            resultsContainer.appendChild(resultDiv);
            resultsContainer.scrollTop = resultsContainer.scrollHeight;
        }
        
        // Show progress bar
        function showProgress(percent) {
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            progressBar.style.display = 'block';
            progressFill.style.width = percent + '%';
        }
        
        // Hide progress bar
        function hideProgress() {
            document.getElementById('progressBar').style.display = 'none';
        }
        
        // Test validation functions
        function testValidation() {
            try {
                // Test supported formats
                const formats = exportManager.getSupportedFormats();
                addResult(`üìã Supported formats: ${formats.join(', ')}`, 'info');
                
                // Test validation
                exportManager.validateExportOptions('pdf', {});
                addResult('‚úÖ PDF validation passed', 'success');
                
                exportManager.validateExportOptions('excel', {});
                addResult('‚úÖ Excel validation passed', 'success');
                
                try {
                    exportManager.validateExportOptions('invalid', {});
                } catch (error) {
                    addResult('‚úÖ Invalid format validation working', 'success');
                }
                
            } catch (error) {
                addResult(`‚ùå Validation test failed: ${error.message}`, 'error');
            }
        }
        
        // Run validation tests on load
        setTimeout(() => {
            if (exportManager) {
                testValidation();
            }
        }, 1000);
    </script>
</body>
</html>