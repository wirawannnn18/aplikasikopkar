<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Master Barang Setup - Task 1</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Master Barang System - Task 1 Setup Test</h1>
        <p>Testing the project structure and core interfaces implementation.</p>
        
        <div class="test-section info">
            <h3>üìã Test Overview</h3>
            <p>This test verifies that Task 1 has been completed successfully:</p>
            <ul>
                <li>‚úÖ Directory structure for master-barang components</li>
                <li>‚úÖ Data models and types definitions</li>
                <li>‚úÖ Base interfaces for all managers</li>
                <li>‚úÖ LocalStorage schema setup</li>
            </ul>
        </div>

        <div class="test-section" id="systemTest">
            <h3>üîß System Initialization Test</h3>
            <button onclick="testSystemInitialization()">Test System Initialization</button>
            <div id="systemTestResult"></div>
        </div>

        <div class="test-section" id="managersTest">
            <h3>üìä Managers Test</h3>
            <button onclick="testManagers()">Test All Managers</button>
            <div id="managersTestResult"></div>
        </div>

        <div class="test-section" id="dataModelsTest">
            <h3>üóÉÔ∏è Data Models Test</h3>
            <button onclick="testDataModels()">Test Data Models</button>
            <div id="dataModelsTestResult"></div>
        </div>

        <div class="test-section" id="validationTest">
            <h3>‚úÖ Validation Test</h3>
            <button onclick="testValidation()">Test Validation Engine</button>
            <div id="validationTestResult"></div>
        </div>

        <div class="test-section" id="auditTest">
            <h3>üìù Audit Logging Test</h3>
            <button onclick="testAuditLogging()">Test Audit Logging</button>
            <div id="auditTestResult"></div>
        </div>

        <div class="test-section" id="statsTest">
            <h3>üìà System Statistics</h3>
            <button onclick="showSystemStats()">Show System Statistics</button>
            <div id="statsTestResult"></div>
        </div>

        <div class="test-section">
            <h3>üßπ Cleanup</h3>
            <button onclick="clearAllData()" style="background-color: #dc3545;">Clear All Test Data</button>
            <p><small>‚ö†Ô∏è This will clear all test data from localStorage</small></p>
        </div>
    </div>

    <script type="module">
        import { masterBarangSystem } from './js/master-barang/MasterBarangSystem.js';
        import { STORAGE_KEYS, DEFAULTS, VALIDATION_RULES } from './js/master-barang/types.js';

        // Make system available globally for testing
        window.masterBarangSystem = masterBarangSystem;
        window.STORAGE_KEYS = STORAGE_KEYS;
        window.DEFAULTS = DEFAULTS;
        window.VALIDATION_RULES = VALIDATION_RULES;

        // Test functions
        window.testSystemInitialization = function() {
            const resultDiv = document.getElementById('systemTestResult');
            try {
                // Test system health
                const health = masterBarangSystem.getSystemHealth();
                
                let html = '<h4>System Health Check:</h4>';
                html += `<pre>${JSON.stringify(health, null, 2)}</pre>`;
                
                if (health.status === 'healthy') {
                    resultDiv.className = 'success';
                    html += '<p>‚úÖ System initialized successfully!</p>';
                } else {
                    resultDiv.className = 'error';
                    html += '<p>‚ùå System initialization failed!</p>';
                }
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.className = 'error';
                resultDiv.innerHTML = `<p>‚ùå Error: ${error.message}</p>`;
            }
        };

        window.testManagers = function() {
            const resultDiv = document.getElementById('managersTestResult');
            try {
                const tests = [];
                
                // Test BarangManager
                tests.push({
                    name: 'BarangManager',
                    result: typeof masterBarangSystem.barangManager !== 'undefined'
                });
                
                // Test KategoriManager
                tests.push({
                    name: 'KategoriManager',
                    result: typeof masterBarangSystem.kategoriManager !== 'undefined'
                });
                
                // Test SatuanManager
                tests.push({
                    name: 'SatuanManager',
                    result: typeof masterBarangSystem.satuanManager !== 'undefined'
                });
                
                // Test AuditLogger
                tests.push({
                    name: 'AuditLogger',
                    result: typeof masterBarangSystem.auditLogger !== 'undefined'
                });
                
                let html = '<h4>Manager Tests:</h4><ul>';
                let allPassed = true;
                
                tests.forEach(test => {
                    const status = test.result ? '‚úÖ' : '‚ùå';
                    html += `<li>${status} ${test.name}: ${test.result ? 'OK' : 'FAILED'}</li>`;
                    if (!test.result) allPassed = false;
                });
                
                html += '</ul>';
                
                if (allPassed) {
                    resultDiv.className = 'success';
                    html += '<p>‚úÖ All managers initialized successfully!</p>';
                } else {
                    resultDiv.className = 'error';
                    html += '<p>‚ùå Some managers failed to initialize!</p>';
                }
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.className = 'error';
                resultDiv.innerHTML = `<p>‚ùå Error: ${error.message}</p>`;
            }
        };

        window.testDataModels = function() {
            const resultDiv = document.getElementById('dataModelsTestResult');
            try {
                // Test creating sample data
                const kategoriResult = masterBarangSystem.createKategori({
                    nama: 'Test Kategori',
                    deskripsi: 'Kategori untuk testing'
                });
                
                const satuanResult = masterBarangSystem.createSatuan({
                    nama: 'TEST',
                    deskripsi: 'Satuan untuk testing'
                });
                
                const barangResult = masterBarangSystem.createBarang({
                    kode: 'TEST001',
                    nama: 'Test Barang',
                    kategori_id: kategoriResult.success ? kategoriResult.data.id : 'test',
                    kategori_nama: 'Test Kategori',
                    satuan_id: satuanResult.success ? satuanResult.data.id : 'test',
                    satuan_nama: 'TEST',
                    harga_beli: 10000,
                    harga_jual: 15000,
                    stok: 100,
                    stok_minimum: 10
                });
                
                let html = '<h4>Data Model Tests:</h4>';
                html += `<p>Kategori Creation: ${kategoriResult.success ? '‚úÖ' : '‚ùå'}</p>`;
                html += `<p>Satuan Creation: ${satuanResult.success ? '‚úÖ' : '‚ùå'}</p>`;
                html += `<p>Barang Creation: ${barangResult.success ? '‚úÖ' : '‚ùå'}</p>`;
                
                if (kategoriResult.success && satuanResult.success && barangResult.success) {
                    resultDiv.className = 'success';
                    html += '<p>‚úÖ All data models working correctly!</p>';
                } else {
                    resultDiv.className = 'error';
                    html += '<p>‚ùå Some data model tests failed!</p>';
                    
                    if (!kategoriResult.success) html += `<p>Kategori errors: ${kategoriResult.errors.join(', ')}</p>`;
                    if (!satuanResult.success) html += `<p>Satuan errors: ${satuanResult.errors.join(', ')}</p>`;
                    if (!barangResult.success) html += `<p>Barang errors: ${barangResult.errors.join(', ')}</p>`;
                }
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.className = 'error';
                resultDiv.innerHTML = `<p>‚ùå Error: ${error.message}</p>`;
            }
        };

        window.testValidation = function() {
            const resultDiv = document.getElementById('validationTestResult');
            try {
                // Test validation with invalid data
                const invalidBarang = masterBarangSystem.createBarang({
                    kode: '', // Invalid: empty
                    nama: 'A', // Invalid: too short
                    harga_beli: -100, // Invalid: negative
                    stok: 'abc' // Invalid: not a number
                });
                
                // Test validation with valid data
                const validBarang = masterBarangSystem.createBarang({
                    kode: 'VALID001',
                    nama: 'Valid Test Barang',
                    kategori_id: 'test_kategori',
                    kategori_nama: 'Test Kategori',
                    satuan_id: 'test_satuan',
                    satuan_nama: 'PCS',
                    harga_beli: 10000,
                    stok: 50
                });
                
                let html = '<h4>Validation Tests:</h4>';
                html += `<p>Invalid Data Rejection: ${!invalidBarang.success ? '‚úÖ' : '‚ùå'}</p>`;
                html += `<p>Valid Data Acceptance: ${validBarang.success ? '‚úÖ' : '‚ùå'}</p>`;
                
                if (!invalidBarang.success) {
                    html += '<p><strong>Invalid data errors (expected):</strong></p>';
                    html += `<ul>${invalidBarang.errors.map(err => `<li>${err}</li>`).join('')}</ul>`;
                }
                
                if (!invalidBarang.success && validBarang.success) {
                    resultDiv.className = 'success';
                    html += '<p>‚úÖ Validation engine working correctly!</p>';
                } else {
                    resultDiv.className = 'error';
                    html += '<p>‚ùå Validation engine has issues!</p>';
                }
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.className = 'error';
                resultDiv.innerHTML = `<p>‚ùå Error: ${error.message}</p>`;
            }
        };

        window.testAuditLogging = function() {
            const resultDiv = document.getElementById('auditTestResult');
            try {
                // Get audit logs before test
                const logsBefore = masterBarangSystem.getAuditLogs({ limit: 10 });
                
                // Perform some operations that should be logged
                const kategori = masterBarangSystem.createKategori({
                    nama: 'Audit Test Kategori',
                    deskripsi: 'For audit testing'
                });
                
                if (kategori.success) {
                    masterBarangSystem.updateKategori(kategori.data.id, {
                        deskripsi: 'Updated description'
                    });
                }
                
                // Get audit logs after test
                const logsAfter = masterBarangSystem.getAuditLogs({ limit: 10 });
                
                const newLogsCount = logsAfter.total - logsBefore.total;
                
                let html = '<h4>Audit Logging Tests:</h4>';
                html += `<p>Logs before test: ${logsBefore.total}</p>`;
                html += `<p>Logs after test: ${logsAfter.total}</p>`;
                html += `<p>New logs created: ${newLogsCount}</p>`;
                
                if (newLogsCount >= 2) { // Should have create and update logs
                    resultDiv.className = 'success';
                    html += '<p>‚úÖ Audit logging working correctly!</p>';
                } else {
                    resultDiv.className = 'error';
                    html += '<p>‚ùå Audit logging may not be working properly!</p>';
                }
                
                // Show recent logs
                if (logsAfter.data.length > 0) {
                    html += '<h5>Recent Audit Logs:</h5>';
                    html += '<pre>' + JSON.stringify(logsAfter.data.slice(0, 3), null, 2) + '</pre>';
                }
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.className = 'error';
                resultDiv.innerHTML = `<p>‚ùå Error: ${error.message}</p>`;
            }
        };

        window.showSystemStats = function() {
            const resultDiv = document.getElementById('statsTestResult');
            try {
                const stats = masterBarangSystem.getSystemStatistics();
                const dashboard = masterBarangSystem.getDashboardSummary();
                
                let html = '<div class="stats-grid">';
                html += `<div class="stat-card"><div class="stat-number">${stats.barang.total_barang}</div><div class="stat-label">Total Barang</div></div>`;
                html += `<div class="stat-card"><div class="stat-number">${stats.kategori.total_kategori}</div><div class="stat-label">Total Kategori</div></div>`;
                html += `<div class="stat-card"><div class="stat-number">${stats.satuan.total_satuan}</div><div class="stat-label">Total Satuan</div></div>`;
                html += `<div class="stat-card"><div class="stat-number">${stats.audit.total_logs}</div><div class="stat-label">Audit Logs</div></div>`;
                html += '</div>';
                
                html += '<h4>Detailed Statistics:</h4>';
                html += '<pre>' + JSON.stringify(stats, null, 2) + '</pre>';
                
                resultDiv.className = 'info';
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.className = 'error';
                resultDiv.innerHTML = `<p>‚ùå Error: ${error.message}</p>`;
            }
        };

        window.clearAllData = function() {
            if (confirm('Are you sure you want to clear all test data?')) {
                try {
                    const result = masterBarangSystem.clearAllData();
                    if (result.success) {
                        alert('‚úÖ All test data cleared successfully!');
                        location.reload();
                    } else {
                        alert('‚ùå Failed to clear some data');
                    }
                } catch (error) {
                    alert(`‚ùå Error: ${error.message}`);
                }
            }
        };

        // Auto-run system initialization test on load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                testSystemInitialization();
            }, 500);
        });
    </script>
</body>
</html>