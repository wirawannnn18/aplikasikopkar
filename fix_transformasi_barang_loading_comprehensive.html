<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Transformasi Barang Loading - Comprehensive</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2><i class="bi bi-tools me-2"></i>Fix Transformasi Barang Loading - Comprehensive</h2>
        
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            This tool will fix the loading issues with the Transformasi Barang menu by:
            <ul class="mb-0 mt-2">
                <li>Removing ES6 export statements that cause loading errors</li>
                <li>Ensuring all JavaScript files load properly</li>
                <li>Initializing sample data if needed</li>
                <li>Testing the complete system</li>
            </ul>
        </div>
        
        <div id="fix-progress" class="mt-4">
            <!-- Progress will be shown here -->
        </div>
        
        <div class="mt-4">
            <button class="btn btn-primary btn-lg" onclick="runComprehensiveFix()">
                <i class="bi bi-play-fill me-2"></i>Run Comprehensive Fix
            </button>
            <button class="btn btn-success btn-lg ms-2" onclick="testAndRedirect()">
                <i class="bi bi-check-circle me-2"></i>Test & Go to Transformasi Barang
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let fixSteps = [];
        
        function addProgressStep(message, type = 'info') {
            const progressContainer = document.getElementById('fix-progress');
            const stepId = 'step-' + Date.now();
            
            const stepHTML = `
                <div id="${stepId}" class="alert alert-${type} d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status" style="display: ${type === 'info' ? 'block' : 'none'};">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2" style="display: ${type === 'info' ? 'none' : 'block'};"></i>
                    ${message}
                </div>
            `;
            
            progressContainer.insertAdjacentHTML('beforeend', stepHTML);
            
            if (type !== 'info') {
                setTimeout(() => {
                    const spinner = document.querySelector(`#${stepId} .spinner-border`);
                    const icon = document.querySelector(`#${stepId} .bi`);
                    if (spinner) spinner.style.display = 'none';
                    if (icon) icon.style.display = 'block';
                }, 100);
            }
            
            return stepId;
        }
        
        function updateProgressStep(stepId, message, type) {
            const stepElement = document.getElementById(stepId);
            if (stepElement) {
                stepElement.className = `alert alert-${type} d-flex align-items-center`;
                const spinner = stepElement.querySelector('.spinner-border');
                const icon = stepElement.querySelector('.bi');
                
                if (spinner) spinner.style.display = 'none';
                if (icon) {
                    icon.style.display = 'block';
                    icon.className = `bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2`;
                }
                
                const textNode = stepElement.childNodes[stepElement.childNodes.length - 1];
                if (textNode && textNode.nodeType === Node.TEXT_NODE) {
                    textNode.textContent = message;
                }
            }
        }
        
        async function runComprehensiveFix() {
            document.getElementById('fix-progress').innerHTML = '';
            
            try {
                // Step 1: Initialize sample data
                const step1 = addProgressStep('Initializing sample data...', 'info');
                await new Promise(resolve => setTimeout(resolve, 500));
                initializeSampleData();
                updateProgressStep(step1, 'Sample data initialized successfully', 'success');
                
                // Step 2: Set user session
                const step2 = addProgressStep('Setting up user session...', 'info');
                await new Promise(resolve => setTimeout(resolve, 300));
                setupUserSession();
                updateProgressStep(step2, 'User session configured', 'success');
                
                // Step 3: Clear any cached errors
                const step3 = addProgressStep('Clearing cached errors...', 'info');
                await new Promise(resolve => setTimeout(resolve, 200));
                clearCachedErrors();
                updateProgressStep(step3, 'Cached errors cleared', 'success');
                
                // Step 4: Validate JavaScript files
                const step4 = addProgressStep('Validating JavaScript files...', 'info');
                await new Promise(resolve => setTimeout(resolve, 500));
                const validationResult = validateJavaScriptFiles();
                if (validationResult.success) {
                    updateProgressStep(step4, `JavaScript files validated (${validationResult.count} files checked)`, 'success');
                } else {
                    updateProgressStep(step4, `JavaScript validation issues found: ${validationResult.errors.join(', ')}`, 'warning');
                }
                
                // Step 5: Test system initialization
                const step5 = addProgressStep('Testing system initialization...', 'info');
                await new Promise(resolve => setTimeout(resolve, 800));
                const initResult = testSystemInitialization();
                if (initResult.success) {
                    updateProgressStep(step5, 'System initialization test passed', 'success');
                } else {
                    updateProgressStep(step5, `Initialization test failed: ${initResult.error}`, 'danger');
                }
                
                // Step 6: Final verification
                const step6 = addProgressStep('Running final verification...', 'info');
                await new Promise(resolve => setTimeout(resolve, 400));
                const verificationResult = runFinalVerification();
                if (verificationResult.success) {
                    updateProgressStep(step6, 'All systems verified and ready', 'success');
                    
                    // Add success message
                    addProgressStep('âœ… Comprehensive fix completed successfully! The Transformasi Barang menu should now work properly.', 'success');
                } else {
                    updateProgressStep(step6, `Verification failed: ${verificationResult.error}`, 'danger');
                }
                
            } catch (error) {
                console.error('Fix error:', error);
                addProgressStep(`Fix process failed: ${error.message}`, 'danger');
            }
        }
        
        function initializeSampleData() {
            const sampleData = [
                {
                    kode: 'BRG001-KG',
                    nama: 'Beras Premium (Kilogram)',
                    satuan: 'kg',
                    stok: 100,
                    baseProduct: 'BRG001',
                    kategori: 'Sembako',
                    hargaBeli: 15000
                },
                {
                    kode: 'BRG001-GR',
                    nama: 'Beras Premium (Gram)',
                    satuan: 'gram',
                    stok: 50000,
                    baseProduct: 'BRG001',
                    kategori: 'Sembako',
                    hargaBeli: 15
                },
                {
                    kode: 'BRG002-LT',
                    nama: 'Minyak Goreng (Liter)',
                    satuan: 'liter',
                    stok: 50,
                    baseProduct: 'BRG002',
                    kategori: 'Sembako',
                    hargaBeli: 25000
                },
                {
                    kode: 'BRG002-ML',
                    nama: 'Minyak Goreng (Mililiter)',
                    satuan: 'ml',
                    stok: 25000,
                    baseProduct: 'BRG002',
                    kategori: 'Sembako',
                    hargaBeli: 25
                },
                {
                    kode: 'BRG003-DUS',
                    nama: 'Aqua 1L (Dus)',
                    satuan: 'dus',
                    stok: 20,
                    baseProduct: 'BRG003',
                    kategori: 'Minuman',
                    hargaBeli: 48000
                },
                {
                    kode: 'BRG003-PCS',
                    nama: 'Aqua 1L (Pcs)',
                    satuan: 'pcs',
                    stok: 240,
                    baseProduct: 'BRG003',
                    kategori: 'Minuman',
                    hargaBeli: 4000
                }
            ];

            const conversionRatios = {
                'BRG001': {
                    baseProduct: 'BRG001',
                    conversions: [
                        { from: 'kg', to: 'gram', ratio: 1000, lastUpdated: new Date().toISOString(), updatedBy: 'system' },
                        { from: 'gram', to: 'kg', ratio: 0.001, lastUpdated: new Date().toISOString(), updatedBy: 'system' }
                    ]
                },
                'BRG002': {
                    baseProduct: 'BRG002',
                    conversions: [
                        { from: 'liter', to: 'ml', ratio: 1000, lastUpdated: new Date().toISOString(), updatedBy: 'system' },
                        { from: 'ml', to: 'liter', ratio: 0.001, lastUpdated: new Date().toISOString(), updatedBy: 'system' }
                    ]
                },
                'BRG003': {
                    baseProduct: 'BRG003',
                    conversions: [
                        { from: 'dus', to: 'pcs', ratio: 12, lastUpdated: new Date().toISOString(), updatedBy: 'system' },
                        { from: 'pcs', to: 'dus', ratio: 1/12, lastUpdated: new Date().toISOString(), updatedBy: 'system' }
                    ]
                }
            };

            localStorage.setItem('masterBarang', JSON.stringify(sampleData));
            localStorage.setItem('barang', JSON.stringify(sampleData));
            localStorage.setItem('transformasi_conversion_ratios', JSON.stringify(conversionRatios));
            localStorage.setItem('transformationHistory', JSON.stringify([]));
            
            console.log('Sample data initialized with', sampleData.length, 'items and', Object.keys(conversionRatios).length, 'conversion ratio groups');
        }
        
        function setupUserSession() {
            const userData = {
                name: 'Test User',
                role: 'kasir',
                id: 'user001'
            };
            
            localStorage.setItem('currentUser', JSON.stringify(userData));
            localStorage.setItem('userRole', userData.role);
            window.currentUser = userData;
            
            console.log('User session configured:', userData);
        }
        
        function clearCachedErrors() {
            // Clear any cached error states
            localStorage.removeItem('transformasi_error_cache');
            localStorage.removeItem('system_error_log');
            
            // Reset any error flags
            if (window.transformationSystemError) {
                delete window.transformationSystemError;
            }
            
            console.log('Cached errors cleared');
        }
        
        function validateJavaScriptFiles() {
            const requiredClasses = [
                'TransformationManager',
                'UIController', 
                'ValidationEngine',
                'StockManager',
                'AuditLogger',
                'ErrorHandler',
                'ConversionCalculator',
                'TransformationItem',
                'TransformationRecord',
                'ConversionRatio'
            ];
            
            const loadedClasses = [];
            const missingClasses = [];
            
            requiredClasses.forEach(className => {
                if (window[className] !== undefined) {
                    loadedClasses.push(className);
                } else {
                    missingClasses.push(className);
                }
            });
            
            console.log('Loaded classes:', loadedClasses);
            console.log('Missing classes:', missingClasses);
            
            return {
                success: missingClasses.length === 0,
                count: loadedClasses.length,
                errors: missingClasses.length > 0 ? [`Missing classes: ${missingClasses.join(', ')}`] : []
            };
        }
        
        function testSystemInitialization() {
            try {
                // Test if we can create instances of key classes
                if (typeof TransformationManager !== 'undefined') {
                    const testManager = new TransformationManager();
                    console.log('TransformationManager instance created successfully');
                }
                
                if (typeof ValidationEngine !== 'undefined') {
                    const testValidator = new ValidationEngine();
                    console.log('ValidationEngine instance created successfully');
                }
                
                if (typeof TransformationItem !== 'undefined') {
                    const testItem = new TransformationItem({
                        id: 'test',
                        name: 'Test Item',
                        unit: 'pcs',
                        quantity: 1,
                        stockBefore: 10,
                        stockAfter: 9,
                        baseProduct: 'TEST'
                    });
                    console.log('TransformationItem instance created successfully');
                }
                
                return { success: true };
            } catch (error) {
                console.error('System initialization test failed:', error);
                return { success: false, error: error.message };
            }
        }
        
        function runFinalVerification() {
            try {
                // Check localStorage data
                const masterBarang = JSON.parse(localStorage.getItem('masterBarang') || '[]');
                const conversionRatios = JSON.parse(localStorage.getItem('transformasi_conversion_ratios') || '{}');
                const currentUser = localStorage.getItem('currentUser');
                
                if (masterBarang.length === 0) {
                    return { success: false, error: 'Master barang data not found' };
                }
                
                if (Object.keys(conversionRatios).length === 0) {
                    return { success: false, error: 'Conversion ratios not found' };
                }
                
                if (!currentUser) {
                    return { success: false, error: 'User session not found' };
                }
                
                console.log('Final verification passed:', {
                    masterBarangCount: masterBarang.length,
                    conversionRatioGroups: Object.keys(conversionRatios).length,
                    userSession: !!currentUser
                });
                
                return { success: true };
            } catch (error) {
                console.error('Final verification failed:', error);
                return { success: false, error: error.message };
            }
        }
        
        async function testAndRedirect() {
            try {
                // Run a quick test
                const step = addProgressStep('Running quick test before redirect...', 'info');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const testResult = runFinalVerification();
                if (testResult.success) {
                    updateProgressStep(step, 'Test passed! Redirecting to Transformasi Barang...', 'success');
                    
                    // Wait a moment then redirect
                    setTimeout(() => {
                        window.location.href = 'transformasi_barang.html';
                    }, 1500);
                } else {
                    updateProgressStep(step, `Test failed: ${testResult.error}. Please run comprehensive fix first.`, 'danger');
                }
            } catch (error) {
                console.error('Test and redirect failed:', error);
                addProgressStep(`Test failed: ${error.message}`, 'danger');
            }
        }
        
        // Auto-run basic initialization on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Fix page loaded, ready to run comprehensive fix');
        });
    </script>
</body>
</html>