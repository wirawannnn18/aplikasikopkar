<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perbaikan Loading Transformasi Barang - Komprehensif</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .status-card {
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
        }
        .test-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .test-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .test-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .progress-step {
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
        .progress-step.completed {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .progress-step.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="text-center mb-4">
                    <h1 class="display-4 text-primary">
                        <i class="bi bi-tools me-3"></i>Perbaikan Loading Transformasi Barang
                    </h1>
                    <p class="lead text-muted">Diagnosis dan perbaikan komprehensif sistem transformasi barang</p>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Status Panel -->
            <div class="col-lg-4">
                <div class="status-card card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>Status Sistem</h5>
                    </div>
                    <div class="card-body">
                        <div id="system-status">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Memulai diagnosis...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Panel -->
            <div class="col-lg-8">
                <div class="status-card card h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Progress Perbaikan</h5>
                    </div>
                    <div class="card-body">
                        <div id="progress-container">
                            <!-- Progress steps will be added here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <!-- Test Results -->
            <div class="col-12">
                <div class="status-card card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-clipboard-check me-2"></i>Hasil Test & Diagnosis</h5>
                    </div>
                    <div class="card-body">
                        <div id="test-results">
                            <!-- Test results will be added here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <!-- Action Buttons -->
            <div class="col-12 text-center">
                <button id="start-fix" class="btn btn-primary btn-lg me-3">
                    <i class="bi bi-play-circle me-2"></i>Mulai Perbaikan
                </button>
                <button id="test-system" class="btn btn-outline-info btn-lg me-3" disabled>
                    <i class="bi bi-check-circle me-2"></i>Test Sistem
                </button>
                <button id="open-transformasi" class="btn btn-success btn-lg" disabled>
                    <i class="bi bi-arrow-right-circle me-2"></i>Buka Transformasi Barang
                </button>
            </div>
        </div>

        <div class="row mt-4">
            <!-- Manual Actions -->
            <div class="col-12">
                <div class="status-card card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="bi bi-wrench me-2"></i>Aksi Manual (Jika Diperlukan)</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <button class="btn btn-outline-primary w-100 mb-2" onclick="clearLocalStorage()">
                                    <i class="bi bi-trash me-2"></i>Clear LocalStorage
                                </button>
                                <button class="btn btn-outline-secondary w-100 mb-2" onclick="createSampleData()">
                                    <i class="bi bi-database-add me-2"></i>Buat Data Sample
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-outline-info w-100 mb-2" onclick="reloadScripts()">
                                    <i class="bi bi-arrow-clockwise me-2"></i>Reload Scripts
                                </button>
                                <button class="btn btn-outline-success w-100 mb-2" onclick="testInitialization()">
                                    <i class="bi bi-gear me-2"></i>Test Inisialisasi
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let fixProgress = [];
        let testResults = [];
        let systemStatus = {
            filesLoaded: false,
            classesAvailable: false,
            dataInitialized: false,
            systemReady: false
        };

        // Required JavaScript files in correct order
        const requiredFiles = [
            'js/auth.js',
            'js/koperasi.js',
            'js/transformasi-barang/types.js',
            'js/transformasi-barang/DataModels.js',
            'js/transformasi-barang/ValidationEngine.js',
            'js/transformasi-barang/ConversionCalculator.js',
            'js/transformasi-barang/StockManager.js',
            'js/transformasi-barang/AuditLogger.js',
            'js/transformasi-barang/ErrorHandler.js',
            'js/transformasi-barang/TransformationManager.js',
            'js/transformasi-barang/UIController.js',
            'js/transformasi-barang/ReportManager.js',
            'js/transformasiBarangInit.js'
        ];

        // Required classes
        const requiredClasses = [
            'TransformationManager',
            'UIController',
            'ValidationEngine',
            'StockManager',
            'AuditLogger',
            'ErrorHandler',
            'ConversionCalculator',
            'DataModels'
        ];

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            updateSystemStatus();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('start-fix').addEventListener('click', startComprehensiveFix);
            document.getElementById('test-system').addEventListener('click', runSystemTests);
            document.getElementById('open-transformasi').addEventListener('click', openTransformasiBarang);
        }

        function updateSystemStatus() {
            const statusContainer = document.getElementById('system-status');
            
            statusContainer.innerHTML = `
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Files Loaded:</span>
                        <span class="badge bg-${systemStatus.filesLoaded ? 'success' : 'danger'}">
                            ${systemStatus.filesLoaded ? 'OK' : 'ERROR'}
                        </span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Classes Available:</span>
                        <span class="badge bg-${systemStatus.classesAvailable ? 'success' : 'danger'}">
                            ${systemStatus.classesAvailable ? 'OK' : 'ERROR'}
                        </span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Data Initialized:</span>
                        <span class="badge bg-${systemStatus.dataInitialized ? 'success' : 'danger'}">
                            ${systemStatus.dataInitialized ? 'OK' : 'ERROR'}
                        </span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>System Ready:</span>
                        <span class="badge bg-${systemStatus.systemReady ? 'success' : 'danger'}">
                            ${systemStatus.systemReady ? 'READY' : 'NOT READY'}
                        </span>
                    </div>
                </div>
                <div class="text-center">
                    <div class="progress mb-2">
                        <div class="progress-bar" role="progressbar" 
                             style="width: ${getSystemProgress()}%" 
                             aria-valuenow="${getSystemProgress()}" 
                             aria-valuemin="0" aria-valuemax="100">
                            ${getSystemProgress()}%
                        </div>
                    </div>
                    <small class="text-muted">Overall System Health</small>
                </div>
            `;
        }

        function getSystemProgress() {
            const statuses = Object.values(systemStatus);
            const trueCount = statuses.filter(status => status === true).length;
            return Math.round((trueCount / statuses.length) * 100);
        }

        function addProgressStep(message, status = 'pending') {
            const step = {
                message: message,
                status: status,
                timestamp: new Date().toLocaleTimeString()
            };
            
            fixProgress.push(step);
            updateProgressDisplay();
        }

        function updateProgressDisplay() {
            const container = document.getElementById('progress-container');
            
            container.innerHTML = fixProgress.map(step => `
                <div class="progress-step ${step.status}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-${getStatusIcon(step.status)} me-2"></i>
                            ${step.message}
                        </div>
                        <small class="text-muted">${step.timestamp}</small>
                    </div>
                </div>
            `).join('');
        }

        function getStatusIcon(status) {
            switch(status) {
                case 'completed': return 'check-circle-fill text-success';
                case 'error': return 'x-circle-fill text-danger';
                case 'pending': return 'clock text-warning';
                default: return 'circle text-secondary';
            }
        }

        function addTestResult(test, result, details = '') {
            const testResult = {
                test: test,
                result: result,
                details: details,
                timestamp: new Date().toLocaleTimeString()
            };
            
            testResults.push(testResult);
            updateTestResultsDisplay();
        }

        function updateTestResultsDisplay() {
            const container = document.getElementById('test-results');
            
            if (testResults.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">Belum ada hasil test</p>';
                return;
            }
            
            container.innerHTML = testResults.map(result => `
                <div class="test-result test-${result.result}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${result.test}</strong>
                            ${result.details ? `<br><small>${result.details}</small>` : ''}
                        </div>
                        <div class="text-end">
                            <span class="badge bg-${result.result === 'success' ? 'success' : result.result === 'error' ? 'danger' : 'warning'}">
                                ${result.result.toUpperCase()}
                            </span>
                            <br><small>${result.timestamp}</small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function startComprehensiveFix() {
            addProgressStep('Memulai perbaikan komprehensif...', 'pending');
            
            try {
                // Step 1: Clear existing data
                addProgressStep('Membersihkan data lama...', 'pending');
                clearLocalStorage();
                addProgressStep('Data lama berhasil dibersihkan', 'completed');
                
                // Step 2: Load required scripts
                addProgressStep('Memuat file JavaScript yang diperlukan...', 'pending');
                await loadRequiredScripts();
                addProgressStep('File JavaScript berhasil dimuat', 'completed');
                systemStatus.filesLoaded = true;
                
                // Step 3: Check classes availability
                addProgressStep('Memeriksa ketersediaan kelas...', 'pending');
                const classesAvailable = checkRequiredClasses();
                if (classesAvailable) {
                    addProgressStep('Semua kelas tersedia', 'completed');
                    systemStatus.classesAvailable = true;
                } else {
                    addProgressStep('Beberapa kelas tidak tersedia', 'error');
                }
                
                // Step 4: Initialize sample data
                addProgressStep('Menginisialisasi data sample...', 'pending');
                createSampleData();
                addProgressStep('Data sample berhasil dibuat', 'completed');
                systemStatus.dataInitialized = true;
                
                // Step 5: Test initialization
                addProgressStep('Menguji inisialisasi sistem...', 'pending');
                const initSuccess = await testInitialization();
                if (initSuccess) {
                    addProgressStep('Sistem berhasil diinisialisasi', 'completed');
                    systemStatus.systemReady = true;
                } else {
                    addProgressStep('Inisialisasi sistem gagal', 'error');
                }
                
                // Update UI
                updateSystemStatus();
                document.getElementById('test-system').disabled = false;
                document.getElementById('open-transformasi').disabled = !systemStatus.systemReady;
                
                if (systemStatus.systemReady) {
                    addProgressStep('üéâ Perbaikan selesai! Sistem siap digunakan', 'completed');
                } else {
                    addProgressStep('‚ö†Ô∏è Perbaikan selesai dengan beberapa masalah', 'error');
                }
                
            } catch (error) {
                console.error('Error during comprehensive fix:', error);
                addProgressStep(`Error: ${error.message}`, 'error');
            }
        }

        async function loadRequiredScripts() {
            for (const file of requiredFiles) {
                try {
                    await loadScript(file);
                    addTestResult(`Load ${file}`, 'success');
                } catch (error) {
                    addTestResult(`Load ${file}`, 'error', error.message);
                }
            }
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                // Check if script already exists
                const existingScript = document.querySelector(`script[src="${src}"]`);
                if (existingScript) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => resolve();
                script.onerror = () => reject(new Error(`Failed to load ${src}`));
                document.head.appendChild(script);
            });
        }

        function checkRequiredClasses() {
            let allAvailable = true;
            
            for (const className of requiredClasses) {
                const available = typeof window[className] === 'function';
                addTestResult(`Class ${className}`, available ? 'success' : 'error');
                if (!available) allAvailable = false;
            }
            
            return allAvailable;
        }

        function clearLocalStorage() {
            const keysToRemove = [
                'masterBarang', 'barang', 'stokBarang', 'produk',
                'conversionRatios', 'transformationHistory',
                'transformationLogs', 'auditLogs'
            ];
            
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
            });
            
            addTestResult('Clear LocalStorage', 'success', `Removed ${keysToRemove.length} keys`);
        }

        function createSampleData() {
            // Sample master barang data
            const sampleBarang = [
                {
                    kode: 'BRG001-KG',
                    nama: 'Beras Premium (Kilogram)',
                    satuan: 'kg',
                    stok: 100,
                    baseProduct: 'BRG001',
                    hargaBeli: 12000,
                    hargaJual: 15000,
                    kategori: 'Makanan Pokok'
                },
                {
                    kode: 'BRG001-GR',
                    nama: 'Beras Premium (Gram)',
                    satuan: 'gram',
                    stok: 50000,
                    baseProduct: 'BRG001',
                    hargaBeli: 12,
                    hargaJual: 15,
                    kategori: 'Makanan Pokok'
                },
                {
                    kode: 'BRG002-LT',
                    nama: 'Minyak Goreng (Liter)',
                    satuan: 'liter',
                    stok: 50,
                    baseProduct: 'BRG002',
                    hargaBeli: 18000,
                    hargaJual: 22000,
                    kategori: 'Minyak'
                },
                {
                    kode: 'BRG002-ML',
                    nama: 'Minyak Goreng (Mililiter)',
                    satuan: 'ml',
                    stok: 25000,
                    baseProduct: 'BRG002',
                    hargaBeli: 18,
                    hargaJual: 22,
                    kategori: 'Minyak'
                },
                {
                    kode: 'BRG003-DUS',
                    nama: 'Air Mineral (Dus)',
                    satuan: 'dus',
                    stok: 20,
                    baseProduct: 'BRG003',
                    hargaBeli: 48000,
                    hargaJual: 60000,
                    kategori: 'Minuman'
                },
                {
                    kode: 'BRG003-BTL',
                    nama: 'Air Mineral (Botol)',
                    satuan: 'botol',
                    stok: 480,
                    baseProduct: 'BRG003',
                    hargaBeli: 2000,
                    hargaJual: 2500,
                    kategori: 'Minuman'
                }
            ];

            // Sample conversion ratios
            const conversionRatios = [
                {
                    baseProduct: 'BRG001',
                    conversions: [
                        { from: 'kg', to: 'gram', ratio: 1000 },
                        { from: 'gram', to: 'kg', ratio: 0.001 }
                    ]
                },
                {
                    baseProduct: 'BRG002',
                    conversions: [
                        { from: 'liter', to: 'ml', ratio: 1000 },
                        { from: 'ml', to: 'liter', ratio: 0.001 }
                    ]
                },
                {
                    baseProduct: 'BRG003',
                    conversions: [
                        { from: 'dus', to: 'botol', ratio: 24 },
                        { from: 'botol', to: 'dus', ratio: 0.041667 }
                    ]
                }
            ];

            // Save to localStorage
            localStorage.setItem('masterBarang', JSON.stringify(sampleBarang));
            localStorage.setItem('barang', JSON.stringify(sampleBarang));
            localStorage.setItem('conversionRatios', JSON.stringify(conversionRatios));
            localStorage.setItem('currentUser', 'Test User');
            localStorage.setItem('userRole', 'admin');
            
            addTestResult('Create Sample Data', 'success', `Created ${sampleBarang.length} items and ${conversionRatios.length} conversion rules`);
        }

        async function testInitialization() {
            try {
                // Test if initialization function exists
                if (typeof window.initializeTransformasiBarang !== 'function') {
                    addTestResult('Initialization Function', 'error', 'initializeTransformasiBarang function not found');
                    return false;
                }
                
                // Try to initialize
                await window.initializeTransformasiBarang();
                addTestResult('System Initialization', 'success', 'System initialized successfully');
                
                // Test if global instances are created
                const instances = [
                    'transformationManager',
                    'uiController',
                    'validationEngine',
                    'stockManager',
                    'auditLogger',
                    'errorHandler',
                    'calculator'
                ];
                
                let instancesCreated = 0;
                instances.forEach(instance => {
                    if (window[instance]) {
                        instancesCreated++;
                        addTestResult(`Instance ${instance}`, 'success');
                    } else {
                        addTestResult(`Instance ${instance}`, 'error', 'Instance not created');
                    }
                });
                
                return instancesCreated === instances.length;
                
            } catch (error) {
                addTestResult('System Initialization', 'error', error.message);
                return false;
            }
        }

        async function runSystemTests() {
            addProgressStep('Menjalankan test sistem...', 'pending');
            
            // Test 1: Check localStorage data
            const masterBarang = localStorage.getItem('masterBarang');
            addTestResult('LocalStorage Data', masterBarang ? 'success' : 'error', 
                         masterBarang ? `${JSON.parse(masterBarang).length} items found` : 'No data found');
            
            // Test 2: Check conversion ratios
            const conversionRatios = localStorage.getItem('conversionRatios');
            addTestResult('Conversion Ratios', conversionRatios ? 'success' : 'error',
                         conversionRatios ? `${JSON.parse(conversionRatios).length} rules found` : 'No ratios found');
            
            // Test 3: Test transformation manager
            if (window.transformationManager) {
                try {
                    const transformableItems = await window.transformationManager.getTransformableItems();
                    addTestResult('Transformation Manager', 'success', `Found ${transformableItems.length} transformable groups`);
                } catch (error) {
                    addTestResult('Transformation Manager', 'error', error.message);
                }
            } else {
                addTestResult('Transformation Manager', 'error', 'Manager not available');
            }
            
            // Test 4: Test UI Controller
            if (window.uiController) {
                addTestResult('UI Controller', 'success', 'Controller available');
            } else {
                addTestResult('UI Controller', 'error', 'Controller not available');
            }
            
            addProgressStep('Test sistem selesai', 'completed');
        }

        function reloadScripts() {
            addProgressStep('Memuat ulang scripts...', 'pending');
            location.reload();
        }

        function openTransformasiBarang() {
            if (systemStatus.systemReady) {
                window.open('transformasi_barang.html', '_blank');
            } else {
                alert('Sistem belum siap. Jalankan perbaikan terlebih dahulu.');
            }
        }

        // Auto-run initial diagnosis
        setTimeout(() => {
            addProgressStep('Menjalankan diagnosis awal...', 'pending');
            
            // Check if files are already loaded
            systemStatus.filesLoaded = checkRequiredClasses();
            
            // Check if data exists
            systemStatus.dataInitialized = !!localStorage.getItem('masterBarang');
            
            // Check if system is ready
            systemStatus.systemReady = systemStatus.filesLoaded && systemStatus.dataInitialized;
            
            updateSystemStatus();
            
            if (systemStatus.systemReady) {
                addProgressStep('‚úÖ Sistem sudah siap digunakan!', 'completed');
                document.getElementById('test-system').disabled = false;
                document.getElementById('open-transformasi').disabled = false;
            } else {
                addProgressStep('‚ö†Ô∏è Sistem memerlukan perbaikan', 'error');
            }
        }, 1000);
    </script>
</body>
</html>