<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Master Barang Excel - Koperasi</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* Responsive Design Enhancements */
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .upload-area:hover {
            border-color: #0d6efd;
            background-color: #f8f9fa;
        }
        
        .upload-area.dragover {
            border-color: #0d6efd;
            background-color: #e7f1ff;
        }
        
        /* Mobile Responsive Adjustments */
        @media (max-width: 768px) {
            .upload-area {
                padding: 2rem 1rem;
                min-height: 150px;
            }
            
            .upload-area h5 {
                font-size: 1.1rem;
            }
            
            .upload-area .fa-3x {
                font-size: 2rem !important;
            }
            
            .container {
                padding-left: 15px;
                padding-right: 15px;
            }
            
            .step-indicator {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .step {
                min-width: 120px;
            }
            
            .step:not(:last-child)::after {
                display: none;
            }
        }
        
        @media (max-width: 576px) {
            .upload-area {
                padding: 1.5rem 0.5rem;
            }
            
            .step-indicator {
                flex-direction: column;
                align-items: center;
            }
            
            .step {
                width: 100%;
                max-width: 200px;
                margin-bottom: 10px;
            }
            
            .preview-table {
                overflow-x: auto;
            }
            
            .table {
                min-width: 800px;
            }
        }
        
        /* Accessibility Enhancements */
        .upload-area:focus {
            outline: 2px solid #0d6efd;
            outline-offset: 2px;
        }
        
        .step-circle:focus {
            outline: 2px solid #0d6efd;
            outline-offset: 2px;
        }
        
        /* High Contrast Mode Support */
        @media (prefers-contrast: high) {
            .upload-area {
                border-width: 3px;
            }
            
            .step-circle {
                border: 2px solid currentColor;
            }
        }
        
        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            .upload-area,
            .step-circle,
            .progress-bar {
                transition: none;
            }
            
            .progress-bar-animated {
                animation: none;
            }
        }
        
        /* Focus Management */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: #000;
            color: #fff;
            padding: 8px;
            text-decoration: none;
            z-index: 1000;
        }
        
        .skip-link:focus {
            top: 6px;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
        }
        
        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        
        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 15px;
            right: -50%;
            width: 100%;
            height: 2px;
            background-color: #dee2e6;
            z-index: -1;
        }
        
        .step.active::after {
            background-color: #0d6efd;
        }
        
        .step.completed::after {
            background-color: #198754;
        }
        
        .step-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #dee2e6;
            color: #6c757d;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        
        .step.active .step-circle {
            background-color: #0d6efd;
            color: white;
        }
        
        .step.completed .step-circle {
            background-color: #198754;
            color: white;
        }
        
        .validation-badge {
            font-size: 0.75rem;
            margin-left: 0.25rem;
        }
        
        .preview-table {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .progress-container {
            display: none;
        }
        
        .error-list, .warning-list {
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- Skip Link for Accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary" role="navigation" aria-label="Main navigation">
        <div class="container">
            <a class="navbar-brand" href="index.html" aria-label="Koperasi - Go to homepage">
                <i class="fas fa-store me-2" aria-hidden="true"></i>Koperasi
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="index.html" aria-label="Return to main menu">
                    <i class="fas fa-arrow-left me-1" aria-hidden="true"></i>Kembali ke Menu Utama
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mt-4" id="main-content" role="main">
        <!-- Header -->
        <header class="row mb-4">
            <div class="col-md-8">
                <h1 class="mb-0" id="page-title">
                    <i class="fas fa-file-excel me-3 text-success" aria-hidden="true"></i>Upload Master Barang Excel
                </h1>
                <p class="text-muted mt-2">Upload data barang secara massal menggunakan file Excel atau CSV</p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-outline-primary" id="downloadTemplateBtn" 
                        aria-describedby="template-help">
                    <i class="fas fa-download me-2" aria-hidden="true"></i>Download Template
                </button>
                <div id="template-help" class="sr-only">
                    Download template CSV untuk format data yang benar
                </div>
            </div>
        </header>

        <!-- Step Indicator -->
        <nav class="step-indicator" role="navigation" aria-label="Upload progress steps">
            <div class="step active" id="step1" role="tab" aria-selected="true" tabindex="0">
                <div class="step-circle" aria-label="Step 1">1</div>
                <div class="step-label">Upload File</div>
            </div>
            <div class="step" id="step2" role="tab" aria-selected="false" tabindex="-1">
                <div class="step-circle" aria-label="Step 2">2</div>
                <div class="step-label">Preview Data</div>
            </div>
            <div class="step" id="step3" role="tab" aria-selected="false" tabindex="-1">
                <div class="step-circle" aria-label="Step 3">3</div>
                <div class="step-label">Validasi</div>
            </div>
            <div class="step" id="step4" role="tab" aria-selected="false" tabindex="-1">
                <div class="step-circle" aria-label="Step 4">4</div>
                <div class="step-label">Import</div>
            </div>
        </nav>

        <!-- Step 1: File Upload -->
        <section class="card mb-4" id="uploadStep" role="tabpanel" aria-labelledby="step1">
            <div class="card-header">
                <h2 class="mb-0 h5">
                    <i class="fas fa-upload me-2" aria-hidden="true"></i>Step 1: Upload File Excel/CSV
                </h2>
            </div>
            <div class="card-body">
                <div class="upload-area" id="uploadArea" 
                     role="button" 
                     tabindex="0"
                     aria-label="Upload area - drag and drop files here or click to select"
                     aria-describedby="upload-instructions">
                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3" aria-hidden="true"></i>
                    <h3 class="h5">Drag & Drop file Excel atau CSV di sini</h3>
                    <p class="text-muted">atau klik untuk memilih file</p>
                    <div id="upload-instructions" class="small text-muted">
                        Format yang didukung: .xlsx, .csv (Maksimal 5MB)
                    </div>
                    <input type="file" 
                           id="fileInput" 
                           class="d-none" 
                           accept=".xlsx,.csv"
                           aria-label="Select Excel or CSV file">
                </div>
                
                <div class="mt-3" id="fileInfo" style="display: none;" role="status" aria-live="polite">
                    <div class="alert alert-info">
                        <i class="fas fa-file me-2" aria-hidden="true"></i>
                        <span id="fileName"></span>
                        <span class="badge bg-secondary ms-2" id="fileSize"></span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Step 2: Data Preview -->
        <section class="card mb-4" id="previewStep" style="display: none;" role="tabpanel" aria-labelledby="step2">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2 class="mb-0 h5">
                    <i class="fas fa-eye me-2" aria-hidden="true"></i>Step 2: Preview Data
                </h2>
                <span class="badge bg-primary" id="recordCount" aria-live="polite">0 records</span>
            </div>
            <div class="card-body">
                <div class="preview-table" role="region" aria-label="Data preview table">
                    <table class="table table-striped table-hover" 
                           id="previewTable" 
                           role="table"
                           aria-label="Preview of uploaded data">
                        <thead class="table-dark">
                            <tr role="row">
                                <th scope="col" tabindex="0" aria-sort="none">Kode</th>
                                <th scope="col" tabindex="0" aria-sort="none">Nama</th>
                                <th scope="col" tabindex="0" aria-sort="none">Kategori</th>
                                <th scope="col" tabindex="0" aria-sort="none">Satuan</th>
                                <th scope="col" tabindex="0" aria-sort="none">Harga Beli</th>
                                <th scope="col" tabindex="0" aria-sort="none">Stok</th>
                                <th scope="col" tabindex="0" aria-sort="none">Supplier</th>
                                <th scope="col" tabindex="0" aria-sort="none">Status</th>
                            </tr>
                        </thead>
                        <tbody id="previewTableBody" role="rowgroup">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Bulk Edit Controls -->
                <div class="row mb-3" id="bulkEditControls" style="display: none;">
                    <div class="col-12">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-edit me-2"></i>Bulk Edit - 
                                    <span id="selectedCount">0</span> items selected
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <label for="bulkCategory" class="form-label">Kategori</label>
                                        <select class="form-select" id="bulkCategory">
                                            <option value="">-- Pilih Kategori --</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="bulkUnit" class="form-label">Satuan</label>
                                        <select class="form-select" id="bulkUnit">
                                            <option value="">-- Pilih Satuan --</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="bulkSupplier" class="form-label">Supplier</label>
                                        <input type="text" class="form-control" id="bulkSupplier" placeholder="Nama supplier">
                                    </div>
                                    <div class="col-md-3 d-flex align-items-end">
                                        <button class="btn btn-success me-2" id="applyBulkEditBtn">
                                            <i class="fas fa-check me-1"></i>Apply
                                        </button>
                                        <button class="btn btn-secondary" id="cancelBulkEditBtn">
                                            <i class="fas fa-times me-1"></i>Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <nav class="mt-3" role="navigation" aria-label="Step navigation">
                    <button class="btn btn-secondary me-2" 
                            id="backToUploadBtn"
                            aria-label="Go back to upload step">
                        <i class="fas fa-arrow-left me-2" aria-hidden="true"></i>Kembali
                    </button>
                    <button class="btn btn-outline-info me-2" 
                            id="bulkEditBtn"
                            aria-label="Enable bulk edit mode"
                            style="display: none;">
                        <i class="fas fa-edit me-2" aria-hidden="true"></i>Bulk Edit
                    </button>
                    <button class="btn btn-primary" 
                            id="continueToValidationBtn"
                            aria-label="Continue to validation step">
                        <i class="fas fa-arrow-right me-2" aria-hidden="true"></i>Lanjut ke Validasi
                    </button>
                </nav>
            </div>
        </section>

        <!-- Step 3: Validation -->
        <div class="card mb-4" id="validationStep" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i>Step 3: Validasi Data</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-danger" id="errorsCard" style="display: none;">
                            <div class="card-header bg-danger text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Errors (<span id="errorCount">0</span>)
                                </h6>
                            </div>
                            <div class="card-body error-list" id="errorsList">
                                <!-- Errors will be populated here -->
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-warning" id="warningsCard" style="display: none;">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0">
                                    <i class="fas fa-exclamation-circle me-2"></i>
                                    Warnings (<span id="warningCount">0</span>)
                                </h6>
                            </div>
                            <div class="card-body warning-list" id="warningsList">
                                <!-- Warnings will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-success mt-3" id="validationSuccess" style="display: none;">
                    <i class="fas fa-check-circle me-2"></i>
                    Semua data valid dan siap untuk diimport!
                </div>
                
                <div class="mt-3">
                    <button class="btn btn-secondary me-2" id="backToPreviewBtn">
                        <i class="fas fa-arrow-left me-2"></i>Kembali
                    </button>
                    <button class="btn btn-success" id="continueToImportBtn" disabled>
                        <i class="fas fa-arrow-right me-2"></i>Lanjut ke Import
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 4: Import -->
        <div class="card mb-4" id="importStep" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-database me-2"></i>Step 4: Import Data</h5>
            </div>
            <div class="card-body">
                <div class="progress-container" id="progressContainer">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span id="progressLabel">Memproses data...</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="progressBar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="import-results" id="importResults" style="display: none;">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="card border-success">
                                <div class="card-body">
                                    <i class="fas fa-plus-circle fa-2x text-success mb-2"></i>
                                    <h4 class="text-success" id="createdCount">0</h4>
                                    <p class="mb-0">Dibuat</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-info">
                                <div class="card-body">
                                    <i class="fas fa-edit fa-2x text-info mb-2"></i>
                                    <h4 class="text-info" id="updatedCount">0</h4>
                                    <p class="mb-0">Diupdate</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-danger">
                                <div class="card-body">
                                    <i class="fas fa-times-circle fa-2x text-danger mb-2"></i>
                                    <h4 class="text-danger" id="failedCount">0</h4>
                                    <p class="mb-0">Gagal</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-primary">
                                <div class="card-body">
                                    <i class="fas fa-list fa-2x text-primary mb-2"></i>
                                    <h4 class="text-primary" id="totalCount">0</h4>
                                    <p class="mb-0">Total</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <button class="btn btn-secondary me-2" id="backToValidationBtn">
                        <i class="fas fa-arrow-left me-2"></i>Kembali
                    </button>
                    <button class="btn btn-primary" id="startImportBtn">
                        <i class="fas fa-play me-2"></i>Mulai Import
                    </button>
                    <button class="btn btn-success" id="finishBtn" style="display: none;">
                        <i class="fas fa-check me-2"></i>Selesai
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Core Upload Components -->
    <script src="js/upload-excel/types.js"></script>
    <script src="js/upload-excel/ExcelUploadManager.js"></script>
    
    <!-- Additional Components -->
    <script src="js/upload-excel/ValidationEngine.js"></script>
    <script src="js/upload-excel/CategoryUnitManager.js"></script>
    <script src="js/upload-excel/DataProcessor.js"></script>
    <script src="js/upload-excel/AuditLogger.js"></script>
    
    <!-- Task 5 Components -->
    <script src="js/upload-excel/UIManager.js"></script>
    <script src="js/upload-excel/TemplateManager.js"></script>
    
    <!-- Main Application Script -->
    <script>
        // Global variables
        let uploadManager;
        let uiManager;
        let templateManager;
        let currentStep = 1;
        let uploadedData = null;

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Upload Master Barang Excel - Initializing...');
            
            try {
                // Initialize managers
                uploadManager = new ExcelUploadManager();
                
                // Initialize UI and Template managers if available
                if (typeof UIManager !== 'undefined') {
                    uiManager = new UIManager();
                }
                if (typeof TemplateManager !== 'undefined') {
                    templateManager = new TemplateManager();
                }
                
                // Setup event listeners
                setupEventListeners();
                
                console.log('Upload Master Barang Excel - Ready!');
            } catch (error) {
                console.error('Error initializing application:', error);
                showError('Error initializing application: ' + error.message);
            }
        });

        // Setup all event listeners
        function setupEventListeners() {
            // File upload area
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            // Drag & Drop events
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            uploadArea.addEventListener('click', () => fileInput.click());

            // Keyboard accessibility for upload area
            uploadArea.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    fileInput.click();
                }
            });

            // File input change
            fileInput.addEventListener('change', handleFileSelect);

            // Setup keyboard navigation for steps
            setupKeyboardNavigation();

            // Navigation buttons
            document.getElementById('downloadTemplateBtn').addEventListener('click', downloadTemplate);
            document.getElementById('backToUploadBtn').addEventListener('click', () => goToStep(1));
            document.getElementById('continueToValidationBtn').addEventListener('click', () => goToStep(3));
            document.getElementById('backToPreviewBtn').addEventListener('click', () => goToStep(2));
            document.getElementById('continueToImportBtn').addEventListener('click', () => goToStep(4));
            document.getElementById('backToValidationBtn').addEventListener('click', () => goToStep(3));
            document.getElementById('startImportBtn').addEventListener('click', startImport);
            document.getElementById('finishBtn').addEventListener('click', () => location.reload());

            // Bulk edit buttons
            document.getElementById('bulkEditBtn').addEventListener('click', enableBulkEditMode);
            document.getElementById('applyBulkEditBtn').addEventListener('click', applyBulkEdit);
            document.getElementById('cancelBulkEditBtn').addEventListener('click', disableBulkEditMode);
        }

        // Setup keyboard navigation
        function setupKeyboardNavigation() {
            // Step navigation with arrow keys
            const steps = document.querySelectorAll('.step');
            steps.forEach((step, index) => {
                step.addEventListener('keydown', (e) => {
                    switch (e.key) {
                        case 'ArrowRight':
                            e.preventDefault();
                            focusStep(Math.min(index + 1, steps.length - 1));
                            break;
                        case 'ArrowLeft':
                            e.preventDefault();
                            focusStep(Math.max(index - 1, 0));
                            break;
                        case 'Home':
                            e.preventDefault();
                            focusStep(0);
                            break;
                        case 'End':
                            e.preventDefault();
                            focusStep(steps.length - 1);
                            break;
                    }
                });
            });

            // Table keyboard navigation
            setupTableKeyboardNavigation();
        }

        // Focus specific step
        function focusStep(stepIndex) {
            const steps = document.querySelectorAll('.step');
            steps.forEach((step, index) => {
                step.setAttribute('tabindex', index === stepIndex ? '0' : '-1');
                step.setAttribute('aria-selected', index === stepIndex ? 'true' : 'false');
            });
            steps[stepIndex].focus();
        }

        // Setup table keyboard navigation
        function setupTableKeyboardNavigation() {
            const table = document.getElementById('previewTable');
            if (!table) return;

            // Add keyboard support for sortable headers
            const headers = table.querySelectorAll('th[tabindex]');
            headers.forEach(header => {
                header.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        header.click();
                    }
                });
            });
        }

        // Drag & Drop handlers
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        // Handle file upload
        async function handleFile(file) {
            try {
                showLoading('Memproses file...');
                
                // Upload file using ExcelUploadManager
                const session = await uploadManager.uploadFile(file);
                
                // Process file content
                const data = await uploadManager.processFileContent(file);
                uploadedData = data;
                
                // Update session with record count
                session.recordCount = data.length;
                
                // Show file info
                showFileInfo(file, data.length);
                
                // Generate preview
                const preview = uploadManager.previewData(data);
                showPreview(preview);
                
                // Go to preview step
                goToStep(2);
                
                hideLoading();
            } catch (error) {
                console.error('Error handling file:', error);
                showError('Error memproses file: ' + error.message);
                hideLoading();
            }
        }

        // Show file information
        function showFileInfo(file, recordCount) {
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.style.display = 'block';
            
            // Update record count
            document.getElementById('recordCount').textContent = `${recordCount} records`;
        }

        // Show data preview
        function showPreview(preview) {
            try {
                if (uiManager && typeof uiManager.setUploadedData === 'function') {
                    // Set data in UI manager
                    uiManager.setUploadedData(preview.data);
                    
                    // Render using UI manager for enhanced functionality
                    uiManager.renderPreviewTable(preview.data);
                    
                    // Setup selection change handlers
                    setTimeout(() => {
                        const checkboxes = document.querySelectorAll('#previewTableBody input[type="checkbox"]');
                        checkboxes.forEach(checkbox => {
                            checkbox.addEventListener('change', updateSelectionCount);
                        });
                        
                        // Setup select all functionality
                        const selectAllCheckbox = document.getElementById('selectAll');
                        if (selectAllCheckbox) {
                            selectAllCheckbox.addEventListener('change', (e) => {
                                checkboxes.forEach(checkbox => {
                                    checkbox.checked = e.target.checked;
                                });
                                updateSelectionCount();
                            });
                        }
                    }, 100);
                } else {
                    // Fallback to simple preview
                    showSimplePreview(preview);
                }
            } catch (error) {
                console.error('Error showing preview:', error);
                // Fallback to simple preview
                showSimplePreview(preview);
            }
        }
        
        // Fallback simple preview
        function showSimplePreview(preview) {
            const tableBody = document.getElementById('previewTableBody');
            tableBody.innerHTML = '';
            
            const data = preview.data || preview; // Handle both preview object and direct data array
            
            if (Array.isArray(data)) {
                data.forEach((row, index) => {
                    const tr = document.createElement('tr');
                    
                    // Determine status badge based on validation
                    let statusBadge = '<span class="badge bg-success">Valid</span>';
                    if (row._hasErrors) {
                        statusBadge = '<span class="badge bg-danger">Error</span>';
                    } else if (row._hasWarnings) {
                        statusBadge = '<span class="badge bg-warning">Warning</span>';
                    }
                    
                    tr.innerHTML = `
                        <td>${row.kode || ''}</td>
                        <td>${row.nama || ''}</td>
                        <td><span class="badge bg-secondary">${row.kategori || ''}</span></td>
                        <td><span class="badge bg-info">${row.satuan || ''}</span></td>
                        <td>${formatCurrency(row.harga_beli || 0)}</td>
                        <td>${row.stok || 0}</td>
                        <td>${row.supplier || ''}</td>
                        <td>${statusBadge}</td>
                    `;
                    tableBody.appendChild(tr);
                });
            } else {
                // Show error message if data is not an array
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td colspan="8" class="text-center text-muted">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No data available for preview
                    </td>
                `;
                tableBody.appendChild(tr);
            }
        }

        // Navigation functions
        function goToStep(step) {
            // Hide all steps
            document.getElementById('uploadStep').style.display = 'none';
            document.getElementById('previewStep').style.display = 'none';
            document.getElementById('validationStep').style.display = 'none';
            document.getElementById('importStep').style.display = 'none';
            
            // Update step indicators with accessibility
            for (let i = 1; i <= 4; i++) {
                const stepElement = document.getElementById(`step${i}`);
                stepElement.classList.remove('active', 'completed');
                stepElement.setAttribute('aria-selected', 'false');
                stepElement.setAttribute('tabindex', '-1');
                
                if (i < step) {
                    stepElement.classList.add('completed');
                } else if (i === step) {
                    stepElement.classList.add('active');
                    stepElement.setAttribute('aria-selected', 'true');
                    stepElement.setAttribute('tabindex', '0');
                }
            }
            
            // Show current step and announce to screen readers
            let stepContent, stepTitle;
            switch (step) {
                case 1:
                    stepContent = document.getElementById('uploadStep');
                    stepTitle = 'Upload File Excel/CSV';
                    break;
                case 2:
                    stepContent = document.getElementById('previewStep');
                    stepTitle = 'Preview Data';
                    break;
                case 3:
                    stepContent = document.getElementById('validationStep');
                    stepTitle = 'Validasi Data';
                    // Run validation (placeholder for Task 3)
                    showValidationSuccess();
                    break;
                case 4:
                    stepContent = document.getElementById('importStep');
                    stepTitle = 'Import Data';
                    break;
            }
            
            if (stepContent) {
                stepContent.style.display = 'block';
                
                // Announce step change to screen readers
                announceToScreenReader(`Navigated to ${stepTitle}`);
                
                // Focus management
                const firstFocusable = stepContent.querySelector('button, input, select, textarea, [tabindex]:not([tabindex="-1"])');
                if (firstFocusable) {
                    setTimeout(() => firstFocusable.focus(), 100);
                }
            }
            
            currentStep = step;
        }

        // Announce to screen readers
        function announceToScreenReader(message) {
            const announcement = document.createElement('div');
            announcement.setAttribute('aria-live', 'polite');
            announcement.setAttribute('aria-atomic', 'true');
            announcement.className = 'sr-only';
            announcement.textContent = message;
            
            document.body.appendChild(announcement);
            
            // Remove after announcement
            setTimeout(() => {
                document.body.removeChild(announcement);
            }, 1000);
        }

        // Placeholder validation (will be implemented in Task 3)
        function showValidationSuccess() {
            document.getElementById('validationSuccess').style.display = 'block';
            document.getElementById('continueToImportBtn').disabled = false;
        }

        // Start import process (placeholder for Task 7)
        function startImport() {
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('startImportBtn').style.display = 'none';
            
            // Simulate import progress
            simulateImportProgress();
        }

        function simulateImportProgress() {
            let progress = 0;
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            const progressLabel = document.getElementById('progressLabel');
            
            const interval = setInterval(() => {
                progress += 10;
                progressBar.style.width = progress + '%';
                progressPercent.textContent = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(interval);
                    showImportResults();
                }
            }, 200);
        }

        function showImportResults() {
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('importResults').style.display = 'block';
            document.getElementById('finishBtn').style.display = 'inline-block';
            
            // Show mock results
            const recordCount = uploadedData ? uploadedData.length : 0;
            document.getElementById('createdCount').textContent = recordCount;
            document.getElementById('updatedCount').textContent = '0';
            document.getElementById('failedCount').textContent = '0';
            document.getElementById('totalCount').textContent = recordCount;
        }

        // Download template
        function downloadTemplate() {
            try {
                if (templateManager && typeof templateManager.downloadCSVTemplate === 'function') {
                    templateManager.downloadCSVTemplate('template_master_barang_excel.csv');
                } else {
                    // Fallback to manual template creation
                    downloadTemplateManual();
                }
            } catch (error) {
                console.error('Error downloading template:', error);
                // Fallback to manual template creation
                downloadTemplateManual();
            }
        }

        // Manual template download fallback
        function downloadTemplateManual() {
            const template = `kode,nama,kategori,satuan,harga_beli,stok,supplier
BRG001,Beras Premium 5kg,makanan,kg,65000,50,PT Beras Sejahtera
BRG002,Minyak Goreng 1L,makanan,botol,15000,30,CV Minyak Murni
BRG003,Pulpen Pilot Hitam,alat-tulis,pcs,3000,100,Toko ATK Lengkap
BRG004,Air Mineral 600ml,minuman,botol,2500,200,PT Air Bersih`;

            const blob = new Blob([template], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'template_master_barang_excel.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Utility functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function showLoading(message) {
            // Implementation for loading indicator
            console.log('Loading:', message);
        }

        function hideLoading() {
            // Implementation for hiding loading indicator
            console.log('Loading hidden');
        }

        function showError(message) {
            alert('Error: ' + message);
        }

        // Bulk Edit Functions
        let bulkEditMode = false;

        function enableBulkEditMode() {
            bulkEditMode = true;
            document.getElementById('bulkEditControls').style.display = 'block';
            document.getElementById('bulkEditBtn').style.display = 'none';
            
            // Populate bulk edit options
            populateBulkEditOptions();
            
            // Show selection checkboxes if not already visible
            if (uiManager && typeof uiManager.enableRowSelection === 'function') {
                uiManager.enableRowSelection();
            }
            
            announceToScreenReader('Bulk edit mode enabled. Select rows to edit multiple items at once.');
        }

        function disableBulkEditMode() {
            bulkEditMode = false;
            document.getElementById('bulkEditControls').style.display = 'none';
            document.getElementById('bulkEditBtn').style.display = 'inline-block';
            
            // Clear selections
            const checkboxes = document.querySelectorAll('#previewTableBody input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = false);
            
            updateSelectionCount();
            announceToScreenReader('Bulk edit mode disabled.');
        }

        function populateBulkEditOptions() {
            if (!uploadedData) return;
            
            // Get unique categories and units
            const categories = [...new Set(uploadedData.map(row => row.kategori).filter(Boolean))];
            const units = [...new Set(uploadedData.map(row => row.satuan).filter(Boolean))];
            
            // Populate category dropdown
            const categorySelect = document.getElementById('bulkCategory');
            categorySelect.innerHTML = '<option value="">-- Pilih Kategori --</option>';
            categories.sort().forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
            
            // Populate unit dropdown
            const unitSelect = document.getElementById('bulkUnit');
            unitSelect.innerHTML = '<option value="">-- Pilih Satuan --</option>';
            units.sort().forEach(unit => {
                const option = document.createElement('option');
                option.value = unit;
                option.textContent = unit;
                unitSelect.appendChild(option);
            });
        }

        function applyBulkEdit() {
            const selectedCheckboxes = document.querySelectorAll('#previewTableBody input[type="checkbox"]:checked');
            if (selectedCheckboxes.length === 0) {
                showError('Pilih minimal satu item untuk diedit.');
                return;
            }
            
            const bulkCategory = document.getElementById('bulkCategory').value;
            const bulkUnit = document.getElementById('bulkUnit').value;
            const bulkSupplier = document.getElementById('bulkSupplier').value;
            
            if (!bulkCategory && !bulkUnit && !bulkSupplier) {
                showError('Pilih minimal satu field untuk diupdate.');
                return;
            }
            
            // Apply changes to selected rows
            let updatedCount = 0;
            selectedCheckboxes.forEach(checkbox => {
                const index = parseInt(checkbox.dataset.index);
                if (uploadedData[index]) {
                    if (bulkCategory) {
                        uploadedData[index].kategori = bulkCategory;
                    }
                    if (bulkUnit) {
                        uploadedData[index].satuan = bulkUnit;
                    }
                    if (bulkSupplier) {
                        uploadedData[index].supplier = bulkSupplier;
                    }
                    updatedCount++;
                }
            });
            
            // Refresh preview table
            showPreview({ data: uploadedData });
            
            // Clear bulk edit form
            document.getElementById('bulkCategory').value = '';
            document.getElementById('bulkUnit').value = '';
            document.getElementById('bulkSupplier').value = '';
            
            // Disable bulk edit mode
            disableBulkEditMode();
            
            announceToScreenReader(`Bulk edit applied to ${updatedCount} items successfully.`);
        }

        function updateSelectionCount() {
            const selectedCount = document.querySelectorAll('#previewTableBody input[type="checkbox"]:checked').length;
            const totalCount = document.querySelectorAll('#previewTableBody input[type="checkbox"]').length;
            
            document.getElementById('selectedCount').textContent = selectedCount;
            
            // Show/hide bulk edit button based on selection
            const bulkEditBtn = document.getElementById('bulkEditBtn');
            if (selectedCount > 0 && !bulkEditMode) {
                bulkEditBtn.style.display = 'inline-block';
            } else if (selectedCount === 0 && !bulkEditMode) {
                bulkEditBtn.style.display = 'none';
            }
        }
    </script>
</body>
</html>