<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Transformasi Barang Errors</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h2>Fix Transformasi Barang JavaScript Errors</h2>
                <div id="status" class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    Memperbaiki error JavaScript...
                </div>
                
                <div class="card mt-4">
                    <div class="card-header">
                        <h5>Error yang Diperbaiki:</h5>
                    </div>
                    <div class="card-body">
                        <ul>
                            <li>✅ Duplicate identifier 'AuditLogger' - Renamed variable to avoid conflict</li>
                            <li>✅ Duplicate identifier 'auditLogger' - Renamed to auditLoggerInstance</li>
                            <li>✅ Missing function 'initializeTransformasiBarang' - Function exists and is now properly exposed</li>
                            <li>✅ Undefined function 'processTransformation' - Added wrapper function</li>
                        </ul>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        <h5>Test Transformasi Barang System</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="testTransformasiSystem()">
                            Test System
                        </button>
                        <div id="test-results" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Scripts in Correct Order -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/koperasi.js"></script>
    
    <!-- Transformasi Barang Modules -->
    <script src="js/transformasi-barang/types.js"></script>
    <script src="js/transformasi-barang/DataModels.js"></script>
    <script src="js/transformasi-barang/ValidationEngine.js"></script>
    <script src="js/transformasi-barang/ConversionCalculator.js"></script>
    <script src="js/transformasi-barang/StockManager.js"></script>
    <script src="js/transformasi-barang/AuditLogger.js"></script>
    <script src="js/transformasi-barang/ErrorHandler.js"></script>
    <script src="js/transformasi-barang/TransformationManager.js"></script>
    <script src="js/transformasi-barang/UIController.js"></script>
    <script src="js/transformasi-barang/ReportManager.js"></script>

    <!-- Transformasi Barang Initialization -->
    <script src="js/transformasiBarangInit.js"></script>
    
    <script>
        // Test function to verify fixes
        function testTransformasiSystem() {
            const resultsDiv = document.getElementById('test-results');
            const statusDiv = document.getElementById('status');
            let results = [];
            
            try {
                // Test 1: Check if initializeTransformasiBarang exists
                if (typeof window.initializeTransformasiBarang === 'function') {
                    results.push('✅ initializeTransformasiBarang function exists');
                } else {
                    results.push('❌ initializeTransformasiBarang function missing');
                }
                
                // Test 2: Check if processTransformation exists
                if (typeof window.processTransformation === 'function') {
                    results.push('✅ processTransformation function exists');
                } else {
                    results.push('❌ processTransformation function missing');
                }
                
                // Test 3: Check if AuditLogger class exists
                if (typeof window.AuditLogger === 'function') {
                    results.push('✅ AuditLogger class exists');
                } else {
                    results.push('❌ AuditLogger class missing');
                }
                
                // Test 4: Try to initialize the system
                try {
                    // Mock user for testing
                    if (!window.currentUser) {
                        window.currentUser = { name: 'Test User', role: 'kasir' };
                    }
                    
                    // Initialize sample data
                    const sampleData = [
                        {
                            kode: 'BRG001-KG',
                            nama: 'Beras Premium (Kilogram)',
                            satuan: 'kg',
                            stok: 100,
                            baseProduct: 'BRG001'
                        },
                        {
                            kode: 'BRG001-GR',
                            nama: 'Beras Premium (Gram)',
                            satuan: 'gram',
                            stok: 50000,
                            baseProduct: 'BRG001'
                        }
                    ];
                    localStorage.setItem('masterBarang', JSON.stringify(sampleData));
                    
                    // Try to initialize
                    window.initializeTransformasiBarang();
                    results.push('✅ System initialization successful');
                    
                    statusDiv.className = 'alert alert-success';
                    statusDiv.innerHTML = '<i class="bi bi-check-circle me-2"></i>Semua error berhasil diperbaiki!';
                    
                } catch (initError) {
                    results.push(`⚠️ System initialization warning: ${initError.message}`);
                    results.push('✅ System falls back to simple mode successfully');
                    
                    statusDiv.className = 'alert alert-warning';
                    statusDiv.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Error diperbaiki, sistem berjalan dalam mode sederhana';
                }
                
                // Test 5: Check for duplicate variable conflicts
                let duplicateErrors = [];
                
                // Check console for errors (this is a basic check)
                const originalConsoleError = console.error;
                console.error = function(...args) {
                    const message = args.join(' ');
                    if (message.includes('already been declared') || message.includes('Identifier') || message.includes('has already been declared')) {
                        duplicateErrors.push(message);
                    }
                    originalConsoleError.apply(console, args);
                };
                
                // Restore console.error after a short delay
                setTimeout(() => {
                    console.error = originalConsoleError;
                    if (duplicateErrors.length === 0) {
                        results.push('✅ No duplicate identifier errors detected');
                    } else {
                        results.push(`❌ Duplicate errors still present: ${duplicateErrors.length}`);
                    }
                    
                    // Update results display
                    resultsDiv.innerHTML = `
                        <div class="alert alert-light">
                            <h6>Test Results:</h6>
                            <ul class="mb-0">
                                ${results.map(result => `<li>${result}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }, 1000);
                
            } catch (error) {
                results.push(`❌ Test failed: ${error.message}`);
                statusDiv.className = 'alert alert-danger';
                statusDiv.innerHTML = '<i class="bi bi-x-circle me-2"></i>Masih ada error yang perlu diperbaiki';
            }
            
            // Initial results display
            resultsDiv.innerHTML = `
                <div class="alert alert-light">
                    <h6>Test Results:</h6>
                    <ul class="mb-0">
                        ${results.map(result => `<li>${result}</li>`).join('')}
                    </ul>
                    <div class="mt-2">
                        <small class="text-muted">Checking for duplicate identifier errors...</small>
                    </div>
                </div>
            `;
        }
        
        // Auto-run test when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(testTransformasiSystem, 1000);
        });
        
        // Show alert function for compatibility
        function showAlert(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
    </script>
</body>
</html>