<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnosis Import Tagihan Pembayaran</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2><i class="bi bi-bug"></i> Diagnosis Import Tagihan Pembayaran</h2>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Component Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="componentStatus"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Error Log</h5>
                    </div>
                    <div class="card-body">
                        <div id="errorLog" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Import Interface</h5>
                    </div>
                    <div class="card-body">
                        <div id="testInterface"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Include all required scripts -->
    <script src="js/auth.js"></script>
    <script src="js/import-tagihan/interfaces.js"></script>
    <script src="js/import-tagihan/FileParser.js"></script>
    <script src="js/import-tagihan/ValidationEngine.js"></script>
    <script src="js/import-tagihan/PreviewGenerator.js"></script>
    <script src="js/import-tagihan/BatchProcessor.js"></script>
    <script src="js/import-tagihan/ReportGenerator.js"></script>
    <script src="js/import-tagihan/AuditLogger.js"></script>
    <script src="js/import-tagihan/ErrorHandler.js"></script>
    <script src="js/import-tagihan/RollbackManager.js"></script>
    <script src="js/import-tagihan/ConfigurationInterface.js"></script>
    <script src="js/import-tagihan/ImportUploadInterface.js"></script>
    <script src="js/import-tagihan/PreviewConfirmationInterface.js"></script>
    <script src="js/import-tagihan/ProgressResultsInterface.js"></script>
    <script src="js/import-tagihan/ImportTagihanManager.js"></script>

    <script>
        // Capture console errors
        const originalConsoleError = console.error;
        const errors = [];
        
        console.error = function(...args) {
            errors.push(args.join(' '));
            updateErrorLog();
            originalConsoleError.apply(console, args);
        };

        function updateErrorLog() {
            const errorLog = document.getElementById('errorLog');
            if (errors.length === 0) {
                errorLog.innerHTML = '<div class="text-success">No errors detected</div>';
            } else {
                errorLog.innerHTML = errors.map(error => 
                    `<div class="alert alert-danger py-1 mb-1 small">${error}</div>`
                ).join('');
            }
        }

        function checkComponent(name, obj) {
            const status = obj ? 
                '<span class="badge bg-success">Available</span>' : 
                '<span class="badge bg-danger">Missing</span>';
            return `<div class="d-flex justify-content-between align-items-center mb-2">
                <span>${name}</span>
                ${status}
            </div>`;
        }

        function updateComponentStatus() {
            const statusDiv = document.getElementById('componentStatus');
            
            let html = '';
            html += checkComponent('ImportTagihanManager', typeof ImportTagihanManager !== 'undefined');
            html += checkComponent('FileParser', typeof FileParser !== 'undefined');
            html += checkComponent('ValidationEngine', typeof ValidationEngine !== 'undefined');
            html += checkComponent('PreviewGenerator', typeof PreviewGenerator !== 'undefined');
            html += checkComponent('BatchProcessor', typeof BatchProcessor !== 'undefined');
            html += checkComponent('ReportGenerator', typeof ReportGenerator !== 'undefined');
            html += checkComponent('AuditLogger', typeof AuditLogger !== 'undefined');
            html += checkComponent('ErrorHandler', typeof ErrorHandler !== 'undefined');
            html += checkComponent('ImportUploadInterface', typeof ImportUploadInterface !== 'undefined');
            
            statusDiv.innerHTML = html;
        }

        function testImportInterface() {
            const testDiv = document.getElementById('testInterface');
            
            try {
                // Test creating ImportTagihanManager
                if (typeof ImportTagihanManager !== 'undefined') {
                    const manager = new ImportTagihanManager();
                    testDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h6>✅ ImportTagihanManager created successfully</h6>
                            <p>State: ${JSON.stringify(manager.getState())}</p>
                        </div>
                        
                        <div class="mt-3">
                            <button class="btn btn-primary" onclick="testTemplateDownload()">
                                Test Template Download
                            </button>
                            <button class="btn btn-secondary ms-2" onclick="testUploadInterface()">
                                Test Upload Interface
                            </button>
                        </div>
                        
                        <div id="testResults" class="mt-3"></div>
                    `;
                    
                    window.testManager = manager;
                } else {
                    testDiv.innerHTML = `
                        <div class="alert alert-danger">
                            ❌ ImportTagihanManager not available
                        </div>
                    `;
                }
            } catch (error) {
                testDiv.innerHTML = `
                    <div class="alert alert-danger">
                        ❌ Error creating ImportTagihanManager: ${error.message}
                    </div>
                `;
            }
        }

        function testTemplateDownload() {
            const resultsDiv = document.getElementById('testResults');
            
            try {
                const template = window.testManager.generateTemplate();
                resultsDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h6>✅ Template generated successfully</h6>
                        <p><strong>Filename:</strong> ${template.filename}</p>
                        <p><strong>Size:</strong> ${template.size} bytes</p>
                        <p><strong>Headers:</strong> ${template.headers.join(', ')}</p>
                        <button class="btn btn-sm btn-primary" onclick="downloadTemplate()">
                            Download Template
                        </button>
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        ❌ Template generation failed: ${error.message}
                    </div>
                `;
            }
        }

        function downloadTemplate() {
            try {
                const success = window.testManager.downloadTemplate();
                if (success) {
                    alert('Template downloaded successfully!');
                } else {
                    alert('Template download failed');
                }
            } catch (error) {
                alert('Download error: ' + error.message);
            }
        }

        function testUploadInterface() {
            const resultsDiv = document.getElementById('testResults');
            
            try {
                if (typeof ImportUploadInterface !== 'undefined') {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-info">
                            <h6>Testing Upload Interface</h6>
                            <div id="uploadInterfaceContainer"></div>
                        </div>
                    `;
                    
                    const uploadInterface = new ImportUploadInterface(window.testManager, 'uploadInterfaceContainer');
                    
                    setTimeout(() => {
                        resultsDiv.innerHTML = `
                            <div class="alert alert-success">
                                ✅ Upload Interface created successfully
                            </div>
                            <div id="uploadInterfaceContainer"></div>
                        `;
                        uploadInterface.render();
                    }, 100);
                    
                } else {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            ❌ ImportUploadInterface not available
                        </div>
                    `;
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        ❌ Upload Interface test failed: ${error.message}
                    </div>
                `;
            }
        }

        // Initialize diagnosis
        document.addEventListener('DOMContentLoaded', function() {
            updateComponentStatus();
            updateErrorLog();
            testImportInterface();
        });
    </script>
</body>
</html>