<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Task 1 - FIXED Core Filtering Functions</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .test-pass { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .test-fail { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .function-test { border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin: 15px 0; }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1><i class="bi bi-gear-fill"></i> Test Task 1 - FIXED Core Filtering Functions</h1>
        <p class="lead">Testing the corrected logic for filterActiveAnggota() function</p>
        
        <div class="alert alert-success">
            <strong>ðŸ”§ FIXED LOGIC:</strong>
            <ul class="mb-0">
                <li><code>filterActiveAnggota()</code> now only excludes <strong>permanently exited</strong> members</li>
                <li>Members with status 'Nonaktif' or 'Cuti' are <strong>included</strong> in Master Anggota</li>
                <li>Transaction filtering is handled separately by <code>filterTransactableAnggota()</code></li>
            </ul>
        </div>

        <div id="testResults"></div>
        
        <button class="btn btn-primary" onclick="runAllTests()">
            <i class="bi bi-play-fill"></i> Run All Tests
        </button>
    </div>

    <!-- Include the koperasi.js file -->
    <script src="js/koperasi.js"></script>
    
    <script>
        // Test data setup
        function setupTestData() {
            const testAnggota = [
                {
                    id: 'A001',
                    nama: 'John Aktif',
                    status: 'Aktif',
                    statusKeanggotaan: 'Anggota'
                },
                {
                    id: 'A002',
                    nama: 'Jane Nonaktif',
                    status: 'Nonaktif',
                    statusKeanggotaan: 'Anggota'
                },
                {
                    id: 'A003',
                    nama: 'Bob Keluar',
                    status: 'Aktif',
                    statusKeanggotaan: 'Keluar'
                },
                {
                    id: 'A004',
                    nama: 'Alice Cuti',
                    status: 'Cuti',
                    statusKeanggotaan: 'Anggota'
                },
                {
                    id: 'A005',
                    nama: 'Charlie TanggalKeluar',
                    status: 'Aktif',
                    statusKeanggotaan: 'Anggota',
                    tanggalKeluar: '2024-01-15'
                },
                {
                    id: 'A006',
                    nama: 'Diana PengembalianStatus',
                    status: 'Aktif',
                    statusKeanggotaan: 'Anggota',
                    pengembalianStatus: 'Proses'
                }
            ];
            
            localStorage.setItem('anggota', JSON.stringify(testAnggota));
            return testAnggota;
        }

        function addResult(testName, passed, message, details = '') {
            const resultsDiv = document.getElementById('testResults');
            const resultClass = passed ? 'test-pass' : 'test-fail';
            const icon = passed ? 'bi-check-circle-fill' : 'bi-x-circle-fill';
            
            resultsDiv.innerHTML += `
                <div class="test-result ${resultClass}">
                    <i class="bi ${icon}"></i>
                    <strong>${testName}:</strong> ${message}
                    ${details ? `<br><small>${details}</small>` : ''}
                </div>
            `;
        }

        // Test the CORRECTED filterActiveAnggota logic
        function testCorrectedFilterActiveAnggota() {
            const testData = setupTestData();
            
            // Test with valid array - should include Aktif, Nonaktif, Cuti
            const result = filterActiveAnggota(testData);
            const expectedCount = 3; // A001 (Aktif), A002 (Nonaktif), A004 (Cuti)
            
            addResult(
                'filterActiveAnggota - Corrected Basic filtering',
                result.length === expectedCount,
                `Returned ${result.length} anggota, expected ${expectedCount}`,
                `Should INCLUDE: Aktif (A001), Nonaktif (A002), Cuti (A004). Should EXCLUDE: Keluar (A003), tanggalKeluar (A005), pengembalianStatus (A006)`
            );
            
            // Test that Nonaktif and Cuti are included
            const hasAktif = result.some(a => a.id === 'A001' && a.status === 'Aktif');
            const hasNonaktif = result.some(a => a.id === 'A002' && a.status === 'Nonaktif');
            const hasCuti = result.some(a => a.id === 'A004' && a.status === 'Cuti');
            
            addResult(
                'filterActiveAnggota - Includes all non-exited statuses',
                hasAktif && hasNonaktif && hasCuti,
                'Correctly includes Aktif, Nonaktif, and Cuti members',
                'All three status types should appear in Master Anggota display'
            );
            
            // Test that permanent exits are excluded
            const hasKeluar = result.some(a => a.statusKeanggotaan === 'Keluar');
            const hasTanggalKeluar = result.some(a => a.tanggalKeluar);
            const hasPengembalianStatus = result.some(a => a.pengembalianStatus);
            
            addResult(
                'filterActiveAnggota - Excludes permanent exits only',
                !hasKeluar && !hasTanggalKeluar && !hasPengembalianStatus,
                'Correctly excludes only permanent exit indicators',
                'Only members who have permanently left should be excluded'
            );
            
            // Test specific exclusions
            const excludedIds = result.map(a => a.id);
            const shouldBeExcluded = ['A003', 'A005', 'A006']; // Keluar, tanggalKeluar, pengembalianStatus
            const shouldBeIncluded = ['A001', 'A002', 'A004']; // Aktif, Nonaktif, Cuti
            
            const correctlyExcluded = shouldBeExcluded.every(id => !excludedIds.includes(id));
            const correctlyIncluded = shouldBeIncluded.every(id => excludedIds.includes(id));
            
            addResult(
                'filterActiveAnggota - Specific member filtering',
                correctlyExcluded && correctlyIncluded,
                'Correctly filters specific members',
                `Included: ${shouldBeIncluded.join(', ')}. Excluded: ${shouldBeExcluded.join(', ')}`
            );
        }

        // Test filterTransactableAnggota (should be more restrictive)
        function testFilterTransactableAnggota() {
            const testData = setupTestData();
            
            const result = filterTransactableAnggota(testData);
            const expectedCount = 1; // Only A001 (Aktif) should pass
            
            addResult(
                'filterTransactableAnggota - Transaction filtering',
                result.length === expectedCount,
                `Returned ${result.length} anggota, expected ${expectedCount}`,
                `Should ONLY include: Aktif (A001). Should exclude: Nonaktif (A002), Keluar (A003), Cuti (A004), tanggalKeluar (A005), pengembalianStatus (A006)`
            );
            
            // Test that only Aktif members are included
            const allAktif = result.every(a => a.status === 'Aktif');
            const onlyA001 = result.length === 1 && result[0].id === 'A001';
            
            addResult(
                'filterTransactableAnggota - Only Aktif members',
                allAktif && onlyA001,
                'Only includes Aktif members for transactions',
                'Nonaktif and Cuti members cannot perform transactions'
            );
        }

        // Test the difference between the two functions
        function testFunctionDifference() {
            const testData = setupTestData();
            
            const activeResult = filterActiveAnggota(testData);
            const transactableResult = filterTransactableAnggota(testData);
            
            addResult(
                'Function Difference - Master Anggota vs Transactions',
                activeResult.length > transactableResult.length,
                `Master Anggota shows ${activeResult.length} members, Transactions allow ${transactableResult.length} members`,
                'Master Anggota includes Nonaktif/Cuti for visibility, Transactions only allow Aktif members'
            );
            
            // Test that transactable is subset of active
            const transactableIds = transactableResult.map(a => a.id);
            const activeIds = activeResult.map(a => a.id);
            const isSubset = transactableIds.every(id => activeIds.includes(id));
            
            addResult(
                'Function Difference - Subset relationship',
                isSubset,
                'Transactable anggota is a subset of active anggota',
                'All members who can transact should also appear in Master Anggota'
            );
        }

        function runAllTests() {
            document.getElementById('testResults').innerHTML = '';
            
            document.getElementById('testResults').innerHTML += '<div class="function-test"><h4><i class="bi bi-1-circle"></i> Corrected filterActiveAnggota Tests</h4>';
            testCorrectedFilterActiveAnggota();
            document.getElementById('testResults').innerHTML += '</div>';
            
            document.getElementById('testResults').innerHTML += '<div class="function-test"><h4><i class="bi bi-2-circle"></i> filterTransactableAnggota Comparison</h4>';
            testFilterTransactableAnggota();
            document.getElementById('testResults').innerHTML += '</div>';
            
            document.getElementById('testResults').innerHTML += '<div class="function-test"><h4><i class="bi bi-3-circle"></i> Function Difference Analysis</h4>';
            testFunctionDifference();
            document.getElementById('testResults').innerHTML += '</div>';
            
            // Summary
            const allResults = document.querySelectorAll('.test-result');
            const passedTests = document.querySelectorAll('.test-pass').length;
            const totalTests = allResults.length;
            
            document.getElementById('testResults').innerHTML += `
                <div class="alert ${passedTests === totalTests ? 'alert-success' : 'alert-warning'} mt-4">
                    <h5><i class="bi bi-clipboard-check"></i> Test Summary</h5>
                    <p><strong>${passedTests}/${totalTests}</strong> tests passed</p>
                    ${passedTests === totalTests ? 
                        '<p class="mb-0"><i class="bi bi-check-circle-fill text-success"></i> âœ… All tests passed! The filterActiveAnggota logic has been corrected.</p>' :
                        '<p class="mb-0"><i class="bi bi-exclamation-triangle-fill text-warning"></i> Some tests failed. Please review the implementation.</p>'
                    }
                </div>
            `;
        }

        // Auto-run tests on page load
        window.onload = function() {
            runAllTests();
        };
    </script>
</body>
</html>