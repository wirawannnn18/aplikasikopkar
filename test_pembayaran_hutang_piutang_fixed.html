<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Pembayaran Hutang Piutang - Fixed</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container py-4">
        <h1><i class="bi bi-check-circle-fill text-success"></i> Test Pembayaran Hutang Piutang - Fixed</h1>
        <p class="lead">Memverifikasi bahwa masalah pembayaran-hutang-piutang telah diperbaiki</p>

        <div class="alert alert-success">
            <h5><i class="bi bi-info-circle"></i> Perbaikan yang Dilakukan</h5>
            <ul class="mb-0">
                <li>✅ Menambahkan <code>js/transactionValidator.js</code> ke dalam index.html</li>
                <li>✅ Memastikan urutan loading script yang benar</li>
                <li>✅ Semua dependency tersedia sebelum pembayaranHutangPiutang.js dimuat</li>
            </ul>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5><i class="bi bi-gear"></i> Test Setup</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary w-100" onclick="setupTestData()">Setup Test Data</button>
                        <div id="setupResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5><i class="bi bi-play-circle"></i> Test Navigation</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-success w-100" onclick="testNavigation()">Test Navigation to Pembayaran</button>
                        <div id="navigationResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-display"></i> Pembayaran Hutang Piutang Interface</h5>
                    </div>
                    <div class="card-body">
                        <div id="content"></div>
                        <div id="mainContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-list-check"></i> Function Tests</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <button class="btn btn-outline-primary w-100 mb-2" onclick="testSaldoCalculation()">Test Saldo Calculation</button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-outline-success w-100 mb-2" onclick="testAnggotaSearch()">Test Anggota Search</button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-outline-info w-100 mb-2" onclick="testValidation()">Test Validation</button>
                            </div>
                        </div>
                        <div id="functionTestResults" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load scripts in the same order as index.html -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/app.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/koperasi.js"></script>
    <script src="js/keuangan.js"></script>
    <script src="js/transactionValidator.js"></script>
    <script src="js/pembayaranHutangPiutang.js"></script>

    <script>
        function setupTestData() {
            const resultDiv = document.getElementById('setupResult');
            
            try {
                // Setup current user
                const testUser = {
                    id: 'admin-001',
                    nama: 'Test Administrator',
                    role: 'admin',
                    username: 'admin'
                };
                localStorage.setItem('currentUser', JSON.stringify(testUser));

                // Setup anggota with proper structure
                const testAnggota = [
                    {
                        id: 'anggota-001',
                        nik: '1234567890123456',
                        nama: 'Ahmad Budi',
                        status: 'Aktif',
                        statusKeanggotaan: 'Aktif',
                        departemen: 'IT',
                        tanggalDaftar: '2024-01-01'
                    },
                    {
                        id: 'anggota-002',
                        nik: '6543210987654321', 
                        nama: 'Siti Aminah',
                        status: 'Aktif',
                        statusKeanggotaan: 'Aktif',
                        departemen: 'Finance',
                        tanggalDaftar: '2024-01-15'
                    }
                ];
                localStorage.setItem('anggota', JSON.stringify(testAnggota));

                // Setup penjualan kredit
                const testPenjualan = [
                    {
                        id: 'penjualan-001',
                        anggotaId: 'anggota-001',
                        total: 250000,
                        metodePembayaran: 'Kredit',
                        status: 'kredit',
                        tanggal: '2024-01-20',
                        items: [
                            { nama: 'Beras 5kg', qty: 1, harga: 75000 },
                            { nama: 'Minyak Goreng 2L', qty: 2, harga: 87500 }
                        ]
                    },
                    {
                        id: 'penjualan-002',
                        anggotaId: 'anggota-002',
                        total: 180000,
                        metodePembayaran: 'Kredit', 
                        status: 'kredit',
                        tanggal: '2024-01-25',
                        items: [
                            { nama: 'Gula Pasir 1kg', qty: 3, harga: 60000 }
                        ]
                    }
                ];
                localStorage.setItem('penjualan', JSON.stringify(testPenjualan));

                // Setup empty required arrays
                localStorage.setItem('pembayaranHutangPiutang', JSON.stringify([]));
                localStorage.setItem('jurnal', JSON.stringify([]));
                localStorage.setItem('auditLog', JSON.stringify([]));
                localStorage.setItem('simpanan', JSON.stringify([]));
                localStorage.setItem('departemen', JSON.stringify([
                    { id: 'dept-001', nama: 'IT' },
                    { id: 'dept-002', nama: 'Finance' }
                ]));

                // Setup COA
                const coa = [
                    { kode: '1-1000', nama: 'Kas', tipe: 'Aset', saldo: 5000000 },
                    { kode: '2-1000', nama: 'Hutang Anggota', tipe: 'Kewajiban', saldo: 0 },
                    { kode: '1-1200', nama: 'Piutang Anggota', tipe: 'Aset', saldo: 0 }
                ];
                localStorage.setItem('coa', JSON.stringify(coa));

                resultDiv.innerHTML = '<div class="alert alert-success">✅ Test data berhasil di-setup!</div>';
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">❌ Error setup: ${error.message}</div>`;
            }
        }

        function testNavigation() {
            const resultDiv = document.getElementById('navigationResult');
            
            try {
                // Test if renderPage function exists
                if (typeof renderPage !== 'function') {
                    throw new Error('renderPage function not found');
                }

                // Test navigation to pembayaran-hutang-piutang
                renderPage('pembayaran-hutang-piutang');
                
                // Check if content was rendered
                const contentDiv = document.getElementById('content');
                if (contentDiv && contentDiv.innerHTML.trim() !== '') {
                    resultDiv.innerHTML = '<div class="alert alert-success">✅ Navigation berhasil! Pembayaran Hutang Piutang terbuka dengan baik.</div>';
                } else {
                    throw new Error('Content tidak ter-render setelah navigasi');
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">❌ Navigation gagal: ${error.message}</div>`;
            }
        }

        function testSaldoCalculation() {
            const resultDiv = document.getElementById('functionTestResults');
            
            try {
                // Test saldo hutang calculation
                const saldoHutang1 = hitungSaldoHutang('anggota-001');
                const saldoHutang2 = hitungSaldoHutang('anggota-002');
                
                let html = '<div class="alert alert-info"><h6>Hasil Test Saldo:</h6>';
                html += `<p><strong>Ahmad Budi:</strong> Saldo Hutang = ${formatRupiah(saldoHutang1)}</p>`;
                html += `<p><strong>Siti Aminah:</strong> Saldo Hutang = ${formatRupiah(saldoHutang2)}</p>`;
                html += '</div>';
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">❌ Test saldo gagal: ${error.message}</div>`;
            }
        }

        function testAnggotaSearch() {
            const resultDiv = document.getElementById('functionTestResults');
            
            try {
                // Test anggota search function
                const searchResults = searchAnggota('Ahmad');
                
                let html = '<div class="alert alert-info"><h6>Hasil Test Search:</h6>';
                html += `<p>Pencarian "Ahmad" menemukan ${searchResults.length} hasil:</p>`;
                searchResults.forEach(anggota => {
                    html += `<p>- ${anggota.nama} (${anggota.nik})</p>`;
                });
                html += '</div>';
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">❌ Test search gagal: ${error.message}</div>`;
            }
        }

        function testValidation() {
            const resultDiv = document.getElementById('functionTestResults');
            
            try {
                // Test validation function
                const validation = validateAnggotaForHutangPiutang('anggota-001');
                
                let html = '<div class="alert alert-info"><h6>Hasil Test Validation:</h6>';
                html += `<p><strong>Status:</strong> ${validation.valid ? 'Valid ✅' : 'Invalid ❌'}</p>`;
                if (!validation.valid) {
                    html += `<p><strong>Error:</strong> ${validation.error}</p>`;
                }
                html += '</div>';
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">❌ Test validation gagal: ${error.message}</div>`;
            }
        }

        // Auto-initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Auto setup test data
            setTimeout(() => {
                setupTestData();
                
                // Auto test navigation after setup
                setTimeout(() => {
                    testNavigation();
                }, 1000);
            }, 500);
        });
    </script>
</body>
</html>