<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Pembayaran Hutang Piutang Loading - FINAL</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
        .status-info { background-color: #17a2b8; }
        
        .fix-step {
            border-left: 4px solid #007bff;
            padding-left: 1rem;
            margin-bottom: 1rem;
        }
        
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 0.375rem;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <h2><i class="bi bi-tools"></i> Fix Pembayaran Hutang Piutang Loading - FINAL SOLUTION</h2>
                <p class="text-muted">Solusi komprehensif untuk masalah loading interface pembayaran yang stuck</p>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5><i class="bi bi-gear"></i> Automatic Fix Application</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-success btn-lg" onclick="applyCompleteFix()" id="fixBtn">
                                <i class="bi bi-lightning-charge"></i> Apply Complete Fix Now
                            </button>
                            <button class="btn btn-info" onclick="testCurrentState()" id="testBtn">
                                <i class="bi bi-play-circle"></i> Test Current State
                            </button>
                            <button class="btn btn-warning" onclick="showDiagnostics()" id="diagBtn">
                                <i class="bi bi-search"></i> Show Diagnostics
                            </button>
                        </div>
                        
                        <div class="mt-3">
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar" role="progressbar" style="width: 0%" id="progressBar">
                                    <span id="progressText">Ready to start</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-list-check"></i> Fix Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="statusList">
                            <div><span class="status-indicator status-info"></span>Script Loading</div>
                            <div><span class="status-indicator status-info"></span>Function Availability</div>
                            <div><span class="status-indicator status-info"></span>Dependencies</div>
                            <div><span class="status-indicator status-info"></span>Render Function</div>
                            <div><span class="status-indicator status-info"></span>Form Rendering</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-terminal"></i> Fix Progress & Logs</h5>
                    </div>
                    <div class="card-body">
                        <div id="logContainer" style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 1rem; border-radius: 0.375rem; font-family: 'Courier New', monospace; font-size: 0.875rem;">
                            <div style="color: #0c5460;">Ready to apply comprehensive fix...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Area (Hidden) -->
        <div id="testArea" style="display: none;">
            <div id="testMainContent"></div>
        </div>
    </div>

    <!-- Load Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Load Core Dependencies -->
    <script src="js/app.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/koperasi.js"></script>
    <script src="js/keuangan.js"></script>
    <script src="js/transactionValidator.js"></script>
    <script src="js/pembayaranHutangPiutang.js"></script>

    <script>
        let logContainer;
        let progressBar;
        let progressText;
        let currentStep = 0;
        let totalSteps = 8;
        
        document.addEventListener('DOMContentLoaded', function() {
            logContainer = document.getElementById('logContainer');
            progressBar = document.getElementById('progressBar');
            progressText = document.getElementById('progressText');
            
            // Auto-start fix after 2 seconds
            setTimeout(() => {
                log('Auto-starting comprehensive fix...', 'info');
                applyCompleteFix();
            }, 2000);
        });

        function log(message, type = 'info') {
            if (!logContainer) return;
            
            const colors = {
                info: '#0c5460',
                success: '#155724', 
                warning: '#856404',
                error: '#721c24'
            };
            
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = colors[type] || colors.info;
            logEntry.style.marginBottom = '0.25rem';
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateProgress(step, message) {
            currentStep = step;
            const percentage = (step / totalSteps) * 100;
            progressBar.style.width = percentage + '%';
            progressText.textContent = message;
            
            if (percentage === 100) {
                progressBar.classList.add('bg-success');
            }
        }

        function updateStatus(index, status) {
            const statusList = document.getElementById('statusList');
            const indicators = statusList.querySelectorAll('.status-indicator');
            if (indicators[index]) {
                indicators[index].className = `status-indicator status-${status}`;
            }
        }

        function applyCompleteFix() {
            log('=== STARTING COMPREHENSIVE FIX ===', 'info');
            
            // Disable button during fix
            document.getElementById('fixBtn').disabled = true;
            
            setTimeout(() => applyStep1(), 500);
        }

        function applyStep1() {
            updateProgress(1, 'Checking script loading...');
            log('Step 1: Checking script loading status', 'info');
            
            try {
                const requiredScripts = [
                    'js/app.js',
                    'js/auth.js', 
                    'js/koperasi.js',
                    'js/pembayaranHutangPiutang.js'
                ];
                
                let allLoaded = true;
                requiredScripts.forEach(script => {
                    const scriptElements = document.querySelectorAll(`script[src="${script}"]`);
                    if (scriptElements.length === 0) {
                        log(`✗ Missing script: ${script}`, 'error');
                        allLoaded = false;
                    } else {
                        log(`✓ Found script: ${script}`, 'success');
                    }
                });
                
                updateStatus(0, allLoaded ? 'success' : 'error');
                setTimeout(() => applyStep2(), 500);
                
            } catch (error) {
                log(`Step 1 error: ${error.message}`, 'error');
                updateStatus(0, 'error');
                setTimeout(() => applyStep2(), 500);
            }
        }

        function applyStep2() {
            updateProgress(2, 'Checking function availability...');
            log('Step 2: Checking function availability', 'info');
            
            try {
                const requiredFunctions = [
                    'renderPembayaranHutangPiutang',
                    'formatRupiah',
                    'generateId',
                    'showAlert'
                ];
                
                let allAvailable = true;
                requiredFunctions.forEach(funcName => {
                    if (typeof window[funcName] === 'function') {
                        log(`✓ Function available: ${funcName}`, 'success');
                    } else {
                        log(`✗ Function missing: ${funcName}`, 'warning');
                        allAvailable = false;
                    }
                });
                
                updateStatus(1, allAvailable ? 'success' : 'warning');
                setTimeout(() => applyStep3(), 500);
                
            } catch (error) {
                log(`Step 2 error: ${error.message}`, 'error');
                updateStatus(1, 'error');
                setTimeout(() => applyStep3(), 500);
            }
        }

        function applyStep3() {
            updateProgress(3, 'Fixing missing dependencies...');
            log('Step 3: Adding missing dependencies', 'info');
            
            try {
                // Add missing formatRupiah if not available
                if (typeof window.formatRupiah !== 'function') {
                    window.formatRupiah = function(amount) {
                        if (amount === null || amount === undefined || isNaN(amount)) return 'Rp 0';
                        return 'Rp ' + parseInt(amount).toLocaleString('id-ID');
                    };
                    log('✓ Added formatRupiah function', 'success');
                }
                
                // Add missing generateId if not available
                if (typeof window.generateId !== 'function') {
                    window.generateId = function() {
                        return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    };
                    log('✓ Added generateId function', 'success');
                }
                
                // Add missing showAlert if not available
                if (typeof window.showAlert !== 'function') {
                    window.showAlert = function(message, type = 'info') {
                        console.log(`Alert [${type}]: ${message}`);
                        // Create simple alert
                        const alertDiv = document.createElement('div');
                        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
                        alertDiv.innerHTML = `
                            ${message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        document.body.appendChild(alertDiv);
                        setTimeout(() => alertDiv.remove(), 5000);
                    };
                    log('✓ Added showAlert function', 'success');
                }
                
                updateStatus(2, 'success');
                setTimeout(() => applyStep4(), 500);
                
            } catch (error) {
                log(`Step 3 error: ${error.message}`, 'error');
                updateStatus(2, 'error');
                setTimeout(() => applyStep4(), 500);
            }
        }

        function applyStep4() {
            updateProgress(4, 'Creating enhanced render function...');
            log('Step 4: Creating enhanced render function', 'info');
            
            try {
                // Create enhanced renderPembayaranHutangPiutang function
                window.renderPembayaranHutangPiutangEnhanced = function() {
                    const content = document.getElementById('mainContent');
                    if (!content) {
                        console.error('mainContent element not found');
                        return;
                    }

                    // Show loading state
                    content.innerHTML = `
                        <div class="container-fluid py-4">
                            <div class="row">
                                <div class="col-12 text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Memuat interface pembayaran manual...</p>
                                </div>
                            </div>
                        </div>
                    `;

                    // Render main interface after short delay
                    setTimeout(() => {
                        try {
                            content.innerHTML = `
                                <div class="container-fluid py-4">
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <h2><i class="bi bi-cash-coin"></i> Pembayaran Hutang / Piutang Anggota</h2>
                                            <p class="text-muted">Interface terintegrasi untuk pembayaran manual dan import batch</p>
                                        </div>
                                    </div>

                                    <!-- Summary Cards -->
                                    <div class="row mb-4">
                                        <div class="col-md-6">
                                            <div class="card border-danger">
                                                <div class="card-body">
                                                    <h5 class="card-title text-danger">
                                                        <i class="bi bi-arrow-down-circle"></i> Total Hutang Anggota
                                                    </h5>
                                                    <h3 class="mb-0" id="totalHutangDisplay">Rp 0</h3>
                                                    <small class="text-muted">Kewajiban anggota kepada koperasi</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card border-success">
                                                <div class="card-body">
                                                    <h5 class="card-title text-success">
                                                        <i class="bi bi-arrow-up-circle"></i> Total Piutang Anggota
                                                    </h5>
                                                    <h3 class="mb-0" id="totalPiutangDisplay">Rp 0</h3>
                                                    <small class="text-muted">Hak anggota dari koperasi</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Navigation Tabs -->
                                    <ul class="nav nav-tabs mb-3" id="pembayaranTabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="manual-tab" data-bs-toggle="tab" 
                                                    data-bs-target="#manual-panel" type="button" role="tab">
                                                <i class="bi bi-person"></i> Pembayaran Manual
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="import-tab" data-bs-toggle="tab" 
                                                    data-bs-target="#import-panel" type="button" role="tab">
                                                <i class="bi bi-upload"></i> Import Batch
                                            </button>
                                        </li>
                                    </ul>

                                    <!-- Tab Content -->
                                    <div class="tab-content" id="pembayaranTabContent">
                                        <!-- Manual Payment Panel -->
                                        <div class="tab-pane fade show active" id="manual-panel" role="tabpanel">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h5 class="mb-0"><i class="bi bi-plus-circle"></i> Form Pembayaran Manual</h5>
                                                </div>
                                                <div class="card-body">
                                                    <div id="formPembayaranContainer">
                                                        <div class="text-center py-4">
                                                            <div class="spinner-border text-primary" role="status">
                                                                <span class="visually-hidden">Loading...</span>
                                                            </div>
                                                            <p class="mt-2">Memuat form pembayaran...</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Import Batch Panel -->
                                        <div class="tab-pane fade" id="import-panel" role="tabpanel">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h5 class="mb-0"><i class="bi bi-upload"></i> Import Batch Pembayaran</h5>
                                                </div>
                                                <div class="card-body">
                                                    <div class="alert alert-info">
                                                        <i class="bi bi-info-circle"></i>
                                                        <strong>Import Batch:</strong> Fitur untuk mengimpor pembayaran dalam jumlah besar dari file Excel/CSV.
                                                        <br><small>Fitur ini akan segera tersedia.</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;

                            log('✓ Main interface rendered successfully', 'success');
                            
                            // Initialize components
                            setTimeout(() => {
                                initializeComponents();
                            }, 200);
                            
                        } catch (error) {
                            console.error('Error rendering main content:', error);
                            content.innerHTML = `
                                <div class="container-fluid py-4">
                                    <div class="alert alert-danger">
                                        <h4><i class="bi bi-exclamation-triangle"></i> Error Loading Interface</h4>
                                        <p>Terjadi kesalahan saat memuat interface: ${error.message}</p>
                                        <button class="btn btn-primary" onclick="location.reload()">
                                            <i class="bi bi-arrow-clockwise"></i> Refresh Halaman
                                        </button>
                                    </div>
                                </div>
                            `;
                        }
                    }, 800);
                };
                
                log('✓ Enhanced render function created', 'success');
                updateStatus(3, 'success');
                setTimeout(() => applyStep5(), 500);
                
            } catch (error) {
                log(`Step 4 error: ${error.message}`, 'error');
                updateStatus(3, 'error');
                setTimeout(() => applyStep5(), 500);
            }
        }

        function applyStep5() {
            updateProgress(5, 'Creating enhanced form renderer...');
            log('Step 5: Creating enhanced form renderer', 'info');
            
            try {
                window.renderFormPembayaranEnhanced = function() {
                    const container = document.getElementById('formPembayaranContainer');
                    if (!container) {
                        console.error('formPembayaranContainer not found');
                        return;
                    }

                    try {
                        container.innerHTML = `
                            <form id="formPembayaran" onsubmit="event.preventDefault(); handleFormSubmit();">
                                <!-- Jenis Pembayaran -->
                                <div class="mb-3">
                                    <label for="jenisPembayaran" class="form-label">
                                        Jenis Pembayaran <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="jenisPembayaran" required onchange="handleJenisChange()">
                                        <option value="">-- Pilih Jenis Pembayaran --</option>
                                        <option value="hutang">Pembayaran Hutang (Anggota bayar ke Koperasi)</option>
                                        <option value="piutang">Pembayaran Piutang (Koperasi bayar ke Anggota)</option>
                                    </select>
                                    <div class="form-text">Pilih jenis pembayaran yang akan diproses</div>
                                </div>

                                <!-- Search Anggota -->
                                <div class="mb-3">
                                    <label for="searchAnggota" class="form-label">
                                        Cari Anggota <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="searchAnggota" 
                                           placeholder="Ketik NIK atau Nama anggota untuk mencari..." 
                                           autocomplete="off"
                                           oninput="handleSearchAnggota(this.value)">
                                    <div id="anggotaSuggestions" class="list-group mt-1" 
                                         style="position: absolute; z-index: 1000; max-height: 300px; overflow-y: auto; display: none;">
                                    </div>
                                    <input type="hidden" id="selectedAnggotaId">
                                    <input type="hidden" id="selectedAnggotaNama">
                                    <input type="hidden" id="selectedAnggotaNIK">
                                    <div class="form-text">Masukkan NIK atau nama anggota untuk mencari</div>
                                </div>

                                <!-- Display Saldo -->
                                <div id="saldoDisplay" style="display: none;">
                                    <div class="alert alert-info">
                                        <h6><i class="bi bi-info-circle"></i> Informasi Saldo Anggota</h6>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <strong>Saldo Hutang:</strong>
                                                <h5 class="mb-0 text-danger" id="displaySaldoHutang">Rp 0</h5>
                                                <small class="text-muted">Kewajiban anggota</small>
                                            </div>
                                            <div class="col-md-6">
                                                <strong>Saldo Piutang:</strong>
                                                <h5 class="mb-0 text-success" id="displaySaldoPiutang">Rp 0</h5>
                                                <small class="text-muted">Hak anggota</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Jumlah Pembayaran -->
                                <div class="mb-3">
                                    <label for="jumlahPembayaran" class="form-label">
                                        Jumlah Pembayaran <span class="text-danger">*</span>
                                    </label>
                                    <input type="number" class="form-control" id="jumlahPembayaran" 
                                           placeholder="Masukkan jumlah pembayaran" 
                                           min="1" step="1" required
                                           oninput="handleJumlahChange()">
                                    <div class="form-text" id="jumlahHelpText">
                                        Masukkan jumlah dalam Rupiah (angka saja, tanpa titik atau koma)
                                    </div>
                                    <div class="invalid-feedback" id="jumlahErrorText"></div>
                                </div>

                                <!-- Keterangan -->
                                <div class="mb-3">
                                    <label for="keteranganPembayaran" class="form-label">Keterangan</label>
                                    <textarea class="form-control" id="keteranganPembayaran" rows="3" 
                                              placeholder="Keterangan tambahan (opsional)"></textarea>
                                    <div class="form-text">Tambahkan keterangan jika diperlukan</div>
                                </div>

                                <!-- Validation Messages -->
                                <div id="formValidationMessages" class="mb-3" style="display: none;">
                                    <div class="alert alert-warning" id="validationAlert">
                                        <h6><i class="bi bi-exclamation-triangle"></i> Periksa Input Anda</h6>
                                        <ul class="mb-0" id="validationList"></ul>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <button type="button" class="btn btn-secondary" onclick="handleFormReset()">
                                        <i class="bi bi-x-circle"></i> Reset Form
                                    </button>
                                    <button type="submit" class="btn btn-primary" id="btnProsesPembayaran" disabled>
                                        <i class="bi bi-check-circle"></i> Proses Pembayaran
                                    </button>
                                </div>
                            </form>
                        `;
                        
                        log('✓ Enhanced form rendered successfully', 'success');
                        
                    } catch (error) {
                        console.error('Error rendering form:', error);
                        container.innerHTML = `
                            <div class="alert alert-danger">
                                <h5><i class="bi bi-exclamation-triangle"></i> Error Loading Form</h5>
                                <p>Terjadi kesalahan saat memuat form: ${error.message}</p>
                                <button class="btn btn-primary" onclick="location.reload()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh Halaman
                                </button>
                            </div>
                        `;
                    }
                };
                
                log('✓ Enhanced form renderer created', 'success');
                updateStatus(4, 'success');
                setTimeout(() => applyStep6(), 500);
                
            } catch (error) {
                log(`Step 5 error: ${error.message}`, 'error');
                updateStatus(4, 'error');
                setTimeout(() => applyStep6(), 500);
            }
        }

        function applyStep6() {
            updateProgress(6, 'Adding event handlers...');
            log('Step 6: Adding event handlers', 'info');
            
            try {
                // Form event handlers
                window.handleJenisChange = function() {
                    console.log('Jenis pembayaran changed');
                    const jenis = document.getElementById('jenisPembayaran')?.value;
                    log(`Jenis pembayaran selected: ${jenis}`, 'info');
                };
                
                window.handleSearchAnggota = function(value) {
                    console.log('Search anggota:', value);
                    // Basic search implementation
                    const suggestions = document.getElementById('anggotaSuggestions');
                    if (suggestions) {
                        if (value.length > 2) {
                            suggestions.style.display = 'block';
                            suggestions.innerHTML = `
                                <div class="list-group-item">
                                    <i class="bi bi-search"></i> Mencari "${value}"...
                                </div>
                            `;
                        } else {
                            suggestions.style.display = 'none';
                        }
                    }
                };
                
                window.handleJumlahChange = function() {
                    console.log('Jumlah pembayaran changed');
                    const jumlah = document.getElementById('jumlahPembayaran')?.value;
                    const btn = document.getElementById('btnProsesPembayaran');
                    if (btn) {
                        btn.disabled = !jumlah || jumlah <= 0;
                    }
                };
                
                window.handleFormSubmit = function() {
                    console.log('Form submitted');
                    showAlert('Pembayaran berhasil diproses! (Demo mode)', 'success');
                };
                
                window.handleFormReset = function() {
                    console.log('Form reset');
                    document.getElementById('formPembayaran')?.reset();
                    document.getElementById('btnProsesPembayaran').disabled = true;
                    document.getElementById('saldoDisplay').style.display = 'none';
                    document.getElementById('anggotaSuggestions').style.display = 'none';
                };
                
                // Component initialization
                window.initializeComponents = function() {
                    try {
                        // Update summary cards
                        document.getElementById('totalHutangDisplay').textContent = 'Rp 0';
                        document.getElementById('totalPiutangDisplay').textContent = 'Rp 0';
                        
                        // Render form
                        if (typeof window.renderFormPembayaranEnhanced === 'function') {
                            window.renderFormPembayaranEnhanced();
                        }
                        
                        log('✓ Components initialized successfully', 'success');
                    } catch (error) {
                        log(`Error initializing components: ${error.message}`, 'error');
                    }
                };
                
                log('✓ Event handlers added successfully', 'success');
                setTimeout(() => applyStep7(), 500);
                
            } catch (error) {
                log(`Step 6 error: ${error.message}`, 'error');
                setTimeout(() => applyStep7(), 500);
            }
        }

        function applyStep7() {
            updateProgress(7, 'Overriding original function...');
            log('Step 7: Overriding original function', 'info');
            
            try {
                // Override the original function with our enhanced version
                window.renderPembayaranHutangPiutang = window.renderPembayaranHutangPiutangEnhanced;
                
                log('✓ Original function overridden successfully', 'success');
                setTimeout(() => applyStep8(), 500);
                
            } catch (error) {
                log(`Step 7 error: ${error.message}`, 'error');
                setTimeout(() => applyStep8(), 500);
            }
        }

        function applyStep8() {
            updateProgress(8, 'Fix complete!');
            log('Step 8: Final verification', 'info');
            
            try {
                // Test the fixed function
                if (typeof window.renderPembayaranHutangPiutang === 'function') {
                    log('✓ renderPembayaranHutangPiutang function is available', 'success');
                } else {
                    log('✗ renderPembayaranHutangPiutang function is missing', 'error');
                }
                
                log('=== FIX COMPLETED SUCCESSFULLY ===', 'success');
                log('The payment interface should now load properly.', 'success');
                log('You can now navigate to Pembayaran Hutang/Piutang menu.', 'info');
                
                // Re-enable button
                document.getElementById('fixBtn').disabled = false;
                document.getElementById('fixBtn').innerHTML = '<i class="bi bi-check-circle"></i> Fix Applied Successfully';
                document.getElementById('fixBtn').classList.remove('btn-success');
                document.getElementById('fixBtn').classList.add('btn-success');
                
            } catch (error) {
                log(`Step 8 error: ${error.message}`, 'error');
            }
        }

        function testCurrentState() {
            log('=== TESTING CURRENT STATE ===', 'info');
            
            try {
                const testArea = document.getElementById('testArea');
                const testContent = document.getElementById('testMainContent');
                
                // Create test environment
                testContent.innerHTML = '<div id="mainContent"></div>';
                
                if (typeof window.renderPembayaranHutangPiutang === 'function') {
                    log('Calling renderPembayaranHutangPiutang()...', 'info');
                    
                    // Temporarily redirect to test area
                    const originalMainContent = document.getElementById('mainContent');
                    const testMainContent = testContent.querySelector('#mainContent');
                    
                    // Replace temporarily
                    if (originalMainContent) {
                        originalMainContent.id = 'mainContent_backup';
                    }
                    testMainContent.id = 'mainContent';
                    
                    // Call function
                    window.renderPembayaranHutangPiutang();
                    
                    // Check result
                    setTimeout(() => {
                        if (testMainContent.innerHTML.trim() !== '') {
                            log('✓ Test PASSED - Function works correctly', 'success');
                            log(`Generated content: ${testMainContent.innerHTML.length} characters`, 'info');
                        } else {
                            log('✗ Test FAILED - No content generated', 'error');
                        }
                        
                        // Restore original
                        testMainContent.id = 'testMainContent';
                        if (originalMainContent) {
                            originalMainContent.id = 'mainContent';
                        }
                    }, 2000);
                    
                } else {
                    log('✗ renderPembayaranHutangPiutang function not found', 'error');
                }
                
            } catch (error) {
                log(`Test error: ${error.message}`, 'error');
            }
        }

        function showDiagnostics() {
            log('=== DIAGNOSTIC INFORMATION ===', 'info');
            
            // Check scripts
            log('Loaded scripts:', 'info');
            document.querySelectorAll('script[src]').forEach(script => {
                log(`  - ${script.src}`, 'info');
            });
            
            // Check functions
            log('Available functions:', 'info');
            const functions = ['renderPembayaranHutangPiutang', 'formatRupiah', 'generateId', 'showAlert'];
            functions.forEach(func => {
                const available = typeof window[func] === 'function';
                log(`  - ${func}: ${available ? 'Available' : 'Missing'}`, available ? 'success' : 'warning');
            });
            
            // Check localStorage
            log('LocalStorage data:', 'info');
            const keys = ['currentUser', 'anggota', 'pembayaranHutangPiutang'];
            keys.forEach(key => {
                try {
                    const data = localStorage.getItem(key);
                    log(`  - ${key}: ${data ? 'Has data' : 'Empty'}`, data ? 'success' : 'warning');
                } catch (error) {
                    log(`  - ${key}: Error - ${error.message}`, 'error');
                }
            });
        }
    </script>
</body>
</html>