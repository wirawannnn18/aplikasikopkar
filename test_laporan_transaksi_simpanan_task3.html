<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Task 3: Filter and Search - Laporan Transaksi Simpanan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
        }
        .test-pass {
            background-color: #d1e7dd;
            color: #0f5132;
        }
        .test-fail {
            background-color: #f8d7da;
            color: #842029;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Test Task 3: Filter and Search Functionality</h1>
        
        <!-- Test Setup -->
        <div class="test-section">
            <h3>Test Setup</h3>
            <button class="btn btn-primary" onclick="setupTestData()">Setup Test Data</button>
            <button class="btn btn-danger" onclick="clearTestData()">Clear Test Data</button>
            <div id="setupResult" class="test-result" style="display: none;"></div>
        </div>
        
        <!-- Test 1: LaporanFilterManager Class -->
        <div class="test-section">
            <h3>Test 1: LaporanFilterManager Class</h3>
            <button class="btn btn-success" onclick="testFilterManagerClass()">Run Test</button>
            <div id="test1Result" class="test-result" style="display: none;"></div>
        </div>
        
        <!-- Test 2: Search Filter -->
        <div class="test-section">
            <h3>Test 2: Search Filter (NIK, Nama, No. Kartu)</h3>
            <button class="btn btn-success" onclick="testSearchFilter()">Run Test</button>
            <div id="test2Result" class="test-result" style="display: none;"></div>
        </div>
        
        <!-- Test 3: Departemen Filter -->
        <div class="test-section">
            <h3>Test 3: Departemen Filter</h3>
            <button class="btn btn-success" onclick="testDepartemenFilter()">Run Test</button>
            <div id="test3Result" class="test-result" style="display: none;"></div>
        </div>
        
        <!-- Test 4: Tipe Anggota Filter -->
        <div class="test-section">
            <h3>Test 4: Tipe Anggota Filter</h3>
            <button class="btn btn-success" onclick="testTipeAnggotaFilter()">Run Test</button>
            <div id="test4Result" class="test-result" style="display: none;"></div>
        </div>
        
        <!-- Test 5: Combined Filters -->
        <div class="test-section">
            <h3>Test 5: Combined Filters</h3>
            <button class="btn btn-success" onclick="testCombinedFilters()">Run Test</button>
            <div id="test5Result" class="test-result" style="display: none;"></div>
        </div>
        
        <!-- Test 6: Reset Filter -->
        <div class="test-section">
            <h3>Test 6: Reset Filter</h3>
            <button class="btn btn-success" onclick="testResetFilter()">Run Test</button>
            <div id="test6Result" class="test-result" style="display: none;"></div>
        </div>
        
        <!-- Test 7: Filter Count Display -->
        <div class="test-section">
            <h3>Test 7: Filter Count Display</h3>
            <button class="btn btn-success" onclick="testFilterCount()">Run Test</button>
            <div id="test7Result" class="test-result" style="display: none;"></div>
        </div>
        
        <!-- Test 8: UI Integration -->
        <div class="test-section">
            <h3>Test 8: UI Integration Test</h3>
            <p>This test will render the full report with filters</p>
            <button class="btn btn-success" onclick="testUIIntegration()">Run Test</button>
            <div id="test8Result" class="test-result" style="display: none;"></div>
            <div id="mainContent" class="mt-3"></div>
        </div>
    </div>

    <!-- Load Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Load App Scripts -->
    <script>
        // Mock functions
        function showAlert(message, type) {
            console.log(`[${type}] ${message}`);
        }
        
        function formatRupiah(amount) {
            if (!amount) return 'Rp 0';
            return 'Rp ' + amount.toLocaleString('id-ID');
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID');
        }
        
        function filterActiveAnggota(anggotaList) {
            return anggotaList.filter(a => a.statusKeanggotaan !== 'Keluar');
        }
    </script>
    
    <script src="js/laporanTransaksiSimpananAnggota.js"></script>
    
    <!-- Test Scripts -->
    <script>
        function setupTestData() {
            // Clear existing data
            localStorage.clear();
            
            // Create test anggota
            const anggota = [
                {
                    id: 'A001',
                    nik: '1234567890',
                    nama: 'Budi Santoso',
                    noKartu: 'K001',
                    departemen: 'IT',
                    tipeAnggota: 'Anggota',
                    statusKeanggotaan: 'Aktif'
                },
                {
                    id: 'A002',
                    nik: '0987654321',
                    nama: 'Siti Aminah',
                    noKartu: 'K002',
                    departemen: 'Finance',
                    tipeAnggota: 'Anggota',
                    statusKeanggotaan: 'Aktif'
                },
                {
                    id: 'A003',
                    nik: '1122334455',
                    nama: 'Ahmad Yani',
                    noKartu: 'K003',
                    departemen: 'IT',
                    tipeAnggota: 'Non-Anggota',
                    statusKeanggotaan: 'Aktif'
                },
                {
                    id: 'A004',
                    nik: '5544332211',
                    nama: 'Dewi Lestari',
                    noKartu: 'K004',
                    departemen: 'HR',
                    tipeAnggota: 'Anggota',
                    statusKeanggotaan: 'Aktif'
                },
                {
                    id: 'A005',
                    nik: '9988776655',
                    nama: 'Eko Prasetyo',
                    noKartu: 'K005',
                    departemen: 'Finance',
                    tipeAnggota: 'Umum',
                    statusKeanggotaan: 'Keluar'
                }
            ];
            
            // Create test transactions
            const penjualan = [
                { id: 'T001', anggotaId: 'A001', metode: 'cash', total: 100000, status: 'lunas' },
                { id: 'T002', anggotaId: 'A001', metode: 'bon', total: 200000, status: 'kredit' },
                { id: 'T003', anggotaId: 'A002', metode: 'cash', total: 150000, status: 'lunas' },
                { id: 'T004', anggotaId: 'A003', metode: 'bon', total: 300000, status: 'lunas' }
            ];
            
            // Create test simpanan
            const simpananPokok = [
                { id: 'SP001', anggotaId: 'A001', jumlah: 500000 },
                { id: 'SP002', anggotaId: 'A002', jumlah: 500000 },
                { id: 'SP003', anggotaId: 'A003', jumlah: 500000 }
            ];
            
            const simpananWajib = [
                { id: 'SW001', anggotaId: 'A001', jumlah: 100000 },
                { id: 'SW002', anggotaId: 'A002', jumlah: 100000 },
                { id: 'SW003', anggotaId: 'A004', jumlah: 100000 }
            ];
            
            const simpananSukarela = [
                { id: 'SS001', anggotaId: 'A001', jumlah: 200000 },
                { id: 'SS002', anggotaId: 'A002', jumlah: 300000 }
            ];
            
            // Save to localStorage
            localStorage.setItem('anggota', JSON.stringify(anggota));
            localStorage.setItem('penjualan', JSON.stringify(penjualan));
            localStorage.setItem('simpananPokok', JSON.stringify(simpananPokok));
            localStorage.setItem('simpananWajib', JSON.stringify(simpananWajib));
            localStorage.setItem('simpananSukarela', JSON.stringify(simpananSukarela));
            
            const result = document.getElementById('setupResult');
            result.style.display = 'block';
            result.className = 'test-result test-pass';
            result.innerHTML = `
                <strong>✓ Test data created successfully!</strong><br>
                - 5 anggota (4 aktif, 1 keluar)<br>
                - 4 transaksi<br>
                - Simpanan pokok, wajib, dan sukarela
            `;
        }
        
        function clearTestData() {
            localStorage.clear();
            const result = document.getElementById('setupResult');
            result.style.display = 'block';
            result.className = 'test-result test-pass';
            result.innerHTML = '<strong>✓ Test data cleared!</strong>';
        }
        
        function testFilterManagerClass() {
            const result = document.getElementById('test1Result');
            result.style.display = 'block';
            
            try {
                // Create test data
                const testData = [
                    { nik: '123', nama: 'Test 1', departemen: 'IT', tipeAnggota: 'Anggota' },
                    { nik: '456', nama: 'Test 2', departemen: 'Finance', tipeAnggota: 'Non-Anggota' }
                ];
                
                // Create filter manager
                const manager = new LaporanFilterManager();
                manager.setData(testData);
                
                // Test initial state
                if (manager.allData.length !== 2) throw new Error('Initial data not set correctly');
                if (manager.filteredData.length !== 2) throw new Error('Initial filtered data incorrect');
                
                // Test getUniqueDepartemen
                const depts = manager.getUniqueDepartemen();
                if (depts.length !== 2) throw new Error('Unique departemen count incorrect');
                if (!depts.includes('IT') || !depts.includes('Finance')) throw new Error('Departemen list incorrect');
                
                // Test getUniqueTipeAnggota
                const tipes = manager.getUniqueTipeAnggota();
                if (tipes.length !== 2) throw new Error('Unique tipe anggota count incorrect');
                
                result.className = 'test-result test-pass';
                result.innerHTML = '<strong>✓ PASS:</strong> LaporanFilterManager class works correctly';
            } catch (error) {
                result.className = 'test-result test-fail';
                result.innerHTML = `<strong>✗ FAIL:</strong> ${error.message}`;
            }
        }
        
        function testSearchFilter() {
            const result = document.getElementById('test2Result');
            result.style.display = 'block';
            
            try {
                const reportData = getAnggotaReportData();
                const manager = new LaporanFilterManager();
                manager.setData(reportData);
                
                // Test search by NIK
                manager.applySearch('1234567890');
                let filtered = manager.getFilteredData();
                if (filtered.length !== 1) throw new Error('Search by NIK failed');
                if (filtered[0].nama !== 'Budi Santoso') throw new Error('Wrong result for NIK search');
                
                // Test search by nama
                manager.applySearch('siti');
                filtered = manager.getFilteredData();
                if (filtered.length !== 1) throw new Error('Search by nama failed');
                if (filtered[0].nama !== 'Siti Aminah') throw new Error('Wrong result for nama search');
                
                // Test search by noKartu
                manager.applySearch('K003');
                filtered = manager.getFilteredData();
                if (filtered.length !== 1) throw new Error('Search by noKartu failed');
                if (filtered[0].nama !== 'Ahmad Yani') throw new Error('Wrong result for noKartu search');
                
                // Test partial search
                manager.applySearch('ahmad');
                filtered = manager.getFilteredData();
                if (filtered.length !== 1) throw new Error('Partial search failed');
                
                result.className = 'test-result test-pass';
                result.innerHTML = '<strong>✓ PASS:</strong> Search filter works correctly (NIK, nama, noKartu)';
            } catch (error) {
                result.className = 'test-result test-fail';
                result.innerHTML = `<strong>✗ FAIL:</strong> ${error.message}`;
            }
        }
        
        function testDepartemenFilter() {
            const result = document.getElementById('test3Result');
            result.style.display = 'block';
            
            try {
                const reportData = getAnggotaReportData();
                const manager = new LaporanFilterManager();
                manager.setData(reportData);
                
                // Test IT filter
                manager.applyDepartemenFilter('IT');
                let filtered = manager.getFilteredData();
                if (filtered.length !== 2) throw new Error('IT filter should return 2 members');
                if (!filtered.every(f => f.departemen === 'IT')) throw new Error('Filtered data contains non-IT members');
                
                // Test Finance filter
                manager.applyDepartemenFilter('Finance');
                filtered = manager.getFilteredData();
                if (filtered.length !== 1) throw new Error('Finance filter should return 1 member');
                if (filtered[0].departemen !== 'Finance') throw new Error('Wrong departemen in filtered data');
                
                // Test HR filter
                manager.applyDepartemenFilter('HR');
                filtered = manager.getFilteredData();
                if (filtered.length !== 1) throw new Error('HR filter should return 1 member');
                
                result.className = 'test-result test-pass';
                result.innerHTML = '<strong>✓ PASS:</strong> Departemen filter works correctly';
            } catch (error) {
                result.className = 'test-result test-fail';
                result.innerHTML = `<strong>✗ FAIL:</strong> ${error.message}`;
            }
        }
        
        function testTipeAnggotaFilter() {
            const result = document.getElementById('test4Result');
            result.style.display = 'block';
            
            try {
                const reportData = getAnggotaReportData();
                const manager = new LaporanFilterManager();
                manager.setData(reportData);
                
                // Test Anggota filter
                manager.applyTipeAnggotaFilter('Anggota');
                let filtered = manager.getFilteredData();
                if (filtered.length !== 3) throw new Error('Anggota filter should return 3 members');
                if (!filtered.every(f => f.tipeAnggota === 'Anggota')) throw new Error('Filtered data contains non-Anggota');
                
                // Test Non-Anggota filter
                manager.applyTipeAnggotaFilter('Non-Anggota');
                filtered = manager.getFilteredData();
                if (filtered.length !== 1) throw new Error('Non-Anggota filter should return 1 member');
                if (filtered[0].tipeAnggota !== 'Non-Anggota') throw new Error('Wrong tipe in filtered data');
                
                result.className = 'test-result test-pass';
                result.innerHTML = '<strong>✓ PASS:</strong> Tipe Anggota filter works correctly';
            } catch (error) {
                result.className = 'test-result test-fail';
                result.innerHTML = `<strong>✗ FAIL:</strong> ${error.message}`;
            }
        }
        
        function testCombinedFilters() {
            const result = document.getElementById('test5Result');
            result.style.display = 'block';
            
            try {
                const reportData = getAnggotaReportData();
                const manager = new LaporanFilterManager();
                manager.setData(reportData);
                
                // Test combined: IT + Anggota
                manager.applyDepartemenFilter('IT');
                manager.applyTipeAnggotaFilter('Anggota');
                let filtered = manager.getFilteredData();
                if (filtered.length !== 1) throw new Error('Combined filter IT+Anggota should return 1 member');
                if (filtered[0].nama !== 'Budi Santoso') throw new Error('Wrong result for combined filter');
                
                // Test combined: Finance + search
                manager.resetFilters();
                manager.applyDepartemenFilter('Finance');
                manager.applySearch('siti');
                filtered = manager.getFilteredData();
                if (filtered.length !== 1) throw new Error('Combined filter Finance+search should return 1 member');
                if (filtered[0].nama !== 'Siti Aminah') throw new Error('Wrong result for Finance+search');
                
                result.className = 'test-result test-pass';
                result.innerHTML = '<strong>✓ PASS:</strong> Combined filters work correctly';
            } catch (error) {
                result.className = 'test-result test-fail';
                result.innerHTML = `<strong>✗ FAIL:</strong> ${error.message}`;
            }
        }
        
        function testResetFilter() {
            const result = document.getElementById('test6Result');
            result.style.display = 'block';
            
            try {
                const reportData = getAnggotaReportData();
                const manager = new LaporanFilterManager();
                manager.setData(reportData);
                
                // Apply some filters
                manager.applySearch('test');
                manager.applyDepartemenFilter('IT');
                manager.applyTipeAnggotaFilter('Anggota');
                
                // Reset
                manager.resetFilters();
                
                // Check if all filters are cleared
                if (manager.filters.search !== '') throw new Error('Search filter not reset');
                if (manager.filters.departemen !== '') throw new Error('Departemen filter not reset');
                if (manager.filters.tipeAnggota !== '') throw new Error('Tipe filter not reset');
                
                // Check if data is restored
                const filtered = manager.getFilteredData();
                if (filtered.length !== reportData.length) throw new Error('Data not restored after reset');
                
                result.className = 'test-result test-pass';
                result.innerHTML = '<strong>✓ PASS:</strong> Reset filter works correctly';
            } catch (error) {
                result.className = 'test-result test-fail';
                result.innerHTML = `<strong>✗ FAIL:</strong> ${error.message}`;
            }
        }
        
        function testFilterCount() {
            const result = document.getElementById('test7Result');
            result.style.display = 'block';
            
            try {
                const reportData = getAnggotaReportData();
                const manager = new LaporanFilterManager();
                manager.setData(reportData);
                
                // Test initial count
                let count = manager.getFilterCount();
                if (count.total !== 4) throw new Error('Total count should be 4 (excluding keluar)');
                if (count.filtered !== 4) throw new Error('Initial filtered count should equal total');
                
                // Apply filter and test count
                manager.applyDepartemenFilter('IT');
                count = manager.getFilterCount();
                if (count.total !== 4) throw new Error('Total count should remain 4');
                if (count.filtered !== 2) throw new Error('Filtered count should be 2 for IT');
                
                result.className = 'test-result test-pass';
                result.innerHTML = '<strong>✓ PASS:</strong> Filter count display works correctly';
            } catch (error) {
                result.className = 'test-result test-fail';
                result.innerHTML = `<strong>✗ FAIL:</strong> ${error.message}`;
            }
        }
        
        function testUIIntegration() {
            const result = document.getElementById('test8Result');
            result.style.display = 'block';
            
            try {
                // Render the report
                renderLaporanTransaksiSimpananAnggota();
                
                // Check if filter UI elements exist
                const searchInput = document.getElementById('searchLaporan');
                const departemenSelect = document.getElementById('filterDepartemen');
                const tipeSelect = document.getElementById('filterTipeAnggota');
                const filterCountInfo = document.getElementById('filterCountInfo');
                
                if (!searchInput) throw new Error('Search input not found');
                if (!departemenSelect) throw new Error('Departemen select not found');
                if (!tipeSelect) throw new Error('Tipe select not found');
                if (!filterCountInfo) throw new Error('Filter count info not found');
                
                // Check if options are populated
                if (departemenSelect.options.length < 2) throw new Error('Departemen options not populated');
                if (tipeSelect.options.length < 2) throw new Error('Tipe options not populated');
                
                // Test search functionality
                searchInput.value = 'budi';
                handleSearchLaporan('budi');
                
                // Check if table updated
                const tbody = document.getElementById('tbodyLaporanAnggota');
                if (!tbody) throw new Error('Table body not found');
                
                const rows = tbody.querySelectorAll('tr');
                if (rows.length !== 1) throw new Error('Search filter did not update table correctly');
                
                // Test reset
                handleResetFilter();
                const rowsAfterReset = tbody.querySelectorAll('tr');
                if (rowsAfterReset.length !== 4) throw new Error('Reset did not restore all rows');
                
                result.className = 'test-result test-pass';
                result.innerHTML = '<strong>✓ PASS:</strong> UI integration works correctly. Check the rendered report below.';
            } catch (error) {
                result.className = 'test-result test-fail';
                result.innerHTML = `<strong>✗ FAIL:</strong> ${error.message}`;
            }
        }
    </script>
</body>
</html>
