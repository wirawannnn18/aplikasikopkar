<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Simpanan Anggota Keluar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .debug-section { margin-bottom: 30px; }
        .badge-custom { font-size: 0.9rem; padding: 5px 10px; }
        pre { background: #f5f5f5; padding: 15px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="mb-4">üîç Debug - Simpanan Anggota Keluar</h2>
        
        <div class="alert alert-info">
            <strong>Tujuan:</strong> Memeriksa apakah ada anggota keluar yang simpanannya belum di-zero-kan
        </div>
        
        <div class="debug-section">
            <h4>1. Anggota dengan Status Keluar</h4>
            <div id="anggotaKeluarList"></div>
        </div>
        
        <div class="debug-section">
            <h4>2. Simpanan Pokok Anggota Keluar (yang belum zero)</h4>
            <div id="simpananPokokList"></div>
        </div>
        
        <div class="debug-section">
            <h4>3. Simpanan Wajib Anggota Keluar (yang belum zero)</h4>
            <div id="simpananWajibList"></div>
        </div>
        
        <div class="debug-section">
            <h4>4. Simpanan Sukarela Anggota Keluar (yang belum zero)</h4>
            <div id="simpananSukarelaList"></div>
        </div>
        
        <div class="debug-section">
            <h4>5. Rekomendasi Perbaikan</h4>
            <div id="recommendations"></div>
        </div>
        
        <div class="mt-4">
            <button class="btn btn-primary" onclick="runDebug()">üîÑ Refresh Debug</button>
            <button class="btn btn-success" onclick="fixAllSimpanan()">‚úÖ Perbaiki Semua Simpanan</button>
        </div>
    </div>

    <script>
        function runDebug() {
            const anggota = JSON.parse(localStorage.getItem('anggota') || '[]');
            const simpananPokok = JSON.parse(localStorage.getItem('simpananPokok') || '[]');
            const simpananWajib = JSON.parse(localStorage.getItem('simpananWajib') || '[]');
            const simpananSukarela = JSON.parse(localStorage.getItem('simpananSukarela') || '[]');
            
            // 1. Find anggota keluar
            const anggotaKeluar = anggota.filter(a => a.statusKeanggotaan === 'Keluar');
            
            let html1 = '<div class="table-responsive"><table class="table table-bordered">';
            html1 += '<thead><tr><th>NIK</th><th>Nama</th><th>Status Pengembalian</th><th>Tanggal Keluar</th></tr></thead><tbody>';
            
            if (anggotaKeluar.length === 0) {
                html1 += '<tr><td colspan="4" class="text-center">Tidak ada anggota keluar</td></tr>';
            } else {
                anggotaKeluar.forEach(a => {
                    const statusBadge = a.pengembalianStatus === 'Selesai' ? 
                        '<span class="badge bg-success">Selesai</span>' : 
                        '<span class="badge bg-warning">Pending</span>';
                    html1 += `<tr>
                        <td>${a.nik}</td>
                        <td>${a.nama}</td>
                        <td>${statusBadge}</td>
                        <td>${a.tanggalKeluar || '-'}</td>
                    </tr>`;
                });
            }
            html1 += '</tbody></table></div>';
            html1 += `<p class="mt-2"><strong>Total: ${anggotaKeluar.length} anggota keluar</strong></p>`;
            document.getElementById('anggotaKeluarList').innerHTML = html1;
            
            // 2. Find simpanan pokok with balance > 0 for anggota keluar
            const anggotaKeluarIds = anggotaKeluar.map(a => a.id);
            const simpananPokokKeluar = simpananPokok.filter(s => 
                anggotaKeluarIds.includes(s.anggotaId) && s.jumlah > 0
            );
            
            let html2 = '<div class="table-responsive"><table class="table table-bordered">';
            html2 += '<thead><tr><th>Anggota</th><th>Jumlah</th><th>Status Pengembalian</th></tr></thead><tbody>';
            
            if (simpananPokokKeluar.length === 0) {
                html2 += '<tr><td colspan="3" class="text-center text-success">‚úÖ Semua simpanan pokok sudah di-zero-kan</td></tr>';
            } else {
                simpananPokokKeluar.forEach(s => {
                    const ang = anggota.find(a => a.id === s.anggotaId);
                    html2 += `<tr class="table-danger">
                        <td>${ang?.nama || '-'} (${ang?.nik || '-'})</td>
                        <td>Rp ${s.jumlah.toLocaleString('id-ID')}</td>
                        <td>${s.statusPengembalian || 'Aktif'}</td>
                    </tr>`;
                });
            }
            html2 += '</tbody></table></div>';
            html2 += `<p class="mt-2"><strong>Total: ${simpananPokokKeluar.length} record yang perlu di-zero-kan</strong></p>`;
            document.getElementById('simpananPokokList').innerHTML = html2;
            
            // 3. Find simpanan wajib with balance > 0 for anggota keluar
            const simpananWajibKeluar = simpananWajib.filter(s => 
                anggotaKeluarIds.includes(s.anggotaId) && s.jumlah > 0
            );
            
            let html3 = '<div class="table-responsive"><table class="table table-bordered">';
            html3 += '<thead><tr><th>Anggota</th><th>Jumlah</th><th>Periode</th><th>Status Pengembalian</th></tr></thead><tbody>';
            
            if (simpananWajibKeluar.length === 0) {
                html3 += '<tr><td colspan="4" class="text-center text-success">‚úÖ Semua simpanan wajib sudah di-zero-kan</td></tr>';
            } else {
                simpananWajibKeluar.forEach(s => {
                    const ang = anggota.find(a => a.id === s.anggotaId);
                    html3 += `<tr class="table-danger">
                        <td>${ang?.nama || '-'} (${ang?.nik || '-'})</td>
                        <td>Rp ${s.jumlah.toLocaleString('id-ID')}</td>
                        <td>${s.periode || '-'}</td>
                        <td>${s.statusPengembalian || 'Aktif'}</td>
                    </tr>`;
                });
            }
            html3 += '</tbody></table></div>';
            html3 += `<p class="mt-2"><strong>Total: ${simpananWajibKeluar.length} record yang perlu di-zero-kan</strong></p>`;
            document.getElementById('simpananWajibList').innerHTML = html3;
            
            // 4. Find simpanan sukarela with balance > 0 for anggota keluar
            const simpananSukarelaKeluar = simpananSukarela.filter(s => 
                anggotaKeluarIds.includes(s.anggotaId) && s.jumlah > 0
            );
            
            let html4 = '<div class="table-responsive"><table class="table table-bordered">';
            html4 += '<thead><tr><th>Anggota</th><th>Jumlah</th><th>Status Pengembalian</th></tr></thead><tbody>';
            
            if (simpananSukarelaKeluar.length === 0) {
                html4 += '<tr><td colspan="3" class="text-center text-success">‚úÖ Semua simpanan sukarela sudah di-zero-kan</td></tr>';
            } else {
                simpananSukarelaKeluar.forEach(s => {
                    const ang = anggota.find(a => a.id === s.anggotaId);
                    html4 += `<tr class="table-danger">
                        <td>${ang?.nama || '-'} (${ang?.nik || '-'})</td>
                        <td>Rp ${s.jumlah.toLocaleString('id-ID')}</td>
                        <td>${s.statusPengembalian || 'Aktif'}</td>
                    </tr>`;
                });
            }
            html4 += '</tbody></table></div>';
            html4 += `<p class="mt-2"><strong>Total: ${simpananSukarelaKeluar.length} record yang perlu di-zero-kan</strong></p>`;
            document.getElementById('simpananSukarelaList').innerHTML = html4;
            
            // 5. Recommendations
            const totalIssues = simpananPokokKeluar.length + simpananWajibKeluar.length + simpananSukarelaKeluar.length;
            
            let html5 = '';
            if (totalIssues === 0) {
                html5 = '<div class="alert alert-success"><strong>‚úÖ Sempurna!</strong> Semua simpanan anggota keluar sudah di-zero-kan dengan benar.</div>';
            } else {
                html5 = `<div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Ditemukan ${totalIssues} record simpanan yang belum di-zero-kan</strong>
                    <ul class="mt-2 mb-0">
                        <li>Simpanan Pokok: ${simpananPokokKeluar.length} record</li>
                        <li>Simpanan Wajib: ${simpananWajibKeluar.length} record</li>
                        <li>Simpanan Sukarela: ${simpananSukarelaKeluar.length} record</li>
                    </ul>
                    <hr>
                    <p class="mb-0"><strong>Solusi:</strong> Klik tombol "Perbaiki Semua Simpanan" di bawah untuk meng-zero-kan semua simpanan anggota keluar.</p>
                </div>`;
            }
            document.getElementById('recommendations').innerHTML = html5;
        }
        
        function fixAllSimpanan() {
            if (!confirm('Apakah Anda yakin ingin meng-zero-kan semua simpanan anggota keluar?\n\nData saldo lama akan disimpan di field saldoSebelumPengembalian.')) {
                return;
            }
            
            const anggota = JSON.parse(localStorage.getItem('anggota') || '[]');
            const anggotaKeluarIds = anggota.filter(a => a.statusKeanggotaan === 'Keluar').map(a => a.id);
            
            // Fix simpanan pokok
            const simpananPokok = JSON.parse(localStorage.getItem('simpananPokok') || '[]');
            const fixedSimpananPokok = simpananPokok.map(s => {
                if (anggotaKeluarIds.includes(s.anggotaId) && s.jumlah > 0) {
                    return {
                        ...s,
                        saldoSebelumPengembalian: s.saldoSebelumPengembalian || s.jumlah,
                        jumlah: 0,
                        statusPengembalian: 'Dikembalikan',
                        tanggalPengembalian: s.tanggalPengembalian || new Date().toISOString().split('T')[0]
                    };
                }
                return s;
            });
            localStorage.setItem('simpananPokok', JSON.stringify(fixedSimpananPokok));
            
            // Fix simpanan wajib
            const simpananWajib = JSON.parse(localStorage.getItem('simpananWajib') || '[]');
            const fixedSimpananWajib = simpananWajib.map(s => {
                if (anggotaKeluarIds.includes(s.anggotaId) && s.jumlah > 0) {
                    return {
                        ...s,
                        saldoSebelumPengembalian: s.saldoSebelumPengembalian || s.jumlah,
                        jumlah: 0,
                        statusPengembalian: 'Dikembalikan',
                        tanggalPengembalian: s.tanggalPengembalian || new Date().toISOString().split('T')[0]
                    };
                }
                return s;
            });
            localStorage.setItem('simpananWajib', JSON.stringify(fixedSimpananWajib));
            
            // Fix simpanan sukarela
            const simpananSukarela = JSON.parse(localStorage.getItem('simpananSukarela') || '[]');
            const fixedSimpananSukarela = simpananSukarela.map(s => {
                if (anggotaKeluarIds.includes(s.anggotaId) && s.jumlah > 0) {
                    return {
                        ...s,
                        saldoSebelumPengembalian: s.saldoSebelumPengembalian || s.jumlah,
                        jumlah: 0,
                        statusPengembalian: 'Dikembalikan',
                        tanggalPengembalian: s.tanggalPengembalian || new Date().toISOString().split('T')[0]
                    };
                }
                return s;
            });
            localStorage.setItem('simpananSukarela', JSON.stringify(fixedSimpananSukarela));
            
            alert('‚úÖ Berhasil! Semua simpanan anggota keluar sudah di-zero-kan.');
            runDebug();
        }
        
        // Run debug on page load
        window.onload = runDebug;
    </script>
</body>
</html>
