<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Koneksi Transformasi Barang</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .test-card {
            border-left: 4px solid #007bff;
            transition: all 0.3s ease;
        }
        .test-card.success {
            border-left-color: #28a745;
            background-color: #f8fff9;
        }
        .test-card.error {
            border-left-color: #dc3545;
            background-color: #fff5f5;
        }
        .test-result {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            background: #f8f9fa;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
        }
        .transformation-preview {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }
        .arrow {
            font-size: 2rem;
            color: #007bff;
            text-align: center;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2><i class="bi bi-check-circle me-2"></i>Test Koneksi Transformasi Barang</h2>
                        <p class="text-muted mb-0">Menguji koneksi antara master barang dan sistem transformasi</p>
                    </div>
                    <div>
                        <button class="btn btn-outline-primary" onclick="runAllTests()">
                            <i class="bi bi-play-fill me-1"></i>Run All Tests
                        </button>
                        <button class="btn btn-outline-secondary ms-2" onclick="window.location.reload()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                        </button>
                    </div>
                </div>

                <!-- Test Results -->
                <div class="row">
                    <div class="col-lg-8">
                        <!-- System Tests -->
                        <div class="card test-card mb-4" id="systemTestCard">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-gear me-2"></i>System Component Tests
                                    <span class="badge bg-secondary ms-2" id="systemTestStatus">Not Run</span>
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="systemTestResults">
                                    <p class="text-muted">Klik "Run All Tests" untuk memulai pengujian sistem.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Data Tests -->
                        <div class="card test-card mb-4" id="dataTestCard">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-database me-2"></i>Data Integrity Tests
                                    <span class="badge bg-secondary ms-2" id="dataTestStatus">Not Run</span>
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="dataTestResults">
                                    <p class="text-muted">Pengujian integritas data akan dimulai setelah system tests.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Transformation Tests -->
                        <div class="card test-card mb-4" id="transformationTestCard">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-arrow-left-right me-2"></i>Transformation Tests
                                    <span class="badge bg-secondary ms-2" id="transformationTestStatus">Not Run</span>
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="transformationTestResults">
                                    <p class="text-muted">Pengujian transformasi akan dimulai setelah data tests.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <!-- Live Transformation Demo -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-play-circle me-2"></i>Live Demo</h6>
                            </div>
                            <div class="card-body">
                                <div id="demoSection">
                                    <p class="text-muted small">Demo akan tersedia setelah semua tests berhasil.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Test Summary -->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-clipboard-check me-2"></i>Test Summary</h6>
                            </div>
                            <div class="card-body">
                                <div id="testSummary">
                                    <div class="text-center text-muted">
                                        <i class="bi bi-hourglass-split display-6"></i>
                                        <p class="mt-2">Waiting for tests...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/koperasi.js"></script>
    
    <!-- Transformasi Barang Modules -->
    <script src="js/transformasi-barang/types.js"></script>
    <script src="js/transformasi-barang/DataModels.js"></script>
    <script src="js/transformasi-barang/ValidationEngine.js"></script>
    <script src="js/transformasi-barang/ConversionCalculator.js"></script>
    <script src="js/transformasi-barang/StockManager.js"></script>
    <script src="js/transformasi-barang/AuditLogger.js"></script>
    <script src="js/transformasi-barang/TransformationManager.js"></script>
    
    <!-- Integration Module -->
    <script src="js/masterBarangIntegration.js"></script>

    <script>
        let testResults = {
            system: { passed: 0, failed: 0, tests: [] },
            data: { passed: 0, failed: 0, tests: [] },
            transformation: { passed: 0, failed: 0, tests: [] }
        };

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-run tests after a short delay
            setTimeout(() => {
                runAllTests();
            }, 1000);
        });

        /**
         * Run all tests
         */
        async function runAllTests() {
            try {
                // Reset results
                testResults = {
                    system: { passed: 0, failed: 0, tests: [] },
                    data: { passed: 0, failed: 0, tests: [] },
                    transformation: { passed: 0, failed: 0, tests: [] }
                };

                // Run system tests
                await runSystemTests();
                
                // Run data tests
                await runDataTests();
                
                // Run transformation tests
                await runTransformationTests();
                
                // Update summary
                updateTestSummary();
                
                // Setup demo if all tests pass
                if (allTestsPassed()) {
                    setupLiveDemo();
                }

            } catch (error) {
                console.error('Error running tests:', error);
                showError('Error running tests: ' + error.message);
            }
        }

        /**
         * Run system component tests
         */
        async function runSystemTests() {
            updateTestStatus('systemTestStatus', 'Running', 'warning');
            const results = [];

            // Test 1: Check if classes are loaded
            const test1 = await runTest('Class Loading', () => {
                const classes = [
                    'TransformationManager',
                    'StockManager', 
                    'ValidationEngine',
                    'ConversionCalculator',
                    'AuditLogger',
                    'MasterBarangIntegration'
                ];
                
                const missing = classes.filter(cls => typeof window[cls] === 'undefined');
                if (missing.length > 0) {
                    throw new Error(`Missing classes: ${missing.join(', ')}`);
                }
                
                return `All ${classes.length} classes loaded successfully`;
            });
            results.push(test1);

            // Test 2: Initialize components
            const test2 = await runTest('Component Initialization', async () => {
                // Initialize components
                window.stockManager = new StockManager();
                window.validationEngine = new ValidationEngine();
                window.calculator = new ConversionCalculator();
                window.auditLogger = new AuditLogger();
                window.transformationManager = new TransformationManager();

                // Initialize each component
                window.stockManager.initialize();
                window.validationEngine.initialize();
                window.calculator.initialize();
                window.auditLogger.initialize();

                // Initialize transformation manager
                window.transformationManager.initialize({
                    validationEngine: window.validationEngine,
                    calculator: window.calculator,
                    stockManager: window.stockManager,
                    auditLogger: window.auditLogger
                });

                return 'All components initialized successfully';
            });
            results.push(test2);

            // Test 3: Integration system
            const test3 = await runTest('Integration System', async () => {
                if (!window.masterBarangIntegration) {
                    window.masterBarangIntegration = new MasterBarangIntegration();
                }

                // Wait for initialization
                let attempts = 0;
                while (!window.masterBarangIntegration.initialized && attempts < 20) {
                    await new Promise(resolve => setTimeout(resolve, 250));
                    attempts++;
                }

                if (!window.masterBarangIntegration.initialized) {
                    throw new Error('Integration system failed to initialize');
                }

                return 'Integration system initialized successfully';
            });
            results.push(test3);

            // Update results
            testResults.system = calculateTestResults(results);
            displayTestResults('systemTestResults', results);
            updateTestStatus('systemTestStatus', 
                testResults.system.failed === 0 ? 'Passed' : 'Failed',
                testResults.system.failed === 0 ? 'success' : 'danger'
            );
            updateCardStatus('systemTestCard', testResults.system.failed === 0);
        }

        /**
         * Run data integrity tests
         */
        async function runDataTests() {
            updateTestStatus('dataTestStatus', 'Running', 'warning');
            const results = [];

            // Test 1: Master Barang data
            const test1 = await runTest('Master Barang Data', () => {
                const masterBarang = JSON.parse(localStorage.getItem('masterBarang') || '[]');
                
                if (masterBarang.length === 0) {
                    throw new Error('No master barang data found');
                }

                const withBaseProduct = masterBarang.filter(item => item.baseProduct).length;
                const withStock = masterBarang.filter(item => item.stok > 0).length;

                return `${masterBarang.length} items total, ${withBaseProduct} with baseProduct, ${withStock} with stock`;
            });
            results.push(test1);

            // Test 2: Conversion ratios
            const test2 = await runTest('Conversion Ratios', () => {
                const ratios = JSON.parse(localStorage.getItem('conversionRatios') || '[]');
                
                if (ratios.length === 0) {
                    throw new Error('No conversion ratios found');
                }

                const totalConversions = ratios.reduce((sum, ratio) => 
                    sum + (ratio.conversions ? ratio.conversions.length : 0), 0
                );

                return `${ratios.length} ratio groups, ${totalConversions} total conversions`;
            });
            results.push(test2);

            // Test 3: Data consistency
            const test3 = await runTest('Data Consistency', () => {
                const masterBarang = JSON.parse(localStorage.getItem('masterBarang') || '[]');
                const ratios = JSON.parse(localStorage.getItem('conversionRatios') || '[]');
                
                // Check if items with same baseProduct exist
                const baseProducts = new Map();
                masterBarang.forEach(item => {
                    const baseProduct = item.baseProduct || item.kode.split('-')[0];
                    if (!baseProducts.has(baseProduct)) {
                        baseProducts.set(baseProduct, []);
                    }
                    baseProducts.get(baseProduct).push(item);
                });

                const transformableGroups = Array.from(baseProducts.entries())
                    .filter(([_, items]) => items.length > 1).length;

                const ratioGroups = ratios.length;

                return `${transformableGroups} transformable groups, ${ratioGroups} ratio groups`;
            });
            results.push(test3);

            // Update results
            testResults.data = calculateTestResults(results);
            displayTestResults('dataTestResults', results);
            updateTestStatus('dataTestStatus', 
                testResults.data.failed === 0 ? 'Passed' : 'Failed',
                testResults.data.failed === 0 ? 'success' : 'danger'
            );
            updateCardStatus('dataTestCard', testResults.data.failed === 0);
        }

        /**
         * Run transformation tests
         */
        async function runTransformationTests() {
            updateTestStatus('transformationTestStatus', 'Running', 'warning');
            const results = [];

            // Test 1: Get transformable items
            const test1 = await runTest('Get Transformable Items', async () => {
                const transformableItems = await window.transformationManager.getTransformableItems();
                
                if (transformableItems.length === 0) {
                    throw new Error('No transformable items found');
                }

                const totalItems = transformableItems.reduce((sum, group) => sum + group.items.length, 0);
                return `${transformableItems.length} groups, ${totalItems} total items`;
            });
            results.push(test1);

            // Test 2: Validation system
            const test2 = await runTest('Validation System', async () => {
                const transformableItems = await window.transformationManager.getTransformableItems();
                
                if (transformableItems.length === 0) {
                    throw new Error('No transformable items for validation test');
                }

                const group = transformableItems[0];
                if (group.items.length < 2) {
                    throw new Error('Not enough items in group for validation test');
                }

                const sourceItem = group.items[0];
                const targetItem = group.items[1];
                
                // Test validation with valid data
                const validResult = await window.transformationManager.validateTransformation(
                    sourceItem.id, targetItem.id, 1
                );

                if (!validResult.hasOwnProperty('isValid')) {
                    throw new Error('Validation result missing isValid property');
                }

                return `Validation system working, result: ${validResult.isValid ? 'valid' : 'invalid'}`;
            });
            results.push(test2);

            // Test 3: Preview system
            const test3 = await runTest('Preview System', async () => {
                const transformableItems = await window.transformationManager.getTransformableItems();
                
                if (transformableItems.length === 0) {
                    throw new Error('No transformable items for preview test');
                }

                const group = transformableItems[0];
                if (group.items.length < 2) {
                    throw new Error('Not enough items in group for preview test');
                }

                const sourceItem = group.items[0];
                const targetItem = group.items[1];
                
                const preview = await window.transformationManager.getTransformationPreview(
                    sourceItem.id, targetItem.id, 1
                );

                if (!preview.sourceItem || !preview.targetItem) {
                    throw new Error('Preview missing source or target item');
                }

                return `Preview generated: ${preview.sourceItem.name} → ${preview.targetItem.name}`;
            });
            results.push(test3);

            // Test 4: Stock manager integration
            const test4 = await runTest('Stock Manager Integration', async () => {
                const masterBarang = JSON.parse(localStorage.getItem('masterBarang') || '[]');
                
                if (masterBarang.length === 0) {
                    throw new Error('No master barang data for stock test');
                }

                const item = masterBarang[0];
                const originalStock = await window.stockManager.getStockBalance(item.kode);
                
                if (originalStock !== item.stok) {
                    throw new Error(`Stock mismatch: expected ${item.stok}, got ${originalStock}`);
                }

                return `Stock manager correctly reports ${originalStock} for ${item.kode}`;
            });
            results.push(test4);

            // Test 5: Integration system
            const test5 = await runTest('Integration System', async () => {
                const transformableItems = await window.masterBarangIntegration.getTransformableItemsForUI();
                
                if (transformableItems.length === 0) {
                    throw new Error('Integration system returns no transformable items');
                }

                const group = transformableItems[0];
                if (group.items.length < 2) {
                    throw new Error('Integration system: not enough items in group');
                }

                const sourceItem = group.items[0];
                const targetItem = group.items[1];
                
                const isAvailable = window.masterBarangIntegration.isTransformationAvailable(
                    sourceItem.id, targetItem.id
                );

                return `Integration system working, transformation ${isAvailable ? 'available' : 'not available'}`;
            });
            results.push(test5);

            // Update results
            testResults.transformation = calculateTestResults(results);
            displayTestResults('transformationTestResults', results);
            updateTestStatus('transformationTestStatus', 
                testResults.transformation.failed === 0 ? 'Passed' : 'Failed',
                testResults.transformation.failed === 0 ? 'success' : 'danger'
            );
            updateCardStatus('transformationTestCard', testResults.transformation.failed === 0);
        }

        /**
         * Run individual test
         */
        async function runTest(name, testFunction) {
            try {
                const startTime = Date.now();
                const result = await testFunction();
                const duration = Date.now() - startTime;
                
                return {
                    name,
                    status: 'passed',
                    result,
                    duration,
                    error: null
                };
            } catch (error) {
                return {
                    name,
                    status: 'failed',
                    result: null,
                    duration: 0,
                    error: error.message
                };
            }
        }

        /**
         * Calculate test results
         */
        function calculateTestResults(tests) {
            const passed = tests.filter(t => t.status === 'passed').length;
            const failed = tests.filter(t => t.status === 'failed').length;
            
            return { passed, failed, tests };
        }

        /**
         * Display test results
         */
        function displayTestResults(containerId, tests) {
            const container = document.getElementById(containerId);
            
            let html = '';
            tests.forEach(test => {
                const icon = test.status === 'passed' ? 
                    '<i class="bi bi-check-circle text-success"></i>' : 
                    '<i class="bi bi-x-circle text-danger"></i>';
                
                html += `
                    <div class="mb-2">
                        <div class="d-flex align-items-center">
                            ${icon}
                            <strong class="ms-2">${test.name}</strong>
                            <span class="badge bg-light text-dark ms-auto">${test.duration}ms</span>
                        </div>
                        <div class="test-result">
                            ${test.status === 'passed' ? 
                                `✓ ${test.result}` : 
                                `✗ ${test.error}`
                            }
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        /**
         * Update test status badge
         */
        function updateTestStatus(elementId, status, type) {
            const element = document.getElementById(elementId);
            element.textContent = status;
            element.className = `badge bg-${type} ms-2`;
        }

        /**
         * Update card status
         */
        function updateCardStatus(cardId, success) {
            const card = document.getElementById(cardId);
            card.className = `card test-card mb-4 ${success ? 'success' : 'error'}`;
        }

        /**
         * Update test summary
         */
        function updateTestSummary() {
            const container = document.getElementById('testSummary');
            
            const totalPassed = testResults.system.passed + testResults.data.passed + testResults.transformation.passed;
            const totalFailed = testResults.system.failed + testResults.data.failed + testResults.transformation.failed;
            const totalTests = totalPassed + totalFailed;
            
            const allPassed = totalFailed === 0;
            
            container.innerHTML = `
                <div class="text-center">
                    <div class="display-6 ${allPassed ? 'text-success' : 'text-danger'}">
                        ${allPassed ? '✓' : '✗'}
                    </div>
                    <h6 class="mt-2">${allPassed ? 'All Tests Passed' : 'Some Tests Failed'}</h6>
                    <div class="small text-muted">
                        <div>Total: ${totalTests} tests</div>
                        <div class="text-success">Passed: ${totalPassed}</div>
                        ${totalFailed > 0 ? `<div class="text-danger">Failed: ${totalFailed}</div>` : ''}
                    </div>
                </div>
                
                <hr>
                
                <div class="small">
                    <div class="d-flex justify-content-between">
                        <span>System Tests:</span>
                        <span class="${testResults.system.failed === 0 ? 'text-success' : 'text-danger'}">
                            ${testResults.system.passed}/${testResults.system.passed + testResults.system.failed}
                        </span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Data Tests:</span>
                        <span class="${testResults.data.failed === 0 ? 'text-success' : 'text-danger'}">
                            ${testResults.data.passed}/${testResults.data.passed + testResults.data.failed}
                        </span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Transformation Tests:</span>
                        <span class="${testResults.transformation.failed === 0 ? 'text-success' : 'text-danger'}">
                            ${testResults.transformation.passed}/${testResults.transformation.passed + testResults.transformation.failed}
                        </span>
                    </div>
                </div>
            `;
        }

        /**
         * Check if all tests passed
         */
        function allTestsPassed() {
            return testResults.system.failed === 0 && 
                   testResults.data.failed === 0 && 
                   testResults.transformation.failed === 0;
        }

        /**
         * Setup live demo
         */
        async function setupLiveDemo() {
            try {
                const transformableItems = await window.masterBarangIntegration.getTransformableItemsForUI();
                
                if (transformableItems.length === 0) {
                    document.getElementById('demoSection').innerHTML = `
                        <div class="alert alert-warning">
                            <small>Tidak ada item yang dapat ditransformasi untuk demo.</small>
                        </div>
                    `;
                    return;
                }

                const group = transformableItems[0];
                if (group.items.length < 2) {
                    document.getElementById('demoSection').innerHTML = `
                        <div class="alert alert-warning">
                            <small>Tidak cukup item dalam grup untuk demo.</small>
                        </div>
                    `;
                    return;
                }

                const sourceItem = group.items.find(item => item.stock > 0) || group.items[0];
                const targetItem = group.items.find(item => item.id !== sourceItem.id) || group.items[1];

                // Get preview
                const preview = await window.transformationManager.getTransformationPreview(
                    sourceItem.id, targetItem.id, 1
                );

                document.getElementById('demoSection').innerHTML = `
                    <div class="transformation-preview">
                        <h6 class="text-center mb-3">Demo Transformasi</h6>
                        
                        <div class="text-center">
                            <div class="small">
                                <strong>${sourceItem.name}</strong><br>
                                Stok: ${sourceItem.stock} ${sourceItem.unit}<br>
                                <span class="text-primary">-1 ${sourceItem.unit}</span>
                            </div>
                            
                            <div class="arrow">
                                <i class="bi bi-arrow-down"></i>
                            </div>
                            
                            <div class="small">
                                <strong>${targetItem.name}</strong><br>
                                Stok: ${targetItem.stock} ${targetItem.unit}<br>
                                <span class="text-success">+${preview.targetItem.transformQuantity} ${targetItem.unit}</span>
                            </div>
                        </div>
                        
                        <div class="text-center mt-3">
                            <button class="btn btn-sm btn-primary" onclick="runDemoTransformation('${sourceItem.id}', '${targetItem.id}')">
                                <i class="bi bi-play-fill me-1"></i>Jalankan Demo
                            </button>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('Error setting up demo:', error);
                document.getElementById('demoSection').innerHTML = `
                    <div class="alert alert-danger">
                        <small>Error setting up demo: ${error.message}</small>
                    </div>
                `;
            }
        }

        /**
         * Run demo transformation
         */
        async function runDemoTransformation(sourceItemId, targetItemId) {
            try {
                const result = await window.masterBarangIntegration.executeTransformation(
                    sourceItemId, targetItemId, 1, 'Demo User'
                );

                showSuccess(`Demo transformation berhasil! ID: ${result.id}`);
                
                // Refresh demo
                setTimeout(() => {
                    setupLiveDemo();
                }, 1000);

            } catch (error) {
                console.error('Demo transformation failed:', error);
                showError('Demo transformation gagal: ' + error.message);
            }
        }

        /**
         * Utility functions
         */
        function showSuccess(message) {
            alert('✅ ' + message);
        }

        function showError(message) {
            alert('❌ ' + message);
        }
    </script>
</body>
</html>