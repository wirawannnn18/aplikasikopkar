<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Task 6: Error Handling and User Feedback</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .test-section {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .test-result {
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 0.25rem;
        }
        .test-pass {
            background-color: #d1edff;
            border-left: 4px solid #0d6efd;
        }
        .test-fail {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        .error-demo {
            border: 1px solid #ffc107;
            background-color: #fff3cd;
            padding: 1rem;
            border-radius: 0.375rem;
            margin: 1rem 0;
        }
        .recovery-demo {
            border: 1px solid #20c997;
            background-color: #d1ecf1;
            padding: 1rem;
            border-radius: 0.375rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">
            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
            Test Task 6: Error Handling and User Feedback
        </h1>

        <!-- Test Results Summary -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Test Results Summary</h5>
                    </div>
                    <div class="card-body">
                        <div id="testSummary">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Running tests...</span>
                                </div>
                                <p class="mt-2">Running error handling tests...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Task 6.1: Comprehensive Error Handling System -->
        <div class="test-section">
            <h3><i class="fas fa-cogs me-2"></i>Task 6.1: Comprehensive Error Handling System</h3>
            <p class="text-muted">Testing structured error messages with codes and context information</p>
            
            <div class="row">
                <div class="col-md-6">
                    <h5>Error Handler Demo</h5>
                    <button class="btn btn-danger btn-sm" onclick="testErrorHandler()">Test Error Handler</button>
                    <button class="btn btn-warning btn-sm" onclick="testWarningHandler()">Test Warning Handler</button>
                    <button class="btn btn-info btn-sm" onclick="testErrorSummary()">Test Error Summary</button>
                </div>
                <div class="col-md-6">
                    <h5>Error Display Demo</h5>
                    <button class="btn btn-outline-danger btn-sm" onclick="testErrorDisplay()">Test Error Display</button>
                    <button class="btn btn-outline-success btn-sm" onclick="testSuccessDisplay()">Test Success Display</button>
                    <button class="btn btn-outline-info btn-sm" onclick="clearErrorDisplay()">Clear Display</button>
                </div>
            </div>

            <div id="errorContainer" class="mt-3"></div>
            <div id="task61Results" class="mt-3"></div>
        </div>

        <!-- Task 6.2: Error Reporting Precision -->
        <div class="test-section">
            <h3><i class="fas fa-crosshairs me-2"></i>Task 6.2: Error Reporting Precision</h3>
            <p class="text-muted">Testing Property 7: Error Reporting Precision</p>
            
            <div class="error-demo">
                <h5>Error Precision Demo</h5>
                <button class="btn btn-primary btn-sm" onclick="testErrorPrecision()">Test Error Precision</button>
                <button class="btn btn-secondary btn-sm" onclick="testErrorContext()">Test Error Context</button>
                <div id="precisionResults" class="mt-3"></div>
            </div>

            <div id="task62Results" class="mt-3"></div>
        </div>

        <!-- Task 6.3: Error Message Helpfulness -->
        <div class="test-section">
            <h3><i class="fas fa-question-circle me-2"></i>Task 6.3: Error Message Helpfulness</h3>
            <p class="text-muted">Testing Property 12: Error Message Helpfulness</p>
            
            <div class="error-demo">
                <h5>Guidance System Demo</h5>
                <button class="btn btn-primary btn-sm" onclick="testGuidanceSystem()">Test Guidance System</button>
                <button class="btn btn-secondary btn-sm" onclick="testActionableGuidance()">Test Actionable Guidance</button>
                <div id="guidanceResults" class="mt-3"></div>
            </div>

            <div id="task63Results" class="mt-3"></div>
        </div>

        <!-- Task 6.4: Recovery and Rollback Mechanisms -->
        <div class="test-section">
            <h3><i class="fas fa-undo me-2"></i>Task 6.4: Recovery and Rollback Mechanisms</h3>
            <p class="text-muted">Testing backup, recovery, and rollback functionality</p>
            
            <div class="recovery-demo">
                <h5>Recovery Manager Demo</h5>
                <button class="btn btn-success btn-sm" onclick="testBackupCreation()">Test Backup Creation</button>
                <button class="btn btn-warning btn-sm" onclick="testRollback()">Test Rollback</button>
                <button class="btn btn-info btn-sm" onclick="testRecoveryStrategy()">Test Recovery Strategy</button>
                <div id="recoveryResults" class="mt-3"></div>
            </div>

            <div id="task64Results" class="mt-3"></div>
        </div>

        <!-- Task 6.5: Error Recovery Capability -->
        <div class="test-section">
            <h3><i class="fas fa-shield-alt me-2"></i>Task 6.5: Error Recovery Capability</h3>
            <p class="text-muted">Testing Property 15: Error Recovery Capability</p>
            
            <div class="recovery-demo">
                <h5>Recovery Capability Demo</h5>
                <button class="btn btn-primary btn-sm" onclick="testRecoveryCapability()">Test Recovery Capability</button>
                <button class="btn btn-secondary btn-sm" onclick="testOfflineMode()">Test Offline Mode</button>
                <div id="capabilityResults" class="mt-3"></div>
            </div>

            <div id="task65Results" class="mt-3"></div>
        </div>

        <!-- Integration Test -->
        <div class="test-section">
            <h3><i class="fas fa-puzzle-piece me-2"></i>Integration Test</h3>
            <p class="text-muted">Testing complete error handling workflow</p>
            
            <button class="btn btn-lg btn-primary" onclick="runIntegrationTest()">
                <i class="fas fa-play me-2"></i>Run Complete Integration Test
            </button>
            
            <div id="integrationResults" class="mt-3"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/upload-excel/ErrorHandler.js"></script>
    <script src="js/upload-excel/ErrorDisplayManager.js"></script>
    <script src="js/upload-excel/RecoveryManager.js"></script>

    <script>
        // Global test instances
        let errorHandler;
        let errorDisplayManager;
        let recoveryManager;
        let testResults = {
            task61: [],
            task62: [],
            task63: [],
            task64: [],
            task65: [],
            integration: []
        };

        // Initialize test environment
        document.addEventListener('DOMContentLoaded', function() {
            initializeTestEnvironment();
            runAllTests();
        });

        function initializeTestEnvironment() {
            try {
                errorHandler = new ErrorHandler();
                errorDisplayManager = new ErrorDisplayManager('errorContainer');
                recoveryManager = new RecoveryManager();
                
                console.log('Test environment initialized successfully');
            } catch (error) {
                console.error('Failed to initialize test environment:', error);
                showTestResult('initialization', false, `Initialization failed: ${error.message}`);
            }
        }

        // Task 6.1 Tests
        function testErrorHandler() {
            try {
                // Test adding errors with context
                const error1 = errorHandler.addError('E201', 'Field wajib tidak boleh kosong', {
                    row: 5,
                    field: 'kode',
                    value: ''
                });

                const error2 = errorHandler.addError('E204', 'Kode barang duplikat', {
                    row: 10,
                    field: 'kode',
                    value: 'BRG001'
                });

                // Verify error structure
                const errors = errorHandler.getErrors();
                const isValid = errors.length === 2 && 
                               errors[0].code === 'E201' && 
                               errors[1].code === 'E204' &&
                               errors[0].context.row === 5 &&
                               errors[1].context.row === 10;

                showTestResult('task61', isValid, 
                    isValid ? 'Error handler working correctly' : 'Error handler test failed');

                // Display errors
                const report = errorHandler.getDetailedReport();
                errorDisplayManager.displayErrors(report);

            } catch (error) {
                showTestResult('task61', false, `Error handler test failed: ${error.message}`);
            }
        }

        function testWarningHandler() {
            try {
                errorHandler.clear();
                
                const warning = errorHandler.addWarning('E301', 'Kode barang sudah ada dalam sistem', {
                    row: 3,
                    field: 'kode',
                    value: 'BRG002'
                });

                const warnings = errorHandler.getWarnings();
                const isValid = warnings.length === 1 && 
                               warnings[0].severity === 'warning' &&
                               warnings[0].code === 'E301';

                showTestResult('task61', isValid, 
                    isValid ? 'Warning handler working correctly' : 'Warning handler test failed');

            } catch (error) {
                showTestResult('task61', false, `Warning handler test failed: ${error.message}`);
            }
        }

        function testErrorSummary() {
            try {
                errorHandler.clear();
                
                // Add multiple errors
                errorHandler.addError('E201', 'Required field empty', { row: 1, field: 'kode' });
                errorHandler.addError('E201', 'Required field empty', { row: 2, field: 'nama' });
                errorHandler.addError('E204', 'Duplicate code', { row: 3, field: 'kode' });

                const summary = errorHandler.getErrorSummary();
                const isValid = summary.totalErrors === 3 &&
                               summary.errorsByCode.length === 2 &&
                               summary.hasBlockingErrors === true;

                showTestResult('task61', isValid, 
                    isValid ? 'Error summary working correctly' : 'Error summary test failed');

            } catch (error) {
                showTestResult('task61', false, `Error summary test failed: ${error.message}`);
            }
        }

        function testErrorDisplay() {
            try {
                errorHandler.clear();
                
                errorHandler.addError('E201', 'Field wajib tidak boleh kosong', {
                    row: 5,
                    field: 'kode',
                    value: ''
                });

                errorHandler.addWarning('E301', 'Kode barang sudah ada', {
                    row: 8,
                    field: 'kode',
                    value: 'BRG001'
                });

                const report = errorHandler.getDetailedReport();
                errorDisplayManager.displayErrors(report);

                showTestResult('task61', true, 'Error display test completed');

            } catch (error) {
                showTestResult('task61', false, `Error display test failed: ${error.message}`);
            }
        }

        function testSuccessDisplay() {
            try {
                errorDisplayManager.displaySuccess('Import berhasil!', {
                    created: 15,
                    updated: 3,
                    failed: 0
                });

                showTestResult('task61', true, 'Success display test completed');

            } catch (error) {
                showTestResult('task61', false, `Success display test failed: ${error.message}`);
            }
        }

        function clearErrorDisplay() {
            errorDisplayManager.clear();
        }

        // Task 6.2 Tests
        function testErrorPrecision() {
            try {
                errorHandler.clear();
                
                const error = errorHandler.addError('E202', 'Invalid data type', {
                    row: 15,
                    column: 3,
                    field: 'harga_beli',
                    value: 'abc123'
                });

                const displayMessage = errorHandler.formatErrorForDisplay(error);
                
                const hasAllInfo = displayMessage.includes('[E202]') &&
                                  displayMessage.includes('Baris 15') &&
                                  displayMessage.includes('Field: harga_beli') &&
                                  displayMessage.includes('Nilai: "abc123"');

                document.getElementById('precisionResults').innerHTML = `
                    <div class="alert alert-info">
                        <strong>Formatted Error:</strong><br>
                        ${displayMessage}
                    </div>
                `;

                showTestResult('task62', hasAllInfo, 
                    hasAllInfo ? 'Error precision test passed' : 'Error precision test failed');

            } catch (error) {
                showTestResult('task62', false, `Error precision test failed: ${error.message}`);
            }
        }

        function testErrorContext() {
            try {
                errorHandler.clear();
                
                const error = errorHandler.addError('E203', 'Negative value not allowed', {
                    row: 20,
                    field: 'stok',
                    value: -5
                });

                const hasContext = error.context &&
                                  error.context.row === 20 &&
                                  error.context.field === 'stok' &&
                                  error.context.value === -5 &&
                                  error.context.timestamp;

                showTestResult('task62', hasContext, 
                    hasContext ? 'Error context test passed' : 'Error context test failed');

            } catch (error) {
                showTestResult('task62', false, `Error context test failed: ${error.message}`);
            }
        }

        // Task 6.3 Tests
        function testGuidanceSystem() {
            try {
                errorHandler.clear();
                
                const error = errorHandler.addError('E001', 'Format file tidak valid');
                
                const hasGuidance = error.guidance &&
                                   Array.isArray(error.guidance) &&
                                   error.guidance.length > 0 &&
                                   error.guidance.some(guide => guide.includes('template'));

                document.getElementById('guidanceResults').innerHTML = `
                    <div class="alert alert-info">
                        <strong>Guidance for E001:</strong>
                        <ul>
                            ${error.guidance.map(guide => `<li>${guide}</li>`).join('')}
                        </ul>
                    </div>
                `;

                showTestResult('task63', hasGuidance, 
                    hasGuidance ? 'Guidance system test passed' : 'Guidance system test failed');

            } catch (error) {
                showTestResult('task63', false, `Guidance system test failed: ${error.message}`);
            }
        }

        function testActionableGuidance() {
            try {
                const error = errorHandler.addError('E204', 'Kode barang duplikat');
                
                const actionableWords = ['pastikan', 'periksa', 'gunakan', 'hapus'];
                const guidanceText = error.guidance.join(' ').toLowerCase();
                const isActionable = actionableWords.some(word => guidanceText.includes(word));

                showTestResult('task63', isActionable, 
                    isActionable ? 'Actionable guidance test passed' : 'Actionable guidance test failed');

            } catch (error) {
                showTestResult('task63', false, `Actionable guidance test failed: ${error.message}`);
            }
        }

        // Task 6.4 Tests
        function testBackupCreation() {
            try {
                const testData = {
                    records: [
                        { kode: 'BRG001', nama: 'Barang 1' },
                        { kode: 'BRG002', nama: 'Barang 2' }
                    ]
                };

                const backupId = recoveryManager.createBackup(testData, 'test_operation');
                const backup = recoveryManager.getBackup(backupId);

                const isValid = backupId &&
                               backup &&
                               backup.id === backupId &&
                               backup.operation === 'test_operation' &&
                               JSON.stringify(backup.data) === JSON.stringify(testData);

                document.getElementById('recoveryResults').innerHTML = `
                    <div class="alert alert-info">
                        <strong>Backup Created:</strong> ${backupId}<br>
                        <strong>Operation:</strong> ${backup?.operation}<br>
                        <strong>Timestamp:</strong> ${backup?.timestamp}
                    </div>
                `;

                showTestResult('task64', isValid, 
                    isValid ? 'Backup creation test passed' : 'Backup creation test failed');

            } catch (error) {
                showTestResult('task64', false, `Backup creation test failed: ${error.message}`);
            }
        }

        async function testRollback() {
            try {
                const testData = { value: 'test_rollback' };
                const backupId = recoveryManager.createBackup(testData, 'rollback_test');
                
                const rollbackResult = await recoveryManager.rollback(backupId);
                
                const isValid = rollbackResult.success &&
                               rollbackResult.backupId === backupId;

                showTestResult('task64', isValid, 
                    isValid ? 'Rollback test passed' : 'Rollback test failed');

            } catch (error) {
                showTestResult('task64', false, `Rollback test failed: ${error.message}`);
            }
        }

        async function testRecoveryStrategy() {
            try {
                const context = {
                    validData: [{ id: 1, name: 'valid' }],
                    invalidData: [{ id: 2, error: 'invalid' }]
                };

                const mockRetryCallback = async () => ({ success: true });
                
                const result = await recoveryManager.applyRecoveryStrategy(
                    'VALIDATION_ERROR',
                    context,
                    mockRetryCallback
                );

                const isValid = result.success && result.message;

                showTestResult('task64', isValid, 
                    isValid ? 'Recovery strategy test passed' : 'Recovery strategy test failed');

            } catch (error) {
                showTestResult('task64', false, `Recovery strategy test failed: ${error.message}`);
            }
        }

        // Task 6.5 Tests
        async function testRecoveryCapability() {
            try {
                // Test multiple backup creation and rollback
                const backups = [];
                for (let i = 0; i < 3; i++) {
                    const backupId = recoveryManager.createBackup(
                        { step: i, data: `test_${i}` },
                        `operation_${i}`
                    );
                    backups.push(backupId);
                }

                // Test rollback to specific backup
                const rollbackResult = await recoveryManager.rollback(backups[1]);
                
                const isValid = rollbackResult.success &&
                               rollbackResult.backupId === backups[1];

                document.getElementById('capabilityResults').innerHTML = `
                    <div class="alert alert-info">
                        <strong>Backups Created:</strong> ${backups.length}<br>
                        <strong>Rollback Target:</strong> ${backups[1]}<br>
                        <strong>Rollback Success:</strong> ${rollbackResult.success}
                    </div>
                `;

                showTestResult('task65', isValid, 
                    isValid ? 'Recovery capability test passed' : 'Recovery capability test failed');

            } catch (error) {
                showTestResult('task65', false, `Recovery capability test failed: ${error.message}`);
            }
        }

        async function testOfflineMode() {
            try {
                const context = {
                    data: [{ id: 1, name: 'offline_test' }],
                    operation: 'offline_import'
                };

                const result = await recoveryManager.applyRecoveryStrategy(
                    'NETWORK_ERROR',
                    context,
                    null
                );

                // For network errors, should go to offline mode
                const isValid = result.success && result.message.includes('offline');

                showTestResult('task65', isValid, 
                    isValid ? 'Offline mode test passed' : 'Offline mode test failed');

            } catch (error) {
                showTestResult('task65', false, `Offline mode test failed: ${error.message}`);
            }
        }

        // Integration Test
        async function runIntegrationTest() {
            try {
                document.getElementById('integrationResults').innerHTML = `
                    <div class="alert alert-info">
                        <div class="spinner-border spinner-border-sm me-2"></div>
                        Running integration test...
                    </div>
                `;

                // Step 1: Create backup
                const originalData = {
                    records: [
                        { kode: 'BRG001', nama: 'Barang 1', harga_beli: 1000 },
                        { kode: 'BRG002', nama: 'Barang 2', harga_beli: 2000 }
                    ]
                };

                const backupId = recoveryManager.createBackup(originalData, 'integration_test');

                // Step 2: Simulate errors
                errorHandler.clear();
                errorHandler.addError('E201', 'Field required', { row: 1, field: 'kode' });
                errorHandler.addError('E204', 'Duplicate code', { row: 2, field: 'kode' });
                errorHandler.addWarning('E301', 'Existing code', { row: 3, field: 'kode' });

                // Step 3: Display errors
                const report = errorHandler.getDetailedReport();
                errorDisplayManager.displayErrors(report);

                // Step 4: Test recovery
                const recoveryResult = await recoveryManager.applyRecoveryStrategy(
                    'VALIDATION_ERROR',
                    { validData: [originalData.records[0]], invalidData: [originalData.records[1]] },
                    async () => ({ success: true })
                );

                // Step 5: Test rollback
                const rollbackResult = await recoveryManager.rollback(backupId);

                const integrationSuccess = backupId &&
                                         report.errors.length === 2 &&
                                         report.warnings.length === 1 &&
                                         recoveryResult.success &&
                                         rollbackResult.success;

                document.getElementById('integrationResults').innerHTML = `
                    <div class="alert ${integrationSuccess ? 'alert-success' : 'alert-danger'}">
                        <h5>Integration Test Results:</h5>
                        <ul>
                            <li>Backup Created: ${backupId ? '✓' : '✗'}</li>
                            <li>Errors Detected: ${report.errors.length} (Expected: 2)</li>
                            <li>Warnings Detected: ${report.warnings.length} (Expected: 1)</li>
                            <li>Recovery Strategy: ${recoveryResult.success ? '✓' : '✗'}</li>
                            <li>Rollback: ${rollbackResult.success ? '✓' : '✗'}</li>
                        </ul>
                        <strong>Overall: ${integrationSuccess ? 'PASSED' : 'FAILED'}</strong>
                    </div>
                `;

                showTestResult('integration', integrationSuccess, 
                    integrationSuccess ? 'Integration test passed' : 'Integration test failed');

            } catch (error) {
                document.getElementById('integrationResults').innerHTML = `
                    <div class="alert alert-danger">
                        Integration test failed: ${error.message}
                    </div>
                `;
                showTestResult('integration', false, `Integration test failed: ${error.message}`);
            }
        }

        // Utility functions
        function showTestResult(task, success, message) {
            testResults[task].push({ success, message, timestamp: new Date() });
            updateTestSummary();
        }

        function updateTestSummary() {
            const totalTests = Object.values(testResults).flat().length;
            const passedTests = Object.values(testResults).flat().filter(r => r.success).length;
            const failedTests = totalTests - passedTests;

            document.getElementById('testSummary').innerHTML = `
                <div class="row text-center">
                    <div class="col-md-3">
                        <h4 class="text-primary">${totalTests}</h4>
                        <small>Total Tests</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-success">${passedTests}</h4>
                        <small>Passed</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-danger">${failedTests}</h4>
                        <small>Failed</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-info">${totalTests > 0 ? Math.round((passedTests/totalTests)*100) : 0}%</h4>
                        <small>Success Rate</small>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="progress">
                        <div class="progress-bar ${passedTests === totalTests ? 'bg-success' : 'bg-warning'}" 
                             style="width: ${totalTests > 0 ? (passedTests/totalTests)*100 : 0}%"></div>
                    </div>
                </div>
            `;
        }

        async function runAllTests() {
            try {
                // Wait a bit for initialization
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Run basic tests
                testErrorHandler();
                testWarningHandler();
                testErrorSummary();
                testErrorPrecision();
                testErrorContext();
                testGuidanceSystem();
                testActionableGuidance();
                testBackupCreation();
                
                // Run async tests
                await testRollback();
                await testRecoveryStrategy();
                await testRecoveryCapability();
                await testOfflineMode();
                
                console.log('All tests completed');
                
            } catch (error) {
                console.error('Error running tests:', error);
                showTestResult('initialization', false, `Test execution failed: ${error.message}`);
            }
        }
    </script>
</body>
</html>