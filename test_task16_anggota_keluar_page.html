<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Task 16 - Anggota Keluar Page Rendering</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .test-section { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-result { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .test-pass { background-color: #d4edda; border-left: 4px solid #28a745; }
        .test-fail { background-color: #f8d7da; border-left: 4px solid #dc3545; }
        .test-info { background-color: #d1ecf1; border-left: 4px solid #17a2b8; }
        .scenario { background-color: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 4px; border: 1px solid #dee2e6; }
        .data-display { background-color: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 0.9em; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h1 class="mb-4">
            <i class="bi bi-clipboard-check text-primary"></i>
            Test Task 16 - Anggota Keluar Page Rendering
        </h1>

        <div class="test-section">
            <h3>üìã Test Overview</h3>
            <p><strong>Task:</strong> Update Anggota Keluar page to show only statusKeanggotaan === 'Keluar'</p>
            <p><strong>Requirements:</strong></p>
            <ul>
                <li>Anggota Keluar tab shows only anggota with statusKeanggotaan === 'Keluar'</li>
                <li>Display tanggal keluar and pengembalian status</li>
                <li>Show zero balances after pencairan</li>
                <li>Anggota Aktif tab shows anggota who can be processed (not keluar yet)</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üîß Setup Test Data</h3>
            <button class="btn btn-primary" onclick="setupTestData()">
                <i class="bi bi-database-fill-add me-1"></i>Setup Test Data
            </button>
            <button class="btn btn-secondary ms-2" onclick="clearTestData()">
                <i class="bi bi-trash me-1"></i>Clear Test Data
            </button>
            <div id="setupResult" class="mt-3"></div>
        </div>

        <div class="test-section">
            <h3>üß™ Run Tests</h3>
            <button class="btn btn-success" onclick="runAllTests()">
                <i class="bi bi-play-circle me-1"></i>Run All Tests
            </button>
            <div id="testResults" class="mt-3"></div>
        </div>

        <div class="test-section">
            <h3>üëÅÔ∏è Visual Verification</h3>
            <button class="btn btn-info" onclick="showAnggotaKeluarPage()">
                <i class="bi bi-eye me-1"></i>Show Anggota Keluar Page
            </button>
            <div id="visualResult" class="mt-3"></div>
        </div>
    </div>

    <!-- Load required scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/koperasi.js"></script>
    <script src="js/anggotaKeluarUI.js"></script>

    <script>
        // Test data setup
        function setupTestData() {
            const testAnggota = [
                // Scenario 1: Aktif, not keluar
                {
                    id: 'test-aktif-1',
                    nik: '1001',
                    nama: 'Budi Santoso',
                    departemen: 'IT',
                    tipeAnggota: 'Umum',
                    status: 'Aktif',
                    statusKeanggotaan: 'Aktif',
                    tanggalKeluar: null,
                    pengembalianStatus: null
                },
                // Scenario 2: Aktif, not keluar
                {
                    id: 'test-aktif-2',
                    nik: '1002',
                    nama: 'Siti Rahayu',
                    departemen: 'Finance',
                    tipeAnggota: 'Umum',
                    status: 'Aktif',
                    statusKeanggotaan: 'Aktif',
                    tanggalKeluar: null,
                    pengembalianStatus: null
                },
                // Scenario 3: Keluar with Pending pengembalian
                {
                    id: 'test-keluar-1',
                    nik: '1003',
                    nama: 'Andi Wijaya',
                    departemen: 'HR',
                    tipeAnggota: 'Umum',
                    status: 'Aktif',
                    statusKeanggotaan: 'Keluar',
                    tanggalKeluar: '2024-12-01',
                    pengembalianStatus: 'Pending'
                },
                // Scenario 4: Keluar with Selesai pengembalian
                {
                    id: 'test-keluar-2',
                    nik: '1004',
                    nama: 'Dewi Lestari',
                    departemen: 'Marketing',
                    tipeAnggota: 'Umum',
                    status: 'Aktif',
                    statusKeanggotaan: 'Keluar',
                    tanggalKeluar: '2024-11-15',
                    pengembalianStatus: 'Selesai'
                },
                // Scenario 5: Nonaktif but not keluar (e.g., cuti)
                {
                    id: 'test-nonaktif-1',
                    nik: '1005',
                    nama: 'Eko Prasetyo',
                    departemen: 'Operations',
                    tipeAnggota: 'Umum',
                    status: 'Nonaktif',
                    statusKeanggotaan: 'Aktif',
                    tanggalKeluar: null,
                    pengembalianStatus: null
                },
                // Scenario 6: Keluar without pengembalianStatus (edge case)
                {
                    id: 'test-keluar-3',
                    nik: '1006',
                    nama: 'Fitri Handayani',
                    departemen: 'Sales',
                    tipeAnggota: 'Umum',
                    status: 'Aktif',
                    statusKeanggotaan: 'Keluar',
                    tanggalKeluar: '2024-12-05',
                    pengembalianStatus: null
                }
            ];

            localStorage.setItem('anggota', JSON.stringify(testAnggota));

            const result = document.getElementById('setupResult');
            result.innerHTML = `
                <div class="test-result test-pass">
                    <i class="bi bi-check-circle me-2"></i>
                    <strong>Test data created successfully!</strong>
                    <div class="data-display mt-2">
                        Total anggota: ${testAnggota.length}<br>
                        - Aktif (not keluar): 2<br>
                        - Keluar (Pending): 1<br>
                        - Keluar (Selesai): 1<br>
                        - Keluar (no status): 1<br>
                        - Nonaktif (not keluar): 1
                    </div>
                </div>
            `;
        }

        function clearTestData() {
            localStorage.removeItem('anggota');
            document.getElementById('setupResult').innerHTML = `
                <div class="test-result test-info">
                    <i class="bi bi-info-circle me-2"></i>
                    Test data cleared.
                </div>
            `;
        }

        // Test functions
        function runAllTests() {
            const results = [];
            
            // Test 1: Anggota Keluar filtering
            results.push(testAnggotaKeluarFiltering());
            
            // Test 2: Anggota Aktif filtering
            results.push(testAnggotaAktifFiltering());
            
            // Test 3: Count accuracy
            results.push(testCountAccuracy());
            
            // Test 4: Display fields
            results.push(testDisplayFields());
            
            // Test 5: Edge cases
            results.push(testEdgeCases());
            
            displayTestResults(results);
        }

        function testAnggotaKeluarFiltering() {
            const anggotaList = JSON.parse(localStorage.getItem('anggota') || '[]');
            const anggotaKeluar = anggotaList.filter(a => a.statusKeanggotaan === 'Keluar');
            
            const allHaveKeluarStatus = anggotaKeluar.every(a => a.statusKeanggotaan === 'Keluar');
            const expectedCount = 3; // test-keluar-1, test-keluar-2, test-keluar-3
            const actualCount = anggotaKeluar.length;
            
            return {
                name: 'Test 1: Anggota Keluar Filtering',
                pass: allHaveKeluarStatus && actualCount === expectedCount,
                message: allHaveKeluarStatus && actualCount === expectedCount
                    ? `‚úÖ All ${actualCount} anggota in Keluar tab have statusKeanggotaan === 'Keluar'`
                    : `‚ùå Expected ${expectedCount} anggota keluar, got ${actualCount}. All have Keluar status: ${allHaveKeluarStatus}`,
                details: anggotaKeluar.map(a => `${a.nama} (${a.statusKeanggotaan}, ${a.pengembalianStatus || 'no status'})`).join(', ')
            };
        }

        function testAnggotaAktifFiltering() {
            const anggotaList = JSON.parse(localStorage.getItem('anggota') || '[]');
            const anggotaAktif = anggotaList.filter(a => a.statusKeanggotaan !== 'Keluar');
            
            const noneHaveKeluarStatus = anggotaAktif.every(a => a.statusKeanggotaan !== 'Keluar');
            const expectedCount = 3; // test-aktif-1, test-aktif-2, test-nonaktif-1
            const actualCount = anggotaAktif.length;
            
            return {
                name: 'Test 2: Anggota Aktif Filtering',
                pass: noneHaveKeluarStatus && actualCount === expectedCount,
                message: noneHaveKeluarStatus && actualCount === expectedCount
                    ? `‚úÖ All ${actualCount} anggota in Aktif tab have statusKeanggotaan !== 'Keluar'`
                    : `‚ùå Expected ${expectedCount} anggota aktif, got ${actualCount}. None have Keluar status: ${noneHaveKeluarStatus}`,
                details: anggotaAktif.map(a => `${a.nama} (${a.statusKeanggotaan}, status: ${a.status})`).join(', ')
            };
        }

        function testCountAccuracy() {
            const anggotaList = JSON.parse(localStorage.getItem('anggota') || '[]');
            const anggotaKeluar = anggotaList.filter(a => a.statusKeanggotaan === 'Keluar');
            
            const pendingCount = anggotaKeluar.filter(a => a.pengembalianStatus === 'Pending').length;
            const selesaiCount = anggotaKeluar.filter(a => a.pengembalianStatus === 'Selesai').length;
            
            const expectedPending = 1;
            const expectedSelesai = 1;
            
            return {
                name: 'Test 3: Count Accuracy',
                pass: pendingCount === expectedPending && selesaiCount === expectedSelesai,
                message: pendingCount === expectedPending && selesaiCount === expectedSelesai
                    ? `‚úÖ Counts accurate: Pending=${pendingCount}, Selesai=${selesaiCount}`
                    : `‚ùå Expected Pending=${expectedPending}, Selesai=${expectedSelesai}. Got Pending=${pendingCount}, Selesai=${selesaiCount}`,
                details: `Total Keluar: ${anggotaKeluar.length}, Pending: ${pendingCount}, Selesai: ${selesaiCount}`
            };
        }

        function testDisplayFields() {
            const anggotaList = JSON.parse(localStorage.getItem('anggota') || '[]');
            const anggotaKeluar = anggotaList.filter(a => a.statusKeanggotaan === 'Keluar');
            
            const allHaveTanggalKeluar = anggotaKeluar.every(a => a.tanggalKeluar !== undefined);
            const allHavePengembalianStatus = anggotaKeluar.every(a => a.pengembalianStatus !== undefined);
            
            return {
                name: 'Test 4: Display Fields',
                pass: allHaveTanggalKeluar && allHavePengembalianStatus,
                message: allHaveTanggalKeluar && allHavePengembalianStatus
                    ? `‚úÖ All anggota keluar have tanggalKeluar and pengembalianStatus fields`
                    : `‚ùå Some anggota keluar missing required fields`,
                details: `tanggalKeluar present: ${allHaveTanggalKeluar}, pengembalianStatus present: ${allHavePengembalianStatus}`
            };
        }

        function testEdgeCases() {
            const anggotaList = JSON.parse(localStorage.getItem('anggota') || '[]');
            
            // Edge case 1: Nonaktif but not keluar should be in Aktif tab
            const nonaktifNotKeluar = anggotaList.find(a => a.id === 'test-nonaktif-1');
            const shouldBeInAktif = nonaktifNotKeluar && nonaktifNotKeluar.statusKeanggotaan !== 'Keluar';
            
            // Edge case 2: Keluar without pengembalianStatus should still be in Keluar tab
            const keluarNoStatus = anggotaList.find(a => a.id === 'test-keluar-3');
            const shouldBeInKeluar = keluarNoStatus && keluarNoStatus.statusKeanggotaan === 'Keluar';
            
            return {
                name: 'Test 5: Edge Cases',
                pass: shouldBeInAktif && shouldBeInKeluar,
                message: shouldBeInAktif && shouldBeInKeluar
                    ? `‚úÖ Edge cases handled correctly`
                    : `‚ùå Edge cases not handled correctly`,
                details: `Nonaktif (not keluar) in Aktif tab: ${shouldBeInAktif}, Keluar (no status) in Keluar tab: ${shouldBeInKeluar}`
            };
        }

        function displayTestResults(results) {
            const container = document.getElementById('testResults');
            const passCount = results.filter(r => r.pass).length;
            const totalCount = results.length;
            
            let html = `
                <div class="test-result ${passCount === totalCount ? 'test-pass' : 'test-fail'}">
                    <h5>
                        <i class="bi bi-${passCount === totalCount ? 'check-circle' : 'x-circle'} me-2"></i>
                        Test Results: ${passCount}/${totalCount} passed
                    </h5>
                </div>
            `;
            
            results.forEach(result => {
                html += `
                    <div class="scenario">
                        <h6>${result.name}</h6>
                        <div class="test-result ${result.pass ? 'test-pass' : 'test-fail'}">
                            ${result.message}
                        </div>
                        <div class="data-display">
                            ${result.details}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function showAnggotaKeluarPage() {
            const anggotaList = JSON.parse(localStorage.getItem('anggota') || '[]');
            const anggotaAktif = anggotaList.filter(a => a.statusKeanggotaan !== 'Keluar');
            const anggotaKeluar = anggotaList.filter(a => a.statusKeanggotaan === 'Keluar');
            
            const container = document.getElementById('visualResult');
            container.innerHTML = `
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <i class="bi bi-box-arrow-right me-2"></i>Visual Verification
                    </div>
                    <div class="card-body">
                        <h5>Anggota Aktif Tab (${anggotaAktif.length})</h5>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>NIK</th>
                                        <th>Nama</th>
                                        <th>Status</th>
                                        <th>StatusKeanggotaan</th>
                                        <th>Pengembalian Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${anggotaAktif.map(a => `
                                        <tr>
                                            <td>${a.nik}</td>
                                            <td>${a.nama}</td>
                                            <td><span class="badge bg-${a.status === 'Aktif' ? 'success' : 'secondary'}">${a.status}</span></td>
                                            <td><span class="badge bg-${a.statusKeanggotaan === 'Aktif' ? 'success' : 'warning'}">${a.statusKeanggotaan}</span></td>
                                            <td>${a.pengembalianStatus || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <h5 class="mt-4">Anggota Keluar Tab (${anggotaKeluar.length})</h5>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>NIK</th>
                                        <th>Nama</th>
                                        <th>StatusKeanggotaan</th>
                                        <th>Tanggal Keluar</th>
                                        <th>Pengembalian Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${anggotaKeluar.map(a => `
                                        <tr>
                                            <td>${a.nik}</td>
                                            <td>${a.nama}</td>
                                            <td><span class="badge bg-danger">${a.statusKeanggotaan}</span></td>
                                            <td>${a.tanggalKeluar || '-'}</td>
                                            <td>
                                                ${a.pengembalianStatus === 'Selesai' 
                                                    ? '<span class="badge bg-success">Selesai</span>'
                                                    : a.pengembalianStatus === 'Pending'
                                                    ? '<span class="badge bg-warning">Pending</span>'
                                                    : '<span class="badge bg-secondary">-</span>'
                                                }
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        // Auto-setup on load
        window.addEventListener('load', () => {
            console.log('Test page loaded. Ready to test Task 16.');
        });
    </script>
</body>
</html>
