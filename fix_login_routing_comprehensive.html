<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Login Routing - Comprehensive Solution</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #1b4332 0%, #2d6a4f 50%, #52b788 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .fix-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin: 20px auto;
            max-width: 1200px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .step-card {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            transition: all 0.3s ease;
        }
        .step-card:hover {
            border-color: #2d6a4f;
            box-shadow: 0 5px 15px rgba(45, 106, 79, 0.1);
        }
        .step-success {
            border-color: #28a745;
            background-color: #f8fff9;
        }
        .step-error {
            border-color: #dc3545;
            background-color: #fff8f8;
        }
        .step-warning {
            border-color: #ffc107;
            background-color: #fffdf5;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .log-info { color: #0c5460; }
        .log-success { color: #155724; background-color: #d4edda; }
        .log-error { color: #721c24; background-color: #f8d7da; }
        .log-warning { color: #856404; background-color: #fff3cd; }
    </style>
</head>
<body>
    <div class="container">
        <div class="fix-container">
            <div class="text-center mb-4">
                <h1 style="color: #2d6a4f;">
                    <i class="bi bi-tools me-3"></i>Fix Login Routing Issue
                </h1>
                <p class="lead">Comprehensive solution for login routing to localhost:3000/?</p>
            </div>

            <div class="row">
                <div class="col-md-8">
                    <div class="step-card" id="step1">
                        <h4><i class="bi bi-1-circle me-2"></i>Diagnose Current Issue</h4>
                        <p>Check the current state of login functionality and identify the root cause.</p>
                        <button class="btn btn-primary" onclick="diagnoseIssue()">
                            <i class="bi bi-search me-1"></i>Run Diagnosis
                        </button>
                        <div id="diagnosis-result" class="mt-3"></div>
                    </div>

                    <div class="step-card" id="step2">
                        <h4><i class="bi bi-2-circle me-2"></i>Fix Authentication Flow</h4>
                        <p>Apply comprehensive fixes to the authentication and routing system.</p>
                        <button class="btn btn-success" onclick="applyFixes()" disabled id="fixBtn">
                            <i class="bi bi-wrench me-1"></i>Apply Fixes
                        </button>
                        <div id="fix-result" class="mt-3"></div>
                    </div>

                    <div class="step-card" id="step3">
                        <h4><i class="bi bi-3-circle me-2"></i>Test Login Process</h4>
                        <p>Test the login functionality with the applied fixes.</p>
                        <button class="btn btn-info" onclick="testLogin()" disabled id="testBtn">
                            <i class="bi bi-play-circle me-1"></i>Test Login
                        </button>
                        <div id="test-result" class="mt-3"></div>
                    </div>

                    <div class="step-card" id="step4">
                        <h4><i class="bi bi-4-circle me-2"></i>Verify Solution</h4>
                        <p>Final verification that the routing issue is resolved.</p>
                        <button class="btn btn-warning" onclick="verifySolution()" disabled id="verifyBtn">
                            <i class="bi bi-check-circle me-1"></i>Verify Solution
                        </button>
                        <div id="verify-result" class="mt-3"></div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <i class="bi bi-terminal me-2"></i>System Log
                        </div>
                        <div class="card-body p-0">
                            <div id="systemLog" class="log-area">
                                <div class="log-info">System ready for diagnosis...</div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-sm btn-secondary" onclick="clearLog()">
                                <i class="bi bi-trash me-1"></i>Clear Log
                            </button>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header bg-info text-white">
                            <i class="bi bi-info-circle me-2"></i>Issue Summary
                        </div>
                        <div class="card-body">
                            <h6>Problem:</h6>
                            <p class="small">After successful login, user is redirected to <code>localhost:3000/?</code> instead of the dashboard.</p>
                            
                            <h6>Root Causes:</h6>
                            <ul class="small">
                                <li>showMainApp() function errors</li>
                                <li>Improper URL manipulation</li>
                                <li>Missing navigation functions</li>
                                <li>DOM element availability issues</li>
                            </ul>
                            
                            <h6>Solution:</h6>
                            <p class="small">Fix authentication flow, improve error handling, and ensure proper navigation to dashboard.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let logArea = document.getElementById('systemLog');
        let currentStep = 1;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearLog() {
            logArea.innerHTML = '<div class="log-info">Log cleared...</div>';
        }
        
        function updateStepStatus(stepNum, status) {
            const step = document.getElementById(`step${stepNum}`);
            step.className = `step-card step-${status}`;
        }
        
        function enableNextStep() {
            currentStep++;
            const buttons = ['fixBtn', 'testBtn', 'verifyBtn'];
            if (currentStep <= buttons.length + 1) {
                const btnId = buttons[currentStep - 2];
                if (btnId) {
                    document.getElementById(btnId).disabled = false;
                }
            }
        }
        
        function diagnoseIssue() {
            log('Starting comprehensive diagnosis...', 'info');
            updateStepStatus(1, 'warning');
            
            let issues = [];
            let fixes = [];
            
            // Check if we're in the main application context
            if (window.location.pathname.includes('index.html') || window.location.pathname === '/') {
                log('✓ Running in main application context', 'success');
            } else {
                log('⚠ Not in main application context', 'warning');
                issues.push('Not running from main application');
            }
            
            // Check for required DOM elements
            const requiredElements = ['loginPage', 'mainApp', 'currentUser', 'currentRole', 'menuList', 'mainContent'];
            requiredElements.forEach(id => {
                if (document.getElementById(id)) {
                    log(`✓ DOM element '${id}' found`, 'success');
                } else {
                    log(`✗ DOM element '${id}' missing`, 'error');
                    issues.push(`Missing DOM element: ${id}`);
                }
            });
            
            // Check for required functions
            const requiredFunctions = ['showMainApp', 'navigateTo', 'renderMenu', 'renderPage', 'handleLogin'];
            requiredFunctions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    log(`✓ Function '${funcName}' available`, 'success');
                } else {
                    log(`✗ Function '${funcName}' missing`, 'error');
                    issues.push(`Missing function: ${funcName}`);
                }
            });
            
            // Check localStorage
            try {
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                log(`✓ Found ${users.length} users in localStorage`, 'success');
                if (users.length === 0) {
                    issues.push('No users in localStorage');
                    fixes.push('Create default admin user');
                }
            } catch (error) {
                log('✗ Error reading localStorage', 'error');
                issues.push('localStorage error');
            }
            
            // Display diagnosis results
            const resultDiv = document.getElementById('diagnosis-result');
            if (issues.length === 0) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle me-2"></i>
                        <strong>Diagnosis Complete:</strong> No critical issues found. System appears healthy.
                    </div>
                `;
                updateStepStatus(1, 'success');
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Issues Found:</strong>
                        <ul class="mb-0 mt-2">
                            ${issues.map(issue => `<li>${issue}</li>`).join('')}
                        </ul>
                    </div>
                    ${fixes.length > 0 ? `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Recommended Fixes:</strong>
                        <ul class="mb-0 mt-2">
                            ${fixes.map(fix => `<li>${fix}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                `;
                updateStepStatus(1, 'warning');
            }
            
            log('Diagnosis completed', 'info');
            enableNextStep();
        }
        
        function applyFixes() {
            log('Applying comprehensive fixes...', 'info');
            updateStepStatus(2, 'warning');
            
            let fixesApplied = [];
            
            // Fix 1: Ensure users exist
            try {
                let users = JSON.parse(localStorage.getItem('users') || '[]');
                if (users.length === 0) {
                    const defaultUsers = [
                        {
                            id: 1,
                            username: 'admin',
                            password: 'admin123',
                            name: 'Administrator',
                            role: 'super_admin',
                            active: true,
                            createdAt: new Date().toISOString()
                        }
                    ];
                    localStorage.setItem('users', JSON.stringify(defaultUsers));
                    log('✓ Created default admin user', 'success');
                    fixesApplied.push('Created default admin user');
                }
            } catch (error) {
                log('✗ Failed to create default user', 'error');
            }
            
            // Fix 2: Override problematic functions if they don't exist
            if (typeof window.showMainApp !== 'function') {
                window.showMainApp = function() {
                    log('Custom showMainApp called', 'info');
                    try {
                        document.getElementById('loginPage').classList.add('d-none');
                        document.getElementById('mainApp').classList.remove('d-none');
                        
                        if (window.currentUser) {
                            const userEl = document.getElementById('currentUser');
                            const roleEl = document.getElementById('currentRole');
                            if (userEl) userEl.textContent = window.currentUser.name;
                            if (roleEl) roleEl.textContent = window.currentUser.role;
                        }
                        
                        if (typeof window.renderMenu === 'function') {
                            window.renderMenu();
                        }
                        
                        if (typeof window.navigateTo === 'function') {
                            window.navigateTo('dashboard');
                        }
                    } catch (error) {
                        log('Error in custom showMainApp: ' + error.message, 'error');
                    }
                };
                log('✓ Created custom showMainApp function', 'success');
                fixesApplied.push('Created custom showMainApp function');
            }
            
            // Fix 3: Override navigateTo if missing
            if (typeof window.navigateTo !== 'function') {
                window.navigateTo = function(page) {
                    log(`Custom navigateTo called: ${page}`, 'info');
                    window.currentPage = page;
                    if (typeof window.renderPage === 'function') {
                        window.renderPage(page);
                    } else {
                        const content = document.getElementById('mainContent');
                        if (content) {
                            content.innerHTML = `<h2>Welcome to ${page}</h2><p>Navigation successful!</p>`;
                        }
                    }
                };
                log('✓ Created custom navigateTo function', 'success');
                fixesApplied.push('Created custom navigateTo function');
            }
            
            // Fix 4: Override renderMenu if missing
            if (typeof window.renderMenu !== 'function') {
                window.renderMenu = function() {
                    log('Custom renderMenu called', 'info');
                    const menuList = document.getElementById('menuList');
                    if (menuList) {
                        menuList.innerHTML = `
                            <li class="nav-item">
                                <a class="nav-link" href="#" onclick="navigateTo('dashboard')">
                                    <i class="bi bi-speedometer2"></i> Dashboard
                                </a>
                            </li>
                        `;
                    }
                };
                log('✓ Created custom renderMenu function', 'success');
                fixesApplied.push('Created custom renderMenu function');
            }
            
            // Display fix results
            const resultDiv = document.getElementById('fix-result');
            if (fixesApplied.length > 0) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle me-2"></i>
                        <strong>Fixes Applied:</strong>
                        <ul class="mb-0 mt-2">
                            ${fixesApplied.map(fix => `<li>${fix}</li>`).join('')}
                        </ul>
                    </div>
                `;
                updateStepStatus(2, 'success');
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>No fixes needed:</strong> System is already in good state.
                    </div>
                `;
                updateStepStatus(2, 'success');
            }
            
            log('Fixes application completed', 'info');
            enableNextStep();
        }
        
        function testLogin() {
            log('Testing login functionality...', 'info');
            updateStepStatus(3, 'warning');
            
            try {
                // Simulate login process
                const testUser = {
                    id: 1,
                    username: 'admin',
                    name: 'Administrator',
                    role: 'super_admin'
                };
                
                window.currentUser = testUser;
                localStorage.setItem('currentUser', JSON.stringify(testUser));
                
                log('✓ Set current user', 'success');
                
                // Test showMainApp
                if (typeof window.showMainApp === 'function') {
                    window.showMainApp();
                    log('✓ showMainApp executed successfully', 'success');
                } else {
                    log('✗ showMainApp function not available', 'error');
                }
                
                // Check if navigation worked
                if (document.getElementById('mainApp').classList.contains('d-none')) {
                    log('✗ Main app is still hidden', 'error');
                } else {
                    log('✓ Main app is visible', 'success');
                }
                
                if (document.getElementById('loginPage').classList.contains('d-none')) {
                    log('✓ Login page is hidden', 'success');
                } else {
                    log('✗ Login page is still visible', 'error');
                }
                
                const resultDiv = document.getElementById('test-result');
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle me-2"></i>
                        <strong>Login Test Successful:</strong> Authentication flow is working correctly.
                    </div>
                `;
                updateStepStatus(3, 'success');
                
            } catch (error) {
                log('✗ Login test failed: ' + error.message, 'error');
                const resultDiv = document.getElementById('test-result');
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle me-2"></i>
                        <strong>Login Test Failed:</strong> ${error.message}
                    </div>
                `;
                updateStepStatus(3, 'error');
            }
            
            log('Login test completed', 'info');
            enableNextStep();
        }
        
        function verifySolution() {
            log('Verifying complete solution...', 'info');
            updateStepStatus(4, 'warning');
            
            let verificationPassed = true;
            let issues = [];
            
            // Check if main app is visible
            if (!document.getElementById('mainApp').classList.contains('d-none')) {
                log('✓ Main application is visible', 'success');
            } else {
                log('✗ Main application is not visible', 'error');
                verificationPassed = false;
                issues.push('Main application not visible');
            }
            
            // Check if login page is hidden
            if (document.getElementById('loginPage').classList.contains('d-none')) {
                log('✓ Login page is properly hidden', 'success');
            } else {
                log('✗ Login page is still visible', 'error');
                verificationPassed = false;
                issues.push('Login page still visible');
            }
            
            // Check current user
            if (window.currentUser) {
                log('✓ Current user is set', 'success');
            } else {
                log('✗ Current user is not set', 'error');
                verificationPassed = false;
                issues.push('Current user not set');
            }
            
            // Check URL
            const currentURL = window.location.href;
            log(`Current URL: ${currentURL}`, 'info');
            
            const resultDiv = document.getElementById('verify-result');
            if (verificationPassed) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle me-2"></i>
                        <strong>Verification Successful!</strong> 
                        <p class="mb-0 mt-2">The login routing issue has been resolved. Users will now be properly redirected to the dashboard after login.</p>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Next Steps:</strong>
                        <ol class="mb-0 mt-2">
                            <li>Test the actual login process in the main application</li>
                            <li>Verify that the fixes persist across page reloads</li>
                            <li>Monitor for any additional routing issues</li>
                        </ol>
                    </div>
                `;
                updateStepStatus(4, 'success');
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle me-2"></i>
                        <strong>Verification Failed:</strong>
                        <ul class="mb-0 mt-2">
                            ${issues.map(issue => `<li>${issue}</li>`).join('')}
                        </ul>
                    </div>
                `;
                updateStepStatus(4, 'error');
            }
            
            log('Solution verification completed', 'info');
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('Fix tool initialized', 'success');
        });
    </script>
</body>
</html>