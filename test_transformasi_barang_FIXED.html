<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEST - Transformasi Barang FIXED</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="alert alert-success">
                    <h4><i class="bi bi-check-circle me-2"></i>TEST PERBAIKAN TRANSFORMASI BARANG</h4>
                    <p>Memverifikasi bahwa dropdown tidak lagi menampilkan "undefined"</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5>Status Test</h5>
                    </div>
                    <div class="card-body">
                        <div id="test-results">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Testing...</span>
                            </div>
                            <span class="ms-2">Menjalankan test...</span>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header">
                        <h5>Form Test</h5>
                    </div>
                    <div class="card-body">
                        <!-- Source Item -->
                        <div class="mb-3">
                            <label for="sourceItem" class="form-label">Barang Asal</label>
                            <select class="form-select" id="sourceItem">
                                <option value="">Loading...</option>
                            </select>
                        </div>

                        <!-- Target Item -->
                        <div class="mb-3">
                            <label for="targetItem" class="form-label">Barang Tujuan</label>
                            <select class="form-select" id="targetItem">
                                <option value="">Loading...</option>
                            </select>
                        </div>

                        <!-- Quantity -->
                        <div class="mb-3">
                            <label for="quantity" class="form-label">Jumlah</label>
                            <input type="number" class="form-control" id="quantity" min="1" value="10">
                        </div>

                        <!-- Conversion Info -->
                        <div class="mb-3">
                            <label class="form-label">Info Konversi</label>
                            <div id="conversion-info" class="form-control bg-light" style="height: auto; min-height: 60px;">
                                <span class="text-muted">Pilih item untuk melihat info konversi</span>
                            </div>
                        </div>

                        <button type="button" class="btn btn-primary" onclick="runTest()">
                            <i class="bi bi-play-circle me-1"></i>Jalankan Test
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        console.log('ðŸ§ª Starting transformasi barang test...');

        // Sample data for testing
        const testData = [
            {
                kode: 'BRG001-KG',
                nama: 'Beras Premium (Kilogram)',
                satuan: 'kg',
                stok: 100,
                baseProduct: 'BRG001'
            },
            {
                kode: 'BRG001-GR',
                nama: 'Beras Premium (Gram)',
                satuan: 'gram',
                stok: 50000,
                baseProduct: 'BRG001'
            },
            {
                kode: 'BRG002-LT',
                nama: 'Minyak Goreng (Liter)',
                satuan: 'liter',
                stok: 50,
                baseProduct: 'BRG002'
            },
            {
                kode: 'BRG002-ML',
                nama: 'Minyak Goreng (Mililiter)',
                satuan: 'ml',
                stok: 25000,
                baseProduct: 'BRG002'
            }
        ];

        const testConversionRatios = [
            {
                baseProduct: 'BRG001',
                conversions: [
                    { from: 'kg', to: 'gram', ratio: 1000 },
                    { from: 'gram', to: 'kg', ratio: 0.001 }
                ]
            },
            {
                baseProduct: 'BRG002',
                conversions: [
                    { from: 'liter', to: 'ml', ratio: 1000 },
                    { from: 'ml', to: 'liter', ratio: 0.001 }
                ]
            }
        ];

        // Initialize test data
        function initializeTestData() {
            localStorage.setItem('masterBarang', JSON.stringify(testData));
            localStorage.setItem('conversionRatios', JSON.stringify(testConversionRatios));
            console.log('âœ… Test data initialized');
        }

        // Test dropdown population
        function testDropdownPopulation() {
            const sourceSelect = document.getElementById('sourceItem');
            const targetSelect = document.getElementById('targetItem');
            
            if (!sourceSelect || !targetSelect) {
                return { success: false, message: 'Dropdown elements not found' };
            }

            try {
                const masterBarang = JSON.parse(localStorage.getItem('masterBarang') || '[]');
                
                if (masterBarang.length === 0) {
                    return { success: false, message: 'No test data found' };
                }

                // Clear existing options
                sourceSelect.innerHTML = '<option value="">Pilih barang asal...</option>';
                targetSelect.innerHTML = '<option value="">Pilih barang tujuan...</option>';

                let undefinedCount = 0;
                let totalOptions = 0;

                // Populate dropdowns
                masterBarang.forEach(item => {
                    // Ensure all values are defined
                    const kode = item.kode || 'UNKNOWN';
                    const nama = item.nama || 'Unknown Item';
                    const satuan = item.satuan || 'unit';
                    const stok = (typeof item.stok === 'number' && !isNaN(item.stok)) ? item.stok : 0;

                    // Create option text
                    const optionText = `${nama} - Stok: ${stok} ${satuan}`;

                    // Check for undefined values
                    if (optionText.includes('undefined')) {
                        undefinedCount++;
                    }

                    // Source dropdown (only items with stock > 0)
                    if (stok > 0) {
                        const sourceOption = new Option(optionText, kode);
                        sourceOption.dataset.nama = nama;
                        sourceOption.dataset.satuan = satuan;
                        sourceOption.dataset.stok = stok.toString();
                        sourceOption.dataset.baseProduct = item.baseProduct || 'UNKNOWN';
                        sourceSelect.add(sourceOption);
                        totalOptions++;
                    }

                    // Target dropdown (all items)
                    const targetOption = new Option(optionText, kode);
                    targetOption.dataset.nama = nama;
                    targetOption.dataset.satuan = satuan;
                    targetOption.dataset.stok = stok.toString();
                    targetOption.dataset.baseProduct = item.baseProduct || 'UNKNOWN';
                    targetSelect.add(targetOption);
                    totalOptions++;
                });

                return {
                    success: true,
                    message: `Dropdown populated successfully`,
                    details: {
                        totalOptions: totalOptions,
                        undefinedCount: undefinedCount,
                        sourceOptions: sourceSelect.options.length - 1,
                        targetOptions: targetSelect.options.length - 1
                    }
                };

            } catch (error) {
                return { success: false, message: 'Error: ' + error.message };
            }
        }

        // Test conversion info
        function testConversionInfo() {
            const sourceSelect = document.getElementById('sourceItem');
            const targetSelect = document.getElementById('targetItem');
            const quantityInput = document.getElementById('quantity');
            const conversionInfo = document.getElementById('conversion-info');

            // Select first available options
            if (sourceSelect.options.length > 1) {
                sourceSelect.selectedIndex = 1;
            }
            if (targetSelect.options.length > 2) {
                targetSelect.selectedIndex = 2;
            }
            quantityInput.value = '10';

            // Trigger conversion info update
            updateConversionInfo();

            // Check if conversion info was updated
            const infoText = conversionInfo.innerHTML;
            const hasUndefined = infoText.includes('undefined');

            return {
                success: !hasUndefined,
                message: hasUndefined ? 'Conversion info contains undefined values' : 'Conversion info updated successfully',
                details: {
                    infoLength: infoText.length,
                    hasUndefined: hasUndefined
                }
            };
        }

        // Simple conversion info update function
        function updateConversionInfo() {
            const sourceSelect = document.getElementById('sourceItem');
            const targetSelect = document.getElementById('targetItem');
            const quantityInput = document.getElementById('quantity');
            const conversionInfo = document.getElementById('conversion-info');

            const sourceValue = sourceSelect.value;
            const targetValue = targetSelect.value;
            const quantity = parseFloat(quantityInput.value) || 0;

            if (!sourceValue || !targetValue) {
                conversionInfo.innerHTML = '<span class="text-muted">Pilih item untuk melihat info konversi</span>';
                return;
            }

            if (sourceValue === targetValue) {
                conversionInfo.innerHTML = '<span class="text-warning">Item sumber dan target tidak boleh sama</span>';
                return;
            }

            try {
                // Get item data from dropdown options
                const sourceOption = sourceSelect.selectedOptions[0];
                const targetOption = targetSelect.selectedOptions[0];

                const sourceNama = sourceOption.dataset.nama || 'Unknown';
                const targetNama = targetOption.dataset.nama || 'Unknown';
                const sourceSatuan = sourceOption.dataset.satuan || 'unit';
                const targetSatuan = targetOption.dataset.satuan || 'unit';
                const sourceStok = parseInt(sourceOption.dataset.stok) || 0;
                const targetStok = parseInt(targetOption.dataset.stok) || 0;
                const sourceBaseProduct = sourceOption.dataset.baseProduct || 'UNKNOWN';
                const targetBaseProduct = targetOption.dataset.baseProduct || 'UNKNOWN';

                if (sourceBaseProduct !== targetBaseProduct) {
                    conversionInfo.innerHTML = '<span class="text-warning">Item harus dari produk yang sama</span>';
                    return;
                }

                // Get conversion ratio
                let ratio = 1;
                const conversionRatios = JSON.parse(localStorage.getItem('conversionRatios') || '[]');
                const productRatios = conversionRatios.find(r => r.baseProduct === sourceBaseProduct);

                if (productRatios && productRatios.conversions) {
                    const conversion = productRatios.conversions.find(c => 
                        c.from === sourceSatuan && c.to === targetSatuan
                    );
                    if (conversion) {
                        ratio = conversion.ratio;
                    }
                }

                const targetQuantity = quantity * ratio;
                const stockSufficient = sourceStok >= quantity;

                conversionInfo.innerHTML = `
                    <div class="small">
                        <div class="mb-2">
                            <strong>Rasio:</strong> 1 ${sourceSatuan} = ${ratio} ${targetSatuan}
                        </div>
                        <div class="mb-2">
                            <strong>Hasil:</strong> ${quantity} ${sourceSatuan} â†’ ${targetQuantity.toFixed(3)} ${targetSatuan}
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <div class="badge bg-${stockSufficient ? 'success' : 'danger'}">
                                    ${sourceNama}: ${sourceStok} ${sourceSatuan}
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="badge bg-info">
                                    ${targetNama}: ${targetStok} ${targetSatuan}
                                </div>
                            </div>
                        </div>
                    </div>
                `;

            } catch (error) {
                conversionInfo.innerHTML = '<span class="text-danger">Error: ' + error.message + '</span>';
            }
        }

        // Run all tests
        function runTest() {
            console.log('ðŸ§ª Running comprehensive test...');
            
            const results = [];
            
            // Test 1: Initialize data
            initializeTestData();
            results.push({ name: 'Data Initialization', success: true, message: 'Test data initialized' });
            
            // Test 2: Dropdown population
            const dropdownTest = testDropdownPopulation();
            results.push({ name: 'Dropdown Population', ...dropdownTest });
            
            // Test 3: Conversion info
            const conversionTest = testConversionInfo();
            results.push({ name: 'Conversion Info', ...conversionTest });
            
            // Display results
            displayTestResults(results);
        }

        // Display test results
        function displayTestResults(results) {
            const container = document.getElementById('test-results');
            let html = '<div class="test-results">';
            
            let allPassed = true;
            
            results.forEach(test => {
                const statusClass = test.success ? 'success' : 'danger';
                const statusIcon = test.success ? 'check-circle' : 'x-circle';
                
                if (!test.success) allPassed = false;
                
                html += `
                    <div class="alert alert-${statusClass} py-2 mb-2">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-${statusIcon} me-2"></i>
                            <div class="flex-grow-1">
                                <strong>${test.name}:</strong> 
                                <span class="badge bg-${statusClass} ms-2">${test.success ? 'PASS' : 'FAIL'}</span>
                            </div>
                        </div>
                        <div class="mt-1">
                            <small>${test.message}</small>
                            ${test.details ? `<br><small class="text-muted">${JSON.stringify(test.details)}</small>` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += `
                <div class="alert alert-${allPassed ? 'success' : 'warning'} mt-3">
                    <h6><i class="bi bi-${allPassed ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                    ${allPassed ? 'SEMUA TEST BERHASIL!' : 'ADA TEST YANG GAGAL'}
                    </h6>
                    <p class="mb-0">
                        ${allPassed ? 
                            'Transformasi barang sudah diperbaiki dan tidak ada lagi nilai "undefined" di dropdown.' : 
                            'Masih ada masalah yang perlu diperbaiki.'
                        }
                    </p>
                </div>
            `;
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Auto-run test when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('âœ… DOM loaded, running auto-test...');
            setTimeout(runTest, 1000);
        });

        // Setup event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const sourceSelect = document.getElementById('sourceItem');
            const targetSelect = document.getElementById('targetItem');
            const quantityInput = document.getElementById('quantity');
            
            if (sourceSelect) {
                sourceSelect.addEventListener('change', updateConversionInfo);
            }
            
            if (targetSelect) {
                targetSelect.addEventListener('change', updateConversionInfo);
            }
            
            if (quantityInput) {
                quantityInput.addEventListener('input', updateConversionInfo);
            }
        });

        console.log('âœ… Test script loaded successfully!');
    </script>
</body>
</html>