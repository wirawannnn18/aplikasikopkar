<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transformasi Barang - Koperasi Karyawan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .transformation-card {
            border: 2px solid #e9ecef;
            border-radius: 15px;
            transition: all 0.3s ease;
        }
        .transformation-card:hover {
            border-color: #007bff;
            box-shadow: 0 4px 15px rgba(0,123,255,0.1);
        }
        .preview-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }
        .stock-info {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #007bff;
        }
        .conversion-arrow {
            font-size: 2rem;
            color: #007bff;
            text-align: center;
            margin: 10px 0;
        }
        .btn-transform {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-transform:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,123,255,0.3);
        }
        .history-table {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .filter-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #1b4332 0%, #2d6a4f 100%);">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-shop-window me-2"></i>Koperasi Karyawan
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html"><i class="bi bi-house me-1"></i>Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="transformasi_barang.html">
                            <i class="bi bi-arrow-left-right me-1"></i>Transformasi Barang
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle me-1"></i><span id="navUsername">User</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="logout()">
                                <i class="bi bi-box-arrow-right me-2"></i>Logout
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Main Content Area -->
            <div class="col-lg-8">
                <!-- Page Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2><i class="bi bi-arrow-left-right me-2"></i>Transformasi Barang</h2>
                        <p class="text-muted mb-0">Konversi barang antar unit dengan mudah dan akurat</p>
                    </div>
                    <div>
                        <button class="btn btn-outline-primary" onclick="refreshData()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Refresh Data
                        </button>
                    </div>
                </div>

                <!-- Alert Container -->
                <div id="alert-container"></div>
                <div id="success-container"></div>

                <!-- Transformation Form -->
                <div class="transformation-card p-4 mb-4">
                    <h4 class="mb-3"><i class="bi bi-plus-circle me-2"></i>Form Transformasi</h4>
                    
                    <form id="transformation-form">
                        <div class="row">
                            <!-- Source Item Selection -->
                            <div class="col-md-6 mb-3">
                                <label for="sourceItem" class="form-label">
                                    <i class="bi bi-box-seam me-1"></i>Item Sumber
                                </label>
                                <select class="form-select" id="sourceItem" required>
                                    <option value="">Pilih Item Sumber...</option>
                                </select>
                                <div class="form-text">Pilih item yang akan dikurangi stoknya</div>
                            </div>

                            <!-- Target Item Selection -->
                            <div class="col-md-6 mb-3">
                                <label for="targetItem" class="form-label">
                                    <i class="bi bi-bullseye me-1"></i>Item Target
                                </label>
                                <select class="form-select" id="targetItem" disabled required>
                                    <option value="">Pilih Item Target...</option>
                                </select>
                                <div class="form-text">Pilih item yang akan ditambah stoknya</div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Quantity Input -->
                            <div class="col-md-6 mb-3">
                                <label for="quantity" class="form-label">
                                    <i class="bi bi-123 me-1"></i>Jumlah Transformasi
                                </label>
                                <input type="number" class="form-control" id="quantity" 
                                       min="1" step="1" placeholder="Masukkan jumlah..." required>
                                <div class="form-text">Jumlah unit sumber yang akan ditransformasi</div>
                            </div>

                            <!-- Conversion Info Display -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i class="bi bi-calculator me-1"></i>Info Konversi
                                </label>
                                <div id="conversion-info" class="form-control bg-light" style="height: auto; min-height: 38px;">
                                    <span class="text-muted">Pilih item untuk melihat rasio konversi</span>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2 mb-3">
                            <button type="button" class="btn btn-transform" id="submit-transformation" disabled>
                                <i class="bi bi-arrow-repeat me-2"></i>Lakukan Transformasi
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="reset-form">
                                <i class="bi bi-arrow-counterclockwise me-2"></i>Reset Form
                            </button>
                        </div>
                    </form>

                    <!-- Loading Indicator -->
                    <div id="loading-indicator" class="text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Memproses transformasi...</p>
                    </div>
                </div>

                <!-- Preview Section -->
                <div id="preview-container" class="preview-section" style="display: none;">
                    <!-- Preview content will be populated by JavaScript -->
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Quick Stats -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Statistik Hari Ini</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="border-end">
                                    <h4 class="text-primary mb-1" id="today-transformations">0</h4>
                                    <small class="text-muted">Transformasi</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <h4 class="text-success mb-1" id="available-items">0</h4>
                                <small class="text-muted">Item Tersedia</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Transformations -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Transformasi Terbaru</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="showHistoryModal()">
                            <i class="bi bi-list-ul me-1"></i>Lihat Semua
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div id="recent-transformations" class="list-group list-group-flush">
                            <div class="list-group-item text-center text-muted py-4">
                                <i class="bi bi-inbox display-6 d-block mb-2"></i>
                                Belum ada transformasi hari ini
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-clock-history me-2"></i>Riwayat Transformasi
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Filter Section -->
                    <div class="filter-section mb-4">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Tanggal Mulai</label>
                                <input type="date" class="form-control" id="filter-start-date">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Tanggal Akhir</label>
                                <input type="date" class="form-control" id="filter-end-date">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Produk</label>
                                <select class="form-select" id="filter-product">
                                    <option value="">Semua Produk</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">User</label>
                                <select class="form-select" id="filter-user">
                                    <option value="">Semua User</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <button class="btn btn-primary" onclick="applyHistoryFilter()">
                                    <i class="bi bi-funnel me-1"></i>Terapkan Filter
                                </button>
                                <button class="btn btn-outline-secondary" onclick="clearHistoryFilter()">
                                    <i class="bi bi-x-circle me-1"></i>Reset Filter
                                </button>
                                <button class="btn btn-success ms-2" onclick="exportHistory()">
                                    <i class="bi bi-download me-1"></i>Export CSV
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- History Table -->
                    <div class="table-responsive">
                        <table class="table history-table">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID Transaksi</th>
                                    <th>Tanggal</th>
                                    <th>User</th>
                                    <th>Item Sumber</th>
                                    <th>Item Target</th>
                                    <th>Jumlah</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body">
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-4">
                                        <i class="bi bi-search display-6 d-block mb-2"></i>
                                        Memuat data riwayat...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Modal (Admin Only) -->
    <div class="modal fade" id="configModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-gear me-2"></i>Konfigurasi Rasio Konversi
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="config-content">
                        <!-- Configuration content will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-primary" onclick="saveConfiguration()">
                        <i class="bi bi-check-lg me-1"></i>Simpan Konfigurasi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/koperasi.js"></script>
    
    <!-- Transformasi Barang Modules -->
    <script src="js/transformasi-barang/types.js"></script>
    <script src="js/transformasi-barang/DataModels.js"></script>
    <script src="js/transformasi-barang/ValidationEngine.js"></script>
    <script src="js/transformasi-barang/ConversionCalculator.js"></script>
    <script src="js/transformasi-barang/StockManager.js"></script>
    <script src="js/transformasi-barang/AuditLogger.js"></script>
    <script src="js/transformasi-barang/ErrorHandler.js"></script>
    <script src="js/transformasi-barang/TransformationManager.js"></script>
    <script src="js/transformasi-barang/UIController.js"></script>
    <script src="js/transformasi-barang/ReportManager.js"></script>

    <!-- Transformasi Barang Initialization -->
    <script src="js/transformasiBarangInit.js"></script>
    
    <script>
        // Initialize application when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Mock user for testing if not available
                if (!window.currentUser) {
                    window.currentUser = { name: 'Test User', role: 'kasir' };
                    console.log('Using mock user for testing');
                }
                
                // Initialize sample data if not available
                initializeSampleDataIfNeeded();
                
                // Try to initialize transformasi barang system, but don't fail if it doesn't work
                try {
                    if (typeof initializeTransformasiBarang === 'function') {
                        initializeTransformasiBarang();
                    } else {
                        console.log('Using fallback initialization');
                        initializeFallbackSystem();
                    }
                } catch (initError) {
                    console.warn('Advanced system failed, using fallback:', initError);
                    initializeFallbackSystem();
                }
                
                // Load initial data
                loadInitialData();
                
                // Setup additional event listeners
                setupAdditionalEventListeners();
                
                // Update statistics
                updateStats();
                
                // Hide any loading messages and show success
                hideLoadingMessages();
                
            } catch (error) {
                console.error('Error initializing page:', error);
                showAlert(`Sistem dimuat dengan mode sederhana`, 'info');
                initializeFallbackSystem();
            }
        });

        /**
         * Initialize sample data if localStorage is empty
         */
        function initializeSampleDataIfNeeded() {
            const existingData = localStorage.getItem('masterBarang') || localStorage.getItem('barang');
            
            if (!existingData) {
                console.log('No existing data found, initializing sample data...');
                
                const sampleData = [
                    {
                        kode: 'BRG001-KG',
                        nama: 'Beras Premium (Kilogram)',
                        satuan: 'kg',
                        stok: 100,
                        baseProduct: 'BRG001'
                    },
                    {
                        kode: 'BRG001-GR',
                        nama: 'Beras Premium (Gram)',
                        satuan: 'gram',
                        stok: 50000,
                        baseProduct: 'BRG001'
                    },
                    {
                        kode: 'BRG002-LT',
                        nama: 'Minyak Goreng (Liter)',
                        satuan: 'liter',
                        stok: 50,
                        baseProduct: 'BRG002'
                    },
                    {
                        kode: 'BRG002-ML',
                        nama: 'Minyak Goreng (Mililiter)',
                        satuan: 'ml',
                        stok: 25000,
                        baseProduct: 'BRG002'
                    }
                ];

                const conversionRatios = [
                    {
                        baseProduct: 'BRG001',
                        conversions: [
                            { from: 'kg', to: 'gram', ratio: 1000 },
                            { from: 'gram', to: 'kg', ratio: 0.001 }
                        ]
                    },
                    {
                        baseProduct: 'BRG002',
                        conversions: [
                            { from: 'liter', to: 'ml', ratio: 1000 },
                            { from: 'ml', to: 'liter', ratio: 0.001 }
                        ]
                    }
                ];

                localStorage.setItem('masterBarang', JSON.stringify(sampleData));
                localStorage.setItem('barang', JSON.stringify(sampleData));
                localStorage.setItem('conversionRatios', JSON.stringify(conversionRatios));
                localStorage.setItem('currentUser', 'Test User');
                
                console.log('Sample data initialized successfully');
            }
        }

        /**
         * Load initial data for the page
         */
        async function loadInitialData() {
            try {
                // Load transformable items if components are initialized
                if (window.transformationManager) {
                    const transformableItems = await window.transformationManager.getTransformableItems();
                    console.log(`Loaded ${transformableItems.length} transformable items`);
                }
                
                // Load recent transformations
                if (window.auditLogger) {
                    const recentHistory = await window.auditLogger.getTransformationHistory({ limit: 10 });
                    displayRecentTransformations(recentHistory.data);
                }
                
            } catch (error) {
                console.error('Error loading initial data:', error);
                // Don't throw error, just log it
            }
        }

        /**
         * Setup additional event listeners for the page
         */
        function setupAdditionalEventListeners() {
            // History button
            const historyBtn = document.getElementById('showHistoryBtn');
            if (historyBtn) {
                historyBtn.addEventListener('click', showTransformationHistory);
            }
            
            // Help button  
            const helpBtn = document.getElementById('showHelpBtn');
            if (helpBtn) {
                helpBtn.addEventListener('click', showTransformationHelp);
            }
        }





        /**
         * Show transformation history modal
         */
        function showTransformationHistory() {
            // Implementation for showing history modal
            console.log('Show transformation history');
        }

        /**
         * Show transformation help modal
         */
        function showTransformationHelp() {
            // Implementation for showing help modal
            console.log('Show transformation help');
        }

        /**
         * Setup additional event listeners
         */
        function setupEventListeners() {
            // Check for admin role to show config button
            const userRole = getCurrentUserRole();
            if (userRole === 'admin' || userRole === 'superadmin') {
                addConfigButton();
            }

            // Auto-refresh data every 5 minutes
            setInterval(async () => {
                await updateStats();
                await loadRecentTransformations();
            }, 300000); // 5 minutes
        }

        /**
         * Add configuration button for admin users
         */
        function addConfigButton() {
            const headerActions = document.querySelector('.d-flex.justify-content-between .div:last-child');
            if (headerActions) {
                const configButton = document.createElement('button');
                configButton.className = 'btn btn-outline-warning ms-2';
                configButton.innerHTML = '<i class="bi bi-gear me-1"></i>Konfigurasi';
                configButton.onclick = showConfigModal;
                headerActions.appendChild(configButton);
            }
        }

        /**
         * Refresh all data
         */
        async function refreshData() {
            try {
                showAlert('Memperbarui data...', 'info');
                if (window.uiController && window.uiController.refreshData) {
                    await window.uiController.refreshData();
                }
                await loadInitialData();
                showAlert('Data berhasil diperbarui', 'success');
                
                // Auto-hide success message
                setTimeout(() => {
                    document.getElementById('alert-container').innerHTML = '';
                }, 3000);
            } catch (error) {
                console.error('Error refreshing data:', error);
                showAlert('Gagal memperbarui data', 'danger');
            }
        }

        /**
         * Display recent transformations
         */
        function displayRecentTransformations(transformations) {
            const container = document.getElementById('recent-transformations');
            if (!container || !transformations) return;
            
            if (transformations.length === 0) {
                container.innerHTML = `
                    <div class="list-group-item text-center text-muted py-4">
                        <i class="bi bi-inbox display-6 d-block mb-2"></i>
                        Belum ada transformasi hari ini
                    </div>
                `;
                return;
            }
            
            container.innerHTML = transformations.map(t => `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${t.sourceItem ? t.sourceItem.name : t.sourceName} → ${t.targetItem ? t.targetItem.name : t.targetName}</h6>
                            <p class="mb-1 small text-muted">
                                ${t.sourceItem ? t.sourceItem.quantity : t.quantity} ${t.sourceItem ? t.sourceItem.unit : ''} → 
                                ${t.targetItem ? t.targetItem.quantity : t.resultQuantity} ${t.targetItem ? t.targetItem.unit : ''}
                            </p>
                            <small class="text-muted">${new Date(t.timestamp).toLocaleTimeString('id-ID')}</small>
                        </div>
                        <span class="badge bg-${t.status === 'completed' ? 'success' : t.status === 'failed' ? 'danger' : 'success'}">
                            ${t.status === 'completed' ? 'Berhasil' : t.status === 'failed' ? 'Gagal' : 'Berhasil'}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        /**
         * Load recent transformations
         */
        async function loadRecentTransformations() {
            try {
                let history = [];
                
                // Try to get from transformation manager first
                if (window.transformationManager && window.transformationManager.getTransformationHistory) {
                    history = await window.transformationManager.getTransformationHistory();
                } else {
                    // Fallback to localStorage
                    history = JSON.parse(localStorage.getItem('transformationHistory') || '[]');
                }
                
                const today = new Date().toDateString();
                const todayTransformations = history.filter(t => 
                    new Date(t.timestamp).toDateString() === today
                ).slice(0, 5); // Last 5 transformations today

                displayRecentTransformations(todayTransformations);
            } catch (error) {
                console.error('Error loading recent transformations:', error);
                // Show empty state on error
                displayRecentTransformations([]);
            }
        }

        /**
         * Update today's transformation count
         */
        async function updateTodayTransformationCount() {
            try {
                let history = [];
                
                // Try to get from transformation manager first
                if (window.transformationManager && window.transformationManager.getTransformationHistory) {
                    history = await window.transformationManager.getTransformationHistory();
                } else {
                    // Fallback to localStorage
                    history = JSON.parse(localStorage.getItem('transformationHistory') || '[]');
                }
                
                const today = new Date().toDateString();
                const todayCount = history.filter(t => 
                    new Date(t.timestamp).toDateString() === today
                ).length;

                const todayElement = document.getElementById('today-transformations');
                if (todayElement) {
                    todayElement.textContent = todayCount;
                }
            } catch (error) {
                console.error('Error updating transformation count:', error);
                const todayElement = document.getElementById('today-transformations');
                if (todayElement) {
                    todayElement.textContent = '0';
                }
            }
        }

        /**
         * Update statistics
         */
        async function updateStats() {
            await updateTodayTransformationCount();
            
            try {
                let totalItems = 0;
                
                if (window.transformationManager && window.transformationManager.getTransformableItems) {
                    const transformableItems = await window.transformationManager.getTransformableItems();
                    totalItems = transformableItems.reduce((sum, group) => sum + group.items.length, 0);
                } else {
                    // Fallback to counting from localStorage
                    const barang = JSON.parse(localStorage.getItem('masterBarang') || localStorage.getItem('barang') || '[]');
                    totalItems = barang.length;
                }
                
                const availableItemsElement = document.getElementById('available-items');
                if (availableItemsElement) {
                    availableItemsElement.textContent = totalItems;
                }
            } catch (error) {
                console.error('Error updating stats:', error);
                const availableItemsElement = document.getElementById('available-items');
                if (availableItemsElement) {
                    availableItemsElement.textContent = '0';
                }
            }
        }

        /**
         * Show history modal
         */
        async function showHistoryModal() {
            try {
                const modal = new bootstrap.Modal(document.getElementById('historyModal'));
                await loadHistoryData();
                modal.show();
            } catch (error) {
                console.error('Error showing history modal:', error);
                showAlert('Gagal memuat riwayat transformasi', 'danger');
            }
        }

        /**
         * Load history data into modal
         */
        async function loadHistoryData() {
            try {
                let history = [];
                
                // Try to get from transformation manager first
                if (window.transformationManager && window.transformationManager.getTransformationHistory) {
                    history = await window.transformationManager.getTransformationHistory();
                } else {
                    // Fallback to localStorage
                    history = JSON.parse(localStorage.getItem('transformationHistory') || '[]');
                }
                
                const tbody = document.getElementById('history-table-body');
                
                if (history.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-muted py-4">
                                <i class="bi bi-inbox display-6 d-block mb-2"></i>
                                Belum ada riwayat transformasi
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = history.map(transformation => `
                    <tr>
                        <td><code>${transformation.id || 'N/A'}</code></td>
                        <td>${new Date(transformation.timestamp).toLocaleString('id-ID')}</td>
                        <td>${transformation.user || 'Unknown'}</td>
                        <td>${transformation.sourceItem ? 
                            `${transformation.sourceItem.quantity} ${transformation.sourceItem.unit} ${transformation.sourceItem.name}` :
                            `${transformation.quantity} ${transformation.sourceName}`
                        }</td>
                        <td>${transformation.targetItem ? 
                            `${transformation.targetItem.quantity} ${transformation.targetItem.unit} ${transformation.targetItem.name}` :
                            `${transformation.resultQuantity} ${transformation.targetName}`
                        }</td>
                        <td>1:${transformation.conversionRatio || transformation.ratio || '1'}</td>
                        <td><span class="badge bg-success">Berhasil</span></td>
                    </tr>
                `).join('');

                // Populate filter dropdowns
                populateHistoryFilters(history);
            } catch (error) {
                console.error('Error loading history data:', error);
                const tbody = document.getElementById('history-table-body');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-danger py-4">
                                <i class="bi bi-exclamation-triangle display-6 d-block mb-2"></i>
                                Gagal memuat riwayat transformasi
                            </td>
                        </tr>
                    `;
                }
            }
        }

        /**
         * Populate history filter dropdowns
         */
        function populateHistoryFilters(history) {
            try {
                // Populate product filter
                const products = [...new Set(history.map(h => {
                    if (h.sourceItem && h.sourceItem.baseProduct) {
                        return h.sourceItem.baseProduct;
                    }
                    if (h.sourceName) {
                        return h.sourceName.split(' ')[0]; // Use first word as base product
                    }
                    return 'Unknown';
                }))];
                
                const productSelect = document.getElementById('filter-product');
                if (productSelect) {
                    productSelect.innerHTML = '<option value="">Semua Produk</option>' +
                        products.map(product => `<option value="${product}">${product}</option>`).join('');
                }

                // Populate user filter
                const users = [...new Set(history.map(h => h.user || 'Unknown'))];
                const userSelect = document.getElementById('filter-user');
                if (userSelect) {
                    userSelect.innerHTML = '<option value="">Semua User</option>' +
                        users.map(user => `<option value="${user}">${user}</option>`).join('');
                }
            } catch (error) {
                console.error('Error populating history filters:', error);
            }
        }

        /**
         * Apply history filter
         */
        async function applyHistoryFilter() {
            // Implementation for filtering history
            console.log('Applying history filter...');
            // This would filter the history table based on selected criteria
        }

        /**
         * Clear history filter
         */
        function clearHistoryFilter() {
            document.getElementById('filter-start-date').value = '';
            document.getElementById('filter-end-date').value = '';
            document.getElementById('filter-product').value = '';
            document.getElementById('filter-user').value = '';
            loadHistoryData();
        }

        /**
         * Export history to CSV
         */
        async function exportHistory() {
            try {
                let csvData = '';
                
                if (window.reportManager && window.reportManager.exportTransformationHistory) {
                    csvData = await window.reportManager.exportTransformationHistory('csv');
                } else {
                    // Fallback: create CSV manually
                    const history = JSON.parse(localStorage.getItem('transformationHistory') || '[]');
                    const headers = ['ID Transaksi', 'Tanggal', 'User', 'Item Sumber', 'Item Target', 'Rasio', 'Status'];
                    const rows = history.map(h => [
                        h.id || 'N/A',
                        new Date(h.timestamp).toLocaleString('id-ID'),
                        h.user || 'Unknown',
                        h.sourceItem ? `${h.sourceItem.quantity} ${h.sourceItem.unit} ${h.sourceItem.name}` : `${h.quantity} ${h.sourceName}`,
                        h.targetItem ? `${h.targetItem.quantity} ${h.targetItem.unit} ${h.targetItem.name}` : `${h.resultQuantity} ${h.targetName}`,
                        `1:${h.conversionRatio || h.ratio || '1'}`,
                        'Berhasil'
                    ]);
                    
                    csvData = [headers, ...rows].map(row => 
                        row.map(cell => `"${cell}"`).join(',')
                    ).join('\n');
                }
                
                downloadCSV(csvData, 'riwayat_transformasi.csv');
                showAlert('Data berhasil diekspor', 'success');
            } catch (error) {
                console.error('Error exporting history:', error);
                showAlert('Gagal mengekspor data', 'danger');
            }
        }

        /**
         * Show configuration modal (admin only)
         */
        async function showConfigModal() {
            try {
                const modal = new bootstrap.Modal(document.getElementById('configModal'));
                await loadConfigurationData();
                modal.show();
            } catch (error) {
                console.error('Error showing config modal:', error);
                showAlert('Gagal memuat konfigurasi', 'danger');
            }
        }

        /**
         * Load configuration data
         */
        async function loadConfigurationData() {
            // Implementation for loading configuration
            const configContent = document.getElementById('config-content');
            configContent.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    Fitur konfigurasi rasio konversi akan segera tersedia.
                </div>
            `;
        }

        /**
         * Save configuration
         */
        async function saveConfiguration() {
            // Implementation for saving configuration
            console.log('Saving configuration...');
        }

        /**
         * Initialize fallback system when advanced system fails
         */
        function initializeFallbackSystem() {
            console.log('Initializing fallback transformation system...');
            
            // Load products for dropdowns
            loadProductsForTransformationFallback();
            
            // Setup basic event listeners
            setupFallbackEventListeners();
            
            showAlert('Sistem transformasi barang dimuat (mode sederhana)', 'success');
        }
        
        /**
         * Load products for transformation (fallback version)
         */
        function loadProductsForTransformationFallback() {
            try {
                const sourceSelect = document.getElementById('sourceItem');
                const targetSelect = document.getElementById('targetItem');
                
                if (!sourceSelect || !targetSelect) {
                    console.warn('Product select elements not found');
                    return;
                }
                
                const barang = JSON.parse(localStorage.getItem('masterBarang') || localStorage.getItem('barang') || '[]');
                
                sourceSelect.innerHTML = '<option value="">Pilih Item Sumber...</option>';
                targetSelect.innerHTML = '<option value="">Pilih Item Target...</option>';
                
                barang.forEach(item => {
                    if (item.stok > 0) {
                        const option = new Option(`${item.nama} (Stok: ${item.stok} ${item.satuan})`, item.kode || item.id);
                        sourceSelect.add(option.cloneNode(true));
                    }
                    
                    const targetOption = new Option(`${item.nama} (Stok: ${item.stok || 0} ${item.satuan})`, item.kode || item.id);
                    targetSelect.add(targetOption);
                });
                
                console.log(`Loaded ${barang.length} products for transformation (fallback)`);
            } catch (error) {
                console.error('Error loading products (fallback):', error);
            }
        }
        
        /**
         * Setup fallback event listeners
         */
        function setupFallbackEventListeners() {
            try {
                const sourceSelect = document.getElementById('sourceItem');
                const targetSelect = document.getElementById('targetItem');
                const quantityInput = document.getElementById('quantity');
                const submitButton = document.getElementById('submit-transformation');
                const resetButton = document.getElementById('reset-form');
                
                if (sourceSelect) {
                    sourceSelect.addEventListener('change', updateConversionInfoFallback);
                }
                
                if (targetSelect) {
                    targetSelect.addEventListener('change', updateConversionInfoFallback);
                }
                
                if (quantityInput) {
                    quantityInput.addEventListener('input', updateConversionInfoFallback);
                }
                
                if (submitButton) {
                    submitButton.addEventListener('click', processTransformationFallback);
                }
                
                if (resetButton) {
                    resetButton.addEventListener('click', resetTransformationForm);
                }
                
                console.log('Fallback event listeners setup completed');
            } catch (error) {
                console.error('Error setting up fallback event listeners:', error);
            }
        }
        
        /**
         * Update conversion info (fallback version)
         */
        function updateConversionInfoFallback() {
            try {
                const sourceSelect = document.getElementById('sourceItem');
                const targetSelect = document.getElementById('targetItem');
                const quantityInput = document.getElementById('quantity');
                const conversionInfo = document.getElementById('conversion-info');
                const submitButton = document.getElementById('submit-transformation');
                
                if (!sourceSelect || !targetSelect || !quantityInput || !conversionInfo) {
                    return;
                }
                
                const sourceValue = sourceSelect.value;
                const targetValue = targetSelect.value;
                const quantity = parseFloat(quantityInput.value) || 0;
                
                if (!sourceValue || !targetValue) {
                    conversionInfo.innerHTML = '<span class="text-muted">Pilih item untuk melihat rasio konversi</span>';
                    if (submitButton) submitButton.disabled = true;
                    return;
                }
                
                const barang = JSON.parse(localStorage.getItem('masterBarang') || localStorage.getItem('barang') || '[]');
                const sourceItem = barang.find(item => (item.kode || item.id) === sourceValue);
                const targetItem = barang.find(item => (item.kode || item.id) === targetValue);
                
                if (!sourceItem || !targetItem) {
                    conversionInfo.innerHTML = '<span class="text-danger">Item tidak ditemukan</span>';
                    if (submitButton) submitButton.disabled = true;
                    return;
                }
                
                if (sourceItem.baseProduct && targetItem.baseProduct && sourceItem.baseProduct !== targetItem.baseProduct) {
                    conversionInfo.innerHTML = '<span class="text-warning">Item harus dari produk yang sama</span>';
                    if (submitButton) submitButton.disabled = true;
                    return;
                }
                
                // Simple conversion ratio (1:1 by default, or from stored ratios)
                let ratio = 1;
                const conversionRatios = JSON.parse(localStorage.getItem('conversionRatios') || '{}');
                
                if (sourceItem.baseProduct && conversionRatios[sourceItem.baseProduct]) {
                    const ratioData = conversionRatios[sourceItem.baseProduct];
                    if (ratioData.conversions) {
                        const conversion = ratioData.conversions.find(c => 
                            c.from === sourceItem.satuan && c.to === targetItem.satuan
                        );
                        if (conversion) {
                            ratio = conversion.ratio;
                        }
                    }
                }
                
                const targetQuantity = quantity * ratio;
                
                conversionInfo.innerHTML = `
                    <div class="small">
                        <div><strong>Rasio:</strong> 1 ${sourceItem.satuan} = ${ratio} ${targetItem.satuan}</div>
                        ${quantity > 0 ? `<div><strong>Hasil:</strong> ${quantity} ${sourceItem.satuan} → ${targetQuantity} ${targetItem.satuan}</div>` : ''}
                    </div>
                `;
                
                const canSubmit = sourceValue && targetValue && quantity > 0 && sourceItem.stok >= quantity;
                if (submitButton) submitButton.disabled = !canSubmit;
                
            } catch (error) {
                console.error('Error updating conversion info (fallback):', error);
            }
        }
        
        /**
         * Process transformation (fallback version)
         */
        function processTransformationFallback() {
            try {
                const sourceSelect = document.getElementById('sourceItem');
                const targetSelect = document.getElementById('targetItem');
                const quantityInput = document.getElementById('quantity');
                
                if (!sourceSelect || !targetSelect || !quantityInput) {
                    showAlert('Form elements tidak ditemukan', 'danger');
                    return;
                }
                
                const sourceId = sourceSelect.value;
                const targetId = targetSelect.value;
                const quantity = parseFloat(quantityInput.value) || 0;
                
                if (!sourceId || !targetId) {
                    showAlert('Pilih item sumber dan target', 'warning');
                    return;
                }
                
                if (sourceId === targetId) {
                    showAlert('Item sumber dan target tidak boleh sama', 'warning');
                    return;
                }
                
                if (quantity <= 0) {
                    showAlert('Jumlah harus lebih dari 0', 'warning');
                    return;
                }
                
                const barang = JSON.parse(localStorage.getItem('masterBarang') || localStorage.getItem('barang') || '[]');
                const sourceItem = barang.find(item => (item.kode || item.id) === sourceId);
                const targetItem = barang.find(item => (item.kode || item.id) === targetId);
                
                if (!sourceItem || !targetItem) {
                    showAlert('Item tidak ditemukan', 'danger');
                    return;
                }
                
                if (sourceItem.stok < quantity) {
                    showAlert(`Stok ${sourceItem.nama} tidak mencukupi. Tersedia: ${sourceItem.stok} ${sourceItem.satuan}`, 'warning');
                    return;
                }
                
                // Get conversion ratio
                let ratio = 1;
                const conversionRatios = JSON.parse(localStorage.getItem('conversionRatios') || '{}');
                
                if (sourceItem.baseProduct && conversionRatios[sourceItem.baseProduct]) {
                    const ratioData = conversionRatios[sourceItem.baseProduct];
                    if (ratioData.conversions) {
                        const conversion = ratioData.conversions.find(c => 
                            c.from === sourceItem.satuan && c.to === targetItem.satuan
                        );
                        if (conversion) {
                            ratio = conversion.ratio;
                        }
                    }
                }
                
                const targetQuantity = quantity * ratio;
                
                if (!confirm(`Konfirmasi transformasi:\\n${quantity} ${sourceItem.satuan} ${sourceItem.nama} → ${targetQuantity} ${targetItem.satuan} ${targetItem.nama}\\n\\nLanjutkan?`)) {
                    return;
                }
                
                // Process transformation
                sourceItem.stok -= quantity;
                targetItem.stok = (targetItem.stok || 0) + targetQuantity;
                
                // Save updated items
                localStorage.setItem('masterBarang', JSON.stringify(barang));
                if (localStorage.getItem('barang')) {
                    localStorage.setItem('barang', JSON.stringify(barang));
                }
                
                // Log transformation
                const transformationRecord = {
                    id: 'TRF-' + Date.now(),
                    timestamp: new Date().toISOString(),
                    user: localStorage.getItem('currentUser') || 'Unknown',
                    sourceName: sourceItem.nama,
                    targetName: targetItem.nama,
                    quantity: quantity,
                    resultQuantity: targetQuantity,
                    ratio: ratio
                };
                
                const history = JSON.parse(localStorage.getItem('transformationHistory') || '[]');
                history.unshift(transformationRecord);
                localStorage.setItem('transformationHistory', JSON.stringify(history));
                
                // Reset form and reload data
                resetTransformationForm();
                loadProductsForTransformationFallback();
                loadRecentTransformations();
                updateStats();
                
                showAlert(`Transformasi berhasil! ${quantity} ${sourceItem.satuan} ${sourceItem.nama} → ${targetQuantity} ${targetItem.satuan} ${targetItem.nama}`, 'success');
                
            } catch (error) {
                console.error('Error processing transformation (fallback):', error);
                showAlert('Terjadi kesalahan saat memproses transformasi', 'danger');
            }
        }
        
        /**
         * Hide loading messages
         */
        function hideLoadingMessages() {
            // Remove any loading indicators or error messages
            const loadingElements = document.querySelectorAll('.loading, .spinner-border');
            loadingElements.forEach(el => el.remove());
            
            // Show the main content
            const mainContent = document.querySelector('.container-fluid');
            if (mainContent) {
                mainContent.style.display = 'block';
            }
        }

        /**
         * Show alert message
         */
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container');
            const alertId = 'alert-' + Date.now();
            
            alertContainer.innerHTML = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        /**
         * Download CSV file
         */
        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        /**
         * Get current user role
         */
        function getCurrentUserRole() {
            return localStorage.getItem('userRole') || 'kasir';
        }

        /**
         * Logout function
         */
        function logout() {
            if (confirm('Apakah Anda yakin ingin logout?')) {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('userRole');
                window.location.href = 'index.html';
            }
        }
    </script>

    <style>
        /* Additional CSS for auto-complete */
        .autocomplete-wrapper {
            position: relative;
        }
        
        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .autocomplete-suggestion {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .autocomplete-suggestion:hover {
            background-color: #f8f9fa;
        }
        
        .autocomplete-suggestion:last-child {
            border-bottom: none;
        }

        /* Loading animation */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .transformation-card {
                margin: 0 -15px;
                border-radius: 0;
            }
            
            .preview-section {
                margin: 0 -15px;
                border-radius: 0;
            }
        }
    </style>
</body>
</html>