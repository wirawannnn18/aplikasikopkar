<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transformasi Barang - Koperasi Karyawan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .transformation-card {
            border: 2px solid #e9ecef;
            border-radius: 15px;
            transition: all 0.3s ease;
        }
        .transformation-card:hover {
            border-color: #007bff;
            box-shadow: 0 4px 15px rgba(0,123,255,0.1);
        }
        .preview-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }
        .stock-info {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #007bff;
        }
        .conversion-arrow {
            font-size: 2rem;
            color: #007bff;
            text-align: center;
            margin: 10px 0;
        }
        .btn-transform {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-transform:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,123,255,0.3);
        }
        .history-table {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .filter-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #1b4332 0%, #2d6a4f 100%);">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-shop-window me-2"></i>Koperasi Karyawan
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html"><i class="bi bi-house me-1"></i>Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="transformasi_barang.html">
                            <i class="bi bi-arrow-left-right me-1"></i>Transformasi Barang
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle me-1"></i><span id="navUsername">User</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="logout()">
                                <i class="bi bi-box-arrow-right me-2"></i>Logout
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Main Content Area -->
            <div class="col-lg-8">
                <!-- Page Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2><i class="bi bi-arrow-left-right me-2"></i>Transformasi Barang</h2>
                        <p class="text-muted mb-0">Konversi barang antar unit dengan mudah dan akurat</p>
                    </div>
                    <div>
                        <button class="btn btn-outline-primary me-2" onclick="refreshData()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Refresh Data
                        </button>
                        <button class="btn btn-outline-warning" onclick="reloadTransformationScripts()" title="Muat ulang sistem jika ada masalah">
                            <i class="bi bi-bootstrap-reboot me-1"></i>Reload System
                        </button>
                    </div>
                </div>

                <!-- Alert Container -->
                <div id="alert-container"></div>
                <div id="success-container"></div>

                <!-- Transformation Form -->
                <div class="transformation-card p-4 mb-4">
                    <h4 class="mb-3"><i class="bi bi-plus-circle me-2"></i>Form Transformasi</h4>
                    
                    <form id="transformation-form">
                        <div class="row">
                            <!-- Source Item Selection -->
                            <div class="col-md-6 mb-3">
                                <label for="sourceItem" class="form-label">
                                    <i class="bi bi-box-seam me-1"></i>Item Sumber
                                </label>
                                <select class="form-select" id="sourceItem" required>
                                    <option value="">Pilih Item Sumber...</option>
                                </select>
                                <div class="form-text">Pilih item yang akan dikurangi stoknya</div>
                            </div>

                            <!-- Target Item Selection -->
                            <div class="col-md-6 mb-3">
                                <label for="targetItem" class="form-label">
                                    <i class="bi bi-bullseye me-1"></i>Item Target
                                </label>
                                <select class="form-select" id="targetItem" disabled required>
                                    <option value="">Pilih Item Target...</option>
                                </select>
                                <div class="form-text">Pilih item yang akan ditambah stoknya</div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Quantity Input -->
                            <div class="col-md-6 mb-3">
                                <label for="quantity" class="form-label">
                                    <i class="bi bi-123 me-1"></i>Jumlah Transformasi
                                </label>
                                <input type="number" class="form-control" id="quantity" 
                                       min="1" step="1" placeholder="Masukkan jumlah..." required>
                                <div class="form-text">Jumlah unit sumber yang akan ditransformasi</div>
                            </div>

                            <!-- Conversion Info Display -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i class="bi bi-calculator me-1"></i>Info Konversi
                                </label>
                                <div id="conversion-info" class="form-control bg-light" style="height: auto; min-height: 38px;">
                                    <span class="text-muted">Pilih item untuk melihat rasio konversi</span>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2 mb-3">
                            <button type="button" class="btn btn-transform" id="submit-transformation" disabled>
                                <i class="bi bi-arrow-repeat me-2"></i>Lakukan Transformasi
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="reset-form">
                                <i class="bi bi-arrow-counterclockwise me-2"></i>Reset Form
                            </button>
                        </div>
                    </form>

                    <!-- Loading Indicator -->
                    <div id="loading-indicator" class="text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Memproses transformasi...</p>
                    </div>
                </div>

                <!-- Preview Section -->
                <div id="preview-container" class="preview-section" style="display: none;">
                    <!-- Preview content will be populated by JavaScript -->
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Quick Stats -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Statistik Hari Ini</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="border-end">
                                    <h4 class="text-primary mb-1" id="today-transformations">0</h4>
                                    <small class="text-muted">Transformasi</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <h4 class="text-success mb-1" id="available-items">0</h4>
                                <small class="text-muted">Item Tersedia</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Transformations -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Transformasi Terbaru</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="showHistoryModal()">
                            <i class="bi bi-list-ul me-1"></i>Lihat Semua
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div id="recent-transformations" class="list-group list-group-flush">
                            <div class="list-group-item text-center text-muted py-4">
                                <i class="bi bi-inbox display-6 d-block mb-2"></i>
                                Belum ada transformasi hari ini
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-clock-history me-2"></i>Riwayat Transformasi
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Filter Section -->
                    <div class="filter-section mb-4">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Tanggal Mulai</label>
                                <input type="date" class="form-control" id="filter-start-date">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Tanggal Akhir</label>
                                <input type="date" class="form-control" id="filter-end-date">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Produk</label>
                                <select class="form-select" id="filter-product">
                                    <option value="">Semua Produk</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">User</label>
                                <select class="form-select" id="filter-user">
                                    <option value="">Semua User</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <button class="btn btn-primary" onclick="applyHistoryFilter()">
                                    <i class="bi bi-funnel me-1"></i>Terapkan Filter
                                </button>
                                <button class="btn btn-outline-secondary" onclick="clearHistoryFilter()">
                                    <i class="bi bi-x-circle me-1"></i>Reset Filter
                                </button>
                                <button class="btn btn-success ms-2" onclick="exportHistory()">
                                    <i class="bi bi-download me-1"></i>Export CSV
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- History Table -->
                    <div class="table-responsive">
                        <table class="table history-table">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID Transaksi</th>
                                    <th>Tanggal</th>
                                    <th>User</th>
                                    <th>Item Sumber</th>
                                    <th>Item Target</th>
                                    <th>Jumlah</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body">
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-4">
                                        <i class="bi bi-search display-6 d-block mb-2"></i>
                                        Memuat data riwayat...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Modal (Admin Only) -->
    <div class="modal fade" id="configModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-gear me-2"></i>Konfigurasi Rasio Konversi
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="config-content">
                        <!-- Configuration content will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-primary" onclick="saveConfiguration()">
                        <i class="bi bi-check-lg me-1"></i>Simpan Konfigurasi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/koperasi.js"></script>
    
    <!-- Transformasi Barang Modules -->
    <script src="js/transformasi-barang/types.js"></script>
    <script src="js/transformasi-barang/DataModels.js"></script>
    <script src="js/transformasi-barang/ValidationEngine.js"></script>
    <script src="js/transformasi-barang/ConversionCalculator.js"></script>
    <script src="js/transformasi-barang/StockManager.js"></script>
    <script src="js/transformasi-barang/AuditLogger.js"></script>
    <script src="js/transformasi-barang/ErrorHandler.js"></script>
    <script src="js/transformasi-barang/TransformationManager.js"></script>
    <script src="js/transformasi-barang/UIController.js"></script>
    <script src="js/transformasi-barang/ReportManager.js"></script>

    <!-- Transformasi Barang Initialization -->
    <script src="js/transformasiBarangInit.js"></script>
    
    <!-- EMERGENCY FIX: Element-safe loader for transformasi barang -->
    <script>
    (function() {
        'use strict';
        
        console.log('üîß Loading emergency fix for transformasi barang...');
        
        // PREVIEW VALIDATION FIX: Prevent repeated validation errors
        let lastValidationError = null;
        let errorCount = 0;
        const MAX_REPEATED_ERRORS = 2;
        const ERROR_RESET_TIME = 5000; // 5 seconds
        
        // Reset error count periodically
        setInterval(() => {
            if (errorCount > 0) {
                errorCount = Math.max(0, errorCount - 1);
            }
        }, ERROR_RESET_TIME);
        
        // Throttle function to prevent excessive validation calls
        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        }
        
        // Enhanced validation with error suppression
        function suppressRepeatedValidationErrors() {
            // Override console.error to suppress repeated validation errors
            const originalConsoleError = console.error;
            console.error = function(...args) {
                const message = args.join(' ');
                
                // Check if this is a repeated validation error
                if (message.includes('Preview tidak tersedia') || 
                    message.includes('Silakan lengkapi form terlebih dahulu')) {
                    
                    if (lastValidationError !== message || errorCount < MAX_REPEATED_ERRORS) {
                        if (lastValidationError !== message) {
                            errorCount = 0;
                        }
                        lastValidationError = message;
                        errorCount++;
                        
                        if (errorCount <= MAX_REPEATED_ERRORS) {
                            originalConsoleError.apply(console, args);
                        } else {
                            // Suppress repeated errors, just log once more with suppression notice
                            originalConsoleError.call(console, `[SUPPRESSED] ${message} (${errorCount - MAX_REPEATED_ERRORS} more suppressed)`);
                        }
                    }
                    return;
                }
                
                // For non-validation errors, log normally
                originalConsoleError.apply(console, args);
            };
        }
        
        // Apply error suppression immediately
        suppressRepeatedValidationErrors();
        
        // ADVANCED FIX: Intercept ErrorHandler logging
        function interceptErrorHandlerLogging() {
            // Wait for ErrorHandler to be available and patch its _logError method
            function patchErrorHandler() {
                if (window.ErrorHandler && window.ErrorHandler.prototype && window.ErrorHandler.prototype._logError) {
                    const originalLogError = window.ErrorHandler.prototype._logError;
                    
                    window.ErrorHandler.prototype._logError = function(errorInfo) {
                        // Check if this is a validation error we want to suppress
                        const errorMessage = errorInfo.originalError?.message || errorInfo.originalError || '';
                        
                        if (typeof errorMessage === 'string' && 
                            (errorMessage.includes('Preview tidak tersedia') || 
                             errorMessage.includes('Silakan lengkapi form terlebih dahulu'))) {
                            
                            // Apply the same suppression logic
                            if (lastValidationError !== errorMessage || errorCount < MAX_REPEATED_ERRORS) {
                                if (lastValidationError !== errorMessage) {
                                    errorCount = 0;
                                }
                                lastValidationError = errorMessage;
                                errorCount++;
                                
                                if (errorCount <= MAX_REPEATED_ERRORS) {
                                    return originalLogError.call(this, errorInfo);
                                } else {
                                    // Suppress the error logging
                                    console.log(`[SUPPRESSED] Validation error suppressed (${errorCount - MAX_REPEATED_ERRORS} more)`);
                                    return;
                                }
                            }
                            return; // Skip logging
                        }
                        
                        // For non-validation errors, log normally
                        return originalLogError.call(this, errorInfo);
                    };
                    
                    console.log('‚úÖ ErrorHandler._logError patched for validation suppression');
                }
            }
            
            // Try to patch immediately and with delays
            patchErrorHandler();
            setTimeout(patchErrorHandler, 1000);
            setTimeout(patchErrorHandler, 3000);
            setTimeout(patchErrorHandler, 5000);
        }
        
        // Apply ErrorHandler patching
        interceptErrorHandlerLogging();
        
        // ULTIMATE FIX: Intercept handleValidationError calls
        function interceptValidationErrorCalls() {
            function patchValidationMethods() {
                if (window.ErrorHandler && window.ErrorHandler.prototype) {
                    // Patch handleValidationError method
                    if (window.ErrorHandler.prototype.handleValidationError) {
                        const originalHandleValidationError = window.ErrorHandler.prototype.handleValidationError;
                        
                        window.ErrorHandler.prototype.handleValidationError = function(error, context = {}) {
                            const errorMessage = error?.message || error || '';
                            
                            // Suppress specific validation errors
                            if (typeof errorMessage === 'string' && 
                                (errorMessage.includes('Preview tidak tersedia') || 
                                 errorMessage.includes('Silakan lengkapi form terlebih dahulu'))) {
                                
                                // Apply suppression logic
                                if (lastValidationError !== errorMessage || errorCount < MAX_REPEATED_ERRORS) {
                                    if (lastValidationError !== errorMessage) {
                                        errorCount = 0;
                                    }
                                    lastValidationError = errorMessage;
                                    errorCount++;
                                    
                                    if (errorCount <= MAX_REPEATED_ERRORS) {
                                        return originalHandleValidationError.call(this, error, context);
                                    } else {
                                        // Return a suppressed response instead of logging
                                        return {
                                            success: false,
                                            category: 'validation',
                                            message: 'Form validation suppressed',
                                            suppressed: true,
                                            timestamp: new Date().toISOString()
                                        };
                                    }
                                }
                                
                                // Return suppressed response
                                return {
                                    success: false,
                                    category: 'validation',
                                    message: 'Form validation suppressed',
                                    suppressed: true,
                                    timestamp: new Date().toISOString()
                                };
                            }
                            
                            // For other errors, handle normally
                            return originalHandleValidationError.call(this, error, context);
                        };
                        
                        console.log('‚úÖ ErrorHandler.handleValidationError patched');
                    }
                }
            }
            
            // Try to patch with multiple attempts
            patchValidationMethods();
            setTimeout(patchValidationMethods, 1000);
            setTimeout(patchValidationMethods, 3000);
            setTimeout(patchValidationMethods, 5000);
        }
        
        // Apply validation method patching
        interceptValidationErrorCalls();
        
        // Initialize data if not exists
        function initializeDataIfNeeded() {
            let masterBarang = JSON.parse(localStorage.getItem('masterBarang') || '[]');
            
            if (masterBarang.length === 0) {
                console.log('üîÑ Initializing sample data...');
                masterBarang = [
                    {
                        kode: 'BRG001-KG',
                        nama: 'Beras Premium (Kilogram)',
                        satuan: 'kg',
                        stok: 100,
                        baseProduct: 'BRG001',
                        hargaBeli: 12000,
                        hargaJual: 15000
                    },
                    {
                        kode: 'BRG001-GR',
                        nama: 'Beras Premium (Gram)',
                        satuan: 'gram',
                        stok: 50000,
                        baseProduct: 'BRG001',
                        hargaBeli: 12,
                        hargaJual: 15
                    },
                    {
                        kode: 'BRG002-LT',
                        nama: 'Minyak Goreng (Liter)',
                        satuan: 'liter',
                        stok: 50,
                        baseProduct: 'BRG002',
                        hargaBeli: 18000,
                        hargaJual: 22000
                    },
                    {
                        kode: 'BRG002-ML',
                        nama: 'Minyak Goreng (Mililiter)',
                        satuan: 'ml',
                        stok: 25000,
                        baseProduct: 'BRG002',
                        hargaBeli: 18,
                        hargaJual: 22
                    },
                    {
                        kode: 'BRG003-DUS',
                        nama: 'Air Mineral (Dus)',
                        satuan: 'dus',
                        stok: 20,
                        baseProduct: 'BRG003',
                        hargaBeli: 48000,
                        hargaJual: 60000
                    },
                    {
                        kode: 'BRG003-BTL',
                        nama: 'Air Mineral (Botol)',
                        satuan: 'botol',
                        stok: 480,
                        baseProduct: 'BRG003',
                        hargaBeli: 2000,
                        hargaJual: 2500
                    }
                ];
                
                const conversionRatios = [
                    {
                        baseProduct: 'BRG001',
                        conversions: [
                            { from: 'kg', to: 'gram', ratio: 1000 },
                            { from: 'gram', to: 'kg', ratio: 0.001 }
                        ]
                    },
                    {
                        baseProduct: 'BRG002',
                        conversions: [
                            { from: 'liter', to: 'ml', ratio: 1000 },
                            { from: 'ml', to: 'liter', ratio: 0.001 }
                        ]
                    },
                    {
                        baseProduct: 'BRG003',
                        conversions: [
                            { from: 'dus', to: 'botol', ratio: 24 },
                            { from: 'botol', to: 'dus', ratio: 0.041667 }
                        ]
                    }
                ];
                
                localStorage.setItem('masterBarang', JSON.stringify(masterBarang));
                localStorage.setItem('barang', JSON.stringify(masterBarang));
                localStorage.setItem('conversionRatios', JSON.stringify(conversionRatios));
                console.log('‚úÖ Sample data initialized');
            }
        }
        
        // Function to populate dropdowns safely
        function populateDropdownsSafe() {
            const sourceSelect = document.getElementById('sourceItem');
            const targetSelect = document.getElementById('targetItem');
            
            if (!sourceSelect || !targetSelect) {
                console.warn('Dropdown elements not found, retrying in 500ms...');
                setTimeout(populateDropdownsSafe, 500);
                return;
            }
            
            console.log('‚úÖ Dropdown elements found, populating...');
            
            try {
                const masterBarang = JSON.parse(localStorage.getItem('masterBarang') || '[]');
                
                if (masterBarang.length === 0) {
                    console.warn('No master barang data found');
                    return;
                }
                
                // Clear existing options
                sourceSelect.innerHTML = '<option value="">Pilih barang asal...</option>';
                targetSelect.innerHTML = '<option value="">Pilih barang tujuan...</option>';
                
                // Group by base product
                const baseProducts = {};
                masterBarang.forEach(item => {
                    const baseProduct = item.baseProduct || item.kode.split('-')[0];
                    if (!baseProducts[baseProduct]) {
                        baseProducts[baseProduct] = [];
                    }
                    baseProducts[baseProduct].push(item);
                });
                
                // Populate dropdowns
                Object.entries(baseProducts).forEach(([baseProduct, items]) => {
                    if (items.length > 1) {
                        items.forEach(item => {
                            if (item.stok > 0) {
                                const sourceOption = new Option(
                                    `${item.nama} (Stok: ${item.stok} ${item.satuan})`, 
                                    item.kode
                                );
                                sourceSelect.add(sourceOption);
                            }
                            
                            const targetOption = new Option(
                                `${item.nama} (Stok: ${item.stok} ${item.satuan})`, 
                                item.kode
                            );
                            targetSelect.add(targetOption);
                        });
                    }
                });
                
                targetSelect.disabled = false;
                console.log(`‚úÖ Dropdowns populated: ${sourceSelect.options.length - 1} source, ${targetSelect.options.length - 1} target options`);
                
                // Setup event listeners
                sourceSelect.addEventListener('change', updateConversionInfo);
                targetSelect.addEventListener('change', updateConversionInfo);
                const quantityInput = document.getElementById('quantity');
                if (quantityInput) {
                    quantityInput.addEventListener('input', updateConversionInfo);
                }
                
                // Update statistics
                const availableItemsElement = document.getElementById('available-items');
                if (availableItemsElement) {
                    availableItemsElement.textContent = masterBarang.length;
                }
                
                // Show success message
                showAlert('Sistem transformasi barang berhasil dimuat!', 'success');
                
            } catch (error) {
                console.error('‚ùå Error populating dropdowns:', error);
            }
        }
        
        // Update conversion info function with enhanced stock integration
        async function updateConversionInfo() {
            const sourceSelect = document.getElementById('sourceItem');
            const targetSelect = document.getElementById('targetItem');
            const quantityInput = document.getElementById('quantity');
            const conversionInfo = document.getElementById('conversion-info');
            const submitButton = document.getElementById('submit-transformation');
            
            if (!sourceSelect || !targetSelect || !quantityInput || !conversionInfo) {
                return;
            }
            
            const sourceValue = sourceSelect.value;
            const targetValue = targetSelect.value;
            const quantity = parseFloat(quantityInput.value) || 0;
            
            if (!sourceValue || !targetValue) {
                conversionInfo.innerHTML = '<span class="text-muted">Pilih item untuk melihat rasio konversi</span>';
                if (submitButton) submitButton.disabled = true;
                return;
            }
            
            try {
                // Initialize StockManager if needed
                if (!window.stockManager) {
                    window.stockManager = new StockManager();
                    window.stockManager.initialize();
                }
                
                const masterBarang = JSON.parse(localStorage.getItem('masterBarang') || '[]');
                const sourceItem = masterBarang.find(item => item.kode === sourceValue);
                const targetItem = masterBarang.find(item => item.kode === targetValue);
                
                if (!sourceItem || !targetItem) {
                    conversionInfo.innerHTML = '<span class="text-danger">Item tidak ditemukan</span>';
                    if (submitButton) submitButton.disabled = true;
                    return;
                }
                
                const sourceBaseProduct = sourceItem.baseProduct || sourceItem.kode.split('-')[0];
                const targetBaseProduct = targetItem.baseProduct || targetItem.kode.split('-')[0];
                
                if (sourceBaseProduct !== targetBaseProduct) {
                    conversionInfo.innerHTML = '<span class="text-warning">Item harus dari produk yang sama</span>';
                    if (submitButton) submitButton.disabled = true;
                    return;
                }
                
                if (sourceValue === targetValue) {
                    conversionInfo.innerHTML = '<span class="text-warning">Item sumber dan target tidak boleh sama</span>';
                    if (submitButton) submitButton.disabled = true;
                    return;
                }
                
                // Get real-time stock from StockManager
                const currentSourceStock = await window.stockManager.getStockBalance(sourceValue);
                const currentTargetStock = await window.stockManager.getStockBalance(targetValue);
                
                let ratio = 1;
                const conversionRatios = JSON.parse(localStorage.getItem('conversionRatios') || '[]');
                const productRatios = conversionRatios.find(r => r.baseProduct === sourceBaseProduct);
                
                if (productRatios && productRatios.conversions) {
                    const conversion = productRatios.conversions.find(c => 
                        c.from === sourceItem.satuan && c.to === targetItem.satuan
                    );
                    if (conversion) {
                        ratio = conversion.ratio;
                    }
                }
                
                const targetQuantity = quantity * ratio;
                const stockSufficient = currentSourceStock >= quantity;
                const newSourceStock = currentSourceStock - quantity;
                const newTargetStock = currentTargetStock + targetQuantity;
                
                conversionInfo.innerHTML = `
                    <div class="small">
                        <div class="row mb-2">
                            <div class="col-12">
                                <strong>Rasio Konversi:</strong> 1 ${sourceItem.satuan} = ${ratio} ${targetItem.satuan}
                            </div>
                        </div>
                        ${quantity > 0 ? `
                        <div class="row mb-2">
                            <div class="col-12">
                                <strong>Hasil Konversi:</strong> ${quantity} ${sourceItem.satuan} ‚Üí ${targetQuantity.toFixed(3)} ${targetItem.satuan}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <div class="text-center p-2 border rounded">
                                    <div class="fw-bold text-primary">Stok Sumber</div>
                                    <div class="small">${sourceItem.nama}</div>
                                    <div class="badge bg-${stockSufficient ? 'success' : 'danger'} mb-1">
                                        ${currentSourceStock} ${sourceItem.satuan}
                                    </div>
                                    <div class="small">
                                        Setelah: <span class="fw-bold ${newSourceStock >= 0 ? 'text-success' : 'text-danger'}">${newSourceStock} ${sourceItem.satuan}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center p-2 border rounded">
                                    <div class="fw-bold text-success">Stok Target</div>
                                    <div class="small">${targetItem.nama}</div>
                                    <div class="badge bg-info mb-1">
                                        ${currentTargetStock} ${targetItem.satuan}
                                    </div>
                                    <div class="small">
                                        Setelah: <span class="fw-bold text-success">${newTargetStock.toFixed(3)} ${targetItem.satuan}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        ` : `
                        <div class="row">
                            <div class="col-6">
                                <span class="badge bg-${stockSufficient ? 'success' : 'danger'}">
                                    Stok ${sourceItem.nama}: ${currentSourceStock} ${sourceItem.satuan}
                                </span>
                            </div>
                            <div class="col-6">
                                <span class="badge bg-info">
                                    Stok ${targetItem.nama}: ${currentTargetStock} ${targetItem.satuan}
                                </span>
                            </div>
                        </div>
                        `}
                    </div>
                `;
                
                if (submitButton) {
                    const canSubmit = sourceValue && targetValue && quantity > 0 && stockSufficient && sourceValue !== targetValue;
                    submitButton.disabled = !canSubmit;
                }
                
            } catch (error) {
                console.error('‚ùå Error updating conversion info:', error);
                conversionInfo.innerHTML = '<span class="text-danger">Error memuat info konversi</span>';
            }
        }
        
        // Show alert function
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container') || document.getElementById('success-container');
            if (alertContainer) {
                const alertHtml = `
                    <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                        <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                alertContainer.innerHTML = alertHtml;
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    alertContainer.innerHTML = '';
                }, 5000);
            }
        }
        
        // Make function global
        window.updateConversionInfo = updateConversionInfo;
        
        // Initialize data first
        initializeDataIfNeeded();
        
        // Start population when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', populateDropdownsSafe);
        } else {
            populateDropdownsSafe();
        }
        
        // Also try after delays to ensure elements are loaded
        setTimeout(populateDropdownsSafe, 1000);
        setTimeout(populateDropdownsSafe, 3000);
        
        console.log('üîß Emergency fix loaded and ready!');
        
        // PATCH UIController to prevent repeated validation errors
        function patchUIControllerValidation() {
            // Wait for UIController to be available
            if (typeof window.UIController !== 'undefined') {
                console.log('üîß Patching UIController validation methods...');
                
                // Create a throttled validation function
                const throttledValidation = throttle(function(formData) {
                    if (!formData || !formData.sourceItem || !formData.targetItem || !formData.quantity) {
                        // Only log validation errors occasionally, not repeatedly
                        if (errorCount <= MAX_REPEATED_ERRORS) {
                            console.log('‚ÑπÔ∏è Form validation: Preview not available (form incomplete)');
                        }
                        return false;
                    }
                    return true;
                }, 1000); // Throttle to max once per second
                
                // Store original methods if they exist
                const originalUIControllerMethods = {};
                
                // Patch UIController prototype if available
                if (window.UIController.prototype) {
                    // Patch _updatePreview method
                    if (window.UIController.prototype._updatePreview) {
                        originalUIControllerMethods._updatePreview = window.UIController.prototype._updatePreview;
                        window.UIController.prototype._updatePreview = async function() {
                            try {
                                const formData = this._getFormData ? this._getFormData() : {};
                                
                                // Use throttled validation
                                if (throttledValidation(formData)) {
                                    return await originalUIControllerMethods._updatePreview.call(this);
                                } else {
                                    // Silently skip preview update if form is incomplete
                                    return;
                                }
                            } catch (error) {
                                // Suppress validation errors, only log system errors
                                if (!error.message.includes('Preview tidak tersedia')) {
                                    console.warn('‚ö†Ô∏è Preview update error:', error.message);
                                }
                            }
                        };
                    }
                    
                    // Patch _handleFormSubmission method
                    if (window.UIController.prototype._handleFormSubmission) {
                        originalUIControllerMethods._handleFormSubmission = window.UIController.prototype._handleFormSubmission;
                        window.UIController.prototype._handleFormSubmission = async function() {
                            try {
                                if (!this.currentPreview) {
                                    // Show user-friendly message instead of logging error
                                    const alertContainer = document.getElementById('alert-container');
                                    if (alertContainer) {
                                        alertContainer.innerHTML = `
                                            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                                                <i class="bi bi-exclamation-triangle me-2"></i>
                                                Silakan lengkapi form transformasi terlebih dahulu.
                                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                            </div>
                                        `;
                                    }
                                    return;
                                }
                                
                                return await originalUIControllerMethods._handleFormSubmission.call(this);
                            } catch (error) {
                                console.error('‚ùå Form submission error:', error);
                                throw error;
                            }
                        };
                    }
                    
                    console.log('‚úÖ UIController validation methods patched');
                }
            }
        }
        
        // Apply patches when UIController is available
        function applyUIControllerPatches() {
            patchUIControllerValidation();
            
            // Also try after delays in case UIController loads later
            setTimeout(patchUIControllerValidation, 1000);
            setTimeout(patchUIControllerValidation, 3000);
            setTimeout(patchUIControllerValidation, 5000);
        }
        
        // Initialize patches
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', applyUIControllerPatches);
        } else {
            applyUIControllerPatches();
        }
        
    })();
    </script>
    
    <script>
        // Global flag to track initialization status
        let systemInitialized = false;
        let initializationAttempts = 0;
        const maxInitializationAttempts = 3;

        // Initialize application when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, starting initialization...');
            attemptSystemInitialization();
        });

        /**
         * Attempt to initialize the system with retry logic
         */
        function attemptSystemInitialization() {
            initializationAttempts++;
            console.log(`Initialization attempt ${initializationAttempts}/${maxInitializationAttempts}`);
            
            try {
                // Mock user for testing if not available
                if (!window.currentUser) {
                    window.currentUser = { name: 'Test User', role: 'kasir' };
                    console.log('Using mock user for testing');
                }
                
                // Initialize sample data if not available
                initializeSampleDataIfNeeded();
                
                // Check if all required classes are loaded
                const requiredClasses = [
                    'TransformationManager', 'UIController', 'ValidationEngine',
                    'StockManager', 'AuditLogger', 'ErrorHandler', 'ConversionCalculator'
                ];
                
                const missingClasses = requiredClasses.filter(className => typeof window[className] !== 'function');
                
                if (missingClasses.length > 0) {
                    console.warn('Missing classes:', missingClasses);
                    
                    if (initializationAttempts < maxInitializationAttempts) {
                        console.log('Retrying initialization in 1 second...');
                        setTimeout(attemptSystemInitialization, 1000);
                        return;
                    } else {
                        throw new Error(`Tidak semua file JavaScript transformasi barang berhasil dimuat. Missing: ${missingClasses.join(', ')}`);
                    }
                }
                
                // Try to initialize transformasi barang system
                if (typeof initializeTransformasiBarang === 'function') {
                    console.log('Initializing advanced transformation system...');
                    initializeTransformasiBarang();
                    systemInitialized = true;
                    showAlert('Sistem transformasi barang berhasil dimuat', 'success');
                } else {
                    throw new Error('initializeTransformasiBarang function not available');
                }
                
                // Load initial data
                loadInitialData();
                
                // Setup additional event listeners
                setupAdditionalEventListeners();
                
                // Update statistics
                updateStats();
                
                // Hide any loading messages
                hideLoadingMessages();
                
                console.log('System initialization completed successfully');
                
            } catch (error) {
                console.error('Error initializing system:', error);
                
                if (initializationAttempts < maxInitializationAttempts) {
                    console.log('Retrying initialization in 2 seconds...');
                    setTimeout(attemptSystemInitialization, 2000);
                } else {
                    console.log('Max initialization attempts reached, using fallback system');
                    showAlert(`${error.message}. Menggunakan sistem sederhana.`, 'warning');
                    initializeFallbackSystem();
                }
            }
        }

        /**
         * Initialize sample data if localStorage is empty
         */
        function initializeSampleDataIfNeeded() {
            // Cek apakah ada data barang di localStorage
            let hasData = false;
            const dataSources = ['masterBarang', 'barang', 'stokBarang', 'produk'];
            
            for (const source of dataSources) {
                try {
                    const data = localStorage.getItem(source);
                    if (data) {
                        const parsedData = JSON.parse(data);
                        if (Array.isArray(parsedData) && parsedData.length > 0) {
                            hasData = true;
                            console.log(`Data barang ditemukan di ${source}: ${parsedData.length} items`);
                            break;
                        }
                    }
                } catch (e) {
                    console.warn(`Error checking data in ${source}:`, e);
                }
            }
            
            if (!hasData) {
                console.log('Tidak ada data barang ditemukan, menginisialisasi data sample...');
                
                const sampleData = [
                    // Beras Premium - Contoh transformasi KG ke Gram
                    {
                        kode: 'BRG001-KG',
                        nama: 'Beras Premium (Kilogram)',
                        satuan: 'kg',
                        stok: 100,
                        baseProduct: 'BRG001',
                        hargaBeli: 12000,
                        hargaJual: 15000
                    },
                    {
                        kode: 'BRG001-GR',
                        nama: 'Beras Premium (Gram)',
                        satuan: 'gram',
                        stok: 50000,
                        baseProduct: 'BRG001',
                        hargaBeli: 12,
                        hargaJual: 15
                    },
                    // Minyak Goreng - Contoh transformasi Liter ke Mililiter
                    {
                        kode: 'BRG002-LT',
                        nama: 'Minyak Goreng (Liter)',
                        satuan: 'liter',
                        stok: 50,
                        baseProduct: 'BRG002',
                        hargaBeli: 18000,
                        hargaJual: 22000
                    },
                    {
                        kode: 'BRG002-ML',
                        nama: 'Minyak Goreng (Mililiter)',
                        satuan: 'ml',
                        stok: 25000,
                        baseProduct: 'BRG002',
                        hargaBeli: 18,
                        hargaJual: 22
                    },
                    // Air Mineral - Contoh transformasi Dus ke Botol (1 dus = 24 botol)
                    {
                        kode: 'BRG003-DUS',
                        nama: 'Air Mineral (Dus)',
                        satuan: 'dus',
                        stok: 20,
                        baseProduct: 'BRG003',
                        hargaBeli: 48000,
                        hargaJual: 60000
                    },
                    {
                        kode: 'BRG003-BTL',
                        nama: 'Air Mineral (Botol)',
                        satuan: 'botol',
                        stok: 480,
                        baseProduct: 'BRG003',
                        hargaBeli: 2000,
                        hargaJual: 2500
                    },
                    // Gula Pasir - Contoh transformasi Karung ke Kilogram (1 karung = 50 kg)
                    {
                        kode: 'BRG004-KRG',
                        nama: 'Gula Pasir (Karung)',
                        satuan: 'karung',
                        stok: 10,
                        baseProduct: 'BRG004',
                        hargaBeli: 650000,
                        hargaJual: 750000
                    },
                    {
                        kode: 'BRG004-KG',
                        nama: 'Gula Pasir (Kilogram)',
                        satuan: 'kg',
                        stok: 200,
                        baseProduct: 'BRG004',
                        hargaBeli: 13000,
                        hargaJual: 15000
                    },
                    // Tepung Terigu - Contoh transformasi Sak ke Kilogram (1 sak = 25 kg)
                    {
                        kode: 'BRG005-SAK',
                        nama: 'Tepung Terigu (Sak)',
                        satuan: 'sak',
                        stok: 15,
                        baseProduct: 'BRG005',
                        hargaBeli: 300000,
                        hargaJual: 350000
                    },
                    {
                        kode: 'BRG005-KG',
                        nama: 'Tepung Terigu (Kilogram)',
                        satuan: 'kg',
                        stok: 150,
                        baseProduct: 'BRG005',
                        hargaBeli: 12000,
                        hargaJual: 14000
                    }
                ];

                const conversionRatios = [
                    {
                        baseProduct: 'BRG001',
                        conversions: [
                            { from: 'kg', to: 'gram', ratio: 1000 },
                            { from: 'gram', to: 'kg', ratio: 0.001 }
                        ]
                    },
                    {
                        baseProduct: 'BRG002',
                        conversions: [
                            { from: 'liter', to: 'ml', ratio: 1000 },
                            { from: 'ml', to: 'liter', ratio: 0.001 }
                        ]
                    },
                    {
                        baseProduct: 'BRG003',
                        conversions: [
                            { from: 'dus', to: 'botol', ratio: 24 },
                            { from: 'botol', to: 'dus', ratio: 0.041667 }
                        ]
                    }
                ];

                // Simpan ke semua kemungkinan key localStorage
                localStorage.setItem('masterBarang', JSON.stringify(sampleData));
                localStorage.setItem('barang', JSON.stringify(sampleData));
                localStorage.setItem('conversionRatios', JSON.stringify(conversionRatios));
                localStorage.setItem('currentUser', 'Test User');
                
                console.log('Data sample berhasil diinisialisasi dengan', sampleData.length, 'items');
                showAlert('Data sample barang berhasil dimuat untuk testing', 'info');
            }
        }

        /**
         * Load initial data for the page
         */
        async function loadInitialData() {
            try {
                // Load transformable items if components are initialized
                if (window.transformationManager) {
                    const transformableItems = await window.transformationManager.getTransformableItems();
                    console.log(`Loaded ${transformableItems.length} transformable items`);
                }
                
                // Load recent transformations
                if (window.auditLogger) {
                    const recentHistory = await window.auditLogger.getTransformationHistory({ limit: 10 });
                    displayRecentTransformations(recentHistory.data);
                }
                
            } catch (error) {
                console.error('Error loading initial data:', error);
                // Don't throw error, just log it
            }
        }

        /**
         * Setup additional event listeners for the page
         */
        function setupAdditionalEventListeners() {
            // History button
            const historyBtn = document.getElementById('showHistoryBtn');
            if (historyBtn) {
                historyBtn.addEventListener('click', showTransformationHistory);
            }
            
            // Help button  
            const helpBtn = document.getElementById('showHelpBtn');
            if (helpBtn) {
                helpBtn.addEventListener('click', showTransformationHelp);
            }
        }





        /**
         * Show transformation history modal
         */
        function showTransformationHistory() {
            // Implementation for showing history modal
            console.log('Show transformation history');
        }

        /**
         * Show transformation help modal
         */
        function showTransformationHelp() {
            // Implementation for showing help modal
            console.log('Show transformation help');
        }

        /**
         * Setup additional event listeners
         */
        function setupEventListeners() {
            // Check for admin role to show config button
            const userRole = getCurrentUserRole();
            if (userRole === 'admin' || userRole === 'superadmin') {
                addConfigButton();
            }

            // Auto-refresh data every 5 minutes
            setInterval(async () => {
                await updateStats();
                await loadRecentTransformations();
            }, 300000); // 5 minutes
        }

        /**
         * Add configuration button for admin users
         */
        function addConfigButton() {
            const headerActions = document.querySelector('.d-flex.justify-content-between .div:last-child');
            if (headerActions) {
                const configButton = document.createElement('button');
                configButton.className = 'btn btn-outline-warning ms-2';
                configButton.innerHTML = '<i class="bi bi-gear me-1"></i>Konfigurasi';
                configButton.onclick = showConfigModal;
                headerActions.appendChild(configButton);
            }
        }

        /**
         * Refresh all data
         */
        async function refreshData() {
            try {
                showAlert('Memperbarui data...', 'info');
                if (window.uiController && window.uiController.refreshData) {
                    await window.uiController.refreshData();
                }
                await loadInitialData();
                showAlert('Data berhasil diperbarui', 'success');
                
                // Auto-hide success message
                setTimeout(() => {
                    document.getElementById('alert-container').innerHTML = '';
                }, 3000);
            } catch (error) {
                console.error('Error refreshing data:', error);
                showAlert('Gagal memperbarui data', 'danger');
            }
        }

        /**
         * Display recent transformations
         */
        function displayRecentTransformations(transformations) {
            const container = document.getElementById('recent-transformations');
            if (!container || !transformations) return;
            
            if (transformations.length === 0) {
                container.innerHTML = `
                    <div class="list-group-item text-center text-muted py-4">
                        <i class="bi bi-inbox display-6 d-block mb-2"></i>
                        Belum ada transformasi hari ini
                    </div>
                `;
                return;
            }
            
            container.innerHTML = transformations.map(t => `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${t.sourceItem ? t.sourceItem.name : t.sourceName} ‚Üí ${t.targetItem ? t.targetItem.name : t.targetName}</h6>
                            <p class="mb-1 small text-muted">
                                ${t.sourceItem ? t.sourceItem.quantity : t.quantity} ${t.sourceItem ? t.sourceItem.unit : ''} ‚Üí 
                                ${t.targetItem ? t.targetItem.quantity : t.resultQuantity} ${t.targetItem ? t.targetItem.unit : ''}
                            </p>
                            <small class="text-muted">${new Date(t.timestamp).toLocaleTimeString('id-ID')}</small>
                        </div>
                        <span class="badge bg-${t.status === 'completed' ? 'success' : t.status === 'failed' ? 'danger' : 'success'}">
                            ${t.status === 'completed' ? 'Berhasil' : t.status === 'failed' ? 'Gagal' : 'Berhasil'}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        /**
         * Load recent transformations
         */
        async function loadRecentTransformations() {
            try {
                let history = [];
                
                // Try to get from transformation manager first
                if (window.transformationManager && window.transformationManager.getTransformationHistory) {
                    history = await window.transformationManager.getTransformationHistory();
                } else {
                    // Fallback to localStorage
                    history = JSON.parse(localStorage.getItem('transformationHistory') || '[]');
                }
                
                const today = new Date().toDateString();
                const todayTransformations = history.filter(t => 
                    new Date(t.timestamp).toDateString() === today
                ).slice(0, 5); // Last 5 transformations today

                displayRecentTransformations(todayTransformations);
            } catch (error) {
                console.error('Error loading recent transformations:', error);
                // Show empty state on error
                displayRecentTransformations([]);
            }
        }

        /**
         * Update today's transformation count
         */
        async function updateTodayTransformationCount() {
            try {
                let history = [];
                
                // Try to get from transformation manager first
                if (window.transformationManager && window.transformationManager.getTransformationHistory) {
                    history = await window.transformationManager.getTransformationHistory();
                } else {
                    // Fallback to localStorage
                    history = JSON.parse(localStorage.getItem('transformationHistory') || '[]');
                }
                
                const today = new Date().toDateString();
                const todayCount = history.filter(t => 
                    new Date(t.timestamp).toDateString() === today
                ).length;

                const todayElement = document.getElementById('today-transformations');
                if (todayElement) {
                    todayElement.textContent = todayCount;
                }
            } catch (error) {
                console.error('Error updating transformation count:', error);
                const todayElement = document.getElementById('today-transformations');
                if (todayElement) {
                    todayElement.textContent = '0';
                }
            }
        }

        /**
         * Update statistics
         */
        async function updateStats() {
            await updateTodayTransformationCount();
            
            try {
                let totalItems = 0;
                
                if (window.transformationManager && window.transformationManager.getTransformableItems) {
                    const transformableItems = await window.transformationManager.getTransformableItems();
                    totalItems = transformableItems.reduce((sum, group) => sum + group.items.length, 0);
                } else {
                    // Fallback to counting from localStorage
                    const barang = JSON.parse(localStorage.getItem('masterBarang') || localStorage.getItem('barang') || '[]');
                    totalItems = barang.length;
                }
                
                const availableItemsElement = document.getElementById('available-items');
                if (availableItemsElement) {
                    availableItemsElement.textContent = totalItems;
                }
            } catch (error) {
                console.error('Error updating stats:', error);
                const availableItemsElement = document.getElementById('available-items');
                if (availableItemsElement) {
                    availableItemsElement.textContent = '0';
                }
            }
        }

        /**
         * Show history modal
         */
        async function showHistoryModal() {
            try {
                const modal = new bootstrap.Modal(document.getElementById('historyModal'));
                await loadHistoryData();
                modal.show();
            } catch (error) {
                console.error('Error showing history modal:', error);
                showAlert('Gagal memuat riwayat transformasi', 'danger');
            }
        }

        /**
         * Load history data into modal
         */
        async function loadHistoryData() {
            try {
                let history = [];
                
                // Try to get from transformation manager first
                if (window.transformationManager && window.transformationManager.getTransformationHistory) {
                    history = await window.transformationManager.getTransformationHistory();
                } else {
                    // Fallback to localStorage
                    history = JSON.parse(localStorage.getItem('transformationHistory') || '[]');
                }
                
                const tbody = document.getElementById('history-table-body');
                
                if (history.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-muted py-4">
                                <i class="bi bi-inbox display-6 d-block mb-2"></i>
                                Belum ada riwayat transformasi
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = history.map(transformation => `
                    <tr>
                        <td><code>${transformation.id || 'N/A'}</code></td>
                        <td>${new Date(transformation.timestamp).toLocaleString('id-ID')}</td>
                        <td>${transformation.user || 'Unknown'}</td>
                        <td>${transformation.sourceItem ? 
                            `${transformation.sourceItem.quantity} ${transformation.sourceItem.unit} ${transformation.sourceItem.name}` :
                            `${transformation.quantity} ${transformation.sourceName}`
                        }</td>
                        <td>${transformation.targetItem ? 
                            `${transformation.targetItem.quantity} ${transformation.targetItem.unit} ${transformation.targetItem.name}` :
                            `${transformation.resultQuantity} ${transformation.targetName}`
                        }</td>
                        <td>1:${transformation.conversionRatio || transformation.ratio || '1'}</td>
                        <td><span class="badge bg-success">Berhasil</span></td>
                    </tr>
                `).join('');

                // Populate filter dropdowns
                populateHistoryFilters(history);
            } catch (error) {
                console.error('Error loading history data:', error);
                const tbody = document.getElementById('history-table-body');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-danger py-4">
                                <i class="bi bi-exclamation-triangle display-6 d-block mb-2"></i>
                                Gagal memuat riwayat transformasi
                            </td>
                        </tr>
                    `;
                }
            }
        }

        /**
         * Populate history filter dropdowns
         */
        function populateHistoryFilters(history) {
            try {
                // Populate product filter
                const products = [...new Set(history.map(h => {
                    if (h.sourceItem && h.sourceItem.baseProduct) {
                        return h.sourceItem.baseProduct;
                    }
                    if (h.sourceName) {
                        return h.sourceName.split(' ')[0]; // Use first word as base product
                    }
                    return 'Unknown';
                }))];
                
                const productSelect = document.getElementById('filter-product');
                if (productSelect) {
                    productSelect.innerHTML = '<option value="">Semua Produk</option>' +
                        products.map(product => `<option value="${product}">${product}</option>`).join('');
                }

                // Populate user filter
                const users = [...new Set(history.map(h => h.user || 'Unknown'))];
                const userSelect = document.getElementById('filter-user');
                if (userSelect) {
                    userSelect.innerHTML = '<option value="">Semua User</option>' +
                        users.map(user => `<option value="${user}">${user}</option>`).join('');
                }
            } catch (error) {
                console.error('Error populating history filters:', error);
            }
        }

        /**
         * Apply history filter
         */
        async function applyHistoryFilter() {
            // Implementation for filtering history
            console.log('Applying history filter...');
            // This would filter the history table based on selected criteria
        }

        /**
         * Clear history filter
         */
        function clearHistoryFilter() {
            document.getElementById('filter-start-date').value = '';
            document.getElementById('filter-end-date').value = '';
            document.getElementById('filter-product').value = '';
            document.getElementById('filter-user').value = '';
            loadHistoryData();
        }

        /**
         * Export history to CSV
         */
        async function exportHistory() {
            try {
                let csvData = '';
                
                if (window.reportManager && window.reportManager.exportTransformationHistory) {
                    csvData = await window.reportManager.exportTransformationHistory('csv');
                } else {
                    // Fallback: create CSV manually
                    const history = JSON.parse(localStorage.getItem('transformationHistory') || '[]');
                    const headers = ['ID Transaksi', 'Tanggal', 'User', 'Item Sumber', 'Item Target', 'Rasio', 'Status'];
                    const rows = history.map(h => [
                        h.id || 'N/A',
                        new Date(h.timestamp).toLocaleString('id-ID'),
                        h.user || 'Unknown',
                        h.sourceItem ? `${h.sourceItem.quantity} ${h.sourceItem.unit} ${h.sourceItem.name}` : `${h.quantity} ${h.sourceName}`,
                        h.targetItem ? `${h.targetItem.quantity} ${h.targetItem.unit} ${h.targetItem.name}` : `${h.resultQuantity} ${h.targetName}`,
                        `1:${h.conversionRatio || h.ratio || '1'}`,
                        'Berhasil'
                    ]);
                    
                    csvData = [headers, ...rows].map(row => 
                        row.map(cell => `"${cell}"`).join(',')
                    ).join('\n');
                }
                
                downloadCSV(csvData, 'riwayat_transformasi.csv');
                showAlert('Data berhasil diekspor', 'success');
            } catch (error) {
                console.error('Error exporting history:', error);
                showAlert('Gagal mengekspor data', 'danger');
            }
        }

        /**
         * Show configuration modal (admin only)
         */
        async function showConfigModal() {
            try {
                const modal = new bootstrap.Modal(document.getElementById('configModal'));
                await loadConfigurationData();
                modal.show();
            } catch (error) {
                console.error('Error showing config modal:', error);
                showAlert('Gagal memuat konfigurasi', 'danger');
            }
        }

        /**
         * Load configuration data
         */
        async function loadConfigurationData() {
            // Implementation for loading configuration
            const configContent = document.getElementById('config-content');
            configContent.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    Fitur konfigurasi rasio konversi akan segera tersedia.
                </div>
            `;
        }

        /**
         * Save configuration
         */
        async function saveConfiguration() {
            // Implementation for saving configuration
            console.log('Saving configuration...');
        }

        /**
         * Initialize fallback system when advanced system fails
         */
        function initializeFallbackSystem() {
            console.log('Initializing fallback transformation system...');
            
            try {
                // Load products for dropdowns
                loadProductsForTransformationFallback();
                
                // Setup basic event listeners
                setupFallbackEventListeners();
                
                // Create minimal system objects for compatibility
                window.transformationManager = {
                    getTransformableItems: () => Promise.resolve([]),
                    processTransformation: (data) => Promise.resolve(data),
                    getTransformationHistory: () => Promise.resolve([])
                };
                
                window.uiController = {
                    refreshData: () => Promise.resolve(),
                    _handleFormSubmission: processTransformationFallback
                };
                
                systemInitialized = true;
                showAlert('Sistem transformasi barang dimuat (mode sederhana)', 'success');
                
                // Load initial data for fallback system
                loadInitialData();
                updateStats();
                hideLoadingMessages();
                
            } catch (error) {
                console.error('Error initializing fallback system:', error);
                showAlert('Gagal menginisialisasi sistem transformasi barang', 'danger');
            }
        }

        /**
         * Reload transformation scripts
         */
        function reloadTransformationScripts() {
            console.log('Attempting to reload transformation scripts...');
            
            const scriptFiles = [
                'js/transformasi-barang/types.js',
                'js/transformasi-barang/DataModels.js',
                'js/transformasi-barang/ValidationEngine.js',
                'js/transformasi-barang/ConversionCalculator.js',
                'js/transformasi-barang/StockManager.js',
                'js/transformasi-barang/AuditLogger.js',
                'js/transformasi-barang/ErrorHandler.js',
                'js/transformasi-barang/TransformationManager.js',
                'js/transformasi-barang/UIController.js',
                'js/transformasi-barang/ReportManager.js',
                'js/transformasiBarangInit.js'
            ];
            
            // Load scripts sequentially
            loadScriptsSequentially(scriptFiles)
                .then(() => {
                    console.log('All scripts loaded, attempting initialization...');
                    setTimeout(() => {
                        initializationAttempts = 0; // Reset attempts
                        attemptSystemInitialization();
                    }, 500);
                })
                .catch(error => {
                    console.error('Error loading scripts:', error);
                    showAlert('Gagal memuat ulang script. Menggunakan sistem sederhana.', 'warning');
                    initializeFallbackSystem();
                });
        }

        /**
         * Load scripts sequentially
         */
        function loadScriptsSequentially(scriptPaths) {
            return scriptPaths.reduce((promise, scriptPath) => {
                return promise.then(() => loadScript(scriptPath));
            }, Promise.resolve());
        }

        /**
         * Load a single script
         */
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                // Check if script already exists
                const existingScript = document.querySelector(`script[src="${src}"]`);
                if (existingScript) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    console.log(`Loaded: ${src}`);
                    resolve();
                };
                script.onerror = () => {
                    console.warn(`Failed to load: ${src}`);
                    resolve(); // Don't reject, just continue
                };
                document.head.appendChild(script);
            });
        }
        
        /**
         * Load products for transformation with proper stock integration
         */
        async function loadProductsForTransformationFallback() {
            try {
                const sourceSelect = document.getElementById('sourceItem');
                const targetSelect = document.getElementById('targetItem');
                
                if (!sourceSelect || !targetSelect) {
                    console.warn('Product select elements not found');
                    return;
                }
                
                // Initialize StockManager if not already done
                if (!window.stockManager) {
                    window.stockManager = new StockManager();
                    window.stockManager.initialize();
                }
                
                // Get transformable items using TransformationManager
                let transformableItems = [];
                if (window.transformationManager && window.transformationManager.getTransformableItems) {
                    try {
                        const items = await window.transformationManager.getTransformableItems();
                        transformableItems = items;
                    } catch (error) {
                        console.warn('Error getting transformable items from manager:', error);
                    }
                }
                
                // Fallback: load from localStorage directly
                if (transformableItems.length === 0) {
                    const masterBarang = JSON.parse(localStorage.getItem('masterBarang') || '[]');
                    
                    // If no data, create sample data
                    if (masterBarang.length === 0) {
                        console.log('Tidak ada data barang ditemukan, membuat data sample...');
                        const sampleData = createSampleBarangData();
                        localStorage.setItem('masterBarang', JSON.stringify(sampleData));
                        
                        // Also create sample conversion ratios
                        const sampleRatios = createSampleConversionRatios();
                        localStorage.setItem('conversionRatios', JSON.stringify(sampleRatios));
                    }
                    
                    // Group by base product for transformable items
                    const baseProducts = {};
                    masterBarang.forEach(item => {
                        const baseProduct = item.baseProduct || item.kode.split('-')[0];
                        if (!baseProducts[baseProduct]) {
                            baseProducts[baseProduct] = [];
                        }
                        baseProducts[baseProduct].push(item);
                    });
                    
                    // Convert to transformable items format
                    transformableItems = Object.entries(baseProducts)
                        .filter(([baseProduct, items]) => items.length > 1)
                        .map(([baseProduct, items]) => ({
                            baseProduct,
                            items: items.map(item => ({
                                id: item.kode,
                                name: item.nama,
                                unit: item.satuan,
                                stock: item.stok || 0,
                                baseProduct
                            }))
                        }));
                }
                
                // Clear existing options
                sourceSelect.innerHTML = '<option value="">Pilih barang asal...</option>';
                targetSelect.innerHTML = '<option value="">Pilih barang tujuan...</option>';
                
                // Populate dropdowns with stock-aware filtering
                let sourceCount = 0;
                let targetCount = 0;
                
                transformableItems.forEach(productGroup => {
                    productGroup.items.forEach(item => {
                        // Source dropdown - only items with stock > 0
                        if (item.stock > 0) {
                            const sourceOption = new Option(
                                `${item.name} (Stok: ${item.stock} ${item.unit})`, 
                                item.id
                            );
                            sourceSelect.add(sourceOption);
                            sourceCount++;
                        }
                        
                        // Target dropdown - all items (for conversion targets)
                        const targetOption = new Option(
                            `${item.name} (Stok: ${item.stock} ${item.unit})`, 
                            item.id
                        );
                        targetSelect.add(targetOption);
                        targetCount++;
                    });
                });
                
                console.log(`‚úÖ Berhasil memuat produk untuk transformasi: ${sourceCount} source items, ${targetCount} target items`);
                
                // Update statistik
                updateAvailableItemsCount(sourceCount);
                
            } catch (error) {
                console.error('‚ùå Error loading products for transformation:', error);
                showAlert('Gagal memuat data barang. Silakan refresh halaman.', 'warning');
            }
        }
        
        /**
         * Buat data sample barang untuk testing
         */
        function createSampleBarangData() {
            return [
                {
                    kode: 'BRG001-KG',
                    nama: 'Beras Premium (Kilogram)',
                    satuan: 'kg',
                    stok: 100,
                    baseProduct: 'BRG001',
                    hargaBeli: 12000,
                    hargaJual: 15000
                },
                {
                    kode: 'BRG001-GR',
                    nama: 'Beras Premium (Gram)',
                    satuan: 'gram',
                    stok: 50000,
                    baseProduct: 'BRG001',
                    hargaBeli: 12,
                    hargaJual: 15
                },
                {
                    kode: 'BRG002-LT',
                    nama: 'Minyak Goreng (Liter)',
                    satuan: 'liter',
                    stok: 50,
                    baseProduct: 'BRG002',
                    hargaBeli: 18000,
                    hargaJual: 22000
                },
                {
                    kode: 'BRG002-ML',
                    nama: 'Minyak Goreng (Mililiter)',
                    satuan: 'ml',
                    stok: 25000,
                    baseProduct: 'BRG002',
                    hargaBeli: 18,
                    hargaJual: 22
                },
                {
                    kode: 'BRG003-DUS',
                    nama: 'Air Mineral (Dus)',
                    satuan: 'dus',
                    stok: 20,
                    baseProduct: 'BRG003',
                    hargaBeli: 48000,
                    hargaJual: 60000
                },
                {
                    kode: 'BRG003-BTL',
                    nama: 'Air Mineral (Botol)',
                    satuan: 'botol',
                    stok: 480,
                    baseProduct: 'BRG003',
                    hargaBeli: 2000,
                    hargaJual: 2500
                }
            ];
        }
        
        /**
         * Buat data sample conversion ratios untuk testing
         */
        function createSampleConversionRatios() {
            return [
                {
                    baseProduct: 'BRG001',
                    productName: 'Beras Premium',
                    conversions: [
                        { from: 'kg', to: 'gram', ratio: 1000 },
                        { from: 'gram', to: 'kg', ratio: 0.001 }
                    ]
                },
                {
                    baseProduct: 'BRG002',
                    productName: 'Minyak Goreng',
                    conversions: [
                        { from: 'liter', to: 'ml', ratio: 1000 },
                        { from: 'ml', to: 'liter', ratio: 0.001 }
                    ]
                },
                {
                    baseProduct: 'BRG003',
                    productName: 'Air Mineral',
                    conversions: [
                        { from: 'dus', to: 'botol', ratio: 24 },
                        { from: 'botol', to: 'dus', ratio: 0.041667 }
                    ]
                }
            ];
        }
        
        /**
         * Update jumlah item tersedia di statistik
         */
        function updateAvailableItemsCount(count) {
            const availableItemsElement = document.getElementById('available-items');
            if (availableItemsElement) {
                availableItemsElement.textContent = count;
            }
        }
        
        /**
         * Process transformation with proper stock integration
         */
        async function processTransformation() {
            const sourceSelect = document.getElementById('sourceItem');
            const targetSelect = document.getElementById('targetItem');
            const quantityInput = document.getElementById('quantity');
            const loadingIndicator = document.getElementById('loading-indicator');
            const submitButton = document.getElementById('submit-transformation');
            
            if (!sourceSelect || !targetSelect || !quantityInput) {
                showAlert('Form elements tidak ditemukan', 'danger');
                return;
            }
            
            const sourceValue = sourceSelect.value;
            const targetValue = targetSelect.value;
            const quantity = parseFloat(quantityInput.value) || 0;
            
            // Validasi input
            if (!sourceValue || !targetValue || quantity <= 0) {
                showAlert('Silakan lengkapi semua field dengan benar', 'warning');
                return;
            }
            
            if (sourceValue === targetValue) {
                showAlert('Item sumber dan target tidak boleh sama', 'warning');
                return;
            }
            
            try {
                // Show loading
                if (loadingIndicator) loadingIndicator.style.display = 'block';
                if (submitButton) submitButton.disabled = true;
                
                // Initialize managers if not already done
                if (!window.stockManager) {
                    window.stockManager = new StockManager();
                    window.stockManager.initialize();
                }
                
                if (!window.transformationManager) {
                    // Initialize transformation manager with dependencies
                    window.transformationManager = new TransformationManager();
                    
                    // Create minimal dependencies for fallback
                    const validationEngine = {
                        validateProductMatch: async (source, target) => {
                            const sourceBase = source.baseProduct || source.kode.split('-')[0];
                            const targetBase = target.baseProduct || target.kode.split('-')[0];
                            return {
                                isValid: sourceBase === targetBase,
                                errors: sourceBase !== targetBase ? ['Item harus dari produk yang sama'] : []
                            };
                        },
                        validateStockAvailability: async (item, qty) => {
                            return {
                                isValid: item.stok >= qty,
                                errors: item.stok < qty ? [`Stok tidak mencukupi. Tersedia: ${item.stok}, diminta: ${qty}`] : []
                            };
                        },
                        validateConversionRatio: async (fromUnit, toUnit) => {
                            return { isValid: true, errors: [] };
                        },
                        validateQuantityCalculation: async (qty, targetQty, ratio) => {
                            return { isValid: true, errors: [] };
                        }
                    };
                    
                    const calculator = {
                        getConversionRatio: async (fromUnit, toUnit) => {
                            const ratios = JSON.parse(localStorage.getItem('conversionRatios') || '[]');
                            for (const productRatio of ratios) {
                                const conversion = productRatio.conversions.find(c => 
                                    c.from === fromUnit && c.to === toUnit
                                );
                                if (conversion) return conversion.ratio;
                            }
                            return 1;
                        },
                        calculateTargetQuantity: async (qty, ratio) => qty * ratio
                    };
                    
                    const auditLogger = {
                        logTransformation: async (record) => {
                            const history = JSON.parse(localStorage.getItem('transformationHistory') || '[]');
                            history.unshift(record);
                            localStorage.setItem('transformationHistory', JSON.stringify(history));
                        }
                    };
                    
                    window.transformationManager.initialize({
                        validationEngine,
                        calculator,
                        stockManager: window.stockManager,
                        auditLogger
                    });
                }
                
                // Use TransformationManager for proper processing
                const transformationData = {
                    sourceItemId: sourceValue,
                    targetItemId: targetValue,
                    quantity: quantity,
                    user: window.currentUser?.name || 'Test User'
                };
                
                // Execute transformation using the manager
                const transformationRecord = await window.transformationManager.executeTransformation(transformationData);
                
                // Show success message
                showAlert(`
                    <strong>Transformasi Berhasil!</strong><br>
                    <small>
                        ${transformationRecord.sourceItem.quantity} ${transformationRecord.sourceItem.unit} ${transformationRecord.sourceItem.name} ‚Üí 
                        ${transformationRecord.targetItem.quantity.toFixed(3)} ${transformationRecord.targetItem.unit} ${transformationRecord.targetItem.name}<br>
                        ID Transaksi: ${transformationRecord.id}
                    </small>
                `, 'success');
                
                // Reset form
                resetTransformationForm();
                
                // Refresh data
                await refreshData();
                
                // Update recent transformations
                await loadRecentTransformations();
                
            } catch (error) {
                console.error('‚ùå Error processing transformation:', error);
                showAlert(`Gagal memproses transformasi: ${error.message}`, 'danger');
            } finally {
                // Hide loading
                if (loadingIndicator) loadingIndicator.style.display = 'none';
                if (submitButton) submitButton.disabled = false;
            }
        }
        
        /**
         * Reset transformation form
         */
        function resetTransformationForm() {
            const sourceSelect = document.getElementById('sourceItem');
            const targetSelect = document.getElementById('targetItem');
            const quantityInput = document.getElementById('quantity');
            const conversionInfo = document.getElementById('conversion-info');
            const submitButton = document.getElementById('submit-transformation');
            
            if (sourceSelect) sourceSelect.value = '';
            if (targetSelect) targetSelect.value = '';
            if (quantityInput) quantityInput.value = '';
            if (conversionInfo) {
                conversionInfo.innerHTML = '<span class="text-muted">Pilih item untuk melihat rasio konversi</span>';
            }
            if (submitButton) submitButton.disabled = true;
        }

        /**
         * Setup fallback event listeners
         */
        function setupFallbackEventListeners() {
            try {
                const sourceSelect = document.getElementById('sourceItem');
                const targetSelect = document.getElementById('targetItem');
                const quantityInput = document.getElementById('quantity');
                const submitButton = document.getElementById('submit-transformation');
                const resetButton = document.getElementById('reset-form');
                
                if (sourceSelect) {
                    sourceSelect.addEventListener('change', updateConversionInfo);
                }
                
                if (targetSelect) {
                    targetSelect.addEventListener('change', updateConversionInfo);
                }
                
                if (quantityInput) {
                    quantityInput.addEventListener('input', updateConversionInfo);
                }
                
                if (submitButton) {
                    submitButton.addEventListener('click', processTransformation);
                }
                
                if (resetButton) {
                    resetButton.addEventListener('click', resetTransformationForm);
                }
                
                console.log('‚úÖ Fallback event listeners setup completed');
                
            } catch (error) {
                console.error('‚ùå Error setting up fallback event listeners:', error);
            }
        }
        
        /**
         * Process transformation fallback (for compatibility)
         */
        async function processTransformationFallback() {
            return await processTransformation();
        }
        
        /**
         * Update conversion info fallback (for compatibility)
         */
        function updateConversionInfoFallback() {
            return updateConversionInfo();
        }
        
        /**
         * Enhanced dropdown population with stock filtering
         */
        async function populateDropdownsEnhanced() {
            try {
                const sourceSelect = document.getElementById('sourceItem');
                const targetSelect = document.getElementById('targetItem');
                
                if (!sourceSelect || !targetSelect) {
                    console.warn('Dropdown elements not found');
                    return;
                }
                
                // Initialize StockManager if needed
                if (!window.stockManager) {
                    window.stockManager = new StockManager();
                    window.stockManager.initialize();
                }
                
                const masterBarang = JSON.parse(localStorage.getItem('masterBarang') || '[]');
                
                if (masterBarang.length === 0) {
                    console.warn('No master barang data found');
                    return;
                }
                
                // Clear existing options
                sourceSelect.innerHTML = '<option value="">Pilih barang asal...</option>';
                targetSelect.innerHTML = '<option value="">Pilih barang tujuan...</option>';
                
                // Group by base product
                const baseProducts = {};
                masterBarang.forEach(item => {
                    const baseProduct = item.baseProduct || item.kode.split('-')[0];
                    if (!baseProducts[baseProduct]) {
                        baseProducts[baseProduct] = [];
                    }
                    baseProducts[baseProduct].push(item);
                });
                
                // Check conversion ratios exist
                const conversionRatios = JSON.parse(localStorage.getItem('conversionRatios') || '[]');
                
                // Populate dropdowns with enhanced information
                for (const [baseProduct, items] of Object.entries(baseProducts)) {
                    // Only show products with multiple units AND conversion ratios
                    const hasConversionRatios = conversionRatios.some(ratio => ratio.baseProduct === baseProduct);
                    
                    if (items.length > 1 && hasConversionRatios) {
                        for (const item of items) {
                            // Get real-time stock
                            const currentStock = await window.stockManager.getStockBalance(item.kode);
                            const stockInfo = currentStock > 0 ? `(Stok: ${currentStock} ${item.satuan})` : '(Stok Habis)';
                            const itemLabel = `${item.nama} ${stockInfo}`;
                            
                            // Source dropdown - only items with stock > 0
                            if (currentStock > 0) {
                                const sourceOption = new Option(itemLabel, item.kode);
                                sourceSelect.add(sourceOption);
                            }
                            
                            // Target dropdown - all items (for conversion targets)
                            const targetOption = new Option(itemLabel, item.kode);
                            targetSelect.add(targetOption);
                        }
                    }
                }
                
                console.log(`‚úÖ Enhanced dropdowns populated: ${sourceSelect.options.length - 1} source, ${targetSelect.options.length - 1} target options`);
                
            } catch (error) {
                console.error('‚ùå Error populating enhanced dropdowns:', error);
            }
        }
        
        // Make functions globally available
        window.processTransformation = processTransformation;
        window.resetTransformationForm = resetTransformationForm;
        window.updateConversionInfo = updateConversionInfo;
        window.populateDropdownsEnhanced = populateDropdownsEnhanced;
        
        /**
         * Setup enhanced event listeners
         */
        function setupEnhancedEventListeners() {
            try {
                const sourceSelect = document.getElementById('sourceItem');
                const targetSelect = document.getElementById('targetItem');
                const quantityInput = document.getElementById('quantity');
                const submitButton = document.getElementById('submit-transformation');
                const resetButton = document.getElementById('reset-form');
                
                if (sourceSelect) {
                    sourceSelect.addEventListener('change', async function() {
                        await updateConversionInfo();
                        // Auto-populate target dropdown based on source selection
                        if (sourceSelect.value) {
                            await filterTargetOptions(sourceSelect.value);
                        }
                    });
                }
                
                if (targetSelect) {
                    targetSelect.addEventListener('change', updateConversionInfo);
                }
                
                if (quantityInput) {
                    quantityInput.addEventListener('input', updateConversionInfo);
                    quantityInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            if (!submitButton.disabled) {
                                processTransformation();
                            }
                        }
                    });
                }
                
                if (submitButton) {
                    submitButton.addEventListener('click', processTransformation);
                }
                
                if (resetButton) {
                    resetButton.addEventListener('click', resetTransformationForm);
                }
                
                console.log('‚úÖ Enhanced event listeners setup completed');
                
            } catch (error) {
                console.error('‚ùå Error setting up enhanced event listeners:', error);
            }
        }
        
        /**
         * Filter target options based on source selection
         */
        async function filterTargetOptions(sourceItemId) {
            try {
                const targetSelect = document.getElementById('targetItem');
                if (!targetSelect) return;
                
                // Initialize StockManager if needed
                if (!window.stockManager) {
                    window.stockManager = new StockManager();
                    window.stockManager.initialize();
                }
                
                const masterBarang = JSON.parse(localStorage.getItem('masterBarang') || '[]');
                const sourceItem = masterBarang.find(item => item.kode === sourceItemId);
                
                if (!sourceItem) return;
                
                const sourceBaseProduct = sourceItem.baseProduct || sourceItem.kode.split('-')[0];
                
                // Clear and repopulate target dropdown with same base product items only
                targetSelect.innerHTML = '<option value="">Pilih barang tujuan...</option>';
                
                // Check if conversion ratios exist for this base product
                const conversionRatios = JSON.parse(localStorage.getItem('conversionRatios') || '[]');
                const hasConversionRatios = conversionRatios.some(ratio => ratio.baseProduct === sourceBaseProduct);
                
                if (!hasConversionRatios) {
                    console.warn(`No conversion ratios found for base product: ${sourceBaseProduct}`);
                    return;
                }
                
                for (const item of masterBarang) {
                    const itemBaseProduct = item.baseProduct || item.kode.split('-')[0];
                    if (itemBaseProduct === sourceBaseProduct && item.kode !== sourceItemId) {
                        // Get real-time stock
                        const currentStock = await window.stockManager.getStockBalance(item.kode);
                        const stockInfo = `(Stok: ${currentStock} ${item.satuan})`;
                        const itemLabel = `${item.nama} ${stockInfo}`;
                        const option = new Option(itemLabel, item.kode);
                        targetSelect.add(option);
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Error filtering target options:', error);
            }
        }
        
        // Initialize enhanced system
        async function initializeEnhancedTransformationSystem() {
            console.log('üöÄ Initializing enhanced transformation system...');
            
            try {
                // Initialize sample data if needed
                initializeSampleDataIfNeeded();
                
                // Initialize StockManager
                if (!window.stockManager) {
                    window.stockManager = new StockManager();
                    window.stockManager.initialize();
                }
                
                // Populate dropdowns with enhanced features
                await populateDropdownsEnhanced();
                
                // Setup enhanced event listeners
                setupEnhancedEventListeners();
                
                // Load initial data
                loadInitialData();
                updateStats();
                
                console.log('‚úÖ Enhanced transformation system initialized');
            } catch (error) {
                console.error('‚ùå Error initializing enhanced transformation system:', error);
            }
        }
        
        // Auto-initialize enhanced system
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeEnhancedTransformationSystem);
        } else {
            initializeEnhancedTransformationSystem();
        }
        
        // Also initialize after delays to ensure all elements are loaded
        setTimeout(initializeEnhancedTransformationSystem, 1000);
        setTimeout(initializeEnhancedTransformationSystem, 3000);

        /**
         * Setup fallback event listeners (continued)
         */
        function setupFallbackEventListenersContinued() {
            try {
                const resetButton = document.getElementById('reset-form');
                
                if (resetButton) {
                    resetButton.addEventListener('click', resetTransformationForm);
                }
                
                console.log('Fallback event listeners setup completed');
            } catch (error) {
                console.error('Error setting up fallback event listeners:', error);
            }
        }
        
        /**
         * Update conversion info (fallback version)
         */
        function updateConversionInfoFallback() {
            try {
                const sourceSelect = document.getElementById('sourceItem');
                const targetSelect = document.getElementById('targetItem');
                const quantityInput = document.getElementById('quantity');
                const conversionInfo = document.getElementById('conversion-info');
                const submitButton = document.getElementById('submit-transformation');
                
                if (!sourceSelect || !targetSelect || !quantityInput || !conversionInfo) {
                    return;
                }
                
                const sourceValue = sourceSelect.value;
                const targetValue = targetSelect.value;
                const quantity = parseFloat(quantityInput.value) || 0;
                
                if (!sourceValue || !targetValue) {
                    conversionInfo.innerHTML = '<span class="text-muted">Pilih item untuk melihat rasio konversi</span>';
                    if (submitButton) submitButton.disabled = true;
                    return;
                }
                
                const barang = JSON.parse(localStorage.getItem('masterBarang') || localStorage.getItem('barang') || '[]');
                const sourceItem = barang.find(item => (item.kode || item.id) === sourceValue);
                const targetItem = barang.find(item => (item.kode || item.id) === targetValue);
                
                if (!sourceItem || !targetItem) {
                    conversionInfo.innerHTML = '<span class="text-danger">Item tidak ditemukan</span>';
                    if (submitButton) submitButton.disabled = true;
                    return;
                }
                
                if (sourceItem.baseProduct && targetItem.baseProduct && sourceItem.baseProduct !== targetItem.baseProduct) {
                    conversionInfo.innerHTML = '<span class="text-warning">Item harus dari produk yang sama</span>';
                    if (submitButton) submitButton.disabled = true;
                    return;
                }
                
                // Simple conversion ratio (1:1 by default, or from stored ratios)
                let ratio = 1;
                const conversionRatios = JSON.parse(localStorage.getItem('conversionRatios') || '{}');
                
                if (sourceItem.baseProduct && conversionRatios[sourceItem.baseProduct]) {
                    const ratioData = conversionRatios[sourceItem.baseProduct];
                    if (ratioData.conversions) {
                        const conversion = ratioData.conversions.find(c => 
                            c.from === sourceItem.satuan && c.to === targetItem.satuan
                        );
                        if (conversion) {
                            ratio = conversion.ratio;
                        }
                    }
                }
                
                const targetQuantity = quantity * ratio;
                
                conversionInfo.innerHTML = `
                    <div class="small">
                        <div><strong>Rasio:</strong> 1 ${sourceItem.satuan} = ${ratio} ${targetItem.satuan}</div>
                        ${quantity > 0 ? `<div><strong>Hasil:</strong> ${quantity} ${sourceItem.satuan} ‚Üí ${targetQuantity} ${targetItem.satuan}</div>` : ''}
                    </div>
                `;
                
                const canSubmit = sourceValue && targetValue && quantity > 0 && sourceItem.stok >= quantity;
                if (submitButton) submitButton.disabled = !canSubmit;
                
            } catch (error) {
                console.error('Error updating conversion info (fallback):', error);
            }
        }
        
        /**
         * Process transformation (fallback version)
         */
        function processTransformationFallback() {
            try {
                const sourceSelect = document.getElementById('sourceItem');
                const targetSelect = document.getElementById('targetItem');
                const quantityInput = document.getElementById('quantity');
                
                if (!sourceSelect || !targetSelect || !quantityInput) {
                    showAlert('Form elements tidak ditemukan', 'danger');
                    return;
                }
                
                const sourceId = sourceSelect.value;
                const targetId = targetSelect.value;
                const quantity = parseFloat(quantityInput.value) || 0;
                
                if (!sourceId || !targetId) {
                    showAlert('Pilih item sumber dan target', 'warning');
                    return;
                }
                
                if (sourceId === targetId) {
                    showAlert('Item sumber dan target tidak boleh sama', 'warning');
                    return;
                }
                
                if (quantity <= 0) {
                    showAlert('Jumlah harus lebih dari 0', 'warning');
                    return;
                }
                
                const barang = JSON.parse(localStorage.getItem('masterBarang') || localStorage.getItem('barang') || '[]');
                const sourceItem = barang.find(item => (item.kode || item.id) === sourceId);
                const targetItem = barang.find(item => (item.kode || item.id) === targetId);
                
                if (!sourceItem || !targetItem) {
                    showAlert('Item tidak ditemukan', 'danger');
                    return;
                }
                
                if (sourceItem.stok < quantity) {
                    showAlert(`Stok ${sourceItem.nama} tidak mencukupi. Tersedia: ${sourceItem.stok} ${sourceItem.satuan}`, 'warning');
                    return;
                }
                
                // Get conversion ratio
                let ratio = 1;
                const conversionRatios = JSON.parse(localStorage.getItem('conversionRatios') || '{}');
                
                if (sourceItem.baseProduct && conversionRatios[sourceItem.baseProduct]) {
                    const ratioData = conversionRatios[sourceItem.baseProduct];
                    if (ratioData.conversions) {
                        const conversion = ratioData.conversions.find(c => 
                            c.from === sourceItem.satuan && c.to === targetItem.satuan
                        );
                        if (conversion) {
                            ratio = conversion.ratio;
                        }
                    }
                }
                
                const targetQuantity = quantity * ratio;
                
                if (!confirm(`Konfirmasi transformasi:\\n${quantity} ${sourceItem.satuan} ${sourceItem.nama} ‚Üí ${targetQuantity} ${targetItem.satuan} ${targetItem.nama}\\n\\nLanjutkan?`)) {
                    return;
                }
                
                // Process transformation
                sourceItem.stok -= quantity;
                targetItem.stok = (targetItem.stok || 0) + targetQuantity;
                
                // Save updated items
                localStorage.setItem('masterBarang', JSON.stringify(barang));
                if (localStorage.getItem('barang')) {
                    localStorage.setItem('barang', JSON.stringify(barang));
                }
                
                // Log transformation
                const transformationRecord = {
                    id: 'TRF-' + Date.now(),
                    timestamp: new Date().toISOString(),
                    user: localStorage.getItem('currentUser') || 'Unknown',
                    sourceName: sourceItem.nama,
                    targetName: targetItem.nama,
                    quantity: quantity,
                    resultQuantity: targetQuantity,
                    ratio: ratio
                };
                
                const history = JSON.parse(localStorage.getItem('transformationHistory') || '[]');
                history.unshift(transformationRecord);
                localStorage.setItem('transformationHistory', JSON.stringify(history));
                
                // Reset form and reload data
                resetTransformationForm();
                loadProductsForTransformationFallback();
                loadRecentTransformations();
                updateStats();
                
                showAlert(`Transformasi berhasil! ${quantity} ${sourceItem.satuan} ${sourceItem.nama} ‚Üí ${targetQuantity} ${targetItem.satuan} ${targetItem.nama}`, 'success');
                
            } catch (error) {
                console.error('Error processing transformation (fallback):', error);
                showAlert('Terjadi kesalahan saat memproses transformasi', 'danger');
            }
        }
        
        /**
         * Hide loading messages
         */
        function hideLoadingMessages() {
            // Remove any loading indicators or error messages
            const loadingElements = document.querySelectorAll('.loading, .spinner-border');
            loadingElements.forEach(el => el.remove());
            
            // Show the main content
            const mainContent = document.querySelector('.container-fluid');
            if (mainContent) {
                mainContent.style.display = 'block';
            }
        }

        /**
         * Show alert message
         */
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container');
            const alertId = 'alert-' + Date.now();
            
            alertContainer.innerHTML = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        /**
         * Download CSV file
         */
        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        /**
         * Get current user role
         */
        function getCurrentUserRole() {
            return localStorage.getItem('userRole') || 'kasir';
        }

        /**
         * Logout function
         */
        function logout() {
            if (confirm('Apakah Anda yakin ingin logout?')) {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('userRole');
                window.location.href = 'index.html';
            }
        }
    </script>

    <style>
        /* Additional CSS for auto-complete */
        .autocomplete-wrapper {
            position: relative;
        }
        
        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .autocomplete-suggestion {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .autocomplete-suggestion:hover {
            background-color: #f8f9fa;
        }
        
        .autocomplete-suggestion:last-child {
            border-bottom: none;
        }

        /* Loading animation */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .transformation-card {
                margin: 0 -15px;
                border-radius: 0;
            }
            
            .preview-section {
                margin: 0 -15px;
                border-radius: 0;
            }
        }
    </style>
</body>
</html>