<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Perbaikan Loading Transformasi Barang</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .test-card {
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
        }
        .test-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .test-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .test-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="text-center mb-4">
                    <h1 class="display-4 text-primary">
                        <i class="bi bi-check-circle me-3"></i>Test Perbaikan Loading
                    </h1>
                    <p class="lead text-muted">Verifikasi perbaikan sistem transformasi barang</p>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Test Controls -->
            <div class="col-lg-4">
                <div class="test-card card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Test Controls</h5>
                    </div>
                    <div class="card-body">
                        <button id="run-all-tests" class="btn btn-success w-100 mb-3">
                            <i class="bi bi-play-circle me-2"></i>Run All Tests
                        </button>
                        <button id="test-files" class="btn btn-outline-primary w-100 mb-2">
                            <i class="bi bi-file-code me-2"></i>Test File Loading
                        </button>
                        <button id="test-classes" class="btn btn-outline-info w-100 mb-2">
                            <i class="bi bi-box me-2"></i>Test Classes
                        </button>
                        <button id="test-data" class="btn btn-outline-warning w-100 mb-2">
                            <i class="bi bi-database me-2"></i>Test Data
                        </button>
                        <button id="test-init" class="btn btn-outline-success w-100 mb-2">
                            <i class="bi bi-power me-2"></i>Test Initialization
                        </button>
                        <hr>
                        <button id="clear-results" class="btn btn-outline-secondary w-100">
                            <i class="bi bi-trash me-2"></i>Clear Results
                        </button>
                    </div>
                </div>
            </div>

            <!-- Test Results -->
            <div class="col-lg-8">
                <div class="test-card card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-clipboard-check me-2"></i>Test Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="test-results">
                            <p class="text-muted text-center">Klik "Run All Tests" untuk memulai testing</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <!-- System Status -->
            <div class="col-12">
                <div class="test-card card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>System Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="system-status">
                            <!-- Status will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <!-- Quick Actions -->
            <div class="col-12 text-center">
                <a href="fix_transformasi_barang_loading_comprehensive.html" class="btn btn-warning btn-lg me-3">
                    <i class="bi bi-tools me-2"></i>Perbaikan Komprehensif
                </a>
                <a href="transformasi_barang.html" class="btn btn-primary btn-lg me-3" target="_blank">
                    <i class="bi bi-arrow-right-circle me-2"></i>Buka Transformasi Barang
                </a>
                <button id="reload-page" class="btn btn-outline-secondary btn-lg">
                    <i class="bi bi-arrow-clockwise me-2"></i>Reload Page
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Load transformasi barang scripts for testing -->
    <script src="js/auth.js"></script>
    <script src="js/koperasi.js"></script>
    <script src="js/transformasi-barang/types.js"></script>
    <script src="js/transformasi-barang/DataModels.js"></script>
    <script src="js/transformasi-barang/ValidationEngine.js"></script>
    <script src="js/transformasi-barang/ConversionCalculator.js"></script>
    <script src="js/transformasi-barang/StockManager.js"></script>
    <script src="js/transformasi-barang/AuditLogger.js"></script>
    <script src="js/transformasi-barang/ErrorHandler.js"></script>
    <script src="js/transformasi-barang/TransformationManager.js"></script>
    <script src="js/transformasi-barang/UIController.js"></script>
    <script src="js/transformasi-barang/ReportManager.js"></script>
    <script src="js/transformasiBarangInit.js"></script>
    
    <script>
        let testResults = [];

        // Required files and classes for testing
        const requiredFiles = [
            'js/auth.js',
            'js/koperasi.js',
            'js/transformasi-barang/types.js',
            'js/transformasi-barang/DataModels.js',
            'js/transformasi-barang/ValidationEngine.js',
            'js/transformasi-barang/ConversionCalculator.js',
            'js/transformasi-barang/StockManager.js',
            'js/transformasi-barang/AuditLogger.js',
            'js/transformasi-barang/ErrorHandler.js',
            'js/transformasi-barang/TransformationManager.js',
            'js/transformasi-barang/UIController.js',
            'js/transformasi-barang/ReportManager.js',
            'js/transformasiBarangInit.js'
        ];

        const requiredClasses = [
            'TransformationManager',
            'UIController',
            'ValidationEngine',
            'StockManager',
            'AuditLogger',
            'ErrorHandler',
            'ConversionCalculator'
        ];

        const requiredFunctions = [
            'initializeTransformasiBarang'
        ];

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            updateSystemStatus();
        });

        function setupEventListeners() {
            document.getElementById('run-all-tests').addEventListener('click', runAllTests);
            document.getElementById('test-files').addEventListener('click', testFileLoading);
            document.getElementById('test-classes').addEventListener('click', testClasses);
            document.getElementById('test-data').addEventListener('click', testData);
            document.getElementById('test-init').addEventListener('click', testInitialization);
            document.getElementById('clear-results').addEventListener('click', clearResults);
            document.getElementById('reload-page').addEventListener('click', () => location.reload());
        }

        function addTestResult(test, result, details = '') {
            const testResult = {
                test: test,
                result: result,
                details: details,
                timestamp: new Date().toLocaleTimeString()
            };
            
            testResults.push(testResult);
            updateTestResultsDisplay();
        }

        function updateTestResultsDisplay() {
            const container = document.getElementById('test-results');
            
            if (testResults.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">Belum ada hasil test</p>';
                return;
            }
            
            container.innerHTML = testResults.map(result => `
                <div class="test-result test-${result.result}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${result.test}</strong>
                            ${result.details ? `<br><small>${result.details}</small>` : ''}
                        </div>
                        <div class="text-end">
                            <span class="badge bg-${result.result === 'success' ? 'success' : result.result === 'error' ? 'danger' : 'warning'}">
                                ${result.result.toUpperCase()}
                            </span>
                            <br><small>${result.timestamp}</small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateSystemStatus() {
            const container = document.getElementById('system-status');
            
            // Check system components
            const filesLoaded = checkFileLoading();
            const classesAvailable = checkClasses();
            const dataAvailable = checkData();
            const systemReady = filesLoaded && classesAvailable && dataAvailable;
            
            container.innerHTML = `
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <i class="bi bi-file-code display-6 text-${filesLoaded ? 'success' : 'danger'}"></i>
                            <h6 class="mt-2">Files Loaded</h6>
                            <span class="badge bg-${filesLoaded ? 'success' : 'danger'}">
                                ${filesLoaded ? 'OK' : 'ERROR'}
                            </span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <i class="bi bi-box display-6 text-${classesAvailable ? 'success' : 'danger'}"></i>
                            <h6 class="mt-2">Classes Available</h6>
                            <span class="badge bg-${classesAvailable ? 'success' : 'danger'}">
                                ${classesAvailable ? 'OK' : 'ERROR'}
                            </span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <i class="bi bi-database display-6 text-${dataAvailable ? 'success' : 'danger'}"></i>
                            <h6 class="mt-2">Data Available</h6>
                            <span class="badge bg-${dataAvailable ? 'success' : 'danger'}">
                                ${dataAvailable ? 'OK' : 'ERROR'}
                            </span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <i class="bi bi-check-circle display-6 text-${systemReady ? 'success' : 'danger'}"></i>
                            <h6 class="mt-2">System Ready</h6>
                            <span class="badge bg-${systemReady ? 'success' : 'danger'}">
                                ${systemReady ? 'READY' : 'NOT READY'}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="progress">
                        <div class="progress-bar bg-${systemReady ? 'success' : 'warning'}" 
                             role="progressbar" 
                             style="width: ${getSystemProgress()}%" 
                             aria-valuenow="${getSystemProgress()}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            ${getSystemProgress()}% Complete
                        </div>
                    </div>
                </div>
            `;
        }

        function getSystemProgress() {
            const checks = [
                checkFileLoading(),
                checkClasses(),
                checkData(),
                typeof window.initializeTransformasiBarang === 'function'
            ];
            
            const passedChecks = checks.filter(check => check === true).length;
            return Math.round((passedChecks / checks.length) * 100);
        }

        function checkFileLoading() {
            // Check if scripts are loaded by looking for script tags
            const loadedScripts = Array.from(document.querySelectorAll('script[src]'))
                .map(script => script.src.split('/').pop());
            
            return requiredFiles.every(file => {
                const fileName = file.split('/').pop();
                return loadedScripts.some(loaded => loaded.includes(fileName));
            });
        }

        function checkClasses() {
            return requiredClasses.every(className => typeof window[className] === 'function');
        }

        function checkData() {
            return !!(localStorage.getItem('masterBarang') || localStorage.getItem('barang'));
        }

        async function runAllTests() {
            clearResults();
            addTestResult('Starting comprehensive test suite...', 'warning');
            
            await testFileLoading();
            await testClasses();
            await testData();
            await testInitialization();
            
            const totalTests = testResults.length - 1; // Exclude the starting message
            const successfulTests = testResults.filter(r => r.result === 'success').length;
            const successRate = Math.round((successfulTests / totalTests) * 100);
            
            addTestResult(`Test suite completed: ${successfulTests}/${totalTests} tests passed (${successRate}%)`, 
                         successRate === 100 ? 'success' : successRate > 50 ? 'warning' : 'error');
            
            updateSystemStatus();
        }

        async function testFileLoading() {
            addTestResult('Testing file loading...', 'warning');
            
            for (const file of requiredFiles) {
                const fileName = file.split('/').pop();
                const scriptExists = Array.from(document.querySelectorAll('script[src]'))
                    .some(script => script.src.includes(fileName));
                
                addTestResult(`File: ${fileName}`, scriptExists ? 'success' : 'error');
            }
        }

        async function testClasses() {
            addTestResult('Testing class availability...', 'warning');
            
            for (const className of requiredClasses) {
                const classExists = typeof window[className] === 'function';
                addTestResult(`Class: ${className}`, classExists ? 'success' : 'error',
                             classExists ? 'Available' : 'Not found');
            }
            
            for (const funcName of requiredFunctions) {
                const funcExists = typeof window[funcName] === 'function';
                addTestResult(`Function: ${funcName}`, funcExists ? 'success' : 'error',
                             funcExists ? 'Available' : 'Not found');
            }
        }

        async function testData() {
            addTestResult('Testing data availability...', 'warning');
            
            // Test localStorage data
            const masterBarang = localStorage.getItem('masterBarang');
            const barang = localStorage.getItem('barang');
            const conversionRatios = localStorage.getItem('conversionRatios');
            
            addTestResult('Master Barang Data', masterBarang ? 'success' : 'error',
                         masterBarang ? `${JSON.parse(masterBarang).length} items` : 'No data');
            
            addTestResult('Barang Data', barang ? 'success' : 'warning',
                         barang ? `${JSON.parse(barang).length} items` : 'Using masterBarang');
            
            addTestResult('Conversion Ratios', conversionRatios ? 'success' : 'error',
                         conversionRatios ? `${JSON.parse(conversionRatios).length} rules` : 'No ratios');
            
            // If no data, create sample data
            if (!masterBarang && !barang) {
                addTestResult('Creating sample data...', 'warning');
                createSampleData();
                addTestResult('Sample data created', 'success');
            }
        }

        async function testInitialization() {
            addTestResult('Testing system initialization...', 'warning');
            
            try {
                if (typeof window.initializeTransformasiBarang !== 'function') {
                    addTestResult('Initialization function', 'error', 'Function not found');
                    return;
                }
                
                // Try to initialize
                await window.initializeTransformasiBarang();
                addTestResult('System initialization', 'success', 'Initialized successfully');
                
                // Test global instances
                const instances = [
                    'transformationManager',
                    'uiController',
                    'validationEngine',
                    'stockManager',
                    'auditLogger',
                    'errorHandler',
                    'calculator'
                ];
                
                instances.forEach(instance => {
                    const exists = !!window[instance];
                    addTestResult(`Instance: ${instance}`, exists ? 'success' : 'error',
                                 exists ? 'Created' : 'Not created');
                });
                
            } catch (error) {
                addTestResult('System initialization', 'error', error.message);
            }
        }

        function createSampleData() {
            const sampleBarang = [
                {
                    kode: 'BRG001-KG',
                    nama: 'Beras Premium (Kilogram)',
                    satuan: 'kg',
                    stok: 100,
                    baseProduct: 'BRG001',
                    hargaBeli: 12000,
                    hargaJual: 15000
                },
                {
                    kode: 'BRG001-GR',
                    nama: 'Beras Premium (Gram)',
                    satuan: 'gram',
                    stok: 50000,
                    baseProduct: 'BRG001',
                    hargaBeli: 12,
                    hargaJual: 15
                },
                {
                    kode: 'BRG002-LT',
                    nama: 'Minyak Goreng (Liter)',
                    satuan: 'liter',
                    stok: 50,
                    baseProduct: 'BRG002',
                    hargaBeli: 18000,
                    hargaJual: 22000
                },
                {
                    kode: 'BRG002-ML',
                    nama: 'Minyak Goreng (Mililiter)',
                    satuan: 'ml',
                    stok: 25000,
                    baseProduct: 'BRG002',
                    hargaBeli: 18,
                    hargaJual: 22
                }
            ];

            const conversionRatios = [
                {
                    baseProduct: 'BRG001',
                    conversions: [
                        { from: 'kg', to: 'gram', ratio: 1000 },
                        { from: 'gram', to: 'kg', ratio: 0.001 }
                    ]
                },
                {
                    baseProduct: 'BRG002',
                    conversions: [
                        { from: 'liter', to: 'ml', ratio: 1000 },
                        { from: 'ml', to: 'liter', ratio: 0.001 }
                    ]
                }
            ];

            localStorage.setItem('masterBarang', JSON.stringify(sampleBarang));
            localStorage.setItem('barang', JSON.stringify(sampleBarang));
            localStorage.setItem('conversionRatios', JSON.stringify(conversionRatios));
            localStorage.setItem('currentUser', 'Test User');
        }

        function clearResults() {
            testResults = [];
            updateTestResultsDisplay();
        }

        // Auto-run basic checks on load
        setTimeout(() => {
            updateSystemStatus();
        }, 1000);
    </script>
</body>
</html>