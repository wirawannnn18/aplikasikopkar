<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Transformasi Barang Loading Fix</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>Test Transformasi Barang Loading</h2>
        
        <div id="loading-status" class="alert alert-info">
            <i class="bi bi-hourglass-split me-2"></i>Checking file loading status...
        </div>
        
        <div id="file-status" class="mt-3">
            <!-- File loading status will be displayed here -->
        </div>
        
        <div id="error-details" class="mt-3" style="display: none;">
            <!-- Error details will be displayed here -->
        </div>
        
        <div class="mt-4">
            <button class="btn btn-primary" onclick="testTransformasiBarang()">
                <i class="bi bi-play-fill me-1"></i>Test Transformasi Barang
            </button>
            <button class="btn btn-success" onclick="fixAndRedirect()">
                <i class="bi bi-tools me-1"></i>Fix & Go to Transformasi Barang
            </button>
        </div>
    </div>

    <!-- Load required scripts in correct order -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/koperasi.js"></script>
    
    <!-- Transformasi Barang Modules -->
    <script src="js/transformasi-barang/types.js"></script>
    <script src="js/transformasi-barang/DataModels.js"></script>
    <script src="js/transformasi-barang/ValidationEngine.js"></script>
    <script src="js/transformasi-barang/ConversionCalculator.js"></script>
    <script src="js/transformasi-barang/StockManager.js"></script>
    <script src="js/transformasi-barang/AuditLogger.js"></script>
    <script src="js/transformasi-barang/ErrorHandler.js"></script>
    <script src="js/transformasi-barang/TransformationManager.js"></script>
    <script src="js/transformasi-barang/UIController.js"></script>
    <script src="js/transformasi-barang/ReportManager.js"></script>
    
    <!-- Transformasi Barang Initialization -->
    <script src="js/transformasiBarangInit.js"></script>
    
    <script>
        let loadingErrors = [];
        let loadedFiles = [];
        
        // Track script loading
        document.addEventListener('DOMContentLoaded', function() {
            checkFileLoadingStatus();
        });
        
        // Override console.error to catch loading errors
        const originalConsoleError = console.error;
        console.error = function(...args) {
            loadingErrors.push(args.join(' '));
            originalConsoleError.apply(console, args);
        };
        
        function checkFileLoadingStatus() {
            const requiredClasses = [
                'TransformationManager',
                'UIController', 
                'ValidationEngine',
                'StockManager',
                'AuditLogger',
                'ErrorHandler',
                'ConversionCalculator',
                'DataModels'
            ];
            
            const statusContainer = document.getElementById('file-status');
            const loadingStatus = document.getElementById('loading-status');
            
            let statusHTML = '<h5>File Loading Status:</h5><ul class="list-group">';
            let allLoaded = true;
            
            requiredClasses.forEach(className => {
                const isLoaded = window[className] !== undefined;
                if (isLoaded) {
                    loadedFiles.push(className);
                }
                allLoaded = allLoaded && isLoaded;
                
                statusHTML += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        ${className}
                        <span class="badge bg-${isLoaded ? 'success' : 'danger'}">
                            ${isLoaded ? 'Loaded' : 'Missing'}
                        </span>
                    </li>
                `;
            });
            
            statusHTML += '</ul>';
            statusContainer.innerHTML = statusHTML;
            
            if (allLoaded) {
                loadingStatus.className = 'alert alert-success';
                loadingStatus.innerHTML = '<i class="bi bi-check-circle me-2"></i>All files loaded successfully!';
            } else {
                loadingStatus.className = 'alert alert-danger';
                loadingStatus.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Some files failed to load!';
                
                if (loadingErrors.length > 0) {
                    const errorContainer = document.getElementById('error-details');
                    errorContainer.style.display = 'block';
                    errorContainer.innerHTML = `
                        <div class="alert alert-warning">
                            <h6>Loading Errors:</h6>
                            <ul>
                                ${loadingErrors.map(error => `<li><code>${error}</code></li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
            }
        }
        
        function testTransformasiBarang() {
            try {
                // Initialize sample data
                initializeSampleData();
                
                // Test initialization
                if (typeof initializeTransformasiBarang === 'function') {
                    initializeTransformasiBarang();
                    showAlert('Transformasi Barang initialized successfully!', 'success');
                } else {
                    showAlert('initializeTransformasiBarang function not found!', 'danger');
                }
            } catch (error) {
                console.error('Test error:', error);
                showAlert(`Test failed: ${error.message}`, 'danger');
            }
        }
        
        function initializeSampleData() {
            const sampleData = [
                {
                    kode: 'BRG001-KG',
                    nama: 'Beras Premium (Kilogram)',
                    satuan: 'kg',
                    stok: 100,
                    baseProduct: 'BRG001'
                },
                {
                    kode: 'BRG001-GR',
                    nama: 'Beras Premium (Gram)',
                    satuan: 'gram',
                    stok: 50000,
                    baseProduct: 'BRG001'
                },
                {
                    kode: 'BRG002-LT',
                    nama: 'Minyak Goreng (Liter)',
                    satuan: 'liter',
                    stok: 50,
                    baseProduct: 'BRG002'
                },
                {
                    kode: 'BRG002-ML',
                    nama: 'Minyak Goreng (Mililiter)',
                    satuan: 'ml',
                    stok: 25000,
                    baseProduct: 'BRG002'
                }
            ];

            const conversionRatios = [
                {
                    baseProduct: 'BRG001',
                    conversions: [
                        { from: 'kg', to: 'gram', ratio: 1000 },
                        { from: 'gram', to: 'kg', ratio: 0.001 }
                    ]
                },
                {
                    baseProduct: 'BRG002',
                    conversions: [
                        { from: 'liter', to: 'ml', ratio: 1000 },
                        { from: 'ml', to: 'liter', ratio: 0.001 }
                    ]
                }
            ];

            localStorage.setItem('masterBarang', JSON.stringify(sampleData));
            localStorage.setItem('barang', JSON.stringify(sampleData));
            localStorage.setItem('conversionRatios', JSON.stringify(conversionRatios));
            localStorage.setItem('currentUser', 'Test User');
            
            console.log('Sample data initialized');
        }
        
        function fixAndRedirect() {
            try {
                // Initialize sample data
                initializeSampleData();
                
                // Set user data
                window.currentUser = { name: 'Test User', role: 'kasir' };
                
                // Redirect to transformasi barang page
                window.location.href = 'transformasi_barang.html';
            } catch (error) {
                console.error('Fix error:', error);
                showAlert(`Fix failed: ${error.message}`, 'danger');
            }
        }
        
        function showAlert(message, type = 'info') {
            const alertContainer = document.createElement('div');
            alertContainer.className = `alert alert-${type} alert-dismissible fade show mt-3`;
            alertContainer.innerHTML = `
                <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.querySelector('.container').appendChild(alertContainer);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                if (alertContainer.parentNode) {
                    alertContainer.remove();
                }
            }, 5000);
        }
        
        // Check loading status after a short delay
        setTimeout(checkFileLoadingStatus, 1000);
    </script>
</body>
</html>