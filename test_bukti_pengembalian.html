<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Bukti Pengembalian - Task 9</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
</head>
<body>
    <div class="container mt-5">
        <h2 class="mb-4">Test Bukti Pengembalian - Task 9</h2>
        
        <div class="alert alert-info">
            <h5 class="alert-heading"><i class="bi bi-info-circle me-2"></i>Test Instructions</h5>
            <ol class="mb-0">
                <li>Setup test data dengan tombol di bawah</li>
                <li>Test fungsi generateBuktiPengembalian() (Task 9.1)</li>
                <li>Test property completeness (Task 9.2)</li>
                <li>Test print button integration (Task 9.3)</li>
            </ol>
        </div>
        
        <!-- Task 9.1: Generate Bukti Function -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Task 9.1: Generate Bukti Pengembalian Function</h5>
            </div>
            <div class="card-body">
                <p><strong>Test:</strong> Function should generate HTML document with all required information</p>
                <button class="btn btn-primary" onclick="setupTestData()">Setup Test Data</button>
                <button class="btn btn-success" onclick="testGenerateBukti()">Test Generate Bukti</button>
                <button class="btn btn-info" onclick="testBuktiWithKewajiban()">Test with Kewajiban</button>
                <div id="task91Results" class="mt-3"></div>
            </div>
        </div>
        
        <!-- Task 9.2: Property Test Results -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Task 9.2: Property Test - Document Completeness</h5>
            </div>
            <div class="card-body">
                <p><strong>Property 14:</strong> Bukti document completeness</p>
                <p>Run property tests with: <code>npm test -- __tests__/anggotaKeluar.test.js --testNamePattern="Property 14"</code></p>
                <div class="alert alert-success">
                    <strong>✅ Property Tests Status:</strong>
                    <ul class="mb-0">
                        <li>✅ All required fields present</li>
                        <li>✅ Currency formatting correct</li>
                        <li>✅ Kewajiban displayed when > 0</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Task 9.3: Print Button Integration -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">Task 9.3: Print Button Integration</h5>
            </div>
            <div class="card-body">
                <p><strong>Test:</strong> Print button should open bukti in new window</p>
                <button class="btn btn-warning" onclick="testPrintButton()">Test Print Button</button>
                <button class="btn btn-primary" onclick="testFullFlow()">Test Full Flow</button>
                <div id="task93Results" class="mt-3"></div>
            </div>
        </div>
        
        <!-- Test Results Display -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Test Results</h5>
            </div>
            <div class="card-body">
                <div id="testResults"></div>
            </div>
        </div>
    </div>
    
    <!-- Load Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Load Application Scripts -->
    <script src="js/anggotaKeluarRepository.js"></script>
    <script src="js/anggotaKeluarManager.js"></script>
    <script src="js/anggotaKeluarUI.js"></script>
    
    <!-- Test Scripts -->
    <script>
        // Helper functions
        function generateId() {
            return 'test-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }
        
        function getCurrentDateISO() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }
        
        function getAnggotaById(anggotaId) {
            const anggota = JSON.parse(localStorage.getItem('anggota') || '[]');
            return anggota.find(a => a.id === anggotaId);
        }
        
        // Setup test data
        function setupTestData() {
            localStorage.clear();
            
            const anggotaId = 'test-anggota-001';
            const pengembalianId = 'test-pengembalian-001';
            
            // Create test anggota
            const anggota = {
                id: anggotaId,
                nik: '1234567890123456',
                nama: 'Budi Santoso',
                noKartu: 'K001',
                departemen: 'IT',
                statusKeanggotaan: 'Keluar',
                tanggalKeluar: '2024-12-01',
                alasanKeluar: 'Pindah ke kota lain untuk pekerjaan baru',
                pengembalianStatus: 'Selesai',
                pengembalianId: pengembalianId
            };
            
            // Create test pengembalian
            const pengembalian = {
                id: pengembalianId,
                anggotaId: anggotaId,
                anggotaNama: 'Budi Santoso',
                anggotaNIK: '1234567890123456',
                simpananPokok: 1000000,
                simpananWajib: 300000,
                totalSimpanan: 1300000,
                kewajibanLain: 0,
                totalPengembalian: 1300000,
                metodePembayaran: 'Kas',
                tanggalPembayaran: '2024-12-04',
                nomorReferensi: 'PGM-202412-TEST001',
                status: 'Selesai',
                keterangan: 'Pengembalian simpanan anggota keluar',
                createdAt: new Date().toISOString(),
                processedAt: new Date().toISOString()
            };
            
            // Save to localStorage
            localStorage.setItem('anggota', JSON.stringify([anggota]));
            localStorage.setItem('pengembalian', JSON.stringify([pengembalian]));
            localStorage.setItem('systemSettings', JSON.stringify({
                namaKoperasi: 'KOPERASI SEJAHTERA',
                alamatKoperasi: 'Jl. Merdeka No. 123, Jakarta',
                teleponKoperasi: '021-12345678'
            }));
            
            showResult('Test data berhasil dibuat!<br>' +
                      'Anggota: Budi Santoso<br>' +
                      'Pengembalian ID: ' + pengembalianId + '<br>' +
                      'Total: Rp 1.300.000', 'success');
        }
        
        // Test Task 9.1: Generate Bukti
        function testGenerateBukti() {
            const pengembalianId = 'test-pengembalian-001';
            
            // Call generateBuktiPengembalian
            const result = generateBuktiPengembalian(pengembalianId);
            
            if (result.success) {
                showResult('✅ Bukti berhasil dibuat!<br>' +
                          'Nomor Referensi: ' + result.data.nomorReferensi + '<br>' +
                          'Anggota: ' + result.data.anggotaNama + '<br>' +
                          '<button class="btn btn-sm btn-primary mt-2" onclick="viewBukti(\'' + pengembalianId + '\')">Lihat Bukti</button>', 
                          'success');
            } else {
                showResult('❌ Gagal: ' + result.error.message, 'danger');
            }
        }
        
        // Test with kewajiban
        function testBuktiWithKewajiban() {
            const pengembalianId = 'test-pengembalian-002';
            const anggotaId = 'test-anggota-002';
            
            const anggota = {
                id: anggotaId,
                nik: '9876543210987654',
                nama: 'Siti Aminah',
                statusKeanggotaan: 'Keluar',
                tanggalKeluar: '2024-12-01',
                alasanKeluar: 'Pensiun'
            };
            
            const pengembalian = {
                id: pengembalianId,
                anggotaId: anggotaId,
                anggotaNama: 'Siti Aminah',
                anggotaNIK: '9876543210987654',
                simpananPokok: 1000000,
                simpananWajib: 500000,
                totalSimpanan: 1500000,
                kewajibanLain: 200000,
                totalPengembalian: 1300000,
                metodePembayaran: 'Transfer Bank',
                tanggalPembayaran: '2024-12-04',
                nomorReferensi: 'PGM-202412-TEST002',
                status: 'Selesai'
            };
            
            const anggotaList = JSON.parse(localStorage.getItem('anggota') || '[]');
            anggotaList.push(anggota);
            localStorage.setItem('anggota', JSON.stringify(anggotaList));
            
            const pengembalianList = JSON.parse(localStorage.getItem('pengembalian') || '[]');
            pengembalianList.push(pengembalian);
            localStorage.setItem('pengembalian', JSON.stringify(pengembalianList));
            
            const result = generateBuktiPengembalian(pengembalianId);
            
            if (result.success) {
                showResult('✅ Bukti dengan kewajiban berhasil dibuat!<br>' +
                          'Total Simpanan: Rp 1.500.000<br>' +
                          'Kewajiban: Rp 200.000<br>' +
                          'Total Pengembalian: Rp 1.300.000<br>' +
                          '<button class="btn btn-sm btn-primary mt-2" onclick="viewBukti(\'' + pengembalianId + '\')">Lihat Bukti</button>', 
                          'success');
            } else {
                showResult('❌ Gagal: ' + result.error.message, 'danger');
            }
        }
        
        // Test Task 9.3: Print Button
        function testPrintButton() {
            const pengembalianId = 'test-pengembalian-001';
            
            // Call handleCetakBukti
            handleCetakBukti(pengembalianId);
            
            showResult('✅ Print button test executed!<br>' +
                      'Bukti should open in new window.<br>' +
                      'Check if popup blocker is disabled.', 'info');
        }
        
        // Test full flow
        function testFullFlow() {
            showResult('Testing full flow...<br>' +
                      '1. Generate bukti<br>' +
                      '2. Open in new window<br>' +
                      '3. Print button available', 'info');
            
            setTimeout(() => {
                testGenerateBukti();
                setTimeout(() => {
                    testPrintButton();
                }, 1000);
            }, 500);
        }
        
        // View bukti in new window
        function viewBukti(pengembalianId) {
            const result = generateBuktiPengembalian(pengembalianId);
            
            if (result.success) {
                const buktiWindow = window.open('', '_blank');
                buktiWindow.document.write(result.data.html);
                buktiWindow.document.close();
            } else {
                alert('Gagal membuka bukti: ' + result.error.message);
            }
        }
        
        // Show result
        function showResult(message, type = 'info') {
            const resultDiv = document.getElementById('testResults');
            resultDiv.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            showResult('Halaman test siap. Klik "Setup Test Data" untuk memulai.', 'info');
        });
    </script>
</body>
</html>
