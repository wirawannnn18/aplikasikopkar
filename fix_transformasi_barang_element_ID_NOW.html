<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Element ID Transformasi Barang - SEKARANG</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .fix-card {
            border: 2px solid #dc3545;
            border-radius: 15px;
            background: linear-gradient(135deg, #fff5f5 0%, #ffe6e6 100%);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
        .fix-button {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            border: none;
            border-radius: 10px;
            padding: 12px 24px;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .fix-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(220,53,69,0.3);
        }
        .code-output {
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
        }
        .element-check {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="fix-card p-4 mb-4">
                    <h2><i class="bi bi-exclamation-triangle me-2"></i>Fix Element ID Error - SEKARANG</h2>
                    <p class="text-muted mb-4">Perbaikan untuk error: "Product select elements not found"</p>
                    
                    <!-- Error Info -->
                    <div class="alert alert-danger">
                        <h6><i class="bi bi-bug me-2"></i>Error yang Ditemukan:</h6>
                        <code>transformasiBarangInit.js:147 Product select elements not found - checking for correct IDs</code>
                        <p class="mt-2 mb-0">Script mencari elemen dropdown tetapi tidak menemukannya saat halaman dimuat.</p>
                    </div>
                    
                    <!-- Status Section -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="bi bi-search me-2"></i>Element Check</h6>
                                </div>
                                <div class="card-body">
                                    <div id="element-status">
                                        <div class="mb-2">
                                            <span class="status-indicator status-warning"></span>
                                            <span>Checking elements...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="bi bi-tools me-2"></i>Quick Fix</h6>
                                </div>
                                <div class="card-body">
                                    <button class="btn fix-button w-100 mb-2" onclick="fixElementIDError()">
                                        <i class="bi bi-wrench me-2"></i>
                                        Fix Element ID Error
                                    </button>
                                    <button class="btn btn-primary w-100 mb-2" onclick="testElements()">
                                        <i class="bi bi-search me-2"></i>
                                        Test Elements
                                    </button>
                                    <button class="btn btn-success w-100" onclick="openTransformationPage()">
                                        <i class="bi bi-box-arrow-up-right me-2"></i>
                                        Test Halaman Transformasi
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Alert Container -->
                    <div id="alert-container"></div>
                    
                    <!-- Element Details -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6><i class="bi bi-list-check me-2"></i>Element Details</h6>
                        </div>
                        <div class="card-body">
                            <div id="element-details">
                                <p class="text-muted">Run element check to see details...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Output Section -->
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="bi bi-terminal me-2"></i>Fix Log</h6>
                            <button class="btn btn-sm btn-outline-secondary float-end" onclick="clearLog()">
                                <i class="bi bi-trash me-1"></i>Clear
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="output-log" class="code-output">
                                <div class="text-muted">Ready to fix element ID error...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let logContainer;
        let statusContainer;
        let detailsContainer;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            logContainer = document.getElementById('output-log');
            statusContainer = document.getElementById('element-status');
            detailsContainer = document.getElementById('element-details');
            
            log('System initialized', 'info');
            checkElements();
        });
        
        /**
         * Log message to output
         */
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#61dafb',
                success: '#4caf50',
                warning: '#ff9800',
                error: '#f44336'
            };
            
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `
                <span style="color: #888;">[${timestamp}]</span> 
                <span style="color: ${colors[type] || colors.info};">[${type.toUpperCase()}]</span> 
                ${message}
            `;
            
            if (logContainer) {
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            
            console.log(`[${timestamp}] [${type.toUpperCase()}] ${message}`);
        }
        
        /**
         * Show alert
         */
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container');
            const alertId = 'alert-' + Date.now();
            
            const alertHtml = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            alertContainer.insertAdjacentHTML('beforeend', alertHtml);
            
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) alert.remove();
            }, 5000);
        }
        
        /**
         * Update status indicator
         */
        function updateStatus(label, status, message = '') {
            const statusClass = status === 'success' ? 'status-success' : 
                               status === 'warning' ? 'status-warning' : 'status-error';
            
            const statusHtml = `
                <div class="mb-2">
                    <span class="status-indicator ${statusClass}"></span>
                    <span><strong>${label}:</strong> ${message}</span>
                </div>
            `;
            
            if (statusContainer) {
                const existingStatus = Array.from(statusContainer.children).find(child => 
                    child.textContent.includes(label)
                );
                
                if (existingStatus) {
                    existingStatus.outerHTML = statusHtml;
                } else {
                    statusContainer.insertAdjacentHTML('beforeend', statusHtml);
                }
            }
        }
        
        /**
         * Check elements in current page
         */
        function checkElements() {
            log('Checking dropdown elements...', 'info');
            
            // Elements to check
            const elementsToCheck = [
                { id: 'sourceItem', name: 'Source Item Dropdown' },
                { id: 'targetItem', name: 'Target Item Dropdown' },
                { id: 'quantity', name: 'Quantity Input' },
                { id: 'conversion-info', name: 'Conversion Info' },
                { id: 'submit-transformation', name: 'Submit Button' },
                { id: 'reset-form', name: 'Reset Button' }
            ];
            
            let foundElements = 0;
            let missingElements = [];
            let elementDetails = '';
            
            elementsToCheck.forEach(element => {
                const domElement = document.getElementById(element.id);
                const exists = !!domElement;
                
                if (exists) {
                    foundElements++;
                    updateStatus(element.name, 'success', 'Found');
                    log(`✓ ${element.name} (${element.id}): Found`, 'success');
                    
                    elementDetails += `
                        <div class="element-check">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            <strong>${element.name}</strong> (ID: ${element.id})
                            <div class="small text-muted">Type: ${domElement.tagName.toLowerCase()}, Class: ${domElement.className}</div>
                        </div>
                    `;
                } else {
                    missingElements.push(element);
                    updateStatus(element.name, 'error', 'Not Found');
                    log(`✗ ${element.name} (${element.id}): Not Found`, 'error');
                    
                    elementDetails += `
                        <div class="element-check border-danger">
                            <i class="bi bi-x-circle text-danger me-2"></i>
                            <strong>${element.name}</strong> (ID: ${element.id})
                            <div class="small text-danger">Element not found in DOM</div>
                        </div>
                    `;
                }
            });
            
            // Update details container
            if (detailsContainer) {
                detailsContainer.innerHTML = elementDetails;
            }
            
            // Summary
            const totalElements = elementsToCheck.length;
            log(`Element check completed: ${foundElements}/${totalElements} found`, foundElements === totalElements ? 'success' : 'warning');
            
            if (missingElements.length > 0) {
                log(`Missing elements: ${missingElements.map(e => e.id).join(', ')}`, 'error');
                showAlert(`${missingElements.length} elemen tidak ditemukan. Ini normal karena kita sedang di halaman diagnostic.`, 'warning');
            } else {
                showAlert('Semua elemen ditemukan!', 'success');
            }
            
            return {
                total: totalElements,
                found: foundElements,
                missing: missingElements
            };
        }
        
        /**
         * Fix element ID error
         */
        async function fixElementIDError() {
            log('=== STARTING ELEMENT ID FIX ===', 'info');
            showAlert('Memulai perbaikan element ID error...', 'info');
            
            try {
                // Step 1: Initialize data first
                log('Step 1: Initializing master barang data...', 'info');
                await initializeMasterBarangData();
                
                // Step 2: Create improved initialization script
                log('Step 2: Creating improved initialization script...', 'info');
                createImprovedInitScript();
                
                // Step 3: Create element-safe loader
                log('Step 3: Creating element-safe loader...', 'info');
                createElementSafeLoader();
                
                // Step 4: Test the fix
                log('Step 4: Testing the fix...', 'info');
                await testElementFix();
                
                log('=== ELEMENT ID FIX COMPLETED ===', 'success');
                showAlert('Perbaikan element ID error berhasil! Silakan test halaman transformasi.', 'success');
                
            } catch (error) {
                log(`ERROR: ${error.message}`, 'error');
                showAlert(`Error perbaikan: ${error.message}`, 'danger');
                throw error;
            }
        }
        
        /**
         * Initialize master barang data
         */
        async function initializeMasterBarangData() {
            const sampleData = [
                {
                    kode: 'BRG001-KG',
                    nama: 'Beras Premium (Kilogram)',
                    satuan: 'kg',
                    stok: 100,
                    baseProduct: 'BRG001',
                    hargaBeli: 12000,
                    hargaJual: 15000
                },
                {
                    kode: 'BRG001-GR',
                    nama: 'Beras Premium (Gram)',
                    satuan: 'gram',
                    stok: 50000,
                    baseProduct: 'BRG001',
                    hargaBeli: 12,
                    hargaJual: 15
                },
                {
                    kode: 'BRG002-LT',
                    nama: 'Minyak Goreng (Liter)',
                    satuan: 'liter',
                    stok: 50,
                    baseProduct: 'BRG002',
                    hargaBeli: 18000,
                    hargaJual: 22000
                },
                {
                    kode: 'BRG002-ML',
                    nama: 'Minyak Goreng (Mililiter)',
                    satuan: 'ml',
                    stok: 25000,
                    baseProduct: 'BRG002',
                    hargaBeli: 18,
                    hargaJual: 22
                },
                {
                    kode: 'BRG003-DUS',
                    nama: 'Air Mineral (Dus)',
                    satuan: 'dus',
                    stok: 20,
                    baseProduct: 'BRG003',
                    hargaBeli: 48000,
                    hargaJual: 60000
                },
                {
                    kode: 'BRG003-BTL',
                    nama: 'Air Mineral (Botol)',
                    satuan: 'botol',
                    stok: 480,
                    baseProduct: 'BRG003',
                    hargaBeli: 2000,
                    hargaJual: 2500
                }
            ];
            
            const conversionRatios = [
                {
                    baseProduct: 'BRG001',
                    conversions: [
                        { from: 'kg', to: 'gram', ratio: 1000 },
                        { from: 'gram', to: 'kg', ratio: 0.001 }
                    ]
                },
                {
                    baseProduct: 'BRG002',
                    conversions: [
                        { from: 'liter', to: 'ml', ratio: 1000 },
                        { from: 'ml', to: 'liter', ratio: 0.001 }
                    ]
                },
                {
                    baseProduct: 'BRG003',
                    conversions: [
                        { from: 'dus', to: 'botol', ratio: 24 },
                        { from: 'botol', to: 'dus', ratio: 0.041667 }
                    ]
                }
            ];
            
            // Save to localStorage
            localStorage.setItem('masterBarang', JSON.stringify(sampleData));
            localStorage.setItem('barang', JSON.stringify(sampleData));
            localStorage.setItem('conversionRatios', JSON.stringify(conversionRatios));
            
            log(`Master barang data initialized: ${sampleData.length} items, ${conversionRatios.length} conversion groups`, 'success');
        }
        
        /**
         * Create improved initialization script
         */
        function createImprovedInitScript() {
            const improvedScript = `
/**
 * Improved Transformasi Barang Initialization
 * Fixes element ID error by ensuring elements exist before accessing them
 */

// Global flag to prevent multiple initializations
let transformasiBarangInitialized = false;

/**
 * Safe element getter with retry mechanism
 */
function safeGetElement(id, maxRetries = 10, delay = 100) {
    return new Promise((resolve, reject) => {
        let attempts = 0;
        
        function tryGetElement() {
            const element = document.getElementById(id);
            if (element) {
                console.log(\`✓ Element found: \${id}\`);
                resolve(element);
                return;
            }
            
            attempts++;
            if (attempts >= maxRetries) {
                console.warn(\`✗ Element not found after \${maxRetries} attempts: \${id}\`);
                resolve(null); // Don't reject, just return null
                return;
            }
            
            console.log(\`Attempt \${attempts}/\${maxRetries} to find element: \${id}\`);
            setTimeout(tryGetElement, delay);
        }
        
        tryGetElement();
    });
}

/**
 * Initialize transformasi barang with element safety
 */
async function initializeTransformasiBarangSafe() {
    if (transformasiBarangInitialized) {
        console.log('Transformasi barang already initialized');
        return;
    }
    
    console.log('Starting safe transformasi barang initialization...');
    
    try {
        // Wait for DOM to be fully loaded
        if (document.readyState !== 'complete') {
            await new Promise(resolve => {
                if (document.readyState === 'complete') {
                    resolve();
                } else {
                    window.addEventListener('load', resolve);
                }
            });
        }
        
        // Get elements safely
        const sourceSelect = await safeGetElement('sourceItem');
        const targetSelect = await safeGetElement('targetItem');
        const quantityInput = await safeGetElement('quantity');
        
        if (!sourceSelect || !targetSelect) {
            console.warn('Required dropdown elements not found, skipping dropdown population');
            return;
        }
        
        console.log('All required elements found, proceeding with initialization...');
        
        // Load master barang data
        const masterBarang = JSON.parse(localStorage.getItem('masterBarang') || '[]');
        const conversionRatios = JSON.parse(localStorage.getItem('conversionRatios') || '[]');
        
        if (masterBarang.length === 0) {
            console.warn('No master barang data found');
            return;
        }
        
        console.log(\`Loading \${masterBarang.length} items into dropdowns...\`);
        
        // Populate source dropdown
        sourceSelect.innerHTML = '<option value="">Pilih barang asal...</option>';
        targetSelect.innerHTML = '<option value="">Pilih barang tujuan...</option>';
        
        // Group items by base product
        const baseProducts = {};
        masterBarang.forEach(item => {
            const baseProduct = item.baseProduct || item.kode.split('-')[0];
            if (!baseProducts[baseProduct]) {
                baseProducts[baseProduct] = [];
            }
            baseProducts[baseProduct].push(item);
        });
        
        // Add items to dropdowns
        Object.entries(baseProducts).forEach(([baseProduct, items]) => {
            if (items.length > 1) { // Only transformable products
                items.forEach(item => {
                    // Source dropdown - only items with stock > 0
                    if (item.stok > 0) {
                        const sourceOption = document.createElement('option');
                        sourceOption.value = item.kode;
                        sourceOption.textContent = \`\${item.nama} (Stok: \${item.stok} \${item.satuan})\`;
                        sourceSelect.appendChild(sourceOption);
                    }
                    
                    // Target dropdown - all items
                    const targetOption = document.createElement('option');
                    targetOption.value = item.kode;
                    targetOption.textContent = \`\${item.nama} (Stok: \${item.stok} \${item.satuan})\`;
                    targetSelect.appendChild(targetOption);
                });
            }
        });
        
        // Enable target dropdown
        targetSelect.disabled = false;
        
        // Setup event listeners
        setupEventListenersSafe(sourceSelect, targetSelect, quantityInput);
        
        transformasiBarangInitialized = true;
        console.log('✓ Transformasi barang initialization completed successfully');
        
        // Show success message if possible
        if (typeof showAlert === 'function') {
            showAlert('Sistem transformasi barang berhasil dimuat!', 'success');
        }
        
    } catch (error) {
        console.error('Error in safe transformasi barang initialization:', error);
    }
}

/**
 * Setup event listeners safely
 */
function setupEventListenersSafe(sourceSelect, targetSelect, quantityInput) {
    if (sourceSelect) {
        sourceSelect.addEventListener('change', function() {
            updateConversionInfoSafe();
        });
    }
    
    if (targetSelect) {
        targetSelect.addEventListener('change', function() {
            updateConversionInfoSafe();
        });
    }
    
    if (quantityInput) {
        quantityInput.addEventListener('input', function() {
            updateConversionInfoSafe();
        });
    }
}

/**
 * Update conversion info safely
 */
function updateConversionInfoSafe() {
    const sourceSelect = document.getElementById('sourceItem');
    const targetSelect = document.getElementById('targetItem');
    const quantityInput = document.getElementById('quantity');
    const conversionInfo = document.getElementById('conversion-info');
    const submitButton = document.getElementById('submit-transformation');
    
    if (!sourceSelect || !targetSelect || !quantityInput || !conversionInfo) {
        return;
    }
    
    const sourceValue = sourceSelect.value;
    const targetValue = targetSelect.value;
    const quantity = parseFloat(quantityInput.value) || 0;
    
    if (!sourceValue || !targetValue) {
        conversionInfo.innerHTML = '<span class="text-muted">Pilih item untuk melihat rasio konversi</span>';
        if (submitButton) submitButton.disabled = true;
        return;
    }
    
    try {
        // Get item details
        const masterBarang = JSON.parse(localStorage.getItem('masterBarang') || '[]');
        const sourceItem = masterBarang.find(item => item.kode === sourceValue);
        const targetItem = masterBarang.find(item => item.kode === targetValue);
        
        if (!sourceItem || !targetItem) {
            conversionInfo.innerHTML = '<span class="text-danger">Item tidak ditemukan</span>';
            if (submitButton) submitButton.disabled = true;
            return;
        }
        
        // Check if same base product
        const sourceBaseProduct = sourceItem.baseProduct || sourceItem.kode.split('-')[0];
        const targetBaseProduct = targetItem.baseProduct || targetItem.kode.split('-')[0];
        
        if (sourceBaseProduct !== targetBaseProduct) {
            conversionInfo.innerHTML = '<span class="text-warning">Item harus dari produk yang sama</span>';
            if (submitButton) submitButton.disabled = true;
            return;
        }
        
        // Find conversion ratio
        let ratio = 1;
        const conversionRatios = JSON.parse(localStorage.getItem('conversionRatios') || '[]');
        const productRatios = conversionRatios.find(r => r.baseProduct === sourceBaseProduct);
        
        if (productRatios && productRatios.conversions) {
            const conversion = productRatios.conversions.find(c => 
                c.from === sourceItem.satuan && c.to === targetItem.satuan
            );
            if (conversion) {
                ratio = conversion.ratio;
            }
        }
        
        const targetQuantity = quantity * ratio;
        const stockSufficient = sourceItem.stok >= quantity;
        
        conversionInfo.innerHTML = \`
            <div class="small">
                <div><strong>Rasio:</strong> 1 \${sourceItem.satuan} = \${ratio} \${targetItem.satuan}</div>
                \${quantity > 0 ? \`<div><strong>Hasil:</strong> \${quantity} \${sourceItem.satuan} → \${targetQuantity.toFixed(3)} \${targetItem.satuan}</div>\` : ''}
                <div class="mt-1">
                    <span class="badge bg-\${stockSufficient ? 'success' : 'danger'}">
                        Stok \${sourceItem.nama}: \${sourceItem.stok} \${sourceItem.satuan}
                    </span>
                </div>
            </div>
        \`;
        
        // Enable/disable submit button
        if (submitButton) {
            const canSubmit = sourceValue && targetValue && quantity > 0 && stockSufficient && sourceValue !== targetValue;
            submitButton.disabled = !canSubmit;
        }
        
    } catch (error) {
        console.error('Error updating conversion info:', error);
        conversionInfo.innerHTML = '<span class="text-danger">Error memuat info konversi</span>';
    }
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeTransformasiBarangSafe);
} else {
    initializeTransformasiBarangSafe();
}

// Also try to initialize after a short delay to ensure all elements are loaded
setTimeout(initializeTransformasiBarangSafe, 1000);

// Export for global access
window.initializeTransformasiBarangSafe = initializeTransformasiBarangSafe;
window.updateConversionInfoSafe = updateConversionInfoSafe;
`;
            
            // Save the improved script
            const blob = new Blob([improvedScript], { type: 'application/javascript' });
            const url = URL.createObjectURL(blob);
            
            // Create download link
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = 'transformasiBarangInitSafe.js';
            downloadLink.style.display = 'none';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            URL.revokeObjectURL(url);
            
            log('Improved initialization script created and downloaded', 'success');
        }
        
        /**
         * Create element-safe loader
         */
        function createElementSafeLoader() {
            const loaderScript = `
<!-- Add this script to transformasi_barang.html before closing </body> tag -->
<script>
// Element-safe loader for transformasi barang
(function() {
    'use strict';
    
    console.log('Loading element-safe transformasi barang loader...');
    
    // Function to populate dropdowns safely
    function populateDropdownsSafe() {
        const sourceSelect = document.getElementById('sourceItem');
        const targetSelect = document.getElementById('targetItem');
        
        if (!sourceSelect || !targetSelect) {
            console.warn('Dropdown elements not found, retrying in 500ms...');
            setTimeout(populateDropdownsSafe, 500);
            return;
        }
        
        console.log('Dropdown elements found, populating...');
        
        try {
            const masterBarang = JSON.parse(localStorage.getItem('masterBarang') || '[]');
            
            if (masterBarang.length === 0) {
                console.warn('No master barang data found');
                return;
            }
            
            // Clear existing options
            sourceSelect.innerHTML = '<option value="">Pilih barang asal...</option>';
            targetSelect.innerHTML = '<option value="">Pilih barang tujuan...</option>';
            
            // Group by base product
            const baseProducts = {};
            masterBarang.forEach(item => {
                const baseProduct = item.baseProduct || item.kode.split('-')[0];
                if (!baseProducts[baseProduct]) {
                    baseProducts[baseProduct] = [];
                }
                baseProducts[baseProduct].push(item);
            });
            
            // Populate dropdowns
            Object.entries(baseProducts).forEach(([baseProduct, items]) => {
                if (items.length > 1) {
                    items.forEach(item => {
                        if (item.stok > 0) {
                            const sourceOption = new Option(
                                \`\${item.nama} (Stok: \${item.stok} \${item.satuan})\`, 
                                item.kode
                            );
                            sourceSelect.add(sourceOption);
                        }
                        
                        const targetOption = new Option(
                            \`\${item.nama} (Stok: \${item.stok} \${item.satuan})\`, 
                            item.kode
                        );
                        targetSelect.add(targetOption);
                    });
                }
            });
            
            targetSelect.disabled = false;
            console.log(\`Dropdowns populated with \${sourceSelect.options.length - 1} source and \${targetSelect.options.length - 1} target options\`);
            
        } catch (error) {
            console.error('Error populating dropdowns:', error);
        }
    }
    
    // Start population when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', populateDropdownsSafe);
    } else {
        populateDropdownsSafe();
    }
    
    // Also try after a delay
    setTimeout(populateDropdownsSafe, 1000);
    
})();
</script>
`;
            
            // Save the loader script
            const blob = new Blob([loaderScript], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = 'transformasi_barang_element_safe_loader.html';
            downloadLink.style.display = 'none';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            URL.revokeObjectURL(url);
            
            log('Element-safe loader script created and downloaded', 'success');
        }
        
        /**
         * Test element fix
         */
        async function testElementFix() {
            log('Testing element fix...', 'info');
            
            // Test data availability
            const masterBarang = JSON.parse(localStorage.getItem('masterBarang') || '[]');
            const conversionRatios = JSON.parse(localStorage.getItem('conversionRatios') || '[]');
            
            if (masterBarang.length > 0) {
                log(`✓ Master barang data available: ${masterBarang.length} items`, 'success');
            } else {
                log('✗ Master barang data not available', 'error');
            }
            
            if (conversionRatios.length > 0) {
                log(`✓ Conversion ratios available: ${conversionRatios.length} groups`, 'success');
            } else {
                log('✗ Conversion ratios not available', 'error');
            }
            
            // Test transformable items
            const baseProducts = {};
            masterBarang.forEach(item => {
                const baseProduct = item.baseProduct || item.kode.split('-')[0];
                if (!baseProducts[baseProduct]) {
                    baseProducts[baseProduct] = [];
                }
                baseProducts[baseProduct].push(item);
            });
            
            const transformableProducts = Object.values(baseProducts).filter(items => items.length > 1);
            log(`✓ Transformable products: ${transformableProducts.length}`, 'success');
            
            log('Element fix test completed', 'success');
        }
        
        /**
         * Test elements
         */
        async function testElements() {
            log('=== TESTING ELEMENTS ===', 'info');
            showAlert('Menjalankan test elemen...', 'info');
            
            const result = checkElements();
            
            if (result.found === result.total) {
                showAlert('Semua elemen ditemukan!', 'success');
            } else {
                showAlert(`${result.missing.length} elemen tidak ditemukan (normal untuk halaman diagnostic)`, 'warning');
            }
        }
        
        /**
         * Clear log
         */
        function clearLog() {
            if (logContainer) {
                logContainer.innerHTML = '<div class="text-muted">Log cleared...</div>';
            }
        }
        
        /**
         * Open transformation page
         */
        function openTransformationPage() {
            log('Opening transformation page for testing...', 'info');
            window.open('transformasi_barang.html', '_blank');
        }
    </script>
</body>
</html>