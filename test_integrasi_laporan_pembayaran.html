<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Integrasi Laporan Pembayaran</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
</head>
<body>
    <div class="container mt-5">
        <h2>Test Integrasi Laporan Pembayaran Hutang</h2>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>Test Setup</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-primary" onclick="setupTestData()">Setup Test Data</button>
                <button class="btn btn-success ms-2" onclick="testLaporanIntegration()">Test Laporan Integration</button>
                <button class="btn btn-danger ms-2" onclick="clearTestData()">Clear Test Data</button>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>Test Results</h5>
            </div>
            <div class="card-body">
                <div id="testResults"></div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>Laporan Preview</h5>
            </div>
            <div class="card-body">
                <div id="laporanContent"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/reports.js"></script>
    
    <script>
        // Helper function to format rupiah
        function formatRupiah(amount) {
            return 'Rp ' + amount.toLocaleString('id-ID');
        }
        
        // Helper function to show alert
        function showAlert(message, type) {
            alert(message);
        }
        
        function setupTestData() {
            // Setup anggota
            const anggota = [
                {
                    id: 'A001',
                    nik: '1234567890',
                    nama: 'Budi Santoso',
                    departemen: 'IT'
                },
                {
                    id: 'A002',
                    nik: '0987654321',
                    nama: 'Siti Aminah',
                    departemen: 'Finance'
                },
                {
                    id: 'A003',
                    nik: '1122334455',
                    nama: 'Ahmad Yani',
                    departemen: 'IT'
                }
            ];
            
            // Setup penjualan (kredit transactions)
            const penjualan = [
                {
                    id: 'P001',
                    tanggal: '2024-01-15',
                    anggotaId: 'A001',
                    total: 500000,
                    status: 'kredit'
                },
                {
                    id: 'P002',
                    tanggal: '2024-01-20',
                    anggotaId: 'A001',
                    total: 300000,
                    status: 'kredit'
                },
                {
                    id: 'P003',
                    tanggal: '2024-01-25',
                    anggotaId: 'A002',
                    total: 1000000,
                    status: 'kredit'
                },
                {
                    id: 'P004',
                    tanggal: '2024-01-30',
                    anggotaId: 'A003',
                    total: 750000,
                    status: 'kredit'
                }
            ];
            
            // Setup pembayaran hutang
            const pembayaran = [
                {
                    id: 'PAY001',
                    tanggal: '2024-02-01T10:00:00.000Z',
                    anggotaId: 'A001',
                    jenis: 'hutang',
                    jumlah: 200000,
                    status: 'selesai',
                    kasirNama: 'Kasir 1'
                },
                {
                    id: 'PAY002',
                    tanggal: '2024-02-05T10:00:00.000Z',
                    anggotaId: 'A001',
                    jenis: 'hutang',
                    jumlah: 300000,
                    status: 'selesai',
                    kasirNama: 'Kasir 1'
                },
                {
                    id: 'PAY003',
                    tanggal: '2024-02-10T10:00:00.000Z',
                    anggotaId: 'A002',
                    jenis: 'hutang',
                    jumlah: 1000000,
                    status: 'selesai',
                    kasirNama: 'Kasir 2'
                }
            ];
            
            // Setup departemen
            const departemen = [
                { id: 'D001', nama: 'IT' },
                { id: 'D002', nama: 'Finance' }
            ];
            
            // Save to localStorage
            localStorage.setItem('anggota', JSON.stringify(anggota));
            localStorage.setItem('penjualan', JSON.stringify(penjualan));
            localStorage.setItem('pembayaranHutangPiutang', JSON.stringify(pembayaran));
            localStorage.setItem('departemen', JSON.stringify(departemen));
            
            document.getElementById('testResults').innerHTML = `
                <div class="alert alert-success">
                    <h6>Test Data Setup Complete!</h6>
                    <ul>
                        <li>3 Anggota created</li>
                        <li>4 Penjualan kredit created</li>
                        <li>3 Pembayaran hutang created</li>
                        <li>2 Departemen created</li>
                    </ul>
                    <h6>Expected Results:</h6>
                    <ul>
                        <li><strong>Budi Santoso (A001):</strong>
                            <br>Total Kredit: Rp 800,000
                            <br>Total Pembayaran: Rp 500,000
                            <br>Saldo Hutang: Rp 300,000
                            <br>Status: Belum Lunas
                        </li>
                        <li><strong>Siti Aminah (A002):</strong>
                            <br>Total Kredit: Rp 1,000,000
                            <br>Total Pembayaran: Rp 1,000,000
                            <br>Saldo Hutang: Rp 0
                            <br>Status: Lunas
                        </li>
                        <li><strong>Ahmad Yani (A003):</strong>
                            <br>Total Kredit: Rp 750,000
                            <br>Total Pembayaran: Rp 0
                            <br>Saldo Hutang: Rp 750,000
                            <br>Status: Belum Lunas
                        </li>
                    </ul>
                </div>
            `;
        }
        
        function testLaporanIntegration() {
            try {
                // Test calculation functions
                const results = [];
                
                // Test A001 - Budi Santoso
                const a001Kredit = hitungTotalKredit('A001');
                const a001Pembayaran = hitungTotalPembayaranHutang('A001');
                const a001Saldo = hitungSaldoHutang('A001');
                
                results.push({
                    nama: 'Budi Santoso (A001)',
                    kredit: a001Kredit,
                    pembayaran: a001Pembayaran,
                    saldo: a001Saldo,
                    expected: { kredit: 800000, pembayaran: 500000, saldo: 300000 },
                    pass: a001Kredit === 800000 && a001Pembayaran === 500000 && a001Saldo === 300000
                });
                
                // Test A002 - Siti Aminah
                const a002Kredit = hitungTotalKredit('A002');
                const a002Pembayaran = hitungTotalPembayaranHutang('A002');
                const a002Saldo = hitungSaldoHutang('A002');
                
                results.push({
                    nama: 'Siti Aminah (A002)',
                    kredit: a002Kredit,
                    pembayaran: a002Pembayaran,
                    saldo: a002Saldo,
                    expected: { kredit: 1000000, pembayaran: 1000000, saldo: 0 },
                    pass: a002Kredit === 1000000 && a002Pembayaran === 1000000 && a002Saldo === 0
                });
                
                // Test A003 - Ahmad Yani
                const a003Kredit = hitungTotalKredit('A003');
                const a003Pembayaran = hitungTotalPembayaranHutang('A003');
                const a003Saldo = hitungSaldoHutang('A003');
                
                results.push({
                    nama: 'Ahmad Yani (A003)',
                    kredit: a003Kredit,
                    pembayaran: a003Pembayaran,
                    saldo: a003Saldo,
                    expected: { kredit: 750000, pembayaran: 0, saldo: 750000 },
                    pass: a003Kredit === 750000 && a003Pembayaran === 0 && a003Saldo === 750000
                });
                
                // Display results
                let html = '<h6>Calculation Test Results:</h6>';
                results.forEach(r => {
                    const badge = r.pass ? '<span class="badge bg-success">PASS</span>' : '<span class="badge bg-danger">FAIL</span>';
                    html += `
                        <div class="alert ${r.pass ? 'alert-success' : 'alert-danger'}">
                            ${badge} <strong>${r.nama}</strong>
                            <ul class="mb-0 mt-2">
                                <li>Total Kredit: ${formatRupiah(r.kredit)} (Expected: ${formatRupiah(r.expected.kredit)})</li>
                                <li>Total Pembayaran: ${formatRupiah(r.pembayaran)} (Expected: ${formatRupiah(r.expected.pembayaran)})</li>
                                <li>Saldo Hutang: ${formatRupiah(r.saldo)} (Expected: ${formatRupiah(r.expected.saldo)})</li>
                            </ul>
                        </div>
                    `;
                });
                
                const allPass = results.every(r => r.pass);
                html += `<div class="alert ${allPass ? 'alert-success' : 'alert-warning'}">
                    <strong>${allPass ? '✓ All tests passed!' : '⚠ Some tests failed'}</strong>
                </div>`;
                
                document.getElementById('testResults').innerHTML = html;
                
                // Render laporan
                laporanHutangPiutang();
                
            } catch (error) {
                document.getElementById('testResults').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error:</strong> ${error.message}
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        }
        
        function clearTestData() {
            localStorage.removeItem('anggota');
            localStorage.removeItem('penjualan');
            localStorage.removeItem('pembayaranHutangPiutang');
            localStorage.removeItem('departemen');
            
            document.getElementById('testResults').innerHTML = `
                <div class="alert alert-info">
                    Test data cleared from localStorage.
                </div>
            `;
            document.getElementById('laporanContent').innerHTML = '';
        }
    </script>
</body>
</html>
