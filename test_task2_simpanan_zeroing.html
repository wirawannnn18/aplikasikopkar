<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Task 2: Simpanan Balance Zeroing Functions</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .test-pass { color: #28a745; }
        .test-fail { color: #dc3545; }
        .test-section { margin-bottom: 30px; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">
            <i class="bi bi-check-circle me-2"></i>
            Test Task 2: Simpanan Balance Zeroing Functions
        </h1>
        
        <div class="alert alert-info">
            <strong>Testing:</strong>
            <ul class="mb-0">
                <li>zeroSimpananPokok() - Zero out simpanan pokok balance</li>
                <li>zeroSimpananWajib() - Zero out simpanan wajib balance</li>
                <li>zeroSimpananSukarela() - Zero out simpanan sukarela balance</li>
                <li>getTotalSimpananBalance() - Get total balance across all types</li>
            </ul>
        </div>

        <div id="testResults"></div>

        <div class="mt-4">
            <button class="btn btn-primary" onclick="runTests()">
                <i class="bi bi-play-circle me-2"></i>Run Tests
            </button>
            <button class="btn btn-secondary" onclick="clearData()">
                <i class="bi bi-trash me-2"></i>Clear Test Data
            </button>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script src="js/simpanan.js"></script>
    <script>
        function clearData() {
            localStorage.removeItem('anggota');
            localStorage.removeItem('simpananPokok');
            localStorage.removeItem('simpananWajib');
            localStorage.removeItem('simpananSukarela');
            document.getElementById('testResults').innerHTML = '<div class="alert alert-success">Test data cleared!</div>';
        }

        function runTests() {
            const results = [];
            
            // Setup test data
            const testAnggotaId = 'test-anggota-1';
            
            // Test 1: zeroSimpananPokok
            results.push('<div class="test-section"><h3>Test 1: zeroSimpananPokok()</h3>');
            
            // Setup simpanan pokok data
            const simpananPokok = [
                { id: '1', anggotaId: testAnggotaId, jumlah: 1000000, tanggal: '2024-01-01' },
                { id: '2', anggotaId: 'other-anggota', jumlah: 500000, tanggal: '2024-01-01' }
            ];
            localStorage.setItem('simpananPokok', JSON.stringify(simpananPokok));
            
            // Test 1.1: Zero out simpanan pokok
            const result1 = zeroSimpananPokok(testAnggotaId);
            const test1_1 = result1.success === true;
            results.push(`<p class="${test1_1 ? 'test-pass' : 'test-fail'}">
                <i class="bi bi-${test1_1 ? 'check' : 'x'}-circle me-2"></i>
                Should return success: ${test1_1 ? 'PASS' : 'FAIL'}
            </p>`);
            
            const test1_2 = result1.amount === 1000000;
            results.push(`<p class="${test1_2 ? 'test-pass' : 'test-fail'}">
                <i class="bi bi-${test1_2 ? 'check' : 'x'}-circle me-2"></i>
                Should return correct amount (1000000): ${test1_2 ? 'PASS' : 'FAIL'} (got ${result1.amount})
            </p>`);
            
            // Test 1.3: Verify balance is zeroed
            const updatedPokok = JSON.parse(localStorage.getItem('simpananPokok'));
            const testAnggotaPokok = updatedPokok.find(s => s.anggotaId === testAnggotaId);
            const test1_3 = testAnggotaPokok.jumlah === 0;
            results.push(`<p class="${test1_3 ? 'test-pass' : 'test-fail'}">
                <i class="bi bi-${test1_3 ? 'check' : 'x'}-circle me-2"></i>
                Should zero out balance: ${test1_3 ? 'PASS' : 'FAIL'} (balance: ${testAnggotaPokok.jumlah})
            </p>`);
            
            // Test 1.4: Verify other anggota not affected
            const otherAnggotaPokok = updatedPokok.find(s => s.anggotaId === 'other-anggota');
            const test1_4 = otherAnggotaPokok.jumlah === 500000;
            results.push(`<p class="${test1_4 ? 'test-pass' : 'test-fail'}">
                <i class="bi bi-${test1_4 ? 'check' : 'x'}-circle me-2"></i>
                Should not affect other anggota: ${test1_4 ? 'PASS' : 'FAIL'}
            </p>`);
            
            results.push('</div>');
            
            // Test 2: zeroSimpananWajib
            results.push('<div class="test-section"><h3>Test 2: zeroSimpananWajib()</h3>');
            
            // Setup simpanan wajib data
            const simpananWajib = [
                { id: '1', anggotaId: testAnggotaId, jumlah: 500000, tanggal: '2024-01-01' },
                { id: '2', anggotaId: testAnggotaId, jumlah: 300000, tanggal: '2024-02-01' },
                { id: '3', anggotaId: 'other-anggota', jumlah: 400000, tanggal: '2024-01-01' }
            ];
            localStorage.setItem('simpananWajib', JSON.stringify(simpananWajib));
            
            // Test 2.1: Zero out simpanan wajib
            const result2 = zeroSimpananWajib(testAnggotaId);
            const test2_1 = result2.success === true;
            results.push(`<p class="${test2_1 ? 'test-pass' : 'test-fail'}">
                <i class="bi bi-${test2_1 ? 'check' : 'x'}-circle me-2"></i>
                Should return success: ${test2_1 ? 'PASS' : 'FAIL'}
            </p>`);
            
            const test2_2 = result2.amount === 800000;
            results.push(`<p class="${test2_2 ? 'test-pass' : 'test-fail'}">
                <i class="bi bi-${test2_2 ? 'check' : 'x'}-circle me-2"></i>
                Should return correct total amount (800000): ${test2_2 ? 'PASS' : 'FAIL'} (got ${result2.amount})
            </p>`);
            
            // Test 2.3: Verify all balances are zeroed
            const updatedWajib = JSON.parse(localStorage.getItem('simpananWajib'));
            const testAnggotaWajib = updatedWajib.filter(s => s.anggotaId === testAnggotaId);
            const test2_3 = testAnggotaWajib.every(s => s.jumlah === 0);
            results.push(`<p class="${test2_3 ? 'test-pass' : 'test-fail'}">
                <i class="bi bi-${test2_3 ? 'check' : 'x'}-circle me-2"></i>
                Should zero out all balances: ${test2_3 ? 'PASS' : 'FAIL'}
            </p>`);
            
            results.push('</div>');
            
            // Test 3: zeroSimpananSukarela
            results.push('<div class="test-section"><h3>Test 3: zeroSimpananSukarela()</h3>');
            
            // Setup simpanan sukarela data (with setor and tarik)
            const simpananSukarela = [
                { id: '1', anggotaId: testAnggotaId, jumlah: 2000000, tipe: 'setor', tanggal: '2024-01-01' },
                { id: '2', anggotaId: testAnggotaId, jumlah: 500000, tipe: 'tarik', tanggal: '2024-02-01' },
                { id: '3', anggotaId: testAnggotaId, jumlah: 1000000, tipe: 'setor', tanggal: '2024-03-01' },
                { id: '4', anggotaId: 'other-anggota', jumlah: 600000, tipe: 'setor', tanggal: '2024-01-01' }
            ];
            localStorage.setItem('simpananSukarela', JSON.stringify(simpananSukarela));
            
            // Calculate expected balance: 2000000 - 500000 + 1000000 = 2500000
            const expectedBalance = 2500000;
            
            // Test 3.1: Zero out simpanan sukarela
            const result3 = zeroSimpananSukarela(testAnggotaId);
            const test3_1 = result3.success === true;
            results.push(`<p class="${test3_1 ? 'test-pass' : 'test-fail'}">
                <i class="bi bi-${test3_1 ? 'check' : 'x'}-circle me-2"></i>
                Should return success: ${test3_1 ? 'PASS' : 'FAIL'}
            </p>`);
            
            const test3_2 = result3.amount === expectedBalance;
            results.push(`<p class="${test3_2 ? 'test-pass' : 'test-fail'}">
                <i class="bi bi-${test3_2 ? 'check' : 'x'}-circle me-2"></i>
                Should return correct balance (${expectedBalance}): ${test3_2 ? 'PASS' : 'FAIL'} (got ${result3.amount})
            </p>`);
            
            // Test 3.3: Verify balance is zeroed (by adding withdrawal transaction)
            const updatedSukarela = JSON.parse(localStorage.getItem('simpananSukarela'));
            const testAnggotaSukarela = updatedSukarela.filter(s => s.anggotaId === testAnggotaId);
            const finalBalance = testAnggotaSukarela.reduce((sum, s) => 
                sum + (s.tipe === 'tarik' ? -s.jumlah : s.jumlah), 0
            );
            const test3_3 = finalBalance === 0;
            results.push(`<p class="${test3_3 ? 'test-pass' : 'test-fail'}">
                <i class="bi bi-${test3_3 ? 'check' : 'x'}-circle me-2"></i>
                Should zero out balance: ${test3_3 ? 'PASS' : 'FAIL'} (final balance: ${finalBalance})
            </p>`);
            
            // Test 3.4: Verify withdrawal transaction was added
            const withdrawalTransaction = updatedSukarela.find(s => 
                s.anggotaId === testAnggotaId && 
                s.tipe === 'tarik' && 
                s.keterangan && 
                s.keterangan.includes('Pencairan')
            );
            const test3_4 = withdrawalTransaction !== undefined;
            results.push(`<p class="${test3_4 ? 'test-pass' : 'test-fail'}">
                <i class="bi bi-${test3_4 ? 'check' : 'x'}-circle me-2"></i>
                Should add withdrawal transaction: ${test3_4 ? 'PASS' : 'FAIL'}
            </p>`);
            
            results.push('</div>');
            
            // Test 4: getTotalSimpananBalance
            results.push('<div class="test-section"><h3>Test 4: getTotalSimpananBalance()</h3>');
            
            // Setup fresh data for total balance test
            const testAnggotaId2 = 'test-anggota-2';
            localStorage.setItem('simpananPokok', JSON.stringify([
                { id: '1', anggotaId: testAnggotaId2, jumlah: 1000000, tanggal: '2024-01-01' }
            ]));
            localStorage.setItem('simpananWajib', JSON.stringify([
                { id: '1', anggotaId: testAnggotaId2, jumlah: 500000, tanggal: '2024-01-01' },
                { id: '2', anggotaId: testAnggotaId2, jumlah: 300000, tanggal: '2024-02-01' }
            ]));
            localStorage.setItem('simpananSukarela', JSON.stringify([
                { id: '1', anggotaId: testAnggotaId2, jumlah: 2000000, tipe: 'setor', tanggal: '2024-01-01' },
                { id: '2', anggotaId: testAnggotaId2, jumlah: 500000, tipe: 'tarik', tanggal: '2024-02-01' }
            ]));
            
            // Test 4.1: Get total balance
            const balances = getTotalSimpananBalance(testAnggotaId2);
            const test4_1 = balances.pokok === 1000000;
            results.push(`<p class="${test4_1 ? 'test-pass' : 'test-fail'}">
                <i class="bi bi-${test4_1 ? 'check' : 'x'}-circle me-2"></i>
                Should return correct pokok balance (1000000): ${test4_1 ? 'PASS' : 'FAIL'} (got ${balances.pokok})
            </p>`);
            
            const test4_2 = balances.wajib === 800000;
            results.push(`<p class="${test4_2 ? 'test-pass' : 'test-fail'}">
                <i class="bi bi-${test4_2 ? 'check' : 'x'}-circle me-2"></i>
                Should return correct wajib balance (800000): ${test4_2 ? 'PASS' : 'FAIL'} (got ${balances.wajib})
            </p>`);
            
            const test4_3 = balances.sukarela === 1500000;
            results.push(`<p class="${test4_3 ? 'test-pass' : 'test-fail'}">
                <i class="bi bi-${test4_3 ? 'check' : 'x'}-circle me-2"></i>
                Should return correct sukarela balance (1500000): ${test4_3 ? 'PASS' : 'FAIL'} (got ${balances.sukarela})
            </p>`);
            
            const test4_4 = balances.total === 3300000;
            results.push(`<p class="${test4_4 ? 'test-pass' : 'test-fail'}">
                <i class="bi bi-${test4_4 ? 'check' : 'x'}-circle me-2"></i>
                Should return correct total balance (3300000): ${test4_4 ? 'PASS' : 'FAIL'} (got ${balances.total})
            </p>`);
            
            results.push('</div>');
            
            // Test 5: Edge cases
            results.push('<div class="test-section"><h3>Test 5: Edge Cases</h3>');
            
            // Test 5.1: Zero out when already zero
            localStorage.setItem('simpananPokok', JSON.stringify([
                { id: '1', anggotaId: 'test-zero', jumlah: 0, tanggal: '2024-01-01' }
            ]));
            const result5_1 = zeroSimpananPokok('test-zero');
            const test5_1 = result5_1.success === true && result5_1.amount === 0;
            results.push(`<p class="${test5_1 ? 'test-pass' : 'test-fail'}">
                <i class="bi bi-${test5_1 ? 'check' : 'x'}-circle me-2"></i>
                Should handle already zero balance: ${test5_1 ? 'PASS' : 'FAIL'}
            </p>`);
            
            // Test 5.2: Zero out non-existent anggota
            const result5_2 = zeroSimpananPokok('non-existent');
            const test5_2 = result5_2.success === true && result5_2.amount === 0;
            results.push(`<p class="${test5_2 ? 'test-pass' : 'test-fail'}">
                <i class="bi bi-${test5_2 ? 'check' : 'x'}-circle me-2"></i>
                Should handle non-existent anggota: ${test5_2 ? 'PASS' : 'FAIL'}
            </p>`);
            
            // Test 5.3: Get balance for non-existent anggota
            const balances5_3 = getTotalSimpananBalance('non-existent');
            const test5_3 = balances5_3.total === 0;
            results.push(`<p class="${test5_3 ? 'test-pass' : 'test-fail'}">
                <i class="bi bi-${test5_3 ? 'check' : 'x'}-circle me-2"></i>
                Should return zero for non-existent anggota: ${test5_3 ? 'PASS' : 'FAIL'}
            </p>`);
            
            results.push('</div>');
            
            // Summary
            const allTests = [
                test1_1, test1_2, test1_3, test1_4,
                test2_1, test2_2, test2_3,
                test3_1, test3_2, test3_3, test3_4,
                test4_1, test4_2, test4_3, test4_4,
                test5_1, test5_2, test5_3
            ];
            const passedTests = allTests.filter(t => t).length;
            const totalTests = allTests.length;
            
            results.push(`<div class="alert ${passedTests === totalTests ? 'alert-success' : 'alert-warning'}">
                <h4>Summary</h4>
                <p class="mb-0">
                    <strong>${passedTests}/${totalTests}</strong> tests passed
                    ${passedTests === totalTests ? ' <i class="bi bi-check-circle-fill"></i>' : ''}
                </p>
            </div>`);
            
            document.getElementById('testResults').innerHTML = results.join('');
        }
    </script>
</body>
</html>
