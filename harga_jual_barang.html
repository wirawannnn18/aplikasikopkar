<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Berikan Harga Jual Barang - Koperasi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .header-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .card {
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }
        .card-header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 10px 10px 0 0 !important;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
        }
        .table-hover tbody tr:hover {
            background-color: #f8f9fa;
        }
        .price-input {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .price-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .status-badge {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }
        .search-box {
            border-radius: 25px;
            border: 2px solid #e9ecef;
            padding: 0.75rem 1.5rem;
        }
        .search-box:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
    </style>
</head>
<body class="bg-light">
    <!-- Header -->
    <div class="header-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-0"><i class="fas fa-tags me-3"></i>Berikan Harga Jual Barang</h1>
                    <p class="mb-0 mt-2">Kelola harga jual untuk semua barang dari master barang</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light" onclick="window.history.back()">
                        <i class="fas fa-arrow-left me-2"></i>Kembali
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Filter dan Search -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filter dan Pencarian</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">Cari Barang</label>
                        <input type="text" id="searchBarang" class="form-control search-box" 
                               placeholder="Cari berdasarkan kode atau nama barang...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Kategori</label>
                        <select id="filterKategori" class="form-select">
                            <option value="">Semua Kategori</option>
                            <option value="makanan">Makanan</option>
                            <option value="minuman">Minuman</option>
                            <option value="alat-tulis">Alat Tulis</option>
                            <option value="elektronik">Elektronik</option>
                            <option value="lainnya">Lainnya</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Status Harga</label>
                        <select id="filterStatus" class="form-select">
                            <option value="">Semua Status</option>
                            <option value="ada">Sudah Ada Harga</option>
                            <option value="belum">Belum Ada Harga</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabel Harga Jual -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>Daftar Harga Jual Barang</h5>
                <div>
                    <button class="btn btn-success btn-sm me-2" onclick="simpanSemuaHarga()">
                        <i class="fas fa-save me-1"></i>Simpan Semua
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="exportHargaJual()">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th width="10%">Kode Barang</th>
                                <th width="25%">Nama Barang</th>
                                <th width="15%">Kategori</th>
                                <th width="15%">Harga Beli</th>
                                <th width="15%">Harga Jual</th>
                                <th width="10%">Margin (%)</th>
                                <th width="10%">Status</th>
                            </tr>
                        </thead>
                        <tbody id="tabelHargaJual">
                            <!-- Data akan diisi oleh JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Summary -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="text-primary" id="totalBarang">0</h5>
                        <small class="text-muted">Total Barang</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="text-success" id="sudahAda">0</h5>
                        <small class="text-muted">Sudah Ada Harga</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="text-warning" id="belumAda">0</h5>
                        <small class="text-muted">Belum Ada Harga</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="text-info" id="rataMargin">0%</h5>
                        <small class="text-muted">Rata-rata Margin</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Konfirmasi -->
    <div class="modal fade" id="konfirmasiModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Konfirmasi Simpan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Apakah Anda yakin ingin menyimpan semua perubahan harga jual?</p>
                    <div id="ringkasanPerubahan"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-success" onclick="konfirmasiSimpan()">Ya, Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/koperasi.js"></script>
    <script>
        // Data master barang (akan diambil dari localStorage)
        let masterBarang = [];
        let hargaJualData = [];
        let perubahanData = [];

        // Inisialisasi halaman
        document.addEventListener('DOMContentLoaded', function() {
            loadMasterBarang();
            loadHargaJual();
            renderTabelHarga();
            updateSummary();
            
            // Event listeners
            document.getElementById('searchBarang').addEventListener('input', filterData);
            document.getElementById('filterKategori').addEventListener('change', filterData);
            document.getElementById('filterStatus').addEventListener('change', filterData);
        });

        // Load data master barang
        function loadMasterBarang() {
            const stored = localStorage.getItem('masterBarang');
            if (stored) {
                masterBarang = JSON.parse(stored);
            } else {
                // Data contoh jika belum ada
                masterBarang = [
                    {
                        kode: 'BRG001',
                        nama: 'Beras Premium 5kg',
                        kategori: 'makanan',
                        hargaBeli: 65000,
                        satuan: 'kg',
                        stok: 50
                    },
                    {
                        kode: 'BRG002', 
                        nama: 'Minyak Goreng 1L',
                        kategori: 'makanan',
                        hargaBeli: 15000,
                        satuan: 'botol',
                        stok: 30
                    },
                    {
                        kode: 'BRG003',
                        nama: 'Pulpen Pilot',
                        kategori: 'alat-tulis',
                        hargaBeli: 3000,
                        satuan: 'pcs',
                        stok: 100
                    },
                    {
                        kode: 'BRG004',
                        nama: 'Air Mineral 600ml',
                        kategori: 'minuman',
                        hargaBeli: 2500,
                        satuan: 'botol',
                        stok: 200
                    },
                    {
                        kode: 'BRG005',
                        nama: 'Kabel USB Type-C',
                        kategori: 'elektronik',
                        hargaBeli: 25000,
                        satuan: 'pcs',
                        stok: 15
                    }
                ];
                localStorage.setItem('masterBarang', JSON.stringify(masterBarang));
            }
        }

        // Load data harga jual
        function loadHargaJual() {
            const stored = localStorage.getItem('hargaJualBarang');
            if (stored) {
                hargaJualData = JSON.parse(stored);
            } else {
                hargaJualData = [];
            }
        }

        // Render tabel harga
        function renderTabelHarga() {
            const tbody = document.getElementById('tabelHargaJual');
            let html = '';

            masterBarang.forEach(barang => {
                const hargaJual = hargaJualData.find(h => h.kodeBarang === barang.kode);
                const hargaJualValue = hargaJual ? hargaJual.hargaJual : '';
                const margin = hargaJualValue ? (((hargaJualValue - barang.hargaBeli) / barang.hargaBeli) * 100).toFixed(1) : 0;
                const status = hargaJualValue ? 'ada' : 'belum';

                html += `
                    <tr>
                        <td><strong>${barang.kode}</strong></td>
                        <td>${barang.nama}</td>
                        <td><span class="badge bg-secondary">${barang.kategori}</span></td>
                        <td>Rp ${formatRupiah(barang.hargaBeli)}</td>
                        <td>
                            <input type="number" 
                                   class="form-control price-input" 
                                   value="${hargaJualValue}" 
                                   placeholder="Masukkan harga jual"
                                   onchange="updateHargaJual('${barang.kode}', this.value, ${barang.hargaBeli})"
                                   min="${barang.hargaBeli}">
                        </td>
                        <td>
                            <span class="badge ${margin > 0 ? 'bg-success' : 'bg-secondary'}" id="margin-${barang.kode}">
                                ${margin}%
                            </span>
                        </td>
                        <td>
                            <span class="badge status-badge ${status === 'ada' ? 'bg-success' : 'bg-warning'}" id="status-${barang.kode}">
                                ${status === 'ada' ? 'Ada Harga' : 'Belum Ada'}
                            </span>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // Update harga jual
        function updateHargaJual(kodeBarang, hargaJual, hargaBeli) {
            const harga = parseFloat(hargaJual) || 0;
            
            // Validasi harga jual tidak boleh kurang dari harga beli
            if (harga > 0 && harga < hargaBeli) {
                alert('Harga jual tidak boleh kurang dari harga beli!');
                return;
            }

            // Update atau tambah data harga jual
            const existingIndex = hargaJualData.findIndex(h => h.kodeBarang === kodeBarang);
            if (existingIndex >= 0) {
                hargaJualData[existingIndex].hargaJual = harga;
                hargaJualData[existingIndex].tanggalUpdate = new Date().toISOString();
            } else {
                hargaJualData.push({
                    kodeBarang: kodeBarang,
                    hargaJual: harga,
                    tanggalUpdate: new Date().toISOString()
                });
            }

            // Update margin dan status
            const margin = harga > 0 ? (((harga - hargaBeli) / hargaBeli) * 100).toFixed(1) : 0;
            const status = harga > 0 ? 'ada' : 'belum';

            document.getElementById(`margin-${kodeBarang}`).textContent = `${margin}%`;
            document.getElementById(`margin-${kodeBarang}`).className = `badge ${margin > 0 ? 'bg-success' : 'bg-secondary'}`;
            
            document.getElementById(`status-${kodeBarang}`).textContent = status === 'ada' ? 'Ada Harga' : 'Belum Ada';
            document.getElementById(`status-${kodeBarang}`).className = `badge status-badge ${status === 'ada' ? 'bg-success' : 'bg-warning'}`;

            // Track perubahan
            const perubahanIndex = perubahanData.findIndex(p => p.kodeBarang === kodeBarang);
            if (perubahanIndex >= 0) {
                perubahanData[perubahanIndex].hargaJualBaru = harga;
            } else {
                const barang = masterBarang.find(b => b.kode === kodeBarang);
                const hargaLama = hargaJualData.find(h => h.kodeBarang === kodeBarang);
                perubahanData.push({
                    kodeBarang: kodeBarang,
                    namaBarang: barang.nama,
                    hargaJualLama: hargaLama ? hargaLama.hargaJual : 0,
                    hargaJualBaru: harga
                });
            }

            updateSummary();
        }

        // Update summary
        function updateSummary() {
            const totalBarang = masterBarang.length;
            const sudahAda = hargaJualData.filter(h => h.hargaJual > 0).length;
            const belumAda = totalBarang - sudahAda;
            
            // Hitung rata-rata margin
            let totalMargin = 0;
            let countMargin = 0;
            
            masterBarang.forEach(barang => {
                const hargaJual = hargaJualData.find(h => h.kodeBarang === barang.kode);
                if (hargaJual && hargaJual.hargaJual > 0) {
                    const margin = ((hargaJual.hargaJual - barang.hargaBeli) / barang.hargaBeli) * 100;
                    totalMargin += margin;
                    countMargin++;
                }
            });
            
            const rataMargin = countMargin > 0 ? (totalMargin / countMargin).toFixed(1) : 0;

            document.getElementById('totalBarang').textContent = totalBarang;
            document.getElementById('sudahAda').textContent = sudahAda;
            document.getElementById('belumAda').textContent = belumAda;
            document.getElementById('rataMargin').textContent = `${rataMargin}%`;
        }

        // Filter data
        function filterData() {
            const searchTerm = document.getElementById('searchBarang').value.toLowerCase();
            const kategoriFilter = document.getElementById('filterKategori').value;
            const statusFilter = document.getElementById('filterStatus').value;

            const rows = document.querySelectorAll('#tabelHargaJual tr');
            
            rows.forEach(row => {
                const kode = row.cells[0].textContent.toLowerCase();
                const nama = row.cells[1].textContent.toLowerCase();
                const kategori = row.cells[2].textContent.toLowerCase();
                const statusBadge = row.cells[6].querySelector('.status-badge');
                const hasPrice = statusBadge.textContent.includes('Ada Harga');

                let showRow = true;

                // Filter pencarian
                if (searchTerm && !kode.includes(searchTerm) && !nama.includes(searchTerm)) {
                    showRow = false;
                }

                // Filter kategori
                if (kategoriFilter && !kategori.includes(kategoriFilter)) {
                    showRow = false;
                }

                // Filter status
                if (statusFilter === 'ada' && !hasPrice) {
                    showRow = false;
                } else if (statusFilter === 'belum' && hasPrice) {
                    showRow = false;
                }

                row.style.display = showRow ? '' : 'none';
            });
        }

        // Simpan semua harga
        function simpanSemuaHarga() {
            if (perubahanData.length === 0) {
                alert('Tidak ada perubahan untuk disimpan.');
                return;
            }

            // Tampilkan ringkasan perubahan
            let ringkasan = '<ul class="list-group">';
            perubahanData.forEach(item => {
                ringkasan += `
                    <li class="list-group-item d-flex justify-content-between">
                        <span><strong>${item.kodeBarang}</strong> - ${item.namaBarang}</span>
                        <span>Rp ${formatRupiah(item.hargaJualLama)} â†’ Rp ${formatRupiah(item.hargaJualBaru)}</span>
                    </li>
                `;
            });
            ringkasan += '</ul>';

            document.getElementById('ringkasanPerubahan').innerHTML = ringkasan;
            
            const modal = new bootstrap.Modal(document.getElementById('konfirmasiModal'));
            modal.show();
        }

        // Konfirmasi simpan
        function konfirmasiSimpan() {
            try {
                localStorage.setItem('hargaJualBarang', JSON.stringify(hargaJualData));
                
                // Log aktivitas
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    user: getCurrentUser(),
                    action: 'UPDATE_HARGA_JUAL',
                    details: `Memperbarui ${perubahanData.length} harga jual barang`,
                    changes: perubahanData
                };
                
                logActivity(logEntry);
                
                // Reset perubahan
                perubahanData = [];
                
                // Tutup modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('konfirmasiModal'));
                modal.hide();
                
                // Tampilkan notifikasi sukses
                showNotification('Harga jual berhasil disimpan!', 'success');
                
            } catch (error) {
                console.error('Error saving harga jual:', error);
                alert('Terjadi kesalahan saat menyimpan data.');
            }
        }

        // Export harga jual
        function exportHargaJual() {
            const data = masterBarang.map(barang => {
                const hargaJual = hargaJualData.find(h => h.kodeBarang === barang.kode);
                const hargaJualValue = hargaJual ? hargaJual.hargaJual : 0;
                const margin = hargaJualValue > 0 ? (((hargaJualValue - barang.hargaBeli) / barang.hargaBeli) * 100).toFixed(1) : 0;
                
                return {
                    'Kode Barang': barang.kode,
                    'Nama Barang': barang.nama,
                    'Kategori': barang.kategori,
                    'Harga Beli': barang.hargaBeli,
                    'Harga Jual': hargaJualValue,
                    'Margin (%)': margin,
                    'Status': hargaJualValue > 0 ? 'Ada Harga' : 'Belum Ada Harga'
                };
            });

            exportToCSV(data, 'harga_jual_barang');
        }

        // Utility functions
        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID').format(amount);
        }

        function getCurrentUser() {
            return localStorage.getItem('currentUser') || 'Admin';
        }

        function logActivity(entry) {
            const logs = JSON.parse(localStorage.getItem('activityLogs') || '[]');
            logs.push(entry);
            localStorage.setItem('activityLogs', JSON.stringify(logs));
        }

        function showNotification(message, type = 'info') {
            // Implementasi notifikasi toast
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
            toast.style.zIndex = '9999';
            toast.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>${message}
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 3000);
        }

        function exportToCSV(data, filename) {
            const csv = convertToCSV(data);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function convertToCSV(data) {
            if (!data.length) return '';
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => `"${row[header]}"`).join(','))
            ].join('\n');
            
            return csvContent;
        }
    </script>
</body>
</html>