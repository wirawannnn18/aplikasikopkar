<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Barang - Sistem Koperasi</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/fontawesome.min.css">
    <link rel="stylesheet" href="css/master-barang.css">
</head>
<body>
    <div id="app" class="container-fluid">
        <!-- Navigation Header -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">
                    <i class="fas fa-boxes"></i> Master Barang
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" onclick="showSection('data-table')">
                                <i class="fas fa-table"></i> Data Barang
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('import-export')">
                                <i class="fas fa-exchange-alt"></i> Import/Export
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('category-management')">
                                <i class="fas fa-tags"></i> Kategori & Satuan
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('audit-logs')">
                                <i class="fas fa-history"></i> Audit Log
                            </a>
                        </li>
                    </ul>
                    <ul class="navbar-nav">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user"></i> Admin
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="showHelp()">
                                    <i class="fas fa-question-circle"></i> Bantuan
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="index.html">
                                    <i class="fas fa-home"></i> Dashboard Utama
                                </a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <div id="main-content">
            <!-- Loading Overlay -->
            <div id="loading-overlay" class="loading-overlay" style="display: none;">
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="loading-text">Memproses...</div>
                </div>
            </div>
            <!-- Data Table Section -->
            <div id="data-table-section" class="content-section">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h2><i class="fas fa-table"></i> Data Barang</h2>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-success" onclick="showAddForm()">
                            <i class="fas fa-plus"></i> Tambah Barang
                        </button>
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-primary" onclick="showBulkOperations()">
                                <i class="fas fa-tasks"></i> Operasi Massal
                            </button>
                            <button class="btn btn-outline-info" onclick="refreshData()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                        <div class="btn-group ms-2" role="group">
                            <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="fas fa-download"></i> Template
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="downloadTemplate('excel')">
                                    <i class="fas fa-file-excel text-success"></i> Template Excel
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="downloadTemplate('csv')">
                                    <i class="fas fa-file-csv text-info"></i> Template CSV
                                </a></li>
                            </ul>
                        </div>
                        <button class="btn btn-outline-warning" onclick="openImportDialog()">
                            <i class="fas fa-upload"></i> Import Data
                        </button>
                        <button class="btn btn-outline-success" onclick="openExportDialog()">
                            <i class="fas fa-download"></i> Export Data
                        </button>
                    </div>
                </div>

                <!-- Search and Filter Controls -->
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Pencarian</label>
                                <div class="input-group">
                                    <input type="text" id="search-input" class="form-control" 
                                           placeholder="Cari kode, nama, atau kategori...">
                                    <button class="btn btn-outline-secondary" onclick="clearSearch()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Filter Kategori</label>
                                <select id="category-filter" class="form-select">
                                    <option value="">Semua Kategori</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Filter Satuan</label>
                                <select id="unit-filter" class="form-select">
                                    <option value="">Semua Satuan</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button class="btn btn-primary" onclick="applyFilters()">
                                        <i class="fas fa-filter"></i> Filter
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="barang-table" class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>
                                            <input type="checkbox" id="select-all" onchange="toggleSelectAll()">
                                        </th>
                                        <th onclick="sortTable('kode')" class="sortable">
                                            Kode <i class="fas fa-sort"></i>
                                        </th>
                                        <th onclick="sortTable('nama')" class="sortable">
                                            Nama Barang <i class="fas fa-sort"></i>
                                        </th>
                                        <th onclick="sortTable('kategori')" class="sortable">
                                            Kategori <i class="fas fa-sort"></i>
                                        </th>
                                        <th onclick="sortTable('satuan')" class="sortable">
                                            Satuan <i class="fas fa-sort"></i>
                                        </th>
                                        <th onclick="sortTable('harga')" class="sortable">
                                            Harga <i class="fas fa-sort"></i>
                                        </th>
                                        <th onclick="sortTable('stok')" class="sortable">
                                            Stok <i class="fas fa-sort"></i>
                                        </th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="barang-tbody">
                                    <!-- Data will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        <nav aria-label="Pagination">
                            <ul class="pagination justify-content-center" id="pagination">
                                <!-- Pagination will be populated by JavaScript -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
            <!-- Import/Export Section -->
            <div id="import-export-section" class="content-section" style="display: none;">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h2><i class="fas fa-exchange-alt"></i> Import/Export Data</h2>
                    </div>
                </div>

                <div class="row">
                    <!-- Import Section -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-upload"></i> Import Data</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Download Template</label>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-success" onclick="downloadTemplate('excel')">
                                            <i class="fas fa-file-excel"></i> Template Excel
                                        </button>
                                        <button class="btn btn-outline-info" onclick="downloadTemplate('csv')">
                                            <i class="fas fa-file-csv"></i> Template CSV
                                        </button>
                                    </div>
                                </div>
                                
                                <hr>
                                
                                <div class="mb-3">
                                    <label for="import-file" class="form-label">Upload File</label>
                                    <input type="file" id="import-file" class="form-control" 
                                           accept=".xlsx,.xls,.csv" onchange="handleFileUpload(event)">
                                    <div class="form-text">
                                        Format yang didukung: Excel (.xlsx, .xls) dan CSV (.csv)
                                    </div>
                                </div>
                                
                                <div id="import-preview" style="display: none;">
                                    <h6>Preview Data:</h6>
                                    <div class="table-responsive" style="max-height: 300px;">
                                        <table class="table table-sm table-bordered">
                                            <thead id="preview-header"></thead>
                                            <tbody id="preview-body"></tbody>
                                        </table>
                                    </div>
                                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                        <button class="btn btn-secondary" onclick="cancelImport()">Batal</button>
                                        <button class="btn btn-primary" onclick="processImport()">
                                            <i class="fas fa-check"></i> Proses Import
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Export Section -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-download"></i> Export Data</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Format Export</label>
                                    <select id="export-format" class="form-select">
                                        <option value="excel">Excel (.xlsx)</option>
                                        <option value="csv">CSV (.csv)</option>
                                        <option value="json">JSON (.json)</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Filter Export</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="export-all" checked>
                                        <label class="form-check-label" for="export-all">
                                            Export semua data
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="export-filtered">
                                        <label class="form-check-label" for="export-filtered">
                                            Export data yang difilter saja
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="d-grid">
                                    <button class="btn btn-success" onclick="exportData()">
                                        <i class="fas fa-download"></i> Export Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Import Progress -->
                <div id="import-progress" class="mt-3" style="display: none;">
                    <div class="card">
                        <div class="card-body">
                            <h6>Progress Import:</h6>
                            <div class="progress mb-2">
                                <div id="import-progress-bar" class="progress-bar" role="progressbar" 
                                     style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                            </div>
                            <div id="import-status" class="text-muted">Memulai import...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Category & Unit Management Section -->
            <div id="category-management-section" class="content-section" style="display: none;">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h2><i class="fas fa-tags"></i> Manajemen Kategori & Satuan</h2>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-tag"></i> Kategori Barang</h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted">Fitur manajemen kategori akan segera tersedia.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-balance-scale"></i> Satuan Barang</h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted">Fitur manajemen satuan akan segera tersedia.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Audit Logs Section -->
            <div id="audit-logs-section" class="content-section" style="display: none;">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h2><i class="fas fa-history"></i> Audit Log</h2>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <p class="text-muted">Fitur audit log akan segera tersedia.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/bootstrap.bundle.min.js"></script>
    <script>
        // Master Barang Import/Export Functions
        
        // Sample data untuk testing
        let masterBarangData = JSON.parse(localStorage.getItem('master_barang') || '[]');
        
        // Initialize sample data if empty
        if (masterBarangData.length === 0) {
            masterBarangData = [
                {
                    id: 'brg001',
                    kode: 'BRG001',
                    nama: 'Beras Premium 5kg',
                    kategori_id: 'kat001',
                    kategori_nama: 'Sembako',
                    satuan_id: 'sat001', 
                    satuan_nama: 'Karung',
                    harga_beli: 45000,
                    harga_jual: 50000,
                    stok: 100,
                    stok_minimum: 10,
                    deskripsi: 'Beras premium kualitas terbaik',
                    status: 'aktif',
                    created_at: new Date().toISOString()
                },
                {
                    id: 'brg002',
                    kode: 'BRG002',
                    nama: 'Minyak Goreng 1L',
                    kategori_id: 'kat001',
                    kategori_nama: 'Sembako',
                    satuan_id: 'sat002',
                    satuan_nama: 'Botol',
                    harga_beli: 12000,
                    harga_jual: 14000,
                    stok: 50,
                    stok_minimum: 5,
                    deskripsi: 'Minyak goreng berkualitas',
                    status: 'aktif',
                    created_at: new Date().toISOString()
                }
            ];
            localStorage.setItem('master_barang', JSON.stringify(masterBarangData));
        }

        // Download Template Function
        function downloadTemplate(format) {
            const templateData = {
                headers: [
                    'Kode Barang',
                    'Nama Barang', 
                    'Kategori',
                    'Satuan',
                    'Harga Beli',
                    'Harga Jual',
                    'Stok',
                    'Stok Minimum',
                    'Deskripsi'
                ],
                data: [
                    ['BRG001', 'Beras Premium 5kg', 'Sembako', 'Karung', '45000', '50000', '100', '10', 'Beras premium kualitas terbaik'],
                    ['BRG002', 'Minyak Goreng 1L', 'Sembako', 'Botol', '12000', '14000', '50', '5', 'Minyak goreng berkualitas'],
                    ['BRG003', 'Gula Pasir 1kg', 'Sembako', 'Kg', '13000', '15000', '75', '15', 'Gula pasir putih bersih'],
                    ['BRG004', 'Teh Celup 25pcs', 'Minuman', 'Dus', '8000', '10000', '30', '5', 'Teh celup kemasan dus'],
                    ['BRG005', 'Kopi Sachet 10pcs', 'Minuman', 'Dus', '15000', '18000', '25', '5', 'Kopi instan kemasan sachet']
                ]
            };

            const fileName = `template_master_barang_${new Date().toISOString().slice(0, 10)}.${format === 'excel' ? 'xlsx' : format}`;
            
            if (format === 'csv') {
                downloadCSV(templateData, fileName);
            } else if (format === 'excel') {
                downloadExcel(templateData, fileName);
            }
        }

        // Download CSV
        function downloadCSV(data, fileName) {
            const csvContent = [
                data.headers.join(','),
                ...data.data.map(row => 
                    row.map(cell => {
                        const cellStr = String(cell);
                        if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                            return '"' + cellStr.replace(/"/g, '""') + '"';
                        }
                        return cellStr;
                    }).join(',')
                )
            ].join('\n');

            const bom = '\uFEFF';
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            downloadBlob(blob, fileName);
        }

        // Download Excel (HTML format)
        function downloadExcel(data, fileName) {
            let html = '<table>';
            
            // Headers
            html += '<tr>';
            data.headers.forEach(header => {
                html += `<th>${escapeHtml(header)}</th>`;
            });
            html += '</tr>';
            
            // Data
            data.data.forEach(row => {
                html += '<tr>';
                row.forEach(cell => {
                    html += `<td>${escapeHtml(cell)}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</table>';

            const blob = new Blob([html], { 
                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
            });
            downloadBlob(blob, fileName);
        }

        // Open Import Dialog
        function openImportDialog() {
            const modal = `
                <div class="modal fade" id="importModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Import Data Barang</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle"></i> Panduan Import:</h6>
                                    <ol>
                                        <li>Download template terlebih dahulu</li>
                                        <li>Isi data sesuai format template</li>
                                        <li>Upload file yang sudah diisi</li>
                                        <li>Preview dan konfirmasi data</li>
                                    </ol>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Download Template:</label>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-success" onclick="downloadTemplate('excel')">
                                            <i class="fas fa-file-excel"></i> Template Excel
                                        </button>
                                        <button class="btn btn-outline-info" onclick="downloadTemplate('csv')">
                                            <i class="fas fa-file-csv"></i> Template CSV
                                        </button>
                                    </div>
                                </div>
                                
                                <hr>
                                
                                <div class="mb-3">
                                    <label for="importFile" class="form-label">Upload File:</label>
                                    <input type="file" id="importFile" class="form-control" 
                                           accept=".xlsx,.xls,.csv" onchange="handleImportFile(event)">
                                    <div class="form-text">
                                        Format yang didukung: Excel (.xlsx, .xls) dan CSV (.csv)
                                    </div>
                                </div>
                                
                                <div id="importPreview" style="display: none;">
                                    <h6>Preview Data:</h6>
                                    <div class="alert alert-success">
                                        File berhasil dipilih. Klik "Proses Import" untuk melanjutkan.
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                                <button type="button" class="btn btn-primary" onclick="processImportModal()" id="processImportBtn" disabled>
                                    <i class="fas fa-upload"></i> Proses Import
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal
            const existingModal = document.getElementById('importModal');
            if (existingModal) existingModal.remove();
            
            // Add modal
            document.body.insertAdjacentHTML('beforeend', modal);
            
            // Show modal
            const modalInstance = new bootstrap.Modal(document.getElementById('importModal'));
            modalInstance.show();
        }

        // Handle import file selection
        function handleImportFile(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('importPreview').style.display = 'block';
                document.getElementById('processImportBtn').disabled = false;
            }
        }

        // Process import from modal
        function processImportModal() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Pilih file yang akan diimport');
                return;
            }
            
            // Show loading
            showLoading('Memproses import data...');
            
            // Process file
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let data;
                    const fileName = file.name.toLowerCase();
                    
                    if (fileName.endsWith('.csv')) {
                        data = parseCSV(e.target.result);
                    } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                        // For Excel files, we'll simulate parsing for now
                        // In real implementation, you'd use a library like SheetJS
                        alert('Untuk implementasi lengkap Excel, gunakan library seperti SheetJS. Saat ini gunakan format CSV.');
                        hideLoading();
                        return;
                    } else {
                        throw new Error('Format file tidak didukung');
                    }
                    
                    // Validate and import data
                    importBarangData(data);
                    
                } catch (error) {
                    hideLoading();
                    alert('Error memproses file: ' + error.message);
                }
            };
            
            reader.readAsText(file);
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('importModal'));
            modal.hide();
        }

        // Parse CSV data
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = parseCSVLine(lines[i]);
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    data.push(row);
                }
            }
            
            return data;
        }

        // Parse CSV line handling quotes and commas
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        // Import barang data
        function importBarangData(data) {
            let successCount = 0;
            let errorCount = 0;
            const errors = [];
            
            data.forEach((row, index) => {
                try {
                    // Map CSV columns to our data structure
                    const barang = {
                        id: 'brg' + Date.now() + '_' + index,
                        kode: row['Kode Barang'] || row['Kode'] || '',
                        nama: row['Nama Barang'] || row['Nama'] || '',
                        kategori_id: 'kat' + Date.now(),
                        kategori_nama: row['Kategori'] || 'Umum',
                        satuan_id: 'sat' + Date.now(),
                        satuan_nama: row['Satuan'] || 'PCS',
                        harga_beli: parseInt(row['Harga Beli']) || 0,
                        harga_jual: parseInt(row['Harga Jual']) || 0,
                        stok: parseInt(row['Stok']) || 0,
                        stok_minimum: parseInt(row['Stok Minimum']) || 0,
                        deskripsi: row['Deskripsi'] || '',
                        status: 'aktif',
                        created_at: new Date().toISOString()
                    };
                    
                    // Validate required fields
                    if (!barang.kode || !barang.nama) {
                        throw new Error(`Baris ${index + 2}: Kode dan Nama barang wajib diisi`);
                    }
                    
                    // Check if kode already exists
                    const existingItem = masterBarangData.find(item => item.kode === barang.kode);
                    if (existingItem) {
                        throw new Error(`Baris ${index + 2}: Kode barang '${barang.kode}' sudah ada`);
                    }
                    
                    // Add to data
                    masterBarangData.push(barang);
                    successCount++;
                    
                } catch (error) {
                    errorCount++;
                    errors.push(error.message);
                }
            });
            
            // Save to localStorage
            localStorage.setItem('master_barang', JSON.stringify(masterBarangData));
            
            // Show results
            hideLoading();
            
            let message = `Import selesai!\n\nBerhasil: ${successCount} data\nGagal: ${errorCount} data`;
            
            if (errors.length > 0) {
                message += '\n\nError:\n' + errors.slice(0, 5).join('\n');
                if (errors.length > 5) {
                    message += `\n... dan ${errors.length - 5} error lainnya`;
                }
            }
            
            alert(message);
            
            // Refresh table
            loadTableData();
        }

        // Show loading overlay
        function showLoading(message = 'Memproses...') {
            const overlay = document.getElementById('loading-overlay');
            const text = overlay.querySelector('.loading-text');
            if (text) text.textContent = message;
            overlay.style.display = 'flex';
        }

        // Hide loading overlay
        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'none';
        }

        // Show success message
            setTimeout(() => {
                alert('Import berhasil! Data telah ditambahkan ke sistem.\n\nCatatan: Ini adalah simulasi. Untuk implementasi lengkap, diperlukan parser file Excel/CSV.');
                loadTableData();
            }, 500);
        }

        // Open Export Dialog
        function openExportDialog() {
            const modal = `
                <div class="modal fade" id="exportModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Export Data Barang</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label">Format Export:</label>
                                    <select id="exportFormat" class="form-select">
                                        <option value="excel">Excel (.xlsx)</option>
                                        <option value="csv">CSV (.csv)</option>
                                        <option value="json">JSON (.json)</option>
                                    </select>
                                </div>
                                
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i>
                                    Data yang akan diekspor: <strong>${masterBarangData.length}</strong> barang
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                                <button type="button" class="btn btn-success" onclick="processExportModal()">
                                    <i class="fas fa-download"></i> Export
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal
            const existingModal = document.getElementById('exportModal');
            if (existingModal) existingModal.remove();
            
            // Add modal
            document.body.insertAdjacentHTML('beforeend', modal);
            
            // Show modal
            const modalInstance = new bootstrap.Modal(document.getElementById('exportModal'));
            modalInstance.show();
        }

        // Process export from modal
        function processExportModal() {
            const format = document.getElementById('exportFormat').value;
            const data = masterBarangData;
            
            if (data.length === 0) {
                alert('Tidak ada data untuk diekspor');
                return;
            }
            
            const fileName = `export_master_barang_${new Date().toISOString().slice(0, 19).replace(/[:-]/g, '')}.${format}`;
            
            if (format === 'csv') {
                exportToCSV(data, fileName);
            } else if (format === 'excel') {
                exportToExcel(data, fileName);
            } else if (format === 'json') {
                exportToJSON(data, fileName);
            }
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('exportModal'));
            modal.hide();
            
            alert(`Data berhasil diekspor ke file: ${fileName}`);
        }

        // Export functions
        function exportToCSV(data, fileName) {
            const headers = ['Kode', 'Nama', 'Kategori', 'Satuan', 'Harga Beli', 'Harga Jual', 'Stok', 'Stok Minimum', 'Deskripsi'];
            const csvContent = [
                headers.join(','),
                ...data.map(item => [
                    item.kode || '',
                    item.nama || '',
                    item.kategori_nama || '',
                    item.satuan_nama || '',
                    item.harga_beli || 0,
                    item.harga_jual || 0,
                    item.stok || 0,
                    item.stok_minimum || 0,
                    item.deskripsi || ''
                ].map(cell => {
                    const cellStr = String(cell);
                    if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                        return '"' + cellStr.replace(/"/g, '""') + '"';
                    }
                    return cellStr;
                }).join(','))
            ].join('\n');

            const bom = '\uFEFF';
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            downloadBlob(blob, fileName);
        }

        function exportToExcel(data, fileName) {
            let html = '<table>';
            
            // Headers
            const headers = ['Kode', 'Nama', 'Kategori', 'Satuan', 'Harga Beli', 'Harga Jual', 'Stok', 'Stok Minimum', 'Deskripsi'];
            html += '<tr>';
            headers.forEach(header => {
                html += `<th>${escapeHtml(header)}</th>`;
            });
            html += '</tr>';
            
            // Data
            data.forEach(item => {
                html += '<tr>';
                [
                    item.kode || '',
                    item.nama || '',
                    item.kategori_nama || '',
                    item.satuan_nama || '',
                    item.harga_beli || 0,
                    item.harga_jual || 0,
                    item.stok || 0,
                    item.stok_minimum || 0,
                    item.deskripsi || ''
                ].forEach(cell => {
                    html += `<td>${escapeHtml(cell)}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</table>';

            const blob = new Blob([html], { 
                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
            });
            downloadBlob(blob, fileName);
        }

        function exportToJSON(data, fileName) {
            const jsonContent = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json' });
            downloadBlob(blob, fileName);
        }

        // Utility functions
        function downloadBlob(blob, fileName) {
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            setTimeout(() => window.URL.revokeObjectURL(url), 100);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Navigation functions
        function showSection(sectionName) {
            // Hide all sections
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.style.display = 'none';
            });
            
            // Show target section
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.style.display = 'block';
            }
            
            // Update navigation
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.classList.remove('active');
            });
            
            const activeLink = document.querySelector(`[onclick="showSection('${sectionName}')"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
        }

        // File upload handler for import/export section
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const previewSection = document.getElementById('import-preview');
                if (previewSection) {
                    previewSection.style.display = 'block';
                    
                    const previewHeader = document.getElementById('preview-header');
                    const previewBody = document.getElementById('preview-body');
                    
                    if (previewHeader && previewBody) {
                        previewHeader.innerHTML = '<tr><th colspan="100%">File: ' + file.name + ' (Size: ' + formatFileSize(file.size) + ')</th></tr>';
                        previewBody.innerHTML = '<tr><td colspan="100%" class="text-center text-muted">Preview akan tersedia setelah implementasi parser file</td></tr>';
                    }
                }
            }
        }

        function cancelImport() {
            const importPreview = document.getElementById('import-preview');
            if (importPreview) {
                importPreview.style.display = 'none';
            }
            const fileInput = document.getElementById('import-file');
            if (fileInput) {
                fileInput.value = '';
            }
        }

        function processImport() {
            alert('Fitur import sedang dalam pengembangan. Gunakan dialog import yang lebih lengkap.');
        }

        function exportData() {
            openExportDialog();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Load table data
        function loadTableData(dataToShow = null) {
            const tbody = document.getElementById('barang-tbody');
            if (tbody) {
                tbody.innerHTML = '';
                
                const data = dataToShow || masterBarangData;
                
                if (data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center text-muted">
                                ${dataToShow ? 'Tidak ada data yang sesuai dengan filter' : 'Belum ada data barang'}
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                data.forEach((item, index) => {
                    const stockClass = item.stok <= item.stok_minimum ? 'text-danger' : '';
                    const row = `
                        <tr>
                            <td><input type="checkbox" value="${item.id}"></td>
                            <td>${item.kode}</td>
                            <td>${item.nama}</td>
                            <td><span class="badge bg-secondary">${item.kategori_nama}</span></td>
                            <td><span class="badge bg-info">${item.satuan_nama}</span></td>
                            <td>Rp ${item.harga_jual.toLocaleString()}</td>
                            <td class="${stockClass}">
                                ${item.stok}
                                ${item.stok <= item.stok_minimum ? '<i class="fas fa-exclamation-triangle text-warning" title="Stok rendah"></i>' : ''}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="editItem('${item.id}')" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('${item.id}')" title="Hapus">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }
            
            // Update filter dropdowns
            updateFilterDropdowns();
        }

        // Update filter dropdowns
        function updateFilterDropdowns() {
            const categoryFilter = document.getElementById('category-filter');
            const unitFilter = document.getElementById('unit-filter');
            
            if (categoryFilter) {
                const categories = [...new Set(masterBarangData.map(item => item.kategori_nama))];
                const currentValue = categoryFilter.value;
                
                categoryFilter.innerHTML = '<option value="">Semua Kategori</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    if (category === currentValue) option.selected = true;
                    categoryFilter.appendChild(option);
                });
            }
            
            if (unitFilter) {
                const units = [...new Set(masterBarangData.map(item => item.satuan_nama))];
                const currentValue = unitFilter.value;
                
                unitFilter.innerHTML = '<option value="">Semua Satuan</option>';
                units.forEach(unit => {
                    const option = document.createElement('option');
                    option.value = unit;
                    option.textContent = unit;
                    if (unit === currentValue) option.selected = true;
                    unitFilter.appendChild(option);
                });
            }
        }

        // Show add form
        function showAddForm() {
            const modal = `
                <div class="modal fade" id="addBarangModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Tambah Barang Baru</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="addBarangForm">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Kode Barang *</label>
                                                <input type="text" id="kode" class="form-control" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Nama Barang *</label>
                                                <input type="text" id="nama" class="form-control" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Kategori</label>
                                                <select id="kategori" class="form-select">
                                                    <option value="Sembako">Sembako</option>
                                                    <option value="Minuman">Minuman</option>
                                                    <option value="Makanan">Makanan</option>
                                                    <option value="Peralatan">Peralatan</option>
                                                    <option value="Lainnya">Lainnya</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Satuan</label>
                                                <select id="satuan" class="form-select">
                                                    <option value="PCS">PCS</option>
                                                    <option value="Kg">Kg</option>
                                                    <option value="Liter">Liter</option>
                                                    <option value="Karung">Karung</option>
                                                    <option value="Botol">Botol</option>
                                                    <option value="Dus">Dus</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Harga Beli</label>
                                                <input type="number" id="harga_beli" class="form-control" min="0">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Harga Jual</label>
                                                <input type="number" id="harga_jual" class="form-control" min="0">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Stok</label>
                                                <input type="number" id="stok" class="form-control" min="0" value="0">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Stok Minimum</label>
                                                <input type="number" id="stok_minimum" class="form-control" min="0" value="0">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Deskripsi</label>
                                        <textarea id="deskripsi" class="form-control" rows="3"></textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                                <button type="button" class="btn btn-primary" onclick="saveBarang()">
                                    <i class="fas fa-save"></i> Simpan
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal
            const existingModal = document.getElementById('addBarangModal');
            if (existingModal) existingModal.remove();
            
            // Add modal
            document.body.insertAdjacentHTML('beforeend', modal);
            
            // Show modal
            const modalInstance = new bootstrap.Modal(document.getElementById('addBarangModal'));
            modalInstance.show();
        }

        // Save barang
        function saveBarang() {
            const form = document.getElementById('addBarangForm');
            const formData = new FormData(form);
            
            // Get form values
            const kode = document.getElementById('kode').value.trim();
            const nama = document.getElementById('nama').value.trim();
            const kategori = document.getElementById('kategori').value;
            const satuan = document.getElementById('satuan').value;
            const harga_beli = parseInt(document.getElementById('harga_beli').value) || 0;
            const harga_jual = parseInt(document.getElementById('harga_jual').value) || 0;
            const stok = parseInt(document.getElementById('stok').value) || 0;
            const stok_minimum = parseInt(document.getElementById('stok_minimum').value) || 0;
            const deskripsi = document.getElementById('deskripsi').value.trim();
            
            // Validate
            if (!kode || !nama) {
                alert('Kode dan Nama barang wajib diisi');
                return;
            }
            
            // Check if kode already exists
            const existingItem = masterBarangData.find(item => item.kode === kode);
            if (existingItem) {
                alert('Kode barang sudah ada, gunakan kode yang berbeda');
                return;
            }
            
            // Create new barang
            const newBarang = {
                id: 'brg' + Date.now(),
                kode: kode,
                nama: nama,
                kategori_id: 'kat' + Date.now(),
                kategori_nama: kategori,
                satuan_id: 'sat' + Date.now(),
                satuan_nama: satuan,
                harga_beli: harga_beli,
                harga_jual: harga_jual,
                stok: stok,
                stok_minimum: stok_minimum,
                deskripsi: deskripsi,
                status: 'aktif',
                created_at: new Date().toISOString()
            };
            
            // Add to data
            masterBarangData.push(newBarang);
            
            // Save to localStorage
            localStorage.setItem('master_barang', JSON.stringify(masterBarangData));
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addBarangModal'));
            modal.hide();
            
            // Refresh table
            loadTableData();
            
            alert('Barang berhasil ditambahkan!');
        }

        function showBulkOperations() {
            const selectedItems = getSelectedItems();
            if (selectedItems.length === 0) {
                alert('Pilih minimal satu barang untuk operasi massal');
                return;
            }
            
            const modal = `
                <div class="modal fade" id="bulkOperationsModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Operasi Massal</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p><strong>${selectedItems.length}</strong> barang dipilih</p>
                                
                                <div class="mb-3">
                                    <label class="form-label">Pilih Operasi:</label>
                                    <select id="bulkOperation" class="form-select">
                                        <option value="">-- Pilih Operasi --</option>
                                        <option value="delete">Hapus Semua</option>
                                        <option value="updateCategory">Update Kategori</option>
                                        <option value="updateUnit">Update Satuan</option>
                                    </select>
                                </div>
                                
                                <div id="bulkOperationOptions" style="display: none;">
                                    <!-- Options will be populated based on selected operation -->
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                                <button type="button" class="btn btn-primary" onclick="executeBulkOperation()" id="executeBulkBtn" disabled>
                                    <i class="fas fa-check"></i> Jalankan
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal
            const existingModal = document.getElementById('bulkOperationsModal');
            if (existingModal) existingModal.remove();
            
            // Add modal
            document.body.insertAdjacentHTML('beforeend', modal);
            
            // Add event listener for operation selection
            document.getElementById('bulkOperation').addEventListener('change', function() {
                const operation = this.value;
                const optionsDiv = document.getElementById('bulkOperationOptions');
                const executeBtn = document.getElementById('executeBulkBtn');
                
                if (operation) {
                    executeBtn.disabled = false;
                    optionsDiv.style.display = 'block';
                    
                    if (operation === 'updateCategory') {
                        optionsDiv.innerHTML = `
                            <label class="form-label">Kategori Baru:</label>
                            <select id="newCategory" class="form-select">
                                <option value="Sembako">Sembako</option>
                                <option value="Minuman">Minuman</option>
                                <option value="Makanan">Makanan</option>
                                <option value="Peralatan">Peralatan</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                        `;
                    } else if (operation === 'updateUnit') {
                        optionsDiv.innerHTML = `
                            <label class="form-label">Satuan Baru:</label>
                            <select id="newUnit" class="form-select">
                                <option value="PCS">PCS</option>
                                <option value="Kg">Kg</option>
                                <option value="Liter">Liter</option>
                                <option value="Karung">Karung</option>
                                <option value="Botol">Botol</option>
                                <option value="Dus">Dus</option>
                            </select>
                        `;
                    } else {
                        optionsDiv.innerHTML = '';
                    }
                } else {
                    executeBtn.disabled = true;
                    optionsDiv.style.display = 'none';
                }
            });
            
            // Show modal
            const modalInstance = new bootstrap.Modal(document.getElementById('bulkOperationsModal'));
            modalInstance.show();
        }

        // Get selected items
        function getSelectedItems() {
            const checkboxes = document.querySelectorAll('#barang-tbody input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // Execute bulk operation
        function executeBulkOperation() {
            const operation = document.getElementById('bulkOperation').value;
            const selectedIds = getSelectedItems();
            
            if (!operation || selectedIds.length === 0) {
                alert('Pilih operasi dan barang yang akan diproses');
                return;
            }
            
            let confirmMessage = '';
            
            switch (operation) {
                case 'delete':
                    confirmMessage = `Apakah Anda yakin ingin menghapus ${selectedIds.length} barang?`;
                    break;
                case 'updateCategory':
                    const newCategory = document.getElementById('newCategory').value;
                    confirmMessage = `Apakah Anda yakin ingin mengubah kategori ${selectedIds.length} barang menjadi "${newCategory}"?`;
                    break;
                case 'updateUnit':
                    const newUnit = document.getElementById('newUnit').value;
                    confirmMessage = `Apakah Anda yakin ingin mengubah satuan ${selectedIds.length} barang menjadi "${newUnit}"?`;
                    break;
            }
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Execute operation
            let successCount = 0;
            
            selectedIds.forEach(id => {
                const itemIndex = masterBarangData.findIndex(item => item.id === id);
                if (itemIndex !== -1) {
                    switch (operation) {
                        case 'delete':
                            masterBarangData.splice(itemIndex, 1);
                            successCount++;
                            break;
                        case 'updateCategory':
                            masterBarangData[itemIndex].kategori_nama = document.getElementById('newCategory').value;
                            masterBarangData[itemIndex].updated_at = new Date().toISOString();
                            successCount++;
                            break;
                        case 'updateUnit':
                            masterBarangData[itemIndex].satuan_nama = document.getElementById('newUnit').value;
                            masterBarangData[itemIndex].updated_at = new Date().toISOString();
                            successCount++;
                            break;
                    }
                }
            });
            
            // Save to localStorage
            localStorage.setItem('master_barang', JSON.stringify(masterBarangData));
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('bulkOperationsModal'));
            modal.hide();
            
            // Refresh table
            loadTableData();
            
            alert(`Operasi berhasil dijalankan untuk ${successCount} barang`);
        }

        function refreshData() {
            loadTableData();
            alert('Data berhasil direfresh');
        }

        function clearSearch() {
            document.getElementById('search-input').value = '';
        }

        function applyFilters() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const categoryFilter = document.getElementById('category-filter').value;
            const unitFilter = document.getElementById('unit-filter').value;
            
            let filteredData = masterBarangData;
            
            // Apply search filter
            if (searchTerm) {
                filteredData = filteredData.filter(item => 
                    item.kode.toLowerCase().includes(searchTerm) ||
                    item.nama.toLowerCase().includes(searchTerm) ||
                    item.kategori_nama.toLowerCase().includes(searchTerm)
                );
            }
            
            // Apply category filter
            if (categoryFilter) {
                filteredData = filteredData.filter(item => item.kategori_nama === categoryFilter);
            }
            
            // Apply unit filter
            if (unitFilter) {
                filteredData = filteredData.filter(item => item.satuan_nama === unitFilter);
            }
            
            // Update table with filtered data
            loadTableData(filteredData);
        }

        // Real-time search
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    applyFilters();
                });
            }
            
            const categoryFilter = document.getElementById('category-filter');
            if (categoryFilter) {
                categoryFilter.addEventListener('change', function() {
                    applyFilters();
                });
            }
            
            const unitFilter = document.getElementById('unit-filter');
            if (unitFilter) {
                unitFilter.addEventListener('change', function() {
                    applyFilters();
                });
            }
        });

        function editItem(id) {
            const item = masterBarangData.find(barang => barang.id === id);
            if (!item) {
                alert('Data barang tidak ditemukan');
                return;
            }
            
            const modal = `
                <div class="modal fade" id="editBarangModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Edit Barang</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="editBarangForm">
                                    <input type="hidden" id="edit_id" value="${item.id}">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Kode Barang *</label>
                                                <input type="text" id="edit_kode" class="form-control" value="${item.kode}" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Nama Barang *</label>
                                                <input type="text" id="edit_nama" class="form-control" value="${item.nama}" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Kategori</label>
                                                <select id="edit_kategori" class="form-select">
                                                    <option value="Sembako" ${item.kategori_nama === 'Sembako' ? 'selected' : ''}>Sembako</option>
                                                    <option value="Minuman" ${item.kategori_nama === 'Minuman' ? 'selected' : ''}>Minuman</option>
                                                    <option value="Makanan" ${item.kategori_nama === 'Makanan' ? 'selected' : ''}>Makanan</option>
                                                    <option value="Peralatan" ${item.kategori_nama === 'Peralatan' ? 'selected' : ''}>Peralatan</option>
                                                    <option value="Lainnya" ${item.kategori_nama === 'Lainnya' ? 'selected' : ''}>Lainnya</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Satuan</label>
                                                <select id="edit_satuan" class="form-select">
                                                    <option value="PCS" ${item.satuan_nama === 'PCS' ? 'selected' : ''}>PCS</option>
                                                    <option value="Kg" ${item.satuan_nama === 'Kg' ? 'selected' : ''}>Kg</option>
                                                    <option value="Liter" ${item.satuan_nama === 'Liter' ? 'selected' : ''}>Liter</option>
                                                    <option value="Karung" ${item.satuan_nama === 'Karung' ? 'selected' : ''}>Karung</option>
                                                    <option value="Botol" ${item.satuan_nama === 'Botol' ? 'selected' : ''}>Botol</option>
                                                    <option value="Dus" ${item.satuan_nama === 'Dus' ? 'selected' : ''}>Dus</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Harga Beli</label>
                                                <input type="number" id="edit_harga_beli" class="form-control" value="${item.harga_beli}" min="0">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Harga Jual</label>
                                                <input type="number" id="edit_harga_jual" class="form-control" value="${item.harga_jual}" min="0">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Stok</label>
                                                <input type="number" id="edit_stok" class="form-control" value="${item.stok}" min="0">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Stok Minimum</label>
                                                <input type="number" id="edit_stok_minimum" class="form-control" value="${item.stok_minimum}" min="0">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Deskripsi</label>
                                        <textarea id="edit_deskripsi" class="form-control" rows="3">${item.deskripsi}</textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                                <button type="button" class="btn btn-primary" onclick="updateBarang()">
                                    <i class="fas fa-save"></i> Update
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal
            const existingModal = document.getElementById('editBarangModal');
            if (existingModal) existingModal.remove();
            
            // Add modal
            document.body.insertAdjacentHTML('beforeend', modal);
            
            // Show modal
            const modalInstance = new bootstrap.Modal(document.getElementById('editBarangModal'));
            modalInstance.show();
        }

        // Update barang
        function updateBarang() {
            const id = document.getElementById('edit_id').value;
            const kode = document.getElementById('edit_kode').value.trim();
            const nama = document.getElementById('edit_nama').value.trim();
            const kategori = document.getElementById('edit_kategori').value;
            const satuan = document.getElementById('edit_satuan').value;
            const harga_beli = parseInt(document.getElementById('edit_harga_beli').value) || 0;
            const harga_jual = parseInt(document.getElementById('edit_harga_jual').value) || 0;
            const stok = parseInt(document.getElementById('edit_stok').value) || 0;
            const stok_minimum = parseInt(document.getElementById('edit_stok_minimum').value) || 0;
            const deskripsi = document.getElementById('edit_deskripsi').value.trim();
            
            // Validate
            if (!kode || !nama) {
                alert('Kode dan Nama barang wajib diisi');
                return;
            }
            
            // Check if kode already exists (excluding current item)
            const existingItem = masterBarangData.find(item => item.kode === kode && item.id !== id);
            if (existingItem) {
                alert('Kode barang sudah ada, gunakan kode yang berbeda');
                return;
            }
            
            // Find and update item
            const itemIndex = masterBarangData.findIndex(item => item.id === id);
            if (itemIndex !== -1) {
                masterBarangData[itemIndex] = {
                    ...masterBarangData[itemIndex],
                    kode: kode,
                    nama: nama,
                    kategori_nama: kategori,
                    satuan_nama: satuan,
                    harga_beli: harga_beli,
                    harga_jual: harga_jual,
                    stok: stok,
                    stok_minimum: stok_minimum,
                    deskripsi: deskripsi,
                    updated_at: new Date().toISOString()
                };
                
                // Save to localStorage
                localStorage.setItem('master_barang', JSON.stringify(masterBarangData));
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editBarangModal'));
                modal.hide();
                
                // Refresh table
                loadTableData();
                
                alert('Barang berhasil diupdate!');
            }
        }

        function deleteItem(id) {
            if (confirm('Apakah Anda yakin ingin menghapus item ini?')) {
                masterBarangData = masterBarangData.filter(item => item.id !== id);
                localStorage.setItem('master_barang', JSON.stringify(masterBarangData));
                loadTableData();
                alert('Item berhasil dihapus');
            }
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('select-all');
            const checkboxes = document.querySelectorAll('#barang-tbody input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        }

        function sortTable(column) {
            alert('Fitur sorting akan segera tersedia');
        }

        function showHelp() {
            const helpModal = `
                <div class="modal fade" id="helpModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Bantuan Master Barang</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <h6>Fitur Import Data:</h6>
                                <ul>
                                    <li>Download template Excel atau CSV</li>
                                    <li>Isi data sesuai format template</li>
                                    <li>Upload file melalui tombol Import Data</li>
                                    <li>Preview dan konfirmasi data sebelum import</li>
                                </ul>
                                
                                <h6>Fitur Export Data:</h6>
                                <ul>
                                    <li>Pilih format export (Excel, CSV, JSON)</li>
                                    <li>Data akan diekspor sesuai format yang dipilih</li>
                                    <li>File akan otomatis terdownload</li>
                                </ul>
                                
                                <h6>Template Download:</h6>
                                <ul>
                                    <li>Template Excel: Format .xlsx dengan contoh data</li>
                                    <li>Template CSV: Format .csv yang kompatibel</li>
                                </ul>
                                
                                <h6>Format Data Template:</h6>
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Kolom</th>
                                            <th>Wajib</th>
                                            <th>Keterangan</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td>Kode Barang</td><td>Ya</td><td>Kode unik barang</td></tr>
                                        <tr><td>Nama Barang</td><td>Ya</td><td>Nama lengkap barang</td></tr>
                                        <tr><td>Kategori</td><td>Ya</td><td>Kategori barang</td></tr>
                                        <tr><td>Satuan</td><td>Ya</td><td>Satuan barang (PCS, KG, dll)</td></tr>
                                        <tr><td>Harga Beli</td><td>Tidak</td><td>Harga beli (angka)</td></tr>
                                        <tr><td>Harga Jual</td><td>Tidak</td><td>Harga jual (angka)</td></tr>
                                        <tr><td>Stok</td><td>Tidak</td><td>Jumlah stok (angka)</td></tr>
                                        <tr><td>Stok Minimum</td><td>Tidak</td><td>Batas minimum stok</td></tr>
                                        <tr><td>Deskripsi</td><td>Tidak</td><td>Deskripsi tambahan</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal
            const existingModal = document.getElementById('helpModal');
            if (existingModal) existingModal.remove();
            
            // Add modal
            document.body.insertAdjacentHTML('beforeend', helpModal);
            
            // Show modal
            const modalInstance = new bootstrap.Modal(document.getElementById('helpModal'));
            modalInstance.show();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            showSection('data-table');
            loadTableData();
            console.log('Master Barang system initialized with import/export features');
        });
    </script>
</body>
</html>