<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Enhanced Cash Calculation - Task 4</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .test-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
        }
        .test-result {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.375rem;
        }
        .test-success { background-color: #d1e7dd; border: 1px solid #badbcc; }
        .test-error { background-color: #f8d7da; border: 1px solid #f5c2c7; }
        .test-warning { background-color: #fff3cd; border: 1px solid #ffecb5; }
        .calculation-display {
            font-family: 'Courier New', monospace;
            background-color: #f8f9fa;
            padding: 0.5rem;
            border-radius: 0.25rem;
            margin: 0.5rem 0;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="bi bi-calculator me-2"></i>
                    Test Enhanced Cash Calculation - Task 4
                </h1>
                <p class="lead">Comprehensive testing for enhanced cash calculation and selisih handling</p>
            </div>
        </div>

        <!-- Test 1: Kas Seharusnya Calculation -->
        <div class="test-section">
            <h3><i class="bi bi-1-circle me-2"></i>Test Kas Seharusnya Calculation</h3>
            <p>Testing enhanced kas seharusnya formula with validation and edge cases</p>
            
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Modal Awal (Rp)</label>
                    <input type="number" class="form-control" id="modalAwal1" value="500000" min="0">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Total Cash (Rp)</label>
                    <input type="number" class="form-control" id="totalCash1" value="1250000" min="0">
                </div>
            </div>
            
            <button class="btn btn-primary mt-3" onclick="testKasSeharusnya()">
                <i class="bi bi-play-fill me-1"></i>Test Calculation
            </button>
            
            <div id="result1" class="test-result" style="display: none;"></div>
        </div>

        <!-- Test 2: Selisih Calculation -->
        <div class="test-section">
            <h3><i class="bi bi-2-circle me-2"></i>Test Selisih Calculation</h3>
            <p>Testing real-time selisih calculation with severity categorization</p>
            
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">Kas Aktual (Rp)</label>
                    <input type="number" class="form-control" id="kasAktual2" value="1750000" min="0">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Kas Seharusnya (Rp)</label>
                    <input type="number" class="form-control" id="kasSeharusnya2" value="1750000" min="0">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Real-time Update</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="realTime2" checked>
                        <label class="form-check-label" for="realTime2">Auto-calculate on input</label>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary mt-3" onclick="testSelisih()">
                <i class="bi bi-play-fill me-1"></i>Test Selisih
            </button>
            
            <div id="result2" class="test-result" style="display: none;"></div>
        </div>

        <!-- Test 3: Input Validation -->
        <div class="test-section">
            <h3><i class="bi bi-3-circle me-2"></i>Test Input Validation</h3>
            <p>Testing kas aktual input validation with edge cases</p>
            
            <div class="row">
                <div class="col-md-8">
                    <label class="form-label">Test Input (try negative, text, empty, large numbers)</label>
                    <input type="text" class="form-control" id="testInput3" placeholder="Enter test value...">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Quick Tests</label>
                    <div class="btn-group-vertical w-100">
                        <button class="btn btn-outline-secondary btn-sm" onclick="setTestValue('')">Empty</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="setTestValue('-100')">Negative</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="setTestValue('abc')">Text</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="setTestValue('999999999999')">Large Number</button>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary mt-3" onclick="testValidation()">
                <i class="bi bi-shield-check me-1"></i>Test Validation
            </button>
            
            <div id="result3" class="test-result" style="display: none;"></div>
        </div>

        <!-- Test 4: Precision Arithmetic -->
        <div class="test-section">
            <h3><i class="bi bi-4-circle me-2"></i>Test Precision Arithmetic</h3>
            <p>Testing floating point precision handling for currency calculations</p>
            
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">Number A</label>
                    <input type="number" class="form-control" id="numberA4" value="0.1" step="0.01">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Number B</label>
                    <input type="number" class="form-control" id="numberB4" value="0.2" step="0.01">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Operation</label>
                    <select class="form-select" id="operation4">
                        <option value="add">Addition (+)</option>
                        <option value="subtract">Subtraction (-)</option>
                        <option value="multiply">Multiplication (×)</option>
                    </select>
                </div>
            </div>
            
            <button class="btn btn-primary mt-3" onclick="testPrecision()">
                <i class="bi bi-calculator me-1"></i>Test Precision
            </button>
            
            <div id="result4" class="test-result" style="display: none;"></div>
        </div>

        <!-- Test 5: Edge Cases -->
        <div class="test-section">
            <h3><i class="bi bi-5-circle me-2"></i>Test Edge Cases</h3>
            <p>Testing various edge cases and error conditions</p>
            
            <div class="row">
                <div class="col-12">
                    <div class="btn-group flex-wrap">
                        <button class="btn btn-outline-warning" onclick="testEdgeCase('zero')">Zero Values</button>
                        <button class="btn btn-outline-warning" onclick="testEdgeCase('large')">Large Numbers</button>
                        <button class="btn btn-outline-warning" onclick="testEdgeCase('precision')">Precision Issues</button>
                        <button class="btn btn-outline-warning" onclick="testEdgeCase('invalid')">Invalid Data</button>
                        <button class="btn btn-outline-warning" onclick="testEdgeCase('overflow')">Overflow</button>
                    </div>
                </div>
            </div>
            
            <div id="result5" class="test-result" style="display: none;"></div>
        </div>

        <!-- Test 6: Real-world Scenarios -->
        <div class="test-section">
            <h3><i class="bi bi-6-circle me-2"></i>Test Real-world Scenarios</h3>
            <p>Testing common real-world cash handling scenarios</p>
            
            <div class="row">
                <div class="col-12">
                    <div class="btn-group flex-wrap">
                        <button class="btn btn-success" onclick="testScenario('perfect')">Perfect Match</button>
                        <button class="btn btn-warning" onclick="testScenario('small_excess')">Small Excess</button>
                        <button class="btn btn-danger" onclick="testScenario('shortage')">Cash Shortage</button>
                        <button class="btn btn-info" onclick="testScenario('large_shift')">Large Shift</button>
                        <button class="btn btn-secondary" onclick="testScenario('complex')">Complex Calculation</button>
                    </div>
                </div>
            </div>
            
            <div id="result6" class="test-result" style="display: none;"></div>
        </div>

        <!-- Summary -->
        <div class="test-section">
            <h3><i class="bi bi-clipboard-check me-2"></i>Test Summary</h3>
            <div id="testSummary">
                <p class="text-muted">Run tests above to see summary results</p>
            </div>
        </div>
    </div>

    <!-- Include required scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/enhanced-cash-calculation.js"></script>

    <script>
        // Test tracking
        let testResults = {
            passed: 0,
            failed: 0,
            total: 0
        };

        // Real-time calculation setup
        document.addEventListener('DOMContentLoaded', function() {
            // Set up real-time calculation for selisih test
            const kasAktual2 = document.getElementById('kasAktual2');
            const kasSeharusnya2 = document.getElementById('kasSeharusnya2');
            const realTime2 = document.getElementById('realTime2');
            
            [kasAktual2, kasSeharusnya2].forEach(input => {
                input.addEventListener('input', function() {
                    if (realTime2.checked) {
                        testSelisih();
                    }
                });
            });
        });

        // Test 1: Kas Seharusnya Calculation
        function testKasSeharusnya() {
            const modalAwal = parseFloat(document.getElementById('modalAwal1').value) || 0;
            const totalCash = parseFloat(document.getElementById('totalCash1').value) || 0;
            
            const result = calculateKasSeharusnyaEnhanced(modalAwal, totalCash);
            
            let html = '<h5>Kas Seharusnya Calculation Result</h5>';
            
            if (result.success) {
                html += `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle me-2"></i>Calculation successful!
                    </div>
                    <div class="calculation-display">
                        <strong>Formula:</strong> ${result.formula}<br>
                        <strong>Result:</strong> ${formatRupiah(result.kasSeharusnya)}
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <strong>Modal Awal:</strong><br>
                            ${formatRupiah(result.modalAwal)}
                        </div>
                        <div class="col-md-4">
                            <strong>Total Cash:</strong><br>
                            ${formatRupiah(result.totalCash)}
                        </div>
                        <div class="col-md-4">
                            <strong>Kas Seharusnya:</strong><br>
                            ${formatRupiah(result.kasSeharusnya)}
                        </div>
                    </div>
                `;
                recordTestResult(true);
            } else {
                html += `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>Calculation failed: ${result.error}
                    </div>
                `;
                recordTestResult(false);
            }
            
            showResult('result1', html, result.success ? 'success' : 'error');
        }

        // Test 2: Selisih Calculation
        function testSelisih() {
            const kasAktual = parseFloat(document.getElementById('kasAktual2').value) || 0;
            const kasSeharusnya = parseFloat(document.getElementById('kasSeharusnya2').value) || 0;
            
            const result = calculateSelisihEnhanced(kasAktual, kasSeharusnya);
            
            let html = '<h5>Selisih Calculation Result</h5>';
            
            if (result.success) {
                const alertClass = result.alertType === 'success' ? 'alert-success' : 
                                 result.alertType === 'warning' ? 'alert-warning' : 'alert-danger';
                
                html += `
                    <div class="alert ${alertClass}">
                        <i class="bi ${result.icon} me-2"></i>${result.message}
                    </div>
                    <div class="calculation-display">
                        <strong>Formula:</strong> ${result.formula}<br>
                        <strong>Selisih:</strong> ${formatRupiah(result.selisih)}<br>
                        <strong>Percentage:</strong> ${result.percentageDiff.toFixed(2)}%
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <strong>Status:</strong><br>
                            <span class="badge bg-${result.alertType === 'success' ? 'success' : result.alertType === 'warning' ? 'warning' : 'danger'}">${result.status}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Category:</strong><br>
                            ${result.category}
                        </div>
                        <div class="col-md-3">
                            <strong>Severity:</strong><br>
                            ${result.severity}
                        </div>
                        <div class="col-md-3">
                            <strong>Keterangan Required:</strong><br>
                            ${result.isKeteranganRequired ? 'Yes' : 'No'}
                        </div>
                    </div>
                `;
                recordTestResult(true);
            } else {
                html += `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>Calculation failed: ${result.error}
                    </div>
                `;
                recordTestResult(false);
            }
            
            showResult('result2', html, result.success ? 'success' : 'error');
        }

        // Test 3: Input Validation
        function testValidation() {
            const input = document.getElementById('testInput3').value;
            
            const result = validateKasAktualEnhanced(input);
            
            let html = '<h5>Input Validation Result</h5>';
            
            if (result.valid) {
                html += `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle me-2"></i>Input is valid!
                    </div>
                    <div class="calculation-display">
                        <strong>Input:</strong> "${input}"<br>
                        <strong>Parsed Value:</strong> ${formatRupiah(result.value)}<br>
                        <strong>Code:</strong> ${result.code}
                    </div>
                `;
                if (result.warning) {
                    html += `
                        <div class="alert alert-warning mt-2">
                            <i class="bi bi-exclamation-triangle me-2"></i>${result.warning}
                            ${result.originalValue ? `<br><small>Original: ${result.originalValue}, Rounded: ${result.value}</small>` : ''}
                        </div>
                    `;
                }
                recordTestResult(true);
            } else {
                html += `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle me-2"></i>Input is invalid: ${result.error}
                    </div>
                    <div class="calculation-display">
                        <strong>Input:</strong> "${input}"<br>
                        <strong>Error Code:</strong> ${result.code}<br>
                        <strong>Default Value:</strong> ${formatRupiah(result.value)}
                    </div>
                `;
                recordTestResult(false);
            }
            
            showResult('result3', html, result.valid ? 'success' : 'error');
        }

        // Test 4: Precision Arithmetic
        function testPrecision() {
            const a = parseFloat(document.getElementById('numberA4').value) || 0;
            const b = parseFloat(document.getElementById('numberB4').value) || 0;
            const operation = document.getElementById('operation4').value;
            
            let standardResult, preciseResult, operationSymbol;
            
            switch (operation) {
                case 'add':
                    standardResult = a + b;
                    preciseResult = precisionAdd(a, b);
                    operationSymbol = '+';
                    break;
                case 'subtract':
                    standardResult = a - b;
                    preciseResult = precisionSubtract(a, b);
                    operationSymbol = '-';
                    break;
                case 'multiply':
                    standardResult = a * b;
                    preciseResult = precisionMultiply(a, b);
                    operationSymbol = '×';
                    break;
            }
            
            const difference = Math.abs(standardResult - preciseResult);
            const hasPrecisionIssue = difference > 0.001;
            
            let html = '<h5>Precision Arithmetic Result</h5>';
            
            html += `
                <div class="calculation-display">
                    <strong>Operation:</strong> ${a} ${operationSymbol} ${b}<br>
                    <strong>Standard JavaScript:</strong> ${standardResult}<br>
                    <strong>Precision Function:</strong> ${preciseResult}<br>
                    <strong>Difference:</strong> ${difference}
                </div>
            `;
            
            if (hasPrecisionIssue) {
                html += `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Precision issue detected! Enhanced function provides more accurate result.
                    </div>
                `;
            } else {
                html += `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle me-2"></i>
                        No precision issues detected.
                    </div>
                `;
            }
            
            recordTestResult(true);
            showResult('result4', html, 'success');
        }

        // Test 5: Edge Cases
        function testEdgeCase(caseType) {
            let html = '<h5>Edge Case Test: ' + caseType.toUpperCase() + '</h5>';
            let allPassed = true;
            
            switch (caseType) {
                case 'zero':
                    const zeroTest1 = calculateKasSeharusnyaEnhanced(0, 0);
                    const zeroTest2 = calculateSelisihEnhanced(0, 0);
                    html += `
                        <div class="mb-3">
                            <strong>Zero Values Test:</strong><br>
                            Kas Seharusnya (0 + 0): ${zeroTest1.success ? 'PASS' : 'FAIL'}<br>
                            Selisih (0 - 0): ${zeroTest2.success ? 'PASS' : 'FAIL'}
                        </div>
                    `;
                    allPassed = zeroTest1.success && zeroTest2.success;
                    break;
                    
                case 'large':
                    const largeTest1 = calculateKasSeharusnyaEnhanced(999999999, 999999999);
                    const largeTest2 = validateKasAktualEnhanced('999999999999');
                    html += `
                        <div class="mb-3">
                            <strong>Large Numbers Test:</strong><br>
                            Large Calculation: ${largeTest1.success ? 'PASS' : 'FAIL'}<br>
                            Oversized Input: ${!largeTest2.valid ? 'PASS (correctly rejected)' : 'FAIL'}
                        </div>
                    `;
                    allPassed = largeTest1.success && !largeTest2.valid;
                    break;
                    
                case 'precision':
                    const precisionTest = precisionAdd(0.1, 0.2);
                    const standardTest = 0.1 + 0.2;
                    html += `
                        <div class="mb-3">
                            <strong>Precision Test (0.1 + 0.2):</strong><br>
                            Standard JS: ${standardTest}<br>
                            Enhanced: ${precisionTest}<br>
                            Precision Fixed: ${precisionTest === 0.3 ? 'PASS' : 'FAIL'}
                        </div>
                    `;
                    allPassed = precisionTest === 0.3;
                    break;
                    
                case 'invalid':
                    const invalidTest1 = validateKasAktualEnhanced('abc');
                    const invalidTest2 = validateKasAktualEnhanced(-100);
                    const invalidTest3 = calculateKasSeharusnyaEnhanced('invalid', 100);
                    html += `
                        <div class="mb-3">
                            <strong>Invalid Data Test:</strong><br>
                            Text Input: ${!invalidTest1.valid ? 'PASS (correctly rejected)' : 'FAIL'}<br>
                            Negative Input: ${!invalidTest2.valid ? 'PASS (correctly rejected)' : 'FAIL'}<br>
                            Invalid Calculation: ${!invalidTest3.success ? 'PASS (correctly rejected)' : 'FAIL'}
                        </div>
                    `;
                    allPassed = !invalidTest1.valid && !invalidTest2.valid && !invalidTest3.success;
                    break;
                    
                case 'overflow':
                    const overflowTest = calculateKasSeharusnyaEnhanced(Number.MAX_SAFE_INTEGER, 1);
                    html += `
                        <div class="mb-3">
                            <strong>Overflow Test:</strong><br>
                            MAX_SAFE_INTEGER + 1: ${!overflowTest.success ? 'PASS (correctly handled)' : 'FAIL'}
                        </div>
                    `;
                    allPassed = !overflowTest.success;
                    break;
            }
            
            recordTestResult(allPassed);
            showResult('result5', html, allPassed ? 'success' : 'error');
        }

        // Test 6: Real-world Scenarios
        function testScenario(scenarioType) {
            let html = '<h5>Real-world Scenario: ' + scenarioType.toUpperCase() + '</h5>';
            let result;
            
            switch (scenarioType) {
                case 'perfect':
                    result = calculateSelisihEnhanced(1750000, 1750000);
                    html += `<div class="mb-3"><strong>Perfect Match Scenario:</strong><br>
                             Modal: Rp 500,000, Sales: Rp 1,250,000, Actual: Rp 1,750,000<br>
                             Status: ${result.status} (${result.success ? 'PASS' : 'FAIL'})</div>`;
                    break;
                    
                case 'small_excess':
                    result = calculateSelisihEnhanced(1755000, 1750000);
                    html += `<div class="mb-3"><strong>Small Excess Scenario:</strong><br>
                             Excess of Rp 5,000 (likely counting error)<br>
                             Status: ${result.status}, Severity: ${result.severity} (${result.success ? 'PASS' : 'FAIL'})</div>`;
                    break;
                    
                case 'shortage':
                    result = calculateSelisihEnhanced(1730000, 1750000);
                    html += `<div class="mb-3"><strong>Cash Shortage Scenario:</strong><br>
                             Shortage of Rp 20,000<br>
                             Status: ${result.status}, Severity: ${result.severity} (${result.success ? 'PASS' : 'FAIL'})</div>`;
                    break;
                    
                case 'large_shift':
                    const largeShift = calculateKasSeharusnyaEnhanced(2000000, 15000000);
                    result = calculateSelisihEnhanced(17000000, largeShift.kasSeharusnya);
                    html += `<div class="mb-3"><strong>Large Shift Scenario:</strong><br>
                             Modal: Rp 2,000,000, Sales: Rp 15,000,000<br>
                             Expected: ${formatRupiah(largeShift.kasSeharusnya)}, Actual: Rp 17,000,000<br>
                             Status: ${result.status} (${result.success ? 'PASS' : 'FAIL'})</div>`;
                    break;
                    
                case 'complex':
                    const complexCalc = calculateKasSeharusnyaEnhanced(1234567, 9876543);
                    result = calculateSelisihEnhanced(11111110, complexCalc.kasSeharusnya);
                    html += `<div class="mb-3"><strong>Complex Calculation Scenario:</strong><br>
                             Modal: Rp 1,234,567, Sales: Rp 9,876,543<br>
                             Expected: ${formatRupiah(complexCalc.kasSeharusnya)}, Actual: Rp 11,111,110<br>
                             Selisih: ${formatRupiah(result.selisih)} (${result.success ? 'PASS' : 'FAIL'})</div>`;
                    break;
            }
            
            recordTestResult(result.success);
            showResult('result6', html, result.success ? 'success' : 'error');
        }

        // Helper functions
        function setTestValue(value) {
            document.getElementById('testInput3').value = value;
        }

        function showResult(elementId, html, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = html;
            element.className = `test-result test-${type}`;
            element.style.display = 'block';
            updateTestSummary();
        }

        function recordTestResult(passed) {
            testResults.total++;
            if (passed) {
                testResults.passed++;
            } else {
                testResults.failed++;
            }
        }

        function updateTestSummary() {
            const summaryElement = document.getElementById('testSummary');
            const passRate = testResults.total > 0 ? (testResults.passed / testResults.total * 100).toFixed(1) : 0;
            
            summaryElement.innerHTML = `
                <div class="row">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-success">${testResults.passed}</h5>
                                <p class="card-text">Tests Passed</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-danger">${testResults.failed}</h5>
                                <p class="card-text">Tests Failed</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-info">${testResults.total}</h5>
                                <p class="card-text">Total Tests</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-primary">${passRate}%</h5>
                                <p class="card-text">Pass Rate</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Initialize
        updateTestSummary();
    </script>
</body>
</html>