<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Pembayaran Utils Integration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h2 class="mb-4">
            <i class="bi bi-check2-circle text-success me-2"></i>
            Test Pembayaran Module - Utils Integration
        </h2>
        
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Test Purpose:</strong> Verify that pembayaranHutangPiutang.js correctly uses shared functions from utils.js
        </div>
        
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Test Setup</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-primary" onclick="setupTestData()">
                    <i class="bi bi-database-add me-1"></i>Setup Test Data
                </button>
                <button class="btn btn-success ms-2" onclick="runIntegrationTests()">
                    <i class="bi bi-play-circle me-1"></i>Run Integration Tests
                </button>
                <button class="btn btn-danger ms-2" onclick="clearTestData()">
                    <i class="bi bi-trash me-1"></i>Clear Test Data
                </button>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Test Results</h5>
            </div>
            <div class="card-body">
                <div id="testResults"></div>
            </div>
        </div>
    </div>

    <!-- Load utils.js first (as in index.html) -->
    <script src="js/utils.js"></script>
    
    <script>
        function setupTestData() {
            // Create test anggota
            const anggota = [
                { id: 'A001', nik: '1234', nama: 'Test User 1', departemen: 'IT' },
                { id: 'A002', nik: '5678', nama: 'Test User 2', departemen: 'Finance' }
            ];
            localStorage.setItem('anggota', JSON.stringify(anggota));
            
            // Create test penjualan (credit transactions)
            const penjualan = [
                { id: 'P001', anggotaId: 'A001', total: 100000, status: 'kredit', tanggal: '2024-01-01' },
                { id: 'P002', anggotaId: 'A001', total: 50000, status: 'kredit', tanggal: '2024-01-02' },
                { id: 'P003', anggotaId: 'A002', total: 200000, status: 'kredit', tanggal: '2024-01-03' }
            ];
            localStorage.setItem('penjualan', JSON.stringify(penjualan));
            
            // Create test pembayaran
            const pembayaran = [
                { 
                    id: 'PHT001', 
                    anggotaId: 'A001', 
                    jenis: 'hutang', 
                    jumlah: 30000, 
                    status: 'selesai',
                    tanggal: '2024-01-05',
                    kasirNama: 'Kasir 1'
                },
                { 
                    id: 'PHT002', 
                    anggotaId: 'A002', 
                    jenis: 'hutang', 
                    jumlah: 50000, 
                    status: 'selesai',
                    tanggal: '2024-01-06',
                    kasirNama: 'Kasir 2'
                }
            ];
            localStorage.setItem('pembayaranHutangPiutang', JSON.stringify(pembayaran));
            
            showAlert('Test data berhasil di-setup!', 'success');
        }
        
        function clearTestData() {
            localStorage.removeItem('anggota');
            localStorage.removeItem('penjualan');
            localStorage.removeItem('pembayaranHutangPiutang');
            showAlert('Test data berhasil dihapus!', 'info');
            document.getElementById('testResults').innerHTML = '';
        }
        
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.card'));
            setTimeout(() => alertDiv.remove(), 3000);
        }
        
        function runIntegrationTests() {
            const results = [];
            
            // Test 1: Verify utils.js functions are available
            results.push(testFunctionsAvailable());
            
            // Test 2: Test hitungSaldoHutang
            results.push(testHitungSaldoHutang());
            
            // Test 3: Test hitungTotalKredit
            results.push(testHitungTotalKredit());
            
            // Test 4: Test hitungTotalPembayaranHutang
            results.push(testHitungTotalPembayaranHutang());
            
            // Test 5: Test getPembayaranHutangHistory
            results.push(testGetPembayaranHutangHistory());
            
            // Test 6: Test cross-module consistency
            results.push(testCrossModuleConsistency());
            
            displayResults(results);
        }
        
        function testFunctionsAvailable() {
            const test = { name: 'Functions Available from utils.js', passed: true, details: [] };
            
            try {
                const functions = [
                    'hitungSaldoHutang',
                    'hitungSaldoPiutang',
                    'hitungTotalKredit',
                    'hitungTotalPembayaranHutang',
                    'getPembayaranHutangHistory',
                    'getPembayaranPiutangHistory'
                ];
                
                functions.forEach(funcName => {
                    if (typeof window[funcName] === 'function') {
                        test.details.push(`✓ ${funcName} is available`);
                    } else {
                        test.passed = false;
                        test.details.push(`✗ ${funcName} is NOT available`);
                    }
                });
            } catch (error) {
                test.passed = false;
                test.details.push(`✗ Error: ${error.message}`);
            }
            
            return test;
        }
        
        function testHitungSaldoHutang() {
            const test = { name: 'hitungSaldoHutang() Integration', passed: true, details: [] };
            
            try {
                // A001: 150000 kredit - 30000 payment = 120000
                const saldoA001 = hitungSaldoHutang('A001');
                if (saldoA001 === 120000) {
                    test.details.push('✓ A001 saldo: Rp 120,000 (correct)');
                } else {
                    test.passed = false;
                    test.details.push(`✗ A001 saldo: Expected 120000, got ${saldoA001}`);
                }
                
                // A002: 200000 kredit - 50000 payment = 150000
                const saldoA002 = hitungSaldoHutang('A002');
                if (saldoA002 === 150000) {
                    test.details.push('✓ A002 saldo: Rp 150,000 (correct)');
                } else {
                    test.passed = false;
                    test.details.push(`✗ A002 saldo: Expected 150000, got ${saldoA002}`);
                }
            } catch (error) {
                test.passed = false;
                test.details.push(`✗ Error: ${error.message}`);
            }
            
            return test;
        }
        
        function testHitungTotalKredit() {
            const test = { name: 'hitungTotalKredit() Integration', passed: true, details: [] };
            
            try {
                const totalA001 = hitungTotalKredit('A001');
                if (totalA001 === 150000) {
                    test.details.push('✓ A001 total kredit: Rp 150,000');
                } else {
                    test.passed = false;
                    test.details.push(`✗ A001 total kredit: Expected 150000, got ${totalA001}`);
                }
                
                const totalA002 = hitungTotalKredit('A002');
                if (totalA002 === 200000) {
                    test.details.push('✓ A002 total kredit: Rp 200,000');
                } else {
                    test.passed = false;
                    test.details.push(`✗ A002 total kredit: Expected 200000, got ${totalA002}`);
                }
            } catch (error) {
                test.passed = false;
                test.details.push(`✗ Error: ${error.message}`);
            }
            
            return test;
        }
        
        function testHitungTotalPembayaranHutang() {
            const test = { name: 'hitungTotalPembayaranHutang() Integration', passed: true, details: [] };
            
            try {
                const totalA001 = hitungTotalPembayaranHutang('A001');
                if (totalA001 === 30000) {
                    test.details.push('✓ A001 total pembayaran: Rp 30,000');
                } else {
                    test.passed = false;
                    test.details.push(`✗ A001 total pembayaran: Expected 30000, got ${totalA001}`);
                }
                
                const totalA002 = hitungTotalPembayaranHutang('A002');
                if (totalA002 === 50000) {
                    test.details.push('✓ A002 total pembayaran: Rp 50,000');
                } else {
                    test.passed = false;
                    test.details.push(`✗ A002 total pembayaran: Expected 50000, got ${totalA002}`);
                }
            } catch (error) {
                test.passed = false;
                test.details.push(`✗ Error: ${error.message}`);
            }
            
            return test;
        }
        
        function testGetPembayaranHutangHistory() {
            const test = { name: 'getPembayaranHutangHistory() Integration', passed: true, details: [] };
            
            try {
                const historyA001 = getPembayaranHutangHistory('A001');
                if (historyA001.length === 1) {
                    test.details.push('✓ A001 has 1 payment in history');
                } else {
                    test.passed = false;
                    test.details.push(`✗ A001 history: Expected 1, got ${historyA001.length}`);
                }
                
                const historyA002 = getPembayaranHutangHistory('A002');
                if (historyA002.length === 1) {
                    test.details.push('✓ A002 has 1 payment in history');
                } else {
                    test.passed = false;
                    test.details.push(`✗ A002 history: Expected 1, got ${historyA002.length}`);
                }
            } catch (error) {
                test.passed = false;
                test.details.push(`✗ Error: ${error.message}`);
            }
            
            return test;
        }
        
        function testCrossModuleConsistency() {
            const test = { name: 'Cross-Module Consistency', passed: true, details: [] };
            
            try {
                // Test that saldo = kredit - pembayaran
                const anggotaId = 'A001';
                const saldo = hitungSaldoHutang(anggotaId);
                const kredit = hitungTotalKredit(anggotaId);
                const pembayaran = hitungTotalPembayaranHutang(anggotaId);
                
                if (saldo === (kredit - pembayaran)) {
                    test.details.push('✓ Saldo calculation is consistent: saldo = kredit - pembayaran');
                    test.details.push(`  Saldo: ${saldo}, Kredit: ${kredit}, Pembayaran: ${pembayaran}`);
                } else {
                    test.passed = false;
                    test.details.push(`✗ Inconsistent calculation: ${saldo} ≠ ${kredit} - ${pembayaran}`);
                }
                
                // Test idempotence
                const saldo1 = hitungSaldoHutang(anggotaId);
                const saldo2 = hitungSaldoHutang(anggotaId);
                const saldo3 = hitungSaldoHutang(anggotaId);
                
                if (saldo1 === saldo2 && saldo2 === saldo3) {
                    test.details.push('✓ Function is idempotent (consistent results)');
                } else {
                    test.passed = false;
                    test.details.push('✗ Function is NOT idempotent');
                }
            } catch (error) {
                test.passed = false;
                test.details.push(`✗ Error: ${error.message}`);
            }
            
            return test;
        }
        
        function displayResults(results) {
            const container = document.getElementById('testResults');
            const passedCount = results.filter(r => r.passed).length;
            const totalCount = results.length;
            
            let html = `
                <div class="alert ${passedCount === totalCount ? 'alert-success' : 'alert-warning'}">
                    <h5>
                        <i class="bi bi-${passedCount === totalCount ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                        Integration Test Results: ${passedCount}/${totalCount} Passed
                    </h5>
                </div>
            `;
            
            results.forEach(test => {
                html += `
                    <div class="card mb-3">
                        <div class="card-header ${test.passed ? 'bg-success' : 'bg-danger'} text-white">
                            <i class="bi bi-${test.passed ? 'check-circle' : 'x-circle'} me-2"></i>
                            ${test.name} - ${test.passed ? 'PASSED' : 'FAILED'}
                        </div>
                        <div class="card-body">
                            <ul class="mb-0">
                                ${test.details.map(d => `<li>${d}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
