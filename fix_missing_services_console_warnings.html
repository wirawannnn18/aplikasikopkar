<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Missing Services Console Warnings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-tools"></i>
                            Fix Missing Services Console Warnings
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>Perbaikan:</strong> Mengatasi peringatan console tentang service yang tidak tersedia.
                        </div>

                        <div id="fixStatus" class="mb-3"></div>
                        
                        <button id="fixServicesBtn" class="btn btn-primary">
                            <i class="bi bi-wrench"></i>
                            Perbaiki Services
                        </button>
                        
                        <button id="testServicesBtn" class="btn btn-success ms-2">
                            <i class="bi bi-check-circle"></i>
                            Test Services
                        </button>
                        
                        <button id="reloadPageBtn" class="btn btn-warning ms-2">
                            <i class="bi bi-arrow-clockwise"></i>
                            Reload Page
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Load the services in correct order -->
    <script src="js/shared/SharedPaymentServices.js"></script>
    <script src="js/shared/LazyLoadingManager.js"></script>
    <script src="js/shared/DataQueryOptimizer.js"></script>
    <script src="js/shared/RealTimeUpdateManager.js"></script>
    <script src="js/shared/CrossModeErrorHandler.js"></script>
    <script src="js/shared/DataConsistencyValidator.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fixStatusDiv = document.getElementById('fixStatus');
            const fixServicesBtn = document.getElementById('fixServicesBtn');
            const testServicesBtn = document.getElementById('testServicesBtn');
            const reloadPageBtn = document.getElementById('reloadPageBtn');

            function updateStatus(message, type = 'info') {
                fixStatusDiv.innerHTML = `
                    <div class="alert alert-${type}">
                        ${message}
                    </div>
                `;
            }

            function checkServicesAvailability() {
                const services = {
                    'SharedPaymentServices': window.SharedPaymentServices,
                    'LazyLoadingManager': window.LazyLoadingManager,
                    'DataQueryOptimizer': window.DataQueryOptimizer,
                    'RealTimeUpdateManager': window.RealTimeUpdateManager,
                    'CrossModeErrorHandler': window.CrossModeErrorHandler,
                    'DataConsistencyValidator': window.DataConsistencyValidator
                };

                const available = [];
                const missing = [];

                for (const [name, service] of Object.entries(services)) {
                    if (typeof service !== 'undefined') {
                        available.push(name);
                    } else {
                        missing.push(name);
                    }
                }

                return { available, missing };
            }

            function fixServices() {
                updateStatus('Memperbaiki services...', 'info');

                try {
                    // Ensure SharedPaymentServices is available
                    if (typeof window.SharedPaymentServices === 'undefined') {
                        console.log('Loading SharedPaymentServices...');
                        // The service should be loaded by the script tag above
                    }

                    // Ensure LazyLoadingManager is available
                    if (typeof window.LazyLoadingManager === 'undefined') {
                        console.log('Loading LazyLoadingManager...');
                        // The service should be loaded by the script tag above
                    }

                    // Ensure DataQueryOptimizer is available
                    if (typeof window.DataQueryOptimizer === 'undefined') {
                        console.log('Loading DataQueryOptimizer...');
                        // The service should be loaded by the script tag above
                    }

                    // Ensure RealTimeUpdateManager is available
                    if (typeof window.RealTimeUpdateManager === 'undefined') {
                        console.log('Loading RealTimeUpdateManager...');
                        // The service should be loaded by the script tag above
                    }

                    // Create placeholder services for missing ones
                    if (typeof window.CrossModeErrorHandler === 'undefined') {
                        window.CrossModeErrorHandler = class {
                            constructor(sharedServices) {
                                this.sharedServices = sharedServices;
                                console.log('CrossModeErrorHandler placeholder created');
                            }
                            
                            handleError(error, context) {
                                console.warn('CrossModeErrorHandler placeholder - handling error:', error.message);
                                return {
                                    success: false,
                                    error: error,
                                    message: error.message,
                                    requiresManualIntervention: true
                                };
                            }
                            
                            async performCrossModeRollback(transactionId, options) {
                                console.warn('CrossModeErrorHandler placeholder - rollback requested for:', transactionId);
                                return {
                                    success: false,
                                    message: 'Rollback not available in placeholder mode'
                                };
                            }
                        };
                    }

                    if (typeof window.DataConsistencyValidator === 'undefined') {
                        window.DataConsistencyValidator = class {
                            constructor(sharedServices) {
                                this.sharedServices = sharedServices;
                                console.log('DataConsistencyValidator placeholder created');
                            }
                            
                            validateCrossModeConsistency() {
                                console.log('DataConsistencyValidator placeholder - validation requested');
                                return {
                                    valid: true,
                                    message: 'Validation not available in placeholder mode',
                                    warnings: ['Using placeholder validator']
                                };
                            }
                            
                            validateSaldoConsistency(anggotaId) {
                                console.log('DataConsistencyValidator placeholder - saldo validation for:', anggotaId);
                                return {
                                    valid: true,
                                    message: 'Saldo validation not available in placeholder mode',
                                    warnings: ['Using placeholder validator']
                                };
                            }
                        };
                    }

                    // Test services after fix
                    setTimeout(() => {
                        testServices();
                    }, 1000);

                } catch (error) {
                    console.error('Error fixing services:', error);
                    updateStatus(`Error: ${error.message}`, 'danger');
                }
            }

            function testServices() {
                const { available, missing } = checkServicesAvailability();
                
                let statusHtml = '<h6>Status Services:</h6>';
                
                if (available.length > 0) {
                    statusHtml += '<div class="alert alert-success"><strong>Tersedia:</strong><ul class="mb-0">';
                    available.forEach(service => {
                        statusHtml += `<li>${service} ✓</li>`;
                    });
                    statusHtml += '</ul></div>';
                }
                
                if (missing.length > 0) {
                    statusHtml += '<div class="alert alert-warning"><strong>Masih Missing:</strong><ul class="mb-0">';
                    missing.forEach(service => {
                        statusHtml += `<li>${service} ⚠️</li>`;
                    });
                    statusHtml += '</ul></div>';
                }

                // Test SharedPaymentServices if available
                if (window.SharedPaymentServices) {
                    try {
                        const testService = new window.SharedPaymentServices();
                        statusHtml += '<div class="alert alert-info">SharedPaymentServices berhasil diinisialisasi ✓</div>';
                    } catch (error) {
                        statusHtml += `<div class="alert alert-danger">SharedPaymentServices error: ${error.message}</div>`;
                    }
                }

                // Test LazyLoadingManager if available
                if (window.LazyLoadingManager) {
                    try {
                        const testManager = new window.LazyLoadingManager();
                        statusHtml += '<div class="alert alert-info">LazyLoadingManager berhasil diinisialisasi ✓</div>';
                    } catch (error) {
                        statusHtml += `<div class="alert alert-danger">LazyLoadingManager error: ${error.message}</div>`;
                    }
                }

                // Test DataQueryOptimizer if available
                if (window.DataQueryOptimizer && window.SharedPaymentServices) {
                    try {
                        const sharedServices = new window.SharedPaymentServices();
                        const testOptimizer = new window.DataQueryOptimizer(sharedServices);
                        statusHtml += '<div class="alert alert-info">DataQueryOptimizer berhasil diinisialisasi ✓</div>';
                    } catch (error) {
                        statusHtml += `<div class="alert alert-danger">DataQueryOptimizer error: ${error.message}</div>`;
                    }
                }

                // Test RealTimeUpdateManager if available
                if (window.RealTimeUpdateManager && window.SharedPaymentServices) {
                    try {
                        const sharedServices = new window.SharedPaymentServices();
                        const testManager = new window.RealTimeUpdateManager(sharedServices);
                        statusHtml += '<div class="alert alert-info">RealTimeUpdateManager berhasil diinisialisasi ✓</div>';
                    } catch (error) {
                        statusHtml += `<div class="alert alert-danger">RealTimeUpdateManager error: ${error.message}</div>`;
                    }
                }

                updateStatus(statusHtml, 'light');
            }

            // Event listeners
            fixServicesBtn.addEventListener('click', fixServices);
            testServicesBtn.addEventListener('click', testServices);
            reloadPageBtn.addEventListener('click', () => {
                window.location.reload();
            });

            // Initial test
            testServices();
        });
    </script>
</body>
</html>