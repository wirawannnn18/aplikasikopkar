<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Task 5.3: Engagement Metrics Calculations</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
        .success {
            border-left: 4px solid #28a745;
            background-color: #d4edda;
        }
        .error {
            border-left: 4px solid #dc3545;
            background-color: #f8d7da;
        }
        .warning {
            border-left: 4px solid #ffc107;
            background-color: #fff3cd;
        }
        .controls {
            margin-bottom: 20px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .metric-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .metric-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        .engagement-high { border-left-color: #28a745; }
        .engagement-medium { border-left-color: #ffc107; }
        .engagement-low { border-left-color: #fd7e14; }
        .engagement-critical { border-left-color: #dc3545; }
        .trend-up { color: #28a745; }
        .trend-down { color: #dc3545; }
        .trend-stable { color: #6c757d; }
        .risk-low { background-color: #d4edda; }
        .risk-medium { background-color: #fff3cd; }
        .risk-high { background-color: #f8d7da; }
        .risk-critical { background-color: #f5c6cb; }
        .member-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .member-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .member-item:last-child {
            border-bottom: none;
        }
        .engagement-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        .badge-highly-engaged { background-color: #28a745; }
        .badge-engaged { background-color: #17a2b8; }
        .badge-moderately-engaged { background-color: #ffc107; color: #333; }
        .badge-low-engagement { background-color: #fd7e14; }
        .badge-disengaged { background-color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test Task 5.3: Engagement Metrics Calculations</h1>
        <p>Testing comprehensive member engagement metrics including average transaction values, trend analysis, and risk assessment for member inactivity.</p>
        
        <div class="test-section">
            <h3>Requirements Validation</h3>
            <p><strong>Requirements 3.4:</strong> Average transaction value per member and transaction trends</p>
            <p><strong>Requirements 3.5:</strong> Members at risk of becoming inactive</p>
            
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Engagement Metrics</div>
                    <div class="metric-value">‚úÖ</div>
                    <div class="metric-label">Comprehensive scoring system</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Trend Analysis</div>
                    <div class="metric-value">üìà</div>
                    <div class="metric-label">Linear regression & forecasting</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Risk Assessment</div>
                    <div class="metric-value">‚ö†Ô∏è</div>
                    <div class="metric-label">Multi-factor risk scoring</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Recommendations</div>
                    <div class="metric-value">üí°</div>
                    <div class="metric-label">Actionable insights</div>
                </div>
            </div>
        </div>

        <div class="controls">
            <button onclick="testEngagementMetrics()">Test Engagement Metrics</button>
            <button onclick="testEngagementTrends()">Test Engagement Trends</button>
            <button onclick="testRiskAssessment()">Test Risk Assessment</button>
            <button onclick="runComprehensiveTest()">Run All Tests</button>
            <button onclick="clearResults()">Clear Results</button>
        </div>

        <div id="results"></div>
    </div>

    <script src="js/dashboard/MemberAnalytics.js"></script>
    <script>
        // Mock data source for testing
        class MockDataSource {
            constructor() {
                this.members = this.generateMockMembers();
                this.transactions = this.generateMockTransactions();
            }

            generateMockMembers() {
                const members = [];
                const names = ['Ahmad Suharto', 'Siti Nurhaliza', 'Budi Santoso', 'Dewi Lestari', 'Eko Prasetyo', 
                              'Fitri Handayani', 'Gunawan Wijaya', 'Hesti Purwanti', 'Indra Kusuma', 'Joko Widodo',
                              'Kartika Sari', 'Lukman Hakim', 'Maya Sari', 'Nanda Pratama', 'Oki Setiana'];
                
                for (let i = 1; i <= 50; i++) {
                    members.push({
                        id: i,
                        nama: names[Math.floor(Math.random() * names.length)] + ` ${i}`,
                        status: 'aktif',
                        tanggal_daftar: new Date(2020 + Math.floor(Math.random() * 4), 
                                               Math.floor(Math.random() * 12), 
                                               Math.floor(Math.random() * 28) + 1).toISOString()
                    });
                }
                return members;
            }

            generateMockTransactions() {
                const transactions = [];
                const activeMembers = this.members.filter(m => m.status === 'aktif');
                
                // Generate transactions for the last 6 months with varying patterns
                const startDate = new Date();
                startDate.setMonth(startDate.getMonth() - 6);
                
                for (let i = 1; i <= 3000; i++) {
                    const member = activeMembers[Math.floor(Math.random() * activeMembers.length)];
                    
                    // Create different engagement patterns
                    let transactionDate;
                    let amount;
                    
                    if (member.id <= 10) {
                        // High engagement members - recent and frequent transactions
                        transactionDate = new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000);
                        amount = Math.floor(Math.random() * 3000000) + 500000; // 500K - 3.5M IDR
                    } else if (member.id <= 25) {
                        // Medium engagement members - moderate activity
                        transactionDate = new Date(Date.now() - Math.random() * 60 * 24 * 60 * 60 * 1000);
                        amount = Math.floor(Math.random() * 1500000) + 200000; // 200K - 1.7M IDR
                    } else if (member.id <= 40) {
                        // Low engagement members - infrequent activity
                        transactionDate = new Date(Date.now() - Math.random() * 120 * 24 * 60 * 60 * 1000);
                        amount = Math.floor(Math.random() * 800000) + 100000; // 100K - 900K IDR
                    } else {
                        // At-risk members - very old transactions
                        transactionDate = new Date(Date.now() - (90 + Math.random() * 90) * 24 * 60 * 60 * 1000);
                        amount = Math.floor(Math.random() * 500000) + 50000; // 50K - 550K IDR
                    }
                    
                    transactions.push({
                        id: i,
                        member_id: member.id,
                        tanggal: transactionDate.toISOString(),
                        jumlah: amount,
                        jenis: ['simpanan', 'pinjaman', 'pos'][Math.floor(Math.random() * 3)]
                    });
                }
                
                return transactions;
            }

            async getAllActiveMembers() {
                return this.members.filter(m => m.status === 'aktif');
            }

            async getTransactionsByDateRange(startDate, endDate) {
                return this.transactions.filter(t => {
                    const transactionDate = new Date(t.tanggal);
                    return transactionDate >= startDate && transactionDate <= endDate;
                });
            }

            async getLastTransactionByMember(memberId) {
                const memberTransactions = this.transactions
                    .filter(t => t.member_id === memberId)
                    .sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
                
                return memberTransactions.length > 0 ? memberTransactions[0] : null;
            }
        }

        // Initialize analytics with mock data
        const dataSource = new MockDataSource();
        const analytics = new MemberAnalytics(dataSource);

        function addResult(title, content, type = 'success') {
            const resultsDiv = document.getElementById('results');
            const section = document.createElement('div');
            section.className = `test-section ${type}`;
            section.innerHTML = `
                <h3>${title}</h3>
                <div class="result">${content}</div>
            `;
            resultsDiv.appendChild(section);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function getEngagementBadgeClass(category) {
            const classMap = {
                'highly_engaged': 'badge-highly-engaged',
                'engaged': 'badge-engaged',
                'moderately_engaged': 'badge-moderately-engaged',
                'low_engagement': 'badge-low-engagement',
                'disengaged': 'badge-disengaged'
            };
            return classMap[category] || 'badge-disengaged';
        }

        function getTrendIcon(direction) {
            const iconMap = {
                'increasing': 'üìà',
                'decreasing': 'üìâ',
                'stable': '‚û°Ô∏è'
            };
            return iconMap[direction] || '‚û°Ô∏è';
        }

        function getRiskIcon(level) {
            const iconMap = {
                'low': '‚úÖ',
                'medium': '‚ö†Ô∏è',
                'high': 'üî¥',
                'critical': 'üö®'
            };
            return iconMap[level] || '‚ùì';
        }

        async function testEngagementMetrics() {
            try {
                const startDate = new Date();
                startDate.setMonth(startDate.getMonth() - 3); // Last 3 months
                const endDate = new Date();
                
                console.log('Testing engagement metrics...');
                const result = await analytics.calculateEngagementMetrics(startDate, endDate);
                
                let report = `Engagement Metrics Analysis\n`;
                report += `Analysis Date: ${new Date(result.analysisDate).toLocaleString('id-ID')}\n`;
                report += `Period: ${result.period.start} to ${result.period.end}\n\n`;
                
                // Overall metrics
                report += `Overall Metrics:\n`;
                report += `- Total Members: ${result.overallMetrics.totalMembers}\n`;
                report += `- Active Members: ${result.overallMetrics.activeMembers} (${(result.overallMetrics.activeMembers / result.overallMetrics.totalMembers * 100).toFixed(1)}%)\n`;
                report += `- Avg Transaction Value per Member: ${formatCurrency(result.overallMetrics.avgTransactionValuePerMember)}\n`;
                report += `- Avg Transaction Value Overall: ${formatCurrency(result.overallMetrics.avgTransactionValueOverall)}\n`;
                report += `- Total Transaction Value: ${formatCurrency(result.overallMetrics.totalTransactionValue)}\n`;
                report += `- Total Transaction Count: ${result.overallMetrics.totalTransactionCount}\n\n`;
                
                // Engagement distribution
                report += `Engagement Distribution:\n`;
                const dist = result.overallMetrics.engagementDistribution;
                report += `- Highly Engaged: ${dist.counts.highly_engaged} (${dist.percentages.highly_engaged}%)\n`;
                report += `- Engaged: ${dist.counts.engaged} (${dist.percentages.engaged}%)\n`;
                report += `- Moderately Engaged: ${dist.counts.moderately_engaged} (${dist.percentages.moderately_engaged}%)\n`;
                report += `- Low Engagement: ${dist.counts.low_engagement} (${dist.percentages.low_engagement}%)\n`;
                report += `- Disengaged: ${dist.counts.disengaged} (${dist.percentages.disengaged}%)\n\n`;
                
                // Trend analysis
                report += `Trend Analysis:\n`;
                const trends = result.trendAnalysis;
                report += `- Increasing Trends: ${trends.counts.increasing} (${trends.percentages.increasing}%)\n`;
                report += `- Decreasing Trends: ${trends.counts.decreasing} (${trends.percentages.decreasing}%)\n`;
                report += `- Stable Trends: ${trends.counts.stable} (${trends.percentages.stable}%)\n\n`;
                
                // Risk analysis
                report += `Risk Analysis:\n`;
                const risks = result.riskAnalysis;
                report += `- Critical Risk: ${risks.counts.critical} (${risks.percentages.critical}%)\n`;
                report += `- High Risk: ${risks.counts.high} (${risks.percentages.high}%)\n`;
                report += `- Medium Risk: ${risks.counts.medium} (${risks.percentages.medium}%)\n`;
                report += `- Low Risk: ${risks.counts.low} (${risks.percentages.low}%)\n\n`;
                
                // Top engaged members
                report += `Top 10 Engaged Members:\n`;
                result.memberEngagementData.slice(0, 10).forEach((member, index) => {
                    report += `${index + 1}. ${member.nama}\n`;
                    report += `   Score: ${member.engagementScore.toFixed(1)}, Category: ${member.engagementCategory}\n`;
                    report += `   Transactions: ${member.transactionCount}, Value: ${formatCurrency(member.totalValue)}\n`;
                    report += `   Trend: ${getTrendIcon(member.trend.direction)} ${member.trend.direction}\n`;
                    report += `   Risk: ${getRiskIcon(member.riskLevel)} ${member.riskLevel}\n\n`;
                });
                
                addResult('Engagement Metrics Test', report, 'success');
            } catch (error) {
                addResult('Engagement Metrics Test', `Error: ${error.message}\n${error.stack}`, 'error');
            }
        }

        async function testEngagementTrends() {
            try {
                const startDate = new Date();
                startDate.setMonth(startDate.getMonth() - 4); // Last 4 months for trend analysis
                const endDate = new Date();
                
                console.log('Testing engagement trends...');
                const result = await analytics.calculateEngagementTrends(startDate, endDate);
                
                let report = `Engagement Trends Analysis\n`;
                report += `Analysis Date: ${new Date(result.analysisDate).toLocaleString('id-ID')}\n\n`;
                
                // Period data
                report += `Period Analysis:\n`;
                result.trendAnalysis.periods.forEach(period => {
                    report += `Period ${period.period} (${period.startDate} to ${period.endDate}):\n`;
                    report += `  Active Members: ${period.activeMembers}\n`;
                    report += `  Avg Transaction Value: ${formatCurrency(period.avgTransactionValue)}\n`;
                    report += `  Total Value: ${formatCurrency(period.totalTransactionValue)}\n`;
                    report += `  Engagement Score: ${period.engagementScore}\n\n`;
                });
                
                // Trend directions
                report += `Trend Directions:\n`;
                const trends = result.trendAnalysis.trends;
                report += `- Active Members: ${getTrendIcon(trends.activeMembersTrend.direction)} ${trends.activeMembersTrend.direction} (confidence: ${(trends.activeMembersTrend.confidence * 100).toFixed(1)}%)\n`;
                report += `- Avg Transaction Value: ${getTrendIcon(trends.avgTransactionValueTrend.direction)} ${trends.avgTransactionValueTrend.direction} (confidence: ${(trends.avgTransactionValueTrend.confidence * 100).toFixed(1)}%)\n`;
                report += `- Total Value: ${getTrendIcon(trends.totalValueTrend.direction)} ${trends.totalValueTrend.direction} (confidence: ${(trends.totalValueTrend.confidence * 100).toFixed(1)}%)\n`;
                report += `- Engagement Score: ${getTrendIcon(trends.engagementScoreTrend.direction)} ${trends.engagementScoreTrend.direction} (confidence: ${(trends.engagementScoreTrend.confidence * 100).toFixed(1)}%)\n\n`;
                
                // Growth rates
                report += `Growth Rates:\n`;
                const growth = result.trendAnalysis.growthRates;
                report += `- Active Members Growth: ${growth.activeMembersGrowth}%\n`;
                report += `- Avg Transaction Value Growth: ${growth.avgTransactionValueGrowth}%\n`;
                report += `- Total Value Growth: ${growth.totalValueGrowth}%\n\n`;
                
                // Summary
                report += `Summary:\n${result.summary}`;
                
                addResult('Engagement Trends Test', report, 'success');
            } catch (error) {
                addResult('Engagement Trends Test', `Error: ${error.message}\n${error.stack}`, 'error');
            }
        }

        async function testRiskAssessment() {
            try {
                console.log('Testing risk assessment...');
                const result = await analytics.assessMemberInactivityRisk();
                
                let report = `Member Inactivity Risk Assessment\n`;
                report += `Analysis Date: ${new Date(result.analysisDate).toLocaleString('id-ID')}\n\n`;
                
                // Summary
                report += `Risk Summary:\n`;
                report += `- Total Members: ${result.summary.totalMembers}\n`;
                report += `- Critical Risk: ${result.summary.criticalRisk} (${result.summary.riskDistribution.critical}%)\n`;
                report += `- High Risk: ${result.summary.highRisk} (${result.summary.riskDistribution.high}%)\n`;
                report += `- Medium Risk: ${result.summary.mediumRisk} (${result.summary.riskDistribution.medium}%)\n`;
                report += `- Low Risk: ${result.summary.lowRisk} (${result.summary.riskDistribution.low}%)\n\n`;
                
                // Critical risk members
                if (result.riskGroups.critical.length > 0) {
                    report += `Critical Risk Members:\n`;
                    result.riskGroups.critical.slice(0, 5).forEach(member => {
                        report += `- ${member.nama}\n`;
                        report += `  Risk Score: ${member.riskScore}/100\n`;
                        report += `  Days Since Last Activity: ${member.daysSinceLastActivity === Infinity ? 'Never' : member.daysSinceLastActivity}\n`;
                        report += `  Risk Factors: ${member.riskFactors.join(', ')}\n`;
                        report += `  Recommendations: ${member.recommendedActions.join('; ')}\n\n`;
                    });
                }
                
                // High risk members
                if (result.riskGroups.high.length > 0) {
                    report += `High Risk Members (Sample):\n`;
                    result.riskGroups.high.slice(0, 3).forEach(member => {
                        report += `- ${member.nama}\n`;
                        report += `  Risk Score: ${member.riskScore}/100\n`;
                        report += `  Days Since Last Activity: ${member.daysSinceLastActivity}\n`;
                        report += `  Recent Transactions: ${member.recentTransactionCount}\n`;
                        report += `  Recommendations: ${member.recommendedActions.slice(0, 2).join('; ')}\n\n`;
                    });
                }
                
                // Risk factor analysis
                const allMembers = [
                    ...result.riskGroups.critical,
                    ...result.riskGroups.high,
                    ...result.riskGroups.medium,
                    ...result.riskGroups.low
                ];
                
                const riskFactorCounts = {};
                allMembers.forEach(member => {
                    member.riskFactors.forEach(factor => {
                        riskFactorCounts[factor] = (riskFactorCounts[factor] || 0) + 1;
                    });
                });
                
                report += `Common Risk Factors:\n`;
                Object.entries(riskFactorCounts)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5)
                    .forEach(([factor, count]) => {
                        report += `- ${factor.replace(/_/g, ' ')}: ${count} members\n`;
                    });
                
                addResult('Risk Assessment Test', report, 'success');
            } catch (error) {
                addResult('Risk Assessment Test', `Error: ${error.message}\n${error.stack}`, 'error');
            }
        }

        async function runComprehensiveTest() {
            addResult('Comprehensive Test', 'Running all engagement metrics tests...', 'warning');
            
            await testEngagementMetrics();
            await testEngagementTrends();
            await testRiskAssessment();
            
            addResult('Comprehensive Test Complete', 
                'All engagement metrics tests completed successfully!\n\n' +
                'Requirements Validated:\n' +
                '‚úÖ Requirements 3.4: Average transaction value per member and transaction trends\n' +
                '‚úÖ Requirements 3.5: Members at risk of becoming inactive\n\n' +
                'Features Implemented:\n' +
                '‚Ä¢ Comprehensive engagement scoring system\n' +
                '‚Ä¢ Linear regression trend analysis\n' +
                '‚Ä¢ Multi-factor risk assessment\n' +
                '‚Ä¢ Actionable recommendations\n' +
                '‚Ä¢ Historical engagement tracking\n' +
                '‚Ä¢ Growth rate calculations', 
                'success');
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // Run initial test on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Engagement Metrics test page loaded');
            addResult('System Ready', 
                'Engagement Metrics testing system is ready.\n\n' +
                'This test validates Task 5.3: Implement engagement metrics calculations\n' +
                'Requirements 3.4: Average transaction value per member and transaction trends\n' +
                'Requirements 3.5: Members at risk of becoming inactive\n\n' +
                'Click buttons above to run specific tests or comprehensive validation.', 
                'success');
        });
    </script>
</body>
</html>