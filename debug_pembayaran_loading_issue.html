<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Pembayaran Loading Issue</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .log-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }
        .log-entry {
            margin-bottom: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }
        .log-info { background-color: #d1ecf1; color: #0c5460; }
        .log-success { background-color: #d4edda; color: #155724; }
        .log-warning { background-color: #fff3cd; color: #856404; }
        .log-error { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <h2><i class="bi bi-bug"></i> Debug Pembayaran Hutang/Piutang Loading Issue</h2>
                <p class="text-muted">Diagnostic tool untuk mengidentifikasi masalah loading interface pembayaran manual</p>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-gear"></i> Diagnostic Controls</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="runFullDiagnostic()">
                                <i class="bi bi-play-circle"></i> Run Full Diagnostic
                            </button>
                            <button class="btn btn-info" onclick="checkScriptLoading()">
                                <i class="bi bi-file-earmark-code"></i> Check Script Loading
                            </button>
                            <button class="btn btn-warning" onclick="checkFunctionAvailability()">
                                <i class="bi bi-code-square"></i> Check Function Availability
                            </button>
                            <button class="btn btn-success" onclick="testRenderFunction()">
                                <i class="bi bi-eye"></i> Test Render Function
                            </button>
                            <button class="btn btn-secondary" onclick="clearLogs()">
                                <i class="bi bi-trash"></i> Clear Logs
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-list-check"></i> Quick Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="quickStatus">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Script Loading:</span>
                                <span id="scriptStatus" class="badge bg-secondary">Unknown</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Function Available:</span>
                                <span id="functionStatus" class="badge bg-secondary">Unknown</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Dependencies:</span>
                                <span id="dependencyStatus" class="badge bg-secondary">Unknown</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Render Test:</span>
                                <span id="renderStatus" class="badge bg-secondary">Unknown</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-terminal"></i> Diagnostic Logs</h5>
                    </div>
                    <div class="card-body">
                        <div id="logContainer" class="log-container">
                            <div class="log-entry log-info">Ready to run diagnostics...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Container -->
        <div id="testContainer" style="display: none;"></div>
    </div>

    <!-- Load required scripts in correct order -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Core dependencies -->
    <script src="js/app.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/koperasi.js"></script>
    <script src="js/keuangan.js"></script>
    <script src="js/transactionValidator.js"></script>
    
    <!-- Target script -->
    <script src="js/pembayaranHutangPiutang.js"></script>

    <script>
        let logContainer;
        
        document.addEventListener('DOMContentLoaded', function() {
            logContainer = document.getElementById('logContainer');
            log('Page loaded, ready for diagnostics', 'info');
        });

        function log(message, type = 'info') {
            if (!logContainer) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLogs() {
            if (logContainer) {
                logContainer.innerHTML = '<div class="log-entry log-info">Logs cleared</div>';
            }
        }

        function updateStatus(statusId, status, type) {
            const element = document.getElementById(statusId);
            if (element) {
                element.textContent = status;
                element.className = `badge bg-${type}`;
            }
        }

        function checkScriptLoading() {
            log('=== CHECKING SCRIPT LOADING ===', 'info');
            
            const scripts = [
                'js/app.js',
                'js/auth.js', 
                'js/koperasi.js',
                'js/keuangan.js',
                'js/transactionValidator.js',
                'js/pembayaranHutangPiutang.js'
            ];
            
            let allLoaded = true;
            
            scripts.forEach(script => {
                const scriptElements = document.querySelectorAll(`script[src="${script}"]`);
                if (scriptElements.length > 0) {
                    log(`✓ ${script} - Script tag found`, 'success');
                } else {
                    log(`✗ ${script} - Script tag NOT found`, 'error');
                    allLoaded = false;
                }
            });
            
            updateStatus('scriptStatus', allLoaded ? 'OK' : 'Issues', allLoaded ? 'success' : 'danger');
            log(`Script loading check: ${allLoaded ? 'PASSED' : 'FAILED'}`, allLoaded ? 'success' : 'error');
        }

        function checkFunctionAvailability() {
            log('=== CHECKING FUNCTION AVAILABILITY ===', 'info');
            
            const requiredFunctions = [
                'renderPembayaranHutangPiutang',
                'hitungSaldoHutang',
                'hitungSaldoPiutang',
                'updateSummaryCards',
                'renderFormPembayaran',
                'formatRupiah',
                'generateId',
                'showAlert'
            ];
            
            let allAvailable = true;
            
            requiredFunctions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    log(`✓ ${funcName} - Available`, 'success');
                } else {
                    log(`✗ ${funcName} - NOT available`, 'error');
                    allAvailable = false;
                }
            });
            
            // Check localStorage functions
            const localStorageKeys = ['currentUser', 'anggota', 'pembayaranHutangPiutang'];
            localStorageKeys.forEach(key => {
                try {
                    const data = localStorage.getItem(key);
                    log(`✓ localStorage.${key} - Accessible (${data ? 'has data' : 'empty'})`, 'success');
                } catch (error) {
                    log(`✗ localStorage.${key} - Error: ${error.message}`, 'error');
                    allAvailable = false;
                }
            });
            
            updateStatus('functionStatus', allAvailable ? 'OK' : 'Missing', allAvailable ? 'success' : 'danger');
            updateStatus('dependencyStatus', allAvailable ? 'OK' : 'Issues', allAvailable ? 'success' : 'warning');
            log(`Function availability check: ${allAvailable ? 'PASSED' : 'FAILED'}`, allAvailable ? 'success' : 'error');
        }

        function testRenderFunction() {
            log('=== TESTING RENDER FUNCTION ===', 'info');
            
            try {
                // Check if function exists
                if (typeof renderPembayaranHutangPiutang !== 'function') {
                    log('✗ renderPembayaranHutangPiutang function not found', 'error');
                    updateStatus('renderStatus', 'Function Missing', 'danger');
                    return;
                }
                
                log('✓ renderPembayaranHutangPiutang function found', 'success');
                
                // Create test container
                const testContainer = document.getElementById('testContainer');
                const originalMainContent = document.getElementById('mainContent');
                
                // Create temporary mainContent for testing
                const tempMainContent = document.createElement('div');
                tempMainContent.id = 'mainContent';
                testContainer.appendChild(tempMainContent);
                
                log('Attempting to call renderPembayaranHutangPiutang()...', 'info');
                
                // Call the function
                renderPembayaranHutangPiutang();
                
                // Check if content was rendered
                if (tempMainContent.innerHTML.trim() !== '') {
                    log('✓ Function executed successfully and rendered content', 'success');
                    log(`Content length: ${tempMainContent.innerHTML.length} characters`, 'info');
                    
                    // Check for specific elements
                    const hasTitle = tempMainContent.innerHTML.includes('Pembayaran Hutang');
                    const hasForm = tempMainContent.innerHTML.includes('formPembayaranContainer');
                    const hasTabs = tempMainContent.innerHTML.includes('nav-tabs');
                    
                    log(`✓ Has title: ${hasTitle}`, hasTitle ? 'success' : 'warning');
                    log(`✓ Has form container: ${hasForm}`, hasForm ? 'success' : 'warning');
                    log(`✓ Has tabs: ${hasTabs}`, hasTabs ? 'success' : 'warning');
                    
                    updateStatus('renderStatus', 'OK', 'success');
                } else {
                    log('✗ Function executed but no content was rendered', 'error');
                    updateStatus('renderStatus', 'No Content', 'warning');
                }
                
                // Clean up
                testContainer.removeChild(tempMainContent);
                
            } catch (error) {
                log(`✗ Error calling renderPembayaranHutangPiutang: ${error.message}`, 'error');
                log(`Stack trace: ${error.stack}`, 'error');
                updateStatus('renderStatus', 'Error', 'danger');
            }
        }

        function runFullDiagnostic() {
            log('=== STARTING FULL DIAGNOSTIC ===', 'info');
            clearLogs();
            
            setTimeout(() => {
                checkScriptLoading();
                setTimeout(() => {
                    checkFunctionAvailability();
                    setTimeout(() => {
                        testRenderFunction();
                        log('=== DIAGNOSTIC COMPLETE ===', 'info');
                    }, 500);
                }, 500);
            }, 100);
        }

        // Auto-run diagnostic on page load
        window.addEventListener('load', function() {
            setTimeout(runFullDiagnostic, 1000);
        });
    </script>
</body>
</html>