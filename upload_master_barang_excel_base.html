<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Master Barang Excel - Koperasi</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        .upload-zone {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s ease;
            background-color: #f8f9fa;
        }
        
        .upload-zone.dragover {
            border-color: #0d6efd;
            background-color: #e7f3ff;
        }
        
        .upload-zone:hover {
            border-color: #6c757d;
            background-color: #e9ecef;
        }
        
        .file-info {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }
        
        .validation-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .validation-success { background-color: #28a745; }
        .validation-warning { background-color: #ffc107; }
        .validation-error { background-color: #dc3545; }
        
        .progress-container {
            display: none;
            margin: 1rem 0;
        }
        
        .wizard-step {
            display: none;
        }
        
        .wizard-step.active {
            display: block;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
        }
        
        .step-item {
            flex: 1;
            text-align: center;
            position: relative;
        }
        
        .step-item:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 15px;
            right: -50%;
            width: 100%;
            height: 2px;
            background-color: #dee2e6;
            z-index: 1;
        }
        
        .step-item.completed::after {
            background-color: #28a745;
        }
        
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #dee2e6;
            color: #6c757d;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 2;
        }
        
        .step-item.active .step-number {
            background-color: #0d6efd;
            color: white;
        }
        
        .step-item.completed .step-number {
            background-color: #28a745;
            color: white;
        }
        
        .preview-table {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .error-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .template-download {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .category-unit-manager {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .audit-info {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Main Content -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-file-excel me-2"></i>
                            Upload Master Barang Excel
                        </h4>
                    </div>
                    
                    <div class="card-body">
                        <!-- Step Indicator -->
                        <div class="step-indicator">
                            <div class="step-item active" id="step-indicator-1">
                                <div class="step-number">1</div>
                                <div class="step-label">Upload File</div>
                            </div>
                            <div class="step-item" id="step-indicator-2">
                                <div class="step-number">2</div>
                                <div class="step-label">Preview Data</div>
                            </div>
                            <div class="step-item" id="step-indicator-3">
                                <div class="step-number">3</div>
                                <div class="step-label">Validate</div>
                            </div>
                            <div class="step-item" id="step-indicator-4">
                                <div class="step-number">4</div>
                                <div class="step-label">Import</div>
                            </div>
                        </div>

                        <!-- Step 1: Upload File -->
                        <div class="wizard-step active" id="step-1">
                            <!-- Template Download Section -->
                            <div class="template-download">
                                <h5><i class="fas fa-download me-2"></i>Download Template</h5>
                                <p class="mb-3">Download template CSV untuk memastikan format data yang benar:</p>
                                <button type="button" class="btn btn-outline-primary" id="downloadTemplateBtn">
                                    <i class="fas fa-file-csv me-2"></i>Download Template CSV
                                </button>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        Template berisi kolom: Kode, Nama, Kategori, Satuan, Harga Beli, Stok, Supplier
                                    </small>
                                </div>
                            </div>

                            <!-- Upload Zone -->
                            <div class="upload-zone" id="uploadZone">
                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                <h5>Drag & Drop File Excel atau CSV</h5>
                                <p class="text-muted mb-3">atau klik untuk memilih file</p>
                                <input type="file" id="fileInput" class="d-none" accept=".csv,.xlsx,.xls">
                                <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                                    <i class="fas fa-folder-open me-2"></i>Pilih File
                                </button>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        Format yang didukung: CSV, Excel (.xlsx, .xls) | Maksimal 5MB
                                    </small>
                                </div>
                            </div>

                            <!-- File Info -->
                            <div id="fileInfo" class="file-info" style="display: none;">
                                <h6><i class="fas fa-file me-2"></i>File Information</h6>
                                <div id="fileDetails"></div>
                            </div>

                            <!-- Progress Bar -->
                            <div class="progress-container" id="uploadProgress">
                                <label class="form-label">Upload Progress:</label>
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <div class="mt-2">
                                    <small id="progressText" class="text-muted">Preparing upload...</small>
                                </div>
                            </div>

                            <!-- Navigation -->
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-secondary" disabled>
                                    <i class="fas fa-arrow-left me-2"></i>Previous
                                </button>
                                <button type="button" class="btn btn-primary" id="nextStep1" disabled>
                                    Next<i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Step 2: Preview Data -->
                        <div class="wizard-step" id="step-2">
                            <h5><i class="fas fa-eye me-2"></i>Data Preview</h5>
                            
                            <!-- Summary Cards -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card bg-primary text-white">
                                        <div class="card-body">
                                            <h6>Total Records</h6>
                                            <h4 id="totalRecords">0</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-success text-white">
                                        <div class="card-body">
                                            <h6>Valid Records</h6>
                                            <h4 id="validRecords">0</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-warning text-white">
                                        <div class="card-body">
                                            <h6>Warnings</h6>
                                            <h4 id="warningRecords">0</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-danger text-white">
                                        <div class="card-body">
                                            <h6>Errors</h6>
                                            <h4 id="errorRecords">0</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Category and Unit Management -->
                            <div class="category-unit-manager" id="categoryUnitInfo" style="display: none;">
                                <h6><i class="fas fa-tags me-2"></i>New Categories & Units Detected</h6>
                                <div id="newCategoriesUnits"></div>
                            </div>

                            <!-- Preview Table -->
                            <div class="preview-table">
                                <table class="table table-striped table-hover" id="previewTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th width="40">#</th>
                                            <th width="40">Status</th>
                                            <th>Kode</th>
                                            <th>Nama</th>
                                            <th>Kategori</th>
                                            <th>Satuan</th>
                                            <th>Harga Beli</th>
                                            <th>Stok</th>
                                            <th>Supplier</th>
                                        </tr>
                                    </thead>
                                    <tbody id="previewTableBody">
                                        <!-- Data will be populated here -->
                                    </tbody>
                                </table>
                            </div>

                            <!-- Navigation -->
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-secondary" id="prevStep2">
                                    <i class="fas fa-arrow-left me-2"></i>Previous
                                </button>
                                <button type="button" class="btn btn-primary" id="nextStep2">
                                    Next<i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Step 3: Validate -->
                        <div class="wizard-step" id="step-3">
                            <h5><i class="fas fa-check-circle me-2"></i>Validation Results</h5>
                            
                            <!-- Validation Summary -->
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <div class="alert" id="validationSummary">
                                        <!-- Validation summary will be populated here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Error Details -->
                            <div id="errorDetails" style="display: none;">
                                <h6><i class="fas fa-exclamation-triangle me-2"></i>Validation Errors</h6>
                                <div class="error-list">
                                    <div class="list-group" id="errorList">
                                        <!-- Error details will be populated here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Warning Details -->
                            <div id="warningDetails" style="display: none;">
                                <h6><i class="fas fa-exclamation-circle me-2"></i>Warnings</h6>
                                <div class="error-list">
                                    <div class="list-group" id="warningList">
                                        <!-- Warning details will be populated here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Import Options -->
                            <div class="mt-4" id="importOptions">
                                <h6><i class="fas fa-cog me-2"></i>Import Options</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="updateExisting">
                                    <label class="form-check-label" for="updateExisting">
                                        Update existing records (if product code already exists)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="createCategories" checked>
                                    <label class="form-check-label" for="createCategories">
                                        Automatically create new categories and units
                                    </label>
                                </div>
                            </div>

                            <!-- Navigation -->
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-secondary" id="prevStep3">
                                    <i class="fas fa-arrow-left me-2"></i>Previous
                                </button>
                                <button type="button" class="btn btn-success" id="startImport" disabled>
                                    <i class="fas fa-upload me-2"></i>Start Import
                                </button>
                            </div>
                        </div>

                        <!-- Step 4: Import -->
                        <div class="wizard-step" id="step-4">
                            <h5><i class="fas fa-cogs me-2"></i>Import Progress</h5>
                            
                            <!-- Import Progress -->
                            <div class="progress-container" style="display: block;">
                                <label class="form-label">Import Progress:</label>
                                <div class="progress mb-3">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         id="importProgressBar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <small id="importProgressText" class="text-muted">Preparing import...</small>
                                    </div>
                                    <div class="col-md-6 text-end">
                                        <small id="importProgressPercent" class="text-muted">0%</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Import Results -->
                            <div id="importResults" style="display: none;">
                                <h6><i class="fas fa-chart-bar me-2"></i>Import Results</h6>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="card bg-success text-white">
                                            <div class="card-body text-center">
                                                <h4 id="createdCount">0</h4>
                                                <small>Created</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-info text-white">
                                            <div class="card-body text-center">
                                                <h4 id="updatedCount">0</h4>
                                                <small>Updated</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-danger text-white">
                                            <div class="card-body text-center">
                                                <h4 id="failedCount">0</h4>
                                                <small>Failed</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-primary text-white">
                                            <div class="card-body text-center">
                                                <h4 id="totalProcessedCount">0</h4>
                                                <small>Total</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Audit Information -->
                            <div class="audit-info">
                                <p><i class="fas fa-info-circle me-2"></i>
                                   All upload activities are logged for audit purposes. 
                                   Session ID: <span id="sessionId">-</span>
                                </p>
                            </div>

                            <!-- Navigation -->
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-secondary" id="prevStep4" disabled>
                                    <i class="fas fa-arrow-left me-2"></i>Previous
                                </button>
                                <button type="button" class="btn btn-primary" id="finishImport" style="display: none;">
                                    <i class="fas fa-check me-2"></i>Finish
                                </button>
                                <button type="button" class="btn btn-warning" id="rollbackImport" style="display: none;">
                                    <i class="fas fa-undo me-2"></i>Rollback
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Upload Excel Components -->
    <script src="js/upload-excel/types.js"></script>
    <script src="js/upload-excel/ValidationEngine.js"></script>
    <script src="js/upload-excel/DataProcessor.js"></script>
    <script src="js/upload-excel/CategoryUnitManager.js"></script>
    <script src="js/upload-excel/AuditLogger.js"></script>
    <script src="js/upload-excel/ExcelUploadManager.js"></script>
    
    <script>
        // Global variables
        let uploadManager;
        let currentSession = null;
        let currentStep = 1;
        
        // Initialize the upload system
        document.addEventListener('DOMContentLoaded', function() {
            initializeUploadSystem();
            setupEventListeners();
        });
        
        /**
         * Initialize the upload system with all components
         */
        function initializeUploadSystem() {
            try {
                // Create component instances
                const validator = new ValidationEngine();
                const processor = new DataProcessor();
                const categoryManager = new CategoryUnitManager();
                const auditLogger = new AuditLogger();
                
                // Create upload manager and inject dependencies
                uploadManager = new ExcelUploadManager();
                uploadManager.setComponents({
                    validator,
                    processor,
                    categoryManager,
                    auditLogger
                });
                
                console.log('Upload system initialized successfully');
                
            } catch (error) {
                console.error('Error initializing upload system:', error);
                showAlert('Error initializing upload system: ' + error.message, 'danger');
            }
        }
        
        /**
         * Setup all event listeners
         */
        function setupEventListeners() {
            // File input and drag & drop
            const fileInput = document.getElementById('fileInput');
            const uploadZone = document.getElementById('uploadZone');
            
            fileInput.addEventListener('change', handleFileSelect);
            
            // Drag & drop events
            uploadZone.addEventListener('dragover', handleDragOver);
            uploadZone.addEventListener('dragleave', handleDragLeave);
            uploadZone.addEventListener('drop', handleFileDrop);
            
            // Navigation buttons
            document.getElementById('nextStep1').addEventListener('click', () => goToStep(2));
            document.getElementById('prevStep2').addEventListener('click', () => goToStep(1));
            document.getElementById('nextStep2').addEventListener('click', () => goToStep(3));
            document.getElementById('prevStep3').addEventListener('click', () => goToStep(2));
            document.getElementById('startImport').addEventListener('click', startImport);
            document.getElementById('finishImport').addEventListener('click', () => location.reload());
            document.getElementById('rollbackImport').addEventListener('click', rollbackImport);
            
            // Template download
            document.getElementById('downloadTemplateBtn').addEventListener('click', downloadTemplate);
        }
        
        /**
         * Handle file selection
         */
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }
        
        /**
         * Handle drag over event
         */
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }
        
        /**
         * Handle drag leave event
         */
        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }
        
        /**
         * Handle file drop
         */
        function handleFileDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }
        
        /**
         * Process uploaded file
         */
        async function processFile(file) {
            try {
                showProgress('uploadProgress', 'Processing file...', 10);
                
                // Display file info
                displayFileInfo(file);
                
                // Upload and validate file
                currentSession = await uploadManager.uploadFile(file);
                
                showProgress('uploadProgress', 'File processed successfully!', 100);
                
                // Enable next button
                document.getElementById('nextStep1').disabled = false;
                
                setTimeout(() => {
                    hideProgress('uploadProgress');
                }, 1000);
                
            } catch (error) {
                console.error('Error processing file:', error);
                showAlert('Error processing file: ' + error.message, 'danger');
                hideProgress('uploadProgress');
            }
        }
        
        /**
         * Display file information
         */
        function displayFileInfo(file) {
            const fileInfo = document.getElementById('fileInfo');
            const fileDetails = document.getElementById('fileDetails');
            
            const sizeInMB = (file.size / 1024 / 1024).toFixed(2);
            
            fileDetails.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <strong>File Name:</strong> ${file.name}
                    </div>
                    <div class="col-md-6">
                        <strong>File Size:</strong> ${sizeInMB} MB
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6">
                        <strong>File Type:</strong> ${file.type || 'Unknown'}
                    </div>
                    <div class="col-md-6">
                        <strong>Last Modified:</strong> ${new Date(file.lastModified).toLocaleString()}
                    </div>
                </div>
            `;
            
            fileInfo.style.display = 'block';
        }
        
        /**
         * Navigate to specific step
         */
        async function goToStep(step) {
            try {
                // Hide current step
                document.querySelector('.wizard-step.active').classList.remove('active');
                
                // Show target step
                document.getElementById(`step-${step}`).classList.add('active');
                
                // Update step indicators
                updateStepIndicators(step);
                
                // Load step-specific data
                if (step === 2) {
                    await loadPreviewData();
                } else if (step === 3) {
                    await loadValidationResults();
                }
                
                currentStep = step;
                
            } catch (error) {
                console.error('Error navigating to step:', error);
                showAlert('Error loading step: ' + error.message, 'danger');
            }
        }
        
        /**
         * Update step indicators
         */
        function updateStepIndicators(currentStep) {
            for (let i = 1; i <= 4; i++) {
                const indicator = document.getElementById(`step-indicator-${i}`);
                indicator.classList.remove('active', 'completed');
                
                if (i < currentStep) {
                    indicator.classList.add('completed');
                } else if (i === currentStep) {
                    indicator.classList.add('active');
                }
            }
        }
        
        /**
         * Load preview data for step 2
         */
        async function loadPreviewData() {
            if (!currentSession) return;
            
            try {
                const previewData = await uploadManager.previewData(currentSession.id);
                
                // Update summary cards
                document.getElementById('totalRecords').textContent = previewData.summary.totalRows;
                document.getElementById('validRecords').textContent = previewData.summary.validRows;
                document.getElementById('warningRecords').textContent = previewData.summary.warningRows;
                document.getElementById('errorRecords').textContent = previewData.summary.errorRows;
                
                // Populate preview table
                populatePreviewTable(previewData.data);
                
                // Show category/unit info if needed
                await showCategoryUnitInfo(previewData.data);
                
            } catch (error) {
                console.error('Error loading preview data:', error);
                showAlert('Error loading preview: ' + error.message, 'danger');
            }
        }
        
        /**
         * Populate preview table
         */
        function populatePreviewTable(data) {
            const tbody = document.getElementById('previewTableBody');
            tbody.innerHTML = '';
            
            data.slice(0, 50).forEach((row, index) => { // Show first 50 rows
                const tr = document.createElement('tr');
                
                // Status indicator
                let statusClass = 'validation-success';
                if (row._hasErrors) statusClass = 'validation-error';
                else if (row._hasWarnings) statusClass = 'validation-warning';
                
                tr.innerHTML = `
                    <td>${row._rowNumber}</td>
                    <td><span class="validation-indicator ${statusClass}"></span></td>
                    <td>${row.kode || ''}</td>
                    <td>${row.nama || ''}</td>
                    <td>${row.kategori || ''}</td>
                    <td>${row.satuan || ''}</td>
                    <td>${row.harga_beli || ''}</td>
                    <td>${row.stok || ''}</td>
                    <td>${row.supplier || ''}</td>
                `;
                
                // Add click handler for error details
                if (row._hasErrors || row._hasWarnings) {
                    tr.style.cursor = 'pointer';
                    tr.addEventListener('click', () => showRowDetails(row));
                }
                
                tbody.appendChild(tr);
            });
            
            if (data.length > 50) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td colspan="9" class="text-center text-muted">
                        ... and ${data.length - 50} more rows
                    </td>
                `;
                tbody.appendChild(tr);
            }
        }
        
        /**
         * Show category and unit information
         */
        async function showCategoryUnitInfo(data) {
            // This would be implemented to show new categories/units
            // For now, just hide the section
            document.getElementById('categoryUnitInfo').style.display = 'none';
        }
        
        /**
         * Load validation results for step 3
         */
        async function loadValidationResults() {
            if (!currentSession) return;
            
            const errors = currentSession.validationResults.errors;
            const warnings = currentSession.validationResults.warnings;
            
            // Update validation summary
            const summaryDiv = document.getElementById('validationSummary');
            const hasErrors = errors.some(e => e.severity === 'error');
            
            if (hasErrors) {
                summaryDiv.className = 'alert alert-danger';
                summaryDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Validation Failed:</strong> ${errors.length} errors found. 
                    Please fix the errors before proceeding with import.
                `;
                document.getElementById('startImport').disabled = true;
            } else {
                summaryDiv.className = 'alert alert-success';
                summaryDiv.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Validation Passed:</strong> Data is ready for import. 
                    ${warnings.length > 0 ? `${warnings.length} warnings found.` : ''}
                `;
                document.getElementById('startImport').disabled = false;
            }
            
            // Show error details
            if (errors.length > 0) {
                showErrorDetails(errors);
            }
            
            // Show warning details
            if (warnings.length > 0) {
                showWarningDetails(warnings);
            }
        }
        
        /**
         * Show error details
         */
        function showErrorDetails(errors) {
            const errorDetails = document.getElementById('errorDetails');
            const errorList = document.getElementById('errorList');
            
            errorList.innerHTML = '';
            
            errors.forEach(error => {
                const item = document.createElement('div');
                item.className = 'list-group-item list-group-item-danger';
                item.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">Row ${error.row}: ${error.field}</h6>
                        <small>${error.code}</small>
                    </div>
                    <p class="mb-1">${error.message}</p>
                `;
                errorList.appendChild(item);
            });
            
            errorDetails.style.display = 'block';
        }
        
        /**
         * Show warning details
         */
        function showWarningDetails(warnings) {
            const warningDetails = document.getElementById('warningDetails');
            const warningList = document.getElementById('warningList');
            
            warningList.innerHTML = '';
            
            warnings.forEach(warning => {
                const item = document.createElement('div');
                item.className = 'list-group-item list-group-item-warning';
                item.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">Row ${warning.row}: ${warning.field}</h6>
                        <small>${warning.code}</small>
                    </div>
                    <p class="mb-1">${warning.message}</p>
                `;
                warningList.appendChild(item);
            });
            
            warningDetails.style.display = 'block';
        }
        
        /**
         * Start import process
         */
        async function startImport() {
            if (!currentSession) return;
            
            try {
                // Go to step 4
                await goToStep(4);
                
                // Get import options
                const updateExisting = document.getElementById('updateExisting').checked;
                
                // Set session ID
                document.getElementById('sessionId').textContent = currentSession.id;
                
                // Start import with progress tracking
                const results = await uploadManager.importData(currentSession.id, {
                    updateExisting,
                    onProgress: updateImportProgress
                });
                
                // Show results
                showImportResults(results);
                
            } catch (error) {
                console.error('Error during import:', error);
                showAlert('Import failed: ' + error.message, 'danger');
            }
        }
        
        /**
         * Update import progress
         */
        function updateImportProgress(progress) {
            const progressBar = document.getElementById('importProgressBar');
            const progressText = document.getElementById('importProgressText');
            const progressPercent = document.getElementById('importProgressPercent');
            
            progressBar.style.width = progress.current + '%';
            progressText.textContent = progress.status;
            progressPercent.textContent = progress.current + '%';
        }
        
        /**
         * Show import results
         */
        function showImportResults(results) {
            // Hide progress bar
            document.querySelector('#step-4 .progress-container').style.display = 'none';
            
            // Show results
            document.getElementById('importResults').style.display = 'block';
            
            // Update result cards
            document.getElementById('createdCount').textContent = results.created;
            document.getElementById('updatedCount').textContent = results.updated;
            document.getElementById('failedCount').textContent = results.failed;
            document.getElementById('totalProcessedCount').textContent = results.totalProcessed;
            
            // Show action buttons
            document.getElementById('finishImport').style.display = 'inline-block';
            if (results.created > 0 || results.updated > 0) {
                document.getElementById('rollbackImport').style.display = 'inline-block';
            }
        }
        
        /**
         * Rollback import
         */
        async function rollbackImport() {
            if (!currentSession) return;
            
            if (!confirm('Are you sure you want to rollback this import? This will undo all changes made.')) {
                return;
            }
            
            try {
                await uploadManager.rollbackImport(currentSession.id);
                showAlert('Import rolled back successfully', 'success');
                
                // Hide rollback button
                document.getElementById('rollbackImport').style.display = 'none';
                
            } catch (error) {
                console.error('Error during rollback:', error);
                showAlert('Rollback failed: ' + error.message, 'danger');
            }
        }
        
        /**
         * Download CSV template
         */
        function downloadTemplate() {
            const headers = ['kode', 'nama', 'kategori', 'satuan', 'harga_beli', 'stok', 'supplier'];
            const sampleData = [
                ['BRG001', 'Beras Premium', 'makanan', 'kg', '15000', '100', 'PT Beras Jaya'],
                ['BRG002', 'Minyak Goreng', 'makanan', 'liter', '18000', '50', 'PT Minyak Sehat'],
                ['BRG003', 'Gula Pasir', 'makanan', 'kg', '12000', '75', 'PT Gula Manis']
            ];
            
            let csvContent = headers.join(',') + '\n';
            sampleData.forEach(row => {
                csvContent += row.join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'template_master_barang.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        /**
         * Show progress indicator
         */
        function showProgress(containerId, message, percent) {
            const container = document.getElementById(containerId);
            const progressBar = container.querySelector('.progress-bar');
            const progressText = container.querySelector('small');
            
            container.style.display = 'block';
            progressBar.style.width = percent + '%';
            progressText.textContent = message;
        }
        
        /**
         * Hide progress indicator
         */
        function hideProgress(containerId) {
            document.getElementById(containerId).style.display = 'none';
        }
        
        /**
         * Show alert message
         */
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Insert at top of card body
            const cardBody = document.querySelector('.card-body');
            cardBody.insertBefore(alertDiv, cardBody.firstChild);
            
            // Auto dismiss after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        /**
         * Show row details in modal (placeholder)
         */
        function showRowDetails(row) {
            const errors = row._errors || [];
            const warnings = row._warnings || [];
            
            let message = `Row ${row._rowNumber} details:\n\n`;
            
            if (errors.length > 0) {
                message += 'Errors:\n';
                errors.forEach(error => {
                    message += `- ${error.field}: ${error.message}\n`;
                });
            }
            
            if (warnings.length > 0) {
                message += '\nWarnings:\n';
                warnings.forEach(warning => {
                    message += `- ${warning.field}: ${warning.message}\n`;
                });
            }
            
            alert(message);
        }
    </script>
</body>
</html>