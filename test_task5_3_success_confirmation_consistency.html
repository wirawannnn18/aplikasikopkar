<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Task 5.3 - Success Confirmation Consistency Property Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>Test Task 5.3 - Success Confirmation Consistency Property Test</h2>
        <p class="text-muted">Testing Property 9: Success confirmation consistency for balance sheet export and print operations</p>
        
        <!-- Test Results -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-check-circle me-2"></i>
                            Success Confirmation Consistency Tests
                        </h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary me-2" onclick="testPDFConfirmation()">Test PDF Export Confirmation</button>
                        <button class="btn btn-success me-2" onclick="testExcelConfirmation()">Test Excel Export Confirmation</button>
                        <button class="btn btn-info me-2" onclick="testPrintConfirmation()">Test Print Confirmation</button>
                        <button class="btn btn-warning me-2" onclick="testConfirmationFormat()">Test Confirmation Format</button>
                        <button class="btn btn-danger" onclick="runAllTests()">Run All Tests</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Results Display -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Test Results</h6>
                    </div>
                    <div class="card-body">
                        <div id="testResults"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Success Confirmation Demo -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Success Confirmation Demo</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <button class="btn btn-outline-danger w-100 mb-2" onclick="demoExportPDF()">
                                    <i class="bi bi-file-pdf me-2"></i>Demo PDF Export
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-outline-success w-100 mb-2" onclick="demoExportExcel()">
                                    <i class="bi bi-file-excel me-2"></i>Demo Excel Export
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-outline-primary w-100 mb-2" onclick="demoPrint()">
                                    <i class="bi bi-printer me-2"></i>Demo Print
                                </button>
                            </div>
                        </div>
                        <div id="confirmationDemo" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alert Display Area -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div id="alertArea"></div>
            </div>
        </div>
    </div>

    <script>
        // Mock alert tracking
        let alertCalls = [];
        
        // Override showAlert to capture calls
        function showAlert(message, type) {
            alertCalls.push({ 
                message, 
                type, 
                timestamp: new Date() 
            });
            
            // Display alert in UI
            displayAlert(message, type);
        }

        // Display alert in UI
        function displayAlert(message, type) {
            const alertArea = document.getElementById('alertArea');
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'error' ? 'alert-danger' : 
                              type === 'warning' ? 'alert-warning' : 'alert-info';
            
            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            alertArea.innerHTML = alertHtml + alertArea.innerHTML;
        }

        // Clear alert calls
        function clearAlertCalls() {
            alertCalls = [];
        }

        // Helper function to format currency
        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Helper function to format period text
        function formatPeriodText(periodInfo) {
            if (!periodInfo) return 'Periode tidak diketahui';
            
            const endDate = periodInfo.endDate;
            
            switch (periodInfo.type) {
                case 'daily':
                    return `Laporan Harian - ${endDate.toLocaleDateString('id-ID')}`;
                case 'monthly':
                    return `Laporan Bulanan - ${endDate.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' })}`;
                case 'yearly':
                    return `Laporan Tahunan - ${endDate.getFullYear()}`;
                default:
                    return 'Periode tidak diketahui';
            }
        }

        // Generate Excel filename
        function generateExcelFilename(balanceSheetData) {
            const date = balanceSheetData.reportDate;
            const dateStr = date.getFullYear() + 
                            String(date.getMonth() + 1).padStart(2, '0') + 
                            String(date.getDate()).padStart(2, '0');
            
            const periodType = balanceSheetData.periodInfo.type;
            return `neraca_${periodType}_${dateStr}.csv`;
        }

        // Generate sample balance sheet data
        function generateSampleBalanceSheetData() {
            return {
                reportDate: new Date(),
                periodInfo: {
                    type: 'monthly',
                    endDate: new Date()
                },
                assets: {
                    totalAssets: 65000000
                },
                liabilities: {
                    totalLiabilities: 38000000
                },
                equity: {
                    totalEquityAndRetainedEarnings: 27000000
                },
                totals: {
                    totalAssets: 65000000,
                    totalLiabilitiesAndEquity: 65000000,
                    balanceSheetBalanced: true
                }
            };
        }

        // Mock export functions (from actual implementation)
        function mockExportBalanceSheetPDF(balanceSheetData) {
            try {
                const periodText = formatPeriodText(balanceSheetData.periodInfo);
                
                // Show success confirmation (this is what we're testing)
                showAlert(`✓ PDF berhasil disiapkan untuk download! (${periodText})`, 'success');
                
                return {
                    success: true,
                    operation: 'PDF Export',
                    periodText: periodText,
                    timestamp: new Date()
                };
                
            } catch (error) {
                showAlert('Gagal membuat PDF: ' + error.message, 'error');
                return {
                    success: false,
                    operation: 'PDF Export',
                    error: error.message
                };
            }
        }

        function mockExportBalanceSheetExcel(balanceSheetData) {
            try {
                const filename = generateExcelFilename(balanceSheetData);
                const periodText = formatPeriodText(balanceSheetData.periodInfo);
                
                // Show success confirmation (this is what we're testing)
                showAlert(`✓ Excel berhasil di-download: ${filename} (${periodText})`, 'success');
                
                return {
                    success: true,
                    operation: 'Excel Export',
                    filename: filename,
                    periodText: periodText,
                    timestamp: new Date()
                };
                
            } catch (error) {
                showAlert('Gagal membuat Excel: ' + error.message, 'error');
                return {
                    success: false,
                    operation: 'Excel Export',
                    error: error.message
                };
            }
        }

        function mockPrintBalanceSheet(balanceSheetData) {
            try {
                const periodText = formatPeriodText(balanceSheetData.periodInfo);
                
                // Show success confirmation (this is what we're testing)
                showAlert(`✓ Dialog print berhasil dibuka! (${periodText})`, 'success');
                
                return {
                    success: true,
                    operation: 'Print',
                    periodText: periodText,
                    timestamp: new Date()
                };
                
            } catch (error) {
                showAlert('Gagal membuka dialog print: ' + error.message, 'error');
                return {
                    success: false,
                    operation: 'Print',
                    error: error.message
                };
            }
        }

        // Test functions
        function addTestResult(testName, passed, details) {
            const resultsDiv = document.getElementById('testResults');
            const alertClass = passed ? 'alert-success' : 'alert-danger';
            const icon = passed ? 'bi-check-circle-fill' : 'bi-x-circle-fill';
            
            resultsDiv.innerHTML += `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    <i class="bi ${icon} me-2"></i>
                    <strong>${testName}:</strong> ${details}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        function clearTestResults() {
            document.getElementById('testResults').innerHTML = '';
        }

        // Test 1: PDF Export Confirmation
        function testPDFConfirmation() {
            clearTestResults();
            clearAlertCalls();
            
            try {
                const sampleData = generateSampleBalanceSheetData();
                const result = mockExportBalanceSheetPDF(sampleData);
                
                // Check success confirmation
                const successAlerts = alertCalls.filter(call => call.type === 'success');
                const hasSuccessAlert = successAlerts.length === 1;
                addTestResult('PDF Success Alert Count', hasSuccessAlert, 
                    hasSuccessAlert ? 'Exactly one success alert shown' : `Found ${successAlerts.length} success alerts`);
                
                if (hasSuccessAlert) {
                    const alert = successAlerts[0];
                    
                    // Check message format
                    const hasCheckmark = alert.message.includes('✓');
                    addTestResult('PDF Checkmark Indicator', hasCheckmark, 
                        hasCheckmark ? 'Success indicator found' : 'Missing success indicator');
                    
                    const hasPDFText = alert.message.includes('PDF');
                    addTestResult('PDF Operation Type', hasPDFText, 
                        hasPDFText ? 'PDF operation type found' : 'Missing PDF operation type');
                    
                    const hasSuccessVerb = alert.message.includes('berhasil');
                    addTestResult('PDF Success Verb', hasSuccessVerb, 
                        hasSuccessVerb ? 'Success verb found' : 'Missing success verb');
                    
                    const hasPeriodInfo = alert.message.includes(result.periodText);
                    addTestResult('PDF Period Information', hasPeriodInfo, 
                        hasPeriodInfo ? 'Period information found' : 'Missing period information');
                }
                
            } catch (error) {
                addTestResult('PDF Export Confirmation', false, `Error: ${error.message}`);
            }
        }

        // Test 2: Excel Export Confirmation
        function testExcelConfirmation() {
            clearAlertCalls();
            
            try {
                const sampleData = generateSampleBalanceSheetData();
                const result = mockExportBalanceSheetExcel(sampleData);
                
                // Check success confirmation
                const successAlerts = alertCalls.filter(call => call.type === 'success');
                const hasSuccessAlert = successAlerts.length === 1;
                addTestResult('Excel Success Alert Count', hasSuccessAlert, 
                    hasSuccessAlert ? 'Exactly one success alert shown' : `Found ${successAlerts.length} success alerts`);
                
                if (hasSuccessAlert) {
                    const alert = successAlerts[0];
                    
                    // Check message format
                    const hasCheckmark = alert.message.includes('✓');
                    addTestResult('Excel Checkmark Indicator', hasCheckmark, 
                        hasCheckmark ? 'Success indicator found' : 'Missing success indicator');
                    
                    const hasExcelText = alert.message.includes('Excel');
                    addTestResult('Excel Operation Type', hasExcelText, 
                        hasExcelText ? 'Excel operation type found' : 'Missing Excel operation type');
                    
                    const hasFilename = alert.message.includes(result.filename);
                    addTestResult('Excel Filename', hasFilename, 
                        hasFilename ? 'Filename found in message' : 'Missing filename');
                    
                    const hasPeriodInfo = alert.message.includes(result.periodText);
                    addTestResult('Excel Period Information', hasPeriodInfo, 
                        hasPeriodInfo ? 'Period information found' : 'Missing period information');
                }
                
            } catch (error) {
                addTestResult('Excel Export Confirmation', false, `Error: ${error.message}`);
            }
        }

        // Test 3: Print Confirmation
        function testPrintConfirmation() {
            clearAlertCalls();
            
            try {
                const sampleData = generateSampleBalanceSheetData();
                const result = mockPrintBalanceSheet(sampleData);
                
                // Check success confirmation
                const successAlerts = alertCalls.filter(call => call.type === 'success');
                const hasSuccessAlert = successAlerts.length === 1;
                addTestResult('Print Success Alert Count', hasSuccessAlert, 
                    hasSuccessAlert ? 'Exactly one success alert shown' : `Found ${successAlerts.length} success alerts`);
                
                if (hasSuccessAlert) {
                    const alert = successAlerts[0];
                    
                    // Check message format
                    const hasCheckmark = alert.message.includes('✓');
                    addTestResult('Print Checkmark Indicator', hasCheckmark, 
                        hasCheckmark ? 'Success indicator found' : 'Missing success indicator');
                    
                    const hasPrintText = alert.message.includes('print');
                    addTestResult('Print Operation Type', hasPrintText, 
                        hasPrintText ? 'Print operation type found' : 'Missing print operation type');
                    
                    const hasSuccessVerb = alert.message.includes('berhasil');
                    addTestResult('Print Success Verb', hasSuccessVerb, 
                        hasSuccessVerb ? 'Success verb found' : 'Missing success verb');
                    
                    const hasPeriodInfo = alert.message.includes(result.periodText);
                    addTestResult('Print Period Information', hasPeriodInfo, 
                        hasPeriodInfo ? 'Period information found' : 'Missing period information');
                }
                
            } catch (error) {
                addTestResult('Print Confirmation', false, `Error: ${error.message}`);
            }
        }

        // Test 4: Confirmation Format Consistency
        function testConfirmationFormat() {
            clearAlertCalls();
            
            try {
                const sampleData = generateSampleBalanceSheetData();
                
                // Test all operations
                const pdfResult = mockExportBalanceSheetPDF(sampleData);
                const excelResult = mockExportBalanceSheetExcel(sampleData);
                const printResult = mockPrintBalanceSheet(sampleData);
                
                const successAlerts = alertCalls.filter(call => call.type === 'success');
                
                // Should have 3 success alerts
                const correctCount = successAlerts.length === 3;
                addTestResult('Total Success Alerts', correctCount, 
                    correctCount ? 'All 3 operations showed success alerts' : `Found ${successAlerts.length} success alerts`);
                
                // All should start with checkmark
                const allHaveCheckmark = successAlerts.every(alert => alert.message.startsWith('✓'));
                addTestResult('Consistent Checkmark Format', allHaveCheckmark, 
                    allHaveCheckmark ? 'All messages start with checkmark' : 'Inconsistent checkmark usage');
                
                // All should contain "berhasil"
                const allHaveSuccessVerb = successAlerts.every(alert => alert.message.includes('berhasil'));
                addTestResult('Consistent Success Verb', allHaveSuccessVerb, 
                    allHaveSuccessVerb ? 'All messages contain success verb' : 'Inconsistent success verb usage');
                
                // All should have period info in parentheses
                const allHavePeriodInfo = successAlerts.every(alert => /\([^)]*\)/.test(alert.message));
                addTestResult('Consistent Period Format', allHavePeriodInfo, 
                    allHavePeriodInfo ? 'All messages have period info in parentheses' : 'Inconsistent period format');
                
                // Message lengths should be reasonable
                const reasonableLengths = successAlerts.every(alert => 
                    alert.message.length > 10 && alert.message.length < 200
                );
                addTestResult('Reasonable Message Lengths', reasonableLengths, 
                    reasonableLengths ? 'All messages have reasonable length' : 'Some messages too short or long');
                
            } catch (error) {
                addTestResult('Confirmation Format Consistency', false, `Error: ${error.message}`);
            }
        }

        // Demo functions
        function demoExportPDF() {
            const sampleData = generateSampleBalanceSheetData();
            const result = mockExportBalanceSheetPDF(sampleData);
            updateDemo('PDF Export', result);
        }

        function demoExportExcel() {
            const sampleData = generateSampleBalanceSheetData();
            const result = mockExportBalanceSheetExcel(sampleData);
            updateDemo('Excel Export', result);
        }

        function demoPrint() {
            const sampleData = generateSampleBalanceSheetData();
            const result = mockPrintBalanceSheet(sampleData);
            updateDemo('Print', result);
        }

        function updateDemo(operation, result) {
            const demoDiv = document.getElementById('confirmationDemo');
            const statusClass = result.success ? 'text-success' : 'text-danger';
            const icon = result.success ? 'bi-check-circle' : 'bi-x-circle';
            
            demoDiv.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="bi ${icon} me-2 ${statusClass}"></i>
                            ${operation} Demo Result
                        </h6>
                        <p class="card-text">
                            <strong>Status:</strong> <span class="${statusClass}">${result.success ? 'Success' : 'Failed'}</span><br>
                            <strong>Operation:</strong> ${result.operation}<br>
                            <strong>Timestamp:</strong> ${result.timestamp.toLocaleString('id-ID')}<br>
                            ${result.filename ? `<strong>Filename:</strong> ${result.filename}<br>` : ''}
                            ${result.periodText ? `<strong>Period:</strong> ${result.periodText}<br>` : ''}
                            ${result.error ? `<strong>Error:</strong> ${result.error}` : ''}
                        </p>
                    </div>
                </div>
            `;
        }

        // Run all tests
        async function runAllTests() {
            clearTestResults();
            
            addTestResult('Starting Tests', true, 'Running all success confirmation consistency tests...');
            
            testPDFConfirmation();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testExcelConfirmation();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testPrintConfirmation();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testConfirmationFormat();
            
            addTestResult('All Tests Complete', true, 'All success confirmation consistency tests completed');
        }
    </script>
</body>
</html>