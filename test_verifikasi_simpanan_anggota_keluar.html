<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verifikasi - Filter Simpanan Anggota Keluar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .test-section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .test-pass { background-color: #d4edda; border-color: #c3e6cb; }
        .test-fail { background-color: #f8d7da; border-color: #f5c6cb; }
        .test-warning { background-color: #fff3cd; border-color: #ffeaa7; }
        pre { background: #f5f5f5; padding: 15px; border-radius: 5px; font-size: 0.9rem; }
        .badge-large { font-size: 1.2rem; padding: 10px 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="mb-4">âœ… Verifikasi - Filter Simpanan Anggota Keluar</h2>
        
        <div class="alert alert-info">
            <strong>Tujuan Test:</strong> Memverifikasi bahwa anggota keluar TIDAK muncul di menu simpanan
        </div>
        
        <div id="testResults"></div>
        
        <div class="mt-4">
            <button class="btn btn-primary" onclick="runTests()">ðŸ”„ Run Tests</button>
            <button class="btn btn-secondary" onclick="showRawData()">ðŸ“Š Show Raw Data</button>
        </div>
        
        <div id="rawDataSection" style="display: none;" class="mt-4">
            <h4>Raw Data</h4>
            <div id="rawData"></div>
        </div>
    </div>

    <script>
        function runTests() {
            const anggota = JSON.parse(localStorage.getItem('anggota') || '[]');
            const simpananPokok = JSON.parse(localStorage.getItem('simpananPokok') || '[]');
            const simpananWajib = JSON.parse(localStorage.getItem('simpananWajib') || '[]');
            const simpananSukarela = JSON.parse(localStorage.getItem('simpananSukarela') || '[]');
            
            let html = '';
            let allTestsPassed = true;
            
            // Test 1: Check if there are anggota keluar
            const anggotaKeluar = anggota.filter(a => a.statusKeanggotaan === 'Keluar');
            const anggotaKeluarIds = anggotaKeluar.map(a => a.id);
            
            html += `<div class="test-section ${anggotaKeluar.length > 0 ? 'test-pass' : 'test-warning'}">`;
            html += `<h4>Test 1: Data Anggota Keluar</h4>`;
            if (anggotaKeluar.length > 0) {
                html += `<p><span class="badge bg-success badge-large">âœ“ FOUND</span></p>`;
                html += `<p>Ditemukan <strong>${anggotaKeluar.length}</strong> anggota dengan status "Keluar":</p>`;
                html += '<ul>';
                anggotaKeluar.forEach(a => {
                    html += `<li>${a.nama} (${a.nik}) - Status Pengembalian: ${a.pengembalianStatus || 'Pending'}</li>`;
                });
                html += '</ul>';
            } else {
                html += `<p><span class="badge bg-warning badge-large">âš  NO DATA</span></p>`;
                html += `<p>Tidak ada anggota dengan status "Keluar". Test tidak dapat dilanjutkan.</p>`;
            }
            html += `</div>`;
            
            if (anggotaKeluar.length === 0) {
                document.getElementById('testResults').innerHTML = html;
                return;
            }
            
            // Test 2: Check Simpanan Pokok - Should NOT show anggota keluar
            const simpananPokokKeluar = simpananPokok.filter(s => {
                const ang = anggota.find(a => a.id === s.anggotaId);
                // Simulate the filter logic in renderSimpananPokok
                return s.jumlah > 0 && ang && ang.statusKeanggotaan !== 'Keluar';
            }).filter(s => anggotaKeluarIds.includes(s.anggotaId));
            
            const testPokokPass = simpananPokokKeluar.length === 0;
            if (!testPokokPass) allTestsPassed = false;
            
            html += `<div class="test-section ${testPokokPass ? 'test-pass' : 'test-fail'}">`;
            html += `<h4>Test 2: Filter Simpanan Pokok</h4>`;
            if (testPokokPass) {
                html += `<p><span class="badge bg-success badge-large">âœ“ PASS</span></p>`;
                html += `<p><strong>Sempurna!</strong> Tidak ada anggota keluar yang muncul di simpanan pokok.</p>`;
            } else {
                html += `<p><span class="badge bg-danger badge-large">âœ— FAIL</span></p>`;
                html += `<p><strong>Error!</strong> Ditemukan ${simpananPokokKeluar.length} record anggota keluar di simpanan pokok:</p>`;
                html += '<ul>';
                simpananPokokKeluar.forEach(s => {
                    const ang = anggota.find(a => a.id === s.anggotaId);
                    html += `<li>${ang?.nama} - Rp ${s.jumlah.toLocaleString('id-ID')}</li>`;
                });
                html += '</ul>';
            }
            
            // Show total records that WOULD be displayed
            const totalPokokDisplayed = simpananPokok.filter(s => {
                const ang = anggota.find(a => a.id === s.anggotaId);
                return s.jumlah > 0 && ang && ang.statusKeanggotaan !== 'Keluar';
            }).length;
            html += `<p class="mt-2"><small>Total record yang ditampilkan: ${totalPokokDisplayed}</small></p>`;
            html += `</div>`;
            
            // Test 3: Check Simpanan Wajib - Should NOT show anggota keluar
            const simpananWajibKeluar = simpananWajib.filter(s => {
                const ang = anggota.find(a => a.id === s.anggotaId);
                return s.jumlah > 0 && ang && ang.statusKeanggotaan !== 'Keluar';
            }).filter(s => anggotaKeluarIds.includes(s.anggotaId));
            
            const testWajibPass = simpananWajibKeluar.length === 0;
            if (!testWajibPass) allTestsPassed = false;
            
            html += `<div class="test-section ${testWajibPass ? 'test-pass' : 'test-fail'}">`;
            html += `<h4>Test 3: Filter Simpanan Wajib</h4>`;
            if (testWajibPass) {
                html += `<p><span class="badge bg-success badge-large">âœ“ PASS</span></p>`;
                html += `<p><strong>Sempurna!</strong> Tidak ada anggota keluar yang muncul di simpanan wajib.</p>`;
            } else {
                html += `<p><span class="badge bg-danger badge-large">âœ— FAIL</span></p>`;
                html += `<p><strong>Error!</strong> Ditemukan ${simpananWajibKeluar.length} record anggota keluar di simpanan wajib:</p>`;
                html += '<ul>';
                simpananWajibKeluar.forEach(s => {
                    const ang = anggota.find(a => a.id === s.anggotaId);
                    html += `<li>${ang?.nama} - Rp ${s.jumlah.toLocaleString('id-ID')} (${s.periode})</li>`;
                });
                html += '</ul>';
            }
            
            const totalWajibDisplayed = simpananWajib.filter(s => {
                const ang = anggota.find(a => a.id === s.anggotaId);
                return s.jumlah > 0 && ang && ang.statusKeanggotaan !== 'Keluar';
            }).length;
            html += `<p class="mt-2"><small>Total record yang ditampilkan: ${totalWajibDisplayed}</small></p>`;
            html += `</div>`;
            
            // Test 4: Check Simpanan Sukarela - Should NOT show anggota keluar
            const simpananSukarelaKeluar = simpananSukarela.filter(s => {
                const ang = anggota.find(a => a.id === s.anggotaId);
                return s.jumlah > 0 && ang && ang.statusKeanggotaan !== 'Keluar';
            }).filter(s => anggotaKeluarIds.includes(s.anggotaId));
            
            const testSukarelaPass = simpananSukarelaKeluar.length === 0;
            if (!testSukarelaPass) allTestsPassed = false;
            
            html += `<div class="test-section ${testSukarelaPass ? 'test-pass' : 'test-fail'}">`;
            html += `<h4>Test 4: Filter Simpanan Sukarela</h4>`;
            if (testSukarelaPass) {
                html += `<p><span class="badge bg-success badge-large">âœ“ PASS</span></p>`;
                html += `<p><strong>Sempurna!</strong> Tidak ada anggota keluar yang muncul di simpanan sukarela.</p>`;
            } else {
                html += `<p><span class="badge bg-danger badge-large">âœ— FAIL</span></p>`;
                html += `<p><strong>Error!</strong> Ditemukan ${simpananSukarelaKeluar.length} record anggota keluar di simpanan sukarela:</p>`;
                html += '<ul>';
                simpananSukarelaKeluar.forEach(s => {
                    const ang = anggota.find(a => a.id === s.anggotaId);
                    html += `<li>${ang?.nama} - Rp ${s.jumlah.toLocaleString('id-ID')}</li>`;
                });
                html += '</ul>';
            }
            
            const totalSukarelaDisplayed = simpananSukarela.filter(s => {
                const ang = anggota.find(a => a.id === s.anggotaId);
                return s.jumlah > 0 && ang && ang.statusKeanggotaan !== 'Keluar';
            }).length;
            html += `<p class="mt-2"><small>Total record yang ditampilkan: ${totalSukarelaDisplayed}</small></p>`;
            html += `</div>`;
            
            // Summary
            html += `<div class="test-section ${allTestsPassed ? 'test-pass' : 'test-fail'}">`;
            html += `<h4>ðŸ“Š Summary</h4>`;
            if (allTestsPassed) {
                html += `<p><span class="badge bg-success badge-large">âœ“ ALL TESTS PASSED</span></p>`;
                html += `<p><strong>Sempurna!</strong> Filter anggota keluar sudah bekerja dengan benar di semua menu simpanan.</p>`;
                html += `<ul>`;
                html += `<li>âœ… Simpanan Pokok: Tidak ada anggota keluar</li>`;
                html += `<li>âœ… Simpanan Wajib: Tidak ada anggota keluar</li>`;
                html += `<li>âœ… Simpanan Sukarela: Tidak ada anggota keluar</li>`;
                html += `</ul>`;
            } else {
                html += `<p><span class="badge bg-danger badge-large">âœ— SOME TESTS FAILED</span></p>`;
                html += `<p><strong>Ada masalah!</strong> Beberapa test gagal. Silakan periksa detail di atas.</p>`;
            }
            html += `</div>`;
            
            document.getElementById('testResults').innerHTML = html;
        }
        
        function showRawData() {
            const section = document.getElementById('rawDataSection');
            if (section.style.display === 'none') {
                const anggota = JSON.parse(localStorage.getItem('anggota') || '[]');
                const simpananPokok = JSON.parse(localStorage.getItem('simpananPokok') || '[]');
                const simpananWajib = JSON.parse(localStorage.getItem('simpananWajib') || '[]');
                const simpananSukarela = JSON.parse(localStorage.getItem('simpananSukarela') || '[]');
                
                const anggotaKeluar = anggota.filter(a => a.statusKeanggotaan === 'Keluar');
                
                let html = '<h5>Anggota Keluar</h5>';
                html += `<pre>${JSON.stringify(anggotaKeluar, null, 2)}</pre>`;
                
                html += '<h5>Simpanan Pokok (Anggota Keluar)</h5>';
                const pokokKeluar = simpananPokok.filter(s => 
                    anggotaKeluar.some(a => a.id === s.anggotaId)
                );
                html += `<pre>${JSON.stringify(pokokKeluar, null, 2)}</pre>`;
                
                html += '<h5>Simpanan Wajib (Anggota Keluar)</h5>';
                const wajibKeluar = simpananWajib.filter(s => 
                    anggotaKeluar.some(a => a.id === s.anggotaId)
                );
                html += `<pre>${JSON.stringify(wajibKeluar, null, 2)}</pre>`;
                
                document.getElementById('rawData').innerHTML = html;
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
            }
        }
        
        // Run tests on page load
        window.onload = runTests;
    </script>
</body>
</html>
