<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Pembayaran Hutang Piutang</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container py-4">
        <h1><i class="bi bi-bug"></i> Debug Pembayaran Hutang Piutang</h1>
        <p class="lead">Memeriksa masalah pembayaran-hutang-piutang yang tidak bisa terbuka</p>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Status Fungsi</h5>
                    </div>
                    <div class="card-body">
                        <div id="functionStatus"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Render</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="testRender()">Test Render Function</button>
                        <div id="renderResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Console Output</h5>
                    </div>
                    <div class="card-body">
                        <div id="consoleOutput" style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Content Area -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Content Area</h5>
                    </div>
                    <div class="card-body">
                        <div id="content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/koperasi.js"></script>
    <script src="js/pembayaranHutangPiutang.js"></script>

    <script>
        // Override console.log to capture output
        const originalLog = console.log;
        const originalError = console.error;
        let consoleOutput = '';

        function addToConsole(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            consoleOutput += `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            document.getElementById('consoleOutput').textContent = consoleOutput;
            document.getElementById('consoleOutput').scrollTop = document.getElementById('consoleOutput').scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '), 'log');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };

        // Setup test data
        function setupTestData() {
            // Setup current user
            const testUser = {
                id: 'test-admin',
                nama: 'Test Admin',
                role: 'admin'
            };
            localStorage.setItem('currentUser', JSON.stringify(testUser));

            // Setup test anggota
            const testAnggota = [
                {
                    id: 'anggota-1',
                    nik: '1234567890',
                    nama: 'John Doe',
                    status: 'Aktif'
                }
            ];
            localStorage.setItem('anggota', JSON.stringify(testAnggota));

            // Setup empty arrays
            localStorage.setItem('penjualan', JSON.stringify([]));
            localStorage.setItem('pembayaranHutangPiutang', JSON.stringify([]));
            localStorage.setItem('jurnal', JSON.stringify([]));
            localStorage.setItem('auditLog', JSON.stringify([]));

            console.log('Test data setup completed');
        }

        function checkFunctionStatus() {
            const status = document.getElementById('functionStatus');
            let html = '<ul class="list-group">';

            // Check if functions exist
            const functions = [
                'renderPembayaranHutangPiutang',
                'checkPembayaranAccess',
                'hitungSaldoHutang',
                'hitungSaldoPiutang',
                'formatRupiah',
                'generateId',
                'showAlert'
            ];

            functions.forEach(func => {
                const exists = typeof window[func] === 'function';
                const className = exists ? 'list-group-item-success' : 'list-group-item-danger';
                const icon = exists ? 'bi-check-circle' : 'bi-x-circle';
                html += `<li class="list-group-item ${className}">
                    <i class="bi ${icon}"></i> ${func}: ${exists ? 'OK' : 'MISSING'}
                </li>`;
            });

            html += '</ul>';
            status.innerHTML = html;

            console.log('Function status check completed');
        }

        function testRender() {
            const resultDiv = document.getElementById('renderResult');
            
            try {
                console.log('Testing renderPembayaranHutangPiutang function...');
                
                if (typeof renderPembayaranHutangPiutang !== 'function') {
                    throw new Error('renderPembayaranHutangPiutang function not found');
                }

                // Call the function
                renderPembayaranHutangPiutang();
                
                resultDiv.innerHTML = '<div class="alert alert-success">Function executed successfully! Check content area below.</div>';
                console.log('renderPembayaranHutangPiutang executed successfully');
                
            } catch (error) {
                console.error('Error testing render function:', error);
                resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing debug...');
            setupTestData();
            checkFunctionStatus();
        });
    </script>
</body>
</html>