<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Menu Upload Master Barang Excel - Verification</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">üîç Verifikasi Menu Upload Master Barang Excel</h1>
                
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Status Implementasi</h5>
                    </div>
                    <div class="card-body">
                        <div id="implementationStatus">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-hourglass-split text-warning me-2"></i>
                                <span>Memeriksa implementasi...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Test Menu untuk Berbagai Role</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Super Admin Menu:</h6>
                                <div id="superAdminMenu" class="border p-3 mb-3" style="max-height: 300px; overflow-y: auto;">
                                    <!-- Menu akan di-render di sini -->
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Administrator Menu:</h6>
                                <div id="administratorMenu" class="border p-3 mb-3" style="max-height: 300px; overflow-y: auto;">
                                    <!-- Menu akan di-render di sini -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Troubleshooting Steps</h5>
                    </div>
                    <div class="card-body">
                        <div id="troubleshootingSteps">
                            <!-- Steps akan di-generate di sini -->
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">Quick Fix Actions</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary me-2" onclick="clearBrowserCache()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Clear Cache & Reload
                        </button>
                        <button class="btn btn-success me-2" onclick="testDirectAccess()">
                            <i class="bi bi-link-45deg me-1"></i>Test Direct Access
                        </button>
                        <button class="btn btn-info me-2" onclick="downloadLatestAuthJs()">
                            <i class="bi bi-download me-1"></i>Download Latest auth.js
                        </button>
                        <button class="btn btn-secondary" onclick="runFullDiagnostic()">
                            <i class="bi bi-gear me-1"></i>Run Full Diagnostic
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Simulasi menu data berdasarkan implementasi aktual
        const menuData = {
            super_admin: [
                { icon: 'bi-speedometer2', text: 'Dashboard', page: 'dashboard' },
                { icon: 'bi-gear', text: 'Pengaturan Sistem', page: 'pengaturan-sistem' },
                { icon: 'bi-people', text: 'Master Anggota', page: 'anggota' },
                { icon: 'bi-box-seam', text: 'Master Barang', page: 'barang' },
                { icon: 'bi-file-excel', text: 'Upload Master Barang Excel', page: 'upload-master-barang-excel' },
                { icon: 'bi-arrow-left-right', text: 'Transformasi Barang', page: 'transformasi-barang' },
                { icon: 'bi-truck', text: 'Supplier', page: 'supplier' }
            ],
            administrator: [
                { icon: 'bi-speedometer2', text: 'Dashboard', page: 'dashboard' },
                { icon: 'bi-people', text: 'Master Anggota', page: 'anggota' },
                { icon: 'bi-box-seam', text: 'Master Barang', page: 'barang' },
                { icon: 'bi-file-excel', text: 'Upload Master Barang Excel', page: 'upload-master-barang-excel' },
                { icon: 'bi-arrow-left-right', text: 'Transformasi Barang', page: 'transformasi-barang' },
                { icon: 'bi-truck', text: 'Supplier', page: 'supplier' }
            ]
        };

        document.addEventListener('DOMContentLoaded', function() {
            checkImplementationStatus();
            renderMenus();
            generateTroubleshootingSteps();
        });

        function checkImplementationStatus() {
            const statusDiv = document.getElementById('implementationStatus');
            
            // Check if auth.js is loaded
            const authJsLoaded = typeof renderUploadMasterBarangExcel === 'function';
            
            // Check if menu data contains the upload menu
            const superAdminHasMenu = menuData.super_admin.some(item => item.page === 'upload-master-barang-excel');
            const administratorHasMenu = menuData.administrator.some(item => item.page === 'upload-master-barang-excel');
            
            let statusHtml = '';
            
            // Auth.js status
            if (authJsLoaded) {
                statusHtml += `
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-check-circle text-success me-2"></i>
                        <span>auth.js loaded successfully</span>
                    </div>
                `;
            } else {
                statusHtml += `
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-x-circle text-danger me-2"></i>
                        <span>auth.js not loaded or renderUploadMasterBarangExcel function missing</span>
                    </div>
                `;
            }
            
            // Menu data status
            if (superAdminHasMenu && administratorHasMenu) {
                statusHtml += `
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-check-circle text-success me-2"></i>
                        <span>Menu "Upload Master Barang Excel" found in both super_admin and administrator roles</span>
                    </div>
                `;
            } else {
                statusHtml += `
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-x-circle text-danger me-2"></i>
                        <span>Menu "Upload Master Barang Excel" missing from role configurations</span>
                    </div>
                `;
            }
            
            // File existence check
            statusHtml += `
                <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-info-circle text-info me-2"></i>
                    <span>Checking file existence...</span>
                    <button class="btn btn-sm btn-outline-primary ms-2" onclick="checkFileExistence()">
                        Check Files
                    </button>
                </div>
            `;
            
            statusDiv.innerHTML = statusHtml;
        }

        function renderMenus() {
            renderMenuForRole('super_admin', 'superAdminMenu');
            renderMenuForRole('administrator', 'administratorMenu');
        }

        function renderMenuForRole(role, containerId) {
            const container = document.getElementById(containerId);
            const menus = menuData[role] || [];
            
            let menuHtml = '<ul class="list-unstyled">';
            
            menus.forEach(menu => {
                const isUploadMenu = menu.page === 'upload-master-barang-excel';
                const highlightClass = isUploadMenu ? 'bg-warning bg-opacity-25 border border-warning' : '';
                
                menuHtml += `
                    <li class="mb-1 p-2 rounded ${highlightClass}">
                        <i class="${menu.icon} me-2"></i>
                        ${menu.text}
                        ${isUploadMenu ? '<span class="badge bg-success ms-2">TARGET MENU</span>' : ''}
                    </li>
                `;
            });
            
            menuHtml += '</ul>';
            container.innerHTML = menuHtml;
        }

        function generateTroubleshootingSteps() {
            const stepsDiv = document.getElementById('troubleshootingSteps');
            
            const steps = [
                {
                    title: '1. Hard Refresh Browser',
                    description: 'Tekan Ctrl+F5 (Windows) atau Cmd+Shift+R (Mac) untuk memaksa reload semua file',
                    action: 'clearBrowserCache()',
                    buttonText: 'Clear Cache'
                },
                {
                    title: '2. Check User Role',
                    description: 'Pastikan login sebagai user dengan role "super_admin" atau "administrator"',
                    action: 'checkCurrentUser()',
                    buttonText: 'Check Role'
                },
                {
                    title: '3. Check Console Errors',
                    description: 'Buka Developer Tools (F12) ‚Üí Console, lihat apakah ada error JavaScript',
                    action: 'checkConsoleErrors()',
                    buttonText: 'Check Console'
                },
                {
                    title: '4. Test Direct Access',
                    description: 'Coba akses langsung halaman upload_master_barang_excel.html',
                    action: 'testDirectAccess()',
                    buttonText: 'Test Access'
                },
                {
                    title: '5. Verify File Integrity',
                    description: 'Pastikan file auth.js sudah ter-update dengan versi terbaru',
                    action: 'verifyFileIntegrity()',
                    buttonText: 'Verify Files'
                }
            ];
            
            let stepsHtml = '';
            steps.forEach((step, index) => {
                stepsHtml += `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title">${step.title}</h6>
                            <p class="card-text">${step.description}</p>
                            <button class="btn btn-sm btn-outline-primary" onclick="${step.action}">
                                ${step.buttonText}
                            </button>
                        </div>
                    </div>
                `;
            });
            
            stepsDiv.innerHTML = stepsHtml;
        }

        // Action functions
        function clearBrowserCache() {
            if (confirm('Ini akan me-reload halaman dan clear cache. Lanjutkan?')) {
                // Clear localStorage
                localStorage.clear();
                
                // Force reload with cache bypass
                window.location.reload(true);
            }
        }

        function testDirectAccess() {
            const uploadUrl = 'upload_master_barang_excel.html';
            window.open(uploadUrl, '_blank');
        }

        function downloadLatestAuthJs() {
            alert('Untuk download auth.js terbaru, silakan check repository atau backup file.');
        }

        function runFullDiagnostic() {
            const results = [];
            
            // Check localStorage
            const currentUser = localStorage.getItem('currentUser');
            results.push(`Current User: ${currentUser || 'Not found'}`);
            
            // Check if functions exist
            results.push(`renderUploadMasterBarangExcel function: ${typeof renderUploadMasterBarangExcel !== 'undefined' ? 'Found' : 'Not found'}`);
            
            // Check menu data
            const hasUploadMenu = menuData.super_admin.some(item => item.page === 'upload-master-barang-excel');
            results.push(`Upload menu in data: ${hasUploadMenu ? 'Found' : 'Not found'}`);
            
            // Display results
            alert('Diagnostic Results:\n\n' + results.join('\n'));
        }

        function checkCurrentUser() {
            const currentUser = localStorage.getItem('currentUser');
            if (currentUser) {
                try {
                    const user = JSON.parse(currentUser);
                    alert(`Current User:\nUsername: ${user.username}\nRole: ${user.role}\n\nRole should be 'super_admin' or 'administrator' to see the menu.`);
                } catch (e) {
                    alert('Error parsing current user data. Try logging in again.');
                }
            } else {
                alert('No current user found. Please login first.');
            }
        }

        function checkConsoleErrors() {
            alert('Please open Developer Tools (F12) ‚Üí Console tab and look for any red error messages. Common issues:\n\n1. Failed to load js/auth.js\n2. JavaScript syntax errors\n3. Network errors\n\nIf you see errors, please note them down for troubleshooting.');
        }

        function verifyFileIntegrity() {
            const checks = [
                'auth.js file exists and loads properly',
                'Menu array contains upload-master-barang-excel entry',
                'renderUploadMasterBarangExcel function exists',
                'Case statement for upload-master-barang-excel exists'
            ];
            
            alert('File Integrity Checklist:\n\n' + checks.map((check, i) => `${i + 1}. ${check}`).join('\n') + '\n\nPlease verify each item manually or contact support.');
        }

        function checkFileExistence() {
            // Simple check by trying to access the upload page
            fetch('upload_master_barang_excel.html')
                .then(response => {
                    if (response.ok) {
                        document.getElementById('implementationStatus').innerHTML += `
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                <span>upload_master_barang_excel.html exists and accessible</span>
                            </div>
                        `;
                    } else {
                        document.getElementById('implementationStatus').innerHTML += `
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-x-circle text-danger me-2"></i>
                                <span>upload_master_barang_excel.html not accessible (${response.status})</span>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    document.getElementById('implementationStatus').innerHTML += `
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-x-circle text-danger me-2"></i>
                            <span>Error checking file: ${error.message}</span>
                        </div>
                    `;
                });
        }
    </script>
</body>
</html>