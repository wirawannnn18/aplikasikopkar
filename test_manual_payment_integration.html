<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Manual Payment Integration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>Test Manual Payment Integration</h2>
        <p class="text-muted">Testing enhanced manual payment controller with SharedPaymentServices integration</p>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Integration Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="integrationStatus">
                            <p><strong>SharedPaymentServices:</strong> <span id="sharedServicesStatus" class="badge bg-secondary">Not Loaded</span></p>
                            <p><strong>Manual Payment Controller:</strong> <span id="manualControllerStatus" class="badge bg-secondary">Not Loaded</span></p>
                            <p><strong>Integration Mode:</strong> <span id="integrationModeStatus" class="badge bg-secondary">Disabled</span></p>
                        </div>
                        
                        <div class="mt-3">
                            <button class="btn btn-primary" onclick="testIntegration()">Test Integration</button>
                            <button class="btn btn-success" onclick="enableIntegrationMode()">Enable Integration Mode</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="testResults">
                            <p class="text-muted">Click "Test Integration" to run tests</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Manual Payment Interface</h5>
                    </div>
                    <div class="card-body">
                        <div id="mainContent">
                            <!-- Manual payment interface will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Load dependencies -->
    <script src="js/app.js"></script>
    <script src="js/shared/SharedPaymentServices.js"></script>
    <script src="js/pembayaranHutangPiutang.js"></script>
    
    <script>
        // Test data setup
        function setupTestData() {
            // Setup test user
            const testUser = {
                id: 'test-user-1',
                nama: 'Test Kasir',
                role: 'kasir',
                active: true
            };
            localStorage.setItem('currentUser', JSON.stringify(testUser));
            
            // Setup test anggota
            const testAnggota = [
                {
                    id: 'anggota-1',
                    nama: 'John Doe',
                    nik: '1234567890',
                    status: 'Aktif'
                },
                {
                    id: 'anggota-2',
                    nama: 'Jane Smith',
                    nik: '0987654321',
                    status: 'Aktif'
                }
            ];
            localStorage.setItem('anggota', JSON.stringify(testAnggota));
            
            // Setup test POS transactions (for hutang calculation)
            const testPenjualan = [
                {
                    id: 'pos-1',
                    anggotaId: 'anggota-1',
                    total: 100000,
                    metodePembayaran: 'Kredit',
                    tanggal: '2024-01-15'
                }
            ];
            localStorage.setItem('penjualan', JSON.stringify(testPenjualan));
            
            // Setup test simpanan (for piutang calculation)
            const testSimpanan = [
                {
                    id: 'simpanan-1',
                    anggotaId: 'anggota-2',
                    saldo: 50000,
                    statusPengembalian: 'pending'
                }
            ];
            localStorage.setItem('simpanan', JSON.stringify(testSimpanan));
            
            // Initialize empty payment history
            localStorage.setItem('pembayaranHutangPiutang', JSON.stringify([]));
        }
        
        function checkIntegrationStatus() {
            // Check SharedPaymentServices
            const sharedServicesStatus = document.getElementById('sharedServicesStatus');
            if (typeof window.SharedPaymentServices !== 'undefined') {
                sharedServicesStatus.textContent = 'Loaded';
                sharedServicesStatus.className = 'badge bg-success';
            } else {
                sharedServicesStatus.textContent = 'Not Loaded';
                sharedServicesStatus.className = 'badge bg-danger';
            }
            
            // Check Manual Payment Controller
            const manualControllerStatus = document.getElementById('manualControllerStatus');
            if (typeof window.renderPembayaranHutangPiutang !== 'undefined') {
                manualControllerStatus.textContent = 'Loaded';
                manualControllerStatus.className = 'badge bg-success';
            } else {
                manualControllerStatus.textContent = 'Not Loaded';
                manualControllerStatus.className = 'badge bg-danger';
            }
            
            // Check integration functions
            const integrationModeStatus = document.getElementById('integrationModeStatus');
            if (typeof window.setIntegrationMode !== 'undefined') {
                integrationModeStatus.textContent = 'Available';
                integrationModeStatus.className = 'badge bg-success';
            } else {
                integrationModeStatus.textContent = 'Not Available';
                integrationModeStatus.className = 'badge bg-danger';
            }
        }
        
        function testIntegration() {
            const results = document.getElementById('testResults');
            results.innerHTML = '<p class="text-info">Running integration tests...</p>';
            
            const testResults = [];
            
            try {
                // Test 1: SharedPaymentServices initialization
                if (typeof window.SharedPaymentServices !== 'undefined') {
                    const sharedServices = new window.SharedPaymentServices();
                    testResults.push('✅ SharedPaymentServices can be instantiated');
                    
                    // Test saldo calculation
                    const hutangSaldo = sharedServices.hitungSaldoHutang('anggota-1');
                    const piutangSaldo = sharedServices.hitungSaldoPiutang('anggota-2');
                    testResults.push(`✅ Saldo calculation works: Hutang=${hutangSaldo}, Piutang=${piutangSaldo}`);
                } else {
                    testResults.push('❌ SharedPaymentServices not available');
                }
                
                // Test 2: Integration functions
                if (typeof window.setIntegrationMode !== 'undefined') {
                    testResults.push('✅ Integration functions available');
                    
                    // Test callback setup
                    let callbackTriggered = false;
                    window.setIntegrationMode(true, {
                        onTransactionComplete: (data) => {
                            callbackTriggered = true;
                            testResults.push(`✅ Transaction callback triggered: ${JSON.stringify(data)}`);
                        },
                        onSummaryUpdate: (data) => {
                            testResults.push(`✅ Summary callback triggered: ${JSON.stringify(data)}`);
                        }
                    });
                    testResults.push('✅ Integration mode enabled with callbacks');
                } else {
                    testResults.push('❌ Integration functions not available');
                }
                
                // Test 3: State management
                if (typeof window.hasUnsavedData !== 'undefined' && 
                    typeof window.saveManualPaymentState !== 'undefined') {
                    testResults.push('✅ State management functions available');
                } else {
                    testResults.push('❌ State management functions not available');
                }
                
                // Test 4: Enhanced audit logging
                if (typeof window.saveAuditLog !== 'undefined') {
                    window.saveAuditLog('TEST_ACTION', { test: true }, 'manual', 'test-module');
                    testResults.push('✅ Enhanced audit logging works');
                } else {
                    testResults.push('❌ Audit logging not available');
                }
                
            } catch (error) {
                testResults.push(`❌ Error during testing: ${error.message}`);
            }
            
            // Display results
            results.innerHTML = testResults.map(result => `<p>${result}</p>`).join('');
        }
        
        function enableIntegrationMode() {
            if (typeof window.setIntegrationMode !== 'undefined') {
                window.setIntegrationMode(true, {
                    onTransactionComplete: (data) => {
                        console.log('Transaction completed:', data);
                        alert(`Transaction completed in ${data.mode} mode: ${data.transaction.id}`);
                    },
                    onSummaryUpdate: (data) => {
                        console.log('Summary updated:', data);
                    }
                });
                
                document.getElementById('integrationModeStatus').textContent = 'Enabled';
                document.getElementById('integrationModeStatus').className = 'badge bg-success';
                
                alert('Integration mode enabled! Callbacks are now active.');
            } else {
                alert('Integration functions not available');
            }
        }
        
        function renderManualPayment() {
            if (typeof window.renderPembayaranHutangPiutang !== 'undefined') {
                window.renderPembayaranHutangPiutang();
            } else {
                document.getElementById('mainContent').innerHTML = 
                    '<div class="alert alert-danger">Manual payment controller not loaded</div>';
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            setupTestData();
            checkIntegrationStatus();
            
            // Wait a bit for all scripts to load
            setTimeout(() => {
                checkIntegrationStatus();
                renderManualPayment();
            }, 1000);
        });
    </script>
</body>
</html>