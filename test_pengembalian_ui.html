<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Pengembalian UI - Task 8</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
</head>
<body>
    <div class="container mt-5">
        <h2 class="mb-4">Test Pengembalian UI - Task 8</h2>
        
        <div class="alert alert-info">
            <h5 class="alert-heading"><i class="bi bi-info-circle me-2"></i>Test Instructions</h5>
            <ol class="mb-0">
                <li>Setup test data dengan tombol di bawah</li>
                <li>Test modal pengembalian detail (Task 8.1)</li>
                <li>Test form proses pengembalian (Task 8.2)</li>
                <li>Test modal pembatalan status keluar (Task 8.3)</li>
            </ol>
        </div>
        
        <!-- Task 8.1: Pengembalian Detail Modal -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Task 8.1: Pengembalian Detail Modal</h5>
            </div>
            <div class="card-body">
                <p><strong>Test:</strong> Modal should display anggota info, calculated simpanan totals, and validation warnings</p>
                <button class="btn btn-primary" onclick="setupTestData()">Setup Test Data</button>
                <button class="btn btn-success" onclick="testPengembalianModal()">Test Pengembalian Modal</button>
                <button class="btn btn-warning" onclick="testPengembalianWithLoan()">Test with Active Loan</button>
                <div id="task81Results" class="mt-3"></div>
            </div>
        </div>
        
        <!-- Task 8.2: Pengembalian Processing Form -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Task 8.2: Pengembalian Processing Form</h5>
            </div>
            <div class="card-body">
                <p><strong>Test:</strong> Form should have metode pembayaran dropdown, date picker, and keterangan textarea</p>
                <button class="btn btn-success" onclick="testProcessingForm()">Test Processing Form</button>
                <button class="btn btn-primary" onclick="testProcessPengembalian()">Test Process Pengembalian</button>
                <div id="task82Results" class="mt-3"></div>
            </div>
        </div>
        
        <!-- Task 8.3: Cancellation Button and Modal -->
        <div class="card mb-4">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">Task 8.3: Cancellation Button and Modal</h5>
            </div>
            <div class="card-body">
                <p><strong>Test:</strong> Cancellation button should appear for anggota keluar with pending status</p>
                <button class="btn btn-danger" onclick="testCancelModal()">Test Cancel Modal</button>
                <button class="btn btn-warning" onclick="testCancelKeluar()">Test Cancel Keluar</button>
                <div id="task83Results" class="mt-3"></div>
            </div>
        </div>
        
        <!-- Test Results Display -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Test Results</h5>
            </div>
            <div class="card-body">
                <div id="testResults"></div>
            </div>
        </div>
    </div>
    
    <!-- Load Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Load Application Scripts -->
    <script src="js/anggotaKeluarRepository.js"></script>
    <script src="js/anggotaKeluarManager.js"></script>
    <script src="js/anggotaKeluarUI.js"></script>
    
    <!-- Test Scripts -->
    <script>
        // Helper function to generate ID
        function generateId() {
            return 'test-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }
        
        // Helper function to get current date in ISO format
        function getCurrentDateISO() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }
        
        // Helper function to format date for display
        function formatDateToDisplay(isoDate) {
            if (!isoDate) return '-';
            const date = new Date(isoDate);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        // Helper function to get anggota by ID
        function getAnggotaById(anggotaId) {
            const anggota = JSON.parse(localStorage.getItem('anggota') || '[]');
            return anggota.find(a => a.id === anggotaId);
        }
        
        // Setup test data
        function setupTestData() {
            // Clear existing data
            localStorage.removeItem('anggota');
            localStorage.removeItem('simpananPokok');
            localStorage.removeItem('simpananWajib');
            localStorage.removeItem('pinjaman');
            localStorage.removeItem('pengembalian');
            localStorage.removeItem('jurnal');
            
            // Create test anggota with status "Keluar"
            const testAnggota = {
                id: 'test-anggota-001',
                nik: '1234567890123456',
                nama: 'Budi Santoso',
                noKartu: 'K001',
                departemen: 'IT',
                tipeAnggota: 'Anggota',
                status: 'Aktif',
                statusKeanggotaan: 'Keluar',
                tanggalKeluar: '2024-12-01',
                alasanKeluar: 'Pindah ke kota lain untuk pekerjaan baru',
                pengembalianStatus: 'Pending',
                pengembalianId: null,
                tanggalDaftar: '2023-01-15'
            };
            
            // Create test simpanan pokok
            const testSimpananPokok = [
                {
                    id: 'sp-001',
                    anggotaId: 'test-anggota-001',
                    jumlah: 1000000,
                    tanggal: '2023-01-15',
                    keterangan: 'Simpanan Pokok Awal'
                }
            ];
            
            // Create test simpanan wajib
            const testSimpananWajib = [
                {
                    id: 'sw-001',
                    anggotaId: 'test-anggota-001',
                    jumlah: 100000,
                    periode: '2023-01',
                    tanggal: '2023-01-31'
                },
                {
                    id: 'sw-002',
                    anggotaId: 'test-anggota-001',
                    jumlah: 100000,
                    periode: '2023-02',
                    tanggal: '2023-02-28'
                },
                {
                    id: 'sw-003',
                    anggotaId: 'test-anggota-001',
                    jumlah: 100000,
                    periode: '2023-03',
                    tanggal: '2023-03-31'
                }
            ];
            
            // Initialize COA with sufficient balance
            const testCOA = [
                {
                    kode: '1-1000',
                    nama: 'Kas',
                    tipe: 'Aset',
                    saldo: 10000000
                },
                {
                    kode: '2-1100',
                    nama: 'Simpanan Pokok',
                    tipe: 'Kewajiban',
                    saldo: 1000000
                },
                {
                    kode: '2-1200',
                    nama: 'Simpanan Wajib',
                    tipe: 'Kewajiban',
                    saldo: 300000
                }
            ];
            
            // Save to localStorage
            localStorage.setItem('anggota', JSON.stringify([testAnggota]));
            localStorage.setItem('simpananPokok', JSON.stringify(testSimpananPokok));
            localStorage.setItem('simpananWajib', JSON.stringify(testSimpananWajib));
            localStorage.setItem('pinjaman', JSON.stringify([]));
            localStorage.setItem('coa', JSON.stringify(testCOA));
            
            showResult('Test data berhasil dibuat!<br>' +
                      'Anggota: Budi Santoso (Status: Keluar)<br>' +
                      'Simpanan Pokok: Rp 1.000.000<br>' +
                      'Simpanan Wajib: Rp 300.000<br>' +
                      'Total Pengembalian: Rp 1.300.000', 'success');
        }
        
        // Test Task 8.1: Pengembalian Modal
        function testPengembalianModal() {
            const anggotaId = 'test-anggota-001';
            const anggota = getAnggotaById(anggotaId);
            
            if (!anggota) {
                showResult('Test gagal: Anggota tidak ditemukan. Jalankan Setup Test Data terlebih dahulu.', 'danger');
                return;
            }
            
            // Call showPengembalianModal
            showPengembalianModal(anggotaId);
            
            showResult('Modal pengembalian ditampilkan. Periksa:<br>' +
                      '✓ Informasi anggota (NIK, Nama, Tanggal Keluar, Alasan)<br>' +
                      '✓ Rincian simpanan (Pokok, Wajib, Total)<br>' +
                      '✓ Total pengembalian<br>' +
                      '✓ Form pengembalian (Metode, Tanggal, Keterangan)', 'info');
        }
        
        // Test with active loan
        function testPengembalianWithLoan() {
            // Add active loan
            const testPinjaman = [{
                id: 'pinjaman-001',
                anggotaId: 'test-anggota-001',
                jumlah: 500000,
                status: 'Aktif',
                tanggal: '2024-11-01'
            }];
            
            localStorage.setItem('pinjaman', JSON.stringify(testPinjaman));
            
            // Show modal
            showPengembalianModal('test-anggota-001');
            
            showResult('Modal ditampilkan dengan pinjaman aktif. Periksa:<br>' +
                      '✓ Alert validasi error muncul<br>' +
                      '✓ Pesan "pinjaman aktif" ditampilkan<br>' +
                      '✓ Tombol "Proses Pengembalian" TIDAK muncul', 'warning');
        }
        
        // Test Task 8.2: Processing Form
        function testProcessingForm() {
            showPengembalianModal('test-anggota-001');
            
            setTimeout(() => {
                const metodePembayaran = document.getElementById('metodePembayaran');
                const tanggalPembayaran = document.getElementById('tanggalPembayaran');
                const keterangan = document.getElementById('keteranganPengembalian');
                
                if (metodePembayaran && tanggalPembayaran && keterangan) {
                    showResult('Form pengembalian ditemukan!<br>' +
                              '✓ Dropdown metode pembayaran<br>' +
                              '✓ Date picker tanggal pembayaran<br>' +
                              '✓ Textarea keterangan<br>' +
                              '✓ Tombol "Proses Pengembalian"', 'success');
                } else {
                    showResult('Form tidak lengkap. Periksa kembali.', 'danger');
                }
            }, 500);
        }
        
        // Test process pengembalian
        function testProcessPengembalian() {
            showPengembalianModal('test-anggota-001');
            
            setTimeout(() => {
                // Fill form
                document.getElementById('metodePembayaran').value = 'Kas';
                document.getElementById('tanggalPembayaran').value = getCurrentDateISO();
                document.getElementById('keteranganPengembalian').value = 'Test pengembalian simpanan';
                
                showResult('Form telah diisi. Klik tombol "Proses Pengembalian" di modal untuk test.', 'info');
            }, 500);
        }
        
        // Test Task 8.3: Cancel Modal
        function testCancelModal() {
            const anggotaId = 'test-anggota-001';
            const anggota = getAnggotaById(anggotaId);
            
            if (!anggota) {
                showResult('Test gagal: Anggota tidak ditemukan. Jalankan Setup Test Data terlebih dahulu.', 'danger');
                return;
            }
            
            // Call showCancelKeluarModal
            showCancelKeluarModal(anggotaId);
            
            showResult('Modal pembatalan ditampilkan. Periksa:<br>' +
                      '✓ Informasi anggota<br>' +
                      '✓ Peringatan tentang pembatalan<br>' +
                      '✓ Tombol "Ya, Batalkan Status Keluar"', 'info');
        }
        
        // Test cancel keluar
        function testCancelKeluar() {
            showCancelKeluarModal('test-anggota-001');
            
            showResult('Modal pembatalan ditampilkan. Klik tombol "Ya, Batalkan Status Keluar" untuk test.', 'info');
        }
        
        // Show result
        function showResult(message, type = 'info') {
            const resultDiv = document.getElementById('testResults');
            resultDiv.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            showResult('Halaman test siap. Klik "Setup Test Data" untuk memulai.', 'info');
        });
    </script>
</body>
</html>
