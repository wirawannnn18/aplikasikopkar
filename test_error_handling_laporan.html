<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Error Handling - Laporan Transaksi Simpanan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .test-pass {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .test-fail {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .test-info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1><i class="fas fa-bug"></i> Test Error Handling - Laporan Transaksi Simpanan</h1>
        <p class="text-muted">Testing comprehensive error handling implementation (Task 14)</p>

        <div id="testResults"></div>

        <div class="mt-4">
            <button class="btn btn-primary" onclick="runAllTests()">
                <i class="fas fa-play"></i> Run All Tests
            </button>
            <button class="btn btn-secondary" onclick="clearResults()">
                <i class="fas fa-trash"></i> Clear Results
            </button>
            <button class="btn btn-info" onclick="viewErrorLogs()">
                <i class="fas fa-list"></i> View Error Logs
            </button>
        </div>
    </div>

    <script>
        let testResults = [];

        function addTestResult(testName, passed, message) {
            const result = {
                testName,
                passed,
                message,
                timestamp: new Date().toISOString()
            };
            testResults.push(result);
            displayResults();
        }

        function displayResults() {
            const container = document.getElementById('testResults');
            container.innerHTML = '';

            testResults.forEach((result, index) => {
                const div = document.createElement('div');
                div.className = `test-result ${result.passed ? 'test-pass' : 'test-fail'}`;
                div.innerHTML = `
                    <strong>Test ${index + 1}: ${result.testName}</strong><br>
                    <i class="fas ${result.passed ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                    ${result.message}
                    <br><small>${result.timestamp}</small>
                `;
                container.appendChild(div);
            });

            // Summary
            const passed = testResults.filter(r => r.passed).length;
            const total = testResults.length;
            const summary = document.createElement('div');
            summary.className = 'alert alert-info mt-3';
            summary.innerHTML = `
                <strong>Summary:</strong> ${passed}/${total} tests passed
                (${((passed/total)*100).toFixed(1)}%)
            `;
            container.appendChild(summary);
        }

        function clearResults() {
            testResults = [];
            document.getElementById('testResults').innerHTML = '';
        }

        // ============================================================================
        // TEST 1: Custom Error Classes
        // ============================================================================
        function testErrorClasses() {
            try {
                // Test LaporanError
                const error1 = new LaporanError('Test error', 'TEST_CODE', { detail: 'test' });
                const pass1 = error1.name === 'LaporanError' && 
                             error1.code === 'TEST_CODE' &&
                             error1.details.detail === 'test';

                // Test DataLoadError
                const error2 = new DataLoadError('Data load failed', { key: 'test' });
                const pass2 = error2.name === 'DataLoadError' && 
                             error2.code === 'DATA_LOAD_ERROR';

                // Test ValidationError
                const error3 = new ValidationError('Validation failed', { field: 'test' });
                const pass3 = error3.name === 'ValidationError' && 
                             error3.code === 'VALIDATION_ERROR';

                // Test ExportError
                const error4 = new ExportError('Export failed', { reason: 'test' });
                const pass4 = error4.name === 'ExportError' && 
                             error4.code === 'EXPORT_ERROR';

                const allPass = pass1 && pass2 && pass3 && pass4;
                addTestResult(
                    'Custom Error Classes',
                    allPass,
                    allPass ? 'All error classes work correctly' : 'Some error classes failed'
                );
            } catch (error) {
                addTestResult('Custom Error Classes', false, `Error: ${error.message}`);
            }
        }

        // ============================================================================
        // TEST 2: Error Tracker
        // ============================================================================
        function testErrorTracker() {
            try {
                if (!window.errorTracker) {
                    addTestResult('Error Tracker', false, 'Error tracker not initialized');
                    return;
                }

                // Clear existing errors
                window.errorTracker.clear();

                // Log test error
                const testError = new LaporanError('Test error', 'TEST', {});
                window.errorTracker.log(testError);

                // Check if error was logged
                const errors = window.errorTracker.getErrors();
                const pass = errors.length === 1 && 
                            errors[0].name === 'LaporanError' &&
                            errors[0].code === 'TEST';

                addTestResult(
                    'Error Tracker',
                    pass,
                    pass ? 'Error tracker logs errors correctly' : 'Error tracker failed'
                );

                // Clean up
                window.errorTracker.clear();
            } catch (error) {
                addTestResult('Error Tracker', false, `Error: ${error.message}`);
            }
        }

        // ============================================================================
        // TEST 3: Data Validators
        // ============================================================================
        function testDataValidators() {
            try {
                // Test anggota array validator
                const validAnggota = [{ id: '1', nama: 'Test' }];
                const invalidAnggota = 'not an array';
                const pass1 = DataValidators.isValidAnggotaArray(validAnggota) === true &&
                             DataValidators.isValidAnggotaArray(invalidAnggota) === false;

                // Test transaksi array validator
                const validTransaksi = [{ id: '1', anggotaId: '1' }];
                const pass2 = DataValidators.isValidTransaksiArray(validTransaksi) === true;

                // Test simpanan array validator
                const validSimpanan = [{ anggotaId: '1', jenis: 'pokok' }];
                const pass3 = DataValidators.isValidSimpananArray(validSimpanan) === true;

                // Test number validator
                const pass4 = DataValidators.isValidNumber(123) === true &&
                             DataValidators.isValidNumber(NaN) === false &&
                             DataValidators.isValidNumber(Infinity) === false;

                // Test date validator
                const pass5 = DataValidators.isValidDate('2024-01-01') === true &&
                             DataValidators.isValidDate('invalid') === false;

                const allPass = pass1 && pass2 && pass3 && pass4 && pass5;
                addTestResult(
                    'Data Validators',
                    allPass,
                    allPass ? 'All validators work correctly' : 'Some validators failed'
                );
            } catch (error) {
                addTestResult('Data Validators', false, `Error: ${error.message}`);
            }
        }

        // ============================================================================
        // TEST 4: Safe Calculation Functions
        // ============================================================================
        function testSafeCalculations() {
            try {
                // Test safeAdd
                const sum1 = safeAdd(10, 20);
                const sum2 = safeAdd(null, 20);
                const sum3 = safeAdd(undefined, undefined);
                const pass1 = sum1 === 30 && sum2 === 20 && sum3 === 0;

                // Test safeDivide
                const div1 = safeDivide(10, 2);
                const div2 = safeDivide(10, 0);
                const div3 = safeDivide(null, 2);
                const pass2 = div1 === 5 && div2 === 0 && div3 === 0;

                // Test safePercentage
                const pct1 = safePercentage(25, 100);
                const pct2 = safePercentage(10, 0);
                const pass3 = pct1 === 25 && pct2 === 0;

                // Test safeCurrencyFormat
                const curr1 = safeCurrencyFormat(1000000);
                const curr2 = safeCurrencyFormat(null);
                const pass4 = curr1.includes('1.000.000') && curr2 === 'Rp 0';

                const allPass = pass1 && pass2 && pass3 && pass4;
                addTestResult(
                    'Safe Calculation Functions',
                    allPass,
                    allPass ? 'All safe calculations work correctly' : 'Some calculations failed'
                );
            } catch (error) {
                addTestResult('Safe Calculation Functions', false, `Error: ${error.message}`);
            }
        }

        // ============================================================================
        // TEST 5: safeGetData with Validation
        // ============================================================================
        function testSafeGetData() {
            try {
                // Setup test data
                localStorage.setItem('testValidData', JSON.stringify([{ id: '1', nama: 'Test' }]));
                localStorage.setItem('testInvalidJSON', '{invalid json}');
                localStorage.setItem('testNull', 'null');

                // Test valid data
                const data1 = safeGetData('testValidData', []);
                const pass1 = Array.isArray(data1) && data1.length === 1;

                // Test invalid JSON (should return default)
                const data2 = safeGetData('testInvalidJSON', []);
                const pass2 = Array.isArray(data2) && data2.length === 0;

                // Test null value (should return default)
                const data3 = safeGetData('testNull', []);
                const pass3 = Array.isArray(data3) && data3.length === 0;

                // Test non-existent key (should return default)
                const data4 = safeGetData('nonExistentKey', ['default']);
                const pass4 = Array.isArray(data4) && data4[0] === 'default';

                // Test with validator
                const data5 = safeGetData('testValidData', [], DataValidators.isValidAnggotaArray);
                const pass5 = Array.isArray(data5) && data5.length === 1;

                // Clean up
                localStorage.removeItem('testValidData');
                localStorage.removeItem('testInvalidJSON');
                localStorage.removeItem('testNull');

                const allPass = pass1 && pass2 && pass3 && pass4 && pass5;
                addTestResult(
                    'safeGetData with Validation',
                    allPass,
                    allPass ? 'safeGetData handles all cases correctly' : 'safeGetData failed some cases'
                );
            } catch (error) {
                addTestResult('safeGetData with Validation', false, `Error: ${error.message}`);
            }
        }

        // ============================================================================
        // TEST 6: Export Error Handling
        // ============================================================================
        function testExportErrorHandling() {
            try {
                // This test checks if export functions handle errors gracefully
                // We can't fully test without triggering actual exports, but we can check structure

                const pass1 = typeof exportLaporanToCSV === 'function';
                const pass2 = typeof generateCSVContent === 'function';
                const pass3 = typeof escapeCSVField === 'function';

                const allPass = pass1 && pass2 && pass3;
                addTestResult(
                    'Export Error Handling Structure',
                    allPass,
                    allPass ? 'Export functions are defined' : 'Some export functions missing'
                );
            } catch (error) {
                addTestResult('Export Error Handling Structure', false, `Error: ${error.message}`);
            }
        }

        // ============================================================================
        // TEST 7: Print Error Handling
        // ============================================================================
        function testPrintErrorHandling() {
            try {
                const pass1 = typeof printLaporan === 'function';
                const pass2 = typeof generatePrintContent === 'function';

                const allPass = pass1 && pass2;
                addTestResult(
                    'Print Error Handling Structure',
                    allPass,
                    allPass ? 'Print functions are defined' : 'Some print functions missing'
                );
            } catch (error) {
                addTestResult('Print Error Handling Structure', false, `Error: ${error.message}`);
            }
        }

        // ============================================================================
        // TEST 8: Modal Error Handling
        // ============================================================================
        function testModalErrorHandling() {
            try {
                const pass1 = typeof showDetailTransaksi === 'function';
                const pass2 = typeof showDetailSimpanan === 'function';

                // Test with invalid ID (should not crash)
                let errorCaught = false;
                try {
                    showDetailTransaksi(null);
                } catch (e) {
                    errorCaught = true;
                }

                const allPass = pass1 && pass2 && !errorCaught;
                addTestResult(
                    'Modal Error Handling',
                    allPass,
                    allPass ? 'Modal functions handle errors gracefully' : 'Modal error handling failed'
                );
            } catch (error) {
                addTestResult('Modal Error Handling', false, `Error: ${error.message}`);
            }
        }

        // ============================================================================
        // TEST 9: Graceful Degradation
        // ============================================================================
        function testGracefulDegradation() {
            try {
                // Test that main render function exists and has error handling
                const pass1 = typeof renderLaporanTransaksiSimpananAnggota === 'function';

                // Test AnggotaDataAggregator error handling
                const aggregator = new AnggotaDataAggregator('non-existent-id');
                const loadResult = aggregator.loadData();
                const pass2 = loadResult === false; // Should return false for non-existent ID

                const allPass = pass1 && pass2;
                addTestResult(
                    'Graceful Degradation',
                    allPass,
                    allPass ? 'System degrades gracefully on errors' : 'Graceful degradation failed'
                );
            } catch (error) {
                addTestResult('Graceful Degradation', false, `Error: ${error.message}`);
            }
        }

        // ============================================================================
        // TEST 10: Error Logging Integration
        // ============================================================================
        function testErrorLoggingIntegration() {
            try {
                if (!window.errorTracker) {
                    addTestResult('Error Logging Integration', false, 'Error tracker not available');
                    return;
                }

                // Clear logs
                window.errorTracker.clear();

                // Trigger an error that should be logged
                const testError = new DataLoadError('Test integration', { test: true });
                window.errorTracker.log(testError);

                // Check if error was logged
                const logs = window.errorTracker.getErrors();
                const pass = logs.length === 1 && 
                            logs[0].code === 'DATA_LOAD_ERROR' &&
                            logs[0].details.test === true;

                addTestResult(
                    'Error Logging Integration',
                    pass,
                    pass ? 'Error logging integration works' : 'Error logging integration failed'
                );

                // Clean up
                window.errorTracker.clear();
            } catch (error) {
                addTestResult('Error Logging Integration', false, `Error: ${error.message}`);
            }
        }

        // ============================================================================
        // RUN ALL TESTS
        // ============================================================================
        function runAllTests() {
            clearResults();
            
            console.log('Starting error handling tests...');
            
            testErrorClasses();
            testErrorTracker();
            testDataValidators();
            testSafeCalculations();
            testSafeGetData();
            testExportErrorHandling();
            testPrintErrorHandling();
            testModalErrorHandling();
            testGracefulDegradation();
            testErrorLoggingIntegration();
            
            console.log('All tests completed!');
        }

        // ============================================================================
        // VIEW ERROR LOGS
        // ============================================================================
        function viewErrorLogs() {
            if (!window.errorTracker) {
                alert('Error tracker not available');
                return;
            }

            const logs = window.errorTracker.getErrors();
            
            if (logs.length === 0) {
                alert('No error logs found');
                return;
            }

            const logWindow = window.open('', '_blank');
            logWindow.document.write(`
                <html>
                <head>
                    <title>Error Logs</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                </head>
                <body>
                    <div class="container mt-4">
                        <h1>Error Logs</h1>
                        <p>Total errors: ${logs.length}</p>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Name</th>
                                    <th>Code</th>
                                    <th>Message</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${logs.map(log => `
                                    <tr>
                                        <td>${log.timestamp}</td>
                                        <td>${log.name}</td>
                                        <td>${log.code}</td>
                                        <td>${log.message}</td>
                                        <td><pre>${JSON.stringify(log.details, null, 2)}</pre></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </body>
                </html>
            `);
        }
    </script>

    <!-- Load the actual implementation -->
    <script src="js/laporanTransaksiSimpananAnggota.js"></script>
</body>
</html>
