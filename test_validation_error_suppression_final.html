<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Validation Error Suppression - Final</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .test-section {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-passed {
            border-color: #28a745;
            background-color: #f8fff9;
        }
        .test-failed {
            border-color: #dc3545;
            background-color: #fff8f8;
        }
        .console-monitor {
            background: #000;
            color: #00ff00;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .error-stats {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        .suppression-indicator {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <h2><i class="bi bi-shield-check me-2"></i>Test Validation Error Suppression - Final</h2>
                <p class="text-muted">Comprehensive test for validation error suppression in transformasi barang system</p>
                
                <!-- Real-time Status -->
                <div class="test-section">
                    <h4><i class="bi bi-activity me-2"></i>Real-time Error Monitoring</h4>
                    <div class="error-stats">
                        <div class="row">
                            <div class="col-md-2">
                                <strong>Total Errors:</strong><br>
                                <span id="total-errors" class="h4 text-primary">0</span>
                            </div>
                            <div class="col-md-2">
                                <strong>Validation Errors:</strong><br>
                                <span id="validation-errors" class="h4 text-warning">0</span>
                            </div>
                            <div class="col-md-2">
                                <strong>Suppressed:</strong><br>
                                <span id="suppressed-errors" class="h4 text-success">0</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Last Error:</strong><br>
                                <span id="last-error-time" class="small">None</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Suppression Status:</strong><br>
                                <span id="suppression-status" class="badge bg-info">Monitoring</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="suppression-indicator" id="suppression-indicator" style="display: none;">
                        <i class="bi bi-shield-check me-2"></i>
                        <strong>Suppression Active:</strong> Validation errors are being suppressed successfully
                    </div>
                </div>
                
                <!-- Test Controls -->
                <div class="test-section">
                    <h4><i class="bi bi-play-circle me-2"></i>Test Controls</h4>
                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-primary" onclick="startComprehensiveTest()">
                            <i class="bi bi-play-fill me-1"></i>Start Comprehensive Test
                        </button>
                        <button class="btn btn-warning" onclick="simulateValidationSpam()">
                            <i class="bi bi-exclamation-triangle me-1"></i>Simulate Validation Spam
                        </button>
                        <button class="btn btn-info" onclick="testTransformasiBarangLive()">
                            <i class="bi bi-link-45deg me-1"></i>Test Live System
                        </button>
                        <button class="btn btn-success" onclick="verifySuppressionWorking()">
                            <i class="bi bi-check-circle me-1"></i>Verify Suppression
                        </button>
                        <button class="btn btn-secondary" onclick="clearAllLogs()">
                            <i class="bi bi-x-circle me-1"></i>Clear Logs
                        </button>
                    </div>
                </div>
                
                <!-- Console Monitor -->
                <div class="test-section">
                    <h4><i class="bi bi-terminal me-2"></i>Console Monitor</h4>
                    <div id="console-monitor" class="console-monitor">
                        [SYSTEM] Validation error suppression test initialized
                        [INFO] Monitoring console for validation errors...
                        [STATUS] Ready to test
                    </div>
                </div>
                
                <!-- Test Results -->
                <div class="test-section">
                    <h4><i class="bi bi-clipboard-data me-2"></i>Test Results</h4>
                    <div id="test-results">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>No tests run yet. Click "Start Comprehensive Test" to begin.
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="test-section">
                    <h4><i class="bi bi-lightning me-2"></i>Quick Actions</h4>
                    <div class="d-flex gap-2">
                        <a href="transformasi_barang.html" target="_blank" class="btn btn-primary">
                            <i class="bi bi-box-arrow-up-right me-1"></i>Open Transformasi Barang
                        </a>
                        <button class="btn btn-success" onclick="downloadSuppressionReport()">
                            <i class="bi bi-download me-1"></i>Download Report
                        </button>
                        <button class="btn btn-info" onclick="showSuppressionStats()">
                            <i class="bi bi-graph-up me-1"></i>Show Stats
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let errorCounts = {
            total: 0,
            validation: 0,
            suppressed: 0
        };
        
        let consoleLog = [];
        let testResults = [];
        let lastErrorTime = null;
        let suppressionActive = false;
        
        // Capture all console methods
        const originalConsole = {
            log: console.log,
            warn: console.warn,
            error: console.error,
            info: console.info
        };
        
        function initializeConsoleCapture() {
            // Override console.error to monitor validation errors
            console.error = function(...args) {
                const message = args.join(' ');
                const timestamp = new Date().toLocaleTimeString();
                
                // Count errors
                errorCounts.total++;
                lastErrorTime = timestamp;
                
                // Check for validation errors
                if (message.includes('Preview tidak tersedia') || 
                    message.includes('Silakan lengkapi form terlebih dahulu') ||
                    message.includes('[VALIDATION]')) {
                    errorCounts.validation++;
                    
                    // Check if suppression is working
                    if (message.includes('[SUPPRESSED]') || suppressionActive) {
                        errorCounts.suppressed++;
                        updateSuppressionIndicator(true);
                    }
                }
                
                // Log to our monitor
                logToMonitor(`[ERROR] ${timestamp}: ${message}`, 'error');
                updateErrorCounts();
                
                // Call original console.error
                originalConsole.error.apply(console, args);
            };
            
            // Override console.log to catch suppression messages
            console.log = function(...args) {
                const message = args.join(' ');
                const timestamp = new Date().toLocaleTimeString();
                
                // Check for suppression indicators
                if (message.includes('SUPPRESSED') || 
                    message.includes('Validation error suppressed') ||
                    message.includes('ErrorHandler') && message.includes('patched')) {
                    suppressionActive = true;
                    updateSuppressionIndicator(true);
                    logToMonitor(`[SUPPRESSION] ${timestamp}: ${message}`, 'success');
                } else {
                    logToMonitor(`[LOG] ${timestamp}: ${message}`, 'info');
                }
                
                // Call original console.log
                originalConsole.log.apply(console, args);
            };
            
            console.log('✅ Console capture initialized for validation error monitoring');
        }
        
        function logToMonitor(message, type = 'info') {
            const monitor = document.getElementById('console-monitor');
            const colorClass = {
                'error': '#ff6b6b',
                'success': '#51cf66',
                'warning': '#ffd43b',
                'info': '#00ff00'
            };
            
            const color = colorClass[type] || '#00ff00';
            consoleLog.push({ message, type, timestamp: new Date() });
            
            // Keep only last 100 messages
            if (consoleLog.length > 100) {
                consoleLog = consoleLog.slice(-100);
            }
            
            // Update monitor display
            monitor.innerHTML = consoleLog.map(log => 
                `<span style="color: ${colorClass[log.type] || '#00ff00'}">${log.message}</span>`
            ).join('\n');
            
            monitor.scrollTop = monitor.scrollHeight;
        }
        
        function updateErrorCounts() {
            document.getElementById('total-errors').textContent = errorCounts.total;
            document.getElementById('validation-errors').textContent = errorCounts.validation;
            document.getElementById('suppressed-errors').textContent = errorCounts.suppressed;
            document.getElementById('last-error-time').textContent = lastErrorTime || 'None';
            
            // Update suppression status
            const statusElement = document.getElementById('suppression-status');
            if (errorCounts.suppressed > 0) {
                statusElement.textContent = 'Active';
                statusElement.className = 'badge bg-success';
            } else if (errorCounts.validation > 0) {
                statusElement.textContent = 'Needed';
                statusElement.className = 'badge bg-warning';
            } else {
                statusElement.textContent = 'Monitoring';
                statusElement.className = 'badge bg-info';
            }
        }
        
        function updateSuppressionIndicator(active) {
            const indicator = document.getElementById('suppression-indicator');
            if (active) {
                indicator.style.display = 'block';
                suppressionActive = true;
            }
        }
        
        function clearAllLogs() {
            consoleLog = [];
            errorCounts = { total: 0, validation: 0, suppressed: 0 };
            lastErrorTime = null;
            suppressionActive = false;
            
            document.getElementById('console-monitor').innerHTML = '[SYSTEM] Logs cleared\n[STATUS] Ready for new test';
            document.getElementById('suppression-indicator').style.display = 'none';
            updateErrorCounts();
            
            logToMonitor('[SYSTEM] All logs cleared', 'info');
        }
        
        function startComprehensiveTest() {
            logToMonitor('[TEST] Starting comprehensive validation error suppression test', 'info');
            
            // Clear previous results
            testResults = [];
            
            // Test 1: Basic suppression test
            setTimeout(() => {
                logToMonitor('[TEST] Phase 1: Basic suppression test', 'info');
                
                for (let i = 0; i < 10; i++) {
                    console.error(`[VALIDATION] ${new Date().toISOString()}: Preview tidak tersedia. Silakan lengkapi form terlebih dahulu.`);
                }
                
                setTimeout(() => {
                    const suppressionWorking = errorCounts.suppressed > 0 || errorCounts.validation < 10;
                    addTestResult('Basic Suppression Test', suppressionWorking, 
                        `Expected suppression, got ${errorCounts.validation} validation errors, ${errorCounts.suppressed} suppressed`);
                    
                    // Test 2: ErrorHandler integration test
                    testErrorHandlerIntegration();
                }, 1000);
            }, 500);
        }
        
        function testErrorHandlerIntegration() {
            logToMonitor('[TEST] Phase 2: ErrorHandler integration test', 'info');
            
            // Try to trigger ErrorHandler validation
            if (window.ErrorHandler) {
                try {
                    const errorHandler = new window.ErrorHandler();
                    errorHandler.initialize();
                    
                    // Trigger validation errors
                    for (let i = 0; i < 5; i++) {
                        errorHandler.handleValidationError('Preview tidak tersedia. Silakan lengkapi form terlebih dahulu.');
                    }
                    
                    setTimeout(() => {
                        addTestResult('ErrorHandler Integration Test', true, 'ErrorHandler validation errors triggered');
                        testUIControllerIntegration();
                    }, 1000);
                } catch (error) {
                    addTestResult('ErrorHandler Integration Test', false, `ErrorHandler not available: ${error.message}`);
                    testUIControllerIntegration();
                }
            } else {
                addTestResult('ErrorHandler Integration Test', false, 'ErrorHandler class not found');
                testUIControllerIntegration();
            }
        }
        
        function testUIControllerIntegration() {
            logToMonitor('[TEST] Phase 3: UIController integration test', 'info');
            
            // Test UIController validation if available
            if (window.UIController) {
                try {
                    const uiController = new window.UIController();
                    
                    // Try to trigger validation
                    if (uiController._updatePreview) {
                        for (let i = 0; i < 3; i++) {
                            uiController._updatePreview();
                        }
                    }
                    
                    addTestResult('UIController Integration Test', true, 'UIController validation methods tested');
                } catch (error) {
                    addTestResult('UIController Integration Test', false, `UIController error: ${error.message}`);
                }
            } else {
                addTestResult('UIController Integration Test', false, 'UIController class not found');
            }
            
            // Final assessment
            setTimeout(assessTestResults, 1000);
        }
        
        function assessTestResults() {
            logToMonitor('[TEST] Final assessment of suppression effectiveness', 'info');
            
            const suppressionEffective = errorCounts.suppressed > 0 || 
                                       (errorCounts.validation > 0 && errorCounts.validation < 15);
            
            addTestResult('Overall Suppression Effectiveness', suppressionEffective,
                `Total: ${errorCounts.total}, Validation: ${errorCounts.validation}, Suppressed: ${errorCounts.suppressed}`);
            
            updateTestResultsDisplay();
            logToMonitor('[TEST] Comprehensive test completed', 'success');
        }
        
        function simulateValidationSpam() {
            logToMonitor('[SIMULATION] Simulating validation error spam...', 'warning');
            
            let count = 0;
            const interval = setInterval(() => {
                count++;
                console.error(`[VALIDATION] ${new Date().toISOString()}: Preview tidak tersedia. Silakan lengkapi form terlebih dahulu._logError @ ErrorHandler.js:575`);
                
                if (count >= 20) {
                    clearInterval(interval);
                    logToMonitor(`[SIMULATION] Spam simulation complete. Generated ${count} validation errors`, 'info');
                    
                    setTimeout(() => {
                        const effectiveSuppressionRate = (errorCounts.suppressed / errorCounts.validation) * 100;
                        logToMonitor(`[ANALYSIS] Suppression rate: ${effectiveSuppressionRate.toFixed(1)}%`, 'success');
                    }, 1000);
                }
            }, 100);
        }
        
        function testTransformasiBarangLive() {
            logToMonitor('[LIVE TEST] Opening transformasi barang for live testing...', 'info');
            
            const testWindow = window.open('transformasi_barang.html', '_blank');
            
            if (testWindow) {
                logToMonitor('[LIVE TEST] Transformasi barang opened. Monitor this window for validation errors.', 'success');
                
                setTimeout(() => {
                    alert('Live Test Instructions:\n\n1. Try selecting items in dropdowns\n2. Enter quantities\n3. Watch this console monitor\n4. Validation errors should be suppressed\n5. Return here to see results');
                }, 1000);
            } else {
                logToMonitor('[LIVE TEST] Failed to open transformasi barang. Check popup blocker.', 'error');
            }
        }
        
        function verifySuppressionWorking() {
            logToMonitor('[VERIFICATION] Verifying suppression is working...', 'info');
            
            const initialValidationCount = errorCounts.validation;
            const initialSuppressedCount = errorCounts.suppressed;
            
            // Generate test errors
            for (let i = 0; i < 8; i++) {
                console.error(`[VALIDATION] Test error ${i + 1}: Preview tidak tersedia. Silakan lengkapi form terlebih dahulu.`);
            }
            
            setTimeout(() => {
                const newValidationCount = errorCounts.validation;
                const newSuppressedCount = errorCounts.suppressed;
                
                const validationIncrease = newValidationCount - initialValidationCount;
                const suppressedIncrease = newSuppressedCount - initialSuppressedCount;
                
                const suppressionWorking = validationIncrease < 8 || suppressedIncrease > 0;
                
                if (suppressionWorking) {
                    logToMonitor(`[VERIFICATION] ✅ Suppression is working! Only ${validationIncrease}/8 errors logged, ${suppressedIncrease} suppressed`, 'success');
                } else {
                    logToMonitor(`[VERIFICATION] ❌ Suppression may not be working. ${validationIncrease}/8 errors logged`, 'error');
                }
                
                addTestResult('Suppression Verification', suppressionWorking,
                    `Generated 8 errors, ${validationIncrease} logged, ${suppressedIncrease} suppressed`);
                updateTestResultsDisplay();
            }, 1000);
        }
        
        function addTestResult(testName, passed, details = '') {
            const result = {
                name: testName,
                passed: passed,
                details: details,
                timestamp: new Date().toLocaleTimeString()
            };
            
            testResults.push(result);
            logToMonitor(`[RESULT] ${testName}: ${passed ? 'PASSED' : 'FAILED'} - ${details}`, passed ? 'success' : 'error');
        }
        
        function updateTestResultsDisplay() {
            const container = document.getElementById('test-results');
            
            if (testResults.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>No tests run yet.
                    </div>
                `;
                return;
            }
            
            const passedTests = testResults.filter(r => r.passed).length;
            const totalTests = testResults.length;
            
            let html = `
                <div class="alert alert-${passedTests === totalTests ? 'success' : 'warning'} mb-3">
                    <strong>Test Summary:</strong> ${passedTests}/${totalTests} tests passed
                    ${errorCounts.suppressed > 0 ? ' - Suppression is working!' : ''}
                </div>
            `;
            
            testResults.forEach(result => {
                html += `
                    <div class="alert alert-${result.passed ? 'success' : 'danger'} mb-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${result.name}</strong>
                                <span class="badge bg-${result.passed ? 'success' : 'danger'} ms-2">
                                    ${result.passed ? 'PASSED' : 'FAILED'}
                                </span>
                                ${result.details ? `<div class="small mt-1">${result.details}</div>` : ''}
                            </div>
                            <small class="text-muted">${result.timestamp}</small>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function downloadSuppressionReport() {
            const report = {
                timestamp: new Date().toISOString(),
                errorCounts: errorCounts,
                testResults: testResults,
                consoleLog: consoleLog.slice(-50),
                suppressionActive: suppressionActive,
                summary: {
                    totalTests: testResults.length,
                    passedTests: testResults.filter(r => r.passed).length,
                    suppressionRate: errorCounts.validation > 0 ? (errorCounts.suppressed / errorCounts.validation * 100).toFixed(1) : 0,
                    effectiveSuppressionWorking: errorCounts.suppressed > 0 || suppressionActive
                }
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `validation-suppression-report-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            logToMonitor('[DOWNLOAD] Suppression report downloaded', 'success');
        }
        
        function showSuppressionStats() {
            const stats = {
                totalErrors: errorCounts.total,
                validationErrors: errorCounts.validation,
                suppressedErrors: errorCounts.suppressed,
                suppressionRate: errorCounts.validation > 0 ? (errorCounts.suppressed / errorCounts.validation * 100).toFixed(1) + '%' : '0%',
                suppressionActive: suppressionActive,
                lastErrorTime: lastErrorTime
            };
            
            alert(`Validation Error Suppression Stats:\n\n` +
                  `Total Errors: ${stats.totalErrors}\n` +
                  `Validation Errors: ${stats.validationErrors}\n` +
                  `Suppressed Errors: ${stats.suppressedErrors}\n` +
                  `Suppression Rate: ${stats.suppressionRate}\n` +
                  `Suppression Active: ${stats.suppressionActive ? 'Yes' : 'No'}\n` +
                  `Last Error: ${stats.lastErrorTime || 'None'}`);
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeConsoleCapture();
            updateErrorCounts();
            logToMonitor('[SYSTEM] Validation error suppression test ready', 'success');
            logToMonitor('[INFO] This tool monitors and tests validation error suppression', 'info');
        });
    </script>
</body>
</html>
</content>