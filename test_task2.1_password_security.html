<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Task 2.1: Password Security Improvements</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .test-section {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .test-result {
            padding: 0.5rem;
            border-radius: 0.25rem;
            margin: 0.5rem 0;
        }
        .test-pass {
            background-color: #d1e7dd;
            border: 1px solid #badbcc;
            color: #0f5132;
        }
        .test-fail {
            background-color: #f8d7da;
            border: 1px solid #f5c2c7;
            color: #842029;
        }
        .password-strength-container {
            border: 1px solid #e9ecef;
            border-radius: 0.25rem;
            padding: 0.75rem;
            margin: 0.5rem 0;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="bi bi-shield-lock me-2"></i>
                    Test Task 2.1: Password Security Improvements
                </h1>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Testing:</strong> Enhanced password security features including strength validation, 
                    hashing, password history, and strength indicators.
                </div>

                <!-- Test 1: Password Strength Validation -->
                <div class="test-section">
                    <h3><i class="bi bi-1-circle me-2"></i>Password Strength Validation</h3>
                    <p>Testing password strength validation with various password combinations.</p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Test Password:</label>
                            <input type="password" class="form-control" id="testPassword" 
                                   placeholder="Enter password to test strength">
                            <div id="testPasswordStrength"></div>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-primary" onclick="testPasswordStrengths()">
                                <i class="bi bi-play-circle me-1"></i>Run Strength Tests
                            </button>
                            <div id="strengthTestResults" class="mt-3"></div>
                        </div>
                    </div>
                </div>

                <!-- Test 2: Password Hashing -->
                <div class="test-section">
                    <h3><i class="bi bi-2-circle me-2"></i>Password Hashing & Verification</h3>
                    <p>Testing password hashing and verification functions.</p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Password to Hash:</label>
                            <input type="password" class="form-control" id="hashTestPassword" 
                                   placeholder="Enter password to hash">
                            <button class="btn btn-secondary mt-2" onclick="testPasswordHashing()">
                                <i class="bi bi-hash me-1"></i>Test Hashing
                            </button>
                        </div>
                        <div class="col-md-6">
                            <div id="hashTestResults"></div>
                        </div>
                    </div>
                </div>

                <!-- Test 3: Password History -->
                <div class="test-section">
                    <h3><i class="bi bi-3-circle me-2"></i>Password History & Reuse Prevention</h3>
                    <p>Testing password history tracking and reuse prevention.</p>
                    
                    <button class="btn btn-warning" onclick="testPasswordHistory()">
                        <i class="bi bi-clock-history me-1"></i>Test Password History
                    </button>
                    <div id="historyTestResults" class="mt-3"></div>
                </div>

                <!-- Test 4: User Management Integration -->
                <div class="test-section">
                    <h3><i class="bi bi-4-circle me-2"></i>User Management Integration</h3>
                    <p>Testing password security integration with user management.</p>
                    
                    <button class="btn btn-success" onclick="openUserModal()">
                        <i class="bi bi-person-plus me-1"></i>Test User Creation Modal
                    </button>
                    <div id="userTestResults" class="mt-3"></div>
                </div>

                <!-- Test 5: Migration Test -->
                <div class="test-section">
                    <h3><i class="bi bi-5-circle me-2"></i>Legacy Password Migration</h3>
                    <p>Testing migration from plain text to hashed passwords.</p>
                    
                    <button class="btn btn-info" onclick="testPasswordMigration()">
                        <i class="bi bi-arrow-repeat me-1"></i>Test Migration
                    </button>
                    <div id="migrationTestResults" class="mt-3"></div>
                </div>

                <!-- Overall Results -->
                <div class="test-section">
                    <h3><i class="bi bi-check-circle me-2"></i>Overall Test Results</h3>
                    <div id="overallResults">
                        <p class="text-muted">Run tests to see overall results...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Modal (copied from auth.js for testing) -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-person-plus me-2"></i><span id="userModalTitle">Test User Creation</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <input type="hidden" id="userId">
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-person me-1"></i>Username
                            </label>
                            <input type="text" class="form-control" id="userUsername" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-lock me-1"></i>Password
                            </label>
                            <input type="password" class="form-control" id="userPassword" required>
                            <div id="userPasswordStrength" class="mt-2"></div>
                            <small class="text-muted" id="passwordHint">Minimal 8 karakter dengan huruf besar, kecil, angka, dan karakter khusus</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-person-badge me-1"></i>Nama Lengkap
                            </label>
                            <input type="text" class="form-control" id="userName" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Batal
                    </button>
                    <button type="button" class="btn btn-primary" onclick="testUserCreation()">
                        <i class="bi bi-save me-1"></i>Test Creation
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let testResults = {
            passwordStrength: false,
            passwordHashing: false,
            passwordHistory: false,
            userIntegration: false,
            migration: false
        };

        // Initialize password strength indicator for test input
        document.addEventListener('DOMContentLoaded', function() {
            setupPasswordStrengthIndicator('testPassword', 'testPasswordStrength');
        });

        function testPasswordStrengths() {
            const testPasswords = [
                { password: '123', expected: 'weak' },
                { password: 'password', expected: 'weak' },
                { password: 'Password1', expected: 'fair' },
                { password: 'Password1!', expected: 'good' },
                { password: 'MyStr0ng!P@ssw0rd', expected: 'strong' },
                { password: 'VeryC0mpl3x!P@ssw0rd#2024', expected: 'very_strong' }
            ];

            let results = '<h5>Password Strength Test Results:</h5>';
            let allPassed = true;

            testPasswords.forEach((test, index) => {
                const validation = validatePasswordStrength(test.password);
                const passed = validation.isValid || test.expected === 'weak' || test.expected === 'fair';
                
                results += `
                    <div class="test-result ${passed ? 'test-pass' : 'test-fail'}">
                        <strong>Test ${index + 1}:</strong> "${test.password}" 
                        <br><small>Strength: ${validation.strengthText} | Valid: ${validation.isValid}</small>
                        ${passed ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>'}
                    </div>
                `;
                
                if (!passed) allPassed = false;
            });

            document.getElementById('strengthTestResults').innerHTML = results;
            testResults.passwordStrength = allPassed;
            updateOverallResults();
        }

        function testPasswordHashing() {
            const password = document.getElementById('hashTestPassword').value;
            if (!password) {
                alert('Please enter a password to test');
                return;
            }

            try {
                // Test hashing
                const hashed = hashPassword(password);
                const isValidFormat = hashed.includes(':');
                
                // Test verification
                const verifyCorrect = verifyPassword(password, hashed);
                const verifyIncorrect = verifyPassword('wrongpassword', hashed);

                let results = '<h5>Password Hashing Test Results:</h5>';
                results += `
                    <div class="test-result ${isValidFormat ? 'test-pass' : 'test-fail'}">
                        <strong>Hash Format:</strong> ${isValidFormat ? 'Valid (contains salt:hash)' : 'Invalid'}
                        ${isValidFormat ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>'}
                    </div>
                    <div class="test-result ${verifyCorrect ? 'test-pass' : 'test-fail'}">
                        <strong>Correct Password Verification:</strong> ${verifyCorrect ? 'Passed' : 'Failed'}
                        ${verifyCorrect ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>'}
                    </div>
                    <div class="test-result ${!verifyIncorrect ? 'test-pass' : 'test-fail'}">
                        <strong>Incorrect Password Rejection:</strong> ${!verifyIncorrect ? 'Passed' : 'Failed'}
                        ${!verifyIncorrect ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>'}
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">Hashed: ${hashed}</small>
                    </div>
                `;

                document.getElementById('hashTestResults').innerHTML = results;
                testResults.passwordHashing = isValidFormat && verifyCorrect && !verifyIncorrect;
                updateOverallResults();
            } catch (error) {
                document.getElementById('hashTestResults').innerHTML = `
                    <div class="test-result test-fail">
                        <strong>Error:</strong> ${error.message}
                        <i class="bi bi-x-circle text-danger"></i>
                    </div>
                `;
                testResults.passwordHashing = false;
                updateOverallResults();
            }
        }

        function testPasswordHistory() {
            try {
                const testPasswords = ['Password1!', 'NewPass2@', 'Another3#'];
                let history = [];

                // Test adding passwords to history
                testPasswords.forEach(password => {
                    const hashed = hashPassword(password);
                    history = addToPasswordHistory(history, hashed);
                });

                // Test reuse detection
                const reuseTest1 = isPasswordReused('Password1!', history);
                const reuseTest2 = isPasswordReused('UniquePass4$', history);

                let results = '<h5>Password History Test Results:</h5>';
                results += `
                    <div class="test-result ${history.length === 3 ? 'test-pass' : 'test-fail'}">
                        <strong>History Length:</strong> ${history.length}/3 passwords stored
                        ${history.length === 3 ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>'}
                    </div>
                    <div class="test-result ${reuseTest1 ? 'test-pass' : 'test-fail'}">
                        <strong>Reuse Detection (Old Password):</strong> ${reuseTest1 ? 'Detected' : 'Not Detected'}
                        ${reuseTest1 ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>'}
                    </div>
                    <div class="test-result ${!reuseTest2 ? 'test-pass' : 'test-fail'}">
                        <strong>New Password Acceptance:</strong> ${!reuseTest2 ? 'Accepted' : 'Rejected'}
                        ${!reuseTest2 ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>'}
                    </div>
                `;

                document.getElementById('historyTestResults').innerHTML = results;
                testResults.passwordHistory = history.length === 3 && reuseTest1 && !reuseTest2;
                updateOverallResults();
            } catch (error) {
                document.getElementById('historyTestResults').innerHTML = `
                    <div class="test-result test-fail">
                        <strong>Error:</strong> ${error.message}
                        <i class="bi bi-x-circle text-danger"></i>
                    </div>
                `;
                testResults.passwordHistory = false;
                updateOverallResults();
            }
        }

        function openUserModal() {
            // Clear form
            document.getElementById('userForm').reset();
            document.getElementById('userUsername').value = 'testuser';
            document.getElementById('userName').value = 'Test User';
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('userModal'));
            modal.show();
            
            // Initialize password strength indicator
            setTimeout(() => {
                setupPasswordStrengthIndicator('userPassword', 'userPasswordStrength');
                
                document.getElementById('userTestResults').innerHTML = `
                    <div class="test-result test-pass">
                        <strong>Modal Integration:</strong> Password strength indicator loaded successfully
                        <i class="bi bi-check-circle text-success"></i>
                    </div>
                `;
                testResults.userIntegration = true;
                updateOverallResults();
            }, 100);
        }

        function testUserCreation() {
            const password = document.getElementById('userPassword').value;
            if (!password) {
                alert('Please enter a password to test');
                return;
            }

            const validation = validatePasswordStrength(password);
            const modal = bootstrap.Modal.getInstance(document.getElementById('userModal'));
            modal.hide();

            let results = '<h5>User Creation Test Results:</h5>';
            results += `
                <div class="test-result ${validation.isValid ? 'test-pass' : 'test-fail'}">
                    <strong>Password Validation:</strong> ${validation.isValid ? 'Passed' : 'Failed'}
                    <br><small>Strength: ${validation.strengthText}</small>
                    ${validation.isValid ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>'}
                </div>
            `;

            if (!validation.isValid) {
                results += `
                    <div class="alert alert-warning mt-2">
                        <strong>Validation Errors:</strong><br>
                        ${validation.feedback.join('<br>')}
                    </div>
                `;
            }

            document.getElementById('userTestResults').innerHTML = results;
            testResults.userIntegration = validation.isValid;
            updateOverallResults();
        }

        function testPasswordMigration() {
            try {
                // Simulate legacy user with plain text password
                const legacyUser = {
                    id: 1,
                    username: 'legacy_user',
                    password: 'plaintext123'
                };

                // Test migration logic (simulate what happens in handleLogin)
                const password = 'plaintext123';
                let migrationSuccess = false;

                if (legacyUser.password === password) {
                    // This would trigger migration in real scenario
                    const hashedPassword = hashPassword(password);
                    const verificationWorks = verifyPassword(password, hashedPassword);
                    migrationSuccess = verificationWorks;
                }

                let results = '<h5>Password Migration Test Results:</h5>';
                results += `
                    <div class="test-result ${migrationSuccess ? 'test-pass' : 'test-fail'}">
                        <strong>Legacy Password Migration:</strong> ${migrationSuccess ? 'Successful' : 'Failed'}
                        <br><small>Plain text password converted to hashed format</small>
                        ${migrationSuccess ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>'}
                    </div>
                `;

                document.getElementById('migrationTestResults').innerHTML = results;
                testResults.migration = migrationSuccess;
                updateOverallResults();
            } catch (error) {
                document.getElementById('migrationTestResults').innerHTML = `
                    <div class="test-result test-fail">
                        <strong>Error:</strong> ${error.message}
                        <i class="bi bi-x-circle text-danger"></i>
                    </div>
                `;
                testResults.migration = false;
                updateOverallResults();
            }
        }

        function updateOverallResults() {
            const totalTests = Object.keys(testResults).length;
            const passedTests = Object.values(testResults).filter(result => result === true).length;
            const allPassed = passedTests === totalTests;

            let overallHtml = `
                <div class="test-result ${allPassed ? 'test-pass' : 'test-fail'}">
                    <h5>
                        ${allPassed ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>'}
                        Overall Status: ${passedTests}/${totalTests} tests passed
                    </h5>
                    <div class="progress mt-2">
                        <div class="progress-bar ${allPassed ? 'bg-success' : 'bg-warning'}" 
                             style="width: ${(passedTests/totalTests)*100}%">
                            ${Math.round((passedTests/totalTests)*100)}%
                        </div>
                    </div>
                </div>
            `;

            // Show individual test status
            overallHtml += '<div class="mt-3"><h6>Individual Test Status:</h6><ul class="list-unstyled">';
            Object.entries(testResults).forEach(([test, passed]) => {
                const testName = test.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                overallHtml += `
                    <li>
                        ${passed ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>'}
                        ${testName}
                    </li>
                `;
            });
            overallHtml += '</ul></div>';

            document.getElementById('overallResults').innerHTML = overallHtml;
        }

        // Run initial overall results update
        updateOverallResults();
    </script>
</body>
</html>