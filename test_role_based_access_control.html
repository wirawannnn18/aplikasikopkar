<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Role-Based Access Control Test</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
        }
        
        .dashboard-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .dashboard-widget {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 10px;
            min-height: 120px;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: inline-block;
            width: 250px;
            vertical-align: top;
        }
        
        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .widget-title {
            font-size: 1rem;
            font-weight: 600;
            margin: 0;
            color: #333;
        }
        
        .widget-content {
            text-align: center;
            padding: 10px 0;
        }
        
        .widget-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007bff;
        }
        
        .widget-label {
            font-size: 0.85rem;
            color: #666;
        }
        
        .role-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 250px;
        }
        
        .permissions-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .permission-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .permission-item:last-child {
            border-bottom: none;
        }
        
        .permission-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 10px;
        }
        
        .permission-status.granted {
            background: #28a745;
        }
        
        .permission-status.denied {
            background: #dc3545;
        }
        
        .menu-item {
            padding: 8px 15px;
            margin: 5px 0;
            background: #e9ecef;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .menu-item.hidden {
            opacity: 0.3;
            text-decoration: line-through;
        }
        
        .user-info {
            background: #007bff;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .widget-sensitivity {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 3px;
            color: white;
        }
        
        .sensitivity-basic {
            background: #28a745;
        }
        
        .sensitivity-financial {
            background: #ffc107;
            color: #333;
        }
        
        .sensitivity-sensitive {
            background: #dc3545;
        }
        
        /* Role-specific themes */
        .theme-admin {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .theme-professional {
            background: #343a40;
            color: white;
        }
        
        .theme-business {
            background: #007bff;
            color: white;
        }
        
        .theme-standard {
            background: #28a745;
            color: white;
        }
        
        .theme-clean {
            background: #17a2b8;
            color: white;
        }
        
        .theme-minimal {
            background: #6c757d;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <h2>Role-Based Access Control Test</h2>
                <p class="text-muted">Test different user roles and their dashboard permissions</p>
            </div>
        </div>
        
        <!-- Current User Info -->
        <div class="row">
            <div class="col-md-8">
                <div class="user-info">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong id="current-user-name">Loading...</strong>
                            <div id="current-user-role" class="small">Role: Loading...</div>
                        </div>
                        <div>
                            <i class="fas fa-user-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Widgets -->
        <div class="dashboard-container">
            <h4>Dashboard Widgets</h4>
            <div id="widgets-container">
                <!-- Basic Widgets -->
                <div class="dashboard-widget" data-type="kpi" data-metric="basic">
                    <div class="widget-sensitivity sensitivity-basic">Basic</div>
                    <div class="widget-header">
                        <h6 class="widget-title">Total Members</h6>
                    </div>
                    <div class="widget-content">
                        <div class="widget-value">1,247</div>
                        <div class="widget-label">Active Members</div>
                    </div>
                </div>
                
                <div class="dashboard-widget" data-type="kpi" data-metric="basic">
                    <div class="widget-sensitivity sensitivity-basic">Basic</div>
                    <div class="widget-header">
                        <h6 class="widget-title">Daily Transactions</h6>
                    </div>
                    <div class="widget-content">
                        <div class="widget-value">156</div>
                        <div class="widget-label">Today</div>
                    </div>
                </div>
                
                <!-- Financial Widgets -->
                <div class="dashboard-widget" data-type="chart" data-metric="financial">
                    <div class="widget-sensitivity sensitivity-financial">Financial</div>
                    <div class="widget-header">
                        <h6 class="widget-title">Revenue Trends</h6>
                    </div>
                    <div class="widget-content">
                        <div class="widget-value">Rp 2.5M</div>
                        <div class="widget-label">This Month</div>
                    </div>
                </div>
                
                <div class="dashboard-widget" data-type="kpi" data-metric="financial">
                    <div class="widget-sensitivity sensitivity-financial">Financial</div>
                    <div class="widget-header">
                        <h6 class="widget-title">Total Savings</h6>
                    </div>
                    <div class="widget-content">
                        <div class="widget-value">Rp 15.2M</div>
                        <div class="widget-label">All Accounts</div>
                    </div>
                </div>
                
                <!-- Sensitive Widgets -->
                <div class="dashboard-widget" data-type="table" data-metric="sensitive">
                    <div class="widget-sensitivity sensitivity-sensitive">Sensitive</div>
                    <div class="widget-header">
                        <h6 class="widget-title">Member Financial Details</h6>
                    </div>
                    <div class="widget-content">
                        <div class="widget-value">Confidential</div>
                        <div class="widget-label">Personal Data</div>
                    </div>
                </div>
                
                <div class="dashboard-widget" data-type="chart" data-metric="sensitive">
                    <div class="widget-sensitivity sensitivity-sensitive">Sensitive</div>
                    <div class="widget-header">
                        <h6 class="widget-title">Audit Logs</h6>
                    </div>
                    <div class="widget-content">
                        <div class="widget-value">System</div>
                        <div class="widget-label">Security Data</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Menu Items -->
        <div class="dashboard-container">
            <h4>Menu Items</h4>
            <div class="row">
                <div class="col-md-6">
                    <div class="menu-item menu-analytics">
                        <span><i class="fas fa-chart-line"></i> Basic Analytics</span>
                        <span class="permission-status" data-permission="analytics.basic"></span>
                    </div>
                    <div class="menu-item menu-advanced-analytics">
                        <span><i class="fas fa-chart-area"></i> Advanced Analytics</span>
                        <span class="permission-status" data-permission="analytics.advanced"></span>
                    </div>
                    <div class="menu-item menu-export">
                        <span><i class="fas fa-download"></i> Export Reports</span>
                        <span class="permission-status" data-permission="analytics.export"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="menu-item menu-settings">
                        <span><i class="fas fa-cog"></i> System Settings</span>
                        <span class="permission-status" data-permission="system.settings"></span>
                    </div>
                    <div class="menu-item menu-user-management">
                        <span><i class="fas fa-users-cog"></i> User Management</span>
                        <span class="permission-status" data-permission="system.user_management"></span>
                    </div>
                    <div class="menu-item menu-audit">
                        <span><i class="fas fa-shield-alt"></i> Audit Logs</span>
                        <span class="permission-status" data-permission="system.audit"></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Customization Controls -->
        <div class="dashboard-container">
            <h4>Dashboard Controls</h4>
            <div class="d-flex gap-2 flex-wrap">
                <button id="customize-dashboard-btn" class="btn btn-primary">
                    <i class="fas fa-edit"></i> Customize Dashboard
                </button>
                <button id="add-widget-btn" class="btn btn-success">
                    <i class="fas fa-plus"></i> Add Widget
                </button>
                <button class="btn btn-info">
                    <i class="fas fa-download"></i> Export Data
                </button>
                <button class="btn btn-warning">
                    <i class="fas fa-cog"></i> Settings
                </button>
            </div>
        </div>
        
        <!-- Permissions Panel -->
        <div class="permissions-panel">
            <h5>Current Permissions</h5>
            <div id="permissions-list">
                <!-- Permissions will be populated by JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Mock Dashboard Controller -->
    <script>
        class MockDashboardController {
            constructor() {
                this.currentTemplate = null;
            }
            
            refresh() {
                console.log('Dashboard refreshed');
                // Simulate dashboard refresh
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            }
        }
    </script>
    
    <!-- Role-Based Access Control -->
    <script src="js/dashboard/RoleBasedAccessControl.js"></script>
    
    <script>
        // Initialize RBAC
        const mockController = new MockDashboardController();
        const rbac = new RoleBasedAccessControl(mockController);
        
        // Add role selector to page
        const roleSelector = rbac.createRoleSelector();
        document.body.appendChild(roleSelector);
        
        // Update UI based on current user
        function updateUI() {
            const user = rbac.getCurrentUser();
            
            // Update user info
            document.getElementById('current-user-name').textContent = user.name;
            document.getElementById('current-user-role').textContent = `Role: ${user.role}`;
            
            // Update permissions list
            updatePermissionsList();
            
            // Update menu item status
            updateMenuStatus();
            
            // Apply role restrictions
            rbac.applyRoleRestrictions();
        }
        
        // Update permissions list
        function updatePermissionsList() {
            const permissions = rbac.getUserPermissions();
            const allPermissions = [
                'dashboard.view',
                'dashboard.customize',
                'widgets.view_basic',
                'widgets.view_financial',
                'widgets.view_sensitive',
                'widgets.create',
                'analytics.basic',
                'analytics.advanced',
                'analytics.export',
                'system.settings',
                'system.user_management',
                'system.audit'
            ];
            
            const permissionsList = document.getElementById('permissions-list');
            permissionsList.innerHTML = '';
            
            allPermissions.forEach(permission => {
                const hasPermission = permissions.includes(permission);
                const item = document.createElement('div');
                item.className = 'permission-item';
                item.innerHTML = `
                    <span>${permission.replace(/[._]/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                    <span class="permission-status ${hasPermission ? 'granted' : 'denied'}"></span>
                `;
                permissionsList.appendChild(item);
            });
        }
        
        // Update menu status
        function updateMenuStatus() {
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => {
                const statusElement = item.querySelector('.permission-status');
                const permission = statusElement.dataset.permission;
                
                if (rbac.hasPermission(permission)) {
                    item.classList.remove('hidden');
                    statusElement.className = 'permission-status granted';
                } else {
                    item.classList.add('hidden');
                    statusElement.className = 'permission-status denied';
                }
            });
        }
        
        // Test role switching
        function testRoleSwitch() {
            const roles = ['viewer', 'staff', 'supervisor', 'manager', 'admin', 'super_admin'];
            let currentIndex = 0;
            
            setInterval(() => {
                const role = roles[currentIndex];
                console.log(`Switching to role: ${role}`);
                rbac.switchRole(role);
                currentIndex = (currentIndex + 1) % roles.length;
            }, 5000);
        }
        
        // Initialize UI
        updateUI();
        
        // Add event listeners
        document.addEventListener('click', (e) => {
            if (e.target.id === 'customize-dashboard-btn') {
                if (rbac.hasPermission('dashboard.customize')) {
                    alert('Customization mode activated!');
                } else {
                    alert('Access denied: Insufficient permissions');
                }
            }
            
            if (e.target.id === 'add-widget-btn') {
                if (rbac.hasPermission('widgets.create')) {
                    alert('Add widget dialog opened!');
                } else {
                    alert('Access denied: Cannot create widgets');
                }
            }
        });
        
        // Test widget filtering
        function testWidgetFiltering() {
            const widgets = [
                { type: 'kpi', metric: 'basic' },
                { type: 'chart', metric: 'financial' },
                { type: 'table', metric: 'sensitive', sensitivity: 'high' }
            ];
            
            const filtered = rbac.filterWidgetsByPermissions(widgets);
            console.log('Filtered widgets:', filtered);
        }
        
        // Keyboard shortcuts for testing
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case '1':
                        e.preventDefault();
                        rbac.switchRole('viewer');
                        break;
                    case '2':
                        e.preventDefault();
                        rbac.switchRole('staff');
                        break;
                    case '3':
                        e.preventDefault();
                        rbac.switchRole('supervisor');
                        break;
                    case '4':
                        e.preventDefault();
                        rbac.switchRole('manager');
                        break;
                    case '5':
                        e.preventDefault();
                        rbac.switchRole('admin');
                        break;
                    case '6':
                        e.preventDefault();
                        rbac.switchRole('super_admin');
                        break;
                }
            }
        });
        
        // Log available shortcuts
        console.log('Role-Based Access Control Test initialized');
        console.log('Keyboard shortcuts:');
        console.log('- Ctrl+1: Switch to Viewer');
        console.log('- Ctrl+2: Switch to Staff');
        console.log('- Ctrl+3: Switch to Supervisor');
        console.log('- Ctrl+4: Switch to Manager');
        console.log('- Ctrl+5: Switch to Admin');
        console.log('- Ctrl+6: Switch to Super Admin');
        
        // Test widget filtering
        testWidgetFiltering();
        
        // Uncomment to test automatic role switching
        // testRoleSwitch();
    </script>
</body>
</html>