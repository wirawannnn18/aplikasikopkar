<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Role-Based Access Control - Integrated Payment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .test-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .test-failure {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .test-info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        .log-viewer {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <h1><i class="bi bi-shield-check"></i> Test Role-Based Access Control</h1>
        <p class="text-muted">Testing tab-level permissions and security audit logging for integrated payment interface</p>

        <!-- User Context Controls -->
        <div class="test-section">
            <h3>User Context Controls</h3>
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Select Test User:</label>
                    <select class="form-select" id="userSelect" onchange="switchUser()">
                        <option value="">No User (Anonymous)</option>
                        <option value="super_admin">Super Admin</option>
                        <option value="administrator">Administrator</option>
                        <option value="kasir">Kasir</option>
                        <option value="keuangan">Keuangan</option>
                        <option value="inactive_user">Inactive User</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Current User Info:</label>
                    <div id="currentUserInfo" class="alert alert-info">
                        No user selected
                    </div>
                </div>
            </div>
        </div>

        <!-- Permission Tests -->
        <div class="test-section">
            <h3>Permission Tests</h3>
            <div class="row">
                <div class="col-md-6">
                    <button class="btn btn-primary me-2" onclick="testTabPermissions()">Test Tab Permissions</button>
                    <button class="btn btn-secondary me-2" onclick="testTabSwitching()">Test Tab Switching</button>
                    <button class="btn btn-info me-2" onclick="testAvailableTabs()">Test Available Tabs</button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-warning me-2" onclick="testPermissionViolations()">Test Violations</button>
                    <button class="btn btn-success me-2" onclick="clearTestResults()">Clear Results</button>
                </div>
            </div>
            <div id="permissionTestResults" class="mt-3"></div>
        </div>

        <!-- Security Audit Tests -->
        <div class="test-section">
            <h3>Security Audit Tests</h3>
            <div class="row">
                <div class="col-md-6">
                    <button class="btn btn-primary me-2" onclick="testSecurityLogging()">Test Security Logging</button>
                    <button class="btn btn-secondary me-2" onclick="testSuspiciousActivity()">Test Suspicious Activity</button>
                    <button class="btn btn-info me-2" onclick="viewSecurityLogs()">View Security Logs</button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-warning me-2" onclick="exportSecurityLogs()">Export Logs</button>
                    <button class="btn btn-danger me-2" onclick="clearSecurityLogs()">Clear Security Logs</button>
                </div>
            </div>
            <div id="securityTestResults" class="mt-3"></div>
        </div>

        <!-- Integrated Interface Test -->
        <div class="test-section">
            <h3>Integrated Interface Test</h3>
            <div class="row">
                <div class="col-md-12">
                    <button class="btn btn-success me-2" onclick="initializeIntegratedInterface()">Initialize Interface</button>
                    <button class="btn btn-primary me-2" onclick="testInterfacePermissions()">Test Interface Permissions</button>
                    <button class="btn btn-secondary me-2" onclick="destroyIntegratedInterface()">Destroy Interface</button>
                </div>
            </div>
            <div id="interfaceTestResults" class="mt-3"></div>
            <div id="integratedInterfaceContainer" class="mt-3" style="min-height: 200px; border: 1px solid #ddd; border-radius: 4px;"></div>
        </div>

        <!-- Security Logs Viewer -->
        <div class="test-section">
            <h3>Security Logs Viewer</h3>
            <div class="log-viewer" id="securityLogsViewer">
                Security logs will appear here...
            </div>
        </div>
    </div>

    <!-- Load Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Load Application Scripts -->
    <script src="js/shared/EnhancedAuditLogger.js"></script>
    <script src="js/shared/SecurityAuditLogger.js"></script>
    <script src="js/shared/TabPermissionManager.js"></script>
    <script src="js/shared/SharedPaymentServices.js"></script>
    <script src="js/pembayaranHutangPiutangIntegrated.js"></script>

    <script>
        // Test users for different roles
        const testUsers = {
            super_admin: {
                id: 1,
                username: 'superadmin',
                name: 'Super Administrator',
                role: 'super_admin',
                active: true
            },
            administrator: {
                id: 2,
                username: 'admin',
                name: 'Administrator',
                role: 'administrator',
                active: true
            },
            kasir: {
                id: 3,
                username: 'kasir1',
                name: 'Kasir Utama',
                role: 'kasir',
                active: true
            },
            keuangan: {
                id: 4,
                username: 'keuangan1',
                name: 'Staff Keuangan',
                role: 'keuangan',
                active: true
            },
            inactive_user: {
                id: 5,
                username: 'inactive',
                name: 'Inactive User',
                role: 'kasir',
                active: false
            }
        };

        let currentUser = null;
        let permissionManager = null;
        let securityAuditLogger = null;
        let integratedController = null;

        // Initialize test environment
        function initializeTestEnvironment() {
            try {
                // Initialize permission manager
                if (window.TabPermissionManager) {
                    permissionManager = new window.TabPermissionManager();
                    addTestResult('permissionTestResults', 'Permission manager initialized', 'success');
                } else {
                    addTestResult('permissionTestResults', 'TabPermissionManager not available', 'failure');
                }

                // Initialize security audit logger
                if (window.SecurityAuditLogger) {
                    securityAuditLogger = new window.SecurityAuditLogger();
                    addTestResult('securityTestResults', 'Security audit logger initialized', 'success');
                } else {
                    addTestResult('securityTestResults', 'SecurityAuditLogger not available', 'failure');
                }

                updateSecurityLogsViewer();
            } catch (error) {
                addTestResult('permissionTestResults', `Initialization error: ${error.message}`, 'failure');
            }
        }

        // Switch user context
        function switchUser() {
            const userSelect = document.getElementById('userSelect');
            const selectedUser = userSelect.value;
            
            if (selectedUser) {
                currentUser = testUsers[selectedUser];
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            } else {
                currentUser = null;
                localStorage.removeItem('currentUser');
            }

            // Update permission manager context
            if (permissionManager) {
                permissionManager.updateUserContext(currentUser);
            }

            // Update security audit logger context
            if (securityAuditLogger) {
                securityAuditLogger.updateUserContext(currentUser);
            }

            // Update UI
            updateCurrentUserInfo();
            
            addTestResult('permissionTestResults', 
                `User context switched to: ${currentUser ? currentUser.name : 'Anonymous'}`, 'info');
        }

        // Update current user info display
        function updateCurrentUserInfo() {
            const userInfo = document.getElementById('currentUserInfo');
            if (currentUser) {
                userInfo.innerHTML = `
                    <strong>${currentUser.name}</strong><br>
                    Role: ${currentUser.role}<br>
                    Status: ${currentUser.active ? 'Active' : 'Inactive'}
                `;
                userInfo.className = 'alert alert-success';
            } else {
                userInfo.innerHTML = 'No user selected';
                userInfo.className = 'alert alert-warning';
            }
        }

        // Test tab permissions
        function testTabPermissions() {
            if (!permissionManager) {
                addTestResult('permissionTestResults', 'Permission manager not initialized', 'failure');
                return;
            }

            const tabs = ['manual', 'import'];
            let results = [];

            tabs.forEach(tabId => {
                const hasAccess = permissionManager.hasTabAccess(tabId);
                const accessLevel = permissionManager.getTabAccessLevel(tabId);
                
                results.push(`${tabId}: ${hasAccess ? 'GRANTED' : 'DENIED'} (Level: ${accessLevel})`);
            });

            addTestResult('permissionTestResults', 
                `Tab permissions for ${currentUser ? currentUser.role : 'anonymous'}:<br>${results.join('<br>')}`, 
                'info');
        }

        // Test tab switching
        function testTabSwitching() {
            if (!permissionManager) {
                addTestResult('permissionTestResults', 'Permission manager not initialized', 'failure');
                return;
            }

            const switchTests = [
                { from: 'manual', to: 'import' },
                { from: 'import', to: 'manual' },
                { from: null, to: 'manual' },
                { from: null, to: 'import' }
            ];

            let results = [];

            switchTests.forEach(test => {
                const validation = permissionManager.validateTabSwitch(test.from, test.to);
                results.push(`${test.from || 'none'} â†’ ${test.to}: ${validation.allowed ? 'ALLOWED' : 'DENIED'} (${validation.reason})`);
            });

            addTestResult('permissionTestResults', 
                `Tab switching validation:<br>${results.join('<br>')}`, 
                'info');
        }

        // Test available tabs
        function testAvailableTabs() {
            if (!permissionManager) {
                addTestResult('permissionTestResults', 'Permission manager not initialized', 'failure');
                return;
            }

            const availableTabs = permissionManager.getAvailableTabs();
            
            if (availableTabs.length > 0) {
                const tabList = availableTabs.map(tab => 
                    `${tab.name} (${tab.id}) - ${tab.description}`
                ).join('<br>');
                
                addTestResult('permissionTestResults', 
                    `Available tabs (${availableTabs.length}):<br>${tabList}`, 
                    'success');
            } else {
                addTestResult('permissionTestResults', 'No tabs available for current user', 'warning');
            }
        }

        // Test permission violations
        function testPermissionViolations() {
            if (!permissionManager) {
                addTestResult('permissionTestResults', 'Permission manager not initialized', 'failure');
                return;
            }

            // Test access to restricted tab
            const restrictedAccess = permissionManager.checkTabAccessOrDeny('import', (tabId, user) => {
                addTestResult('permissionTestResults', 
                    `Access denied callback triggered for tab: ${tabId}`, 'warning');
            });

            addTestResult('permissionTestResults', 
                `Restricted tab access test: ${restrictedAccess ? 'GRANTED' : 'DENIED'}`, 
                restrictedAccess ? 'success' : 'warning');
        }

        // Test security logging
        function testSecurityLogging() {
            if (!securityAuditLogger) {
                addTestResult('securityTestResults', 'Security audit logger not initialized', 'failure');
                return;
            }

            // Test various security events
            securityAuditLogger.logTabAccessAttempt('manual', 'granted', {
                test: true,
                reason: 'test_access_granted'
            });

            securityAuditLogger.logTabAccessAttempt('import', 'denied', {
                test: true,
                reason: 'test_access_denied'
            });

            securityAuditLogger.logTabSwitchAttempt('manual', 'import', 'denied', {
                test: true,
                reason: 'test_switch_denied'
            });

            securityAuditLogger.logPermissionViolation('TEST_VIOLATION', {
                test: true,
                violationType: 'test_permission_violation'
            });

            addTestResult('securityTestResults', 'Security logging test completed', 'success');
            updateSecurityLogsViewer();
        }

        // Test suspicious activity detection
        function testSuspiciousActivity() {
            if (!securityAuditLogger) {
                addTestResult('securityTestResults', 'Security audit logger not initialized', 'failure');
                return;
            }

            // Simulate repeated access denials
            for (let i = 0; i < 6; i++) {
                securityAuditLogger.logTabAccessAttempt('import', 'denied', {
                    test: true,
                    repeated: true,
                    attempt: i + 1
                });
            }

            // Simulate rapid tab switching
            for (let i = 0; i < 12; i++) {
                securityAuditLogger.logTabSwitchAttempt('manual', 'import', 'success', {
                    test: true,
                    rapid: true,
                    switch: i + 1
                });
            }

            addTestResult('securityTestResults', 'Suspicious activity simulation completed', 'warning');
            updateSecurityLogsViewer();
        }

        // View security logs
        function viewSecurityLogs() {
            if (!securityAuditLogger) {
                addTestResult('securityTestResults', 'Security audit logger not initialized', 'failure');
                return;
            }

            const logs = securityAuditLogger.getSecurityLogs();
            addTestResult('securityTestResults', 
                `Retrieved ${logs.length} security log entries`, 'info');
            
            updateSecurityLogsViewer();
        }

        // Export security logs
        function exportSecurityLogs() {
            if (!securityAuditLogger) {
                addTestResult('securityTestResults', 'Security audit logger not initialized', 'failure');
                return;
            }

            const csvData = securityAuditLogger.exportSecurityLogs({}, 'csv');
            
            // Create download link
            const blob = new Blob([csvData], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `security_logs_${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            addTestResult('securityTestResults', 'Security logs exported to CSV', 'success');
        }

        // Clear security logs
        function clearSecurityLogs() {
            localStorage.removeItem('securityAuditLog');
            addTestResult('securityTestResults', 'Security logs cleared', 'info');
            updateSecurityLogsViewer();
        }

        // Initialize integrated interface
        function initializeIntegratedInterface() {
            try {
                if (window.PembayaranHutangPiutangIntegrated) {
                    integratedController = new window.PembayaranHutangPiutangIntegrated();
                    
                    // Mock the mainContent element
                    const container = document.getElementById('integratedInterfaceContainer');
                    container.innerHTML = '<div id="mainContent"></div>';
                    
                    integratedController.initialize().then(() => {
                        addTestResult('interfaceTestResults', 'Integrated interface initialized successfully', 'success');
                    }).catch(error => {
                        addTestResult('interfaceTestResults', `Interface initialization failed: ${error.message}`, 'failure');
                    });
                } else {
                    addTestResult('interfaceTestResults', 'PembayaranHutangPiutangIntegrated not available', 'failure');
                }
            } catch (error) {
                addTestResult('interfaceTestResults', `Interface initialization error: ${error.message}`, 'failure');
            }
        }

        // Test interface permissions
        function testInterfacePermissions() {
            if (!integratedController) {
                addTestResult('interfaceTestResults', 'Integrated controller not initialized', 'failure');
                return;
            }

            // Test tab switching with permissions
            const testSwitches = ['manual', 'import'];
            
            testSwitches.forEach(async (tabId) => {
                try {
                    const result = await integratedController.switchTab(tabId);
                    addTestResult('interfaceTestResults', 
                        `Switch to ${tabId}: ${result ? 'SUCCESS' : 'FAILED'}`, 
                        result ? 'success' : 'warning');
                } catch (error) {
                    addTestResult('interfaceTestResults', 
                        `Switch to ${tabId} error: ${error.message}`, 'failure');
                }
            });
        }

        // Destroy integrated interface
        function destroyIntegratedInterface() {
            if (integratedController) {
                integratedController.destroy();
                integratedController = null;
                document.getElementById('integratedInterfaceContainer').innerHTML = '';
                addTestResult('interfaceTestResults', 'Integrated interface destroyed', 'info');
            }
        }

        // Update security logs viewer
        function updateSecurityLogsViewer() {
            const viewer = document.getElementById('securityLogsViewer');
            
            try {
                const logs = JSON.parse(localStorage.getItem('securityAuditLog') || '[]');
                
                if (logs.length === 0) {
                    viewer.innerHTML = 'No security logs available';
                    return;
                }

                const logEntries = logs.slice(-10).reverse().map(log => {
                    const timestamp = new Date(log.timestamp).toLocaleString();
                    const eventType = log.eventType;
                    const user = log.details.userInfo?.userName || 'Unknown';
                    const riskLevel = log.details.riskLevel || 'unknown';
                    
                    return `[${timestamp}] ${eventType} - User: ${user} - Risk: ${riskLevel}`;
                }).join('\n');

                viewer.innerHTML = logEntries;
            } catch (error) {
                viewer.innerHTML = `Error loading logs: ${error.message}`;
            }
        }

        // Clear test results
        function clearTestResults() {
            document.getElementById('permissionTestResults').innerHTML = '';
            document.getElementById('securityTestResults').innerHTML = '';
            document.getElementById('interfaceTestResults').innerHTML = '';
        }

        // Add test result
        function addTestResult(containerId, message, type) {
            const container = document.getElementById(containerId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result test-${type}`;
            resultDiv.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            container.appendChild(resultDiv);
            
            // Auto-scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeTestEnvironment();
            updateCurrentUserInfo();
            
            // Auto-refresh logs viewer every 5 seconds
            setInterval(updateSecurityLogsViewer, 5000);
        });
    </script>
</body>
</html>