<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Task 1 Setup - Upload Master Barang Excel</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .test-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        
        .test-result {
            padding: 0.5rem;
            margin: 0.25rem 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.875rem;
        }
        
        .test-pass {
            background-color: #d1e7dd;
            color: #0f5132;
            border: 1px solid #badbcc;
        }
        
        .test-fail {
            background-color: #f8d7da;
            color: #842029;
            border: 1px solid #f5c2c7;
        }
        
        .test-info {
            background-color: #d1ecf1;
            color: #055160;
            border: 1px solid #b8daff;
        }
        
        .component-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-pass { background-color: #28a745; }
        .status-fail { background-color: #dc3545; }
        .status-pending { background-color: #ffc107; }
        
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
            font-family: monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="bi bi-gear-fill me-2"></i>
                            Task 1 Setup Test - Project Structure and Core Interfaces
                        </h4>
                    </div>
                    
                    <div class="card-body">
                        <!-- Test Overview -->
                        <div class="test-section">
                            <h5><i class="bi bi-info-circle me-2"></i>Test Overview</h5>
                            <p>This test verifies that Task 1 (Setup project structure and core interfaces) has been completed successfully.</p>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Requirements Tested:</h6>
                                    <ul>
                                        <li>Directory structure for upload components</li>
                                        <li>TypeScript interfaces for data models</li>
                                        <li>Testing framework setup</li>
                                        <li>Base HTML structure</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>Components Tested:</h6>
                                    <ul>
                                        <li>ExcelUploadManager</li>
                                        <li>ValidationEngine</li>
                                        <li>DataProcessor</li>
                                        <li>CategoryUnitManager</li>
                                        <li>AuditLogger</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Component Loading Test -->
                        <div class="test-section">
                            <h5><i class="bi bi-box-seam me-2"></i>Component Loading Test</h5>
                            <div id="componentLoadingResults">
                                <div class="test-result test-info">Running component loading tests...</div>
                            </div>
                        </div>

                        <!-- Interface Validation Test -->
                        <div class="test-section">
                            <h5><i class="bi bi-check2-square me-2"></i>Interface Validation Test</h5>
                            <div id="interfaceValidationResults">
                                <div class="test-result test-info">Running interface validation tests...</div>
                            </div>
                        </div>

                        <!-- Integration Test -->
                        <div class="test-section">
                            <h5><i class="bi bi-puzzle me-2"></i>Component Integration Test</h5>
                            <div id="integrationTestResults">
                                <div class="test-result test-info">Running integration tests...</div>
                            </div>
                        </div>

                        <!-- File Processing Test -->
                        <div class="test-section">
                            <h5><i class="bi bi-file-earmark-text me-2"></i>File Processing Test</h5>
                            <div id="fileProcessingResults">
                                <div class="test-result test-info">Running file processing tests...</div>
                            </div>
                            
                            <div class="mt-3">
                                <label for="testFileInput" class="form-label">Test with actual file:</label>
                                <input type="file" class="form-control" id="testFileInput" accept=".csv,.xlsx,.xls">
                                <small class="form-text text-muted">Upload a CSV or Excel file to test the processing pipeline</small>
                            </div>
                        </div>

                        <!-- Error Handling Test -->
                        <div class="test-section">
                            <h5><i class="bi bi-exclamation-triangle me-2"></i>Error Handling Test</h5>
                            <div id="errorHandlingResults">
                                <div class="test-result test-info">Running error handling tests...</div>
                            </div>
                        </div>

                        <!-- Test Summary -->
                        <div class="test-section">
                            <h5><i class="bi bi-clipboard-check me-2"></i>Test Summary</h5>
                            <div id="testSummary">
                                <div class="test-result test-info">Preparing test summary...</div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2 mt-4">
                            <button type="button" class="btn btn-primary" id="runAllTests">
                                <i class="bi bi-play-fill me-2"></i>Run All Tests
                            </button>
                            <button type="button" class="btn btn-secondary" id="clearResults">
                                <i class="bi bi-arrow-clockwise me-2"></i>Clear Results
                            </button>
                            <button type="button" class="btn btn-info" id="exportResults">
                                <i class="bi bi-download me-2"></i>Export Results
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Upload Excel Components -->
    <script src="js/upload-excel/types.js"></script>
    <script src="js/upload-excel/ValidationEngine.js"></script>
    <script src="js/upload-excel/DataProcessor.js"></script>
    <script src="js/upload-excel/CategoryUnitManager.js"></script>
    <script src="js/upload-excel/AuditLogger.js"></script>
    <script src="js/upload-excel/ExcelUploadManager.js"></script>
    
    <script>
        // Test state
        let testResults = {
            componentLoading: [],
            interfaceValidation: [],
            integration: [],
            fileProcessing: [],
            errorHandling: [],
            summary: { passed: 0, failed: 0, total: 0 }
        };
        
        // Initialize tests when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            runAllTests();
        });
        
        /**
         * Setup event listeners
         */
        function setupEventListeners() {
            document.getElementById('runAllTests').addEventListener('click', runAllTests);
            document.getElementById('clearResults').addEventListener('click', clearResults);
            document.getElementById('exportResults').addEventListener('click', exportResults);
            document.getElementById('testFileInput').addEventListener('change', testFileUpload);
        }
        
        /**
         * Run all tests
         */
        async function runAllTests() {
            clearResults();
            
            try {
                await testComponentLoading();
                await testInterfaceValidation();
                await testComponentIntegration();
                await testFileProcessing();
                await testErrorHandling();
                
                updateTestSummary();
                
            } catch (error) {
                addTestResult('errorHandling', false, `Critical test error: ${error.message}`);
                updateTestSummary();
            }
        }
        
        /**
         * Test component loading
         */
        async function testComponentLoading() {
            const resultsContainer = document.getElementById('componentLoadingResults');
            resultsContainer.innerHTML = '';
            
            const components = [
                { name: 'ExcelUploadManager', class: ExcelUploadManager },
                { name: 'ValidationEngine', class: ValidationEngine },
                { name: 'DataProcessor', class: DataProcessor },
                { name: 'CategoryUnitManager', class: CategoryUnitManager },
                { name: 'AuditLogger', class: AuditLogger }
            ];
            
            for (const component of components) {
                try {
                    // Test if class is defined
                    if (typeof component.class !== 'function') {
                        throw new Error(`${component.name} is not defined or not a constructor`);
                    }
                    
                    // Test instantiation
                    const instance = new component.class();
                    if (!instance) {
                        throw new Error(`Failed to instantiate ${component.name}`);
                    }
                    
                    addTestResult('componentLoading', true, `${component.name} loaded and instantiated successfully`);
                    
                } catch (error) {
                    addTestResult('componentLoading', false, `${component.name} failed: ${error.message}`);
                }
            }
        }
        
        /**
         * Test interface validation
         */
        async function testInterfaceValidation() {
            const resultsContainer = document.getElementById('interfaceValidationResults');
            resultsContainer.innerHTML = '';
            
            // Test ExcelUploadManager interface
            try {
                const uploadManager = new ExcelUploadManager();
                const requiredMethods = ['uploadFile', 'validateData', 'previewData', 'importData', 'getUploadHistory', 'rollbackImport', 'setComponents'];
                
                for (const method of requiredMethods) {
                    if (typeof uploadManager[method] !== 'function') {
                        throw new Error(`ExcelUploadManager missing method: ${method}`);
                    }
                }
                
                addTestResult('interfaceValidation', true, 'ExcelUploadManager interface validation passed');
                
            } catch (error) {
                addTestResult('interfaceValidation', false, `ExcelUploadManager interface: ${error.message}`);
            }
            
            // Test ValidationEngine interface
            try {
                const validator = new ValidationEngine();
                const requiredMethods = ['validateFileFormat', 'validateFileSize', 'validateHeaders', 'validateDataTypes', 'validateBusinessRules'];
                
                for (const method of requiredMethods) {
                    if (typeof validator[method] !== 'function') {
                        throw new Error(`ValidationEngine missing method: ${method}`);
                    }
                }
                
                // Test configuration
                if (!Array.isArray(validator.requiredFields) || validator.requiredFields.length === 0) {
                    throw new Error('ValidationEngine missing required fields configuration');
                }
                
                addTestResult('interfaceValidation', true, 'ValidationEngine interface validation passed');
                
            } catch (error) {
                addTestResult('interfaceValidation', false, `ValidationEngine interface: ${error.message}`);
            }
            
            // Test DataProcessor interface
            try {
                const processor = new DataProcessor();
                const requiredMethods = ['parseFile', 'parseCSV', 'transformData', 'processInChunks', 'chunkData'];
                
                for (const method of requiredMethods) {
                    if (typeof processor[method] !== 'function') {
                        throw new Error(`DataProcessor missing method: ${method}`);
                    }
                }
                
                addTestResult('interfaceValidation', true, 'DataProcessor interface validation passed');
                
            } catch (error) {
                addTestResult('interfaceValidation', false, `DataProcessor interface: ${error.message}`);
            }
            
            // Test CategoryUnitManager interface
            try {
                const categoryManager = new CategoryUnitManager();
                const requiredMethods = ['getCategories', 'getUnits', 'createCategory', 'createUnit', 'autoCreateFromData'];
                
                for (const method of requiredMethods) {
                    if (typeof categoryManager[method] !== 'function') {
                        throw new Error(`CategoryUnitManager missing method: ${method}`);
                    }
                }
                
                addTestResult('interfaceValidation', true, 'CategoryUnitManager interface validation passed');
                
            } catch (error) {
                addTestResult('interfaceValidation', false, `CategoryUnitManager interface: ${error.message}`);
            }
            
            // Test AuditLogger interface
            try {
                const auditLogger = new AuditLogger();
                const requiredMethods = ['logUploadStart', 'logValidationResults', 'logDataChanges', 'logImportComplete', 'logError', 'getAuditTrail'];
                
                for (const method of requiredMethods) {
                    if (typeof auditLogger[method] !== 'function') {
                        throw new Error(`AuditLogger missing method: ${method}`);
                    }
                }
                
                addTestResult('interfaceValidation', true, 'AuditLogger interface validation passed');
                
            } catch (error) {
                addTestResult('interfaceValidation', false, `AuditLogger interface: ${error.message}`);
            }
        }
        
        /**
         * Test component integration
         */
        async function testComponentIntegration() {
            const resultsContainer = document.getElementById('integrationTestResults');
            resultsContainer.innerHTML = '';
            
            try {
                // Create all components
                const validator = new ValidationEngine();
                const processor = new DataProcessor();
                const categoryManager = new CategoryUnitManager();
                const auditLogger = new AuditLogger();
                const uploadManager = new ExcelUploadManager();
                
                // Test dependency injection
                uploadManager.setComponents({
                    validator,
                    processor,
                    categoryManager,
                    auditLogger
                });
                
                // Verify components are set
                if (uploadManager.validator !== validator) {
                    throw new Error('Validator not properly injected');
                }
                if (uploadManager.processor !== processor) {
                    throw new Error('Processor not properly injected');
                }
                if (uploadManager.categoryManager !== categoryManager) {
                    throw new Error('CategoryManager not properly injected');
                }
                if (uploadManager.auditLogger !== auditLogger) {
                    throw new Error('AuditLogger not properly injected');
                }
                
                addTestResult('integration', true, 'Component dependency injection successful');
                
                // Test basic workflow
                const testData = [
                    { kode: 'TEST001', nama: 'Test Item', kategori: 'test', satuan: 'pcs', harga_beli: 1000, stok: 10 }
                ];
                
                // Test data transformation
                const transformed = processor.transformData(testData[0]);
                if (!transformed.created_at || !transformed.updated_at) {
                    throw new Error('Data transformation missing timestamps');
                }
                
                addTestResult('integration', true, 'Data transformation workflow successful');
                
                // Test validation workflow
                const validationErrors = validator.validateDataTypes(testData[0], 1);
                if (!Array.isArray(validationErrors)) {
                    throw new Error('Validation should return array');
                }
                
                addTestResult('integration', true, 'Validation workflow successful');
                
                // Test audit logging
                const logId = auditLogger.logUploadStart('testuser', 'test.csv', 1);
                if (!logId || typeof logId !== 'string') {
                    throw new Error('Audit logging failed');
                }
                
                addTestResult('integration', true, 'Audit logging workflow successful');
                
            } catch (error) {
                addTestResult('integration', false, `Integration test failed: ${error.message}`);
            }
        }
        
        /**
         * Test file processing
         */
        async function testFileProcessing() {
            const resultsContainer = document.getElementById('fileProcessingResults');
            resultsContainer.innerHTML = '';
            
            try {
                const processor = new DataProcessor();
                
                // Test CSV parsing
                const csvContent = 'kode,nama,kategori,satuan,harga_beli,stok\nTEST001,Test Item,makanan,pcs,1000,10';
                const parsedData = await processor.parseCSV(csvContent);
                
                if (!Array.isArray(parsedData) || parsedData.length === 0) {
                    throw new Error('CSV parsing failed');
                }
                
                if (!parsedData[0].kode || parsedData[0].kode !== 'TEST001') {
                    throw new Error('CSV parsing data incorrect');
                }
                
                addTestResult('fileProcessing', true, 'CSV parsing successful');
                
                // Test data chunking
                const testData = Array.from({ length: 250 }, (_, i) => ({ kode: `TEST${i}`, nama: `Item ${i}` }));
                const chunks = processor.chunkData(testData, 100);
                
                if (chunks.length !== 3) {
                    throw new Error('Data chunking incorrect');
                }
                
                if (chunks[0].length !== 100 || chunks[2].length !== 50) {
                    throw new Error('Chunk sizes incorrect');
                }
                
                addTestResult('fileProcessing', true, 'Data chunking successful');
                
                // Test file validation
                const validator = new ValidationEngine();
                
                // Create mock file
                const mockFile = {
                    name: 'test.csv',
                    size: 1000,
                    type: 'text/csv'
                };
                
                const validationResult = await validator.validateFileFormat(mockFile);
                
                if (!validationResult.hasOwnProperty('isValid')) {
                    throw new Error('File validation result missing isValid property');
                }
                
                addTestResult('fileProcessing', true, 'File validation successful');
                
            } catch (error) {
                addTestResult('fileProcessing', false, `File processing test failed: ${error.message}`);
            }
        }
        
        /**
         * Test error handling
         */
        async function testErrorHandling() {
            const resultsContainer = document.getElementById('errorHandlingResults');
            resultsContainer.innerHTML = '';
            
            try {
                // Test missing dependencies
                const uploadManager = new ExcelUploadManager();
                
                try {
                    await uploadManager.validateData([]);
                    addTestResult('errorHandling', false, 'Should throw error when validator not set');
                } catch (error) {
                    if (error.message.includes('Validator not initialized')) {
                        addTestResult('errorHandling', true, 'Properly handles missing validator dependency');
                    } else {
                        addTestResult('errorHandling', false, `Unexpected error: ${error.message}`);
                    }
                }
                
                // Test invalid file format
                const validator = new ValidationEngine();
                const invalidFile = {
                    name: 'test.txt',
                    size: 1000,
                    type: 'text/plain'
                };
                
                const result = await validator.validateFileFormat(invalidFile);
                if (result.isValid === false && result.error.includes('Invalid file format')) {
                    addTestResult('errorHandling', true, 'Properly rejects invalid file formats');
                } else {
                    addTestResult('errorHandling', false, 'Failed to reject invalid file format');
                }
                
                // Test file size limit
                const largeFile = {
                    name: 'test.csv',
                    size: 10 * 1024 * 1024, // 10MB
                    type: 'text/csv'
                };
                
                const sizeResult = await validator.validateFileFormat(largeFile);
                if (sizeResult.isValid === false && sizeResult.error.includes('exceeds maximum')) {
                    addTestResult('errorHandling', true, 'Properly enforces file size limits');
                } else {
                    addTestResult('errorHandling', false, 'Failed to enforce file size limits');
                }
                
                // Test audit logger error handling
                const auditLogger = new AuditLogger();
                const testError = new Error('Test error');
                
                try {
                    auditLogger.logError(testError, { test: true });
                    addTestResult('errorHandling', true, 'Audit logger handles errors gracefully');
                } catch (error) {
                    addTestResult('errorHandling', false, `Audit logger error handling failed: ${error.message}`);
                }
                
            } catch (error) {
                addTestResult('errorHandling', false, `Error handling test failed: ${error.message}`);
            }
        }
        
        /**
         * Test file upload with actual file
         */
        async function testFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const resultsContainer = document.getElementById('fileProcessingResults');
            
            try {
                // Create components
                const validator = new ValidationEngine();
                const processor = new DataProcessor();
                const categoryManager = new CategoryUnitManager();
                const auditLogger = new AuditLogger();
                const uploadManager = new ExcelUploadManager();
                
                uploadManager.setComponents({
                    validator,
                    processor,
                    categoryManager,
                    auditLogger
                });
                
                // Test file upload
                addTestResult('fileProcessing', true, `Testing with actual file: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);
                
                const session = await uploadManager.uploadFile(file);
                
                if (session && session.id) {
                    addTestResult('fileProcessing', true, `File upload successful - Session ID: ${session.id}`);
                    addTestResult('fileProcessing', true, `Records found: ${session.recordCount}`);
                    addTestResult('fileProcessing', true, `Validation errors: ${session.validationResults.errors.length}`);
                    addTestResult('fileProcessing', true, `Validation warnings: ${session.validationResults.warnings.length}`);
                } else {
                    addTestResult('fileProcessing', false, 'File upload failed - no session created');
                }
                
            } catch (error) {
                addTestResult('fileProcessing', false, `Actual file test failed: ${error.message}`);
            }
        }
        
        /**
         * Add test result
         */
        function addTestResult(category, passed, message) {
            testResults[category].push({ passed, message });
            testResults.summary.total++;
            if (passed) {
                testResults.summary.passed++;
            } else {
                testResults.summary.failed++;
            }
            
            // Update UI
            const container = document.getElementById(category + 'Results');
            if (container) {
                const resultDiv = document.createElement('div');
                resultDiv.className = `test-result ${passed ? 'test-pass' : 'test-fail'}`;
                resultDiv.innerHTML = `
                    <span class="component-status ${passed ? 'status-pass' : 'status-fail'}"></span>
                    ${passed ? '✓' : '✗'} ${message}
                `;
                container.appendChild(resultDiv);
            }
        }
        
        /**
         * Update test summary
         */
        function updateTestSummary() {
            const summaryContainer = document.getElementById('testSummary');
            const { passed, failed, total } = testResults.summary;
            const passRate = total > 0 ? ((passed / total) * 100).toFixed(1) : 0;
            
            summaryContainer.innerHTML = `
                <div class="row">
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h4>${passed}</h4>
                                <small>Passed</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-danger text-white">
                            <div class="card-body text-center">
                                <h4>${failed}</h4>
                                <small>Failed</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h4>${total}</h4>
                                <small>Total</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h4>${passRate}%</h4>
                                <small>Pass Rate</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="test-result ${failed === 0 ? 'test-pass' : 'test-fail'}">
                        <strong>Overall Result:</strong> ${failed === 0 ? 'ALL TESTS PASSED' : `${failed} TEST(S) FAILED`}
                        ${failed === 0 ? ' - Task 1 setup is complete and functional!' : ' - Please review failed tests above.'}
                    </div>
                </div>
            `;
        }
        
        /**
         * Clear all results
         */
        function clearResults() {
            testResults = {
                componentLoading: [],
                interfaceValidation: [],
                integration: [],
                fileProcessing: [],
                errorHandling: [],
                summary: { passed: 0, failed: 0, total: 0 }
            };
            
            // Clear UI
            const containers = ['componentLoadingResults', 'interfaceValidationResults', 'integrationTestResults', 'fileProcessingResults', 'errorHandlingResults', 'testSummary'];
            containers.forEach(id => {
                const container = document.getElementById(id);
                if (container) {
                    container.innerHTML = '<div class="test-result test-info">Ready to run tests...</div>';
                }
            });
        }
        
        /**
         * Export test results
         */
        function exportResults() {
            const results = {
                timestamp: new Date().toISOString(),
                summary: testResults.summary,
                details: testResults
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `task1_test_results_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>