<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Integration Testing - Final</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .test-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-result {
            margin: 8px 0;
            padding: 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .test-pass {
            background-color: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        .test-fail {
            background-color: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        .test-warning {
            background-color: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        .test-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .progress-container {
            background: #e9ecef;
            border-radius: 10px;
            height: 25px;
            margin: 15px 0;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="text-center mb-4">
            <h1><i class="bi bi-check2-all"></i> Comprehensive Integration Testing</h1>
            <p class="lead">Task 15.1 - Testing all existing functionality, new features, data migration, and performance</p>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-number" id="totalTests">0</div>
                <div>Total Tests</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="passedTests">0</div>
                <div>Passed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="failedTests">0</div>
                <div>Failed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="executionTime">0ms</div>
                <div>Execution Time</div>
            </div>
        </div>

        <div class="progress-container">
            <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
        </div>
        <div class="text-center mb-4">
            <button class="btn btn-primary btn-lg me-2" onclick="runAllTests()">
                <i class="bi bi-play-fill"></i> Run All Tests
            </button>
            <button class="btn btn-success me-2" onclick="runExistingFunctionalityTests()">
                <i class="bi bi-check-circle"></i> Test Existing Features
            </button>
            <button class="btn btn-info me-2" onclick="runNewIntegratedFeatureTests()">
                <i class="bi bi-plus-circle"></i> Test New Features
            </button>
            <button class="btn btn-warning me-2" onclick="runDataMigrationTests()">
                <i class="bi bi-database"></i> Test Data Migration
            </button>
            <button class="btn btn-secondary me-2" onclick="runPerformanceTests()">
                <i class="bi bi-speedometer2"></i> Test Performance
            </button>
            <button class="btn btn-danger" onclick="clearResults()">
                <i class="bi bi-trash"></i> Clear Results
            </button>
        </div>

        <div id="testResults"></div>
    </div>

    <!-- Include required JavaScript files -->
    <script src="js/shared/SharedPaymentServices.js"></script>
    <script src="js/shared/UnifiedTransactionModel.js"></script>
    <script src="js/shared/EnhancedAuditLogger.js"></script>
    <script src="js/pembayaranHutangPiutangIntegrated.js"></script>
    <script src="js/pembayaranHutangPiutangEnhanced.js"></script>
    <script src="js/import-tagihan/ImportTagihanEnhanced.js"></script>
    <script src="js/migration/TransactionMigration.js"></script>
    <script src="js/shared/DataConsistencyValidator.js"></script>
    <script src="js/shared/CrossModeErrorHandler.js"></script>
    <script src="js/shared/LazyLoadingManager.js"></script>
    <script src="js/shared/DataQueryOptimizer.js"></script>
    <script src="js/shared/RealTimeUpdateManager.js"></script>
    <script src="js/shared/UnifiedDashboardView.js"></script>
    <script src="js/shared/UnifiedTransactionHistoryView.js"></script>
    <script src="js/shared/UnifiedTransactionExporter.js"></script>
    <script src="js/shared/TabPermissionManager.js"></script>
    <script src="js/shared/SecurityAuditLogger.js"></script>

    <script>
        let testStats = {
            total: 0,
            passed: 0,
            failed: 0,
            startTime: 0,
            currentTest: 0
        };

        let testResults = [];
        let integrated, sharedServices, manualController, importController;

        function initializeTestEnvironment() {
            try {
                // Clear localStorage for clean testing
                localStorage.clear();
                
                // Initialize test data
                setupTestData();
                
                // Initialize controllers if available
                if (typeof PembayaranHutangPiutangIntegrated !== 'undefined') {
                    integrated = new PembayaranHutangPiutangIntegrated();
                    sharedServices = integrated.sharedServices;
                    manualController = integrated.manualController;
                    importController = integrated.importController;
                }
                
                return true;
            } catch (error) {
                console.error('Failed to initialize test environment:', error);
                return false;
            }
        }

        function setupTestData() {
            // Setup test anggota data
            const testAnggota = [
                { id: 'A001', nama: 'Test Anggota 1', nik: '1234567890123456' },
                { id: 'A002', nama: 'Test Anggota 2', nik: '2345678901234567' },
                { id: 'A003', nama: 'Test Anggota 3', nik: '3456789012345678' }
            ];
            localStorage.setItem('anggota', JSON.stringify(testAnggota));
            
            // Setup test transactions with mixed modes
            const testTransactions = [
                {
                    id: 'T001',
                    anggotaId: 'A001',
                    anggotaNama: 'Test Anggota 1',
                    jumlah: 100000,
                    jenis: 'hutang',
                    mode: 'manual',
                    tanggal: new Date().toISOString(),
                    kasir: 'test_kasir'
                },
                {
                    id: 'T002',
                    anggotaId: 'A002',
                    anggotaNama: 'Test Anggota 2',
                    jumlah: 50000,
                    jenis: 'piutang',
                    mode: 'import',
                    batchId: 'BATCH001',
                    tanggal: new Date().toISOString(),
                    kasir: 'test_kasir'
                }
            ];
            localStorage.setItem('pembayaranHutangPiutang', JSON.stringify(testTransactions));
            
            // Setup test user
            const testUser = {
                id: 'user001',
                nama: 'Test User',
                role: 'admin'
            };
            localStorage.setItem('currentUser', JSON.stringify(testUser));
        }

        function updateStats() {
            document.getElementById('totalTests').textContent = testStats.total;
            document.getElementById('passedTests').textContent = testStats.passed;
            document.getElementById('failedTests').textContent = testStats.failed;
            
            const elapsed = Date.now() - testStats.startTime;
            document.getElementById('executionTime').textContent = elapsed + 'ms';
            
            const progress = testStats.total > 0 ? (testStats.currentTest / testStats.total) * 100 : 0;
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = progress + '%';
            progressBar.textContent = Math.round(progress) + '%';
        }

        function addTestResult(testName, passed, message, details = null) {
            testStats.currentTest++;
            
            if (passed) {
                testStats.passed++;
            } else {
                testStats.failed++;
            }
            
            const result = {
                name: testName,
                passed: passed,
                message: message,
                details: details,
                timestamp: new Date().toISOString()
            };
            
            testResults.push(result);
            
            const resultElement = document.createElement('div');
            resultElement.className = `test-result ${passed ? 'test-pass' : 'test-fail'}`;
            resultElement.innerHTML = `
                <strong>${passed ? '✓' : '✗'} ${testName}</strong><br>
                ${message}
                ${details ? `<br><small>${details}</small>` : ''}
            `;
            
            document.getElementById('testResults').appendChild(resultElement);
            updateStats();
        }

        function addTestSection(sectionName) {
            const section = document.createElement('div');
            section.className = 'test-section';
            section.innerHTML = `<h3><i class="bi bi-folder"></i> ${sectionName}</h3>`;
            section.id = sectionName.replace(/\s+/g, '-').toLowerCase();
            document.getElementById('testResults').appendChild(section);
        }

        async function runAllTests() {
            testStats.startTime = Date.now();
            testStats.total = 50; // Estimated total tests
            testStats.passed = 0;
            testStats.failed = 0;
            testStats.currentTest = 0;
            testResults = [];
            
            document.getElementById('testResults').innerHTML = '';
            
            if (!initializeTestEnvironment()) {
                addTestResult('Environment Initialization', false, 'Failed to initialize test environment');
                return;
            }
            
            await runExistingFunctionalityTests();
            await runNewIntegratedFeatureTests();
            await runDataMigrationTests();
            await runPerformanceTests();
            
            // Final summary
            const section = document.createElement('div');
            section.className = 'test-section';
            section.innerHTML = `
                <h3><i class="bi bi-clipboard-check"></i> Test Summary</h3>
                <div class="alert ${testStats.failed === 0 ? 'alert-success' : 'alert-warning'}">
                    <h5>Integration Testing Complete</h5>
                    <p><strong>Total Tests:</strong> ${testStats.passed + testStats.failed}</p>
                    <p><strong>Passed:</strong> ${testStats.passed}</p>
                    <p><strong>Failed:</strong> ${testStats.failed}</p>
                    <p><strong>Success Rate:</strong> ${Math.round((testStats.passed / (testStats.passed + testStats.failed)) * 100)}%</p>
                    <p><strong>Execution Time:</strong> ${Date.now() - testStats.startTime}ms</p>
                </div>
            `;
            document.getElementById('testResults').appendChild(section);
        }

        async function runExistingFunctionalityTests() {
            addTestSection('Existing Functionality Tests');
            const section = document.getElementById('existing-functionality-tests');
            
            // Test 1: Manual payment functionality
            try {
                if (manualController && typeof manualController.validatePaymentData === 'function') {
                    const paymentData = {
                        anggotaId: 'A001',
                        anggotaNama: 'Test Anggota 1',
                        jenisPembayaran: 'hutang',
                        jumlah: 100000,
                        keterangan: 'Test payment'
                    };
                    
                    const result = manualController.validatePaymentData(paymentData);
                    addTestResult('Manual Payment Validation', result !== null, 'Manual payment validation works correctly');
                } else {
                    addTestResult('Manual Payment Validation', false, 'Manual controller or validation method not available');
                }
            } catch (error) {
                addTestResult('Manual Payment Validation', false, `Error: ${error.message}`);
            }
            
            // Test 2: Shared services backward compatibility
            try {
                if (sharedServices) {
                    const paymentData = {
                        anggotaId: 'A001',
                        jumlah: 100000,
                        jenis: 'hutang'
                    };
                    
                    const validation = sharedServices.validatePaymentAmount(paymentData.jumlah, 150000, paymentData.jenis);
                    addTestResult('Shared Services Compatibility', validation !== null, 'Shared services maintain backward compatibility');
                } else {
                    addTestResult('Shared Services Compatibility', false, 'Shared services not available');
                }
            } catch (error) {
                addTestResult('Shared Services Compatibility', false, `Error: ${error.message}`);
            }
            
            // Test 3: Transaction history retrieval
            try {
                if (sharedServices && typeof sharedServices.getTransactionHistory === 'function') {
                    const history = sharedServices.getTransactionHistory({});
                    addTestResult('Transaction History Retrieval', Array.isArray(history), `Retrieved ${history ? history.length : 0} transactions`);
                } else {
                    addTestResult('Transaction History Retrieval', false, 'Transaction history method not available');
                }
            } catch (error) {
                addTestResult('Transaction History Retrieval', false, `Error: ${error.message}`);
            }
            
            // Test 4: Saldo calculation functions
            try {
                if (sharedServices && typeof sharedServices.hitungSaldoHutang === 'function') {
                    const saldo = sharedServices.hitungSaldoHutang('A001');
                    addTestResult('Saldo Calculation', typeof saldo === 'number', `Saldo calculation returns number: ${saldo}`);
                } else {
                    addTestResult('Saldo Calculation', false, 'Saldo calculation method not available');
                }
            } catch (error) {
                addTestResult('Saldo Calculation', false, `Error: ${error.message}`);
            }
            
            // Test 5: Journal entry creation
            try {
                if (sharedServices && typeof sharedServices.createJurnalEntry === 'function') {
                    const transactionData = {
                        jenis: 'hutang',
                        jumlah: 100000,
                        anggotaNama: 'Test Anggota',
                        tanggal: new Date().toISOString()
                    };
                    
                    const jurnalId = sharedServices.createJurnalEntry(transactionData, 'manual');
                    addTestResult('Journal Entry Creation', jurnalId !== null, `Journal entry created with ID: ${jurnalId}`);
                } else {
                    addTestResult('Journal Entry Creation', false, 'Journal entry method not available');
                }
            } catch (error) {
                addTestResult('Journal Entry Creation', false, `Error: ${error.message}`);
            }
        }

        async function runNewIntegratedFeatureTests() {
            addTestSection('New Integrated Features Tests');
            
            // Test 1: Tab switching functionality
            try {
                if (integrated && typeof integrated.switchTab === 'function') {
                    const result1 = await integrated.switchTab('import');
                    const result2 = await integrated.switchTab('manual');
                    
                    addTestResult('Tab Switching', result1 && result2, 'Tab switching works correctly between manual and import');
                } else {
                    addTestResult('Tab Switching', false, 'Integrated controller or switchTab method not available');
                }
            } catch (error) {
                addTestResult('Tab Switching', false, `Error: ${error.message}`);
            }
            
            // Test 2: Mode tracking in transactions
            try {
                const manualTransaction = {
                    anggotaId: 'A001',
                    jumlah: 100000,
                    mode: 'manual'
                };
                
                const importTransaction = {
                    anggotaId: 'A002',
                    jumlah: 50000,
                    mode: 'import',
                    batchId: 'BATCH001'
                };
                
                const hasMode = manualTransaction.mode && importTransaction.mode;
                const hasBatchId = importTransaction.batchId;
                
                addTestResult('Mode Tracking', hasMode && hasBatchId, 'Transactions properly track mode and batch information');
            } catch (error) {
                addTestResult('Mode Tracking', false, `Error: ${error.message}`);
            }
            
            // Test 3: Unified transaction history with mode filter
            try {
                if (sharedServices && typeof sharedServices.getTransactionHistory === 'function') {
                    const allTransactions = sharedServices.getTransactionHistory({});
                    const manualOnly = sharedServices.getTransactionHistory({ mode: 'manual' });
                    const importOnly = sharedServices.getTransactionHistory({ mode: 'import' });
                    
                    const filterWorks = manualOnly.every(t => t.mode === 'manual') && 
                                      importOnly.every(t => t.mode === 'import');
                    
                    addTestResult('Unified History with Mode Filter', filterWorks, 
                        `Total: ${allTransactions.length}, Manual: ${manualOnly.length}, Import: ${importOnly.length}`);
                } else {
                    addTestResult('Unified History with Mode Filter', false, 'Transaction history method not available');
                }
            } catch (error) {
                addTestResult('Unified History with Mode Filter', false, `Error: ${error.message}`);
            }
            
            // Test 4: Unified summary calculation
            try {
                if (sharedServices && typeof sharedServices.getUnifiedSummary === 'function') {
                    const summary = sharedServices.getUnifiedSummary();
                    const hasRequiredFields = summary && 
                                            typeof summary.totalManual !== 'undefined' && 
                                            typeof summary.totalImport !== 'undefined' && 
                                            typeof summary.grandTotal !== 'undefined';
                    
                    addTestResult('Unified Summary', hasRequiredFields, 
                        `Manual: ${summary?.totalManual || 0}, Import: ${summary?.totalImport || 0}, Total: ${summary?.grandTotal || 0}`);
                } else {
                    addTestResult('Unified Summary', false, 'Unified summary method not available');
                }
            } catch (error) {
                addTestResult('Unified Summary', false, `Error: ${error.message}`);
            }
            
            // Test 5: Real-time updates between tabs
            try {
                if (integrated && integrated.updateManager) {
                    // Simulate real-time update
                    const updateData = { type: 'transaction_added', amount: 10000 };
                    integrated.updateManager.triggerUpdate('manualPaymentCompleted', updateData);
                    
                    addTestResult('Real-time Updates', true, 'Real-time update system is functional');
                } else {
                    addTestResult('Real-time Updates', false, 'Update manager not available or not initialized');
                }
            } catch (error) {
                addTestResult('Real-time Updates', false, `Error: ${error.message}`);
            }
        }

        async function runDataMigrationTests() {
            addTestSection('Data Migration and Consistency Tests');
            
            // Test 1: Existing transactions migration
            try {
                // Simulate old transactions without mode field
                const oldTransactions = [
                    { id: 'OLD001', jumlah: 100000 },
                    { id: 'OLD002', jumlah: 50000 }
                ];
                
                localStorage.setItem('pembayaranHutangPiutang', JSON.stringify(oldTransactions));
                
                // Run migration if available
                if (typeof TransactionMigration !== 'undefined' && 
                    typeof TransactionMigration.migrateExistingTransactions === 'function') {
                    TransactionMigration.migrateExistingTransactions();
                    
                    const migrated = JSON.parse(localStorage.getItem('pembayaranHutangPiutang') || '[]');
                    const allHaveMode = migrated.every(t => t.mode === 'manual');
                    
                    addTestResult('Transaction Migration', allHaveMode, 
                        `Migrated ${migrated.length} transactions with manual mode`);
                } else {
                    addTestResult('Transaction Migration', false, 'Migration function not available');
                }
            } catch (error) {
                addTestResult('Transaction Migration', false, `Error: ${error.message}`);
            }
            
            // Test 2: Data consistency across modes
            try {
                if (sharedServices) {
                    const transactions = [
                        { mode: 'manual', anggotaId: 'A001', jumlah: 100000, jenis: 'hutang' },
                        { mode: 'import', anggotaId: 'A001', jumlah: 50000, jenis: 'hutang' }
                    ];
                    
                    localStorage.setItem('pembayaranHutangPiutang', JSON.stringify(transactions));
                    
                    // Calculate total saldo
                    const saldo = sharedServices.hitungSaldoHutang('A001');
                    const expectedSaldo = 150000; // 100000 + 50000
                    
                    addTestResult('Cross-Mode Data Consistency', saldo === expectedSaldo, 
                        `Expected: ${expectedSaldo}, Actual: ${saldo}`);
                } else {
                    addTestResult('Cross-Mode Data Consistency', false, 'Shared services not available');
                }
            } catch (error) {
                addTestResult('Cross-Mode Data Consistency', false, `Error: ${error.message}`);
            }
            
            // Test 3: Journal entries consistency
            try {
                if (sharedServices && typeof sharedServices.createJurnalEntry === 'function') {
                    const manualPayment = {
                        anggotaId: 'A001',
                        jumlah: 100000,
                        jenis: 'hutang',
                        anggotaNama: 'Test Anggota',
                        tanggal: new Date().toISOString()
                    };
                    
                    const importPayment = {
                        anggotaId: 'A002',
                        jumlah: 50000,
                        jenis: 'hutang',
                        anggotaNama: 'Test Anggota 2',
                        tanggal: new Date().toISOString()
                    };
                    
                    const manualJournal = sharedServices.createJurnalEntry(manualPayment, 'manual');
                    const importJournal = sharedServices.createJurnalEntry(importPayment, 'import');
                    
                    const bothCreated = manualJournal && importJournal;
                    
                    addTestResult('Journal Consistency', bothCreated, 
                        `Manual journal: ${manualJournal}, Import journal: ${importJournal}`);
                } else {
                    addTestResult('Journal Consistency', false, 'Journal creation method not available');
                }
            } catch (error) {
                addTestResult('Journal Consistency', false, `Error: ${error.message}`);
            }
            
            // Test 4: Audit logs with mode information
            try {
                if (sharedServices && typeof sharedServices.logAudit === 'function') {
                    const transactionData = {
                        anggotaId: 'A001',
                        jumlah: 100000,
                        mode: 'manual'
                    };
                    
                    sharedServices.logAudit('TEST_PAYMENT', transactionData);
                    
                    const logs = JSON.parse(localStorage.getItem('audit_logs') || '[]');
                    const lastLog = logs[logs.length - 1];
                    const hasModeInfo = lastLog && lastLog.details && lastLog.details.mode;
                    
                    addTestResult('Audit Logs with Mode', hasModeInfo, 
                        `Audit log includes mode: ${lastLog?.details?.mode || 'none'}`);
                } else {
                    addTestResult('Audit Logs with Mode', false, 'Audit logging method not available');
                }
            } catch (error) {
                addTestResult('Audit Logs with Mode', false, `Error: ${error.message}`);
            }
            
            // Test 5: Data consistency validation
            try {
                if (sharedServices && typeof sharedServices.validateSystemConsistency === 'function') {
                    const validation = sharedServices.validateSystemConsistency();
                    
                    addTestResult('System Consistency Validation', validation.valid !== false, 
                        `Validation result: ${validation.valid ? 'Valid' : validation.message || 'Invalid'}`);
                } else {
                    addTestResult('System Consistency Validation', false, 'Consistency validation method not available');
                }
            } catch (error) {
                addTestResult('System Consistency Validation', false, `Error: ${error.message}`);
            }
        }

        async function runPerformanceTests() {
            addTestSection('Performance Tests with Large Datasets');
            
            // Test 1: Large dataset transaction history loading
            try {
                if (sharedServices && typeof sharedServices.getTransactionHistory === 'function') {
                    // Generate 1000 test transactions
                    const largeDataset = [];
                    for (let i = 0; i < 1000; i++) {
                        largeDataset.push({
                            id: `PERF${i}`,
                            anggotaId: `A${i % 100}`,
                            jumlah: Math.floor(Math.random() * 1000000),
                            mode: i % 2 === 0 ? 'manual' : 'import',
                            tanggal: new Date().toISOString()
                        });
                    }
                    
                    localStorage.setItem('pembayaranHutangPiutang', JSON.stringify(largeDataset));
                    
                    const startTime = performance.now();
                    const history = sharedServices.getTransactionHistory({});
                    const endTime = performance.now();
                    
                    const loadTime = endTime - startTime;
                    const performanceOk = loadTime < 2000; // Should load in less than 2 seconds
                    
                    addTestResult('Large Dataset Loading', performanceOk, 
                        `Loaded ${history.length} transactions in ${Math.round(loadTime)}ms`);
                } else {
                    addTestResult('Large Dataset Loading', false, 'Transaction history method not available');
                }
            } catch (error) {
                addTestResult('Large Dataset Loading', false, `Error: ${error.message}`);
            }
            
            // Test 2: Filtering performance on large dataset
            try {
                if (sharedServices && typeof sharedServices.getTransactionHistory === 'function') {
                    const startTime = performance.now();
                    const filtered = sharedServices.getTransactionHistory({ 
                        mode: 'manual',
                        jenis: 'hutang'
                    });
                    const endTime = performance.now();
                    
                    const filterTime = endTime - startTime;
                    const performanceOk = filterTime < 1000; // Should filter in less than 1 second
                    
                    addTestResult('Large Dataset Filtering', performanceOk, 
                        `Filtered to ${filtered.length} transactions in ${Math.round(filterTime)}ms`);
                } else {
                    addTestResult('Large Dataset Filtering', false, 'Transaction history method not available');
                }
            } catch (error) {
                addTestResult('Large Dataset Filtering', false, `Error: ${error.message}`);
            }
            
            // Test 3: Summary calculation performance
            try {
                if (sharedServices && typeof sharedServices.getUnifiedSummary === 'function') {
                    const startTime = performance.now();
                    const summary = sharedServices.getUnifiedSummary();
                    const endTime = performance.now();
                    
                    const calcTime = endTime - startTime;
                    const performanceOk = calcTime < 1000; // Should calculate in less than 1 second
                    
                    addTestResult('Summary Calculation Performance', performanceOk, 
                        `Calculated summary in ${Math.round(calcTime)}ms`);
                } else {
                    addTestResult('Summary Calculation Performance', false, 'Summary calculation method not available');
                }
            } catch (error) {
                addTestResult('Summary Calculation Performance', false, `Error: ${error.message}`);
            }
            
            // Test 4: Multiple tab switches performance
            try {
                if (integrated && typeof integrated.switchTab === 'function') {
                    const startTime = performance.now();
                    
                    // Simulate rapid tab switching
                    for (let i = 0; i < 10; i++) {
                        await integrated.switchTab(i % 2 === 0 ? 'manual' : 'import');
                    }
                    
                    const endTime = performance.now();
                    const switchTime = endTime - startTime;
                    const performanceOk = switchTime < 2000; // Should handle 10 switches in less than 2 seconds
                    
                    addTestResult('Tab Switching Performance', performanceOk, 
                        `Completed 10 tab switches in ${Math.round(switchTime)}ms`);
                } else {
                    addTestResult('Tab Switching Performance', false, 'Tab switching method not available');
                }
            } catch (error) {
                addTestResult('Tab Switching Performance', false, `Error: ${error.message}`);
            }
            
            // Test 5: Memory usage stability
            try {
                const initialMemory = performance.memory ? performance.memory.usedJSHeapSize : 0;
                
                // Perform multiple operations
                for (let i = 0; i < 100; i++) {
                    if (sharedServices && typeof sharedServices.getTransactionHistory === 'function') {
                        sharedServices.getTransactionHistory({});
                    }
                }
                
                const finalMemory = performance.memory ? performance.memory.usedJSHeapSize : 0;
                
                if (performance.memory) {
                    const memoryIncrease = finalMemory - initialMemory;
                    const memoryOk = memoryIncrease < 10 * 1024 * 1024; // Less than 10MB increase
                    
                    addTestResult('Memory Usage Stability', memoryOk, 
                        `Memory increase: ${Math.round(memoryIncrease / 1024 / 1024)}MB`);
                } else {
                    addTestResult('Memory Usage Stability', true, 'Memory API not available, assuming stable');
                }
            } catch (error) {
                addTestResult('Memory Usage Stability', false, `Error: ${error.message}`);
            }
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            testStats = { total: 0, passed: 0, failed: 0, startTime: 0, currentTest: 0 };
            testResults = [];
            updateStats();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
        });
    </script>
</body>
</html>