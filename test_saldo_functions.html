<!DOCTYPE html>
<html>
<head>
    <title>Test Saldo Functions</title>
</head>
<body>
    <h1>Testing Saldo Calculation Functions</h1>
    <div id="results"></div>

    <script>
        // Mock localStorage for testing
        const mockStorage = {};
        const localStorage = {
            getItem: (key) => mockStorage[key] || null,
            setItem: (key, value) => { mockStorage[key] = value; },
            clear: () => { Object.keys(mockStorage).forEach(key => delete mockStorage[key]); }
        };

        // Mock functions
        function formatRupiah(amount) {
            return `Rp ${amount.toLocaleString('id-ID')}`;
        }

        // Include the saldo calculation functions
        function hitungSaldoHutang(anggotaId) {
            try {
                const penjualan = JSON.parse(localStorage.getItem('penjualan') || '[]');
                const pembayaran = JSON.parse(localStorage.getItem('pembayaranHutangPiutang') || '[]');
                
                // Total kredit from POS transactions
                const totalKredit = penjualan
                    .filter(p => p.anggotaId === anggotaId && p.metodePembayaran === 'Kredit')
                    .reduce((sum, p) => sum + (parseFloat(p.total) || 0), 0);
                
                // Total payments already made
                const totalBayar = pembayaran
                    .filter(p => p.anggotaId === anggotaId && p.jenis === 'hutang' && p.status === 'selesai')
                    .reduce((sum, p) => sum + (parseFloat(p.jumlah) || 0), 0);
                
                return totalKredit - totalBayar;
            } catch (error) {
                console.error('Error calculating hutang saldo:', error);
                return 0;
            }
        }

        function hitungSaldoPiutang(anggotaId) {
            try {
                // Piutang comes from simpanan that need to be returned to anggota
                const simpananList = JSON.parse(localStorage.getItem('simpanan') || '[]');
                const pembayaran = JSON.parse(localStorage.getItem('pembayaranHutangPiutang') || '[]');
                
                // Get simpanan for this anggota that are marked for pengembalian
                const anggotaSimpanan = simpananList.filter(s => 
                    s.anggotaId === anggotaId && 
                    s.statusPengembalian === 'pending'
                );
                
                // Calculate total piutang from simpanan balances
                let totalPiutang = 0;
                anggotaSimpanan.forEach(simpanan => {
                    totalPiutang += parseFloat(simpanan.saldo || 0);
                });
                
                // Subtract payments already made
                const totalBayar = pembayaran
                    .filter(p => p.anggotaId === anggotaId && p.jenis === 'piutang' && p.status === 'selesai')
                    .reduce((sum, p) => sum + (parseFloat(p.jumlah) || 0), 0);
                
                return totalPiutang - totalBayar;
            } catch (error) {
                console.error('Error calculating piutang saldo:', error);
                return 0;
            }
        }

        // Test functions
        function runTests() {
            const results = [];
            
            // Test 1: Hutang calculation with no data
            localStorage.clear();
            const hutang1 = hitungSaldoHutang('A001');
            results.push(`Test 1 - Hutang with no data: ${hutang1} (expected: 0) - ${hutang1 === 0 ? 'PASS' : 'FAIL'}`);
            
            // Test 2: Hutang calculation with kredit transactions
            const penjualan = [
                { anggotaId: 'A001', metodePembayaran: 'Kredit', total: 100000 },
                { anggotaId: 'A001', metodePembayaran: 'Kredit', total: 50000 },
                { anggotaId: 'A002', metodePembayaran: 'Kredit', total: 75000 }
            ];
            localStorage.setItem('penjualan', JSON.stringify(penjualan));
            const hutang2 = hitungSaldoHutang('A001');
            results.push(`Test 2 - Hutang with kredit: ${hutang2} (expected: 150000) - ${hutang2 === 150000 ? 'PASS' : 'FAIL'}`);
            
            // Test 3: Hutang calculation with payments
            const pembayaran = [
                { anggotaId: 'A001', jenis: 'hutang', status: 'selesai', jumlah: 30000 }
            ];
            localStorage.setItem('pembayaranHutangPiutang', JSON.stringify(pembayaran));
            const hutang3 = hitungSaldoHutang('A001');
            results.push(`Test 3 - Hutang after payment: ${hutang3} (expected: 120000) - ${hutang3 === 120000 ? 'PASS' : 'FAIL'}`);
            
            // Test 4: Piutang calculation with no data
            localStorage.clear();
            const piutang1 = hitungSaldoPiutang('A001');
            results.push(`Test 4 - Piutang with no data: ${piutang1} (expected: 0) - ${piutang1 === 0 ? 'PASS' : 'FAIL'}`);
            
            // Test 5: Piutang calculation with simpanan
            const simpanan = [
                { anggotaId: 'A001', statusPengembalian: 'pending', saldo: 200000 },
                { anggotaId: 'A001', statusPengembalian: 'pending', saldo: 100000 },
                { anggotaId: 'A002', statusPengembalian: 'pending', saldo: 150000 }
            ];
            localStorage.setItem('simpanan', JSON.stringify(simpanan));
            const piutang2 = hitungSaldoPiutang('A001');
            results.push(`Test 5 - Piutang with simpanan: ${piutang2} (expected: 300000) - ${piutang2 === 300000 ? 'PASS' : 'FAIL'}`);
            
            // Test 6: Piutang calculation with payments
            const pembayaranPiutang = [
                { anggotaId: 'A001', jenis: 'piutang', status: 'selesai', jumlah: 50000 }
            ];
            localStorage.setItem('pembayaranHutangPiutang', JSON.stringify(pembayaranPiutang));
            const piutang3 = hitungSaldoPiutang('A001');
            results.push(`Test 6 - Piutang after payment: ${piutang3} (expected: 250000) - ${piutang3 === 250000 ? 'PASS' : 'FAIL'}`);
            
            return results;
        }

        // Run tests and display results
        const testResults = runTests();
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '<h2>Test Results:</h2><ul>' + 
            testResults.map(result => `<li>${result}</li>`).join('') + 
            '</ul>';
        
        // Check if all tests passed
        const allPassed = testResults.every(result => result.includes('PASS'));
        resultsDiv.innerHTML += `<h3>Overall Result: ${allPassed ? 'ALL TESTS PASSED ✅' : 'SOME TESTS FAILED ❌'}</h3>`;
        
        console.log('Test Results:', testResults);
        console.log('All tests passed:', allPassed);
    </script>
</body>
</html>