<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Login Fix - Comprehensive</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-success { color: #198754; }
        .status-error { color: #dc3545; }
        .status-warning { color: #fd7e14; }
        .status-info { color: #0dcaf0; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="alert alert-danger">
                    <h4><i class="bi bi-exclamation-triangle-fill me-2"></i>Emergency Login Fix</h4>
                    <p class="mb-0">Tool komprehensif untuk mengatasi masalah login yang masih terjadi setelah commit.</p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-search me-2"></i>Diagnosis Masalah</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-info w-100 mb-2" onclick="runFullDiagnosis()">
                            <i class="bi bi-clipboard-check me-2"></i>Diagnosis Lengkap
                        </button>
                        <button class="btn btn-warning w-100 mb-2" onclick="checkAuthFile()">
                            <i class="bi bi-file-code me-2"></i>Cek Auth.js
                        </button>
                        <button class="btn btn-secondary w-100" onclick="checkLocalStorage()">
                            <i class="bi bi-database me-2"></i>Cek LocalStorage
                        </button>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-tools me-2"></i>Perbaikan Otomatis</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-success w-100 mb-2" onclick="emergencyFix()">
                            <i class="bi bi-lightning-fill me-2"></i>Perbaikan Emergency
                        </button>
                        <button class="btn btn-danger w-100 mb-2" onclick="resetEverything()">
                            <i class="bi bi-arrow-clockwise me-2"></i>Reset Total Sistem
                        </button>
                        <button class="btn btn-primary w-100" onclick="forceLogin()">
                            <i class="bi bi-key-fill me-2"></i>Force Login Admin
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-terminal me-2"></i>Log Aktivitas</h5>
                    </div>
                    <div class="card-body">
                        <div id="logArea" class="log-area">
                            <div class="status-info">Siap untuk diagnosis...</div>
                        </div>
                        <button class="btn btn-outline-secondary btn-sm mt-2" onclick="clearLog()">
                            <i class="bi bi-trash me-1"></i>Clear Log
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="bi bi-person-check me-2"></i>Test Login Manual</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Username:</label>
                            <input type="text" id="testUsername" class="form-control" value="admin" placeholder="admin">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password:</label>
                            <input type="password" id="testPassword" class="form-control" value="admin" placeholder="admin">
                        </div>
                        <button class="btn btn-warning w-100" onclick="testLogin()">
                            <i class="bi bi-box-arrow-in-right me-2"></i>Test Login
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="alert alert-info">
                    <h6><i class="bi bi-info-circle me-2"></i>Kredensial Default:</h6>
                    <ul class="mb-0">
                        <li><strong>Super Admin:</strong> admin / admin</li>
                        <li><strong>Kasir:</strong> kasir / kasir123</li>
                        <li><strong>Keuangan:</strong> keuangan / keuangan123</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let logArea = document.getElementById('logArea');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = `status-${type}`;
            logArea.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLog() {
            logArea.innerHTML = '<div class="status-info">Log cleared...</div>';
        }

        // Default users untuk emergency
        const defaultUsers = [
            {
                id: 1,
                username: 'admin',
                password: 'admin',
                name: 'Super Administrator',
                role: 'super_admin',
                active: true,
                createdAt: new Date().toISOString(),
                lastLogin: null,
                passwordChangedAt: new Date().toISOString(),
                passwordHistory: []
            },
            {
                id: 2,
                username: 'kasir',
                password: 'kasir123',
                name: 'Kasir',
                role: 'kasir',
                active: true,
                createdAt: new Date().toISOString(),
                lastLogin: null,
                passwordChangedAt: new Date().toISOString(),
                passwordHistory: []
            },
            {
                id: 3,
                username: 'keuangan',
                password: 'keuangan123',
                name: 'Admin Keuangan',
                role: 'keuangan',
                active: true,
                createdAt: new Date().toISOString(),
                lastLogin: null,
                passwordChangedAt: new Date().toISOString(),
                passwordHistory: []
            }
        ];

        function runFullDiagnosis() {
            log('=== MEMULAI DIAGNOSIS LENGKAP ===', 'info');
            
            // 1. Cek auth.js
            checkAuthFile();
            
            // 2. Cek localStorage
            setTimeout(() => {
                checkLocalStorage();
            }, 500);
            
            // 3. Cek console errors
            setTimeout(() => {
                checkConsoleErrors();
            }, 1000);
            
            // 4. Cek DOM elements
            setTimeout(() => {
                checkDOMElements();
            }, 1500);
            
            setTimeout(() => {
                log('=== DIAGNOSIS SELESAI ===', 'success');
            }, 2000);
        }

        function checkAuthFile() {
            log('Mengecek file auth.js...', 'info');
            
            try {
                // Coba load auth.js
                const script = document.createElement('script');
                script.src = 'js/auth.js?' + Date.now(); // Cache busting
                
                script.onload = function() {
                    log('✅ Auth.js berhasil dimuat', 'success');
                    
                    // Cek fungsi-fungsi penting
                    const functions = ['handleLogin', 'getUsersFromStorage', 'showMainApp', 'renderMenu'];
                    functions.forEach(funcName => {
                        if (typeof window[funcName] === 'function') {
                            log(`✅ Fungsi ${funcName} tersedia`, 'success');
                        } else {
                            log(`❌ Fungsi ${funcName} tidak ditemukan`, 'error');
                        }
                    });
                };
                
                script.onerror = function() {
                    log('❌ Error loading auth.js', 'error');
                };
                
                document.head.appendChild(script);
                
            } catch (error) {
                log(`❌ Error: ${error.message}`, 'error');
            }
        }

        function checkLocalStorage() {
            log('Mengecek localStorage...', 'info');
            
            try {
                // Cek users
                const users = localStorage.getItem('users');
                if (users) {
                    const parsedUsers = JSON.parse(users);
                    log(`✅ Data users ditemukan: ${parsedUsers.length} user`, 'success');
                    
                    parsedUsers.forEach(user => {
                        log(`  - ${user.username} (${user.role}) - ${user.active ? 'Aktif' : 'Nonaktif'}`, 'info');
                    });
                } else {
                    log('⚠️ Data users tidak ditemukan', 'warning');
                }
                
                // Cek currentUser
                const currentUser = localStorage.getItem('currentUser');
                if (currentUser) {
                    const parsedUser = JSON.parse(currentUser);
                    log(`✅ Current user: ${parsedUser.username}`, 'success');
                } else {
                    log('⚠️ Current user tidak ditemukan', 'warning');
                }
                
            } catch (error) {
                log(`❌ Error parsing localStorage: ${error.message}`, 'error');
            }
        }

        function checkConsoleErrors() {
            log('Mengecek console errors...', 'info');
            
            // Override console.error untuk menangkap errors
            const originalError = console.error;
            let errorCount = 0;
            
            console.error = function(...args) {
                errorCount++;
                log(`❌ Console Error: ${args.join(' ')}`, 'error');
                originalError.apply(console, args);
            };
            
            setTimeout(() => {
                if (errorCount === 0) {
                    log('✅ Tidak ada console errors terdeteksi', 'success');
                }
                console.error = originalError;
            }, 1000);
        }

        function checkDOMElements() {
            log('Mengecek DOM elements...', 'info');
            
            const elements = ['loginForm', 'username', 'password', 'loginError', 'mainContent'];
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    log(`✅ Element #${id} ditemukan`, 'success');
                } else {
                    log(`⚠️ Element #${id} tidak ditemukan`, 'warning');
                }
            });
        }

        function emergencyFix() {
            log('=== MEMULAI PERBAIKAN EMERGENCY ===', 'warning');
            
            try {
                // 1. Reset users ke default
                log('Mereset users ke default...', 'info');
                localStorage.setItem('users', JSON.stringify(defaultUsers));
                log('✅ Users berhasil direset', 'success');
                
                // 2. Clear current user
                log('Menghapus current user...', 'info');
                localStorage.removeItem('currentUser');
                log('✅ Current user dihapus', 'success');
                
                // 3. Clear cache
                log('Membersihkan cache...', 'info');
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => {
                            caches.delete(name);
                        });
                    });
                }
                log('✅ Cache dibersihkan', 'success');
                
                // 4. Reload auth.js
                log('Memuat ulang auth.js...', 'info');
                const oldScript = document.querySelector('script[src*="auth.js"]');
                if (oldScript) {
                    oldScript.remove();
                }
                
                const newScript = document.createElement('script');
                newScript.src = 'js/auth.js?' + Date.now();
                newScript.onload = function() {
                    log('✅ Auth.js berhasil dimuat ulang', 'success');
                    log('=== PERBAIKAN SELESAI ===', 'success');
                    log('Silakan coba login dengan: admin/admin', 'info');
                };
                document.head.appendChild(newScript);
                
            } catch (error) {
                log(`❌ Error dalam perbaikan: ${error.message}`, 'error');
            }
        }

        function resetEverything() {
            if (confirm('Yakin ingin reset total sistem? Semua data akan hilang!')) {
                log('=== RESET TOTAL SISTEM ===', 'warning');
                
                try {
                    // Clear semua localStorage
                    localStorage.clear();
                    log('✅ LocalStorage dibersihkan', 'success');
                    
                    // Set users default
                    localStorage.setItem('users', JSON.stringify(defaultUsers));
                    log('✅ Users default diset', 'success');
                    
                    // Clear sessionStorage
                    sessionStorage.clear();
                    log('✅ SessionStorage dibersihkan', 'success');
                    
                    // Clear cookies
                    document.cookie.split(";").forEach(function(c) { 
                        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                    });
                    log('✅ Cookies dibersihkan', 'success');
                    
                    log('=== RESET SELESAI ===', 'success');
                    log('Sistem telah direset ke kondisi awal', 'info');
                    
                } catch (error) {
                    log(`❌ Error dalam reset: ${error.message}`, 'error');
                }
            }
        }

        function forceLogin() {
            log('=== FORCE LOGIN ADMIN ===', 'warning');
            
            try {
                // Set users jika belum ada
                if (!localStorage.getItem('users')) {
                    localStorage.setItem('users', JSON.stringify(defaultUsers));
                    log('✅ Default users diset', 'success');
                }
                
                // Force login sebagai admin
                const adminUser = defaultUsers[0];
                localStorage.setItem('currentUser', JSON.stringify(adminUser));
                log('✅ Force login sebagai admin berhasil', 'success');
                
                // Redirect ke index.html
                log('Redirecting ke index.html...', 'info');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
                
            } catch (error) {
                log(`❌ Error dalam force login: ${error.message}`, 'error');
            }
        }

        function testLogin() {
            const username = document.getElementById('testUsername').value;
            const password = document.getElementById('testPassword').value;
            
            log(`=== TEST LOGIN: ${username} ===`, 'info');
            
            try {
                // Cek users
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                if (users.length === 0) {
                    log('⚠️ Tidak ada users, menggunakan default...', 'warning');
                    localStorage.setItem('users', JSON.stringify(defaultUsers));
                }
                
                // Cari user
                const updatedUsers = JSON.parse(localStorage.getItem('users') || '[]');
                const user = updatedUsers.find(u => u.username === username);
                
                if (!user) {
                    log(`❌ User ${username} tidak ditemukan`, 'error');
                    return;
                }
                
                // Cek password
                if (user.password === password) {
                    log('✅ Password cocok', 'success');
                    
                    // Set current user
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    log('✅ Current user diset', 'success');
                    
                    log('✅ LOGIN BERHASIL!', 'success');
                    log('Anda bisa kembali ke index.html', 'info');
                    
                } else {
                    log('❌ Password salah', 'error');
                }
                
            } catch (error) {
                log(`❌ Error dalam test login: ${error.message}`, 'error');
            }
        }

        // Auto-run diagnosis saat halaman dimuat
        window.addEventListener('load', function() {
            log('Emergency Login Fix Tool siap digunakan', 'success');
            log('Klik "Diagnosis Lengkap" untuk memulai', 'info');
        });
    </script>
</body>
</html>