<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Rollback Mechanism</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body>
    <div class="container mt-5">
        <h2><i class="bi bi-arrow-counterclockwise me-2"></i>Test Rollback Mechanism</h2>
        <p class="text-muted">Testing error handling and rollback mechanism in processPengembalian()</p>
        
        <div class="card mt-4">
            <div class="card-header bg-primary text-white">
                <h5><i class="bi bi-gear me-2"></i>Setup Test Data</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-primary" onclick="setupTestData()">Setup Test Data</button>
                <button class="btn btn-danger" onclick="clearTestData()">Clear Test Data</button>
                <div id="setupResult" class="mt-3"></div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header bg-warning text-dark">
                <h5><i class="bi bi-exclamation-triangle me-2"></i>Test Cases</h5>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <h6>Test 1: Snapshot Creation</h6>
                    <p class="text-muted">Verifikasi bahwa snapshot dibuat dengan benar</p>
                    <button class="btn btn-sm btn-success" onclick="testSnapshotCreation()">Run Test</button>
                    <div id="test1Result" class="mt-2"></div>
                </div>
                
                <div class="mb-4">
                    <h6>Test 2: Rollback on Error</h6>
                    <p class="text-muted">Verifikasi bahwa data dikembalikan ke kondisi awal saat terjadi error</p>
                    <button class="btn btn-sm btn-warning" onclick="testRollbackOnError()">Run Test</button>
                    <div id="test2Result" class="mt-2"></div>
                </div>
                
                <div class="mb-4">
                    <h6>Test 3: Audit Log for Failed Pengembalian</h6>
                    <p class="text-muted">Verifikasi bahwa audit log dibuat saat pengembalian gagal</p>
                    <button class="btn btn-sm btn-info" onclick="testAuditLogOnError()">Run Test</button>
                    <div id="test3Result" class="mt-2"></div>
                </div>
                
                <div class="mb-4">
                    <h6>Test 4: Successful Pengembalian (No Rollback)</h6>
                    <p class="text-muted">Verifikasi bahwa pengembalian berhasil tanpa rollback</p>
                    <button class="btn btn-sm btn-primary" onclick="testSuccessfulPengembalian()">Run Test</button>
                    <div id="test4Result" class="mt-2"></div>
                </div>
                
                <div class="mb-4">
                    <h6>Test 5: Simpanan Data Preserved in Snapshot</h6>
                    <p class="text-muted">Verifikasi bahwa data simpanan disimpan dalam snapshot</p>
                    <button class="btn btn-sm btn-secondary" onclick="testSimpananInSnapshot()">Run Test</button>
                    <div id="test5Result" class="mt-2"></div>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <h5><i class="bi bi-list-check me-2"></i>Test Summary</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-info" onclick="runAllTests()">Run All Tests</button>
                <div id="summaryResult" class="mt-3"></div>
            </div>
        </div>
    </div>
    
    <script src="js/utils.js"></script>
    <script src="js/anggotaKeluarRepository.js"></script>
    <script src="js/anggotaKeluarManager.js"></script>
    <script>
        // Mock functions if not available
        if (typeof getAnggotaById === 'undefined') {
            function getAnggotaById(id) {
                const anggota = JSON.parse(localStorage.getItem('anggota') || '[]');
                return anggota.find(a => a.id === id);
            }
        }
        
        if (typeof generateId === 'undefined') {
            function generateId() {
                return 'test-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            }
        }
        
        if (typeof addJurnal === 'undefined') {
            function addJurnal(keterangan, entries, tanggal) {
                const jurnal = JSON.parse(localStorage.getItem('jurnal') || '[]');
                jurnal.push({
                    id: generateId(),
                    tanggal: tanggal,
                    keterangan: keterangan,
                    entries: entries
                });
                localStorage.setItem('jurnal', JSON.stringify(jurnal));
            }
        }
        
        function setupTestData() {
            // Create test anggota
            const anggota = {
                id: 'test-anggota-rollback',
                nama: 'Test Anggota Rollback',
                nik: '1234567890123456',
                noKartu: 'K-ROLLBACK',
                departemen: 'IT',
                tipeAnggota: 'Anggota',
                statusKeanggotaan: 'Keluar',
                tanggalKeluar: '2024-01-15',
                alasanKeluar: 'Test rollback',
                pengembalianStatus: 'Pending',
                pengembalianId: null
            };
            
            // Create test simpanan
            const simpananPokok = {
                id: 'sp-test-rollback',
                anggotaId: 'test-anggota-rollback',
                jumlah: 500000,
                tanggal: '2024-01-01',
                statusPengembalian: 'Aktif'
            };
            
            const simpananWajib = {
                id: 'sw-test-rollback',
                anggotaId: 'test-anggota-rollback',
                jumlah: 1500000,
                periode: '2024-01',
                tanggal: '2024-01-01',
                statusPengembalian: 'Aktif'
            };
            
            // Create current user
            const currentUser = {
                id: 'user-test',
                username: 'testuser',
                name: 'Test User'
            };
            
            // Save to localStorage
            localStorage.setItem('anggota', JSON.stringify([anggota]));
            localStorage.setItem('simpananPokok', JSON.stringify([simpananPokok]));
            localStorage.setItem('simpananWajib', JSON.stringify([simpananWajib]));
            localStorage.setItem('simpananSukarela', JSON.stringify([]));
            localStorage.setItem('pengembalian', JSON.stringify([]));
            localStorage.setItem('jurnal', JSON.stringify([]));
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            localStorage.setItem('auditLogsAnggotaKeluar', JSON.stringify([]));
            
            document.getElementById('setupResult').innerHTML = `
                <div class="alert alert-success">
                    <strong>Test data berhasil dibuat!</strong><br>
                    - Anggota: ${anggota.nama}<br>
                    - Simpanan Pokok: Rp ${simpananPokok.jumlah.toLocaleString('id-ID')}<br>
                    - Simpanan Wajib: Rp ${simpananWajib.jumlah.toLocaleString('id-ID')}
                </div>
            `;
        }
        
        function clearTestData() {
            localStorage.removeItem('anggota');
            localStorage.removeItem('simpananPokok');
            localStorage.removeItem('simpananWajib');
            localStorage.removeItem('simpananSukarela');
            localStorage.removeItem('pengembalian');
            localStorage.removeItem('jurnal');
            localStorage.removeItem('auditLogsAnggotaKeluar');
            
            document.getElementById('setupResult').innerHTML = `
                <div class="alert alert-info">Test data dihapus</div>
            `;
        }
        
        function testSnapshotCreation() {
            try {
                const snapshot = createSnapshot();
                
                const checks = {
                    'Has anggota': snapshot.anggota !== null && snapshot.anggota !== undefined,
                    'Has pengembalian': snapshot.pengembalian !== null && snapshot.pengembalian !== undefined,
                    'Has jurnal': snapshot.jurnal !== null && snapshot.jurnal !== undefined,
                    'Has simpananPokok': snapshot.simpananPokok !== null && snapshot.simpananPokok !== undefined,
                    'Has simpananWajib': snapshot.simpananWajib !== null && snapshot.simpananWajib !== undefined,
                    'Has simpananSukarela': snapshot.simpananSukarela !== null && snapshot.simpananSukarela !== undefined
                };
                
                const passed = Object.values(checks).filter(v => v).length;
                const total = Object.keys(checks).length;
                
                let checklistHTML = '<ul class="mb-0">';
                for (const [check, result] of Object.entries(checks)) {
                    checklistHTML += `<li>${result ? '✓' : '✗'} ${check}</li>`;
                }
                checklistHTML += '</ul>';
                
                if (passed === total) {
                    document.getElementById('test1Result').innerHTML = `
                        <div class="alert alert-success">
                            ✓ PASS: Snapshot berhasil dibuat dengan semua data (${passed}/${total})<br>
                            ${checklistHTML}
                        </div>
                    `;
                } else {
                    document.getElementById('test1Result').innerHTML = `
                        <div class="alert alert-warning">
                            ⚠ PARTIAL: ${passed}/${total} data tersimpan<br>
                            ${checklistHTML}
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('test1Result').innerHTML = `
                    <div class="alert alert-danger">
                        ✗ FAIL: ${error.message}
                    </div>
                `;
            }
        }
        
        function testRollbackOnError() {
            try {
                // Save initial state
                const initialAnggota = localStorage.getItem('anggota');
                const initialSimpananPokok = localStorage.getItem('simpananPokok');
                const initialSimpananWajib = localStorage.getItem('simpananWajib');
                
                // Create snapshot
                const snapshot = createSnapshot();
                
                // Modify data
                const anggota = JSON.parse(localStorage.getItem('anggota') || '[]');
                anggota[0].pengembalianStatus = 'Selesai';
                localStorage.setItem('anggota', JSON.stringify(anggota));
                
                const simpananPokok = JSON.parse(localStorage.getItem('simpananPokok') || '[]');
                simpananPokok[0].jumlah = 0;
                localStorage.setItem('simpananPokok', JSON.stringify(simpananPokok));
                
                // Verify data changed
                const modifiedAnggota = localStorage.getItem('anggota');
                const modifiedSimpananPokok = localStorage.getItem('simpananPokok');
                
                const dataChanged = (modifiedAnggota !== initialAnggota) && 
                                   (modifiedSimpananPokok !== initialSimpananPokok);
                
                // Restore snapshot (rollback)
                restoreSnapshot(snapshot);
                
                // Verify data restored
                const restoredAnggota = localStorage.getItem('anggota');
                const restoredSimpananPokok = localStorage.getItem('simpananPokok');
                const restoredSimpananWajib = localStorage.getItem('simpananWajib');
                
                const dataRestored = (restoredAnggota === initialAnggota) && 
                                    (restoredSimpananPokok === initialSimpananPokok) &&
                                    (restoredSimpananWajib === initialSimpananWajib);
                
                if (dataChanged && dataRestored) {
                    document.getElementById('test2Result').innerHTML = `
                        <div class="alert alert-success">
                            ✓ PASS: Rollback berhasil mengembalikan data ke kondisi awal<br>
                            <small>
                            - Data berhasil dimodifikasi: ${dataChanged ? 'Ya' : 'Tidak'}<br>
                            - Data berhasil dikembalikan: ${dataRestored ? 'Ya' : 'Tidak'}
                            </small>
                        </div>
                    `;
                } else {
                    document.getElementById('test2Result').innerHTML = `
                        <div class="alert alert-danger">
                            ✗ FAIL: Rollback tidak berfungsi dengan benar<br>
                            <small>
                            - Data berhasil dimodifikasi: ${dataChanged ? 'Ya' : 'Tidak'}<br>
                            - Data berhasil dikembalikan: ${dataRestored ? 'Ya' : 'Tidak'}
                            </small>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('test2Result').innerHTML = `
                    <div class="alert alert-danger">
                        ✗ FAIL: ${error.message}
                    </div>
                `;
            }
        }
        
        function testAuditLogOnError() {
            try {
                // Clear audit logs
                localStorage.setItem('auditLogsAnggotaKeluar', JSON.stringify([]));
                
                // Try to process pengembalian with invalid data (should fail)
                const result = processPengembalian('test-anggota-rollback', '', '2024-01-20');
                
                // Check audit logs
                const auditLogs = JSON.parse(localStorage.getItem('auditLogsAnggotaKeluar') || '[]');
                const errorLogs = auditLogs.filter(log => 
                    log.action === 'PROSES_PENGEMBALIAN_FAILED' || 
                    log.action === 'PROSES_PENGEMBALIAN_ERROR'
                );
                
                if (!result.success && errorLogs.length > 0) {
                    document.getElementById('test3Result').innerHTML = `
                        <div class="alert alert-success">
                            ✓ PASS: Audit log dibuat untuk pengembalian yang gagal<br>
                            <small>
                            - Pengembalian gagal: ${!result.success ? 'Ya' : 'Tidak'}<br>
                            - Error logs dibuat: ${errorLogs.length}<br>
                            - Action: ${errorLogs[0]?.action}<br>
                            - Error: ${result.error?.message}
                            </small>
                        </div>
                    `;
                } else {
                    document.getElementById('test3Result').innerHTML = `
                        <div class="alert alert-warning">
                            ⚠ WARNING: Audit log tidak dibuat atau pengembalian tidak gagal<br>
                            <small>
                            - Pengembalian gagal: ${!result.success ? 'Ya' : 'Tidak'}<br>
                            - Error logs dibuat: ${errorLogs.length}
                            </small>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('test3Result').innerHTML = `
                    <div class="alert alert-danger">
                        ✗ FAIL: ${error.message}
                    </div>
                `;
            }
        }
        
        function testSuccessfulPengembalian() {
            try {
                // Setup fresh data
                setupTestData();
                
                // Process pengembalian with valid data
                const result = processPengembalian('test-anggota-rollback', 'Kas', '2024-01-20', 'Test successful');
                
                if (result.success) {
                    // Verify data changed
                    const anggota = JSON.parse(localStorage.getItem('anggota') || '[]')[0];
                    const simpananPokok = JSON.parse(localStorage.getItem('simpananPokok') || '[]')[0];
                    const simpananWajib = JSON.parse(localStorage.getItem('simpananWajib') || '[]')[0];
                    const pengembalian = JSON.parse(localStorage.getItem('pengembalian') || '[]');
                    
                    const checks = {
                        'Pengembalian record created': pengembalian.length > 0,
                        'Anggota status updated': anggota.pengembalianStatus === 'Selesai',
                        'Simpanan pokok zeroed': simpananPokok.jumlah === 0,
                        'Simpanan wajib zeroed': simpananWajib.jumlah === 0,
                        'Historical data saved': simpananPokok.saldoSebelumPengembalian > 0
                    };
                    
                    const passed = Object.values(checks).filter(v => v).length;
                    const total = Object.keys(checks).length;
                    
                    let checklistHTML = '<ul class="mb-0">';
                    for (const [check, result] of Object.entries(checks)) {
                        checklistHTML += `<li>${result ? '✓' : '✗'} ${check}</li>`;
                    }
                    checklistHTML += '</ul>';
                    
                    if (passed === total) {
                        document.getElementById('test4Result').innerHTML = `
                            <div class="alert alert-success">
                                ✓ PASS: Pengembalian berhasil tanpa rollback (${passed}/${total})<br>
                                ${checklistHTML}
                                <small class="mt-2 d-block">Nomor Referensi: ${result.data.nomorReferensi}</small>
                            </div>
                        `;
                    } else {
                        document.getElementById('test4Result').innerHTML = `
                            <div class="alert alert-warning">
                                ⚠ PARTIAL: ${passed}/${total} checks passed<br>
                                ${checklistHTML}
                            </div>
                        `;
                    }
                } else {
                    document.getElementById('test4Result').innerHTML = `
                        <div class="alert alert-danger">
                            ✗ FAIL: Pengembalian gagal<br>
                            <small>Error: ${result.error?.message}</small>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('test4Result').innerHTML = `
                    <div class="alert alert-danger">
                        ✗ FAIL: ${error.message}
                    </div>
                `;
            }
        }
        
        function testSimpananInSnapshot() {
            try {
                const snapshot = createSnapshot();
                
                // Verify simpanan data is in snapshot
                const hasSimpananPokok = snapshot.simpananPokok !== null;
                const hasSimpananWajib = snapshot.simpananWajib !== null;
                const hasSimpananSukarela = snapshot.simpananSukarela !== null;
                
                // Parse and verify content
                let simpananPokokValid = false;
                let simpananWajibValid = false;
                
                if (hasSimpananPokok) {
                    const data = JSON.parse(snapshot.simpananPokok);
                    simpananPokokValid = Array.isArray(data);
                }
                
                if (hasSimpananWajib) {
                    const data = JSON.parse(snapshot.simpananWajib);
                    simpananWajibValid = Array.isArray(data);
                }
                
                const allValid = hasSimpananPokok && hasSimpananWajib && hasSimpananSukarela &&
                                simpananPokokValid && simpananWajibValid;
                
                if (allValid) {
                    document.getElementById('test5Result').innerHTML = `
                        <div class="alert alert-success">
                            ✓ PASS: Semua data simpanan tersimpan dalam snapshot<br>
                            <small>
                            - Simpanan Pokok: ${hasSimpananPokok ? 'Ada' : 'Tidak ada'} (Valid: ${simpananPokokValid})<br>
                            - Simpanan Wajib: ${hasSimpananWajib ? 'Ada' : 'Tidak ada'} (Valid: ${simpananWajibValid})<br>
                            - Simpanan Sukarela: ${hasSimpananSukarela ? 'Ada' : 'Tidak ada'}
                            </small>
                        </div>
                    `;
                } else {
                    document.getElementById('test5Result').innerHTML = `
                        <div class="alert alert-warning">
                            ⚠ WARNING: Tidak semua data simpanan tersimpan dengan benar<br>
                            <small>
                            - Simpanan Pokok: ${hasSimpananPokok ? 'Ada' : 'Tidak ada'} (Valid: ${simpananPokokValid})<br>
                            - Simpanan Wajib: ${hasSimpananWajib ? 'Ada' : 'Tidak ada'} (Valid: ${simpananWajibValid})<br>
                            - Simpanan Sukarela: ${hasSimpananSukarela ? 'Ada' : 'Tidak ada'}
                            </small>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('test5Result').innerHTML = `
                    <div class="alert alert-danger">
                        ✗ FAIL: ${error.message}
                    </div>
                `;
            }
        }
        
        function runAllTests() {
            setupTestData();
            
            setTimeout(() => {
                testSnapshotCreation();
                testRollbackOnError();
                testAuditLogOnError();
                
                setTimeout(() => {
                    testSimpananInSnapshot();
                    testSuccessfulPengembalian();
                    
                    setTimeout(() => {
                        document.getElementById('summaryResult').innerHTML = `
                            <div class="alert alert-info">
                                <strong>Semua test selesai!</strong><br>
                                Periksa hasil setiap test di atas.
                            </div>
                        `;
                    }, 500);
                }, 1000);
            }, 500);
        }
    </script>
</body>
</html>
