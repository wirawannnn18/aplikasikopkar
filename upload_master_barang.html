<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Master Barang - Koperasi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .upload-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .upload-card {
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            margin-bottom: 1rem;
        }
        .drop-zone {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .drop-zone:hover {
            border-color: #667eea;
            background-color: #f8f9fa;
        }
        .drop-zone.dragover {
            border-color: #667eea;
            background-color: #e3f2fd;
        }
        .file-input {
            display: none;
        }
        .preview-table {
            max-height: 400px;
            overflow-y: auto;
        }
        .validation-error {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        .validation-warning {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        .validation-success {
            background-color: #d1edff;
            border-left: 4px solid #0dcaf0;
        }
        .progress-container {
            display: none;
        }
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
        }
        .step {
            flex: 1;
            text-align: center;
            padding: 1rem;
            border-radius: 5px;
            margin: 0 0.5rem;
            background-color: #f8f9fa;
            color: #6c757d;
        }
        .step.active {
            background-color: #667eea;
            color: white;
        }
        .step.completed {
            background-color: #28a745;
            color: white;
        }
        .category-badge {
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Header -->
    <div class="upload-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-0"><i class="fas fa-upload me-3"></i>Upload Master Barang</h1>
                    <p class="mb-0 mt-2">Upload data barang dengan kategori dan satuan secara massal menggunakan file CSV</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light" onclick="window.history.back()">
                        <i class="fas fa-arrow-left me-2"></i>Kembali
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step active" id="step1">
                <i class="fas fa-file-upload d-block mb-2"></i>
                <span>1. Upload File</span>
            </div>
            <div class="step" id="step2">
                <i class="fas fa-eye d-block mb-2"></i>
                <span>2. Preview Data</span>
            </div>
            <div class="step" id="step3">
                <i class="fas fa-check-circle d-block mb-2"></i>
                <span>3. Validasi</span>
            </div>
            <div class="step" id="step4">
                <i class="fas fa-save d-block mb-2"></i>
                <span>4. Import</span>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="card upload-card" id="uploadSection">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-cloud-upload-alt me-2"></i>Upload File CSV</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="drop-zone" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <h5>Drag & Drop file CSV di sini</h5>
                            <p class="text-muted">atau klik untuk memilih file</p>
                            <input type="file" id="fileInput" class="file-input" accept=".csv" onchange="handleFileSelect(event)">
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Format yang didukung: CSV (maksimal 5MB)
                            </small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6>Template CSV</h6>
                        <p class="small text-muted">Download template untuk format yang benar:</p>
                        <button class="btn btn-outline-success btn-sm mb-2" onclick="downloadTemplate()">
                            <i class="fas fa-download me-1"></i>Download Template
                        </button>
                        <div class="alert alert-info p-2">
                            <small>
                                <strong>Format CSV:</strong><br>
                                kode,nama,kategori,satuan,harga_beli,stok,supplier
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Preview Section -->
        <div class="card upload-card" id="previewSection" style="display: none;">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-table me-2"></i>Preview Data</h5>
                <div>
                    <span class="badge bg-light text-dark me-2" id="recordCount">0 records</span>
                    <button class="btn btn-sm btn-outline-light" onclick="editData()">
                        <i class="fas fa-edit me-1"></i>Edit
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="preview-table">
                    <table class="table table-hover mb-0" id="previewTable">
                        <thead class="table-light">
                            <tr>
                                <th width="10%">Kode</th>
                                <th width="25%">Nama Barang</th>
                                <th width="15%">Kategori</th>
                                <th width="10%">Satuan</th>
                                <th width="15%">Harga Beli</th>
                                <th width="10%">Stok</th>
                                <th width="15%">Supplier</th>
                            </tr>
                        </thead>
                        <tbody id="previewTableBody">
                            <!-- Data akan diisi oleh JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <button class="btn btn-success" onclick="validateData()">
                    <i class="fas fa-check me-1"></i>Lanjut ke Validasi
                </button>
                <button class="btn btn-secondary ms-2" onclick="resetUpload()">
                    <i class="fas fa-redo me-1"></i>Upload Ulang
                </button>
            </div>
        </div>

        <!-- Validation Section -->
        <div class="card upload-card" id="validationSection" style="display: none;">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Validasi Data</h5>
            </div>
            <div class="card-body">
                <div id="validationResults">
                    <!-- Hasil validasi akan diisi oleh JavaScript -->
                </div>
            </div>
            <div class="card-footer">
                <button class="btn btn-primary" onclick="importData()" id="importBtn" disabled>
                    <i class="fas fa-database me-1"></i>Import Data
                </button>
                <button class="btn btn-secondary ms-2" onclick="showPreview()">
                    <i class="fas fa-arrow-left me-1"></i>Kembali ke Preview
                </button>
            </div>
        </div>

        <!-- Progress Section -->
        <div class="card upload-card progress-container" id="progressSection">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-cog fa-spin me-2"></i>Mengimport Data...</h5>
            </div>
            <div class="card-body">
                <div class="progress mb-3" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         id="importProgress" style="width: 0%">0%</div>
                </div>
                <div id="importStatus">Memulai import...</div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="card upload-card" id="resultsSection" style="display: none;">
            <div class="card-header text-white" id="resultsHeader">
                <h5 class="mb-0"><i class="fas fa-flag-checkered me-2"></i>Hasil Import</h5>
            </div>
            <div class="card-body">
                <div id="resultsContent">
                    <!-- Hasil import akan diisi oleh JavaScript -->
                </div>
            </div>
            <div class="card-footer">
                <button class="btn btn-primary" onclick="viewMasterBarang()">
                    <i class="fas fa-list me-1"></i>Lihat Master Barang
                </button>
                <button class="btn btn-success ms-2" onclick="resetUpload()">
                    <i class="fas fa-plus me-1"></i>Upload Lagi
                </button>
            </div>
        </div>

        <!-- Category & Unit Management -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card upload-card">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0"><i class="fas fa-tags me-2"></i>Kelola Kategori</h6>
                    </div>
                    <div class="card-body">
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="newCategory" placeholder="Nama kategori baru">
                            <button class="btn btn-outline-primary" onclick="addCategory()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div id="categoryList">
                            <!-- Daftar kategori akan diisi oleh JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card upload-card">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0"><i class="fas fa-balance-scale me-2"></i>Kelola Satuan</h6>
                    </div>
                    <div class="card-body">
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="newUnit" placeholder="Nama satuan baru">
                            <button class="btn btn-outline-primary" onclick="addUnit()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div id="unitList">
                            <!-- Daftar satuan akan diisi oleh JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let uploadedData = [];
        let validationErrors = [];
        let categories = [];
        let units = [];
        let currentStep = 1;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadCategories();
            loadUnits();
            setupDragAndDrop();
        });

        // Setup drag and drop functionality
        function setupDragAndDrop() {
            const dropZone = document.querySelector('.drop-zone');
            
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dropZone.classList.remove('dragover');
            });
            
            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
        }

        // Handle file selection
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        // Handle file processing
        function handleFile(file) {
            // Validate file type
            if (!file.name.toLowerCase().endsWith('.csv')) {
                alert('Hanya file CSV yang diperbolehkan!');
                return;
            }

            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                alert('Ukuran file maksimal 5MB!');
                return;
            }

            // Read file
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    parseCSV(e.target.result);
                    showPreview();
                    updateStep(2);
                } catch (error) {
                    alert('Error membaca file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Parse CSV data
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            
            // Validate headers
            const requiredHeaders = ['kode', 'nama', 'kategori', 'satuan', 'harga_beli', 'stok', 'supplier'];
            const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
            
            if (missingHeaders.length > 0) {
                throw new Error(`Header yang hilang: ${missingHeaders.join(', ')}`);
            }

            uploadedData = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',').map(v => v.trim());
                    const item = {};
                    
                    headers.forEach((header, index) => {
                        item[header] = values[index] || '';
                    });
                    
                    // Convert numeric fields
                    item.harga_beli = parseFloat(item.harga_beli) || 0;
                    item.stok = parseInt(item.stok) || 0;
                    
                    uploadedData.push(item);
                }
            }

            document.getElementById('recordCount').textContent = `${uploadedData.length} records`;
        }

        // Show preview
        function showPreview() {
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('previewSection').style.display = 'block';
            document.getElementById('validationSection').style.display = 'none';
            
            renderPreviewTable();
            updateStep(2);
        }

        // Render preview table
        function renderPreviewTable() {
            const tbody = document.getElementById('previewTableBody');
            tbody.innerHTML = '';

            uploadedData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${item.kode}</strong></td>
                    <td>${item.nama}</td>
                    <td><span class="badge bg-secondary category-badge">${item.kategori}</span></td>
                    <td><span class="badge bg-info category-badge">${item.satuan}</span></td>
                    <td>Rp ${formatRupiah(item.harga_beli)}</td>
                    <td>${item.stok}</td>
                    <td>${item.supplier}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Validate data
        function validateData() {
            validationErrors = [];
            const existingItems = JSON.parse(localStorage.getItem('masterBarang') || '[]');
            const existingCodes = existingItems.map(item => item.kode);

            uploadedData.forEach((item, index) => {
                const errors = [];
                const warnings = [];

                // Validate required fields
                if (!item.kode) errors.push('Kode barang wajib diisi');
                if (!item.nama) errors.push('Nama barang wajib diisi');
                if (!item.kategori) errors.push('Kategori wajib diisi');
                if (!item.satuan) errors.push('Satuan wajib diisi');

                // Validate data types
                if (item.harga_beli < 0) errors.push('Harga beli tidak boleh negatif');
                if (item.stok < 0) errors.push('Stok tidak boleh negatif');

                // Check for duplicates in upload
                const duplicateInUpload = uploadedData.findIndex((other, otherIndex) => 
                    otherIndex !== index && other.kode === item.kode
                );
                if (duplicateInUpload !== -1) {
                    errors.push(`Kode duplikat dalam file (baris ${duplicateInUpload + 2})`);
                }

                // Check for existing items
                if (existingCodes.includes(item.kode)) {
                    warnings.push('Kode sudah ada, akan diupdate');
                }

                // Check category and unit existence
                if (!categories.includes(item.kategori.toLowerCase())) {
                    warnings.push('Kategori baru akan dibuat');
                }
                if (!units.includes(item.satuan.toLowerCase())) {
                    warnings.push('Satuan baru akan dibuat');
                }

                if (errors.length > 0 || warnings.length > 0) {
                    validationErrors.push({
                        index: index,
                        item: item,
                        errors: errors,
                        warnings: warnings
                    });
                }
            });

            showValidationResults();
            updateStep(3);
        }

        // Show validation results
        function showValidationResults() {
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('validationSection').style.display = 'block';

            const resultsContainer = document.getElementById('validationResults');
            resultsContainer.innerHTML = '';

            if (validationErrors.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="alert alert-success validation-success">
                        <h6><i class="fas fa-check-circle me-2"></i>Validasi Berhasil</h6>
                        <p class="mb-0">Semua data valid dan siap untuk diimport (${uploadedData.length} items).</p>
                    </div>
                `;
                document.getElementById('importBtn').disabled = false;
            } else {
                const errorCount = validationErrors.filter(e => e.errors.length > 0).length;
                const warningCount = validationErrors.filter(e => e.warnings.length > 0 && e.errors.length === 0).length;

                let summaryHtml = `
                    <div class="alert ${errorCount > 0 ? 'alert-danger validation-error' : 'alert-warning validation-warning'}">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Hasil Validasi</h6>
                        <p class="mb-0">
                            ${errorCount > 0 ? `${errorCount} error(s) ditemukan. ` : ''}
                            ${warningCount > 0 ? `${warningCount} warning(s) ditemukan.` : ''}
                        </p>
                    </div>
                `;

                validationErrors.forEach(validation => {
                    const hasErrors = validation.errors.length > 0;
                    summaryHtml += `
                        <div class="alert ${hasErrors ? 'alert-danger' : 'alert-warning'} py-2 mb-2">
                            <strong>Baris ${validation.index + 2}: ${validation.item.kode} - ${validation.item.nama}</strong>
                            ${validation.errors.map(error => `<div class="text-danger small"><i class="fas fa-times me-1"></i>${error}</div>`).join('')}
                            ${validation.warnings.map(warning => `<div class="text-warning small"><i class="fas fa-exclamation-triangle me-1"></i>${warning}</div>`).join('')}
                        </div>
                    `;
                });

                resultsContainer.innerHTML = summaryHtml;
                document.getElementById('importBtn').disabled = errorCount > 0;
            }
        }

        // Import data
        async function importData() {
            document.getElementById('validationSection').style.display = 'none';
            document.getElementById('progressSection').style.display = 'block';
            updateStep(4);

            const progressBar = document.getElementById('importProgress');
            const statusDiv = document.getElementById('importStatus');
            
            let imported = 0;
            let updated = 0;
            let failed = 0;

            try {
                // Load existing data
                const existingItems = JSON.parse(localStorage.getItem('masterBarang') || '[]');
                const existingMap = new Map(existingItems.map(item => [item.kode, item]));

                // Process each item
                for (let i = 0; i < uploadedData.length; i++) {
                    const item = uploadedData[i];
                    const progress = ((i + 1) / uploadedData.length) * 100;
                    
                    progressBar.style.width = `${progress}%`;
                    progressBar.textContent = `${Math.round(progress)}%`;
                    statusDiv.textContent = `Processing ${item.kode} - ${item.nama}...`;

                    try {
                        // Add/update categories and units
                        await addCategoryIfNotExists(item.kategori);
                        await addUnitIfNotExists(item.satuan);

                        // Prepare item data
                        const itemData = {
                            kode: item.kode,
                            nama: item.nama,
                            kategori: item.kategori.toLowerCase(),
                            satuan: item.satuan.toLowerCase(),
                            hargaBeli: item.harga_beli,
                            stok: item.stok,
                            supplier: item.supplier,
                            tanggalBuat: existingMap.has(item.kode) ? existingMap.get(item.kode).tanggalBuat : new Date().toISOString(),
                            tanggalUpdate: new Date().toISOString()
                        };

                        if (existingMap.has(item.kode)) {
                            // Update existing item
                            existingMap.set(item.kode, itemData);
                            updated++;
                        } else {
                            // Add new item
                            existingMap.set(item.kode, itemData);
                            imported++;
                        }

                        // Simulate processing delay
                        await new Promise(resolve => setTimeout(resolve, 50));

                    } catch (error) {
                        console.error(`Error processing ${item.kode}:`, error);
                        failed++;
                    }
                }

                // Save to localStorage
                const finalData = Array.from(existingMap.values());
                localStorage.setItem('masterBarang', JSON.stringify(finalData));

                // Log activity
                logActivity({
                    timestamp: new Date().toISOString(),
                    user: getCurrentUser(),
                    action: 'BULK_IMPORT_MASTER_BARANG',
                    details: `Import ${imported} new items, updated ${updated} items, ${failed} failed`,
                    data: { imported, updated, failed, total: uploadedData.length }
                });

                showResults(imported, updated, failed);

            } catch (error) {
                console.error('Import error:', error);
                showError('Terjadi kesalahan saat import: ' + error.message);
            }
        }

        // Show import results
        function showResults(imported, updated, failed) {
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';

            const isSuccess = failed === 0;
            const resultsHeader = document.getElementById('resultsHeader');
            resultsHeader.className = `card-header text-white ${isSuccess ? 'bg-success' : 'bg-warning'}`;

            const resultsContent = document.getElementById('resultsContent');
            resultsContent.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center">
                            <h4 class="text-success">${imported}</h4>
                            <small class="text-muted">Items Baru</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <h4 class="text-info">${updated}</h4>
                            <small class="text-muted">Items Diupdate</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <h4 class="text-danger">${failed}</h4>
                            <small class="text-muted">Gagal</small>
                        </div>
                    </div>
                </div>
                <div class="alert ${isSuccess ? 'alert-success' : 'alert-warning'} mt-3">
                    <h6><i class="fas ${isSuccess ? 'fa-check-circle' : 'fa-exclamation-triangle'} me-2"></i>
                        ${isSuccess ? 'Import Berhasil!' : 'Import Selesai dengan Peringatan'}
                    </h6>
                    <p class="mb-0">
                        ${isSuccess ? 
                            'Semua data berhasil diimport ke master barang.' : 
                            `Import selesai dengan ${failed} item yang gagal diproses.`
                        }
                    </p>
                </div>
            `;
        }

        // Category and Unit Management
        function loadCategories() {
            const stored = localStorage.getItem('masterBarangCategories');
            categories = stored ? JSON.parse(stored) : ['makanan', 'minuman', 'alat-tulis', 'elektronik', 'kebersihan', 'lainnya'];
            renderCategoryList();
        }

        function loadUnits() {
            const stored = localStorage.getItem('masterBarangUnits');
            units = stored ? JSON.parse(stored) : ['pcs', 'kg', 'gram', 'liter', 'ml', 'box', 'pack', 'botol', 'kaleng', 'meter'];
            renderUnitList();
        }

        function renderCategoryList() {
            const container = document.getElementById('categoryList');
            container.innerHTML = '';
            
            categories.forEach(category => {
                const badge = document.createElement('span');
                badge.className = 'badge bg-secondary me-1 mb-1';
                badge.innerHTML = `${category} <i class="fas fa-times ms-1" onclick="removeCategory('${category}')" style="cursor: pointer;"></i>`;
                container.appendChild(badge);
            });
        }

        function renderUnitList() {
            const container = document.getElementById('unitList');
            container.innerHTML = '';
            
            units.forEach(unit => {
                const badge = document.createElement('span');
                badge.className = 'badge bg-info me-1 mb-1';
                badge.innerHTML = `${unit} <i class="fas fa-times ms-1" onclick="removeUnit('${unit}')" style="cursor: pointer;"></i>`;
                container.appendChild(badge);
            });
        }

        function addCategory() {
            const input = document.getElementById('newCategory');
            const category = input.value.trim().toLowerCase();
            
            if (category && !categories.includes(category)) {
                categories.push(category);
                localStorage.setItem('masterBarangCategories', JSON.stringify(categories));
                renderCategoryList();
                input.value = '';
            }
        }

        function addUnit() {
            const input = document.getElementById('newUnit');
            const unit = input.value.trim().toLowerCase();
            
            if (unit && !units.includes(unit)) {
                units.push(unit);
                localStorage.setItem('masterBarangUnits', JSON.stringify(units));
                renderUnitList();
                input.value = '';
            }
        }

        function removeCategory(category) {
            categories = categories.filter(c => c !== category);
            localStorage.setItem('masterBarangCategories', JSON.stringify(categories));
            renderCategoryList();
        }

        function removeUnit(unit) {
            units = units.filter(u => u !== unit);
            localStorage.setItem('masterBarangUnits', JSON.stringify(units));
            renderUnitList();
        }

        async function addCategoryIfNotExists(category) {
            const lowerCategory = category.toLowerCase();
            if (!categories.includes(lowerCategory)) {
                categories.push(lowerCategory);
                localStorage.setItem('masterBarangCategories', JSON.stringify(categories));
                renderCategoryList();
            }
        }

        async function addUnitIfNotExists(unit) {
            const lowerUnit = unit.toLowerCase();
            if (!units.includes(lowerUnit)) {
                units.push(lowerUnit);
                localStorage.setItem('masterBarangUnits', JSON.stringify(units));
                renderUnitList();
            }
        }

        // Utility functions
        function updateStep(step) {
            // Reset all steps
            for (let i = 1; i <= 4; i++) {
                const stepElement = document.getElementById(`step${i}`);
                stepElement.classList.remove('active', 'completed');
                
                if (i < step) {
                    stepElement.classList.add('completed');
                } else if (i === step) {
                    stepElement.classList.add('active');
                }
            }
            currentStep = step;
        }

        function resetUpload() {
            uploadedData = [];
            validationErrors = [];
            
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('validationSection').style.display = 'none';
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            
            document.getElementById('fileInput').value = '';
            updateStep(1);
        }

        function downloadTemplate() {
            const template = `kode,nama,kategori,satuan,harga_beli,stok,supplier
BRG001,Beras Premium 5kg,makanan,kg,65000,50,PT Beras Sejahtera
BRG002,Minyak Goreng 1L,makanan,botol,15000,30,CV Minyak Murni
BRG003,Pulpen Pilot Hitam,alat-tulis,pcs,3000,100,Toko ATK Lengkap
BRG004,Air Mineral 600ml,minuman,botol,2500,200,PT Air Bersih`;

            const blob = new Blob([template], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'template_master_barang.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function editData() {
            // Simple edit functionality - could be expanded
            alert('Fitur edit akan segera tersedia. Untuk saat ini, silakan edit file CSV dan upload ulang.');
        }

        function viewMasterBarang() {
            // Redirect to master barang page
            window.location.href = 'master_barang.html'; // Adjust URL as needed
        }

        function showError(message) {
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';
            
            const resultsHeader = document.getElementById('resultsHeader');
            resultsHeader.className = 'card-header text-white bg-danger';
            
            const resultsContent = document.getElementById('resultsContent');
            resultsContent.innerHTML = `
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-circle me-2"></i>Error</h6>
                    <p class="mb-0">${message}</p>
                </div>
            `;
        }

        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID').format(amount);
        }

        function getCurrentUser() {
            return localStorage.getItem('currentUser') || 'Admin';
        }

        function logActivity(entry) {
            const logs = JSON.parse(localStorage.getItem('activityLogs') || '[]');
            logs.push(entry);
            localStorage.setItem('activityLogs', JSON.stringify(logs));
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'u') {
                e.preventDefault();
                document.getElementById('fileInput').click();
            }
        });
    </script>
</body>
</html>