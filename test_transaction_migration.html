<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Transaction Migration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container py-4">
        <h2><i class="bi bi-database-gear"></i> Test Transaction Migration</h2>
        <p class="text-muted">Testing the migration of existing transaction data to include mode field</p>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-info-circle"></i> Migration Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="migrationStatus">Loading...</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-gear"></i> Actions</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary mb-2" onclick="createTestData()">
                            <i class="bi bi-plus-circle"></i> Create Test Data
                        </button>
                        <button class="btn btn-warning mb-2" onclick="runMigration()">
                            <i class="bi bi-arrow-repeat"></i> Run Migration
                        </button>
                        <button class="btn btn-info mb-2" onclick="testQueries()">
                            <i class="bi bi-search"></i> Test Queries
                        </button>
                        <button class="btn btn-danger mb-2" onclick="clearData()">
                            <i class="bi bi-trash"></i> Clear Data
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-table"></i> Transaction Data</h5>
                    </div>
                    <div class="card-body">
                        <div id="transactionData">No data</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-clipboard-data"></i> Test Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="testResults">No tests run</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/migration/TransactionMigration.js"></script>
    <script src="js/migration/UpdatedQueryFunctions.js"></script>

    <script>
        let migration = null;
        let queries = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            migration = new TransactionMigration();
            queries = new UpdatedTransactionQueries();
            updateMigrationStatus();
            displayTransactionData();
        });

        function updateMigrationStatus() {
            const status = migration.getMigrationStatus();
            const statusDiv = document.getElementById('migrationStatus');
            
            statusDiv.innerHTML = `
                <div class="mb-3">
                    <strong>Completed:</strong> 
                    <span class="badge ${status.completed ? 'bg-success' : 'bg-warning'}">
                        ${status.completed ? 'Yes' : 'No'}
                    </span>
                </div>
                ${status.timestamp ? `<div class="mb-2"><strong>Timestamp:</strong> ${new Date(status.timestamp).toLocaleString()}</div>` : ''}
                ${status.version ? `<div class="mb-2"><strong>Version:</strong> ${status.version}</div>` : ''}
                ${status.statistics ? `
                    <div class="mb-2"><strong>Statistics:</strong></div>
                    <ul class="list-unstyled ms-3">
                        <li>Total Transactions: ${status.statistics.totalTransactions}</li>
                        <li>With Mode Field: ${status.statistics.withModeField}</li>
                        <li>Manual Transactions: ${status.statistics.manualTransactions}</li>
                        <li>Import Transactions: ${status.statistics.importTransactions}</li>
                        <li>Needs Migration: ${status.statistics.needsMigration}</li>
                    </ul>
                ` : ''}
                ${status.error ? `<div class="alert alert-danger">Error: ${status.error}</div>` : ''}
            `;
        }

        function createTestData() {
            const testTransactions = [
                {
                    id: 'TEST001',
                    tanggal: '2024-01-15',
                    anggotaId: 'A001',
                    anggotaNama: 'John Doe',
                    anggotaNIK: '1234567890',
                    jenis: 'hutang',
                    jumlah: 100000,
                    saldoSebelum: 500000,
                    saldoSesudah: 400000,
                    keterangan: 'Test payment 1',
                    kasirId: 'K001',
                    kasirNama: 'Kasir 1',
                    status: 'selesai',
                    createdAt: '2024-01-15T10:00:00Z'
                },
                {
                    id: 'TEST002',
                    tanggal: '2024-01-16',
                    anggotaId: 'A002',
                    anggotaNama: 'Jane Smith',
                    anggotaNIK: '0987654321',
                    jenis: 'piutang',
                    jumlah: 200000,
                    saldoSebelum: 300000,
                    saldoSesudah: 100000,
                    keterangan: 'Test payment 2',
                    kasirId: 'K001',
                    kasirNama: 'Kasir 1',
                    status: 'selesai',
                    createdAt: '2024-01-16T11:00:00Z'
                },
                {
                    id: 'TEST003',
                    tanggal: '2024-01-17',
                    anggotaId: 'A001',
                    anggotaNama: 'John Doe',
                    anggotaNIK: '1234567890',
                    jenis: 'hutang',
                    jumlah: 150000,
                    saldoSebelum: 400000,
                    saldoSesudah: 250000,
                    keterangan: 'Test payment 3',
                    kasirId: 'K002',
                    kasirNama: 'Kasir 2',
                    status: 'selesai',
                    createdAt: '2024-01-17T14:00:00Z',
                    mode: 'manual' // This one already has mode field
                }
            ];

            localStorage.setItem('pembayaranHutangPiutang', JSON.stringify(testTransactions));
            
            showAlert('Test data created successfully!', 'success');
            updateMigrationStatus();
            displayTransactionData();
        }

        async function runMigration() {
            showAlert('Running migration...', 'info');
            
            const result = await migration.performMigration();
            
            if (result.success) {
                showAlert(`Migration completed successfully! ${result.message}`, 'success');
                if (result.statistics) {
                    console.log('Migration statistics:', result.statistics);
                }
            } else {
                showAlert(`Migration failed: ${result.message}`, 'danger');
                if (result.errors.length > 0) {
                    console.error('Migration errors:', result.errors);
                }
            }
            
            updateMigrationStatus();
            displayTransactionData();
        }

        function testQueries() {
            const results = [];
            
            try {
                // Test 1: Get all transactions
                const allTransactions = queries.getAllTransactions();
                results.push(`✅ Get all transactions: ${allTransactions.length} found`);
                
                // Test 2: Get manual transactions
                const manualTransactions = queries.getManualTransactions();
                results.push(`✅ Get manual transactions: ${manualTransactions.length} found`);
                
                // Test 3: Get import transactions
                const importTransactions = queries.getImportTransactions();
                results.push(`✅ Get import transactions: ${importTransactions.length} found`);
                
                // Test 4: Get transactions by jenis
                const hutangTransactions = queries.getTransactionsByJenis('hutang');
                results.push(`✅ Get hutang transactions: ${hutangTransactions.length} found`);
                
                const piutangTransactions = queries.getTransactionsByJenis('piutang');
                results.push(`✅ Get piutang transactions: ${piutangTransactions.length} found`);
                
                // Test 5: Get statistics
                const stats = queries.getTransactionStatistics();
                results.push(`✅ Get statistics: Total ${stats.total.count}, Manual ${stats.manual.count}, Import ${stats.import.count}`);
                
                // Test 6: Search transactions
                const searchResults = queries.searchTransactions('John');
                results.push(`✅ Search 'John': ${searchResults.length} found`);
                
                // Test 7: Test updated utility functions
                if (typeof window.hitungTotalPembayaranHutang === 'function') {
                    const totalHutang = window.hitungTotalPembayaranHutang('A001');
                    results.push(`✅ Calculate total hutang for A001: ${totalHutang}`);
                }
                
                if (typeof window.getPembayaranHutangHistory === 'function') {
                    const history = window.getPembayaranHutangHistory('A001');
                    results.push(`✅ Get hutang history for A001: ${history.length} transactions`);
                }
                
                showAlert('All query tests completed successfully!', 'success');
                
            } catch (error) {
                results.push(`❌ Error during testing: ${error.message}`);
                showAlert('Some query tests failed. Check console for details.', 'warning');
                console.error('Query test error:', error);
            }
            
            document.getElementById('testResults').innerHTML = `
                <div class="alert alert-info">
                    <h6>Query Test Results:</h6>
                    <ul class="mb-0">
                        ${results.map(result => `<li>${result}</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        function displayTransactionData() {
            try {
                const transactions = JSON.parse(localStorage.getItem('pembayaranHutangPiutang') || '[]');
                const dataDiv = document.getElementById('transactionData');
                
                if (transactions.length === 0) {
                    dataDiv.innerHTML = '<div class="alert alert-info">No transaction data found</div>';
                    return;
                }
                
                const tableHTML = `
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Anggota</th>
                                    <th>Jenis</th>
                                    <th>Mode</th>
                                    <th>Jumlah</th>
                                    <th>Tanggal</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${transactions.map(t => `
                                    <tr>
                                        <td>${t.id}</td>
                                        <td>${t.anggotaNama}</td>
                                        <td><span class="badge bg-${t.jenis === 'hutang' ? 'danger' : 'success'}">${t.jenis}</span></td>
                                        <td><span class="badge bg-${t.mode === 'import' ? 'info' : 'secondary'}">${t.mode || 'N/A'}</span></td>
                                        <td>${formatRupiah(t.jumlah)}</td>
                                        <td>${t.tanggal}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                dataDiv.innerHTML = tableHTML;
                
            } catch (error) {
                document.getElementById('transactionData').innerHTML = `
                    <div class="alert alert-danger">Error loading data: ${error.message}</div>
                `;
            }
        }

        function clearData() {
            if (confirm('Are you sure you want to clear all transaction data?')) {
                localStorage.removeItem('pembayaranHutangPiutang');
                localStorage.removeItem('transactionMigration_v1');
                localStorage.removeItem('pembayaranHutangPiutang_backup_pre_migration');
                
                showAlert('All data cleared!', 'info');
                updateMigrationStatus();
                displayTransactionData();
                document.getElementById('testResults').innerHTML = 'No tests run';
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.insertBefore(alertDiv, document.body.firstChild);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }
    </script>
</body>
</html>