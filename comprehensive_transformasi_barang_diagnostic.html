<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic Komprehensif - Transformasi Barang</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .diagnostic-card {
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
        }
        .status-success { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
        .status-info { background-color: #17a2b8; }
        .log-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .fix-button {
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <h1><i class="bi bi-tools me-2"></i>Diagnostic Komprehensif - Sistem Transformasi Barang</h1>
                <p class="text-muted">Tool untuk mendiagnosis dan memperbaiki masalah pada sistem transformasi barang</p>
            </div>
        </div>

        <!-- System Status Overview -->
        <div class="row">
            <div class="col-12">
                <div class="diagnostic-card card">
                    <div class="card-header bg-primary text-white">
                        <h5><i class="bi bi-speedometer2 me-2"></i>Status Sistem</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div id="overall-status" class="status-indicator status-info"></div>
                                    <h6>Status Keseluruhan</h6>
                                    <span id="overall-status-text">Checking...</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div id="scripts-status" class="status-indicator status-info"></div>
                                    <h6>JavaScript Files</h6>
                                    <span id="scripts-status-text">Checking...</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div id="data-status" class="status-indicator status-info"></div>
                                    <h6>Data Status</h6>
                                    <span id="data-status-text">Checking...</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div id="ui-status" class="status-indicator status-info"></div>
                                    <h6>UI Elements</h6>
                                    <span id="ui-status-text">Checking...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Diagnostic Actions -->
        <div class="row">
            <div class="col-md-6">
                <div class="diagnostic-card card">
                    <div class="card-header bg-info text-white">
                        <h5><i class="bi bi-search me-2"></i>Diagnostic Actions</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary fix-button" onclick="runFullDiagnostic()">
                            <i class="bi bi-play-circle me-1"></i>Run Full Diagnostic
                        </button>
                        <button class="btn btn-secondary fix-button" onclick="checkScriptLoading()">
                            <i class="bi bi-file-earmark-code me-1"></i>Check Script Loading
                        </button>
                        <button class="btn btn-warning fix-button" onclick="checkDataIntegrity()">
                            <i class="bi bi-database me-1"></i>Check Data Integrity
                        </button>
                        <button class="btn btn-success fix-button" onclick="testUIComponents()">
                            <i class="bi bi-layout-text-window me-1"></i>Test UI Components
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="diagnostic-card card">
                    <div class="card-header bg-warning text-white">
                        <h5><i class="bi bi-wrench me-2"></i>Fix Actions</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-danger fix-button" onclick="reinitializeSystem()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Reinitialize System
                        </button>
                        <button class="btn btn-info fix-button" onclick="reloadScripts()">
                            <i class="bi bi-download me-1"></i>Reload Scripts
                        </button>
                        <button class="btn btn-success fix-button" onclick="resetData()">
                            <i class="bi bi-database-fill-up me-1"></i>Reset Sample Data
                        </button>
                        <button class="btn btn-secondary fix-button" onclick="clearCache()">
                            <i class="bi bi-trash me-1"></i>Clear Cache
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Diagnostic Results -->
        <div class="row">
            <div class="col-12">
                <div class="diagnostic-card card">
                    <div class="card-header bg-secondary text-white">
                        <h5><i class="bi bi-terminal me-2"></i>Diagnostic Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="diagnostic-output" class="log-output">
                            Klik "Run Full Diagnostic" untuk memulai pemeriksaan sistem...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Test -->
        <div class="row">
            <div class="col-12">
                <div class="diagnostic-card card">
                    <div class="card-header bg-success text-white">
                        <h5><i class="bi bi-check-circle me-2"></i>Quick Test</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="runQuickTest()">
                            <i class="bi bi-lightning me-1"></i>Run Quick Test
                        </button>
                        <button class="btn btn-info ms-2" onclick="openTransformasiBarang()">
                            <i class="bi bi-box-arrow-up-right me-1"></i>Open Transformasi Barang
                        </button>
                        <div id="quick-test-results" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let diagnosticLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            diagnosticLog.push(logEntry);
            
            const output = document.getElementById('diagnostic-output');
            output.textContent = diagnosticLog.join('\n');
            output.scrollTop = output.scrollHeight;
            
            console.log(logEntry);
        }

        function updateStatus(elementId, status, text) {
            const indicator = document.getElementById(elementId);
            const textElement = document.getElementById(elementId + '-text');
            
            indicator.className = `status-indicator status-${status}`;
            textElement.textContent = text;
        }

        async function runFullDiagnostic() {
            log('=== MEMULAI DIAGNOSTIC KOMPREHENSIF ===');
            diagnosticLog = [];
            
            // Check script loading
            await checkScriptLoading();
            
            // Check data integrity
            await checkDataIntegrity();
            
            // Test UI components
            await testUIComponents();
            
            // Check system initialization
            await checkSystemInitialization();
            
            // Update overall status
            updateOverallStatus();
            
            log('=== DIAGNOSTIC SELESAI ===');
        }

        async function checkScriptLoading() {
            log('Memeriksa pemuatan file JavaScript...');
            
            const requiredClasses = [
                'TransformationManager',
                'UIController', 
                'ValidationEngine',
                'StockManager',
                'AuditLogger',
                'ErrorHandler',
                'ConversionCalculator'
            ];
            
            const missingClasses = [];
            const availableClasses = [];
            
            for (const className of requiredClasses) {
                if (typeof window[className] === 'function') {
                    availableClasses.push(className);
                    log(`✓ ${className} tersedia`);
                } else {
                    missingClasses.push(className);
                    log(`✗ ${className} TIDAK tersedia`, 'error');
                }
            }
            
            if (missingClasses.length === 0) {
                updateStatus('scripts-status', 'success', 'All Scripts Loaded');
                log('Semua file JavaScript berhasil dimuat', 'success');
            } else {
                updateStatus('scripts-status', 'error', `${missingClasses.length} Missing`);
                log(`${missingClasses.length} file JavaScript tidak dimuat: ${missingClasses.join(', ')}`, 'error');
            }
            
            return missingClasses.length === 0;
        }

        async function checkDataIntegrity() {
            log('Memeriksa integritas data...');
            
            try {
                // Check localStorage data
                const dataSources = ['masterBarang', 'barang', 'conversionRatios', 'transformationHistory'];
                let dataStatus = 'success';
                let dataCount = 0;
                
                for (const source of dataSources) {
                    const data = localStorage.getItem(source);
                    if (data) {
                        try {
                            const parsedData = JSON.parse(data);
                            if (Array.isArray(parsedData)) {
                                dataCount += parsedData.length;
                                log(`✓ ${source}: ${parsedData.length} items`);
                            } else {
                                log(`✓ ${source}: data object tersedia`);
                            }
                        } catch (e) {
                            log(`✗ ${source}: data corrupt`, 'error');
                            dataStatus = 'error';
                        }
                    } else {
                        log(`⚠ ${source}: tidak ada data`, 'warning');
                        if (dataStatus !== 'error') dataStatus = 'warning';
                    }
                }
                
                updateStatus('data-status', dataStatus, `${dataCount} Items`);
                
                if (dataStatus === 'success') {
                    log('Data integrity check passed', 'success');
                } else if (dataStatus === 'warning') {
                    log('Data integrity check: beberapa data kosong', 'warning');
                } else {
                    log('Data integrity check: ada data yang corrupt', 'error');
                }
                
                return dataStatus === 'success';
                
            } catch (error) {
                log(`Error checking data integrity: ${error.message}`, 'error');
                updateStatus('data-status', 'error', 'Check Failed');
                return false;
            }
        }

        async function testUIComponents() {
            log('Memeriksa komponen UI...');
            
            const requiredElements = [
                'sourceItem',
                'targetItem', 
                'quantity',
                'conversion-info',
                'submit-transformation',
                'reset-form'
            ];
            
            let uiStatus = 'success';
            let foundElements = 0;
            
            for (const elementId of requiredElements) {
                const element = document.getElementById(elementId);
                if (element) {
                    foundElements++;
                    log(`✓ Element ${elementId} ditemukan`);
                } else {
                    log(`✗ Element ${elementId} TIDAK ditemukan`, 'error');
                    uiStatus = 'error';
                }
            }
            
            updateStatus('ui-status', uiStatus, `${foundElements}/${requiredElements.length} Elements`);
            
            if (uiStatus === 'success') {
                log('UI components check passed', 'success');
            } else {
                log('UI components check: beberapa element tidak ditemukan', 'error');
            }
            
            return uiStatus === 'success';
        }

        async function checkSystemInitialization() {
            log('Memeriksa inisialisasi sistem...');
            
            try {
                // Check if initialization function exists
                if (typeof window.initializeTransformasiBarang === 'function') {
                    log('✓ initializeTransformasiBarang function tersedia');
                } else {
                    log('✗ initializeTransformasiBarang function TIDAK tersedia', 'error');
                    return false;
                }
                
                // Check global instances
                const instances = [
                    'transformationManager',
                    'uiController',
                    'validationEngine',
                    'stockManager',
                    'auditLogger',
                    'errorHandler'
                ];
                
                let initializedCount = 0;
                for (const instance of instances) {
                    if (window[instance]) {
                        initializedCount++;
                        log(`✓ ${instance} instance tersedia`);
                    } else {
                        log(`⚠ ${instance} instance belum diinisialisasi`, 'warning');
                    }
                }
                
                if (initializedCount === instances.length) {
                    log('Sistem sudah terinisialisasi dengan baik', 'success');
                    return true;
                } else {
                    log(`Sistem belum terinisialisasi penuh: ${initializedCount}/${instances.length}`, 'warning');
                    return false;
                }
                
            } catch (error) {
                log(`Error checking system initialization: ${error.message}`, 'error');
                return false;
            }
        }

        function updateOverallStatus() {
            const scriptsOk = document.getElementById('scripts-status').classList.contains('status-success');
            const dataOk = !document.getElementById('data-status').classList.contains('status-error');
            const uiOk = document.getElementById('ui-status').classList.contains('status-success');
            
            if (scriptsOk && dataOk && uiOk) {
                updateStatus('overall-status', 'success', 'System OK');
            } else if (scriptsOk && uiOk) {
                updateStatus('overall-status', 'warning', 'Minor Issues');
            } else {
                updateStatus('overall-status', 'error', 'Major Issues');
            }
        }

        async function reinitializeSystem() {
            log('Menginisialisasi ulang sistem...');
            
            try {
                if (typeof window.initializeTransformasiBarang === 'function') {
                    await window.initializeTransformasiBarang();
                    log('Sistem berhasil diinisialisasi ulang', 'success');
                } else {
                    log('Function initializeTransformasiBarang tidak tersedia', 'error');
                }
            } catch (error) {
                log(`Error reinitializing system: ${error.message}`, 'error');
            }
        }

        async function reloadScripts() {
            log('Memuat ulang script files...');
            
            const scripts = [
                'js/transformasi-barang/types.js',
                'js/transformasi-barang/DataModels.js',
                'js/transformasi-barang/ValidationEngine.js',
                'js/transformasi-barang/ConversionCalculator.js',
                'js/transformasi-barang/StockManager.js',
                'js/transformasi-barang/AuditLogger.js',
                'js/transformasi-barang/ErrorHandler.js',
                'js/transformasi-barang/TransformationManager.js',
                'js/transformasi-barang/UIController.js',
                'js/transformasi-barang/ReportManager.js',
                'js/transformasiBarangInit.js'
            ];
            
            for (const scriptPath of scripts) {
                try {
                    // Remove existing script if present
                    const existingScript = document.querySelector(`script[src="${scriptPath}"]`);
                    if (existingScript) {
                        existingScript.remove();
                    }
                    
                    // Add new script
                    const script = document.createElement('script');
                    script.src = scriptPath + '?t=' + Date.now(); // Cache busting
                    script.async = false;
                    
                    await new Promise((resolve, reject) => {
                        script.onload = () => {
                            log(`✓ Loaded ${scriptPath}`);
                            resolve();
                        };
                        script.onerror = () => {
                            log(`✗ Failed to load ${scriptPath}`, 'error');
                            reject(new Error(`Failed to load ${scriptPath}`));
                        };
                        document.head.appendChild(script);
                    });
                    
                } catch (error) {
                    log(`Error loading ${scriptPath}: ${error.message}`, 'error');
                }
            }
            
            log('Script reloading completed');
        }

        async function resetData() {
            log('Mereset data sample...');
            
            try {
                // Clear existing data
                const keys = ['masterBarang', 'barang', 'conversionRatios', 'transformationHistory'];
                keys.forEach(key => localStorage.removeItem(key));
                
                // Create sample data
                const sampleData = [
                    {
                        kode: 'BRG001-KG',
                        nama: 'Beras Premium (Kilogram)',
                        satuan: 'kg',
                        stok: 100,
                        baseProduct: 'BRG001',
                        hargaBeli: 12000,
                        hargaJual: 15000
                    },
                    {
                        kode: 'BRG001-GR',
                        nama: 'Beras Premium (Gram)',
                        satuan: 'gram',
                        stok: 50000,
                        baseProduct: 'BRG001',
                        hargaBeli: 12,
                        hargaJual: 15
                    },
                    {
                        kode: 'BRG002-LT',
                        nama: 'Minyak Goreng (Liter)',
                        satuan: 'liter',
                        stok: 50,
                        baseProduct: 'BRG002',
                        hargaBeli: 18000,
                        hargaJual: 22000
                    },
                    {
                        kode: 'BRG002-ML',
                        nama: 'Minyak Goreng (Mililiter)',
                        satuan: 'ml',
                        stok: 25000,
                        baseProduct: 'BRG002',
                        hargaBeli: 18,
                        hargaJual: 22
                    }
                ];

                const conversionRatios = [
                    {
                        baseProduct: 'BRG001',
                        conversions: [
                            { from: 'kg', to: 'gram', ratio: 1000 },
                            { from: 'gram', to: 'kg', ratio: 0.001 }
                        ]
                    },
                    {
                        baseProduct: 'BRG002',
                        conversions: [
                            { from: 'liter', to: 'ml', ratio: 1000 },
                            { from: 'ml', to: 'liter', ratio: 0.001 }
                        ]
                    }
                ];
                
                localStorage.setItem('masterBarang', JSON.stringify(sampleData));
                localStorage.setItem('barang', JSON.stringify(sampleData));
                localStorage.setItem('conversionRatios', JSON.stringify(conversionRatios));
                localStorage.setItem('transformationHistory', JSON.stringify([]));
                
                log('Data sample berhasil direset', 'success');
                
            } catch (error) {
                log(`Error resetting data: ${error.message}`, 'error');
            }
        }

        async function clearCache() {
            log('Membersihkan cache...');
            
            try {
                // Clear localStorage except essential data
                const essentialKeys = ['masterBarang', 'barang', 'conversionRatios', 'transformationHistory'];
                const allKeys = Object.keys(localStorage);
                
                for (const key of allKeys) {
                    if (!essentialKeys.includes(key)) {
                        localStorage.removeItem(key);
                        log(`Removed cache key: ${key}`);
                    }
                }
                
                log('Cache berhasil dibersihkan', 'success');
                
            } catch (error) {
                log(`Error clearing cache: ${error.message}`, 'error');
            }
        }

        async function runQuickTest() {
            const resultsDiv = document.getElementById('quick-test-results');
            resultsDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Running quick test...';
            
            try {
                let results = [];
                
                // Test 1: Check if classes are available
                const requiredClasses = ['TransformationManager', 'UIController', 'ValidationEngine'];
                const classesAvailable = requiredClasses.every(cls => typeof window[cls] === 'function');
                results.push(`Classes Available: ${classesAvailable ? '✅' : '❌'}`);
                
                // Test 2: Check data
                const hasData = localStorage.getItem('masterBarang') !== null;
                results.push(`Sample Data: ${hasData ? '✅' : '❌'}`);
                
                // Test 3: Check UI elements
                const hasUI = document.getElementById('sourceItem') !== null;
                results.push(`UI Elements: ${hasUI ? '✅' : '❌'}`);
                
                // Test 4: Try initialization
                let initSuccess = false;
                if (typeof window.initializeTransformasiBarang === 'function') {
                    try {
                        await window.initializeTransformasiBarang();
                        initSuccess = true;
                    } catch (e) {
                        console.error('Init failed:', e);
                    }
                }
                results.push(`Initialization: ${initSuccess ? '✅' : '❌'}`);
                
                resultsDiv.innerHTML = `
                    <div class="alert alert-info">
                        <h6>Quick Test Results:</h6>
                        ${results.map(r => `<div>${r}</div>`).join('')}
                    </div>
                `;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="alert alert-danger">Test failed: ${error.message}</div>`;
            }
        }

        function openTransformasiBarang() {
            window.open('transformasi_barang.html', '_blank');
        }

        // Auto-run diagnostic on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(runFullDiagnostic, 1000);
        });
    </script>
</body>
</html>