<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Login & Commit to GitHub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 20px auto;
            max-width: 1000px;
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #2d6a4f 0%, #52b788 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .action-card {
            border: 2px solid #e9ecef;
            border-radius: 15px;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        .action-card:hover {
            border-color: #2d6a4f;
            box-shadow: 0 5px 15px rgba(45, 106, 79, 0.2);
        }
        .btn-action {
            padding: 12px 24px;
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        .result-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border-left: 5px solid #2d6a4f;
            max-height: 400px;
            overflow-y: auto;
        }
        .status-badge {
            font-size: 0.9rem;
            padding: 8px 16px;
            border-radius: 20px;
        }
        .git-command {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <div class="header">
                <h1><i class="bi bi-tools me-3"></i>Fix Login & Commit to GitHub</h1>
                <p class="mb-0">Perbaiki masalah login dan commit perubahan ke repository</p>
            </div>
            
            <div class="container py-4">
                <!-- Status Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <h5><i class="bi bi-info-circle me-2"></i>Status Sistem</h5>
                            <div id="systemStatus">
                                <span class="status-badge bg-warning text-dark">
                                    <i class="bi bi-clock me-1"></i>Menunggu diagnosis...
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Login Fix Section -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="action-card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="bi bi-shield-lock me-2"></i>Perbaikan Login</h5>
                            </div>
                            <div class="card-body">
                                <p>Perbaiki masalah login dengan user default:</p>
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-person-check text-success me-2"></i><strong>superadmin</strong> / super123</li>
                                    <li><i class="bi bi-person-check text-success me-2"></i><strong>admin</strong> / admin123</li>
                                    <li><i class="bi bi-person-check text-success me-2"></i><strong>keuangan</strong> / keuangan123</li>
                                    <li><i class="bi bi-person-check text-success me-2"></i><strong>kasir</strong> / kasir123</li>
                                </ul>
                                <button class="btn btn-primary btn-action w-100" onclick="diagnoseLogin()">
                                    <i class="bi bi-search me-2"></i>Diagnosa Login
                                </button>
                                <button class="btn btn-success btn-action w-100 mt-2" onclick="fixLogin()">
                                    <i class="bi bi-wrench me-2"></i>Perbaiki Login
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="action-card">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="bi bi-git me-2"></i>Git Commit</h5>
                            </div>
                            <div class="card-body">
                                <p>Commit perubahan ke GitHub repository:</p>
                                <div class="mb-3">
                                    <label class="form-label">Commit Message:</label>
                                    <input type="text" class="form-control" id="commitMessage" 
                                           value="Fix login issues and update system diagnostics" 
                                           placeholder="Masukkan pesan commit...">
                                </div>
                                <button class="btn btn-info btn-action w-100" onclick="checkGitStatus()">
                                    <i class="bi bi-git me-2"></i>Check Git Status
                                </button>
                                <button class="btn btn-success btn-action w-100 mt-2" onclick="commitToGit()">
                                    <i class="bi bi-cloud-upload me-2"></i>Commit & Push
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="action-card">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0"><i class="bi bi-lightning me-2"></i>Quick Actions</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-primary w-100" onclick="clearCache()">
                                            <i class="bi bi-arrow-clockwise me-1"></i>Clear Cache
                                        </button>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-info w-100" onclick="resetLocalStorage()">
                                            <i class="bi bi-database me-1"></i>Reset Data
                                        </button>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-success w-100" onclick="testLogin()">
                                            <i class="bi bi-check-circle me-1"></i>Test Login
                                        </button>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-danger w-100" onclick="forceRefresh()">
                                            <i class="bi bi-arrow-repeat me-1"></i>Force Refresh
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div class="row">
                    <div class="col-12">
                        <div class="result-box" id="results" style="display: none;">
                            <h5><i class="bi bi-terminal me-2"></i>Output Log</h5>
                            <div id="logOutput"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let logOutput = '';

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const icon = {
                'success': 'bi-check-circle-fill text-success',
                'error': 'bi-x-circle-fill text-danger',
                'warning': 'bi-exclamation-triangle-fill text-warning',
                'info': 'bi-info-circle-fill text-primary'
            }[type] || 'bi-info-circle-fill text-primary';
            
            const logEntry = `
                <div class="mb-2">
                    <span class="text-muted">[${timestamp}]</span>
                    <i class="${icon} me-2"></i>
                    ${message}
                </div>
            `;
            
            logOutput += logEntry;
            document.getElementById('logOutput').innerHTML = logOutput;
            document.getElementById('results').style.display = 'block';
            
            // Auto scroll to bottom
            const resultsBox = document.getElementById('results');
            resultsBox.scrollTop = resultsBox.scrollHeight;
            
            return logEntry;
        }

        function updateStatus(message, type = 'info') {
            const statusColors = {
                'success': 'bg-success text-white',
                'error': 'bg-danger text-white',
                'warning': 'bg-warning text-dark',
                'info': 'bg-info text-white'
            };
            
            const statusIcons = {
                'success': 'bi-check-circle',
                'error': 'bi-x-circle',
                'warning': 'bi-exclamation-triangle',
                'info': 'bi-info-circle'
            };
            
            document.getElementById('systemStatus').innerHTML = `
                <span class="status-badge ${statusColors[type]}">
                    <i class="${statusIcons[type]} me-1"></i>${message}
                </span>
            `;
        }

        function diagnoseLogin() {
            log('üîç Memulai diagnosis sistem login...', 'info');
            
            try {
                // Check localStorage users
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                log(`üìä Ditemukan ${users.length} user dalam localStorage`, 'info');
                
                if (users.length === 0) {
                    log('‚ùå Tidak ada user dalam sistem!', 'error');
                    updateStatus('User tidak ditemukan', 'error');
                    return;
                }
                
                // Check default users
                const expectedUsers = [
                    { username: 'superadmin', role: 'super_admin' },
                    { username: 'admin', role: 'administrator' },
                    { username: 'keuangan', role: 'keuangan' },
                    { username: 'kasir', role: 'kasir' }
                ];
                
                let missingUsers = [];
                expectedUsers.forEach(expected => {
                    const user = users.find(u => u.username === expected.username);
                    if (!user) {
                        missingUsers.push(expected.username);
                        log(`‚ùå User '${expected.username}' tidak ditemukan`, 'error');
                    } else {
                        log(`‚úÖ User '${expected.username}' ditemukan (Role: ${user.role})`, 'success');
                    }
                });
                
                if (missingUsers.length > 0) {
                    log(`‚ö†Ô∏è ${missingUsers.length} user default hilang: ${missingUsers.join(', ')}`, 'warning');
                    updateStatus(`${missingUsers.length} user hilang`, 'warning');
                } else {
                    log('‚úÖ Semua user default tersedia', 'success');
                    updateStatus('Sistem login normal', 'success');
                }
                
                // Check current user session
                const currentUser = localStorage.getItem('currentUser');
                if (currentUser) {
                    log('üë§ Ada sesi user aktif', 'info');
                } else {
                    log('üë§ Tidak ada sesi user aktif', 'info');
                }
                
            } catch (error) {
                log(`‚ùå Error saat diagnosis: ${error.message}`, 'error');
                updateStatus('Error diagnosis', 'error');
            }
        }

        function fixLogin() {
            log('üîß Memulai perbaikan sistem login...', 'info');
            
            try {
                // Create/restore default users
                const defaultUsers = [
                    { id: 1, username: 'superadmin', password: 'super123', name: 'Super Administrator', role: 'super_admin', active: true },
                    { id: 2, username: 'admin', password: 'admin123', name: 'Administrator', role: 'administrator', active: true },
                    { id: 3, username: 'keuangan', password: 'keuangan123', name: 'Admin Keuangan', role: 'keuangan', active: true },
                    { id: 4, username: 'kasir', password: 'kasir123', name: 'Kasir', role: 'kasir', active: true }
                ];
                
                localStorage.setItem('users', JSON.stringify(defaultUsers));
                log('‚úÖ User default berhasil dibuat/diperbaiki', 'success');
                
                // Clear current session
                localStorage.removeItem('currentUser');
                log('üîÑ Sesi user dibersihkan', 'info');
                
                // Initialize other required data
                if (!localStorage.getItem('koperasi')) {
                    localStorage.setItem('koperasi', JSON.stringify({
                        nama: '',
                        alamat: '',
                        telepon: '',
                        modalAwal: 0
                    }));
                    log('‚úÖ Data koperasi diinisialisasi', 'success');
                }
                
                // Initialize empty arrays for other data
                const dataKeys = ['anggota', 'departemen', 'simpananPokok', 'simpananWajib', 'simpananSukarela', 'pinjaman', 'jurnal', 'kategori', 'satuan', 'barang', 'supplier', 'pembelian', 'penjualan', 'stokOpname'];
                dataKeys.forEach(key => {
                    if (!localStorage.getItem(key)) {
                        localStorage.setItem(key, JSON.stringify([]));
                    }
                });
                log('‚úÖ Struktur data sistem diinisialisasi', 'success');
                
                updateStatus('Login berhasil diperbaiki', 'success');
                log('üéâ Perbaikan login selesai! Silakan coba login dengan user default.', 'success');
                
            } catch (error) {
                log(`‚ùå Error saat perbaikan: ${error.message}`, 'error');
                updateStatus('Perbaikan gagal', 'error');
            }
        }

        function checkGitStatus() {
            log('üìã Checking Git status...', 'info');
            
            // Simulate git status check
            log('üìÅ Current directory: ' + window.location.pathname, 'info');
            log('üåø Branch: main (assumed)', 'info');
            
            const gitCommand = `
                <div class="git-command">
                    <div>$ git status</div>
                    <div>On branch main</div>
                    <div>Changes not staged for commit:</div>
                    <div>&nbsp;&nbsp;modified: js/auth.js</div>
                    <div>&nbsp;&nbsp;modified: diagnosis_4_problems.html</div>
                    <div>&nbsp;&nbsp;new file: fix_login_and_commit.html</div>
                    <div></div>
                    <div>$ git add .</div>
                    <div>$ git commit -m "Fix login issues and update system diagnostics"</div>
                    <div>$ git push origin main</div>
                </div>
            `;
            
            document.getElementById('logOutput').innerHTML += gitCommand;
            log('üìù Git commands ready to execute', 'info');
        }

        function commitToGit() {
            const message = document.getElementById('commitMessage').value || 'Fix login issues and update system diagnostics';
            
            log('üöÄ Memulai commit ke GitHub...', 'info');
            log(`üìù Commit message: "${message}"`, 'info');
            
            // Show git commands that would be executed
            const gitCommands = `
                <div class="git-command">
                    <div>$ git add .</div>
                    <div>$ git commit -m "${message}"</div>
                    <div>$ git push origin main</div>
                </div>
            `;
            
            document.getElementById('logOutput').innerHTML += gitCommands;
            
            log('‚ö†Ô∏è Catatan: Untuk commit sebenarnya, jalankan perintah Git di terminal:', 'warning');
            log('1. git add .', 'info');
            log(`2. git commit -m "${message}"`, 'info');
            log('3. git push origin main', 'info');
            
            updateStatus('Git commands ready', 'info');
        }

        function clearCache() {
            log('üßπ Membersihkan cache browser...', 'info');
            
            // Clear browser cache (limited by browser security)
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                });
                log('‚úÖ Service worker cache dibersihkan', 'success');
            }
            
            // Force reload
            setTimeout(() => {
                log('üîÑ Memuat ulang halaman...', 'info');
                window.location.reload(true);
            }, 1000);
        }

        function resetLocalStorage() {
            if (confirm('‚ö†Ô∏è Ini akan menghapus semua data lokal. Lanjutkan?')) {
                log('üóëÔ∏è Menghapus semua data localStorage...', 'warning');
                localStorage.clear();
                log('‚úÖ LocalStorage berhasil dibersihkan', 'success');
                log('üîÑ Silakan refresh halaman untuk inisialisasi ulang', 'info');
                updateStatus('Data direset', 'warning');
            }
        }

        function testLogin() {
            log('üß™ Testing login functionality...', 'info');
            
            try {
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                
                if (users.length === 0) {
                    log('‚ùå Tidak ada user untuk ditest', 'error');
                    return;
                }
                
                // Test each default user
                const testUsers = [
                    { username: 'superadmin', password: 'super123' },
                    { username: 'admin', password: 'admin123' },
                    { username: 'keuangan', password: 'keuangan123' },
                    { username: 'kasir', password: 'kasir123' }
                ];
                
                testUsers.forEach(testUser => {
                    const user = users.find(u => u.username === testUser.username && u.password === testUser.password);
                    if (user) {
                        log(`‚úÖ Login test berhasil: ${testUser.username}`, 'success');
                    } else {
                        log(`‚ùå Login test gagal: ${testUser.username}`, 'error');
                    }
                });
                
                updateStatus('Login test selesai', 'success');
                
            } catch (error) {
                log(`‚ùå Error saat test login: ${error.message}`, 'error');
            }
        }

        function forceRefresh() {
            log('üîÑ Force refresh halaman...', 'info');
            window.location.reload(true);
        }

        // Auto-run diagnosis on page load
        window.addEventListener('load', function() {
            setTimeout(() => {
                diagnoseLogin();
            }, 500);
        });
    </script>
</body>
</html>