<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Task 7: Sorting Functionality - Laporan Transaksi Simpanan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
        }
        .test-pass {
            background-color: #d1e7dd;
            color: #0f5132;
        }
        .test-fail {
            background-color: #f8d7da;
            color: #842029;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Test Task 7: Sorting Functionality</h1>
        
        <!-- Test Setup -->
        <div class="test-section">
            <h3>Test Setup</h3>
            <button class="btn btn-primary" onclick="setupTestData()">Setup Test Data</button>
            <button class="btn btn-danger" onclick="clearTestData()">Clear Test Data</button>
            <div id="setupResult" class="test-result" style="display: none;"></div>
        </div>
        
        <!-- Test 1: Sorting Functions Exist -->
        <div class="test-section">
            <h3>Test 1: Sorting Functions Exist</h3>
            <button class="btn btn-success" onclick="testFunctionsExist()">Run Test</button>
            <div id="test1Result" class="test-result" style="display: none;"></div>
        </div>
        
        <!-- Test 2: Alphabetic Sorting (Ascending) -->
        <div class="test-section">
            <h3>Test 2: Alphabetic Sorting (Ascending)</h3>
            <p>Test sorting by nama (ascending)</p>
            <button class="btn btn-success" onclick="testAlphabeticAscending()">Run Test</button>
            <div id="test2Result" class="test-result" style="display: none;"></div>
        </div>
        
        <!-- Test 3: Alphabetic Sorting (Descending) -->
        <div class="test-section">
            <h3>Test 3: Alphabetic Sorting (Descending)</h3>
            <p>Test sorting by nama (descending)</p>
            <button class="btn btn-success" onclick="testAlphabeticDescending()">Run Test</button>
            <div id="test3Result" class="test-result" style="display: none;"></div>
        </div>
        
        <!-- Test 4: Numeric Sorting (Ascending) -->
        <div class="test-section">
            <h3>Test 4: Numeric Sorting (Ascending)</h3>
            <p>Test sorting by total simpanan (ascending)</p>
            <button class="btn btn-success" onclick="testNumericAscending()">Run Test</button>
            <div id="test4Result" class="test-result" style="display: none;"></div>
        </div>
        
        <!-- Test 5: Numeric Sorting (Descending) -->
        <div class="test-section">
            <h3>Test 5: Numeric Sorting (Descending)</h3>
            <p>Test sorting by total simpanan (descending)</p>
            <button class="btn btn-success" onclick="testNumericDescending()">Run Test</button>
            <div id="test5Result" class="test-result" style="display: none;"></div>
        </div>
        
        <!-- Test 6: Sort Toggle -->
        <div class="test-section">
            <h3>Test 6: Sort Toggle Behavior</h3>
            <p>Test that clicking same column toggles direction</p>
            <button class="btn btn-success" onclick="testSortToggle()">Run Test</button>
            <div id="test6Result" class="test-result" style="display: none;"></div>
        </div>
        
        <!-- Test 7: Sort Indicators -->
        <div class="test-section">
            <h3>Test 7: Sort Indicators Display</h3>
            <p>Test that sort indicators show correctly</p>
            <button class="btn btn-success" onclick="testSortIndicators()">Run Test</button>
            <div id="test7Result" class="test-result" style="display: none;"></div>
        </div>
        
        <!-- Test 8: Interactive Test -->
        <div class="test-section">
            <h3>Test 8: Interactive Sorting Test</h3>
            <p>Render the full report and test sorting manually</p>
            <button class="btn btn-primary" onclick="renderFullReport()">Render Report</button>
            <div id="test8Result" class="test-result" style="display: none;"></div>
            <div id="mainContent" class="mt-3"></div>
        </div>
    </div>

    <!-- Load Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Load App Scripts -->
    <script>
        // Mock functions
        function showAlert(message, type) {
            console.log(`[${type}] ${message}`);
        }
        
        function formatRupiah(amount) {
            if (!amount) return 'Rp 0';
            return 'Rp ' + amount.toLocaleString('id-ID');
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID');
        }
        
        function filterActiveAnggota(anggotaList) {
            return anggotaList.filter(a => a.statusKeanggotaan !== 'Keluar');
        }
    </script>
    
    <script src="js/laporanTransaksiSimpananAnggota.js"></script>
    
    <!-- Test Scripts -->
    <script>
        function setupTestData() {
            localStorage.clear();
            
            const anggota = [
                {
                    id: 'A001',
                    nik: '3333',
                    nama: 'Charlie',
                    noKartu: 'K001',
                    departemen: 'IT',
                    tipeAnggota: 'Anggota',
                    statusKeanggotaan: 'Aktif'
                },
                {
                    id: 'A002',
                    nik: '1111',
                    nama: 'Alice',
                    noKartu: 'K002',
                    departemen: 'Finance',
                    tipeAnggota: 'Anggota',
                    statusKeanggotaan: 'Aktif'
                },
                {
                    id: 'A003',
                    nik: '2222',
                    nama: 'Bob',
                    noKartu: 'K003',
                    departemen: 'HR',
                    tipeAnggota: 'Non-Anggota',
                    statusKeanggotaan: 'Aktif'
                },
                {
                    id: 'A004',
                    nik: '4444',
                    nama: 'Diana',
                    noKartu: 'K004',
                    departemen: 'IT',
                    tipeAnggota: 'Anggota',
                    statusKeanggotaan: 'Aktif'
                }
            ];
            
            const penjualan = [];
            
            const simpananPokok = [
                { id: 'SP001', anggotaId: 'A001', jumlah: 300000 },
                { id: 'SP002', anggotaId: 'A002', jumlah: 100000 },
                { id: 'SP003', anggotaId: 'A003', jumlah: 200000 },
                { id: 'SP004', anggotaId: 'A004', jumlah: 400000 }
            ];
            
            const simpananWajib = [];
            const simpananSukarela = [];
            
            localStorage.setItem('anggota', JSON.stringify(anggota));
            localStorage.setItem('penjualan', JSON.stringify(penjualan));
            localStorage.setItem('simpananPokok', JSON.stringify(simpananPokok));
            localStorage.setItem('simpananWajib', JSON.stringify(simpananWajib));
            localStorage.setItem('simpananSukarela', JSON.stringify(simpananSukarela));
            
            const result = document.getElementById('setupResult');
            result.style.display = 'block';
            result.className = 'test-result test-pass';
            result.innerHTML = `
                <strong>✓ Test data created!</strong><br>
                - 4 anggota with different names and simpanan amounts<br>
                - Charlie (300k), Alice (100k), Bob (200k), Diana (400k)
            `;
        }
        
        function clearTestData() {
            localStorage.clear();
            const result = document.getElementById('setupResult');
            result.style.display = 'block';
            result.className = 'test-result test-pass';
            result.innerHTML = '<strong>✓ Test data cleared!</strong>';
        }
        
        function testFunctionsExist() {
            const result = document.getElementById('test1Result');
            result.style.display = 'block';
            
            try {
                if (typeof sortLaporanBy !== 'function') {
                    throw new Error('sortLaporanBy function not found');
                }
                if (typeof sortData !== 'function') {
                    throw new Error('sortData function not found');
                }
                if (typeof compareNumeric !== 'function') {
                    throw new Error('compareNumeric function not found');
                }
                if (typeof compareAlphabetic !== 'function') {
                    throw new Error('compareAlphabetic function not found');
                }
                if (typeof updateSortIndicators !== 'function') {
                    throw new Error('updateSortIndicators function not found');
                }
                
                result.className = 'test-result test-pass';
                result.innerHTML = '<strong>✓ PASS:</strong> All sorting functions exist';
            } catch (error) {
                result.className = 'test-result test-fail';
                result.innerHTML = `<strong>✗ FAIL:</strong> ${error.message}`;
            }
        }
        
        function testAlphabeticAscending() {
            const result = document.getElementById('test2Result');
            result.style.display = 'block';
            
            try {
                const data = getAnggotaReportData();
                const sorted = sortData(data, 'nama', 'asc');
                
                // Should be: Alice, Bob, Charlie, Diana
                if (sorted[0].nama !== 'Alice') throw new Error('First should be Alice');
                if (sorted[1].nama !== 'Bob') throw new Error('Second should be Bob');
                if (sorted[2].nama !== 'Charlie') throw new Error('Third should be Charlie');
                if (sorted[3].nama !== 'Diana') throw new Error('Fourth should be Diana');
                
                result.className = 'test-result test-pass';
                result.innerHTML = '<strong>✓ PASS:</strong> Alphabetic ascending sort works correctly';
            } catch (error) {
                result.className = 'test-result test-fail';
                result.innerHTML = `<strong>✗ FAIL:</strong> ${error.message}`;
            }
        }
        
        function testAlphabeticDescending() {
            const result = document.getElementById('test3Result');
            result.style.display = 'block';
            
            try {
                const data = getAnggotaReportData();
                const sorted = sortData(data, 'nama', 'desc');
                
                // Should be: Diana, Charlie, Bob, Alice
                if (sorted[0].nama !== 'Diana') throw new Error('First should be Diana');
                if (sorted[1].nama !== 'Charlie') throw new Error('Second should be Charlie');
                if (sorted[2].nama !== 'Bob') throw new Error('Third should be Bob');
                if (sorted[3].nama !== 'Alice') throw new Error('Fourth should be Alice');
                
                result.className = 'test-result test-pass';
                result.innerHTML = '<strong>✓ PASS:</strong> Alphabetic descending sort works correctly';
            } catch (error) {
                result.className = 'test-result test-fail';
                result.innerHTML = `<strong>✗ FAIL:</strong> ${error.message}`;
            }
        }
        
        function testNumericAscending() {
            const result = document.getElementById('test4Result');
            result.style.display = 'block';
            
            try {
                const data = getAnggotaReportData();
                const sorted = sortData(data, 'totalSimpanan', 'asc');
                
                // Should be: Alice (100k), Bob (200k), Charlie (300k), Diana (400k)
                if (sorted[0].simpanan.total !== 100000) throw new Error('First should be 100k');
                if (sorted[1].simpanan.total !== 200000) throw new Error('Second should be 200k');
                if (sorted[2].simpanan.total !== 300000) throw new Error('Third should be 300k');
                if (sorted[3].simpanan.total !== 400000) throw new Error('Fourth should be 400k');
                
                result.className = 'test-result test-pass';
                result.innerHTML = '<strong>✓ PASS:</strong> Numeric ascending sort works correctly';
            } catch (error) {
                result.className = 'test-result test-fail';
                result.innerHTML = `<strong>✗ FAIL:</strong> ${error.message}`;
            }
        }
        
        function testNumericDescending() {
            const result = document.getElementById('test5Result');
            result.style.display = 'block';
            
            try {
                const data = getAnggotaReportData();
                const sorted = sortData(data, 'totalSimpanan', 'desc');
                
                // Should be: Diana (400k), Charlie (300k), Bob (200k), Alice (100k)
                if (sorted[0].simpanan.total !== 400000) throw new Error('First should be 400k');
                if (sorted[1].simpanan.total !== 300000) throw new Error('Second should be 300k');
                if (sorted[2].simpanan.total !== 200000) throw new Error('Third should be 200k');
                if (sorted[3].simpanan.total !== 100000) throw new Error('Fourth should be 100k');
                
                result.className = 'test-result test-pass';
                result.innerHTML = '<strong>✓ PASS:</strong> Numeric descending sort works correctly';
            } catch (error) {
                result.className = 'test-result test-fail';
                result.innerHTML = `<strong>✗ FAIL:</strong> ${error.message}`;
            }
        }
        
        function testSortToggle() {
            const result = document.getElementById('test6Result');
            result.style.display = 'block';
            
            try {
                // Reset sort state
                currentSortColumn = null;
                currentSortDirection = 'asc';
                
                // First click - should be ascending
                sortLaporanBy('nama');
                if (currentSortColumn !== 'nama') throw new Error('Column not set');
                if (currentSortDirection !== 'asc') throw new Error('First click should be asc');
                
                // Second click - should toggle to descending
                sortLaporanBy('nama');
                if (currentSortDirection !== 'desc') throw new Error('Second click should be desc');
                
                // Third click - should toggle back to ascending
                sortLaporanBy('nama');
                if (currentSortDirection !== 'asc') throw new Error('Third click should be asc');
                
                // Click different column - should reset to ascending
                sortLaporanBy('nik');
                if (currentSortColumn !== 'nik') throw new Error('Column not changed');
                if (currentSortDirection !== 'asc') throw new Error('New column should start with asc');
                
                result.className = 'test-result test-pass';
                result.innerHTML = '<strong>✓ PASS:</strong> Sort toggle behavior works correctly';
            } catch (error) {
                result.className = 'test-result test-fail';
                result.innerHTML = `<strong>✗ FAIL:</strong> ${error.message}`;
            }
        }
        
        function testSortIndicators() {
            const result = document.getElementById('test7Result');
            result.style.display = 'block';
            
            try {
                // Render report first
                renderFullReport();
                
                setTimeout(() => {
                    // Click to sort
                    sortLaporanBy('nama');
                    
                    // Check indicator exists
                    const indicator = document.getElementById('sortIndicator-nama');
                    if (!indicator) throw new Error('Sort indicator not found');
                    
                    // Check for arrow icon
                    if (!indicator.innerHTML.includes('bi-arrow')) {
                        throw new Error('Arrow icon not displayed');
                    }
                    
                    result.className = 'test-result test-pass';
                    result.innerHTML = '<strong>✓ PASS:</strong> Sort indicators display correctly';
                }, 500);
                
            } catch (error) {
                result.className = 'test-result test-fail';
                result.innerHTML = `<strong>✗ FAIL:</strong> ${error.message}`;
            }
        }
        
        function renderFullReport() {
            renderLaporanTransaksiSimpananAnggota();
            const result = document.getElementById('test8Result');
            result.style.display = 'block';
            result.className = 'test-result test-pass';
            result.innerHTML = '<strong>✓ Report rendered!</strong> Click column headers to test sorting.';
        }
    </script>
</body>
</html>
