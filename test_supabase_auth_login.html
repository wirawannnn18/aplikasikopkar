<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Supabase Auth Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4><i class="bi bi-shield-check me-2"></i>Test Supabase Auth Login</h4>
                    </div>
                    <div class="card-body">
                        <!-- Status Display -->
                        <div id="statusDisplay" class="mb-4">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Siap untuk menguji login dengan akun yang ada di database
                            </div>
                        </div>

                        <!-- Login Form -->
                        <div class="row">
                            <div class="col-md-6">
                                <h5>Manual Login Test</h5>
                                <form id="loginForm">
                                    <div class="mb-3">
                                        <label for="email" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="email" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="password" class="form-label">Password</label>
                                        <input type="password" class="form-control" id="password" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-box-arrow-in-right me-1"></i>Login
                                    </button>
                                </form>
                            </div>
                            
                            <div class="col-md-6">
                                <h5>Quick Test Accounts</h5>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-danger" onclick="testLogin('superadmin@koperasi.local', 'TempPass123!')">
                                        <i class="bi bi-person-gear me-1"></i>Test Super Admin
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="testLogin('admin@koperasi.local', 'TempPass123!')">
                                        <i class="bi bi-person-badge me-1"></i>Test Admin
                                    </button>
                                    <button class="btn btn-outline-info" onclick="testLogin('keuangan@koperasi.local', 'TempPass123!')">
                                        <i class="bi bi-calculator me-1"></i>Test Keuangan
                                    </button>
                                    <button class="btn btn-outline-success" onclick="testLogin('kasir@koperasi.local', 'TempPass123!')">
                                        <i class="bi bi-cash-register me-1"></i>Test Kasir
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Database Info -->
                        <div class="mt-4">
                            <h5>Database Status</h5>
                            <button class="btn btn-secondary" onclick="checkDatabaseStatus()">
                                <i class="bi bi-database me-1"></i>Check Database
                            </button>
                            <div id="databaseInfo" class="mt-3"></div>
                        </div>

                        <!-- Results -->
                        <div id="results" class="mt-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://etjdnbumjdsueqdffsks.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV0amRuYnVtamRzdWVxZGZmc2tzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1Njg3NTYsImV4cCI6MjA4MTE0NDc1Nn0.ETy2kWOr6XPJ26XvAfeRH8NGh3s5BzI3NGarp4pJhtc';

        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Show status
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusDisplay');
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'error' ? 'alert-danger' : 
                              type === 'warning' ? 'alert-warning' : 'alert-info';
            
            const icon = type === 'success' ? 'check-circle' : 
                        type === 'error' ? 'exclamation-triangle' : 
                        type === 'warning' ? 'exclamation-triangle' : 'info-circle';
            
            statusDiv.innerHTML = `
                <div class="alert ${alertClass}">
                    <i class="bi bi-${icon} me-2"></i>${message}
                </div>
            `;
        }

        // Show results
        function showResults(title, content, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'error' ? 'alert-danger' : 'alert-info';
            
            resultsDiv.innerHTML = `
                <div class="alert ${alertClass}">
                    <h6><strong>${title}</strong></h6>
                    <pre style="white-space: pre-wrap; margin-bottom: 0;">${content}</pre>
                </div>
            `;
        }

        // Test login function
        async function testLogin(email, password) {
            showStatus(`Mencoba login dengan ${email}...`, 'info');
            
            try {
                console.log('Attempting login with:', email);
                
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) {
                    console.error('Login error:', error);
                    showStatus(`Login gagal: ${error.message}`, 'error');
                    showResults('Login Error', JSON.stringify(error, null, 2), 'error');
                    return;
                }

                console.log('Login successful:', data);
                showStatus(`Login berhasil untuk ${email}!`, 'success');
                
                // Get user profile
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', data.user.id)
                    .single();

                if (profileError) {
                    console.error('Profile error:', profileError);
                    showResults('Login Success (No Profile)', JSON.stringify(data, null, 2), 'warning');
                } else {
                    console.log('Profile loaded:', profile);
                    showResults('Login Success with Profile', 
                        `User: ${data.user.email}\nProfile: ${JSON.stringify(profile, null, 2)}`, 
                        'success');
                }

                // Sign out after test
                setTimeout(async () => {
                    await supabase.auth.signOut();
                    console.log('Signed out');
                }, 2000);

            } catch (err) {
                console.error('Unexpected error:', err);
                showStatus(`Error tidak terduga: ${err.message}`, 'error');
                showResults('Unexpected Error', err.toString(), 'error');
            }
        }

        // Check database status
        async function checkDatabaseStatus() {
            try {
                showStatus('Memeriksa status database...', 'info');
                
                // Check auth.users
                const { data: authUsers, error: authError } = await supabase.auth.admin.listUsers();
                
                // Check profiles (using regular query since we can't use admin API)
                const { data: profiles, error: profileError } = await supabase
                    .from('profiles')
                    .select('id, username, role, active');

                let info = '';
                
                if (authError) {
                    info += `Auth Users Error: ${authError.message}\n`;
                } else {
                    info += `Auth Users: ${authUsers?.users?.length || 0} found\n`;
                }

                if (profileError) {
                    info += `Profiles Error: ${profileError.message}\n`;
                } else {
                    info += `Profiles: ${profiles?.length || 0} found\n`;
                    if (profiles && profiles.length > 0) {
                        info += '\nProfiles:\n';
                        profiles.forEach(p => {
                            info += `- ${p.username} (${p.role}) - ${p.active ? 'Active' : 'Inactive'}\n`;
                        });
                    }
                }

                document.getElementById('databaseInfo').innerHTML = `<pre>${info}</pre>`;
                showStatus('Status database berhasil diperiksa', 'success');

            } catch (err) {
                console.error('Database check error:', err);
                showStatus(`Error memeriksa database: ${err.message}`, 'error');
                document.getElementById('databaseInfo').innerHTML = `<div class="text-danger">Error: ${err.message}</div>`;
            }
        }

        // Handle manual login form
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            await testLogin(email, password);
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            showStatus('Supabase client initialized. Ready to test login.', 'success');
            checkDatabaseStatus();
        });
    </script>
</body>
</html>