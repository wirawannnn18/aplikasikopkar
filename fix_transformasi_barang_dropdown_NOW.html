<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Dropdown Transformasi Barang - SEKARANG</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .fix-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
        }
        .status-card {
            border-radius: 15px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        .status-card.success {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }
        .status-card.error {
            border-color: #dc3545;
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        }
        .fix-step {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #007bff;
        }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="fix-container">
            <div class="text-center mb-4">
                <h1><i class="bi bi-tools me-2"></i>Fix Dropdown Transformasi Barang</h1>
                <p class="text-muted">Perbaikan langsung untuk masalah "undefined (undefined) - Stok: undefined"</p>
            </div>

            <!-- Status Card -->
            <div id="status-card" class="status-card card mb-4">
                <div class="card-body text-center">
                    <div id="status-icon" class="display-4 mb-3">
                        <i class="bi bi-hourglass-split text-primary"></i>
                    </div>
                    <h4 id="status-title">Memulai Perbaikan...</h4>
                    <p id="status-message" class="mb-0">Menganalisis masalah dropdown transformasi barang</p>
                </div>
            </div>

            <!-- Progress Steps -->
            <div id="progress-steps">
                <div class="fix-step" id="step-1">
                    <h5><i class="bi bi-1-circle me-2"></i>Analisis Masalah</h5>
                    <p class="mb-0">Mengidentifikasi penyebab dropdown menampilkan "undefined"...</p>
                    <div id="step-1-result" class="mt-2"></div>
                </div>

                <div class="fix-step" id="step-2">
                    <h5><i class="bi bi-2-circle me-2"></i>Pembersihan Data</h5>
                    <p class="mb-0">Membersihkan data yang rusak dari localStorage...</p>
                    <div id="step-2-result" class="mt-2"></div>
                </div>

                <div class="fix-step" id="step-3">
                    <h5><i class="bi bi-3-circle me-2"></i>Inisialisasi Data Bersih</h5>
                    <p class="mb-0">Membuat data sample yang bersih dan valid...</p>
                    <div id="step-3-result" class="mt-2"></div>
                </div>

                <div class="fix-step" id="step-4">
                    <h5><i class="bi bi-4-circle me-2"></i>Perbaikan Dropdown</h5>
                    <p class="mb-0">Mengganti fungsi dropdown dengan versi yang diperbaiki...</p>
                    <div id="step-4-result" class="mt-2"></div>
                </div>

                <div class="fix-step" id="step-5">
                    <h5><i class="bi bi-5-circle me-2"></i>Verifikasi</h5>
                    <p class="mb-0">Memverifikasi bahwa dropdown berfungsi dengan benar...</p>
                    <div id="step-5-result" class="mt-2"></div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="text-center mt-4">
                <button id="start-fix" class="btn btn-primary btn-lg me-3">
                    <i class="bi bi-play-fill me-2"></i>Mulai Perbaikan
                </button>
                <button id="test-dropdown" class="btn btn-outline-success btn-lg me-3" disabled>
                    <i class="bi bi-check-circle me-2"></i>Test Dropdown
                </button>
                <button id="open-transformasi" class="btn btn-outline-primary btn-lg" disabled>
                    <i class="bi bi-box-arrow-up-right me-2"></i>Buka Transformasi Barang
                </button>
            </div>

            <!-- Fix Code Display -->
            <div id="fix-code" class="mt-4" style="display: none;">
                <h5><i class="bi bi-code-slash me-2"></i>Kode Perbaikan yang Diterapkan</h5>
                <div class="code-block" id="applied-code"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class DropdownFixNow {
            constructor() {
                this.fixApplied = false;
                this.testPassed = false;
            }

            async startFix() {
                try {
                    this.updateStatus('Memulai perbaikan...', 'info');
                    
                    // Step 1: Analyze problem
                    await this.analyzeProblems();
                    
                    // Step 2: Clean corrupted data
                    await this.cleanCorruptedData();
                    
                    // Step 3: Initialize clean data
                    await this.initializeCleanData();
                    
                    // Step 4: Apply dropdown fix
                    await this.applyDropdownFix();
                    
                    // Step 5: Verify fix
                    await this.verifyFix();
                    
                    this.updateStatus('Perbaikan berhasil diterapkan!', 'success');
                    this.fixApplied = true;
                    
                    // Enable test button
                    document.getElementById('test-dropdown').disabled = false;
                    document.getElementById('open-transformasi').disabled = false;
                    
                } catch (error) {
                    console.error('Fix failed:', error);
                    this.updateStatus(`Perbaikan gagal: ${error.message}`, 'error');
                }
            }

            async analyzeProblems() {
                this.updateStep(1, 'Menganalisis masalah...', 'info');
                
                const problems = [];
                
                // Check localStorage data
                const dataSources = ['masterBarang', 'barang', 'stokBarang', 'produk'];
                let hasValidData = false;
                
                for (const source of dataSources) {
                    try {
                        const data = localStorage.getItem(source);
                        if (data) {
                            const parsed = JSON.parse(data);
                            if (Array.isArray(parsed) && parsed.length > 0) {
                                // Check for undefined values
                                const hasUndefined = parsed.some(item => 
                                    !item || 
                                    item.nama === undefined || 
                                    item.satuan === undefined || 
                                    item.stok === undefined ||
                                    item.nama === 'undefined' ||
                                    item.satuan === 'undefined'
                                );
                                
                                if (hasUndefined) {
                                    problems.push(`Data rusak ditemukan di ${source}`);
                                } else {
                                    hasValidData = true;
                                }
                            }
                        }
                    } catch (e) {
                        problems.push(`Data tidak valid di ${source}`);
                    }
                }
                
                if (!hasValidData) {
                    problems.push('Tidak ada data barang yang valid');
                }
                
                // Check if dropdown elements exist
                if (!document.getElementById('sourceItem')) {
                    problems.push('Element dropdown sourceItem tidak ditemukan');
                }
                if (!document.getElementById('targetItem')) {
                    problems.push('Element dropdown targetItem tidak ditemukan');
                }
                
                const resultHtml = problems.length > 0 
                    ? `<div class="alert alert-warning"><strong>Masalah ditemukan:</strong><ul class="mb-0">${problems.map(p => `<li>${p}</li>`).join('')}</ul></div>`
                    : `<div class="alert alert-success">Tidak ada masalah struktural ditemukan</div>`;
                
                this.updateStep(1, 'Analisis selesai', 'success', resultHtml);
                
                await this.delay(1000);
            }

            async cleanCorruptedData() {
                this.updateStep(2, 'Membersihkan data yang rusak...', 'info');
                
                const keysToCheck = ['masterBarang', 'barang', 'stokBarang', 'produk', 'conversionRatios'];
                let clearedCount = 0;
                
                keysToCheck.forEach(key => {
                    try {
                        const data = localStorage.getItem(key);
                        if (data) {
                            const parsed = JSON.parse(data);
                            if (Array.isArray(parsed)) {
                                // Check for corruption
                                const hasCorruption = parsed.some(item => 
                                    !item || 
                                    item.nama === undefined || 
                                    item.satuan === undefined || 
                                    item.stok === undefined ||
                                    item.nama === 'undefined' ||
                                    item.satuan === 'undefined' ||
                                    typeof item.nama !== 'string' ||
                                    typeof item.satuan !== 'string' ||
                                    typeof item.stok !== 'number'
                                );
                                
                                if (hasCorruption) {
                                    localStorage.removeItem(key);
                                    clearedCount++;
                                }
                            }
                        }
                    } catch (e) {
                        localStorage.removeItem(key);
                        clearedCount++;
                    }
                });
                
                const resultHtml = `<div class="alert alert-info">Dibersihkan ${clearedCount} data yang rusak</div>`;
                this.updateStep(2, 'Pembersihan selesai', 'success', resultHtml);
                
                await this.delay(1000);
            }

            async initializeCleanData() {
                this.updateStep(3, 'Menginisialisasi data bersih...', 'info');
                
                // Clean, guaranteed data structure - NO undefined values
                const masterBarang = [
                    {
                        kode: 'BRG001',
                        nama: 'Beras Premium',
                        satuan: 'kg',
                        stok: 100,
                        baseProduct: 'BRG001',
                        hargaBeli: 12000,
                        hargaJual: 15000
                    },
                    {
                        kode: 'BRG002',
                        nama: 'Beras Premium',
                        satuan: 'gram',
                        stok: 50000,
                        baseProduct: 'BRG001',
                        hargaBeli: 12,
                        hargaJual: 15
                    },
                    {
                        kode: 'BRG003',
                        nama: 'Minyak Goreng',
                        satuan: 'liter',
                        stok: 50,
                        baseProduct: 'BRG002',
                        hargaBeli: 18000,
                        hargaJual: 22000
                    },
                    {
                        kode: 'BRG004',
                        nama: 'Minyak Goreng',
                        satuan: 'ml',
                        stok: 25000,
                        baseProduct: 'BRG002',
                        hargaBeli: 18,
                        hargaJual: 22
                    },
                    {
                        kode: 'BRG005',
                        nama: 'Air Mineral',
                        satuan: 'dus',
                        stok: 20,
                        baseProduct: 'BRG003',
                        hargaBeli: 48000,
                        hargaJual: 60000
                    },
                    {
                        kode: 'BRG006',
                        nama: 'Air Mineral',
                        satuan: 'botol',
                        stok: 480,
                        baseProduct: 'BRG003',
                        hargaBeli: 2000,
                        hargaJual: 2500
                    }
                ];

                const conversionRatios = [
                    {
                        baseProduct: 'BRG001',
                        conversions: [
                            { from: 'kg', to: 'gram', ratio: 1000 },
                            { from: 'gram', to: 'kg', ratio: 0.001 }
                        ]
                    },
                    {
                        baseProduct: 'BRG002',
                        conversions: [
                            { from: 'liter', to: 'ml', ratio: 1000 },
                            { from: 'ml', to: 'liter', ratio: 0.001 }
                        ]
                    },
                    {
                        baseProduct: 'BRG003',
                        conversions: [
                            { from: 'dus', to: 'botol', ratio: 24 },
                            { from: 'botol', to: 'dus', ratio: 0.041667 }
                        ]
                    }
                ];

                // Save clean data to localStorage
                localStorage.setItem('masterBarang', JSON.stringify(masterBarang));
                localStorage.setItem('barang', JSON.stringify(masterBarang));
                localStorage.setItem('conversionRatios', JSON.stringify(conversionRatios));
                
                const resultHtml = `<div class="alert alert-success">Data bersih berhasil diinisialisasi: ${masterBarang.length} items, ${conversionRatios.length} conversion groups</div>`;
                this.updateStep(3, 'Data bersih siap', 'success', resultHtml);
                
                await this.delay(1000);
            }

            async applyDropdownFix() {
                this.updateStep(4, 'Menerapkan perbaikan dropdown...', 'info');
                
                // Create the fixed dropdown population function
                const fixedDropdownCode = `
// FIXED DROPDOWN POPULATION FUNCTION
window.populateDropdownsFixed = function() {
    console.log('üîß Using FIXED dropdown population function');
    
    const sourceSelect = document.getElementById('sourceItem');
    const targetSelect = document.getElementById('targetItem');
    
    if (!sourceSelect || !targetSelect) {
        console.warn('Dropdown elements not found');
        return false;
    }
    
    try {
        const masterBarang = JSON.parse(localStorage.getItem('masterBarang') || '[]');
        
        if (masterBarang.length === 0) {
            console.warn('No master barang data found');
            return false;
        }
        
        // Clear existing options
        sourceSelect.innerHTML = '<option value="">Pilih barang asal (yang akan dikurangi stoknya)...</option>';
        targetSelect.innerHTML = '<option value="">Pilih barang tujuan (yang akan ditambah stoknya)...</option>';
        
        // Group by base product
        const baseProducts = {};
        masterBarang.forEach(item => {
            const baseProduct = item.baseProduct || item.kode.split('-')[0];
            if (!baseProducts[baseProduct]) {
                baseProducts[baseProduct] = [];
            }
            baseProducts[baseProduct].push(item);
        });
        
        let sourceCount = 0;
        let targetCount = 0;
        
        // Populate dropdowns
        Object.entries(baseProducts).forEach(([baseProduct, items]) => {
            if (items.length > 1) { // Only transformable items
                items.forEach(item => {
                    // GUARANTEED no undefined values
                    const nama = String(item.nama || 'Unknown');
                    const satuan = String(item.satuan || 'unit');
                    const stok = Number(item.stok || 0);
                    
                    if (stok > 0) {
                        const sourceOption = new Option(
                            \`\${nama} (\${satuan}) - Stok: \${stok}\`, 
                            item.kode
                        );
                        sourceOption.dataset.baseProduct = String(item.baseProduct || item.kode);
                        sourceOption.dataset.satuan = satuan;
                        sourceOption.dataset.stok = stok.toString();
                        sourceOption.dataset.nama = nama;
                        sourceSelect.add(sourceOption);
                        sourceCount++;
                    }
                    
                    const targetOption = new Option(
                        \`\${nama} (\${satuan}) - Stok: \${stok}\`, 
                        item.kode
                    );
                    targetOption.dataset.baseProduct = String(item.baseProduct || item.kode);
                    targetOption.dataset.satuan = satuan;
                    targetOption.dataset.stok = stok.toString();
                    targetOption.dataset.nama = nama;
                    targetSelect.add(targetOption);
                    targetCount++;
                });
            }
        });
        
        targetSelect.disabled = false;
        console.log(\`‚úÖ Dropdowns populated: \${sourceCount} source, \${targetCount} target options\`);
        
        return true;
    } catch (error) {
        console.error('‚ùå Error populating dropdowns:', error);
        return false;
    }
};

// Override the original function
if (typeof window.populateDropdownsSafe === 'function') {
    window.populateDropdownsSafe = window.populateDropdownsFixed;
}

// Also override any other dropdown functions
if (typeof window.populateDropdowns === 'function') {
    window.populateDropdowns = window.populateDropdownsFixed;
}

// Apply the fix immediately
window.populateDropdownsFixed();
`;
                
                // Execute the fix code
                eval(fixedDropdownCode);
                
                // Store the code for display
                document.getElementById('applied-code').textContent = fixedDropdownCode;
                document.getElementById('fix-code').style.display = 'block';
                
                const resultHtml = `<div class="alert alert-success">Fungsi dropdown berhasil diperbaiki dan diterapkan</div>`;
                this.updateStep(4, 'Perbaikan dropdown diterapkan', 'success', resultHtml);
                
                await this.delay(1000);
            }

            async verifyFix() {
                this.updateStep(5, 'Memverifikasi perbaikan...', 'info');
                
                const verificationResults = [];
                
                // Check if dropdowns are populated
                const sourceSelect = document.getElementById('sourceItem');
                const targetSelect = document.getElementById('targetItem');
                
                if (sourceSelect && sourceSelect.options.length > 1) {
                    verificationResults.push('‚úÖ Source dropdown berhasil diisi');
                    
                    // Check for undefined values
                    let hasUndefined = false;
                    for (let i = 1; i < sourceSelect.options.length; i++) {
                        if (sourceSelect.options[i].textContent.includes('undefined')) {
                            hasUndefined = true;
                            break;
                        }
                    }
                    
                    if (!hasUndefined) {
                        verificationResults.push('‚úÖ Source dropdown tidak mengandung "undefined"');
                    } else {
                        verificationResults.push('‚ùå Source dropdown masih mengandung "undefined"');
                    }
                } else {
                    verificationResults.push('‚ùå Source dropdown kosong');
                }
                
                if (targetSelect && targetSelect.options.length > 1) {
                    verificationResults.push('‚úÖ Target dropdown berhasil diisi');
                    
                    // Check for undefined values
                    let hasUndefined = false;
                    for (let i = 1; i < targetSelect.options.length; i++) {
                        if (targetSelect.options[i].textContent.includes('undefined')) {
                            hasUndefined = true;
                            break;
                        }
                    }
                    
                    if (!hasUndefined) {
                        verificationResults.push('‚úÖ Target dropdown tidak mengandung "undefined"');
                        this.testPassed = true;
                    } else {
                        verificationResults.push('‚ùå Target dropdown masih mengandung "undefined"');
                    }
                } else {
                    verificationResults.push('‚ùå Target dropdown kosong');
                }
                
                // Check localStorage data
                try {
                    const masterBarang = JSON.parse(localStorage.getItem('masterBarang') || '[]');
                    if (masterBarang.length > 0) {
                        verificationResults.push(`‚úÖ Data master barang tersedia: ${masterBarang.length} items`);
                    }
                } catch (e) {
                    verificationResults.push('‚ùå Data master barang tidak valid');
                }
                
                const resultHtml = `<div class="alert alert-${this.testPassed ? 'success' : 'warning'}"><ul class="mb-0">${verificationResults.map(r => `<li>${r}</li>`).join('')}</ul></div>`;
                this.updateStep(5, 'Verifikasi selesai', this.testPassed ? 'success' : 'warning', resultHtml);
                
                await this.delay(1000);
            }

            testDropdown() {
                const sourceSelect = document.getElementById('sourceItem');
                const targetSelect = document.getElementById('targetItem');
                
                if (!sourceSelect || !targetSelect) {
                    alert('Dropdown elements tidak ditemukan. Silakan buka halaman transformasi barang terlebih dahulu.');
                    return;
                }
                
                let testResults = [];
                
                // Test source dropdown
                if (sourceSelect.options.length > 1) {
                    testResults.push(`‚úÖ Source dropdown: ${sourceSelect.options.length - 1} options`);
                    
                    // Check first few options for undefined
                    let undefinedCount = 0;
                    for (let i = 1; i < Math.min(6, sourceSelect.options.length); i++) {
                        if (sourceSelect.options[i].textContent.includes('undefined')) {
                            undefinedCount++;
                        }
                    }
                    
                    if (undefinedCount === 0) {
                        testResults.push('‚úÖ Tidak ada "undefined" di source dropdown');
                    } else {
                        testResults.push(`‚ùå Ditemukan ${undefinedCount} "undefined" di source dropdown`);
                    }
                } else {
                    testResults.push('‚ùå Source dropdown kosong');
                }
                
                // Test target dropdown
                if (targetSelect.options.length > 1) {
                    testResults.push(`‚úÖ Target dropdown: ${targetSelect.options.length - 1} options`);
                    
                    // Check first few options for undefined
                    let undefinedCount = 0;
                    for (let i = 1; i < Math.min(6, targetSelect.options.length); i++) {
                        if (targetSelect.options[i].textContent.includes('undefined')) {
                            undefinedCount++;
                        }
                    }
                    
                    if (undefinedCount === 0) {
                        testResults.push('‚úÖ Tidak ada "undefined" di target dropdown');
                    } else {
                        testResults.push(`‚ùå Ditemukan ${undefinedCount} "undefined" di target dropdown`);
                    }
                } else {
                    testResults.push('‚ùå Target dropdown kosong');
                }
                
                // Show test results
                const resultMessage = testResults.join('\n');
                alert(`Hasil Test Dropdown:\n\n${resultMessage}`);
                
                console.log('Dropdown Test Results:', testResults);
            }

            updateStatus(message, type) {
                const statusCard = document.getElementById('status-card');
                const statusIcon = document.getElementById('status-icon');
                const statusTitle = document.getElementById('status-title');
                const statusMessage = document.getElementById('status-message');
                
                statusCard.className = `status-card card mb-4 ${type}`;
                statusTitle.textContent = type === 'success' ? 'Perbaikan Berhasil!' : 
                                        type === 'error' ? 'Perbaikan Gagal!' : 'Sedang Memproses...';
                statusMessage.textContent = message;
                
                const iconClass = type === 'success' ? 'bi-check-circle text-success' :
                                 type === 'error' ? 'bi-x-circle text-danger' :
                                 'bi-hourglass-split text-primary';
                statusIcon.innerHTML = `<i class="${iconClass}"></i>`;
            }

            updateStep(stepNumber, message, type, resultHtml = '') {
                const step = document.getElementById(`step-${stepNumber}`);
                const result = document.getElementById(`step-${stepNumber}-result`);
                
                const icon = type === 'success' ? 'bi-check-circle text-success' :
                            type === 'error' ? 'bi-x-circle text-danger' :
                            'bi-hourglass-split text-primary';
                
                step.querySelector('h5 i').className = `${icon} me-2`;
                step.querySelector('p').textContent = message;
                
                if (resultHtml) {
                    result.innerHTML = resultHtml;
                }
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Initialize the fix system
        const dropdownFix = new DropdownFixNow();

        // Event listeners
        document.getElementById('start-fix').addEventListener('click', () => {
            document.getElementById('start-fix').disabled = true;
            dropdownFix.startFix();
        });

        document.getElementById('test-dropdown').addEventListener('click', () => {
            dropdownFix.testDropdown();
        });

        document.getElementById('open-transformasi').addEventListener('click', () => {
            window.open('transformasi_barang.html', '_blank');
        });

        // Auto-start fix if requested
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('autostart') === 'true') {
            setTimeout(() => {
                document.getElementById('start-fix').click();
            }, 1000);
        }
    </script>
</body>
</html>