<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Dropdown Transformasi Barang - SEKARANG</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .fix-card {
            border: 2px solid #007bff;
            border-radius: 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
        .fix-button {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            border-radius: 10px;
            padding: 12px 24px;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .fix-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(40,167,69,0.3);
        }
        .code-output {
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="fix-card p-4 mb-4">
                    <h2><i class="bi bi-tools me-2"></i>Fix Dropdown Transformasi Barang - SEKARANG</h2>
                    <p class="text-muted mb-4">Perbaikan instan untuk masalah dropdown yang tidak menampilkan data barang</p>
                    
                    <!-- Status Section -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="bi bi-clipboard-check me-2"></i>Status Sistem</h6>
                                </div>
                                <div class="card-body">
                                    <div id="status-list">
                                        <div class="mb-2">
                                            <span class="status-indicator status-warning"></span>
                                            <span>Memuat status...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="bi bi-speedometer2 me-2"></i>Aksi Cepat</h6>
                                </div>
                                <div class="card-body">
                                    <button class="btn fix-button w-100 mb-2" onclick="fixDropdownNow()">
                                        <i class="bi bi-lightning-fill me-2"></i>
                                        Perbaiki Dropdown SEKARANG
                                    </button>
                                    <button class="btn btn-primary w-100 mb-2" onclick="testDropdown()">
                                        <i class="bi bi-play-circle me-2"></i>
                                        Test Dropdown
                                    </button>
                                    <button class="btn btn-success w-100" onclick="openTransformationPage()">
                                        <i class="bi bi-box-arrow-up-right me-2"></i>
                                        Buka Halaman Transformasi
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Alert Container -->
                    <div id="alert-container"></div>
                    
                    <!-- Output Section -->
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="bi bi-terminal me-2"></i>Output Log</h6>
                            <button class="btn btn-sm btn-outline-secondary float-end" onclick="clearLog()">
                                <i class="bi bi-trash me-1"></i>Clear
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="output-log" class="code-output">
                                <div class="text-muted">Siap untuk menjalankan perbaikan...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let logContainer;
        let statusContainer;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            logContainer = document.getElementById('output-log');
            statusContainer = document.getElementById('status-list');
            
            log('System initialized', 'info');
            checkSystemStatus();
        });
        
        /**
         * Log message to output
         */
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#61dafb',
                success: '#4caf50',
                warning: '#ff9800',
                error: '#f44336'
            };
            
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `
                <span style="color: #888;">[${timestamp}]</span> 
                <span style="color: ${colors[type] || colors.info};">[${type.toUpperCase()}]</span> 
                ${message}
            `;
            
            if (logContainer) {
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            
            console.log(`[${timestamp}] [${type.toUpperCase()}] ${message}`);
        }
        
        /**
         * Show alert
         */
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container');
            const alertId = 'alert-' + Date.now();
            
            const alertHtml = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            alertContainer.insertAdjacentHTML('beforeend', alertHtml);
            
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) alert.remove();
            }, 5000);
        }
        
        /**
         * Update status indicator
         */
        function updateStatus(label, status, message = '') {
            const statusClass = status === 'success' ? 'status-success' : 
                               status === 'warning' ? 'status-warning' : 'status-error';
            
            const statusHtml = `
                <div class="mb-2">
                    <span class="status-indicator ${statusClass}"></span>
                    <span><strong>${label}:</strong> ${message}</span>
                </div>
            `;
            
            if (statusContainer) {
                // Find existing status or add new one
                const existingStatus = Array.from(statusContainer.children).find(child => 
                    child.textContent.includes(label)
                );
                
                if (existingStatus) {
                    existingStatus.outerHTML = statusHtml;
                } else {
                    statusContainer.insertAdjacentHTML('beforeend', statusHtml);
                }
            }
        }
        
        /**
         * Check system status
         */
        function checkSystemStatus() {
            log('Checking system status...', 'info');
            
            // Check localStorage
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                updateStatus('LocalStorage', 'success', 'Available');
                log('LocalStorage: Available', 'success');
            } catch (error) {
                updateStatus('LocalStorage', 'error', 'Not available');
                log('LocalStorage: Not available - ' + error.message, 'error');
            }
            
            // Check master barang data
            const masterBarangCheck = checkMasterBarangData();
            if (masterBarangCheck.found) {
                updateStatus('Master Barang', 'success', `${masterBarangCheck.count} items`);
                log(`Master Barang: Found ${masterBarangCheck.count} items from ${masterBarangCheck.source}`, 'success');
            } else {
                updateStatus('Master Barang', 'error', 'No data found');
                log('Master Barang: No data found', 'error');
            }
            
            // Check conversion ratios
            const conversionCheck = checkConversionRatios();
            if (conversionCheck.exists && conversionCheck.valid) {
                updateStatus('Conversion Ratios', 'success', `${conversionCheck.count} ratios`);
                log(`Conversion Ratios: Found ${conversionCheck.count} ratios`, 'success');
            } else {
                updateStatus('Conversion Ratios', 'error', 'No ratios found');
                log('Conversion Ratios: No ratios found', 'error');
            }
            
            // Check transformable items
            if (masterBarangCheck.found) {
                const transformableCount = getTransformableProductsCount(masterBarangCheck.data);
                if (transformableCount > 0) {
                    updateStatus('Transformable Items', 'success', `${transformableCount} products`);
                    log(`Transformable Items: ${transformableCount} products available`, 'success');
                } else {
                    updateStatus('Transformable Items', 'warning', 'No transformable products');
                    log('Transformable Items: No transformable products found', 'warning');
                }
            }
        }
        
        /**
         * Check master barang data
         */
        function checkMasterBarangData() {
            const dataSources = ['masterBarang', 'barang', 'stokBarang', 'produk'];
            
            for (const source of dataSources) {
                try {
                    const data = localStorage.getItem(source);
                    if (data) {
                        const parsedData = JSON.parse(data);
                        if (Array.isArray(parsedData) && parsedData.length > 0) {
                            return {
                                found: true,
                                source: source,
                                count: parsedData.length,
                                data: parsedData
                            };
                        }
                    }
                } catch (error) {
                    log(`Error parsing ${source}: ${error.message}`, 'error');
                }
            }
            
            return { found: false, source: null, count: 0, data: null };
        }
        
        /**
         * Check conversion ratios
         */
        function checkConversionRatios() {
            try {
                const ratiosData = localStorage.getItem('conversionRatios');
                if (ratiosData) {
                    const ratios = JSON.parse(ratiosData);
                    return {
                        exists: true,
                        valid: Array.isArray(ratios) && ratios.length > 0,
                        count: Array.isArray(ratios) ? ratios.length : 0,
                        data: ratios
                    };
                }
                return { exists: false, valid: false, count: 0, data: null };
            } catch (error) {
                log(`Error checking conversion ratios: ${error.message}`, 'error');
                return { exists: false, valid: false, count: 0, data: null };
            }
        }
        
        /**
         * Get transformable products count
         */
        function getTransformableProductsCount(masterBarang) {
            const baseProducts = {};
            
            masterBarang.forEach(item => {
                const baseProduct = item.baseProduct || (item.kode ? item.kode.split('-')[0] : 'UNKNOWN');
                if (!baseProducts[baseProduct]) {
                    baseProducts[baseProduct] = [];
                }
                baseProducts[baseProduct].push(item);
            });
            
            return Object.values(baseProducts).filter(items => items.length > 1).length;
        }
        
        /**
         * Fix dropdown NOW - Main function
         */
        async function fixDropdownNow() {
            log('=== STARTING DROPDOWN FIX ===', 'info');
            showAlert('Memulai perbaikan dropdown...', 'info');
            
            try {
                // Step 1: Check existing data
                log('Step 1: Checking existing data...', 'info');
                let masterBarangCheck = checkMasterBarangData();
                let sourceData = null;
                
                if (masterBarangCheck.found) {
                    sourceData = masterBarangCheck.data;
                    log(`Found existing data: ${masterBarangCheck.count} items from ${masterBarangCheck.source}`, 'success');
                } else {
                    log('No existing data found, creating sample data...', 'warning');
                    sourceData = createSampleMasterBarangData();
                    log(`Created sample data: ${sourceData.length} items`, 'success');
                }
                
                // Step 2: Normalize data
                log('Step 2: Normalizing data structure...', 'info');
                const normalizedData = normalizeBarangData(sourceData);
                log(`Normalized ${normalizedData.length} items`, 'success');
                
                // Step 3: Save to localStorage
                log('Step 3: Saving to localStorage...', 'info');
                localStorage.setItem('masterBarang', JSON.stringify(normalizedData));
                localStorage.setItem('barang', JSON.stringify(normalizedData));
                log('Data saved to localStorage', 'success');
                
                // Step 4: Create conversion ratios
                log('Step 4: Creating conversion ratios...', 'info');
                const conversionRatios = createConversionRatios(normalizedData);
                localStorage.setItem('conversionRatios', JSON.stringify(conversionRatios));
                log(`Created ${conversionRatios.length} conversion ratio groups`, 'success');
                
                // Step 5: Test data integrity
                log('Step 5: Testing data integrity...', 'info');
                const integrityTest = testDataIntegrity();
                if (integrityTest.valid) {
                    log('Data integrity test: PASSED', 'success');
                } else {
                    log(`Data integrity test: FAILED - ${integrityTest.issues.join(', ')}`, 'error');
                }
                
                // Step 6: Update status
                log('Step 6: Updating system status...', 'info');
                checkSystemStatus();
                
                log('=== DROPDOWN FIX COMPLETED ===', 'success');
                showAlert(`Perbaikan dropdown berhasil! ${normalizedData.length} item dan ${conversionRatios.length} rasio konversi tersedia.`, 'success');
                
                return {
                    success: true,
                    itemCount: normalizedData.length,
                    ratioCount: conversionRatios.length
                };
                
            } catch (error) {
                log(`ERROR: ${error.message}`, 'error');
                showAlert(`Error perbaikan dropdown: ${error.message}`, 'danger');
                throw error;
            }
        }
        
        /**
         * Create sample master barang data
         */
        function createSampleMasterBarangData() {
            return [
                {
                    kode: 'BRG001-KG',
                    nama: 'Beras Premium (Kilogram)',
                    satuan: 'kg',
                    stok: 100,
                    baseProduct: 'BRG001',
                    hargaBeli: 12000,
                    hargaJual: 15000,
                    kategori: 'Sembako'
                },
                {
                    kode: 'BRG001-GR',
                    nama: 'Beras Premium (Gram)',
                    satuan: 'gram',
                    stok: 50000,
                    baseProduct: 'BRG001',
                    hargaBeli: 12,
                    hargaJual: 15,
                    kategori: 'Sembako'
                },
                {
                    kode: 'BRG002-LT',
                    nama: 'Minyak Goreng (Liter)',
                    satuan: 'liter',
                    stok: 50,
                    baseProduct: 'BRG002',
                    hargaBeli: 18000,
                    hargaJual: 22000,
                    kategori: 'Sembako'
                },
                {
                    kode: 'BRG002-ML',
                    nama: 'Minyak Goreng (Mililiter)',
                    satuan: 'ml',
                    stok: 25000,
                    baseProduct: 'BRG002',
                    hargaBeli: 18,
                    hargaJual: 22,
                    kategori: 'Sembako'
                },
                {
                    kode: 'BRG003-DUS',
                    nama: 'Air Mineral (Dus)',
                    satuan: 'dus',
                    stok: 20,
                    baseProduct: 'BRG003',
                    hargaBeli: 48000,
                    hargaJual: 60000,
                    kategori: 'Minuman'
                },
                {
                    kode: 'BRG003-BTL',
                    nama: 'Air Mineral (Botol)',
                    satuan: 'botol',
                    stok: 480,
                    baseProduct: 'BRG003',
                    hargaBeli: 2000,
                    hargaJual: 2500,
                    kategori: 'Minuman'
                },
                {
                    kode: 'BRG004-KG',
                    nama: 'Gula Pasir (Kilogram)',
                    satuan: 'kg',
                    stok: 75,
                    baseProduct: 'BRG004',
                    hargaBeli: 14000,
                    hargaJual: 17000,
                    kategori: 'Sembako'
                },
                {
                    kode: 'BRG004-GR',
                    nama: 'Gula Pasir (Gram)',
                    satuan: 'gram',
                    stok: 25000,
                    baseProduct: 'BRG004',
                    hargaBeli: 14,
                    hargaJual: 17,
                    kategori: 'Sembako'
                }
            ];
        }
        
        /**
         * Normalize barang data
         */
        function normalizeBarangData(data) {
            return data.map(item => {
                const normalized = {
                    kode: item.kode || item.id || item.barcode || `BRG${Date.now()}`,
                    nama: item.nama || item.name || item.namaBarang || 'Unnamed Item',
                    satuan: item.satuan || item.unit || 'pcs',
                    stok: parseInt(item.stok || item.stock || item.qty || 0),
                    baseProduct: item.baseProduct || (item.kode ? item.kode.split('-')[0] : 'UNKNOWN'),
                    hargaBeli: parseFloat(item.hargaBeli || item.harga_beli || item.buyPrice || 0),
                    hargaJual: parseFloat(item.hargaJual || item.harga_jual || item.sellPrice || 0),
                    kategori: item.kategori || item.category || 'Lainnya'
                };
                
                // Copy additional fields
                Object.keys(item).forEach(key => {
                    if (!normalized.hasOwnProperty(key)) {
                        normalized[key] = item[key];
                    }
                });
                
                return normalized;
            });
        }
        
        /**
         * Create conversion ratios
         */
        function createConversionRatios(masterBarang) {
            const baseProducts = {};
            
            // Group by base product
            masterBarang.forEach(item => {
                const baseProduct = item.baseProduct;
                if (!baseProducts[baseProduct]) {
                    baseProducts[baseProduct] = [];
                }
                baseProducts[baseProduct].push(item);
            });
            
            const conversionRatios = [];
            
            // Predefined conversions
            const unitConversions = {
                'kg': { 'gram': 1000, 'gr': 1000 },
                'gram': { 'kg': 0.001 },
                'gr': { 'kg': 0.001 },
                'liter': { 'ml': 1000, 'mililiter': 1000 },
                'ml': { 'liter': 0.001 },
                'mililiter': { 'liter': 0.001 },
                'dus': { 'botol': 24, 'pcs': 24, 'buah': 24 },
                'botol': { 'dus': 0.041667 },
                'pcs': { 'dus': 0.041667 },
                'buah': { 'dus': 0.041667 }
            };
            
            Object.entries(baseProducts).forEach(([baseProduct, items]) => {
                if (items.length > 1) {
                    const conversions = [];
                    
                    items.forEach(fromItem => {
                        items.forEach(toItem => {
                            if (fromItem.satuan !== toItem.satuan) {
                                let ratio = 1;
                                
                                if (unitConversions[fromItem.satuan] && 
                                    unitConversions[fromItem.satuan][toItem.satuan]) {
                                    ratio = unitConversions[fromItem.satuan][toItem.satuan];
                                }
                                
                                conversions.push({
                                    from: fromItem.satuan,
                                    to: toItem.satuan,
                                    ratio: ratio
                                });
                            }
                        });
                    });
                    
                    if (conversions.length > 0) {
                        conversionRatios.push({
                            baseProduct: baseProduct,
                            conversions: conversions
                        });
                    }
                }
            });
            
            return conversionRatios;
        }
        
        /**
         * Test data integrity
         */
        function testDataIntegrity() {
            const results = { valid: true, issues: [], warnings: [] };
            
            try {
                // Test master barang
                const masterBarangCheck = checkMasterBarangData();
                if (!masterBarangCheck.found) {
                    results.valid = false;
                    results.issues.push('Master barang data not found');
                } else {
                    const requiredFields = ['kode', 'nama', 'satuan', 'stok'];
                    const validItems = masterBarangCheck.data.filter(item => 
                        requiredFields.every(field => item.hasOwnProperty(field))
                    );
                    
                    if (validItems.length === 0) {
                        results.valid = false;
                        results.issues.push('No items with required fields');
                    } else if (validItems.length < masterBarangCheck.count) {
                        results.warnings.push(`${masterBarangCheck.count - validItems.length} items missing required fields`);
                    }
                }
                
                // Test conversion ratios
                const conversionCheck = checkConversionRatios();
                if (!conversionCheck.exists || !conversionCheck.valid) {
                    results.valid = false;
                    results.issues.push('Conversion ratios not found or invalid');
                }
                
            } catch (error) {
                results.valid = false;
                results.issues.push(`Integrity test error: ${error.message}`);
            }
            
            return results;
        }
        
        /**
         * Test dropdown functionality
         */
        async function testDropdown() {
            log('=== TESTING DROPDOWN FUNCTIONALITY ===', 'info');
            showAlert('Menjalankan test dropdown...', 'info');
            
            try {
                const testResults = [];
                
                // Test 1: Data availability
                const masterBarangCheck = checkMasterBarangData();
                testResults.push({
                    name: 'Data Availability',
                    passed: masterBarangCheck.found,
                    message: masterBarangCheck.found ? 
                        `${masterBarangCheck.count} items available` : 
                        'No data found'
                });
                
                // Test 2: Conversion ratios
                const conversionCheck = checkConversionRatios();
                testResults.push({
                    name: 'Conversion Ratios',
                    passed: conversionCheck.exists && conversionCheck.valid,
                    message: conversionCheck.valid ? 
                        `${conversionCheck.count} ratios available` : 
                        'No valid ratios found'
                });
                
                // Test 3: Transformable items
                if (masterBarangCheck.found) {
                    const transformableCount = getTransformableProductsCount(masterBarangCheck.data);
                    testResults.push({
                        name: 'Transformable Items',
                        passed: transformableCount > 0,
                        message: `${transformableCount} products can be transformed`
                    });
                }
                
                // Test 4: Data structure
                if (masterBarangCheck.found) {
                    const requiredFields = ['kode', 'nama', 'satuan', 'stok', 'baseProduct'];
                    const validItems = masterBarangCheck.data.filter(item => 
                        requiredFields.every(field => item.hasOwnProperty(field))
                    );
                    
                    testResults.push({
                        name: 'Data Structure',
                        passed: validItems.length > 0,
                        message: `${validItems.length}/${masterBarangCheck.count} items have valid structure`
                    });
                }
                
                // Display results
                log('Test Results:', 'info');
                testResults.forEach(test => {
                    const status = test.passed ? 'PASS' : 'FAIL';
                    const logType = test.passed ? 'success' : 'error';
                    log(`  ${test.name}: ${status} - ${test.message}`, logType);
                });
                
                const allPassed = testResults.every(test => test.passed);
                log(`=== TEST COMPLETED: ${allPassed ? 'ALL PASSED' : 'SOME FAILED'} ===`, allPassed ? 'success' : 'error');
                
                showAlert(
                    allPassed ? 'Semua test berhasil!' : 'Beberapa test gagal, periksa log untuk detail',
                    allPassed ? 'success' : 'warning'
                );
                
                return { success: allPassed, results: testResults };
                
            } catch (error) {
                log(`Test error: ${error.message}`, 'error');
                showAlert(`Error menjalankan test: ${error.message}`, 'danger');
                throw error;
            }
        }
        
        /**
         * Clear log
         */
        function clearLog() {
            if (logContainer) {
                logContainer.innerHTML = '<div class="text-muted">Log cleared...</div>';
            }
        }
        
        /**
         * Open transformation page
         */
        function openTransformationPage() {
            log('Opening transformation page...', 'info');
            window.open('transformasi_barang.html', '_blank');
        }
    </script>
</body>
</html>