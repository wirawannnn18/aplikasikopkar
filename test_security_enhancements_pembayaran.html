<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Security Enhancements - Pembayaran Hutang Piutang</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        .test-section {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
        }
        .test-result {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 0.375rem;
        }
        .test-success {
            background-color: #d1e7dd;
            border: 1px solid #badbcc;
            color: #0f5132;
        }
        .test-error {
            background-color: #f8d7da;
            border: 1px solid #f5c2c7;
            color: #842029;
        }
        .test-warning {
            background-color: #fff3cd;
            border: 1px solid #ffecb5;
            color: #664d03;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <h2><i class="bi bi-shield-check"></i> Test Security Enhancements - Pembayaran Hutang Piutang</h2>
                <p class="text-muted">Testing role-based access control and input sanitization</p>
                
                <!-- Test 1: Role-based Access Control -->
                <div class="test-section">
                    <h4><i class="bi bi-person-check"></i> Test 1: Role-based Access Control</h4>
                    <p>Testing checkOperationPermission function with different roles</p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Test Role:</label>
                            <select class="form-select" id="testRole">
                                <option value="super_admin">Super Admin</option>
                                <option value="administrator">Administrator</option>
                                <option value="admin">Admin</option>
                                <option value="kasir">Kasir</option>
                                <option value="keuangan">Keuangan</option>
                                <option value="anggota">Anggota</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Test Operation:</label>
                            <select class="form-select" id="testOperation">
                                <option value="view">View</option>
                                <option value="process">Process</option>
                                <option value="print">Print</option>
                                <option value="history">History</option>
                                <option value="audit">Audit</option>
                            </select>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary mt-3" onclick="testRoleAccess()">
                        <i class="bi bi-play"></i> Test Role Access
                    </button>
                    <div id="roleAccessResult" class="test-result" style="display: none;"></div>
                </div>
                
                <!-- Test 2: Input Sanitization -->
                <div class="test-section">
                    <h4><i class="bi bi-shield-exclamation"></i> Test 2: Input Sanitization</h4>
                    <p>Testing sanitizeTextInput function against XSS attacks</p>
                    
                    <div class="mb-3">
                        <label class="form-label">Test Input (try XSS payloads):</label>
                        <textarea class="form-control" id="testInput" rows="3" placeholder="Enter text with potential XSS...">
<script>alert('XSS')</script>Hello World
<img src=x onerror="alert('XSS')">
<a href="javascript:alert('XSS')">Click</a></textarea>
                    </div>
                    
                    <button class="btn btn-primary" onclick="testInputSanitization()">
                        <i class="bi bi-shield-check"></i> Test Sanitization
                    </button>
                    <div id="sanitizationResult" class="test-result" style="display: none;"></div>
                </div>
                
                <!-- Test 3: Numeric Validation -->
                <div class="test-section">
                    <h4><i class="bi bi-123"></i> Test 3: Numeric Validation</h4>
                    <p>Testing validateNumericInput function</p>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Test Value:</label>
                            <input type="text" class="form-control" id="testNumeric" placeholder="Enter number..." value="1000000">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Min Value:</label>
                            <input type="number" class="form-control" id="testMin" value="1">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Max Value:</label>
                            <input type="number" class="form-control" id="testMax" value="10000000">
                        </div>
                    </div>
                    
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="allowNegative">
                                <label class="form-check-label" for="allowNegative">Allow Negative</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="allowDecimal" checked>
                                <label class="form-check-label" for="allowDecimal">Allow Decimal</label>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary mt-3" onclick="testNumericValidation()">
                        <i class="bi bi-calculator"></i> Test Numeric Validation
                    </button>
                    <div id="numericResult" class="test-result" style="display: none;"></div>
                </div>
                
                <!-- Test 4: Date Validation -->
                <div class="test-section">
                    <h4><i class="bi bi-calendar-check"></i> Test 4: Date Validation</h4>
                    <p>Testing validateDateInput function</p>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Test Date:</label>
                            <input type="text" class="form-control" id="testDate" placeholder="YYYY-MM-DD" value="2024-12-19">
                        </div>
                        <div class="col-md-4">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="allowFuture">
                                <label class="form-check-label" for="allowFuture">Allow Future</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="allowPast" checked>
                                <label class="form-check-label" for="allowPast">Allow Past</label>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary mt-3" onclick="testDateValidation()">
                        <i class="bi bi-calendar-check"></i> Test Date Validation
                    </button>
                    <div id="dateResult" class="test-result" style="display: none;"></div>
                </div>
                
                <!-- Test 5: Session Validation -->
                <div class="test-section">
                    <h4><i class="bi bi-person-check"></i> Test 5: Session Validation</h4>
                    <p>Testing validateUserSession function</p>
                    
                    <div class="mb-3">
                        <label class="form-label">Current User Info:</label>
                        <div id="currentUserInfo" class="alert alert-info">
                            Loading user info...
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="testSessionValidation()">
                        <i class="bi bi-person-check"></i> Test Session Validation
                    </button>
                    <div id="sessionResult" class="test-result" style="display: none;"></div>
                </div>
                
                <!-- Test 6: Payment Form Sanitization -->
                <div class="test-section">
                    <h4><i class="bi bi-credit-card-2-front"></i> Test 6: Payment Form Sanitization</h4>
                    <p>Testing sanitizePaymentFormData function</p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Anggota ID:</label>
                                <input type="text" class="form-control" id="testAnggotaId" value="ANG001">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Anggota Nama:</label>
                                <input type="text" class="form-control" id="testAnggotaNama" value="John Doe<script>alert('xss')</script>">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Anggota NIK:</label>
                                <input type="text" class="form-control" id="testAnggotaNIK" value="1234567890123456">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Jenis:</label>
                                <select class="form-select" id="testJenis">
                                    <option value="hutang">Hutang</option>
                                    <option value="piutang">Piutang</option>
                                    <option value="invalid">Invalid</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Jumlah:</label>
                                <input type="text" class="form-control" id="testJumlah" value="1000000">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Keterangan:</label>
                                <textarea class="form-control" id="testKeterangan" rows="2">Pembayaran normal<img src=x onerror="alert('xss')"</textarea>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="testFormSanitization()">
                        <i class="bi bi-shield-check"></i> Test Form Sanitization
                    </button>
                    <div id="formSanitizationResult" class="test-result" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Mock dependencies -->
    <script>
        // Mock localStorage
        const mockLocalStorage = {
            getItem: function(key) {
                const data = {
                    'currentUser': JSON.stringify({
                        id: 1,
                        username: 'testuser',
                        name: 'Test User',
                        role: 'kasir',
                        active: true
                    }),
                    'users': JSON.stringify([
                        {
                            id: 1,
                            username: 'testuser',
                            name: 'Test User',
                            role: 'kasir',
                            active: true
                        }
                    ])
                };
                return data[key] || null;
            },
            setItem: function(key, value) {
                // Mock implementation
            }
        };
        
        // Override localStorage for testing
        Object.defineProperty(window, 'localStorage', {
            value: mockLocalStorage,
            writable: true
        });
        
        // Mock formatRupiah function
        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR'
            }).format(amount);
        }
    </script>
    
    <!-- Load the pembayaran hutang piutang module -->
    <script src="js/pembayaranHutangPiutang.js"></script>
    
    <script>
        // Test functions
        function testRoleAccess() {
            const role = document.getElementById('testRole').value;
            const operation = document.getElementById('testOperation').value;
            const resultDiv = document.getElementById('roleAccessResult');
            
            try {
                // Mock current user with test role
                mockLocalStorage.getItem = function(key) {
                    if (key === 'currentUser') {
                        return JSON.stringify({
                            id: 1,
                            username: 'testuser',
                            name: 'Test User',
                            role: role,
                            active: true
                        });
                    }
                    if (key === 'users') {
                        return JSON.stringify([{
                            id: 1,
                            username: 'testuser',
                            name: 'Test User',
                            role: role,
                            active: true
                        }]);
                    }
                    return null;
                };
                
                const hasPermission = checkOperationPermission(operation);
                
                resultDiv.className = `test-result ${hasPermission ? 'test-success' : 'test-warning'}`;
                resultDiv.innerHTML = `
                    <strong>Result:</strong> ${hasPermission ? 'ALLOWED' : 'DENIED'}<br>
                    <strong>Role:</strong> ${role}<br>
                    <strong>Operation:</strong> ${operation}<br>
                    <strong>Permission:</strong> ${hasPermission ? '✅ Granted' : '❌ Denied'}
                `;
                resultDiv.style.display = 'block';
            } catch (error) {
                resultDiv.className = 'test-result test-error';
                resultDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;
                resultDiv.style.display = 'block';
            }
        }
        
        function testInputSanitization() {
            const input = document.getElementById('testInput').value;
            const resultDiv = document.getElementById('sanitizationResult');
            
            try {
                const sanitized = sanitizeTextInput(input);
                
                resultDiv.className = 'test-result test-success';
                resultDiv.innerHTML = `
                    <strong>Original:</strong><br>
                    <code>${escapeHtml(input)}</code><br><br>
                    <strong>Sanitized:</strong><br>
                    <code>${escapeHtml(sanitized)}</code><br><br>
                    <strong>Status:</strong> ${sanitized !== input ? '✅ Sanitized' : '⚠️ No changes needed'}
                `;
                resultDiv.style.display = 'block';
            } catch (error) {
                resultDiv.className = 'test-result test-error';
                resultDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;
                resultDiv.style.display = 'block';
            }
        }
        
        function testNumericValidation() {
            const value = document.getElementById('testNumeric').value;
            const min = parseFloat(document.getElementById('testMin').value);
            const max = parseFloat(document.getElementById('testMax').value);
            const allowNegative = document.getElementById('allowNegative').checked;
            const allowDecimal = document.getElementById('allowDecimal').checked;
            const resultDiv = document.getElementById('numericResult');
            
            try {
                const result = validateNumericInput(value, {
                    min: min,
                    max: max,
                    allowNegative: allowNegative,
                    allowDecimal: allowDecimal,
                    fieldName: 'Test Value'
                });
                
                resultDiv.className = `test-result ${result.valid ? 'test-success' : 'test-warning'}`;
                resultDiv.innerHTML = `
                    <strong>Input:</strong> "${value}"<br>
                    <strong>Valid:</strong> ${result.valid ? '✅ Yes' : '❌ No'}<br>
                    <strong>Sanitized:</strong> ${result.sanitized !== null ? result.sanitized : 'null'}<br>
                    <strong>Error:</strong> ${result.error || 'None'}<br>
                    <strong>Options:</strong> Min: ${min}, Max: ${max}, Negative: ${allowNegative}, Decimal: ${allowDecimal}
                `;
                resultDiv.style.display = 'block';
            } catch (error) {
                resultDiv.className = 'test-result test-error';
                resultDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;
                resultDiv.style.display = 'block';
            }
        }
        
        function testDateValidation() {
            const date = document.getElementById('testDate').value;
            const allowFuture = document.getElementById('allowFuture').checked;
            const allowPast = document.getElementById('allowPast').checked;
            const resultDiv = document.getElementById('dateResult');
            
            try {
                const result = validateDateInput(date, {
                    allowFuture: allowFuture,
                    allowPast: allowPast,
                    fieldName: 'Test Date'
                });
                
                resultDiv.className = `test-result ${result.valid ? 'test-success' : 'test-warning'}`;
                resultDiv.innerHTML = `
                    <strong>Input:</strong> "${date}"<br>
                    <strong>Valid:</strong> ${result.valid ? '✅ Yes' : '❌ No'}<br>
                    <strong>Sanitized:</strong> ${result.sanitized || 'null'}<br>
                    <strong>Error:</strong> ${result.error || 'None'}<br>
                    <strong>Options:</strong> Future: ${allowFuture}, Past: ${allowPast}
                `;
                resultDiv.style.display = 'block';
            } catch (error) {
                resultDiv.className = 'test-result test-error';
                resultDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;
                resultDiv.style.display = 'block';
            }
        }
        
        function testSessionValidation() {
            const resultDiv = document.getElementById('sessionResult');
            
            try {
                const result = validateUserSession();
                
                resultDiv.className = `test-result ${result.valid ? 'test-success' : 'test-warning'}`;
                resultDiv.innerHTML = `
                    <strong>Valid:</strong> ${result.valid ? '✅ Yes' : '❌ No'}<br>
                    <strong>Error:</strong> ${result.error || 'None'}<br>
                    <strong>Code:</strong> ${result.code || 'None'}<br>
                    <strong>User:</strong> ${result.user ? JSON.stringify(result.user, null, 2) : 'None'}
                `;
                resultDiv.style.display = 'block';
            } catch (error) {
                resultDiv.className = 'test-result test-error';
                resultDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;
                resultDiv.style.display = 'block';
            }
        }
        
        function testFormSanitization() {
            const formData = {
                anggotaId: document.getElementById('testAnggotaId').value,
                anggotaNama: document.getElementById('testAnggotaNama').value,
                anggotaNIK: document.getElementById('testAnggotaNIK').value,
                jenis: document.getElementById('testJenis').value,
                jumlah: document.getElementById('testJumlah').value,
                keterangan: document.getElementById('testKeterangan').value
            };
            const resultDiv = document.getElementById('formSanitizationResult');
            
            try {
                const result = sanitizePaymentFormData(formData);
                
                resultDiv.className = `test-result ${result.valid ? 'test-success' : 'test-warning'}`;
                resultDiv.innerHTML = `
                    <strong>Valid:</strong> ${result.valid ? '✅ Yes' : '❌ No'}<br>
                    <strong>Errors:</strong> ${result.errors.length > 0 ? result.errors.join(', ') : 'None'}<br>
                    <strong>Original Data:</strong><br>
                    <pre>${JSON.stringify(formData, null, 2)}</pre>
                    <strong>Sanitized Data:</strong><br>
                    <pre>${JSON.stringify(result.sanitized, null, 2)}</pre>
                `;
                resultDiv.style.display = 'block';
            } catch (error) {
                resultDiv.className = 'test-result test-error';
                resultDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;
                resultDiv.style.display = 'block';
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Display current user info
            const currentUserInfo = document.getElementById('currentUserInfo');
            try {
                const currentUser = JSON.parse(mockLocalStorage.getItem('currentUser'));
                currentUserInfo.innerHTML = `
                    <strong>ID:</strong> ${currentUser.id}<br>
                    <strong>Username:</strong> ${currentUser.username}<br>
                    <strong>Name:</strong> ${currentUser.name}<br>
                    <strong>Role:</strong> ${currentUser.role}<br>
                    <strong>Active:</strong> ${currentUser.active}
                `;
            } catch (error) {
                currentUserInfo.innerHTML = `<strong>Error:</strong> ${error.message}`;
                currentUserInfo.className = 'alert alert-danger';
            }
        });
        
        // Helper function for escaping HTML (if not available)
        if (typeof escapeHtml === 'undefined') {
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }
    </script>
</body>
</html>