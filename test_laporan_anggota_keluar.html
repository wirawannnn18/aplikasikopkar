<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Laporan Anggota Keluar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .test-result.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .test-result.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .test-result.info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        #content-area {
            margin-top: 20px;
        }
        .log-entry {
            font-family: monospace;
            font-size: 12px;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h1 class="mb-4"><i class="bi bi-clipboard-check me-2"></i>Test Laporan Anggota Keluar</h1>
        
        <!-- Test Controls -->
        <div class="test-section">
            <h3>Test Controls</h3>
            <div class="row g-2">
                <div class="col-md-3">
                    <button class="btn btn-primary w-100" onclick="setupTestData()">
                        <i class="bi bi-database-add me-1"></i>Setup Test Data
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-success w-100" onclick="testRenderLaporan()">
                        <i class="bi bi-file-earmark-text me-1"></i>Test Render Laporan
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-info w-100" onclick="testDateFilter()">
                        <i class="bi bi-funnel me-1"></i>Test Date Filter
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-warning w-100" onclick="testCSVExport()">
                        <i class="bi bi-file-earmark-spreadsheet me-1"></i>Test CSV Export
                    </button>
                </div>
            </div>
            <div class="row g-2 mt-2">
                <div class="col-md-3">
                    <button class="btn btn-secondary w-100" onclick="clearTestData()">
                        <i class="bi bi-trash me-1"></i>Clear Test Data
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-primary w-100" onclick="viewTestData()">
                        <i class="bi bi-eye me-1"></i>View Test Data
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-success w-100" onclick="runAllTests()">
                        <i class="bi bi-play-circle me-1"></i>Run All Tests
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-danger w-100" onclick="clearResults()">
                        <i class="bi bi-x-circle me-1"></i>Clear Results
                    </button>
                </div>
            </div>
        </div>

        <!-- Test Results -->
        <div class="test-section">
            <h3>Test Results</h3>
            <div id="test-results"></div>
        </div>

        <!-- Content Area (for rendering laporan) -->
        <div id="content-area"></div>

        <!-- Test Data View -->
        <div class="test-section" id="data-view" style="display: none;">
            <h3>Test Data</h3>
            <div id="data-content"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/anggotaKeluarRepository.js"></script>
    <script src="js/anggotaKeluarManager.js"></script>
    <script src="js/anggotaKeluarUI.js"></script>
    
    <script>
        // Helper functions
        function generateId() {
            return 'test-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        function getCurrentDateISO() {
            return new Date().toISOString().split('T')[0];
        }

        function formatDateToDisplay(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });
        }

        function logResult(message, type = 'info') {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            logResult('Results cleared', 'info');
        }

        // Setup test data
        function setupTestData() {
            try {
                localStorage.clear();
                
                // Create test anggota keluar
                const anggotaList = [
                    {
                        id: generateId(),
                        nik: '1234567890123456',
                        nama: 'Budi Santoso',
                        departemen: 'IT',
                        tipeAnggota: 'Umum',
                        statusKeanggotaan: 'Keluar',
                        tanggalKeluar: '2024-11-01',
                        alasanKeluar: 'Pindah ke perusahaan lain',
                        pengembalianStatus: 'Pending'
                    },
                    {
                        id: generateId(),
                        nik: '2345678901234567',
                        nama: 'Siti Aminah',
                        departemen: 'Finance',
                        tipeAnggota: 'Umum',
                        statusKeanggotaan: 'Keluar',
                        tanggalKeluar: '2024-11-15',
                        alasanKeluar: 'Pensiun',
                        pengembalianStatus: 'Selesai',
                        pengembalianId: 'pgm-001'
                    },
                    {
                        id: generateId(),
                        nik: '3456789012345678',
                        nama: 'Ahmad Hidayat',
                        departemen: 'HR',
                        tipeAnggota: 'Umum',
                        statusKeanggotaan: 'Keluar',
                        tanggalKeluar: '2024-12-01',
                        alasanKeluar: 'Mengundurkan diri',
                        pengembalianStatus: 'Pending'
                    },
                    {
                        id: generateId(),
                        nik: '4567890123456789',
                        nama: 'Dewi Lestari',
                        departemen: 'Operations',
                        tipeAnggota: 'Umum',
                        statusKeanggotaan: 'Keluar',
                        tanggalKeluar: '2024-10-15',
                        alasanKeluar: 'Pindah kota',
                        pengembalianStatus: 'Selesai',
                        pengembalianId: 'pgm-002'
                    },
                    {
                        id: generateId(),
                        nik: '5678901234567890',
                        nama: 'Eko Prasetyo',
                        departemen: 'IT',
                        tipeAnggota: 'Umum',
                        statusKeanggotaan: 'Keluar',
                        tanggalKeluar: '2024-11-20',
                        alasanKeluar: 'Melanjutkan pendidikan',
                        pengembalianStatus: 'Pending'
                    }
                ];
                
                localStorage.setItem('anggota', JSON.stringify(anggotaList));
                
                // Create test pengembalian records
                const pengembalianList = [
                    {
                        id: 'pgm-001',
                        anggotaId: anggotaList[1].id,
                        anggotaNama: 'Siti Aminah',
                        anggotaNIK: '2345678901234567',
                        simpananPokok: 1000000,
                        simpananWajib: 2500000,
                        totalSimpanan: 3500000,
                        kewajibanLain: 0,
                        totalPengembalian: 3500000,
                        metodePembayaran: 'Transfer Bank',
                        tanggalPembayaran: '2024-11-16',
                        nomorReferensi: 'PGM-202411-001',
                        status: 'Selesai'
                    },
                    {
                        id: 'pgm-002',
                        anggotaId: anggotaList[3].id,
                        anggotaNama: 'Dewi Lestari',
                        anggotaNIK: '4567890123456789',
                        simpananPokok: 1000000,
                        simpananWajib: 1800000,
                        totalSimpanan: 2800000,
                        kewajibanLain: 0,
                        totalPengembalian: 2800000,
                        metodePembayaran: 'Kas',
                        tanggalPembayaran: '2024-10-16',
                        nomorReferensi: 'PGM-202410-002',
                        status: 'Selesai'
                    }
                ];
                
                localStorage.setItem('pengembalian', JSON.stringify(pengembalianList));
                
                logResult(`‚úÖ Test data created: ${anggotaList.length} anggota keluar, ${pengembalianList.length} pengembalian`, 'success');
            } catch (error) {
                logResult(`‚ùå Error setting up test data: ${error.message}`, 'error');
            }
        }

        // Test render laporan
        function testRenderLaporan() {
            try {
                logResult('Testing renderLaporanAnggotaKeluar()...', 'info');
                
                const html = renderLaporanAnggotaKeluar();
                const contentArea = document.getElementById('content-area');
                contentArea.innerHTML = html;
                
                // Verify rendering
                const table = contentArea.querySelector('table');
                const summaryCards = contentArea.querySelectorAll('.card');
                const filterSection = contentArea.querySelector('#formFilterLaporan');
                const exportButton = contentArea.querySelector('button[onclick*="handleExportCSV"]');
                
                if (table && summaryCards.length === 4 && filterSection && exportButton) {
                    logResult('‚úÖ Laporan rendered successfully with all components', 'success');
                } else {
                    logResult('‚ö†Ô∏è Laporan rendered but some components missing', 'error');
                }
            } catch (error) {
                logResult(`‚ùå Error rendering laporan: ${error.message}`, 'error');
            }
        }

        // Test date filter
        function testDateFilter() {
            try {
                logResult('Testing date range filter...', 'info');
                
                // Test 1: Filter with start date only
                const html1 = renderLaporanAnggotaKeluar('2024-11-01', null);
                document.getElementById('content-area').innerHTML = html1;
                logResult('‚úÖ Test 1: Start date only filter applied', 'success');
                
                // Test 2: Filter with end date only
                setTimeout(() => {
                    const html2 = renderLaporanAnggotaKeluar(null, '2024-11-30');
                    document.getElementById('content-area').innerHTML = html2;
                    logResult('‚úÖ Test 2: End date only filter applied', 'success');
                }, 1000);
                
                // Test 3: Filter with both dates
                setTimeout(() => {
                    const html3 = renderLaporanAnggotaKeluar('2024-11-01', '2024-11-30');
                    document.getElementById('content-area').innerHTML = html3;
                    logResult('‚úÖ Test 3: Date range filter applied', 'success');
                }, 2000);
                
                // Test 4: No filter
                setTimeout(() => {
                    const html4 = renderLaporanAnggotaKeluar();
                    document.getElementById('content-area').innerHTML = html4;
                    logResult('‚úÖ Test 4: No filter (show all)', 'success');
                }, 3000);
                
            } catch (error) {
                logResult(`‚ùå Error testing date filter: ${error.message}`, 'error');
            }
        }

        // Test CSV export
        function testCSVExport() {
            try {
                logResult('Testing CSV export...', 'info');
                
                const anggotaKeluar = getAnggotaKeluar();
                const result = generateCSVAnggotaKeluar(anggotaKeluar);
                
                if (result.success) {
                    const csv = result.data.csv;
                    const lines = csv.split('\n');
                    const headerLine = lines[0];
                    const dataRows = lines.slice(1).filter(line => line.trim() !== '');
                    
                    logResult(`‚úÖ CSV generated successfully`, 'success');
                    logResult(`   - Filename: ${result.data.filename}`, 'info');
                    logResult(`   - Row count: ${result.data.rowCount}`, 'info');
                    logResult(`   - Header: ${headerLine}`, 'info');
                    logResult(`   - Data rows: ${dataRows.length}`, 'info');
                    
                    // Show first data row as sample
                    if (dataRows.length > 0) {
                        logResult(`   - Sample row: ${dataRows[0].substring(0, 100)}...`, 'info');
                    }
                    
                    // Verify CSV structure
                    const requiredFields = ['NIK', 'Nama', 'Departemen', 'Tanggal Keluar', 'Status Pengembalian', 'Total Pengembalian'];
                    const hasAllFields = requiredFields.every(field => headerLine.includes(field));
                    
                    if (hasAllFields) {
                        logResult('‚úÖ CSV contains all required fields', 'success');
                    } else {
                        logResult('‚ö†Ô∏è CSV missing some required fields', 'error');
                    }
                } else {
                    logResult(`‚ùå CSV generation failed: ${result.error.message}`, 'error');
                }
            } catch (error) {
                logResult(`‚ùå Error testing CSV export: ${error.message}`, 'error');
            }
        }

        // Clear test data
        function clearTestData() {
            try {
                localStorage.clear();
                document.getElementById('content-area').innerHTML = '';
                logResult('‚úÖ Test data cleared', 'success');
            } catch (error) {
                logResult(`‚ùå Error clearing test data: ${error.message}`, 'error');
            }
        }

        // View test data
        function viewTestData() {
            try {
                const anggota = JSON.parse(localStorage.getItem('anggota') || '[]');
                const pengembalian = JSON.parse(localStorage.getItem('pengembalian') || '[]');
                
                const dataView = document.getElementById('data-view');
                const dataContent = document.getElementById('data-content');
                
                let html = '<h5>Anggota Keluar</h5>';
                html += `<pre>${JSON.stringify(anggota, null, 2)}</pre>`;
                html += '<h5 class="mt-3">Pengembalian</h5>';
                html += `<pre>${JSON.stringify(pengembalian, null, 2)}</pre>`;
                
                dataContent.innerHTML = html;
                dataView.style.display = 'block';
                
                logResult(`‚úÖ Viewing ${anggota.length} anggota and ${pengembalian.length} pengembalian records`, 'info');
            } catch (error) {
                logResult(`‚ùå Error viewing test data: ${error.message}`, 'error');
            }
        }

        // Run all tests
        function runAllTests() {
            clearResults();
            logResult('üöÄ Starting all tests...', 'info');
            
            setupTestData();
            
            setTimeout(() => {
                testRenderLaporan();
            }, 500);
            
            setTimeout(() => {
                testDateFilter();
            }, 1500);
            
            setTimeout(() => {
                testCSVExport();
            }, 6000);
            
            setTimeout(() => {
                logResult('‚úÖ All tests completed!', 'success');
            }, 7000);
        }

        // Initialize
        logResult('Test page loaded. Click "Run All Tests" to start.', 'info');
    </script>
</body>
</html>
