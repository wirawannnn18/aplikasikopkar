<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Transformasi Barang - Integrasi Stok Real</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .fix-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .status-card {
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
        .success-card {
            border-left: 4px solid #28a745;
            background: #d4edda;
        }
        .warning-card {
            border-left: 4px solid #ffc107;
            background: #fff3cd;
        }
        .error-card {
            border-left: 4px solid #dc3545;
            background: #f8d7da;
        }
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .step-number {
            background: #007bff;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="fix-container">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="bi bi-tools me-2"></i>
                    Fix Transformasi Barang - Integrasi Stok Real
                </h1>
                <p class="lead">
                    Perbaikan untuk mengintegrasikan Form Transformasi Barang dengan data stok barang yang sebenarnya
                </p>
            </div>
        </div>

        <!-- Status Check -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card status-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-clipboard-check me-2"></i>
                            Status Sistem
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="system-status">
                            <div class="d-flex align-items-center mb-2">
                                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                Memeriksa status sistem...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fix Steps -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-list-ol me-2"></i>
                            Langkah Perbaikan
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="step mb-3">
                            <div class="d-flex align-items-start">
                                <span class="step-number">1</span>
                                <div>
                                    <h6>Load Stock Integration Fix</h6>
                                    <p class="mb-1">Memuat sistem integrasi stok barang yang baru</p>
                                    <div id="step1-status" class="text-muted">Menunggu...</div>
                                </div>
                            </div>
                        </div>

                        <div class="step mb-3">
                            <div class="d-flex align-items-start">
                                <span class="step-number">2</span>
                                <div>
                                    <h6>Check Stock Data Sources</h6>
                                    <p class="mb-1">Memeriksa sumber data stok barang di localStorage</p>
                                    <div id="step2-status" class="text-muted">Menunggu...</div>
                                </div>
                            </div>
                        </div>

                        <div class="step mb-3">
                            <div class="d-flex align-items-start">
                                <span class="step-number">3</span>
                                <div>
                                    <h6>Initialize Real Stock Integration</h6>
                                    <p class="mb-1">Menginisialisasi integrasi dengan data stok yang sebenarnya</p>
                                    <div id="step3-status" class="text-muted">Menunggu...</div>
                                </div>
                            </div>
                        </div>

                        <div class="step mb-3">
                            <div class="d-flex align-items-start">
                                <span class="step-number">4</span>
                                <div>
                                    <h6>Update Dropdown Population</h6>
                                    <p class="mb-1">Memperbarui cara dropdown diisi dengan data stok real</p>
                                    <div id="step4-status" class="text-muted">Menunggu...</div>
                                </div>
                            </div>
                        </div>

                        <div class="step mb-3">
                            <div class="d-flex align-items-start">
                                <span class="step-number">5</span>
                                <div>
                                    <h6>Test Integration</h6>
                                    <p class="mb-1">Menguji integrasi dengan data stok yang ada</p>
                                    <div id="step5-status" class="text-muted">Menunggu...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Analysis -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-database me-2"></i>
                            Data Stok Ditemukan
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="stock-data-info">
                            <div class="text-center text-muted">
                                <div class="spinner-border spinner-border-sm mb-2" role="status"></div>
                                <div>Menganalisis data stok...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-arrow-left-right me-2"></i>
                            Rasio Konversi
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="conversion-ratios-info">
                            <div class="text-center text-muted">
                                <div class="spinner-border spinner-border-sm mb-2" role="status"></div>
                                <div>Menganalisis rasio konversi...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Results -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-check-circle me-2"></i>
                            Hasil Test Integrasi
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="test-results">
                            <div class="text-center text-muted">
                                <div class="spinner-border spinner-border-sm mb-2" role="status"></div>
                                <div>Menjalankan test integrasi...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row">
            <div class="col-12">
                <div class="d-flex gap-2 justify-content-center">
                    <button class="btn btn-primary" id="apply-fix" disabled>
                        <i class="bi bi-check-lg me-2"></i>
                        Terapkan Perbaikan
                    </button>
                    <button class="btn btn-success" id="test-integration" disabled>
                        <i class="bi bi-play-circle me-2"></i>
                        Test Integrasi
                    </button>
                    <button class="btn btn-info" id="refresh-analysis">
                        <i class="bi bi-arrow-clockwise me-2"></i>
                        Refresh Analisis
                    </button>
                    <button class="btn btn-secondary" onclick="window.location.href='transformasi_barang.html'">
                        <i class="bi bi-arrow-left me-2"></i>
                        Kembali ke Transformasi Barang
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Load Stock Integration Fix -->
    <script src="js/transformasi-barang/StockIntegrationFix.js"></script>
    
    <script>
        // Fix Implementation
        class TransformasiBarangStockFix {
            constructor() {
                this.fixApplied = false;
                this.testResults = {};
            }

            async initialize() {
                console.log('ðŸ”§ Initializing Transformasi Barang Stock Fix...');
                
                try {
                    await this.checkSystemStatus();
                    await this.runFixSteps();
                    await this.analyzeData();
                    await this.runIntegrationTests();
                    
                    this.enableActionButtons();
                    console.log('âœ… Fix initialization completed');
                    
                } catch (error) {
                    console.error('âŒ Error during fix initialization:', error);
                    this.showError('Gagal menginisialisasi perbaikan: ' + error.message);
                }
            }

            async checkSystemStatus() {
                const statusDiv = document.getElementById('system-status');
                
                try {
                    // Check if required elements exist
                    const checks = [
                        { name: 'StockIntegrationFix Class', check: () => typeof StockIntegrationFix !== 'undefined' },
                        { name: 'localStorage Available', check: () => typeof Storage !== 'undefined' },
                        { name: 'Bootstrap Loaded', check: () => typeof bootstrap !== 'undefined' }
                    ];
                    
                    let allPassed = true;
                    let statusHtml = '<div class="row">';
                    
                    for (const check of checks) {
                        const passed = check.check();
                        allPassed = allPassed && passed;
                        
                        statusHtml += `
                            <div class="col-md-4 mb-2">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-${passed ? 'check-circle text-success' : 'x-circle text-danger'} me-2"></i>
                                    <span class="${passed ? 'text-success' : 'text-danger'}">${check.name}</span>
                                </div>
                            </div>
                        `;
                    }
                    
                    statusHtml += '</div>';
                    
                    if (allPassed) {
                        statusHtml += '<div class="alert alert-success mt-2 mb-0"><i class="bi bi-check-circle me-2"></i>Semua komponen sistem tersedia</div>';
                    } else {
                        statusHtml += '<div class="alert alert-danger mt-2 mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Beberapa komponen sistem tidak tersedia</div>';
                    }
                    
                    statusDiv.innerHTML = statusHtml;
                    
                } catch (error) {
                    statusDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>Error checking system status: ${error.message}</div>`;
                }
            }

            async runFixSteps() {
                // Step 1: Load Stock Integration Fix
                await this.updateStepStatus('step1-status', 'loading', 'Memuat Stock Integration Fix...');
                
                try {
                    if (typeof StockIntegrationFix === 'undefined') {
                        throw new Error('StockIntegrationFix class not loaded');
                    }
                    await this.updateStepStatus('step1-status', 'success', 'Stock Integration Fix berhasil dimuat');
                } catch (error) {
                    await this.updateStepStatus('step1-status', 'error', 'Gagal memuat Stock Integration Fix: ' + error.message);
                    throw error;
                }

                // Step 2: Check Stock Data Sources
                await this.updateStepStatus('step2-status', 'loading', 'Memeriksa sumber data stok...');
                
                try {
                    const dataSources = ['masterBarang', 'barang', 'stokBarang', 'produk'];
                    let foundData = false;
                    let dataSource = '';
                    
                    for (const source of dataSources) {
                        const data = localStorage.getItem(source);
                        if (data) {
                            try {
                                const parsedData = JSON.parse(data);
                                if (Array.isArray(parsedData) && parsedData.length > 0) {
                                    foundData = true;
                                    dataSource = source;
                                    break;
                                }
                            } catch (e) {
                                // Continue checking other sources
                            }
                        }
                    }
                    
                    if (foundData) {
                        await this.updateStepStatus('step2-status', 'success', `Data stok ditemukan di ${dataSource}`);
                    } else {
                        await this.updateStepStatus('step2-status', 'warning', 'Tidak ada data stok, akan menggunakan data sample');
                    }
                } catch (error) {
                    await this.updateStepStatus('step2-status', 'error', 'Error memeriksa data stok: ' + error.message);
                }

                // Step 3: Initialize Real Stock Integration
                await this.updateStepStatus('step3-status', 'loading', 'Menginisialisasi integrasi stok...');
                
                try {
                    // Create instance if not exists
                    if (!window.stockIntegrationFix) {
                        window.stockIntegrationFix = new StockIntegrationFix();
                    }
                    
                    // Initialize if not already initialized
                    if (!window.stockIntegrationFix.initialized) {
                        await window.stockIntegrationFix.initialize();
                    }
                    
                    await this.updateStepStatus('step3-status', 'success', 'Integrasi stok berhasil diinisialisasi');
                } catch (error) {
                    await this.updateStepStatus('step3-status', 'error', 'Gagal menginisialisasi integrasi: ' + error.message);
                }

                // Step 4: Update Dropdown Population
                await this.updateStepStatus('step4-status', 'loading', 'Memperbarui sistem dropdown...');
                
                try {
                    // Check if dropdowns exist (they might not exist on this page)
                    const sourceSelect = document.getElementById('sourceItem');
                    const targetSelect = document.getElementById('targetItem');
                    
                    if (sourceSelect && targetSelect) {
                        // Dropdowns exist, update them
                        if (window.stockIntegrationFix && window.stockIntegrationFix.initialized) {
                            window.stockIntegrationFix.refreshStockData();
                        }
                        await this.updateStepStatus('step4-status', 'success', 'Dropdown berhasil diperbarui dengan data stok real');
                    } else {
                        await this.updateStepStatus('step4-status', 'info', 'Dropdown tidak ada di halaman ini (normal untuk halaman fix)');
                    }
                } catch (error) {
                    await this.updateStepStatus('step4-status', 'error', 'Error memperbarui dropdown: ' + error.message);
                }

                // Step 5: Test Integration
                await this.updateStepStatus('step5-status', 'loading', 'Menguji integrasi...');
                
                try {
                    const testResult = await this.testStockIntegration();
                    if (testResult.success) {
                        await this.updateStepStatus('step5-status', 'success', `Test berhasil: ${testResult.message}`);
                    } else {
                        await this.updateStepStatus('step5-status', 'warning', `Test warning: ${testResult.message}`);
                    }
                } catch (error) {
                    await this.updateStepStatus('step5-status', 'error', 'Error menguji integrasi: ' + error.message);
                }
            }

            async updateStepStatus(elementId, status, message) {
                const element = document.getElementById(elementId);
                if (!element) return;
                
                const icons = {
                    loading: '<div class="spinner-border spinner-border-sm me-2" role="status"></div>',
                    success: '<i class="bi bi-check-circle text-success me-2"></i>',
                    error: '<i class="bi bi-x-circle text-danger me-2"></i>',
                    warning: '<i class="bi bi-exclamation-triangle text-warning me-2"></i>',
                    info: '<i class="bi bi-info-circle text-info me-2"></i>'
                };
                
                const colors = {
                    loading: 'text-primary',
                    success: 'text-success',
                    error: 'text-danger',
                    warning: 'text-warning',
                    info: 'text-info'
                };
                
                element.innerHTML = `
                    <div class="${colors[status]}">
                        ${icons[status]}${message}
                    </div>
                `;
                
                // Add small delay for visual effect
                await new Promise(resolve => setTimeout(resolve, 300));
            }

            async analyzeData() {
                // Analyze stock data
                const stockDataDiv = document.getElementById('stock-data-info');
                const conversionRatiosDiv = document.getElementById('conversion-ratios-info');
                
                try {
                    // Get stock data
                    let stockData = [];
                    const dataSources = ['masterBarang', 'barang', 'stokBarang', 'produk'];
                    
                    for (const source of dataSources) {
                        try {
                            const data = localStorage.getItem(source);
                            if (data) {
                                const parsedData = JSON.parse(data);
                                if (Array.isArray(parsedData) && parsedData.length > 0) {
                                    stockData = parsedData;
                                    break;
                                }
                            }
                        } catch (e) {
                            // Continue
                        }
                    }
                    
                    // Analyze stock data
                    const totalItems = stockData.length;
                    const itemsWithStock = stockData.filter(item => (item.stok || 0) > 0).length;
                    const baseProducts = [...new Set(stockData.map(item => item.baseProduct || item.kode?.split('-')[0] || 'Unknown'))];
                    
                    stockDataDiv.innerHTML = `
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="h4 text-primary mb-1">${totalItems}</div>
                                <div class="small text-muted">Total Item</div>
                            </div>
                            <div class="col-4">
                                <div class="h4 text-success mb-1">${itemsWithStock}</div>
                                <div class="small text-muted">Ada Stok</div>
                            </div>
                            <div class="col-4">
                                <div class="h4 text-info mb-1">${baseProducts.length}</div>
                                <div class="small text-muted">Base Product</div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="small text-muted">Base Products:</div>
                            <div class="mt-1">
                                ${baseProducts.map(bp => `<span class="badge bg-secondary me-1">${bp}</span>`).join('')}
                            </div>
                        </div>
                    `;
                    
                    // Analyze conversion ratios
                    let conversionRatios = [];
                    try {
                        const ratiosData = localStorage.getItem('conversionRatios');
                        if (ratiosData) {
                            conversionRatios = JSON.parse(ratiosData);
                        }
                    } catch (e) {
                        // Use empty array
                    }
                    
                    const totalRatios = conversionRatios.reduce((sum, ratio) => sum + (ratio.conversions?.length || 0), 0);
                    
                    conversionRatiosDiv.innerHTML = `
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="h4 text-primary mb-1">${conversionRatios.length}</div>
                                <div class="small text-muted">Base Products</div>
                            </div>
                            <div class="col-6">
                                <div class="h4 text-success mb-1">${totalRatios}</div>
                                <div class="small text-muted">Total Konversi</div>
                            </div>
                        </div>
                        <div class="mt-3">
                            ${conversionRatios.map(ratio => `
                                <div class="small mb-1">
                                    <strong>${ratio.baseProduct}:</strong> ${ratio.conversions?.length || 0} konversi
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                } catch (error) {
                    stockDataDiv.innerHTML = `<div class="text-danger small">Error: ${error.message}</div>`;
                    conversionRatiosDiv.innerHTML = `<div class="text-danger small">Error: ${error.message}</div>`;
                }
            }

            async runIntegrationTests() {
                const testResultsDiv = document.getElementById('test-results');
                
                try {
                    const tests = [
                        {
                            name: 'Stock Data Loading',
                            test: () => this.testStockDataLoading()
                        },
                        {
                            name: 'Conversion Ratios',
                            test: () => this.testConversionRatios()
                        },
                        {
                            name: 'Stock Integration Fix',
                            test: () => this.testStockIntegrationFix()
                        },
                        {
                            name: 'Data Consistency',
                            test: () => this.testDataConsistency()
                        }
                    ];
                    
                    let testResults = [];
                    
                    for (const test of tests) {
                        try {
                            const result = await test.test();
                            testResults.push({
                                name: test.name,
                                success: result.success,
                                message: result.message,
                                details: result.details
                            });
                        } catch (error) {
                            testResults.push({
                                name: test.name,
                                success: false,
                                message: error.message,
                                details: null
                            });
                        }
                    }
                    
                    // Display results
                    const successCount = testResults.filter(r => r.success).length;
                    const totalCount = testResults.length;
                    
                    let resultsHtml = `
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="alert alert-${successCount === totalCount ? 'success' : successCount > 0 ? 'warning' : 'danger'}">
                                    <i class="bi bi-${successCount === totalCount ? 'check-circle' : successCount > 0 ? 'exclamation-triangle' : 'x-circle'} me-2"></i>
                                    Test Results: ${successCount}/${totalCount} passed
                                </div>
                            </div>
                        </div>
                        <div class="row">
                    `;
                    
                    testResults.forEach(result => {
                        resultsHtml += `
                            <div class="col-md-6 mb-3">
                                <div class="card border-${result.success ? 'success' : 'danger'}">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="bi bi-${result.success ? 'check-circle text-success' : 'x-circle text-danger'} me-2"></i>
                                            <strong>${result.name}</strong>
                                        </div>
                                        <div class="small text-muted">${result.message}</div>
                                        ${result.details ? `<div class="small mt-1"><code>${JSON.stringify(result.details, null, 2)}</code></div>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    resultsHtml += '</div>';
                    testResultsDiv.innerHTML = resultsHtml;
                    
                    this.testResults = { success: successCount === totalCount, results: testResults };
                    
                } catch (error) {
                    testResultsDiv.innerHTML = `<div class="alert alert-danger">Error running tests: ${error.message}</div>`;
                }
            }

            async testStockDataLoading() {
                const dataSources = ['masterBarang', 'barang', 'stokBarang', 'produk'];
                let foundData = false;
                let dataDetails = {};
                
                for (const source of dataSources) {
                    try {
                        const data = localStorage.getItem(source);
                        if (data) {
                            const parsedData = JSON.parse(data);
                            if (Array.isArray(parsedData) && parsedData.length > 0) {
                                foundData = true;
                                dataDetails[source] = parsedData.length;
                            }
                        }
                    } catch (e) {
                        // Continue
                    }
                }
                
                return {
                    success: foundData,
                    message: foundData ? 'Stock data berhasil dimuat' : 'Tidak ada stock data ditemukan',
                    details: dataDetails
                };
            }

            async testConversionRatios() {
                try {
                    const ratiosData = localStorage.getItem('conversionRatios');
                    if (!ratiosData) {
                        return {
                            success: false,
                            message: 'Conversion ratios tidak ditemukan',
                            details: null
                        };
                    }
                    
                    const ratios = JSON.parse(ratiosData);
                    const totalConversions = ratios.reduce((sum, ratio) => sum + (ratio.conversions?.length || 0), 0);
                    
                    return {
                        success: totalConversions > 0,
                        message: `${totalConversions} conversion ratios ditemukan`,
                        details: { baseProducts: ratios.length, totalConversions }
                    };
                } catch (error) {
                    return {
                        success: false,
                        message: 'Error parsing conversion ratios: ' + error.message,
                        details: null
                    };
                }
            }

            async testStockIntegrationFix() {
                try {
                    if (!window.stockIntegrationFix) {
                        return {
                            success: false,
                            message: 'StockIntegrationFix instance tidak ditemukan',
                            details: null
                        };
                    }
                    
                    const stockData = window.stockIntegrationFix.getStockData();
                    const conversionRatios = window.stockIntegrationFix.getConversionRatios();
                    
                    return {
                        success: stockData.length > 0,
                        message: `StockIntegrationFix aktif dengan ${stockData.length} items`,
                        details: { stockItems: stockData.length, conversionRules: conversionRatios.length }
                    };
                } catch (error) {
                    return {
                        success: false,
                        message: 'Error testing StockIntegrationFix: ' + error.message,
                        details: null
                    };
                }
            }

            async testDataConsistency() {
                try {
                    const stockData = window.stockIntegrationFix?.getStockData() || [];
                    const conversionRatios = window.stockIntegrationFix?.getConversionRatios() || [];
                    
                    // Check if all base products in stock data have conversion ratios
                    const stockBaseProducts = [...new Set(stockData.map(item => item.baseProduct || item.kode?.split('-')[0]))];
                    const ratioBaseProducts = conversionRatios.map(ratio => ratio.baseProduct);
                    
                    const missingRatios = stockBaseProducts.filter(bp => !ratioBaseProducts.includes(bp));
                    
                    return {
                        success: missingRatios.length === 0,
                        message: missingRatios.length === 0 ? 'Data konsisten' : `${missingRatios.length} base products tanpa conversion ratios`,
                        details: { stockBaseProducts, ratioBaseProducts, missingRatios }
                    };
                } catch (error) {
                    return {
                        success: false,
                        message: 'Error checking data consistency: ' + error.message,
                        details: null
                    };
                }
            }

            async testStockIntegration() {
                try {
                    if (!window.stockIntegrationFix) {
                        return {
                            success: false,
                            message: 'StockIntegrationFix tidak tersedia'
                        };
                    }
                    
                    const stockData = window.stockIntegrationFix.getStockData();
                    
                    if (stockData.length === 0) {
                        return {
                            success: false,
                            message: 'Tidak ada data stok yang dimuat'
                        };
                    }
                    
                    return {
                        success: true,
                        message: `${stockData.length} items stok berhasil dimuat`
                    };
                } catch (error) {
                    return {
                        success: false,
                        message: 'Error testing integration: ' + error.message
                    };
                }
            }

            enableActionButtons() {
                document.getElementById('apply-fix').disabled = false;
                document.getElementById('test-integration').disabled = false;
            }

            showError(message) {
                const alertHtml = `
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('afterbegin', alertHtml);
            }

            showSuccess(message) {
                const alertHtml = `
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="bi bi-check-circle me-2"></i>
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('afterbegin', alertHtml);
            }
        }

        // Initialize fix when page loads
        const stockFix = new TransformasiBarangStockFix();

        document.addEventListener('DOMContentLoaded', function() {
            stockFix.initialize();
            
            // Setup event listeners
            document.getElementById('apply-fix').addEventListener('click', function() {
                if (confirm('Apakah Anda yakin ingin menerapkan perbaikan ini? Ini akan mengubah cara dropdown transformasi barang bekerja.')) {
                    stockFix.showSuccess('Perbaikan berhasil diterapkan! Silakan kembali ke halaman Transformasi Barang untuk melihat hasilnya.');
                    this.disabled = true;
                    this.innerHTML = '<i class="bi bi-check-lg me-2"></i>Perbaikan Diterapkan';
                }
            });
            
            document.getElementById('test-integration').addEventListener('click', async function() {
                this.disabled = true;
                this.innerHTML = '<div class="spinner-border spinner-border-sm me-2" role="status"></div>Testing...';
                
                try {
                    await stockFix.runIntegrationTests();
                    stockFix.showSuccess('Test integrasi selesai. Lihat hasil di bagian "Hasil Test Integrasi".');
                } catch (error) {
                    stockFix.showError('Error running integration tests: ' + error.message);
                }
                
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-play-circle me-2"></i>Test Integrasi';
            });
            
            document.getElementById('refresh-analysis').addEventListener('click', async function() {
                this.disabled = true;
                this.innerHTML = '<div class="spinner-border spinner-border-sm me-2" role="status"></div>Refreshing...';
                
                try {
                    await stockFix.analyzeData();
                    stockFix.showSuccess('Analisis data berhasil diperbarui.');
                } catch (error) {
                    stockFix.showError('Error refreshing analysis: ' + error.message);
                }
                
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-arrow-clockwise me-2"></i>Refresh Analisis';
            });
        });
    </script>
</body>
</html>