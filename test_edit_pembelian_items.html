<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Edit Pembelian Items Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        body { padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        .test-pass { background-color: #d4edda; color: #155724; }
        .test-fail { background-color: #f8d7da; color: #721c24; }
        .test-info { background-color: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test: Edit Pembelian Items Management</h1>
        <p class="text-muted">Testing task 4: Implementasi manajemen items dalam edit mode</p>
        
        <div class="test-section">
            <h3>Test Setup</h3>
            <button class="btn btn-primary" onclick="setupTestData()">Setup Test Data</button>
            <button class="btn btn-secondary" onclick="clearTestData()">Clear Test Data</button>
            <div id="setupResult" class="mt-2"></div>
        </div>
        
        <div class="test-section">
            <h3>Test 4.1: Tampilkan daftar items dengan tombol hapus</h3>
            <button class="btn btn-info" onclick="test_41()">Run Test 4.1</button>
            <div id="test41Result" class="mt-2"></div>
        </div>
        
        <div class="test-section">
            <h3>Test 4.2: Penambahan item baru dalam edit mode</h3>
            <button class="btn btn-info" onclick="test_42()">Run Test 4.2</button>
            <div id="test42Result" class="mt-2"></div>
        </div>
        
        <div class="test-section">
            <h3>Test 4.3: Auto-update subtotal dan total</h3>
            <button class="btn btn-info" onclick="test_43()">Run Test 4.3</button>
            <div id="test43Result" class="mt-2"></div>
        </div>
        
        <div class="test-section">
            <h3>Manual Test: Open Edit Modal</h3>
            <button class="btn btn-success" onclick="openEditModal()">Open Edit Pembelian Modal</button>
            <p class="text-muted mt-2">This will open the actual edit modal for manual testing</p>
        </div>
    </div>
    
    <!-- Include necessary scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/app.js"></script>
    <script src="js/inventory.js"></script>
    
    <script>
        function setupTestData() {
            // Setup test barang
            const barang = [
                { id: 'brg1', barcode: 'BRG001', nama: 'Test Barang 1', kategoriId: '', satuanId: '', stok: 100, hpp: 5000, hargaJual: 7000 },
                { id: 'brg2', barcode: 'BRG002', nama: 'Test Barang 2', kategoriId: '', satuanId: '', stok: 50, hpp: 10000, hargaJual: 15000 }
            ];
            localStorage.setItem('barang', JSON.stringify(barang));
            
            // Setup test pembelian
            const pembelian = [{
                id: 'pb1',
                noFaktur: 'PB001',
                tanggal: '2024-01-15',
                supplierId: null,
                items: [
                    { barangId: 'brg1', nama: 'Test Barang 1', qty: 10, harga: 5000, subtotal: 50000 },
                    { barangId: 'brg2', nama: 'Test Barang 2', qty: 5, harga: 10000, subtotal: 50000 }
                ],
                total: 100000,
                status: 'selesai'
            }];
            localStorage.setItem('pembelian', JSON.stringify(pembelian));
            
            document.getElementById('setupResult').innerHTML = 
                '<div class="test-result test-pass">✓ Test data berhasil dibuat</div>';
        }
        
        function clearTestData() {
            localStorage.removeItem('barang');
            localStorage.removeItem('pembelian');
            document.getElementById('setupResult').innerHTML = 
                '<div class="test-result test-info">Test data berhasil dihapus</div>';
        }
        
        function test_41() {
            const resultDiv = document.getElementById('test41Result');
            let results = [];
            
            try {
                // Test: removeItemFromEdit function exists
                if (typeof removeItemFromEdit === 'function') {
                    results.push('<div class="test-result test-pass">✓ Function removeItemFromEdit exists</div>');
                } else {
                    results.push('<div class="test-result test-fail">✗ Function removeItemFromEdit not found</div>');
                }
                
                // Test: updateItemPembelianList function exists
                if (typeof updateItemPembelianList === 'function') {
                    results.push('<div class="test-result test-pass">✓ Function updateItemPembelianList exists</div>');
                } else {
                    results.push('<div class="test-result test-fail">✗ Function updateItemPembelianList not found</div>');
                }
                
                // Test: Simulate removing item
                itemsPembelian = [
                    { barangId: 'brg1', nama: 'Test 1', qty: 10, harga: 5000, subtotal: 50000 },
                    { barangId: 'brg2', nama: 'Test 2', qty: 5, harga: 10000, subtotal: 50000 }
                ];
                const initialLength = itemsPembelian.length;
                removeItemFromEdit(0);
                
                if (itemsPembelian.length === initialLength - 1) {
                    results.push('<div class="test-result test-pass">✓ Item successfully removed from array</div>');
                } else {
                    results.push('<div class="test-result test-fail">✗ Item not removed correctly</div>');
                }
                
            } catch (error) {
                results.push(`<div class="test-result test-fail">✗ Error: ${error.message}</div>`);
            }
            
            resultDiv.innerHTML = results.join('');
        }
        
        function test_42() {
            const resultDiv = document.getElementById('test42Result');
            let results = [];
            
            try {
                // Test: addItemPembelian function exists
                if (typeof addItemPembelian === 'function') {
                    results.push('<div class="test-result test-pass">✓ Function addItemPembelian exists</div>');
                } else {
                    results.push('<div class="test-result test-fail">✗ Function addItemPembelian not found</div>');
                }
                
                // Test: Function works in edit mode
                isEditMode = true;
                itemsPembelian = [
                    { barangId: 'brg1', nama: 'Test 1', qty: 10, harga: 5000, subtotal: 50000 }
                ];
                const initialLength = itemsPembelian.length;
                
                results.push('<div class="test-result test-info">ℹ addItemPembelian requires DOM elements, manual test recommended</div>');
                
                isEditMode = false;
                
            } catch (error) {
                results.push(`<div class="test-result test-fail">✗ Error: ${error.message}</div>`);
            }
            
            resultDiv.innerHTML = results.join('');
        }
        
        function test_43() {
            const resultDiv = document.getElementById('test43Result');
            let results = [];
            
            try {
                // Test: updateItemQty function exists
                if (typeof updateItemQty === 'function') {
                    results.push('<div class="test-result test-pass">✓ Function updateItemQty exists</div>');
                } else {
                    results.push('<div class="test-result test-fail">✗ Function updateItemQty not found</div>');
                }
                
                // Test: updateItemHarga function exists
                if (typeof updateItemHarga === 'function') {
                    results.push('<div class="test-result test-pass">✓ Function updateItemHarga exists</div>');
                } else {
                    results.push('<div class="test-result test-fail">✗ Function updateItemHarga not found</div>');
                }
                
                // Test: Update qty recalculates subtotal
                itemsPembelian = [
                    { barangId: 'brg1', nama: 'Test 1', qty: 10, harga: 5000, subtotal: 50000 }
                ];
                updateItemQty(0, 20);
                
                if (itemsPembelian[0].qty === 20 && itemsPembelian[0].subtotal === 100000) {
                    results.push('<div class="test-result test-pass">✓ Qty update recalculates subtotal correctly</div>');
                } else {
                    results.push('<div class="test-result test-fail">✗ Qty update failed: qty=' + itemsPembelian[0].qty + ', subtotal=' + itemsPembelian[0].subtotal + '</div>');
                }
                
                // Test: Update harga recalculates subtotal
                itemsPembelian = [
                    { barangId: 'brg1', nama: 'Test 1', qty: 10, harga: 5000, subtotal: 50000 }
                ];
                updateItemHarga(0, 6000);
                
                if (itemsPembelian[0].harga === 6000 && itemsPembelian[0].subtotal === 60000) {
                    results.push('<div class="test-result test-pass">✓ Harga update recalculates subtotal correctly</div>');
                } else {
                    results.push('<div class="test-result test-fail">✗ Harga update failed: harga=' + itemsPembelian[0].harga + ', subtotal=' + itemsPembelian[0].subtotal + '</div>');
                }
                
            } catch (error) {
                results.push(`<div class="test-result test-fail">✗ Error: ${error.message}</div>`);
            }
            
            resultDiv.innerHTML = results.join('');
        }
        
        function openEditModal() {
            // Setup test data first
            setupTestData();
            
            // Navigate to pembelian page
            if (typeof renderPembelian === 'function') {
                renderPembelian();
                
                // Try to open edit modal
                setTimeout(() => {
                    if (typeof editPembelian === 'function') {
                        editPembelian('pb1');
                    }
                }, 500);
            } else {
                alert('renderPembelian function not found. Make sure inventory.js is loaded.');
            }
        }
    </script>
</body>
</html>
