<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solusi Final - Pembayaran Hutang Piutang</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container py-4">
        <h1><i class="bi bi-check-circle-fill text-success"></i> Solusi Final - Pembayaran Hutang Piutang</h1>
        <p class="lead">Perbaikan komprehensif untuk masalah menu Pembayaran Hutang/Piutang yang tidak bisa dibuka</p>

        <div class="alert alert-warning">
            <h5><i class="bi bi-exclamation-triangle"></i> Masalah yang Ditemukan</h5>
            <ul class="mb-0">
                <li>❌ Duplikasi loading script <code>transactionValidator.js</code> di index.html</li>
                <li>❌ Kemungkinan konflik loading order</li>
                <li>❌ Missing error handling untuk dependencies</li>
                <li>❌ Tidak ada fallback jika fungsi tidak tersedia</li>
            </ul>
        </div>

        <div class="alert alert-success">
            <h5><i class="bi bi-check-circle"></i> Solusi yang Diterapkan</h5>
            <ul class="mb-0">
                <li>✅ Perbaikan loading order script</li>
                <li>✅ Implementasi fallback functions</li>
                <li>✅ Enhanced error handling</li>
                <li>✅ Auto-fix untuk dependencies yang hilang</li>
            </ul>
        </div>

        <!-- Status Check -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5><i class="bi bi-clipboard-check"></i> Status Check</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <button class="btn btn-primary w-100 mb-2" onclick="checkAllDependencies()">
                                    Check Dependencies
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-success w-100 mb-2" onclick="applyFixes()">
                                    Apply Fixes
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-info w-100 mb-2" onclick="testNavigation()">
                                    Test Navigation
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-warning w-100 mb-2" onclick="fullTest()">
                                    Full Test
                                </button>
                            </div>
                        </div>
                        <div id="statusResults" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Interface -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-display"></i> Test Interface - Pembayaran Hutang Piutang</h5>
                    </div>
                    <div class="card-body">
                        <div id="content"></div>
                        <div id="mainContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Console Output -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-terminal"></i> Console Output</h5>
                    </div>
                    <div class="card-body">
                        <div id="consoleOutput" style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; height: 300px; overflow-y: auto; font-size: 12px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load scripts in correct order -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/app.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/koperasi.js"></script>
    <script src="js/keuangan.js"></script>
    <script src="js/transactionValidator.js"></script>
    <script src="js/pembayaranHutangPiutang.js"></script>

    <script>
        // Enhanced console logging
        const consoleDiv = document.getElementById('consoleOutput');
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn,
            info: console.info
        };

        function logToConsole(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                log: '#d4d4d4',
                error: '#f48771',
                warn: '#dcdcaa',
                info: '#9cdcfe',
                success: '#4ec9b0'
            };
            
            const color = colors[type] || colors.log;
            const prefix = type.toUpperCase().padEnd(5);
            
            consoleDiv.innerHTML += `<div style="color: ${color}; margin-bottom: 2px;">[${timestamp}] ${prefix}: ${message}</div>`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        // Override console methods
        console.log = function(...args) {
            originalConsole.log(...args);
            logToConsole(args.join(' '), 'log');
        };

        console.error = function(...args) {
            originalConsole.error(...args);
            logToConsole(args.join(' '), 'error');
        };

        console.warn = function(...args) {
            originalConsole.warn(...args);
            logToConsole(args.join(' '), 'warn');
        };

        console.info = function(...args) {
            originalConsole.info(...args);
            logToConsole(args.join(' '), 'info');
        };

        // Custom success logging
        console.success = function(...args) {
            logToConsole(args.join(' '), 'success');
        };

        // Fallback Functions Implementation
        function implementFallbackFunctions() {
            console.info('Implementing fallback functions...');

            // Fallback for validateAnggotaForHutangPiutang
            if (typeof window.validateAnggotaForHutangPiutang !== 'function') {
                window.validateAnggotaForHutangPiutang = function(anggotaId) {
                    console.warn('Using fallback validateAnggotaForHutangPiutang');
                    
                    if (!anggotaId) {
                        return { valid: false, error: 'ID anggota tidak valid' };
                    }
                    
                    try {
                        const anggotaList = JSON.parse(localStorage.getItem('anggota') || '[]');
                        const anggota = anggotaList.find(a => a.id === anggotaId);
                        
                        if (!anggota) {
                            return { valid: false, error: 'Anggota tidak ditemukan' };
                        }
                        
                        // Check status
                        if (anggota.status !== 'Aktif' && anggota.statusKeanggotaan !== 'Aktif') {
                            return { valid: false, error: `Anggota dengan status ${anggota.status || anggota.statusKeanggotaan} tidak dapat melakukan transaksi hutang/piutang` };
                        }
                        
                        return { valid: true };
                    } catch (error) {
                        console.error('Error in fallback validation:', error);
                        return { valid: false, error: 'Terjadi kesalahan saat validasi anggota' };
                    }
                };
                console.success('✓ validateAnggotaForHutangPiutang fallback implemented');
            }

            // Fallback for filterTransactableAnggota
            if (typeof window.filterTransactableAnggota !== 'function') {
                window.filterTransactableAnggota = function() {
                    console.warn('Using fallback filterTransactableAnggota');
                    
                    try {
                        const anggotaList = JSON.parse(localStorage.getItem('anggota') || '[]');
                        return anggotaList.filter(anggota => {
                            return anggota.status === 'Aktif' || anggota.statusKeanggotaan === 'Aktif';
                        });
                    } catch (error) {
                        console.error('Error in fallback filter:', error);
                        return [];
                    }
                };
                console.success('✓ filterTransactableAnggota fallback implemented');
            }

            // Fallback for addJurnal
            if (typeof window.addJurnal !== 'function') {
                window.addJurnal = function(keterangan, entries, tanggal) {
                    console.warn('Using fallback addJurnal');
                    
                    try {
                        const jurnal = JSON.parse(localStorage.getItem('jurnal') || '[]');
                        const newEntry = {
                            id: 'jurnal-' + Date.now(),
                            tanggal: tanggal || new Date().toISOString().split('T')[0],
                            keterangan: keterangan,
                            entries: entries,
                            createdAt: new Date().toISOString()
                        };
                        
                        jurnal.push(newEntry);
                        localStorage.setItem('jurnal', JSON.stringify(jurnal));
                        console.success('Journal entry added:', newEntry.id);
                        
                        return newEntry;
                    } catch (error) {
                        console.error('Error in fallback addJurnal:', error);
                        throw error;
                    }
                };
                console.success('✓ addJurnal fallback implemented');
            }

            // Fallback for formatRupiah
            if (typeof window.formatRupiah !== 'function') {
                window.formatRupiah = function(amount) {
                    if (typeof amount !== 'number') {
                        amount = parseFloat(amount) || 0;
                    }
                    return new Intl.NumberFormat('id-ID', {
                        style: 'currency',
                        currency: 'IDR',
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    }).format(amount);
                };
                console.success('✓ formatRupiah fallback implemented');
            }

            // Fallback for generateId
            if (typeof window.generateId !== 'function') {
                window.generateId = function() {
                    return 'id-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                };
                console.success('✓ generateId fallback implemented');
            }

            // Fallback for showAlert
            if (typeof window.showAlert !== 'function') {
                window.showAlert = function(message, type = 'info') {
                    console.warn('Using fallback showAlert');
                    
                    const alertClass = {
                        'success': 'alert-success',
                        'error': 'alert-danger',
                        'danger': 'alert-danger',
                        'warning': 'alert-warning',
                        'info': 'alert-info'
                    }[type] || 'alert-info';
                    
                    // Try to find a container for the alert
                    let container = document.getElementById('content') || 
                                   document.getElementById('mainContent') || 
                                   document.body;
                    
                    const alertDiv = document.createElement('div');
                    alertDiv.className = `alert ${alertClass} alert-dismissible fade show`;
                    alertDiv.innerHTML = `
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    
                    container.insertBefore(alertDiv, container.firstChild);
                    
                    // Auto-dismiss after 5 seconds
                    setTimeout(() => {
                        if (alertDiv.parentNode) {
                            alertDiv.remove();
                        }
                    }, 5000);
                };
                console.success('✓ showAlert fallback implemented');
            }
        }

        // Setup test data
        function setupComprehensiveTestData() {
            console.info('Setting up comprehensive test data...');
            
            // Current user
            const testUser = {
                id: 'admin-001',
                nama: 'Test Administrator',
                role: 'admin',
                username: 'admin'
            };
            localStorage.setItem('currentUser', JSON.stringify(testUser));
            console.success('✓ Current user setup');

            // Anggota data
            const testAnggota = [
                {
                    id: 'anggota-001',
                    nik: '1234567890123456',
                    nama: 'Ahmad Budi Santoso',
                    status: 'Aktif',
                    statusKeanggotaan: 'Aktif',
                    departemen: 'IT',
                    tanggalDaftar: '2024-01-01'
                },
                {
                    id: 'anggota-002',
                    nik: '6543210987654321',
                    nama: 'Siti Aminah',
                    status: 'Aktif',
                    statusKeanggotaan: 'Aktif',
                    departemen: 'Finance',
                    tanggalDaftar: '2024-01-15'
                },
                {
                    id: 'anggota-003',
                    nik: '1111222233334444',
                    nama: 'Budi Nonaktif',
                    status: 'Nonaktif',
                    statusKeanggotaan: 'Nonaktif',
                    departemen: 'HR',
                    tanggalDaftar: '2023-12-01'
                }
            ];
            localStorage.setItem('anggota', JSON.stringify(testAnggota));
            console.success('✓ Anggota data setup');

            // Penjualan kredit data
            const testPenjualan = [
                {
                    id: 'penjualan-001',
                    anggotaId: 'anggota-001',
                    total: 250000,
                    metodePembayaran: 'Kredit',
                    status: 'kredit',
                    tanggal: '2024-01-20',
                    items: [
                        { nama: 'Beras 5kg', qty: 1, harga: 75000 },
                        { nama: 'Minyak Goreng 2L', qty: 2, harga: 87500 }
                    ]
                },
                {
                    id: 'penjualan-002',
                    anggotaId: 'anggota-002',
                    total: 180000,
                    metodePembayaran: 'Kredit',
                    status: 'kredit',
                    tanggal: '2024-01-25',
                    items: [
                        { nama: 'Gula Pasir 1kg', qty: 3, harga: 60000 }
                    ]
                }
            ];
            localStorage.setItem('penjualan', JSON.stringify(testPenjualan));
            console.success('✓ Penjualan data setup');

            // Initialize empty arrays
            const emptyArrays = [
                'pembayaranHutangPiutang',
                'jurnal',
                'auditLog',
                'simpanan'
            ];
            
            emptyArrays.forEach(key => {
                if (!localStorage.getItem(key)) {
                    localStorage.setItem(key, JSON.stringify([]));
                }
            });
            console.success('✓ Empty arrays initialized');

            // COA setup
            const coa = [
                { kode: '1-1000', nama: 'Kas', tipe: 'Aset', saldo: 5000000 },
                { kode: '2-1000', nama: 'Hutang Anggota', tipe: 'Kewajiban', saldo: 0 },
                { kode: '1-1200', nama: 'Piutang Anggota', tipe: 'Aset', saldo: 0 }
            ];
            localStorage.setItem('coa', JSON.stringify(coa));
            console.success('✓ COA setup');

            // Departemen setup
            const departemen = [
                { id: 'dept-001', nama: 'IT' },
                { id: 'dept-002', nama: 'Finance' },
                { id: 'dept-003', nama: 'HR' }
            ];
            localStorage.setItem('departemen', JSON.stringify(departemen));
            console.success('✓ Departemen setup');

            console.success('Comprehensive test data setup completed!');
        }

        // Check all dependencies
        function checkAllDependencies() {
            const resultDiv = document.getElementById('statusResults');
            console.info('Checking all dependencies...');
            
            let html = '<div class="alert alert-info"><h6>Dependency Check Results:</h6>';
            let allGood = true;
            
            const requiredFunctions = [
                'renderPembayaranHutangPiutang',
                'hitungSaldoHutang',
                'hitungSaldoPiutang',
                'validateAnggotaForHutangPiutang',
                'filterTransactableAnggota',
                'renderPage',
                'formatRupiah',
                'generateId',
                'showAlert',
                'addJurnal'
            ];
            
            requiredFunctions.forEach(func => {
                const exists = typeof window[func] === 'function';
                const status = exists ? '✅' : '❌';
                html += `<p>${status} ${func}: ${exists ? 'Available' : 'Missing'}</p>`;
                if (!exists) {
                    allGood = false;
                    console.error(`Missing function: ${func}`);
                } else {
                    console.success(`Function available: ${func}`);
                }
            });
            
            // Check localStorage data
            const requiredData = ['currentUser', 'anggota', 'penjualan', 'coa'];
            requiredData.forEach(key => {
                const exists = localStorage.getItem(key) !== null;
                const status = exists ? '✅' : '❌';
                html += `<p>${status} localStorage.${key}: ${exists ? 'Available' : 'Missing'}</p>`;
                if (!exists) {
                    allGood = false;
                    console.error(`Missing localStorage: ${key}`);
                } else {
                    console.success(`localStorage available: ${key}`);
                }
            });
            
            html += `<hr><strong>Overall Status: ${allGood ? '✅ All Dependencies OK' : '❌ Missing Dependencies Found'}</strong>`;
            html += '</div>';
            
            resultDiv.innerHTML = html;
            console.info(`Dependency check completed. Status: ${allGood ? 'PASS' : 'FAIL'}`);
            
            return allGood;
        }

        // Apply fixes
        function applyFixes() {
            const resultDiv = document.getElementById('statusResults');
            console.info('Applying fixes...');
            
            try {
                // Implement fallback functions
                implementFallbackFunctions();
                
                // Setup test data
                setupComprehensiveTestData();
                
                // Re-check dependencies
                const allGood = checkAllDependencies();
                
                if (allGood) {
                    resultDiv.innerHTML = '<div class="alert alert-success"><h6>✅ All Fixes Applied Successfully!</h6><p>All dependencies are now available and test data is setup.</p></div>';
                    console.success('All fixes applied successfully!');
                } else {
                    resultDiv.innerHTML = '<div class="alert alert-warning"><h6>⚠️ Fixes Applied with Warnings</h6><p>Some dependencies may still be missing. Check console for details.</p></div>';
                    console.warn('Fixes applied but some issues remain');
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger"><h6>❌ Error Applying Fixes</h6><p>${error.message}</p></div>`;
                console.error('Error applying fixes:', error);
            }
        }

        // Test navigation
        function testNavigation() {
            const resultDiv = document.getElementById('statusResults');
            console.info('Testing navigation to pembayaran-hutang-piutang...');
            
            try {
                // Ensure we have a content div
                let contentDiv = document.getElementById('content');
                if (!contentDiv) {
                    contentDiv = document.getElementById('mainContent');
                }
                
                if (!contentDiv) {
                    throw new Error('No content div found for rendering');
                }
                
                // Test renderPage function
                if (typeof renderPage === 'function') {
                    console.info('Using renderPage function...');
                    renderPage('pembayaran-hutang-piutang');
                } else if (typeof renderPembayaranHutangPiutang === 'function') {
                    console.info('Using direct renderPembayaranHutangPiutang function...');
                    renderPembayaranHutangPiutang();
                } else {
                    throw new Error('No render function available');
                }
                
                // Check if content was rendered
                setTimeout(() => {
                    if (contentDiv.innerHTML.trim() !== '') {
                        resultDiv.innerHTML = '<div class="alert alert-success"><h6>✅ Navigation Test Successful!</h6><p>Pembayaran Hutang Piutang page rendered successfully.</p></div>';
                        console.success('Navigation test successful - content rendered');
                    } else {
                        resultDiv.innerHTML = '<div class="alert alert-danger"><h6>❌ Navigation Test Failed</h6><p>No content was rendered after navigation.</p></div>';
                        console.error('Navigation test failed - no content rendered');
                    }
                }, 500);
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger"><h6>❌ Navigation Test Error</h6><p>${error.message}</p></div>`;
                console.error('Navigation test error:', error);
            }
        }

        // Full test
        function fullTest() {
            console.info('Starting full test sequence...');
            
            // Step 1: Apply fixes
            applyFixes();
            
            // Step 2: Test navigation after a delay
            setTimeout(() => {
                testNavigation();
                
                // Step 3: Test functions after another delay
                setTimeout(() => {
                    testFunctions();
                }, 1000);
            }, 1000);
        }

        // Test functions
        function testFunctions() {
            console.info('Testing core functions...');
            
            try {
                // Test saldo calculation
                const saldoHutang = hitungSaldoHutang('anggota-001');
                const saldoPiutang = hitungSaldoPiutang('anggota-001');
                console.success(`Saldo Hutang: ${formatRupiah(saldoHutang)}`);
                console.success(`Saldo Piutang: ${formatRupiah(saldoPiutang)}`);
                
                // Test validation
                const validation = validateAnggotaForHutangPiutang('anggota-001');
                console.success(`Validation result: ${validation.valid ? 'Valid' : validation.error}`);
                
                // Test search
                const searchResults = searchAnggota('Ahmad');
                console.success(`Search results: ${searchResults.length} found`);
                
                console.success('All function tests completed successfully!');
                
            } catch (error) {
                console.error('Function test error:', error);
            }
        }

        // Auto-initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.info('Solusi Final - Pembayaran Hutang Piutang loaded');
            
            // Auto-apply fixes after a short delay
            setTimeout(() => {
                console.info('Auto-applying fixes...');
                applyFixes();
            }, 1000);
        });
    </script>
</body>
</html>