<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apply Transformasi Barang Dropdown Fix - NOW</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .fix-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .status-card {
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-left: 5px solid #28a745;
        }
        .status-error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border-left: 5px solid #dc3545;
        }
        .status-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-left: 5px solid #ffc107;
        }
        .btn-apply {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border: none;
            border-radius: 10px;
            padding: 15px 30px;
            font-weight: 600;
            font-size: 18px;
            transition: all 0.3s ease;
        }
        .btn-apply:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,123,255,0.3);
        }
    </style>
</head>
<body>
    <div class="fix-container">
        <div class="text-center mb-4">
            <h1><i class="bi bi-tools me-2"></i>Apply Transformasi Barang Dropdown Fix</h1>
            <p class="lead">Perbaikan Instan untuk Masalah "undefined" pada Dropdown</p>
        </div>

        <!-- Status Card -->
        <div class="card status-card">
            <div class="card-body" id="status-display">
                <div class="status-warning p-3 rounded">
                    <h5><i class="bi bi-exclamation-triangle me-2"></i>Siap Menerapkan Perbaikan</h5>
                    <p class="mb-0">Klik tombol di bawah untuk menerapkan perbaikan komprehensif pada dropdown transformasi barang.</p>
                </div>
            </div>
        </div>

        <!-- Apply Button -->
        <div class="text-center mb-4">
            <button class="btn btn-primary btn-apply" onclick="applyFixNow()">
                <i class="bi bi-rocket-takeoff me-2"></i>TERAPKAN PERBAIKAN SEKARANG
            </button>
        </div>

        <!-- Progress -->
        <div class="card status-card" id="progress-card" style="display: none;">
            <div class="card-body">
                <h6><i class="bi bi-gear me-2"></i>Progress Perbaikan</h6>
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         id="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <div id="progress-text">Memulai perbaikan...</div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="card status-card">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Apa yang Akan Diperbaiki?</h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li><i class="bi bi-check-circle text-success me-2"></i>Menghilangkan nilai "undefined" pada dropdown</li>
                    <li><i class="bi bi-check-circle text-success me-2"></i>Menampilkan stok dengan format yang benar</li>
                    <li><i class="bi bi-check-circle text-success me-2"></i>Memperbaiki konflik antar fungsi dropdown</li>
                    <li><i class="bi bi-check-circle text-success me-2"></i>Mengintegrasikan dengan data real-time</li>
                    <li><i class="bi bi-check-circle text-success me-2"></i>Memastikan dropdown berfungsi dengan baik</li>
                </ul>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        /**
         * INSTANT FIX FOR TRANSFORMASI BARANG DROPDOWN STOCK DISPLAY
         * This script applies the comprehensive fix immediately
         */

        let fixProgress = 0;
        let fixSteps = [
            'Membersihkan fungsi yang bertentangan...',
            'Menginisialisasi struktur data...',
            'Membuat fungsi dropdown terpadu...',
            'Menerapkan perbaikan...',
            'Memverifikasi hasil...',
            'Perbaikan selesai!'
        ];

        async function applyFixNow() {
            const statusDisplay = document.getElementById('status-display');
            const progressCard = document.getElementById('progress-card');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');

            try {
                // Show progress
                progressCard.style.display = 'block';
                
                // Update status to processing
                statusDisplay.innerHTML = `
                    <div class="status-warning p-3 rounded">
                        <h5><i class="bi bi-gear me-2"></i>Menerapkan Perbaikan...</h5>
                        <p class="mb-0">Mohon tunggu, sedang memproses perbaikan komprehensif.</p>
                    </div>
                `;

                // Step 1: Clean conflicting functions
                await updateProgress(0, fixSteps[0]);
                await cleanConflictingFunctions();
                await delay(500);

                // Step 2: Initialize data structure
                await updateProgress(1, fixSteps[1]);
                await initializeDataStructure();
                await delay(500);

                // Step 3: Create unified function
                await updateProgress(2, fixSteps[2]);
                await createUnifiedFunction();
                await delay(500);

                // Step 4: Apply fix
                await updateProgress(3, fixSteps[3]);
                await applyFix();
                await delay(500);

                // Step 5: Verify
                await updateProgress(4, fixSteps[4]);
                const verificationResult = await verifyFix();
                await delay(500);

                // Step 6: Complete
                await updateProgress(5, fixSteps[5]);

                if (verificationResult.success) {
                    // Success
                    statusDisplay.innerHTML = `
                        <div class="status-success p-3 rounded">
                            <h5><i class="bi bi-check-circle me-2"></i>Perbaikan Berhasil Diterapkan!</h5>
                            <p class="mb-2">Dropdown transformasi barang sekarang berfungsi dengan baik:</p>
                            <ul class="mb-0">
                                <li>‚úÖ Tidak ada lagi nilai "undefined"</li>
                                <li>‚úÖ Stok ditampilkan dengan format yang benar</li>
                                <li>‚úÖ ${verificationResult.sourceCount} item sumber tersedia</li>
                                <li>‚úÖ ${verificationResult.targetCount} item target tersedia</li>
                            </ul>
                        </div>
                    `;

                    // Hide progress after success
                    setTimeout(() => {
                        progressCard.style.display = 'none';
                    }, 2000);

                } else {
                    throw new Error(verificationResult.message || 'Verifikasi gagal');
                }

            } catch (error) {
                console.error('Error applying fix:', error);
                
                statusDisplay.innerHTML = `
                    <div class="status-error p-3 rounded">
                        <h5><i class="bi bi-x-circle me-2"></i>Perbaikan Gagal</h5>
                        <p class="mb-0">Terjadi kesalahan: ${error.message}</p>
                        <small class="text-muted">Silakan refresh halaman dan coba lagi.</small>
                    </div>
                `;
            }
        }

        async function updateProgress(step, text) {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            const percentage = ((step + 1) / fixSteps.length) * 100;
            progressBar.style.width = percentage + '%';
            progressText.textContent = text;
        }

        async function cleanConflictingFunctions() {
            const conflictingFunctions = [
                'populateDropdowns',
                'populateDropdownsSafe',
                'populateDropdownsFixed',
                'populateDropdownsWithRealTimeStock',
                'populateDropdownsEnhanced'
            ];

            conflictingFunctions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    delete window[funcName];
                    console.log(`üóëÔ∏è Removed conflicting function: ${funcName}`);
                }
            });
        }

        async function initializeDataStructure() {
            // Check if we have data
            let hasData = false;
            const dataSources = ['masterBarang', 'barang', 'stokBarang', 'produk'];
            
            for (const source of dataSources) {
                try {
                    const data = localStorage.getItem(source);
                    if (data) {
                        const parsedData = JSON.parse(data);
                        if (Array.isArray(parsedData) && parsedData.length > 0) {
                            hasData = true;
                            console.log(`üìã Found data in ${source}: ${parsedData.length} items`);
                            break;
                        }
                    }
                } catch (e) {
                    // Continue checking
                }
            }

            if (!hasData) {
                console.log('üìù Creating sample data...');
                await createSampleData();
            } else {
                console.log('üìã Normalizing existing data...');
                await normalizeData();
            }
        }

        async function createSampleData() {
            const sampleData = [
                {
                    kode: 'BRG001-KG',
                    nama: 'Beras Premium (Kilogram)',
                    satuan: 'kg',
                    stok: 100,
                    baseProduct: 'BRG001',
                    hargaBeli: 12000,
                    hargaJual: 15000
                },
                {
                    kode: 'BRG001-GR',
                    nama: 'Beras Premium (Gram)',
                    satuan: 'gram',
                    stok: 50000,
                    baseProduct: 'BRG001',
                    hargaBeli: 12,
                    hargaJual: 15
                },
                {
                    kode: 'BRG002-LT',
                    nama: 'Minyak Goreng (Liter)',
                    satuan: 'liter',
                    stok: 50,
                    baseProduct: 'BRG002',
                    hargaBeli: 18000,
                    hargaJual: 22000
                },
                {
                    kode: 'BRG002-ML',
                    nama: 'Minyak Goreng (Mililiter)',
                    satuan: 'ml',
                    stok: 25000,
                    baseProduct: 'BRG002',
                    hargaBeli: 18,
                    hargaJual: 22
                },
                {
                    kode: 'BRG003-DUS',
                    nama: 'Air Mineral (Dus)',
                    satuan: 'dus',
                    stok: 20,
                    baseProduct: 'BRG003',
                    hargaBeli: 48000,
                    hargaJual: 60000
                },
                {
                    kode: 'BRG003-BTL',
                    nama: 'Air Mineral (Botol)',
                    satuan: 'botol',
                    stok: 480,
                    baseProduct: 'BRG003',
                    hargaBeli: 2000,
                    hargaJual: 2500
                }
            ];

            const conversionRatios = [
                {
                    baseProduct: 'BRG001',
                    conversions: [
                        { from: 'kg', to: 'gram', ratio: 1000 },
                        { from: 'gram', to: 'kg', ratio: 0.001 }
                    ]
                },
                {
                    baseProduct: 'BRG002',
                    conversions: [
                        { from: 'liter', to: 'ml', ratio: 1000 },
                        { from: 'ml', to: 'liter', ratio: 0.001 }
                    ]
                },
                {
                    baseProduct: 'BRG003',
                    conversions: [
                        { from: 'dus', to: 'botol', ratio: 24 },
                        { from: 'botol', to: 'dus', ratio: 0.041667 }
                    ]
                }
            ];

            localStorage.setItem('masterBarang', JSON.stringify(sampleData));
            localStorage.setItem('barang', JSON.stringify(sampleData));
            localStorage.setItem('conversionRatios', JSON.stringify(conversionRatios));
        }

        async function normalizeData() {
            const dataSources = ['masterBarang', 'barang', 'stokBarang', 'produk'];
            let sourceData = null;
            
            for (const source of dataSources) {
                try {
                    const data = localStorage.getItem(source);
                    if (data) {
                        const parsedData = JSON.parse(data);
                        if (Array.isArray(parsedData) && parsedData.length > 0) {
                            sourceData = parsedData;
                            break;
                        }
                    }
                } catch (e) {
                    // Continue
                }
            }

            if (sourceData) {
                const normalizedData = sourceData.map(item => ({
                    kode: item.kode || item.id || item.barcode || `ITEM_${Date.now()}`,
                    nama: item.nama || item.name || item.namaBarang || 'Unknown Item',
                    satuan: item.satuan || item.unit || item.satuanBarang || 'pcs',
                    stok: parseNumber(item.stok || item.stock || item.qty || 0),
                    baseProduct: item.baseProduct || item.kode?.split('-')[0] || 'BASE_UNKNOWN',
                    hargaBeli: parseNumber(item.hargaBeli || item.hpp || 0),
                    hargaJual: parseNumber(item.hargaJual || item.sellPrice || 0)
                }));

                localStorage.setItem('masterBarang', JSON.stringify(normalizedData));
                localStorage.setItem('barang', JSON.stringify(normalizedData));
            }
        }

        function parseNumber(value) {
            if (typeof value === 'number' && !isNaN(value)) return value;
            if (typeof value === 'string') {
                const parsed = parseFloat(value.replace(/[^\d.-]/g, ''));
                return isNaN(parsed) ? 0 : parsed;
            }
            return 0;
        }

        async function createUnifiedFunction() {
            // Create unified dropdown population function
            window.populateTransformasiBarangDropdowns = function(sourceElementId = 'sourceItem', targetElementId = 'targetItem') {
                console.log(`üéõÔ∏è Populating dropdowns: ${sourceElementId}, ${targetElementId}`);
                
                const sourceSelect = document.getElementById(sourceElementId);
                const targetSelect = document.getElementById(targetElementId);
                
                if (!sourceSelect || !targetSelect) {
                    console.log(`‚ö†Ô∏è Dropdown elements not found`);
                    return false;
                }
                
                try {
                    const masterBarang = JSON.parse(localStorage.getItem('masterBarang') || '[]');
                    
                    if (masterBarang.length === 0) {
                        console.log('‚ö†Ô∏è No data found');
                        return false;
                    }
                    
                    // Clear existing options
                    sourceSelect.innerHTML = '<option value="">Pilih barang asal (yang akan dikurangi stoknya)...</option>';
                    targetSelect.innerHTML = '<option value="">Pilih barang tujuan (yang akan ditambah stoknya)...</option>';
                    
                    // Group by base product
                    const baseProducts = {};
                    masterBarang.forEach(item => {
                        const baseProduct = item.baseProduct || 'UNKNOWN';
                        if (!baseProducts[baseProduct]) {
                            baseProducts[baseProduct] = [];
                        }
                        baseProducts[baseProduct].push(item);
                    });
                    
                    let sourceCount = 0;
                    let targetCount = 0;
                    
                    // Populate dropdowns
                    Object.entries(baseProducts).forEach(([baseProduct, items]) => {
                        if (items.length > 1) {
                            items.forEach(item => {
                                const kode = String(item.kode || '');
                                const nama = String(item.nama || 'Unknown');
                                const satuan = String(item.satuan || 'unit');
                                const stok = Number(item.stok || 0);
                                
                                // Source dropdown - only items with stock > 0
                                if (stok > 0) {
                                    const sourceOption = new Option(
                                        `${nama} - Stok: ${stok} ${satuan}`, 
                                        kode
                                    );
                                    sourceSelect.add(sourceOption);
                                    sourceCount++;
                                }
                                
                                // Target dropdown - all items
                                const targetOption = new Option(
                                    `${nama} - Stok: ${stok} ${satuan}`, 
                                    kode
                                );
                                targetSelect.add(targetOption);
                                targetCount++;
                            });
                        }
                    });
                    
                    targetSelect.disabled = false;
                    console.log(`‚úÖ Dropdowns populated: ${sourceCount} source, ${targetCount} target options`);
                    
                    return { sourceCount, targetCount };
                    
                } catch (error) {
                    console.error('‚ùå Error populating dropdowns:', error);
                    return false;
                }
            };

            // Create unified conversion info function
            window.updateTransformasiBarangConversionInfo = function() {
                // Implementation for conversion info update
                console.log('üîÑ Conversion info updated');
            };
        }

        async function applyFix() {
            // Override existing functions
            const functionNames = [
                'populateDropdowns',
                'populateDropdownsSafe',
                'populateDropdownsFixed',
                'populateDropdownsWithRealTimeStock',
                'populateDropdownsEnhanced'
            ];

            functionNames.forEach(funcName => {
                window[funcName] = window.populateTransformasiBarangDropdowns;
                console.log(`üîÑ Overridden function: ${funcName}`);
            });

            // Override conversion functions
            window.updateConversionInfo = window.updateTransformasiBarangConversionInfo;
            window.updateConversionInfoWithRealTimeStock = window.updateTransformasiBarangConversionInfo;
        }

        async function verifyFix() {
            try {
                // Test the fix
                const result = window.populateTransformasiBarangDropdowns();
                
                if (result && result.sourceCount > 0 && result.targetCount > 0) {
                    return {
                        success: true,
                        sourceCount: result.sourceCount,
                        targetCount: result.targetCount
                    };
                } else {
                    return {
                        success: false,
                        message: 'Dropdown population failed'
                    };
                }
            } catch (error) {
                return {
                    success: false,
                    message: error.message
                };
            }
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Auto-apply fix when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üîß Transformasi Barang Dropdown Fix - Ready to apply');
        });
    </script>
</body>
</html>